/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, {
/******/ 				configurable: false,
/******/ 				enumerable: true,
/******/ 				get: getter
/******/ 			});
/******/ 		}
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 0);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


// External Libraries -- Begin
const PC = __webpack_require__( 1 );
// External Libraries -- End

// Create Application
let canvas = document.getElementById( 'app' );
let app = new PC.Application( canvas, { });
app.start( );

// fill the available space at full resolution
app.setCanvasFillMode( PC.FILLMODE_FILL_WINDOW );
app.setCanvasResolution( PC.RESOLUTION_AUTO );

// ensure canvas is resized when window changes size
window.addEventListener( 'resize', ( ) => {
    app.resizeCanvas( );
} );

// create box entity
var cube = new PC.Entity( 'cube' );
cube.addComponent( 'model', {
    type: 'box'
} );


/***/ }),
/* 1 */
/***/ (function(module, exports, __webpack_require__) {

/*
 PlayCanvas Engine v0.220.1 revision 1fcea84
 http://playcanvas.com
 Copyright 2011-2017 PlayCanvas Ltd. All rights reserved.
*/
var pc = {version:"0.220.1", revision:"1fcea84", config:{}, common:{}, apps:{}, data:{}, unpack:function() {
  console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.");
}, makeArray:function(arr) {
  var i, ret = [], length = arr.length;
  for (i = 0;i < length;++i) {
    ret.push(arr[i]);
  }
  return ret;
}, type:function(obj) {
  if (obj === null) {
    return "null";
  }
  var type = typeof obj;
  if (type == "undefined" || type == "number" || type == "string" || type == "boolean") {
    return type;
  }
  return _typeLookup[Object.prototype.toString.call(obj)];
}, extend:function(target, ex) {
  var prop, copy;
  for (prop in ex) {
    copy = ex[prop];
    if (pc.type(copy) == "object") {
      target[prop] = pc.extend({}, copy);
    } else {
      if (pc.type(copy) == "array") {
        target[prop] = pc.extend([], copy);
      } else {
        target[prop] = copy;
      }
    }
  }
  return target;
}, isDefined:function(o) {
  var a;
  return o !== a;
}};
var _typeLookup = function() {
  var result = {};
  var names = ["Array", "Object", "Function", "Date", "RegExp", "Float32Array"];
  for (var i = 0;i < names.length;i++) {
    result["[object " + names[i] + "]"] = names[i].toLowerCase();
  }
  return result;
}();
if (true) {
  exports.pc = pc;
}
;(function() {
  var lastTime = 0;
  var vendors = ["ms", "moz", "webkit", "o"];
  for (var x = 0;x < vendors.length && !window.requestAnimationFrame;++x) {
    window.requestAnimationFrame = window[vendors[x] + "RequestAnimationFrame"];
    window.cancelAnimationFrame = window[vendors[x] + "CancelAnimationFrame"] || window[vendors[x] + "CancelRequestAnimationFrame"];
  }
  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function(callback, element) {
      var currTime = (new Date).getTime();
      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
      var id = window.setTimeout(function() {
        callback(currTime + timeToCall);
      }, timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };
  }
  if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id) {
      clearTimeout(id);
    };
  }
})();
if (!String.prototype.startsWith) {
  Object.defineProperty(String.prototype, "startsWith", {enumerable:false, configurable:true, writable:true, value:function(str) {
    var that = this;
    for (var i = 0, ceil = str.length;i < ceil;i++) {
      if (that[i] !== str[i]) {
        return false;
      }
    }
    return true;
  }});
}
if (!String.prototype.endsWith) {
  Object.defineProperty(String.prototype, "endsWith", {enumerable:false, configurable:true, writable:true, value:function(str) {
    var that = this;
    for (var i = 0, ceil = str.length;i < ceil;i++) {
      if (that[i + that.length - ceil] !== str[i]) {
        return false;
      }
    }
    return true;
  }});
}
if (!String.prototype.includes) {
  String.prototype.includes = function(search, start) {
    if (typeof start !== "number") {
      start = 0;
    }
    if (start + search.length > this.length) {
      return false;
    } else {
      return this.indexOf(search, start) !== -1;
    }
  };
}
;(function() {
  if (typeof document === "undefined") {
    return;
  }
  var fullscreenchange = function(event) {
    var e = document.createEvent("CustomEvent");
    e.initCustomEvent("fullscreenchange", true, false, null);
    event.target.dispatchEvent(e);
  };
  var fullscreenerror = function(event) {
    var e = document.createEvent("CustomEvent");
    e.initCustomEvent("fullscreenerror", true, false, null);
    event.target.dispatchEvent(e);
  };
  document.addEventListener("webkitfullscreenchange", fullscreenchange, false);
  document.addEventListener("mozfullscreenchange", fullscreenchange, false);
  document.addEventListener("MSFullscreenChange", fullscreenchange, false);
  document.addEventListener("webkitfullscreenerror", fullscreenerror, false);
  document.addEventListener("mozfullscreenerror", fullscreenerror, false);
  document.addEventListener("MSFullscreenError", fullscreenerror, false);
  if (Element.prototype.mozRequestFullScreen) {
    Element.prototype.requestFullscreen = function() {
      this.mozRequestFullScreen();
    };
  } else {
    Element.prototype.requestFullscreen = Element.prototype.requestFullscreen || Element.prototype.webkitRequestFullscreen || Element.prototype.msRequestFullscreen;
  }
  document.exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
  if (!document.hasOwnProperty("fullscreenElement")) {
    Object.defineProperty(document, "fullscreenElement", {enumerable:true, configurable:false, get:function() {
      return document.webkitCurrentFullScreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
    }});
  }
  if (!document.hasOwnProperty("fullscreenEnabled")) {
    Object.defineProperty(document, "fullscreenEnabled", {enumerable:true, configurable:false, get:function() {
      return document.webkitFullscreenEnabled || document.mozFullScreenEnabled || document.msFullscreenEnabled;
    }});
  }
})();
pc.extend(pc, function() {
  var Color = function(r, g, b, a) {
    this.buffer = new ArrayBuffer(4 * 4);
    this.data = new Float32Array(this.buffer, 0, 4);
    this.data3 = new Float32Array(this.buffer, 0, 3);
    var length = r && r.length;
    if (length === 3 || length === 4) {
      this.data[0] = r[0];
      this.data[1] = r[1];
      this.data[2] = r[2];
      this.data[3] = r[3] !== undefined ? r[3] : 1.0;
    } else {
      this.data[0] = r || 0;
      this.data[1] = g || 0;
      this.data[2] = b || 0;
      this.data[3] = a !== undefined ? a : 1.0;
    }
  };
  Color.prototype = {clone:function() {
    return new pc.Color(this.data[0], this.data[1], this.data[2], this.data[3]);
  }, copy:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] = b[0];
    a[1] = b[1];
    a[2] = b[2];
    a[3] = b[3];
    return this;
  }, set:function(r, g, b, a) {
    var c = this.data;
    c[0] = r;
    c[1] = g;
    c[2] = b;
    c[3] = a === undefined ? 1 : a;
    return this;
  }, fromString:function(hex) {
    var i = parseInt(hex.replace("#", "0x"));
    var bytes;
    if (hex.length > 7) {
      bytes = pc.math.intToBytes32(i);
    } else {
      bytes = pc.math.intToBytes24(i);
      bytes[3] = 255;
    }
    this.set(bytes[0] / 255, bytes[1] / 255, bytes[2] / 255, bytes[3] / 255);
    return this;
  }, toString:function(alpha) {
    var s = "#" + ((1 << 24) + (parseInt(this.r * 255) << 16) + (parseInt(this.g * 255) << 8) + parseInt(this.b * 255)).toString(16).slice(1);
    if (alpha === true) {
      var a = parseInt(this.a * 255).toString(16);
      if (this.a < 16 / 255) {
        s += "0" + a;
      } else {
        s += a;
      }
    }
    return s;
  }};
  Object.defineProperty(Color.prototype, "r", {get:function() {
    return this.data[0];
  }, set:function(value) {
    this.data[0] = value;
  }});
  Object.defineProperty(Color.prototype, "g", {get:function() {
    return this.data[1];
  }, set:function(value) {
    this.data[1] = value;
  }});
  Object.defineProperty(Color.prototype, "b", {get:function() {
    return this.data[2];
  }, set:function(value) {
    this.data[2] = value;
  }});
  Object.defineProperty(Color.prototype, "a", {get:function() {
    return this.data[3];
  }, set:function(value) {
    this.data[3] = value;
  }});
  return {Color:Color};
}());
pc.guid = function() {
  return {create:function() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == "x" ? r : r & 3 | 8;
      return v.toString(16);
    });
  }};
}();
pc.extend(pc, function() {
  var Timer = function Timer() {
    this._isRunning = false;
    this._a = 0;
    this._b = 0;
  };
  Timer.prototype = {start:function() {
    this._isRunning = true;
    this._a = (new Date).getTime();
  }, stop:function() {
    this._isRunning = false;
    this._b = (new Date).getTime();
  }, getMilliseconds:function() {
    return this._b - this._a;
  }};
  return {Timer:Timer, now:!window.performance || !window.performance.now || !window.performance.timing ? Date.now : function() {
    return window.performance.now();
  }};
}());
pc.extend(pc, function() {
  return {createURI:function(options) {
    var s = "";
    if ((options.authority || options.scheme) && (options.host || options.hostpath)) {
      throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");
    }
    if (options.host && options.hostpath) {
      throw new Error("Can't have 'host' and 'hostpath' option");
    }
    if (options.path && options.hostpath) {
      throw new Error("Can't have 'path' and 'hostpath' option");
    }
    if (options.scheme) {
      s += options.scheme + ":";
    }
    if (options.authority) {
      s += "//" + options.authority;
    }
    if (options.host) {
      s += options.host;
    }
    if (options.path) {
      s += options.path;
    }
    if (options.hostpath) {
      s += options.hostpath;
    }
    if (options.query) {
      s += "?" + options.query;
    }
    if (options.fragment) {
      s += "#" + options.fragment;
    }
    return s;
  }, URI:function(uri) {
    var re = /^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/, result = uri.match(re);
    this.scheme = result[2];
    this.authority = result[4];
    this.path = result[5];
    this.query = result[7];
    this.fragment = result[9];
    this.toString = function() {
      var s = "";
      if (this.scheme) {
        s += this.scheme + ":";
      }
      if (this.authority) {
        s += "//" + this.authority;
      }
      s += this.path;
      if (this.query) {
        s += "?" + this.query;
      }
      if (this.fragment) {
        s += "#" + this.fragment;
      }
      return s;
    };
    this.getQuery = function() {
      var vars;
      var pair;
      var result = {};
      if (this.query) {
        vars = decodeURIComponent(this.query).split("&");
        vars.forEach(function(item, index, arr) {
          pair = item.split("=");
          result[pair[0]] = pair[1];
        }, this);
      }
      return result;
    };
    this.setQuery = function(params) {
      var q = "";
      for (var key in params) {
        if (params.hasOwnProperty(key)) {
          if (q !== "") {
            q += "&";
          }
          q += encodeURIComponent(key) + "=" + encodeURIComponent(params[key]);
        }
      }
      this.query = q;
    };
  }};
}());
pc.extend(pc, function() {
  var log = {write:function(text) {
    console.log(text);
  }, open:function(text) {
    pc.log.write("Powered by PlayCanvas " + pc.version + " " + pc.revision);
  }, info:function(text) {
    console.info("INFO:    " + text);
  }, debug:function(text) {
    console.debug("DEBUG:   " + text);
  }, error:function(text) {
    console.error("ERROR:   " + text);
  }, warning:function(text) {
    console.warn("WARNING: " + text);
  }, alert:function(text) {
    pc.log.write("ALERT:   " + text);
    alert(text);
  }, assert:function(condition, text) {
    if (condition === false) {
      pc.log.write("ASSERT:  " + text);
      alert("ASSERT failed: " + text);
    }
  }};
  return {log:log};
}());
var logINFO = pc.log.info;
var logDEBUG = pc.log.debug;
var logWARNING = pc.log.warning;
var logERROR = pc.log.error;
var logALERT = pc.log.alert;
var logASSERT = pc.log.assert;
Function.prototype.extendsFrom = function(Super) {
  var Self, Func;
  var Temp = function() {
  };
  Self = this;
  Func = function() {
    Super.apply(this, arguments);
    Self.apply(this, arguments);
    this.constructor = Self;
  };
  Func._super = Super.prototype;
  Temp.prototype = Super.prototype;
  Func.prototype = new Temp;
  return Func;
};
pc.extend(pc, function() {
  return {inherits:function(Self, Super) {
    var Temp = function() {
    };
    var Func = function(arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8) {
      Super.call(this, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8);
      Self.call(this, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8);
    };
    Func._super = Super.prototype;
    Temp.prototype = Super.prototype;
    Func.prototype = new Temp;
    return Func;
  }};
}());
pc.path = function() {
  return {delimiter:"/", join:function() {
    var index;
    var num = arguments.length;
    var result = arguments[0];
    for (index = 0;index < num - 1;++index) {
      var one = arguments[index];
      var two = arguments[index + 1];
      if (!pc.isDefined(one) || !pc.isDefined(two)) {
        throw new Error("undefined argument to pc.path.join");
      }
      if (two[0] === pc.path.delimiter) {
        result = two;
        continue;
      }
      if (one && two && one[one.length - 1] !== pc.path.delimiter && two[0] !== pc.path.delimiter) {
        result += pc.path.delimiter + two;
      } else {
        result += two;
      }
    }
    return result;
  }, split:function(path) {
    var parts = path.split(pc.path.delimiter);
    var tail = parts.slice(parts.length - 1)[0];
    var head = parts.slice(0, parts.length - 1).join(pc.path.delimiter);
    return [head, tail];
  }, getBasename:function(path) {
    return pc.path.split(path)[1];
  }, getDirectory:function(path) {
    var parts = path.split(pc.path.delimiter);
    return parts.slice(0, parts.length - 1).join(pc.path.delimiter);
  }, getExtension:function(path) {
    var ext = path.split("?")[0].split(".").pop();
    if (ext !== path) {
      return "." + ext;
    } else {
      return "";
    }
  }, isRelativePath:function(s) {
    return s.charAt(0) !== "/" && s.match(/:\/\//) === null;
  }, extractPath:function(s) {
    var path = ".", parts = s.split("/"), i = 0;
    if (parts.length > 1) {
      if (pc.path.isRelativePath(s) === false) {
        path = "";
      }
      for (i = 0;i < parts.length - 1;++i) {
        path += "/" + parts[i];
      }
    }
    return path;
  }};
}();
pc.string = function() {
  return {ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz", ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ", ASCII_LETTERS:this.ASCII_LOWERCASE + this.ASCII_UPPERCASE, format:function(s) {
    var i = 0, regexp, args = pc.makeArray(arguments);
    args.shift();
    for (i = 0;i < args.length;i++) {
      regexp = new RegExp("\\{" + i + "\\}", "gi");
      s = s.replace(regexp, args[i]);
    }
    return s;
  }, startsWith:function(s, subs) {
    console.warn("WARNING: startsWith: Function is deprecated. Use String.startsWith instead.");
    return s.startsWith(subs);
  }, endsWith:function(s, subs) {
    console.warn("WARNING: endsWith: Function is deprecated. Use String.endsWith instead.");
    return s.endsWith(subs);
  }, toBool:function(s, strict) {
    if (s === "true") {
      return true;
    }
    if (strict) {
      if (s === "false") {
        return false;
      }
      throw new Error("Not a boolean string");
    }
    return false;
  }};
}();
pc.debug = function() {
  var table = null;
  var row = null;
  var title = null;
  var field = null;
  return {display:function(data) {
    function init() {
      table = document.createElement("table");
      row = document.createElement("tr");
      title = document.createElement("td");
      field = document.createElement("td");
      table.style.cssText = "position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc";
      table.style.top = "0px";
      table.style.left = "0px";
      table.style.border = "thin solid #cccccc";
      document.body.appendChild(table);
    }
    if (!table) {
      init();
    }
    table.innerHTML = "";
    for (var key in data) {
      var r = row.cloneNode();
      var t = title.cloneNode();
      var f = field.cloneNode();
      t.textContent = key;
      f.textContent = data[key];
      r.appendChild(t);
      r.appendChild(f);
      table.appendChild(r);
    }
  }};
}();
pc.events = {attach:function(target) {
  var ev = pc.events;
  target.on = ev.on;
  target.off = ev.off;
  target.fire = ev.fire;
  target.once = ev.once;
  target.hasEvent = ev.hasEvent;
  target._callbackActive = {};
  return target;
}, on:function(name, callback, scope) {
  if (!name || typeof name !== "string" || !callback) {
    return this;
  }
  if (!this._callbacks) {
    this._callbacks = {};
  }
  if (!this._callbacks[name]) {
    this._callbacks[name] = [];
  }
  if (!this._callbackActive) {
    this._callbackActive = {};
  }
  if (this._callbackActive[name] && this._callbackActive[name] === this._callbacks[name]) {
    this._callbackActive[name] = this._callbackActive[name].slice();
  }
  this._callbacks[name].push({callback:callback, scope:scope || this});
  return this;
}, off:function(name, callback, scope) {
  if (!this._callbacks) {
    return this;
  }
  if (this._callbackActive) {
    if (name) {
      if (this._callbackActive[name] && this._callbackActive[name] === this._callbacks[name]) {
        this._callbackActive[name] = this._callbackActive[name].slice();
      }
    } else {
      for (var key in this._callbackActive) {
        if (!this._callbacks[key]) {
          continue;
        }
        if (this._callbacks[key] !== this._callbackActive[key]) {
          continue;
        }
        this._callbackActive[key] = this._callbackActive[key].slice();
      }
    }
  }
  if (!name) {
    this._callbacks = null;
  } else {
    if (!callback) {
      if (this._callbacks[name]) {
        delete this._callbacks[name];
      }
    } else {
      var events = this._callbacks[name];
      if (!events) {
        return this;
      }
      var i = events.length;
      while (i--) {
        if (events[i].callback !== callback) {
          continue;
        }
        if (scope && events[i].scope !== scope) {
          continue;
        }
        events.splice(i, 1);
      }
    }
  }
  return this;
}, fire:function(name, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8) {
  if (!name || !this._callbacks || !this._callbacks[name]) {
    return this;
  }
  var callbacks;
  if (!this._callbackActive) {
    this._callbackActive = {};
  }
  if (!this._callbackActive[name]) {
    this._callbackActive[name] = this._callbacks[name];
  } else {
    if (this._callbackActive[name] === this._callbacks[name]) {
      this._callbackActive[name] = this._callbackActive[name].slice();
    }
    callbacks = this._callbacks[name].slice();
  }
  for (var i = 0;(callbacks || this._callbackActive[name]) && i < (callbacks || this._callbackActive[name]).length;i++) {
    var evt = (callbacks || this._callbackActive[name])[i];
    evt.callback.call(evt.scope, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8);
    if (evt.callback.once) {
      var ind = this._callbacks[name].indexOf(evt);
      if (ind !== -1) {
        if (this._callbackActive[name] === this._callbacks[name]) {
          this._callbackActive[name] = this._callbackActive[name].slice();
        }
        this._callbacks[name].splice(ind, 1);
      }
    }
  }
  if (!callbacks) {
    this._callbackActive[name] = null;
  }
  return this;
}, once:function(name, callback, scope) {
  callback.once = true;
  this.on(name, callback, scope);
  return this;
}, hasEvent:function(name) {
  return this._callbacks && this._callbacks[name] && this._callbacks[name].length !== 0;
}};
pc.extend(pc, function() {
  var TagsCache = function(key) {
    this._index = {};
    this._key = key || null;
  };
  TagsCache.prototype = {addItem:function(item) {
    var tags = item.tags._list;
    for (var i = 0;i < tags.length;i++) {
      this.add(tags[i], item);
    }
  }, removeItem:function(item) {
    var tags = item.tags._list;
    for (var i = 0;i < tags.length;i++) {
      this.remove(tags[i], item);
    }
  }, add:function(tag, item) {
    if (this._index[tag] && this._index[tag].list.indexOf(item) !== -1) {
      return;
    }
    if (!this._index[tag]) {
      this._index[tag] = {list:[]};
      if (this._key) {
        this._index[tag].keys = {};
      }
    }
    this._index[tag].list.push(item);
    if (this._key) {
      this._index[tag].keys[item[this._key]] = item;
    }
  }, remove:function(tag, item) {
    if (!this._index[tag]) {
      return;
    }
    if (this._key) {
      if (!this._index[tag].keys[item[this._key]]) {
        return;
      }
    }
    var ind = this._index[tag].indexOf(item);
    if (ind === -1) {
      return;
    }
    this._index[tag].list.splice(ind, 1);
    if (this._key) {
      delete this._index[tag].keys[item[this._key]];
    }
    if (this._index[tag].list.length === 0) {
      delete this._index[tag];
    }
  }, find:function(args) {
    var self = this;
    var index = {};
    var items = [];
    var i, n, t;
    var item, tag, tags, tagsRest, list, missingIndex;
    var sort = function(a, b) {
      return self._index[a].list.length - self._index[b].list.length;
    };
    for (i = 0;i < args.length;i++) {
      tag = args[i];
      if (tag instanceof Array) {
        if (tag.length === 0) {
          continue;
        }
        if (tag.length === 1) {
          tag = tag[0];
        } else {
          missingIndex = false;
          for (t = 0;t < tag.length;t++) {
            if (!this._index[tag[t]]) {
              missingIndex = true;
              break;
            }
          }
          if (missingIndex) {
            continue;
          }
          tags = tag.slice(0).sort(sort);
          tagsRest = tags.slice(1);
          if (tagsRest.length === 1) {
            tagsRest = tagsRest[0];
          }
          for (n = 0;n < this._index[tags[0]].list.length;n++) {
            item = this._index[tags[0]].list[n];
            if ((this._key ? !index[item[this._key]] : items.indexOf(item) === -1) && item.tags.has(tagsRest)) {
              if (this._key) {
                index[item[this._key]] = true;
              }
              items.push(item);
            }
          }
          continue;
        }
      }
      if (tag && typeof tag === "string" && this._index[tag]) {
        for (n = 0;n < this._index[tag].list.length;n++) {
          item = this._index[tag].list[n];
          if (this._key) {
            if (!index[item[this._key]]) {
              index[item[this._key]] = true;
              items.push(item);
            }
          } else {
            if (items.indexOf(item) === -1) {
              items.push(item);
            }
          }
        }
      }
    }
    return items;
  }};
  var Tags = function(parent) {
    this._index = {};
    this._list = [];
    this._parent = parent;
    pc.events.attach(this);
  };
  Tags.prototype = {add:function() {
    var changed = false;
    var tags = this._processArguments(arguments, true);
    if (!tags.length) {
      return changed;
    }
    for (var i = 0;i < tags.length;i++) {
      if (this._index[tags[i]]) {
        continue;
      }
      changed = true;
      this._index[tags[i]] = true;
      this._list.push(tags[i]);
      this.fire("add", tags[i], this._parent);
    }
    if (changed) {
      this.fire("change", this._parent);
    }
    return changed;
  }, remove:function() {
    var changed = false;
    if (!this._list.length) {
      return changed;
    }
    var tags = this._processArguments(arguments, true);
    if (!tags.length) {
      return changed;
    }
    for (var i = 0;i < tags.length;i++) {
      if (!this._index[tags[i]]) {
        continue;
      }
      changed = true;
      delete this._index[tags[i]];
      this._list.splice(this._list.indexOf(tags[i]), 1);
      this.fire("remove", tags[i], this._parent);
    }
    if (changed) {
      this.fire("change", this._parent);
    }
    return changed;
  }, clear:function() {
    if (!this._list.length) {
      return;
    }
    var tags = this._list.slice(0);
    this._list = [];
    this._index = {};
    for (var i = 0;i < tags.length;i++) {
      this.fire("remove", tags[i], this._parent);
    }
    this.fire("change", this._parent);
  }, has:function() {
    if (!this._list.length) {
      return false;
    }
    return this._has(this._processArguments(arguments));
  }, _has:function(tags) {
    if (!this._list.length || !tags.length) {
      return false;
    }
    for (var i = 0;i < tags.length;i++) {
      if (tags[i].length === 1) {
        if (this._index[tags[i][0]]) {
          return true;
        }
      } else {
        var multiple = true;
        for (var t = 0;t < tags[i].length;t++) {
          if (this._index[tags[i][t]]) {
            continue;
          }
          multiple = false;
          break;
        }
        if (multiple) {
          return true;
        }
      }
    }
    return false;
  }, list:function() {
    return this._list.slice(0);
  }, _processArguments:function(args, flat) {
    var tags = [];
    var tmp = [];
    if (!args || !args.length) {
      return tags;
    }
    for (var i = 0;i < args.length;i++) {
      if (args[i] instanceof Array) {
        if (!flat) {
          tmp = [];
        }
        for (var t = 0;t < args[i].length;t++) {
          if (typeof args[i][t] !== "string") {
            continue;
          }
          if (flat) {
            tags.push(args[i][t]);
          } else {
            tmp.push(args[i][t]);
          }
        }
        if (!flat && tmp.length) {
          tags.push(tmp);
        }
      } else {
        if (typeof args[i] === "string") {
          if (flat) {
            tags.push(args[i]);
          } else {
            tags.push([args[i]]);
          }
        }
      }
    }
    return tags;
  }};
  Object.defineProperty(Tags.prototype, "size", {get:function() {
    return this._list.length;
  }});
  return {TagsCache:TagsCache, Tags:Tags};
}());
pc.extend(pc, function() {
  var AllocatePool = function(constructor, size) {
    this._constructor = constructor;
    this._pool = [];
    this._count = 0;
    this._resize(size);
  };
  AllocatePool.prototype = {_resize:function(size) {
    if (size > this._pool.length) {
      for (var i = this._pool.length;i < size;i++) {
        this._pool[i] = new this._constructor;
      }
    }
  }, allocate:function() {
    if (this._count >= this._pool.length) {
      this._resize(this._pool.length * 2);
    }
    return this._pool[this._count++];
  }, freeAll:function() {
    this._count = 0;
  }};
  return {AllocatePool:AllocatePool};
}());
pc.extend(pc, function() {
  var platform = {desktop:false, mobile:false, ios:false, android:false, windows:false, cocoonjs:false, xbox:false, gamepads:false, touch:false};
  var ua = navigator.userAgent;
  if (/(windows|mac os|linux|cros)/i.test(ua)) {
    platform.desktop = true;
  }
  if (/xbox/i.test(ua)) {
    platform.xbox = true;
  }
  if (/(windows phone|iemobile|wpdesktop)/i.test(ua)) {
    platform.desktop = false;
    platform.mobile = true;
    platform.windows = true;
  } else {
    if (/android/i.test(ua)) {
      platform.desktop = false;
      platform.mobile = true;
      platform.android = true;
    } else {
      if (/ip([ao]d|hone)/i.test(ua)) {
        platform.desktop = false;
        platform.mobile = true;
        platform.ios = true;
      }
    }
  }
  if (navigator.isCocoonJS) {
    platform.cocoonjs = true;
  }
  platform.touch = "ontouchstart" in window;
  platform.gamepads = "getGamepads" in navigator;
  return {platform:platform};
}());
pc.math = {DEG_TO_RAD:Math.PI / 180, RAD_TO_DEG:180 / Math.PI, INV_LOG2:1 / Math.log(2), clamp:function(value, min, max) {
  if (value >= max) {
    return max;
  }
  if (value <= min) {
    return min;
  }
  return value;
}, intToBytes24:function(i) {
  var r, g, b;
  r = i >> 16 & 255;
  g = i >> 8 & 255;
  b = i & 255;
  return [r, g, b];
}, intToBytes32:function(i) {
  var r, g, b, a;
  r = i >> 24 & 255;
  g = i >> 16 & 255;
  b = i >> 8 & 255;
  a = i & 255;
  return [r, g, b, a];
}, bytesToInt24:function(r, g, b) {
  if (r.length) {
    b = r[2];
    g = r[1];
    r = r[0];
  }
  return r << 16 | g << 8 | b;
}, bytesToInt32:function(r, g, b, a) {
  if (r.length) {
    a = r[3];
    b = r[2];
    g = r[1];
    r = r[0];
  }
  return (r << 24 | g << 16 | b << 8 | a) >>> 32;
}, lerp:function(a, b, alpha) {
  return a + (b - a) * pc.math.clamp(alpha, 0, 1);
}, lerpAngle:function(a, b, alpha) {
  if (b - a > 180) {
    b -= 360;
  }
  if (b - a < -180) {
    b += 360;
  }
  return pc.math.lerp(a, b, pc.math.clamp(alpha, 0, 1));
}, powerOfTwo:function(x) {
  return x !== 0 && !(x & x - 1);
}, nextPowerOfTwo:function(val) {
  val--;
  val = val >> 1 | val;
  val = val >> 2 | val;
  val = val >> 4 | val;
  val = val >> 8 | val;
  val = val >> 16 | val;
  val++;
  return val;
}, random:function(min, max) {
  var diff = max - min;
  return Math.random() * diff + min;
}, smoothstep:function(min, max, x) {
  if (x <= min) {
    return 0;
  }
  if (x >= max) {
    return 1;
  }
  x = (x - min) / (max - min);
  return x * x * (3 - 2 * x);
}, smootherstep:function(min, max, x) {
  if (x <= min) {
    return 0;
  }
  if (x >= max) {
    return 1;
  }
  x = (x - min) / (max - min);
  return x * x * x * (x * (x * 6 - 15) + 10);
}};
pc.math.intToBytes = pc.math.intToBytes32;
pc.math.bytesToInt = pc.math.bytesToInt32;
if (!Math.log2) {
  Math.log2 = function(x) {
    return Math.log(x) * pc.math.INV_LOG2;
  };
}
;pc.extend(pc, function() {
  var Vec2 = function(x, y) {
    if (x && x.length === 2) {
      this.data = new Float32Array(x);
      return;
    }
    this.data = new Float32Array(2);
    this.data[0] = x || 0;
    this.data[1] = y || 0;
  };
  Vec2.prototype = {add:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] += b[0];
    a[1] += b[1];
    return this;
  }, add2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + b[0];
    r[1] = a[1] + b[1];
    return this;
  }, clone:function() {
    return (new Vec2).copy(this);
  }, copy:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] = b[0];
    a[1] = b[1];
    return this;
  }, dot:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] * b[0] + a[1] * b[1];
  }, equals:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] === b[0] && a[1] === b[1];
  }, length:function() {
    var v = this.data;
    return Math.sqrt(v[0] * v[0] + v[1] * v[1]);
  }, lengthSq:function() {
    var v = this.data;
    return v[0] * v[0] + v[1] * v[1];
  }, lerp:function(lhs, rhs, alpha) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + alpha * (b[0] - a[0]);
    r[1] = a[1] + alpha * (b[1] - a[1]);
    return this;
  }, mul:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] *= b[0];
    a[1] *= b[1];
    return this;
  }, mul2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] * b[0];
    r[1] = a[1] * b[1];
    return this;
  }, normalize:function() {
    var v = this.data;
    var lengthSq = v[0] * v[0] + v[1] * v[1];
    if (lengthSq > 0) {
      var invLength = 1 / Math.sqrt(lengthSq);
      v[0] *= invLength;
      v[1] *= invLength;
    }
    return this;
  }, scale:function(scalar) {
    var v = this.data;
    v[0] *= scalar;
    v[1] *= scalar;
    return this;
  }, set:function(x, y) {
    var v = this.data;
    v[0] = x;
    v[1] = y;
    return this;
  }, sub:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] -= b[0];
    a[1] -= b[1];
    return this;
  }, sub2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] - b[0];
    r[1] = a[1] - b[1];
    return this;
  }, toString:function() {
    return "[" + this.data[0] + ", " + this.data[1] + "]";
  }};
  Object.defineProperty(Vec2.prototype, "x", {get:function() {
    return this.data[0];
  }, set:function(value) {
    this.data[0] = value;
  }});
  Object.defineProperty(Vec2.prototype, "y", {get:function() {
    return this.data[1];
  }, set:function(value) {
    this.data[1] = value;
  }});
  Object.defineProperty(Vec2, "ONE", {get:function() {
    var one = new Vec2(1, 1);
    return function() {
      return one;
    };
  }()});
  Object.defineProperty(Vec2, "RIGHT", {get:function() {
    var right = new Vec2(1, 0);
    return function() {
      return right;
    };
  }()});
  Object.defineProperty(Vec2, "UP", {get:function() {
    var down = new Vec2(0, 1);
    return function() {
      return down;
    };
  }()});
  Object.defineProperty(Vec2, "ZERO", {get:function() {
    var zero = new Vec2(0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Vec2:Vec2};
}());
pc.extend(pc, function() {
  var Vec3 = function(x, y, z) {
    if (x && x.length === 3) {
      this.data = new Float32Array(x);
      return;
    }
    this.data = new Float32Array(3);
    this.data[0] = x || 0;
    this.data[1] = y || 0;
    this.data[2] = z || 0;
  };
  Vec3.prototype = {add:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] += b[0];
    a[1] += b[1];
    a[2] += b[2];
    return this;
  }, add2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + b[0];
    r[1] = a[1] + b[1];
    r[2] = a[2] + b[2];
    return this;
  }, clone:function() {
    return (new Vec3).copy(this);
  }, copy:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] = b[0];
    a[1] = b[1];
    a[2] = b[2];
    return this;
  }, cross:function(lhs, rhs) {
    var a, b, r, ax, ay, az, bx, by, bz;
    a = lhs.data;
    b = rhs.data;
    r = this.data;
    ax = a[0];
    ay = a[1];
    az = a[2];
    bx = b[0];
    by = b[1];
    bz = b[2];
    r[0] = ay * bz - by * az;
    r[1] = az * bx - bz * ax;
    r[2] = ax * by - bx * ay;
    return this;
  }, dot:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2];
  }, equals:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] === b[0] && a[1] === b[1] && a[2] === b[2];
  }, length:function() {
    var v = this.data;
    return Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2]);
  }, lengthSq:function() {
    var v = this.data;
    return v[0] * v[0] + v[1] * v[1] + v[2] * v[2];
  }, lerp:function(lhs, rhs, alpha) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + alpha * (b[0] - a[0]);
    r[1] = a[1] + alpha * (b[1] - a[1]);
    r[2] = a[2] + alpha * (b[2] - a[2]);
    return this;
  }, mul:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] *= b[0];
    a[1] *= b[1];
    a[2] *= b[2];
    return this;
  }, mul2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] * b[0];
    r[1] = a[1] * b[1];
    r[2] = a[2] * b[2];
    return this;
  }, normalize:function() {
    var v = this.data;
    var lengthSq = v[0] * v[0] + v[1] * v[1] + v[2] * v[2];
    if (lengthSq > 0) {
      var invLength = 1 / Math.sqrt(lengthSq);
      v[0] *= invLength;
      v[1] *= invLength;
      v[2] *= invLength;
    }
    return this;
  }, project:function(rhs) {
    var a = this.data;
    var b = rhs.data;
    var a_dot_b = a[0] * b[0] + a[1] * b[1] + a[2] * b[2];
    var b_dot_b = b[0] * b[0] + b[1] * b[1] + b[2] * b[2];
    var s = a_dot_b / b_dot_b;
    a[0] = b[0] * s;
    a[1] = b[1] * s;
    a[2] = b[2] * s;
    return this;
  }, scale:function(scalar) {
    var v = this.data;
    v[0] *= scalar;
    v[1] *= scalar;
    v[2] *= scalar;
    return this;
  }, set:function(x, y, z) {
    var v = this.data;
    v[0] = x;
    v[1] = y;
    v[2] = z;
    return this;
  }, sub:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] -= b[0];
    a[1] -= b[1];
    a[2] -= b[2];
    return this;
  }, sub2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] - b[0];
    r[1] = a[1] - b[1];
    r[2] = a[2] - b[2];
    return this;
  }, toString:function() {
    return "[" + this.data[0] + ", " + this.data[1] + ", " + this.data[2] + "]";
  }};
  Object.defineProperty(Vec3.prototype, "x", {get:function() {
    return this.data[0];
  }, set:function(value) {
    this.data[0] = value;
  }});
  Object.defineProperty(Vec3.prototype, "y", {get:function() {
    return this.data[1];
  }, set:function(value) {
    this.data[1] = value;
  }});
  Object.defineProperty(Vec3.prototype, "z", {get:function() {
    return this.data[2];
  }, set:function(value) {
    this.data[2] = value;
  }});
  Object.defineProperty(Vec3, "BACK", {get:function() {
    var back = new Vec3(0, 0, 1);
    return function() {
      return back;
    };
  }()});
  Object.defineProperty(Vec3, "DOWN", {get:function() {
    var down = new Vec3(0, -1, 0);
    return function() {
      return down;
    };
  }()});
  Object.defineProperty(Vec3, "FORWARD", {get:function() {
    var forward = new Vec3(0, 0, -1);
    return function() {
      return forward;
    };
  }()});
  Object.defineProperty(Vec3, "LEFT", {get:function() {
    var left = new Vec3(-1, 0, 0);
    return function() {
      return left;
    };
  }()});
  Object.defineProperty(Vec3, "ONE", {get:function() {
    var one = new Vec3(1, 1, 1);
    return function() {
      return one;
    };
  }()});
  Object.defineProperty(Vec3, "RIGHT", {get:function() {
    var right = new Vec3(1, 0, 0);
    return function() {
      return right;
    };
  }()});
  Object.defineProperty(Vec3, "UP", {get:function() {
    var down = new Vec3(0, 1, 0);
    return function() {
      return down;
    };
  }()});
  Object.defineProperty(Vec3, "ZERO", {get:function() {
    var zero = new Vec3(0, 0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Vec3:Vec3};
}());
pc.extend(pc, function() {
  var Vec4 = function(x, y, z, w) {
    if (x && x.length === 4) {
      this.data = new Float32Array(x);
      return;
    }
    this.data = new Float32Array(4);
    this.data[0] = x || 0;
    this.data[1] = y || 0;
    this.data[2] = z || 0;
    this.data[3] = w || 0;
  };
  Vec4.prototype = {add:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] += b[0];
    a[1] += b[1];
    a[2] += b[2];
    a[3] += b[3];
    return this;
  }, add2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + b[0];
    r[1] = a[1] + b[1];
    r[2] = a[2] + b[2];
    r[3] = a[3] + b[3];
    return this;
  }, clone:function() {
    return (new Vec4).copy(this);
  }, copy:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] = b[0];
    a[1] = b[1];
    a[2] = b[2];
    a[3] = b[3];
    return this;
  }, dot:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2] + a[3] * b[3];
  }, equals:function(rhs) {
    var a = this.data, b = rhs.data;
    return a[0] === b[0] && a[1] === b[1] && a[2] === b[2] && a[3] === b[3];
  }, length:function() {
    var v = this.data;
    return Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2] + v[3] * v[3]);
  }, lengthSq:function() {
    var v = this.data;
    return v[0] * v[0] + v[1] * v[1] + v[2] * v[2] + v[3] * v[3];
  }, lerp:function(lhs, rhs, alpha) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + alpha * (b[0] - a[0]);
    r[1] = a[1] + alpha * (b[1] - a[1]);
    r[2] = a[2] + alpha * (b[2] - a[2]);
    r[3] = a[3] + alpha * (b[3] - a[3]);
    return this;
  }, mul:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] *= b[0];
    a[1] *= b[1];
    a[2] *= b[2];
    a[3] *= b[3];
    return this;
  }, mul2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] * b[0];
    r[1] = a[1] * b[1];
    r[2] = a[2] * b[2];
    r[3] = a[3] * b[3];
    return this;
  }, normalize:function() {
    var v = this.data;
    var lengthSq = v[0] * v[0] + v[1] * v[1] + v[2] * v[2] + v[3] * v[3];
    if (lengthSq > 0) {
      var invLength = 1 / Math.sqrt(lengthSq);
      v[0] *= invLength;
      v[1] *= invLength;
      v[2] *= invLength;
      v[3] *= invLength;
    }
    return this;
  }, scale:function(scalar) {
    var v = this.data;
    v[0] *= scalar;
    v[1] *= scalar;
    v[2] *= scalar;
    v[3] *= scalar;
    return this;
  }, set:function(x, y, z, w) {
    var v = this.data;
    v[0] = x;
    v[1] = y;
    v[2] = z;
    v[3] = w;
    return this;
  }, sub:function(rhs) {
    var a = this.data, b = rhs.data;
    a[0] -= b[0];
    a[1] -= b[1];
    a[2] -= b[2];
    a[3] -= b[3];
    return this;
  }, sub2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] - b[0];
    r[1] = a[1] - b[1];
    r[2] = a[2] - b[2];
    r[3] = a[3] - b[3];
    return this;
  }, toString:function() {
    return "[" + this.data[0] + ", " + this.data[1] + ", " + this.data[2] + ", " + this.data[3] + "]";
  }};
  Object.defineProperty(Vec4.prototype, "x", {get:function() {
    return this.data[0];
  }, set:function(value) {
    this.data[0] = value;
  }});
  Object.defineProperty(Vec4.prototype, "y", {get:function() {
    return this.data[1];
  }, set:function(value) {
    this.data[1] = value;
  }});
  Object.defineProperty(Vec4.prototype, "z", {get:function() {
    return this.data[2];
  }, set:function(value) {
    this.data[2] = value;
  }});
  Object.defineProperty(Vec4.prototype, "w", {get:function() {
    return this.data[3];
  }, set:function(value) {
    this.data[3] = value;
  }});
  Object.defineProperty(Vec4, "ONE", {get:function() {
    var one = new Vec4(1, 1, 1, 1);
    return function() {
      return one;
    };
  }()});
  Object.defineProperty(Vec4, "ZERO", {get:function() {
    var zero = new Vec4(0, 0, 0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Vec4:Vec4};
}());
pc.extend(pc, function() {
  var typeNumber = "number";
  var Mat3 = function(v0, v1, v2, v3, v4, v5, v6, v7, v8) {
    if (v0 && v0.length === 9) {
      this.data = new Float32Array(v0);
      return;
    }
    this.data = new Float32Array(9);
    if (typeof v0 === typeNumber) {
      this.data[0] = v0;
      this.data[1] = v1;
      this.data[2] = v2;
      this.data[3] = v3;
      this.data[4] = v4;
      this.data[5] = v5;
      this.data[6] = v6;
      this.data[7] = v7;
      this.data[8] = v8;
    } else {
      this.setIdentity();
    }
  };
  Mat3.prototype = {clone:function() {
    return (new pc.Mat3).copy(this);
  }, copy:function(rhs) {
    var src = rhs.data;
    var dst = this.data;
    dst[0] = src[0];
    dst[1] = src[1];
    dst[2] = src[2];
    dst[3] = src[3];
    dst[4] = src[4];
    dst[5] = src[5];
    dst[6] = src[6];
    dst[7] = src[7];
    dst[8] = src[8];
    return this;
  }, equals:function(rhs) {
    var l = this.data;
    var r = rhs.data;
    return l[0] === r[0] && l[1] === r[1] && l[2] === r[2] && l[3] === r[3] && l[4] === r[4] && l[5] === r[5] && l[6] === r[6] && l[7] === r[7] && l[8] === r[8];
  }, isIdentity:function() {
    var m = this.data;
    return m[0] === 1 && m[1] === 0 && m[2] === 0 && m[3] === 0 && m[4] === 1 && m[5] === 0 && m[6] === 0 && m[7] === 0 && m[8] === 1;
  }, setIdentity:function() {
    var m = this.data;
    m[0] = 1;
    m[1] = 0;
    m[2] = 0;
    m[3] = 0;
    m[4] = 1;
    m[5] = 0;
    m[6] = 0;
    m[7] = 0;
    m[8] = 1;
    return this;
  }, toString:function() {
    var t = "[";
    for (var i = 0;i < 9;i++) {
      t += this.data[i];
      t += i !== 9 ? ", " : "";
    }
    t += "]";
    return t;
  }, transpose:function() {
    var m = this.data;
    var tmp;
    tmp = m[1];
    m[1] = m[3];
    m[3] = tmp;
    tmp = m[2];
    m[2] = m[6];
    m[6] = tmp;
    tmp = m[5];
    m[5] = m[7];
    m[7] = tmp;
    return this;
  }};
  Object.defineProperty(Mat3, "IDENTITY", {get:function() {
    var identity = new Mat3;
    return function() {
      return identity;
    };
  }()});
  Object.defineProperty(Mat3, "ZERO", {get:function() {
    var zero = new Mat3(0, 0, 0, 0, 0, 0, 0, 0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Mat3:Mat3};
}());
pc.extend(pc, function() {
  var typeNumber = "number";
  var Mat4 = function(v0, v1, v2, v3, v4, v5, v6, v7, v8, v9, v10, v11, v12, v13, v14, v15) {
    if (v0 && v0.length === 16) {
      this.data = new Float32Array(v0);
      return;
    }
    this.data = new Float32Array(16);
    if (typeof v0 === typeNumber) {
      this.data[0] = v0;
      this.data[1] = v1;
      this.data[2] = v2;
      this.data[3] = v3;
      this.data[4] = v4;
      this.data[5] = v5;
      this.data[6] = v6;
      this.data[7] = v7;
      this.data[8] = v8;
      this.data[9] = v9;
      this.data[10] = v10;
      this.data[11] = v11;
      this.data[12] = v12;
      this.data[13] = v13;
      this.data[14] = v14;
      this.data[15] = v15;
    } else {
      this.setIdentity();
    }
  };
  Mat4.prototype = {add2:function(lhs, rhs) {
    var a = lhs.data, b = rhs.data, r = this.data;
    r[0] = a[0] + b[0];
    r[1] = a[1] + b[1];
    r[2] = a[2] + b[2];
    r[3] = a[3] + b[3];
    r[4] = a[4] + b[4];
    r[5] = a[5] + b[5];
    r[6] = a[6] + b[6];
    r[7] = a[7] + b[7];
    r[8] = a[8] + b[8];
    r[9] = a[9] + b[9];
    r[10] = a[10] + b[10];
    r[11] = a[11] + b[11];
    r[12] = a[12] + b[12];
    r[13] = a[13] + b[13];
    r[14] = a[14] + b[14];
    r[15] = a[15] + b[15];
    return this;
  }, add:function(rhs) {
    return this.add2(this, rhs);
  }, clone:function() {
    return (new pc.Mat4).copy(this);
  }, copy:function(rhs) {
    var src = rhs.data, dst = this.data;
    dst[0] = src[0];
    dst[1] = src[1];
    dst[2] = src[2];
    dst[3] = src[3];
    dst[4] = src[4];
    dst[5] = src[5];
    dst[6] = src[6];
    dst[7] = src[7];
    dst[8] = src[8];
    dst[9] = src[9];
    dst[10] = src[10];
    dst[11] = src[11];
    dst[12] = src[12];
    dst[13] = src[13];
    dst[14] = src[14];
    dst[15] = src[15];
    return this;
  }, equals:function(rhs) {
    var l = this.data, r = rhs.data;
    return l[0] === r[0] && l[1] === r[1] && l[2] === r[2] && l[3] === r[3] && l[4] === r[4] && l[5] === r[5] && l[6] === r[6] && l[7] === r[7] && l[8] === r[8] && l[9] === r[9] && l[10] === r[10] && l[11] === r[11] && l[12] === r[12] && l[13] === r[13] && l[14] === r[14] && l[15] === r[15];
  }, isIdentity:function() {
    var m = this.data;
    return m[0] === 1 && m[1] === 0 && m[2] === 0 && m[3] === 0 && m[4] === 0 && m[5] === 1 && m[6] === 0 && m[7] === 0 && m[8] === 0 && m[9] === 0 && m[10] === 1 && m[11] === 0 && m[12] === 0 && m[13] === 0 && m[14] === 0 && m[15] === 1;
  }, mul2:function(lhs, rhs) {
    var a00, a01, a02, a03, a10, a11, a12, a13, a20, a21, a22, a23, a30, a31, a32, a33, b0, b1, b2, b3, a = lhs.data, b = rhs.data, r = this.data;
    a00 = a[0];
    a01 = a[1];
    a02 = a[2];
    a03 = a[3];
    a10 = a[4];
    a11 = a[5];
    a12 = a[6];
    a13 = a[7];
    a20 = a[8];
    a21 = a[9];
    a22 = a[10];
    a23 = a[11];
    a30 = a[12];
    a31 = a[13];
    a32 = a[14];
    a33 = a[15];
    b0 = b[0];
    b1 = b[1];
    b2 = b[2];
    b3 = b[3];
    r[0] = a00 * b0 + a10 * b1 + a20 * b2 + a30 * b3;
    r[1] = a01 * b0 + a11 * b1 + a21 * b2 + a31 * b3;
    r[2] = a02 * b0 + a12 * b1 + a22 * b2 + a32 * b3;
    r[3] = a03 * b0 + a13 * b1 + a23 * b2 + a33 * b3;
    b0 = b[4];
    b1 = b[5];
    b2 = b[6];
    b3 = b[7];
    r[4] = a00 * b0 + a10 * b1 + a20 * b2 + a30 * b3;
    r[5] = a01 * b0 + a11 * b1 + a21 * b2 + a31 * b3;
    r[6] = a02 * b0 + a12 * b1 + a22 * b2 + a32 * b3;
    r[7] = a03 * b0 + a13 * b1 + a23 * b2 + a33 * b3;
    b0 = b[8];
    b1 = b[9];
    b2 = b[10];
    b3 = b[11];
    r[8] = a00 * b0 + a10 * b1 + a20 * b2 + a30 * b3;
    r[9] = a01 * b0 + a11 * b1 + a21 * b2 + a31 * b3;
    r[10] = a02 * b0 + a12 * b1 + a22 * b2 + a32 * b3;
    r[11] = a03 * b0 + a13 * b1 + a23 * b2 + a33 * b3;
    b0 = b[12];
    b1 = b[13];
    b2 = b[14];
    b3 = b[15];
    r[12] = a00 * b0 + a10 * b1 + a20 * b2 + a30 * b3;
    r[13] = a01 * b0 + a11 * b1 + a21 * b2 + a31 * b3;
    r[14] = a02 * b0 + a12 * b1 + a22 * b2 + a32 * b3;
    r[15] = a03 * b0 + a13 * b1 + a23 * b2 + a33 * b3;
    return this;
  }, mul:function(rhs) {
    return this.mul2(this, rhs);
  }, transformPoint:function(vec, res) {
    var x, y, z, m = this.data, v = vec.data;
    res = res === undefined ? new pc.Vec3 : res;
    x = v[0] * m[0] + v[1] * m[4] + v[2] * m[8] + m[12];
    y = v[0] * m[1] + v[1] * m[5] + v[2] * m[9] + m[13];
    z = v[0] * m[2] + v[1] * m[6] + v[2] * m[10] + m[14];
    return res.set(x, y, z);
  }, transformVector:function(vec, res) {
    var x, y, z, m = this.data, v = vec.data;
    res = res === undefined ? new pc.Vec3 : res;
    x = v[0] * m[0] + v[1] * m[4] + v[2] * m[8];
    y = v[0] * m[1] + v[1] * m[5] + v[2] * m[9];
    z = v[0] * m[2] + v[1] * m[6] + v[2] * m[10];
    return res.set(x, y, z);
  }, transformVec4:function(vec, res) {
    var x, y, z, w, m = this.data, v = vec.data;
    res = res === undefined ? new pc.Vec4 : res;
    x = v[0] * m[0] + v[1] * m[4] + v[2] * m[8] + v[3] * m[12];
    y = v[0] * m[1] + v[1] * m[5] + v[2] * m[9] + v[3] * m[13];
    z = v[0] * m[2] + v[1] * m[6] + v[2] * m[10] + v[3] * m[14];
    w = v[0] * m[3] + v[1] * m[7] + v[2] * m[11] + v[3] * m[15];
    return res.set(x, y, z, w);
  }, setLookAt:function() {
    var x, y, z;
    x = new pc.Vec3;
    y = new pc.Vec3;
    z = new pc.Vec3;
    return function(position, target, up) {
      z.sub2(position, target).normalize();
      y.copy(up).normalize();
      x.cross(y, z).normalize();
      y.cross(z, x);
      var r = this.data;
      r[0] = x.x;
      r[1] = x.y;
      r[2] = x.z;
      r[3] = 0;
      r[4] = y.x;
      r[5] = y.y;
      r[6] = y.z;
      r[7] = 0;
      r[8] = z.x;
      r[9] = z.y;
      r[10] = z.z;
      r[11] = 0;
      r[12] = position.x;
      r[13] = position.y;
      r[14] = position.z;
      r[15] = 1;
      return this;
    };
  }(), setFrustum:function(left, right, bottom, top, znear, zfar) {
    var temp1, temp2, temp3, temp4, r;
    temp1 = 2 * znear;
    temp2 = right - left;
    temp3 = top - bottom;
    temp4 = zfar - znear;
    r = this.data;
    r[0] = temp1 / temp2;
    r[1] = 0;
    r[2] = 0;
    r[3] = 0;
    r[4] = 0;
    r[5] = temp1 / temp3;
    r[6] = 0;
    r[7] = 0;
    r[8] = (right + left) / temp2;
    r[9] = (top + bottom) / temp3;
    r[10] = (-zfar - znear) / temp4;
    r[11] = -1;
    r[12] = 0;
    r[13] = 0;
    r[14] = -temp1 * zfar / temp4;
    r[15] = 0;
    return this;
  }, setPerspective:function(fovy, aspect, znear, zfar, fovIsHorizontal) {
    var xmax, ymax;
    if (!fovIsHorizontal) {
      ymax = znear * Math.tan(fovy * Math.PI / 360);
      xmax = ymax * aspect;
    } else {
      xmax = znear * Math.tan(fovy * Math.PI / 360);
      ymax = xmax / aspect;
    }
    return this.setFrustum(-xmax, xmax, -ymax, ymax, znear, zfar);
  }, setOrtho:function(left, right, bottom, top, near, far) {
    var r = this.data;
    r[0] = 2 / (right - left);
    r[1] = 0;
    r[2] = 0;
    r[3] = 0;
    r[4] = 0;
    r[5] = 2 / (top - bottom);
    r[6] = 0;
    r[7] = 0;
    r[8] = 0;
    r[9] = 0;
    r[10] = -2 / (far - near);
    r[11] = 0;
    r[12] = -(right + left) / (right - left);
    r[13] = -(top + bottom) / (top - bottom);
    r[14] = -(far + near) / (far - near);
    r[15] = 1;
    return this;
  }, setFromAxisAngle:function(axis, angle) {
    var x, y, z, c, s, t, tx, ty, m;
    angle *= pc.math.DEG_TO_RAD;
    x = axis.x;
    y = axis.y;
    z = axis.z;
    c = Math.cos(angle);
    s = Math.sin(angle);
    t = 1 - c;
    tx = t * x;
    ty = t * y;
    m = this.data;
    m[0] = tx * x + c;
    m[1] = tx * y + s * z;
    m[2] = tx * z - s * y;
    m[3] = 0;
    m[4] = tx * y - s * z;
    m[5] = ty * y + c;
    m[6] = ty * z + s * x;
    m[7] = 0;
    m[8] = tx * z + s * y;
    m[9] = ty * z - x * s;
    m[10] = t * z * z + c;
    m[11] = 0;
    m[12] = 0;
    m[13] = 0;
    m[14] = 0;
    m[15] = 1;
    return this;
  }, setTranslate:function(tx, ty, tz) {
    var m = this.data;
    m[0] = 1;
    m[1] = 0;
    m[2] = 0;
    m[3] = 0;
    m[4] = 0;
    m[5] = 1;
    m[6] = 0;
    m[7] = 0;
    m[8] = 0;
    m[9] = 0;
    m[10] = 1;
    m[11] = 0;
    m[12] = tx;
    m[13] = ty;
    m[14] = tz;
    m[15] = 1;
    return this;
  }, setScale:function(sx, sy, sz) {
    var m = this.data;
    m[0] = sx;
    m[1] = 0;
    m[2] = 0;
    m[3] = 0;
    m[4] = 0;
    m[5] = sy;
    m[6] = 0;
    m[7] = 0;
    m[8] = 0;
    m[9] = 0;
    m[10] = sz;
    m[11] = 0;
    m[12] = 0;
    m[13] = 0;
    m[14] = 0;
    m[15] = 1;
    return this;
  }, invert:function() {
    var a00, a01, a02, a03, a10, a11, a12, a13, a20, a21, a22, a23, a30, a31, a32, a33, b00, b01, b02, b03, b04, b05, b06, b07, b08, b09, b10, b11, det, invDet, m;
    m = this.data;
    a00 = m[0];
    a01 = m[1];
    a02 = m[2];
    a03 = m[3];
    a10 = m[4];
    a11 = m[5];
    a12 = m[6];
    a13 = m[7];
    a20 = m[8];
    a21 = m[9];
    a22 = m[10];
    a23 = m[11];
    a30 = m[12];
    a31 = m[13];
    a32 = m[14];
    a33 = m[15];
    b00 = a00 * a11 - a01 * a10;
    b01 = a00 * a12 - a02 * a10;
    b02 = a00 * a13 - a03 * a10;
    b03 = a01 * a12 - a02 * a11;
    b04 = a01 * a13 - a03 * a11;
    b05 = a02 * a13 - a03 * a12;
    b06 = a20 * a31 - a21 * a30;
    b07 = a20 * a32 - a22 * a30;
    b08 = a20 * a33 - a23 * a30;
    b09 = a21 * a32 - a22 * a31;
    b10 = a21 * a33 - a23 * a31;
    b11 = a22 * a33 - a23 * a32;
    det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;
    if (det === 0) {
      this.setIdentity();
    } else {
      invDet = 1 / det;
      m[0] = (a11 * b11 - a12 * b10 + a13 * b09) * invDet;
      m[1] = (-a01 * b11 + a02 * b10 - a03 * b09) * invDet;
      m[2] = (a31 * b05 - a32 * b04 + a33 * b03) * invDet;
      m[3] = (-a21 * b05 + a22 * b04 - a23 * b03) * invDet;
      m[4] = (-a10 * b11 + a12 * b08 - a13 * b07) * invDet;
      m[5] = (a00 * b11 - a02 * b08 + a03 * b07) * invDet;
      m[6] = (-a30 * b05 + a32 * b02 - a33 * b01) * invDet;
      m[7] = (a20 * b05 - a22 * b02 + a23 * b01) * invDet;
      m[8] = (a10 * b10 - a11 * b08 + a13 * b06) * invDet;
      m[9] = (-a00 * b10 + a01 * b08 - a03 * b06) * invDet;
      m[10] = (a30 * b04 - a31 * b02 + a33 * b00) * invDet;
      m[11] = (-a20 * b04 + a21 * b02 - a23 * b00) * invDet;
      m[12] = (-a10 * b09 + a11 * b07 - a12 * b06) * invDet;
      m[13] = (a00 * b09 - a01 * b07 + a02 * b06) * invDet;
      m[14] = (-a30 * b03 + a31 * b01 - a32 * b00) * invDet;
      m[15] = (a20 * b03 - a21 * b01 + a22 * b00) * invDet;
    }
    return this;
  }, set:function(src) {
    var dst = this.data;
    dst[0] = src[0];
    dst[1] = src[1];
    dst[2] = src[2];
    dst[3] = src[3];
    dst[4] = src[4];
    dst[5] = src[5];
    dst[6] = src[6];
    dst[7] = src[7];
    dst[8] = src[8];
    dst[9] = src[9];
    dst[10] = src[10];
    dst[11] = src[11];
    dst[12] = src[12];
    dst[13] = src[13];
    dst[14] = src[14];
    dst[15] = src[15];
    return this;
  }, setIdentity:function() {
    var m = this.data;
    m[0] = 1;
    m[1] = 0;
    m[2] = 0;
    m[3] = 0;
    m[4] = 0;
    m[5] = 1;
    m[6] = 0;
    m[7] = 0;
    m[8] = 0;
    m[9] = 0;
    m[10] = 1;
    m[11] = 0;
    m[12] = 0;
    m[13] = 0;
    m[14] = 0;
    m[15] = 1;
    return this;
  }, setTRS:function(t, r, s) {
    var tx, ty, tz, qx, qy, qz, qw, sx, sy, sz, x2, y2, z2, xx, xy, xz, yy, yz, zz, wx, wy, wz, m;
    tx = t.x;
    ty = t.y;
    tz = t.z;
    qx = r.x;
    qy = r.y;
    qz = r.z;
    qw = r.w;
    sx = s.x;
    sy = s.y;
    sz = s.z;
    x2 = qx + qx;
    y2 = qy + qy;
    z2 = qz + qz;
    xx = qx * x2;
    xy = qx * y2;
    xz = qx * z2;
    yy = qy * y2;
    yz = qy * z2;
    zz = qz * z2;
    wx = qw * x2;
    wy = qw * y2;
    wz = qw * z2;
    m = this.data;
    m[0] = (1 - (yy + zz)) * sx;
    m[1] = (xy + wz) * sx;
    m[2] = (xz - wy) * sx;
    m[3] = 0;
    m[4] = (xy - wz) * sy;
    m[5] = (1 - (xx + zz)) * sy;
    m[6] = (yz + wx) * sy;
    m[7] = 0;
    m[8] = (xz + wy) * sz;
    m[9] = (yz - wx) * sz;
    m[10] = (1 - (xx + yy)) * sz;
    m[11] = 0;
    m[12] = tx;
    m[13] = ty;
    m[14] = tz;
    m[15] = 1;
    return this;
  }, transpose:function() {
    var tmp, m = this.data;
    tmp = m[1];
    m[1] = m[4];
    m[4] = tmp;
    tmp = m[2];
    m[2] = m[8];
    m[8] = tmp;
    tmp = m[3];
    m[3] = m[12];
    m[12] = tmp;
    tmp = m[6];
    m[6] = m[9];
    m[9] = tmp;
    tmp = m[7];
    m[7] = m[13];
    m[13] = tmp;
    tmp = m[11];
    m[11] = m[14];
    m[14] = tmp;
    return this;
  }, invertTo3x3:function(res) {
    var a11, a21, a31, a12, a22, a32, a13, a23, a33, m, r, det, idet;
    m = this.data;
    r = res.data;
    var m0 = m[0];
    var m1 = m[1];
    var m2 = m[2];
    var m3 = m[3];
    var m4 = m[4];
    var m5 = m[5];
    var m6 = m[6];
    var m7 = m[7];
    var m8 = m[8];
    var m9 = m[9];
    var m10 = m[10];
    a11 = m10 * m5 - m6 * m9;
    a21 = -m10 * m1 + m2 * m9;
    a31 = m6 * m1 - m2 * m5;
    a12 = -m10 * m4 + m6 * m8;
    a22 = m10 * m0 - m2 * m8;
    a32 = -m6 * m0 + m2 * m4;
    a13 = m9 * m4 - m5 * m8;
    a23 = -m9 * m0 + m1 * m8;
    a33 = m5 * m0 - m1 * m4;
    det = m0 * a11 + m1 * a12 + m2 * a13;
    if (det === 0) {
      console.warn("pc.Mat4#invertTo3x3: Matrix not invertible");
      return this;
    }
    idet = 1 / det;
    r[0] = idet * a11;
    r[1] = idet * a21;
    r[2] = idet * a31;
    r[3] = idet * a12;
    r[4] = idet * a22;
    r[5] = idet * a32;
    r[6] = idet * a13;
    r[7] = idet * a23;
    r[8] = idet * a33;
    return this;
  }, getTranslation:function(t) {
    t = t === undefined ? new pc.Vec3 : t;
    return t.set(this.data[12], this.data[13], this.data[14]);
  }, getX:function(x) {
    x = x === undefined ? new pc.Vec3 : x;
    return x.set(this.data[0], this.data[1], this.data[2]);
  }, getY:function(y) {
    y = y === undefined ? new pc.Vec3 : y;
    return y.set(this.data[4], this.data[5], this.data[6]);
  }, getZ:function(z) {
    z = z === undefined ? new pc.Vec3 : z;
    return z.set(this.data[8], this.data[9], this.data[10]);
  }, getScale:function() {
    var x, y, z;
    x = new pc.Vec3;
    y = new pc.Vec3;
    z = new pc.Vec3;
    return function(scale) {
      scale = scale === undefined ? new pc.Vec3 : scale;
      this.getX(x);
      this.getY(y);
      this.getZ(z);
      scale.set(x.length(), y.length(), z.length());
      return scale;
    };
  }(), setFromEulerAngles:function(ex, ey, ez) {
    var s1, c1, s2, c2, s3, c3, m;
    ex *= pc.math.DEG_TO_RAD;
    ey *= pc.math.DEG_TO_RAD;
    ez *= pc.math.DEG_TO_RAD;
    s1 = Math.sin(-ex);
    c1 = Math.cos(-ex);
    s2 = Math.sin(-ey);
    c2 = Math.cos(-ey);
    s3 = Math.sin(-ez);
    c3 = Math.cos(-ez);
    m = this.data;
    m[0] = c2 * c3;
    m[1] = -c2 * s3;
    m[2] = s2;
    m[3] = 0;
    m[4] = c1 * s3 + c3 * s1 * s2;
    m[5] = c1 * c3 - s1 * s2 * s3;
    m[6] = -c2 * s1;
    m[7] = 0;
    m[8] = s1 * s3 - c1 * c3 * s2;
    m[9] = c3 * s1 + c1 * s2 * s3;
    m[10] = c1 * c2;
    m[11] = 0;
    m[12] = 0;
    m[13] = 0;
    m[14] = 0;
    m[15] = 1;
    return this;
  }, getEulerAngles:function() {
    var scale = new pc.Vec3;
    return function(eulers) {
      var x, y, z, sx, sy, sz, m, halfPi;
      eulers = eulers === undefined ? new pc.Vec3 : eulers;
      this.getScale(scale);
      sx = scale.x;
      sy = scale.y;
      sz = scale.z;
      m = this.data;
      y = Math.asin(-m[2] / sx);
      halfPi = Math.PI * 0.5;
      if (y < halfPi) {
        if (y > -halfPi) {
          x = Math.atan2(m[6] / sy, m[10] / sz);
          z = Math.atan2(m[1] / sx, m[0] / sx);
        } else {
          z = 0;
          x = -Math.atan2(m[4] / sy, m[5] / sy);
        }
      } else {
        z = 0;
        x = Math.atan2(m[4] / sy, m[5] / sy);
      }
      return eulers.set(x, y, z).scale(pc.math.RAD_TO_DEG);
    };
  }(), toString:function() {
    var i, t;
    t = "[";
    for (i = 0;i < 16;i += 1) {
      t += this.data[i];
      t += i !== 15 ? ", " : "";
    }
    t += "]";
    return t;
  }};
  Object.defineProperty(Mat4, "IDENTITY", {get:function() {
    var identity = new Mat4;
    return function() {
      return identity;
    };
  }()});
  Object.defineProperty(Mat4, "ZERO", {get:function() {
    var zero = new Mat4(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Mat4:Mat4};
}());
pc.extend(pc, function() {
  var Quat = function(x, y, z, w) {
    if (x && x.length === 4) {
      this.x = x[0];
      this.y = x[1];
      this.z = x[2];
      this.w = x[3];
    } else {
      this.x = x === undefined ? 0 : x;
      this.y = y === undefined ? 0 : y;
      this.z = z === undefined ? 0 : z;
      this.w = w === undefined ? 1 : w;
    }
  };
  Quat.prototype = {clone:function() {
    return new pc.Quat(this.x, this.y, this.z, this.w);
  }, conjugate:function() {
    this.x *= -1;
    this.y *= -1;
    this.z *= -1;
    return this;
  }, copy:function(rhs) {
    this.x = rhs.x;
    this.y = rhs.y;
    this.z = rhs.z;
    this.w = rhs.w;
    return this;
  }, equals:function(that) {
    return this.x === that.x && this.y === that.y && this.z === that.z && this.w === that.w;
  }, getEulerAngles:function(eulers) {
    var x, y, z, qx, qy, qz, qw, a2;
    eulers = eulers === undefined ? new pc.Vec3 : eulers;
    qx = this.x;
    qy = this.y;
    qz = this.z;
    qw = this.w;
    a2 = 2 * (qw * qy - qx * qz);
    if (a2 <= -0.99999) {
      x = 2 * Math.atan2(qx, qw);
      y = -Math.PI / 2;
      z = 0;
    } else {
      if (a2 >= 0.99999) {
        x = 2 * Math.atan2(qx, qw);
        y = Math.PI / 2;
        z = 0;
      } else {
        x = Math.atan2(2 * (qw * qx + qy * qz), 1 - 2 * (qx * qx + qy * qy));
        y = Math.asin(a2);
        z = Math.atan2(2 * (qw * qz + qx * qy), 1 - 2 * (qy * qy + qz * qz));
      }
    }
    return eulers.set(x, y, z).scale(pc.math.RAD_TO_DEG);
  }, invert:function() {
    return this.conjugate().normalize();
  }, length:function() {
    var x, y, z, w;
    x = this.x;
    y = this.y;
    z = this.z;
    w = this.w;
    return Math.sqrt(x * x + y * y + z * z + w * w);
  }, lengthSq:function() {
    var x, y, z, w;
    return x * x + y * y + z * z + w * w;
  }, mul:function(rhs) {
    var q1x, q1y, q1z, q1w, q2x, q2y, q2z, q2w;
    q1x = this.x;
    q1y = this.y;
    q1z = this.z;
    q1w = this.w;
    q2x = rhs.x;
    q2y = rhs.y;
    q2z = rhs.z;
    q2w = rhs.w;
    this.x = q1w * q2x + q1x * q2w + q1y * q2z - q1z * q2y;
    this.y = q1w * q2y + q1y * q2w + q1z * q2x - q1x * q2z;
    this.z = q1w * q2z + q1z * q2w + q1x * q2y - q1y * q2x;
    this.w = q1w * q2w - q1x * q2x - q1y * q2y - q1z * q2z;
    return this;
  }, mul2:function(lhs, rhs) {
    var q1x, q1y, q1z, q1w, q2x, q2y, q2z, q2w;
    q1x = lhs.x;
    q1y = lhs.y;
    q1z = lhs.z;
    q1w = lhs.w;
    q2x = rhs.x;
    q2y = rhs.y;
    q2z = rhs.z;
    q2w = rhs.w;
    this.x = q1w * q2x + q1x * q2w + q1y * q2z - q1z * q2y;
    this.y = q1w * q2y + q1y * q2w + q1z * q2x - q1x * q2z;
    this.z = q1w * q2z + q1z * q2w + q1x * q2y - q1y * q2x;
    this.w = q1w * q2w - q1x * q2x - q1y * q2y - q1z * q2z;
    return this;
  }, normalize:function() {
    var len = this.length();
    if (len === 0) {
      this.x = this.y = this.z = 0;
      this.w = 1;
    } else {
      len = 1 / len;
      this.x *= len;
      this.y *= len;
      this.z *= len;
      this.w *= len;
    }
    return this;
  }, set:function(x, y, z, w) {
    this.x = x;
    this.y = y;
    this.z = z;
    this.w = w;
    return this;
  }, setFromAxisAngle:function(axis, angle) {
    var sa, ca;
    angle *= 0.5 * pc.math.DEG_TO_RAD;
    sa = Math.sin(angle);
    ca = Math.cos(angle);
    this.x = sa * axis.x;
    this.y = sa * axis.y;
    this.z = sa * axis.z;
    this.w = ca;
    return this;
  }, setFromEulerAngles:function(ex, ey, ez) {
    var sx, cx, sy, cy, sz, cz, halfToRad;
    halfToRad = 0.5 * pc.math.DEG_TO_RAD;
    ex *= halfToRad;
    ey *= halfToRad;
    ez *= halfToRad;
    sx = Math.sin(ex);
    cx = Math.cos(ex);
    sy = Math.sin(ey);
    cy = Math.cos(ey);
    sz = Math.sin(ez);
    cz = Math.cos(ez);
    this.x = sx * cy * cz - cx * sy * sz;
    this.y = cx * sy * cz + sx * cy * sz;
    this.z = cx * cy * sz - sx * sy * cz;
    this.w = cx * cy * cz + sx * sy * sz;
    return this;
  }, setFromMat4:function(m) {
    var m00, m01, m02, m10, m11, m12, m20, m21, m22, tr, s, rs, lx, ly, lz;
    m = m.data;
    m00 = m[0];
    m01 = m[1];
    m02 = m[2];
    m10 = m[4];
    m11 = m[5];
    m12 = m[6];
    m20 = m[8];
    m21 = m[9];
    m22 = m[10];
    lx = 1 / Math.sqrt(m00 * m00 + m01 * m01 + m02 * m02);
    ly = 1 / Math.sqrt(m10 * m10 + m11 * m11 + m12 * m12);
    lz = 1 / Math.sqrt(m20 * m20 + m21 * m21 + m22 * m22);
    m00 *= lx;
    m01 *= lx;
    m02 *= lx;
    m10 *= ly;
    m11 *= ly;
    m12 *= ly;
    m20 *= lz;
    m21 *= lz;
    m22 *= lz;
    tr = m00 + m11 + m22;
    if (tr >= 0) {
      s = Math.sqrt(tr + 1);
      this.w = s * 0.5;
      s = 0.5 / s;
      this.x = (m12 - m21) * s;
      this.y = (m20 - m02) * s;
      this.z = (m01 - m10) * s;
    } else {
      if (m00 > m11) {
        if (m00 > m22) {
          rs = m00 - (m11 + m22) + 1;
          rs = Math.sqrt(rs);
          this.x = rs * 0.5;
          rs = 0.5 / rs;
          this.w = (m12 - m21) * rs;
          this.y = (m01 + m10) * rs;
          this.z = (m02 + m20) * rs;
        } else {
          rs = m22 - (m00 + m11) + 1;
          rs = Math.sqrt(rs);
          this.z = rs * 0.5;
          rs = 0.5 / rs;
          this.w = (m01 - m10) * rs;
          this.x = (m20 + m02) * rs;
          this.y = (m21 + m12) * rs;
        }
      } else {
        if (m11 > m22) {
          rs = m11 - (m22 + m00) + 1;
          rs = Math.sqrt(rs);
          this.y = rs * 0.5;
          rs = 0.5 / rs;
          this.w = (m20 - m02) * rs;
          this.z = (m12 + m21) * rs;
          this.x = (m10 + m01) * rs;
        } else {
          rs = m22 - (m00 + m11) + 1;
          rs = Math.sqrt(rs);
          this.z = rs * 0.5;
          rs = 0.5 / rs;
          this.w = (m01 - m10) * rs;
          this.x = (m20 + m02) * rs;
          this.y = (m21 + m12) * rs;
        }
      }
    }
    return this;
  }, slerp:function(lhs, rhs, alpha) {
    var lx, ly, lz, lw, rx, ry, rz, rw;
    lx = lhs.x;
    ly = lhs.y;
    lz = lhs.z;
    lw = lhs.w;
    rx = rhs.x;
    ry = rhs.y;
    rz = rhs.z;
    rw = rhs.w;
    var cosHalfTheta = lw * rw + lx * rx + ly * ry + lz * rz;
    if (cosHalfTheta < 0) {
      rw = -rw;
      rx = -rx;
      ry = -ry;
      rz = -rz;
      cosHalfTheta = -cosHalfTheta;
    }
    if (Math.abs(cosHalfTheta) >= 1) {
      this.w = lw;
      this.x = lx;
      this.y = ly;
      this.z = lz;
      return this;
    }
    var halfTheta = Math.acos(cosHalfTheta);
    var sinHalfTheta = Math.sqrt(1 - cosHalfTheta * cosHalfTheta);
    if (Math.abs(sinHalfTheta) < 0.001) {
      this.w = lw * 0.5 + rw * 0.5;
      this.x = lx * 0.5 + rx * 0.5;
      this.y = ly * 0.5 + ry * 0.5;
      this.z = lz * 0.5 + rz * 0.5;
      return this;
    }
    var ratioA = Math.sin((1 - alpha) * halfTheta) / sinHalfTheta;
    var ratioB = Math.sin(alpha * halfTheta) / sinHalfTheta;
    this.w = lw * ratioA + rw * ratioB;
    this.x = lx * ratioA + rx * ratioB;
    this.y = ly * ratioA + ry * ratioB;
    this.z = lz * ratioA + rz * ratioB;
    return this;
  }, transformVector:function(vec, res) {
    if (res === undefined) {
      res = new pc.Vec3;
    }
    var x = vec.x, y = vec.y, z = vec.z;
    var qx = this.x, qy = this.y, qz = this.z, qw = this.w;
    var ix = qw * x + qy * z - qz * y;
    var iy = qw * y + qz * x - qx * z;
    var iz = qw * z + qx * y - qy * x;
    var iw = -qx * x - qy * y - qz * z;
    res.x = ix * qw + iw * -qx + iy * -qz - iz * -qy;
    res.y = iy * qw + iw * -qy + iz * -qx - ix * -qz;
    res.z = iz * qw + iw * -qz + ix * -qy - iy * -qx;
    return res;
  }, toString:function() {
    return "[" + this.x + ", " + this.y + ", " + this.z + ", " + this.w + "]";
  }};
  Object.defineProperty(Quat, "IDENTITY", {get:function() {
    var identity = new Quat;
    return function() {
      return identity;
    };
  }()});
  Object.defineProperty(Quat, "ZERO", {get:function() {
    var zero = new Quat(0, 0, 0, 0);
    return function() {
      return zero;
    };
  }()});
  return {Quat:Quat};
}());
pc.extend(pc, function() {
  var CURVE_LINEAR = 0;
  var CURVE_SMOOTHSTEP = 1;
  var CURVE_CATMULL = 2;
  var CURVE_CARDINAL = 3;
  var Curve = function(data) {
    this.keys = [];
    this.type = CURVE_SMOOTHSTEP;
    this.tension = 0.5;
    if (data) {
      for (var i = 0;i < data.length - 1;i += 2) {
        this.keys.push([data[i], data[i + 1]]);
      }
    }
    this.sort();
  };
  Curve.prototype = {add:function(time, value) {
    var keys = this.keys;
    var len = keys.length;
    var i = 0;
    for (;i < len;i++) {
      if (keys[i][0] > time) {
        break;
      }
    }
    var key = [time, value];
    this.keys.splice(i, 0, key);
    return key;
  }, get:function(index) {
    return this.keys[index];
  }, sort:function() {
    this.keys.sort(function(a, b) {
      return a[0] - b[0];
    });
  }, value:function(time) {
    var keys = this.keys;
    if (!keys.length) {
      return 0;
    }
    if (time < keys[0][0]) {
      return keys[0][1];
    } else {
      if (time > keys[keys.length - 1][0]) {
        return keys[keys.length - 1][1];
      }
    }
    var leftTime = 0;
    var leftValue = keys.length ? keys[0][1] : 0;
    var rightTime = 1;
    var rightValue = 0;
    for (var i = 0, len = keys.length;i < len;i++) {
      if (keys[i][0] === time) {
        return keys[i][1];
      }
      rightValue = keys[i][1];
      if (time < keys[i][0]) {
        rightTime = keys[i][0];
        break;
      }
      leftTime = keys[i][0];
      leftValue = keys[i][1];
    }
    var div = rightTime - leftTime;
    var interpolation = div === 0 ? 0 : (time - leftTime) / div;
    if (this.type === CURVE_SMOOTHSTEP) {
      interpolation *= interpolation * (3 - 2 * interpolation);
    } else {
      if (this.type === CURVE_CATMULL || this.type === CURVE_CARDINAL) {
        var p1 = leftValue;
        var p2 = rightValue;
        var p0 = p1 + (p1 - p2);
        var p3 = p2 + (p2 - p1);
        var dt1 = rightTime - leftTime;
        var dt0 = dt1;
        var dt2 = dt1;
        if (i > 0) {
          i = i - 1;
        }
        if (i > 0) {
          p0 = keys[i - 1][1];
          dt0 = keys[i][0] - keys[i - 1][0];
        }
        if (keys.length > i + 1) {
          dt1 = keys[i + 1][0] - keys[i][0];
        }
        if (keys.length > i + 2) {
          dt2 = keys[i + 2][0] - keys[i + 1][0];
          p3 = keys[i + 2][1];
        }
        p0 = p1 + (p0 - p1) * dt1 / dt0;
        p3 = p2 + (p3 - p2) * dt1 / dt2;
        if (this.type === CURVE_CATMULL) {
          return this._interpolateCatmullRom(p0, p1, p2, p3, interpolation);
        } else {
          return this._interpolateCardinal(p0, p1, p2, p3, interpolation, this.tension);
        }
      }
    }
    return pc.math.lerp(leftValue, rightValue, interpolation);
  }, _interpolateHermite:function(p0, p1, t0, t1, s) {
    var s2 = s * s;
    var s3 = s * s * s;
    var h0 = 2 * s3 - 3 * s2 + 1;
    var h1 = -2 * s3 + 3 * s2;
    var h2 = s3 - 2 * s2 + s;
    var h3 = s3 - s2;
    return p0 * h0 + p1 * h1 + t0 * h2 + t1 * h3;
  }, _interpolateCardinal:function(p0, p1, p2, p3, s, t) {
    var t0 = t * (p2 - p0);
    var t1 = t * (p3 - p1);
    return this._interpolateHermite(p1, p2, t0, t1, s);
  }, _interpolateCatmullRom:function(p0, p1, p2, p3, s) {
    return this._interpolateCardinal(p0, p1, p2, p3, s, 0.5);
  }, closest:function(time) {
    var keys = this.keys;
    var length = keys.length;
    var min = 2;
    var result = null;
    for (var i = 0;i < length;i++) {
      var diff = Math.abs(time - keys[i][0]);
      if (min >= diff) {
        min = diff;
        result = keys[i];
      } else {
        break;
      }
    }
    return result;
  }, clone:function() {
    var result = new pc.Curve;
    result.keys = pc.extend(result.keys, this.keys);
    result.type = this.type;
    return result;
  }, quantize:function(precision) {
    precision = Math.max(precision, 2);
    var values = new Float32Array(precision);
    var step = 1.0 / (precision - 1);
    for (var i = 0;i < precision;i++) {
      var value = this.value(step * i);
      values[i] = value;
    }
    return values;
  }};
  Object.defineProperty(Curve.prototype, "length", {get:function() {
    return this.keys.length;
  }});
  return {Curve:Curve, CURVE_LINEAR:CURVE_LINEAR, CURVE_SMOOTHSTEP:CURVE_SMOOTHSTEP, CURVE_CATMULL:CURVE_CATMULL, CURVE_CARDINAL:CURVE_CARDINAL};
}());
pc.extend(pc, function() {
  var CurveSet = function() {
    var i;
    this.curves = [];
    this._type = pc.CURVE_SMOOTHSTEP;
    if (arguments.length > 1) {
      for (i = 0;i < arguments.length;i++) {
        this.curves.push(new pc.Curve(arguments[i]));
      }
    } else {
      if (arguments.length === 0) {
        this.curves.push(new pc.Curve);
      } else {
        var arg = arguments[0];
        if (pc.type(arg) === "number") {
          for (i = 0;i < arg;i++) {
            this.curves.push(new pc.Curve);
          }
        } else {
          for (i = 0;i < arg.length;i++) {
            this.curves.push(new pc.Curve(arg[i]));
          }
        }
      }
    }
  };
  CurveSet.prototype = {get:function(index) {
    return this.curves[index];
  }, value:function(time, result) {
    var length = this.curves.length;
    result = result || [];
    result.length = length;
    for (var i = 0;i < length;i++) {
      result[i] = this.curves[i].value(time);
    }
    return result;
  }, clone:function() {
    var result = new pc.CurveSet;
    result.curves = [];
    for (var i = 0;i < this.curves.length;i++) {
      result.curves.push(this.curves[i].clone());
    }
    result._type = this._type;
    return result;
  }, quantize:function(precision) {
    precision = Math.max(precision, 2);
    var numCurves = this.curves.length;
    var values = new Float32Array(precision * numCurves);
    var step = 1.0 / (precision - 1);
    var temp = [];
    for (var i = 0;i < precision;i++) {
      var value = this.value(step * i, temp);
      if (numCurves == 1) {
        values[i] = value[0];
      } else {
        for (var j = 0;j < numCurves;j++) {
          values[i * numCurves + j] = value[j];
        }
      }
    }
    return values;
  }};
  Object.defineProperty(CurveSet.prototype, "length", {get:function() {
    return this.curves.length;
  }});
  Object.defineProperty(CurveSet.prototype, "type", {get:function() {
    return this._type;
  }, set:function(value) {
    this._type = value;
    for (var i = 0;i < this.curves.length;i++) {
      this.curves[i].type = value;
    }
  }});
  return {CurveSet:CurveSet};
}());
pc.extend(pc, function() {
  var tmpVecA = new pc.Vec3;
  var tmpVecB = new pc.Vec3;
  var tmpVecC = new pc.Vec3;
  var tmpVecD = new pc.Vec3;
  var tmpVecE = new pc.Vec3;
  var tmpVecF = new pc.Vec3;
  var BoundingBox = function BoundingBox(center, halfExtents) {
    this.center = center || new pc.Vec3(0, 0, 0);
    this.halfExtents = halfExtents || new pc.Vec3(0.5, 0.5, 0.5);
    this._min = new pc.Vec3;
    this._max = new pc.Vec3;
  };
  BoundingBox.prototype = {add:function(other) {
    var tc = this.center.data;
    var tcx = tc[0];
    var tcy = tc[1];
    var tcz = tc[2];
    var th = this.halfExtents.data;
    var thx = th[0];
    var thy = th[1];
    var thz = th[2];
    var tminx = tcx - thx;
    var tmaxx = tcx + thx;
    var tminy = tcy - thy;
    var tmaxy = tcy + thy;
    var tminz = tcz - thz;
    var tmaxz = tcz + thz;
    var oc = other.center.data;
    var ocx = oc[0];
    var ocy = oc[1];
    var ocz = oc[2];
    var oh = other.halfExtents.data;
    var ohx = oh[0];
    var ohy = oh[1];
    var ohz = oh[2];
    var ominx = ocx - ohx;
    var omaxx = ocx + ohx;
    var ominy = ocy - ohy;
    var omaxy = ocy + ohy;
    var ominz = ocz - ohz;
    var omaxz = ocz + ohz;
    if (ominx < tminx) {
      tminx = ominx;
    }
    if (omaxx > tmaxx) {
      tmaxx = omaxx;
    }
    if (ominy < tminy) {
      tminy = ominy;
    }
    if (omaxy > tmaxy) {
      tmaxy = omaxy;
    }
    if (ominz < tminz) {
      tminz = ominz;
    }
    if (omaxz > tmaxz) {
      tmaxz = omaxz;
    }
    tc[0] = (tminx + tmaxx) * 0.5;
    tc[1] = (tminy + tmaxy) * 0.5;
    tc[2] = (tminz + tmaxz) * 0.5;
    th[0] = (tmaxx - tminx) * 0.5;
    th[1] = (tmaxy - tminy) * 0.5;
    th[2] = (tmaxz - tminz) * 0.5;
  }, copy:function(src) {
    this.center.copy(src.center);
    this.halfExtents.copy(src.halfExtents);
    this.type = src.type;
  }, clone:function() {
    return new pc.BoundingBox(this.center.clone(), this.halfExtents.clone());
  }, intersects:function(other) {
    var aMax = this.getMax();
    var aMin = this.getMin();
    var bMax = other.getMax();
    var bMin = other.getMin();
    return aMin.x <= bMax.x && aMax.x >= bMin.x && aMin.y <= bMax.y && aMax.y >= bMin.y && aMin.z <= bMax.z && aMax.z >= bMin.z;
  }, _intersectsRay:function(ray, point) {
    var tMin = tmpVecA.copy(this.getMin()).sub(ray.origin).data;
    var tMax = tmpVecB.copy(this.getMax()).sub(ray.origin).data;
    var dir = ray.direction.data;
    for (var i = 0;i < 3;i++) {
      if (dir[i] === 0) {
        tMin[i] = tMin[i] < 0 ? -Number.MAX_VALUE : Number.MAX_VALUE;
        tMax[i] = tMax[i] < 0 ? -Number.MAX_VALUE : Number.MAX_VALUE;
      } else {
        tMin[i] /= dir[i];
        tMax[i] /= dir[i];
      }
    }
    var realMin = tmpVecC.set(Math.min(tMin[0], tMax[0]), Math.min(tMin[1], tMax[1]), Math.min(tMin[2], tMax[2])).data;
    var realMax = tmpVecD.set(Math.max(tMin[0], tMax[0]), Math.max(tMin[1], tMax[1]), Math.max(tMin[2], tMax[2])).data;
    var minMax = Math.min(Math.min(realMax[0], realMax[1]), realMax[2]);
    var maxMin = Math.max(Math.max(realMin[0], realMin[1]), realMin[2]);
    var intersects = minMax >= maxMin && maxMin >= 0;
    if (intersects) {
      point.copy(ray.direction).scale(maxMin).add(ray.origin);
    }
    return intersects;
  }, _fastIntersectsRay:function(ray) {
    var diff = tmpVecA;
    var cross = tmpVecB;
    var prod = tmpVecC;
    var absDiff = tmpVecD;
    var absDir = tmpVecE;
    var rayDir = ray.direction;
    var i;
    diff.sub2(ray.origin, this.center);
    absDiff.set(Math.abs(diff.x), Math.abs(diff.y), Math.abs(diff.z));
    prod.mul2(diff, rayDir);
    if (absDiff.x > this.halfExtents.x && prod.x >= 0) {
      return false;
    }
    if (absDiff.y > this.halfExtents.y && prod.y >= 0) {
      return false;
    }
    if (absDiff.z > this.halfExtents.z && prod.z >= 0) {
      return false;
    }
    absDir.set(Math.abs(rayDir.x), Math.abs(rayDir.y), Math.abs(rayDir.z));
    cross.cross(rayDir, diff);
    cross.set(Math.abs(cross.x), Math.abs(cross.y), Math.abs(cross.z));
    if (cross.x > this.halfExtents.y * absDir.z + this.halfExtents.z * absDir.y) {
      return false;
    }
    if (cross.y > this.halfExtents.x * absDir.z + this.halfExtents.z * absDir.x) {
      return false;
    }
    if (cross.z > this.halfExtents.x * absDir.y + this.halfExtents.y * absDir.x) {
      return false;
    }
    return true;
  }, intersectsRay:function(ray, point) {
    if (point) {
      return this._intersectsRay(ray, point);
    } else {
      return this._fastIntersectsRay(ray);
    }
  }, setMinMax:function(min, max) {
    this.center.add2(max, min).scale(0.5);
    this.halfExtents.sub2(max, min).scale(0.5);
  }, getMin:function() {
    return this._min.copy(this.center).sub(this.halfExtents);
  }, getMax:function() {
    return this._max.copy(this.center).add(this.halfExtents);
  }, containsPoint:function(point) {
    var min = this.getMin();
    var max = this.getMax();
    var i;
    for (i = 0;i < 3;++i) {
      if (point.data[i] < min.data[i] || point.data[i] > max.data[i]) {
        return false;
      }
    }
    return true;
  }, setFromTransformedAabb:function(aabb, m) {
    var bc = this.center;
    var br = this.halfExtents;
    var ac = aabb.center.data;
    var ar = aabb.halfExtents.data;
    m = m.data;
    var mx0 = m[0];
    var mx1 = m[4];
    var mx2 = m[8];
    var my0 = m[1];
    var my1 = m[5];
    var my2 = m[9];
    var mz0 = m[2];
    var mz1 = m[6];
    var mz2 = m[10];
    var mx0a = Math.abs(mx0);
    var mx1a = Math.abs(mx1);
    var mx2a = Math.abs(mx2);
    var my0a = Math.abs(my0);
    var my1a = Math.abs(my1);
    var my2a = Math.abs(my2);
    var mz0a = Math.abs(mz0);
    var mz1a = Math.abs(mz1);
    var mz2a = Math.abs(mz2);
    bc.set(m[12] + mx0 * ac[0] + mx1 * ac[1] + mx2 * ac[2], m[13] + my0 * ac[0] + my1 * ac[1] + my2 * ac[2], m[14] + mz0 * ac[0] + mz1 * ac[1] + mz2 * ac[2]);
    br.set(mx0a * ar[0] + mx1a * ar[1] + mx2a * ar[2], my0a * ar[0] + my1a * ar[1] + my2a * ar[2], mz0a * ar[0] + mz1a * ar[1] + mz2a * ar[2]);
  }, compute:function(vertices) {
    var min = tmpVecA.set(vertices[0], vertices[1], vertices[2]);
    var max = tmpVecB.set(vertices[0], vertices[1], vertices[2]);
    var numVerts = vertices.length / 3;
    for (var i = 1;i < numVerts;i++) {
      var x = vertices[i * 3 + 0];
      var y = vertices[i * 3 + 1];
      var z = vertices[i * 3 + 2];
      if (x < min.x) {
        min.x = x;
      }
      if (y < min.y) {
        min.y = y;
      }
      if (z < min.z) {
        min.z = z;
      }
      if (x > max.x) {
        max.x = x;
      }
      if (y > max.y) {
        max.y = y;
      }
      if (z > max.z) {
        max.z = z;
      }
    }
    this.setMinMax(min, max);
  }, intersectsBoundingSphere:function(sphere) {
    var sq = this._distanceToBoundingSphereSq(sphere);
    if (sq <= sphere.radius * sphere.radius) {
      return true;
    }
    return false;
  }, _distanceToBoundingSphereSq:function(sphere) {
    var boxMin = this.getMin();
    var boxMax = this.getMax();
    var sq = 0;
    for (var i = 0;i < 3;++i) {
      var out = 0;
      var pn = sphere.center.data[i];
      var bMin = boxMin.data[i];
      var bMax = boxMax.data[i];
      var val = 0;
      if (pn < bMin) {
        val = bMin - pn;
        out += val * val;
      }
      if (pn > bMax) {
        val = pn - bMax;
        out += val * val;
      }
      sq += out;
    }
    return sq;
  }};
  return {BoundingBox:BoundingBox};
}());
pc.extend(pc, function() {
  var tmpVecA = new pc.Vec3;
  var tmpVecB = new pc.Vec3;
  var tmpVecC = new pc.Vec3;
  var tmpVecD = new pc.Vec3;
  var diffBetweenPoints = new pc.Vec3;
  function BoundingSphere(center, radius) {
    this.center = center || new pc.Vec3(0, 0, 0);
    this.radius = radius === undefined ? 0.5 : radius;
  }
  BoundingSphere.prototype = {containsPoint:function(point) {
    var lenSq = tmpVecA.sub2(point, this.center).lengthSq();
    var r = this.radius;
    return lenSq < r * r;
  }, compute:function(vertices) {
    var i;
    var numVerts = vertices.length / 3;
    var vertex = tmpVecA;
    var avgVertex = tmpVecB;
    var sum = tmpVecC;
    for (i = 0;i < numVerts;i++) {
      vertex.set(vertices[i * 3], vertices[i * 3 + 1], vertices[i * 3 + 2]);
      sum.addSelf(vertex);
      if (i % 100 === 0) {
        sum.scale(1 / numVerts);
        avgVertex.add(sum);
        sum.set(0, 0, 0);
      }
    }
    sum.scale(1 / numVerts);
    avgVertex.add(sum);
    this.center.copy(avgVertex);
    var maxDistSq = 0;
    var centerToVert = tmpVecD;
    for (i = 0;i < numVerts;i++) {
      vertex.set(vertices[i * 3], vertices[i * 3 + 1], vertices[i * 3 + 2]);
      centerToVert.sub2(vertex, this.center);
      maxDistSq = Math.max(centerToVert.lengthSq(), maxDistSq);
    }
    this.radius = Math.sqrt(maxDistSq);
  }, intersectsRay:function(ray, point) {
    var m = tmpVecA.copy(ray.origin).sub(this.center);
    var b = m.dot(tmpVecB.copy(ray.direction).normalize());
    var c = m.dot(m) - this.radius * this.radius;
    if (c > 0 && b > 0) {
      return null;
    }
    var discr = b * b - c;
    if (discr < 0) {
      return false;
    }
    var t = Math.abs(-b - Math.sqrt(discr));
    if (point) {
      point.copy(ray.direction).scale(t).add(ray.origin);
    }
    return true;
  }, intersectsBoundingSphere:function(sphere) {
    tmpVecA.sub2(sphere.center, this.center);
    var totalRadius = sphere.radius + this.radius;
    if (tmpVecA.lengthSq() <= totalRadius * totalRadius) {
      return true;
    }
    return false;
  }};
  return {BoundingSphere:BoundingSphere};
}());
pc.extend(pc, function() {
  var viewProj = new pc.Mat4;
  var Frustum = function Frustum(projectionMatrix, viewMatrix) {
    projectionMatrix = projectionMatrix || (new pc.Mat4).setPerspective(90, 16 / 9, 0.1, 1000);
    viewMatrix = viewMatrix || new pc.Mat4;
    this.planes = [];
    for (var i = 0;i < 6;i++) {
      this.planes[i] = [];
    }
    this.update(projectionMatrix, viewMatrix);
  };
  Frustum.prototype = {update:function(projectionMatrix, viewMatrix) {
    viewProj.mul2(projectionMatrix, viewMatrix);
    var vpm = viewProj.data;
    this.planes[0][0] = vpm[3] - vpm[0];
    this.planes[0][1] = vpm[7] - vpm[4];
    this.planes[0][2] = vpm[11] - vpm[8];
    this.planes[0][3] = vpm[15] - vpm[12];
    var t = Math.sqrt(this.planes[0][0] * this.planes[0][0] + this.planes[0][1] * this.planes[0][1] + this.planes[0][2] * this.planes[0][2]);
    this.planes[0][0] /= t;
    this.planes[0][1] /= t;
    this.planes[0][2] /= t;
    this.planes[0][3] /= t;
    this.planes[1][0] = vpm[3] + vpm[0];
    this.planes[1][1] = vpm[7] + vpm[4];
    this.planes[1][2] = vpm[11] + vpm[8];
    this.planes[1][3] = vpm[15] + vpm[12];
    t = Math.sqrt(this.planes[1][0] * this.planes[1][0] + this.planes[1][1] * this.planes[1][1] + this.planes[1][2] * this.planes[1][2]);
    this.planes[1][0] /= t;
    this.planes[1][1] /= t;
    this.planes[1][2] /= t;
    this.planes[1][3] /= t;
    this.planes[2][0] = vpm[3] + vpm[1];
    this.planes[2][1] = vpm[7] + vpm[5];
    this.planes[2][2] = vpm[11] + vpm[9];
    this.planes[2][3] = vpm[15] + vpm[13];
    t = Math.sqrt(this.planes[2][0] * this.planes[2][0] + this.planes[2][1] * this.planes[2][1] + this.planes[2][2] * this.planes[2][2]);
    this.planes[2][0] /= t;
    this.planes[2][1] /= t;
    this.planes[2][2] /= t;
    this.planes[2][3] /= t;
    this.planes[3][0] = vpm[3] - vpm[1];
    this.planes[3][1] = vpm[7] - vpm[5];
    this.planes[3][2] = vpm[11] - vpm[9];
    this.planes[3][3] = vpm[15] - vpm[13];
    t = Math.sqrt(this.planes[3][0] * this.planes[3][0] + this.planes[3][1] * this.planes[3][1] + this.planes[3][2] * this.planes[3][2]);
    this.planes[3][0] /= t;
    this.planes[3][1] /= t;
    this.planes[3][2] /= t;
    this.planes[3][3] /= t;
    this.planes[4][0] = vpm[3] - vpm[2];
    this.planes[4][1] = vpm[7] - vpm[6];
    this.planes[4][2] = vpm[11] - vpm[10];
    this.planes[4][3] = vpm[15] - vpm[14];
    t = Math.sqrt(this.planes[4][0] * this.planes[4][0] + this.planes[4][1] * this.planes[4][1] + this.planes[4][2] * this.planes[4][2]);
    this.planes[4][0] /= t;
    this.planes[4][1] /= t;
    this.planes[4][2] /= t;
    this.planes[4][3] /= t;
    this.planes[5][0] = vpm[3] + vpm[2];
    this.planes[5][1] = vpm[7] + vpm[6];
    this.planes[5][2] = vpm[11] + vpm[10];
    this.planes[5][3] = vpm[15] + vpm[14];
    t = Math.sqrt(this.planes[5][0] * this.planes[5][0] + this.planes[5][1] * this.planes[5][1] + this.planes[5][2] * this.planes[5][2]);
    this.planes[5][0] /= t;
    this.planes[5][1] /= t;
    this.planes[5][2] /= t;
    this.planes[5][3] /= t;
  }, containsPoint:function(point) {
    for (var p = 0;p < 6;p++) {
      if (this.planes[p][0] * point.x + this.planes[p][1] * point.y + this.planes[p][2] * point.z + this.planes[p][3] <= 0) {
        return false;
      }
    }
    return true;
  }, containsSphere:function(sphere) {
    var c = 0;
    var d;
    var p;
    var sr = sphere.radius;
    var sc = sphere.center.data;
    var scx = sc[0];
    var scy = sc[1];
    var scz = sc[2];
    var planes = this.planes;
    var plane;
    for (p = 0;p < 6;p++) {
      plane = planes[p];
      d = plane[0] * scx + plane[1] * scy + plane[2] * scz + plane[3];
      if (d <= -sr) {
        return 0;
      }
      if (d > sr) {
        c++;
      }
    }
    return c === 6 ? 2 : 1;
  }};
  return {Frustum:Frustum};
}());
pc.extend(pc, function() {
  var tmpVecA = new pc.Vec3;
  var Plane = function Plane(point, normal) {
    this.normal = normal || new pc.Vec3(0, 0, 1);
    this.point = point || new pc.Vec3(0, 0, 0);
  };
  Plane.prototype = {intersectsLine:function(start, end, point) {
    var d = -this.normal.dot(this.point);
    var d0 = this.normal.dot(start) + d;
    var d1 = this.normal.dot(end) + d;
    var t = d0 / (d0 - d1);
    var intersects = t >= 0 && t <= 1;
    if (intersects && point) {
      point.lerp(start, end, t);
    }
    return intersects;
  }, intersectsRay:function(ray, point) {
    var pointToOrigin = tmpVecA.sub2(this.point, ray.origin);
    var t = this.normal.dot(pointToOrigin) / this.normal.dot(ray.direction);
    var intersects = t >= 0;
    if (intersects && point) {
      point.copy(ray.direction).scale(t).add(ray.origin);
    }
    return intersects;
  }};
  return {Plane:Plane};
}());
pc.extend(pc, function() {
  var Ray = function Ray(origin, direction) {
    this.origin = origin || new pc.Vec3(0, 0, 0);
    this.direction = direction || new pc.Vec3(0, 0, -1);
  };
  return {Ray:Ray};
}());
pc.extend(pc, function() {
  var tmpRay = new pc.Ray;
  var tmpVec3 = new pc.Vec3;
  var tmpSphere = new pc.BoundingSphere;
  var tmpMat4 = new pc.Mat4;
  var OrientedBox = function OrientedBox(worldTransform, halfExtents) {
    this.halfExtents = halfExtents || new pc.Vec3(0.5, 0.5, 0.5);
    worldTransform = worldTransform || tmpMat4.setIdentity();
    this._modelTransform = worldTransform.clone().invert();
    this._aabb = new pc.BoundingBox(new pc.Vec3, this.halfExtents);
  };
  OrientedBox.prototype = {intersectsRay:function(ray, point) {
    this._modelTransform.transformPoint(ray.origin, tmpRay.origin);
    this._modelTransform.transformVector(ray.direction, tmpRay.direction);
    if (point) {
      var result = this._aabb._intersectsRay(tmpRay, point);
      tmpMat4.copy(this._modelTransform).invert().transformPoint(point, point);
      return result;
    } else {
      return this._aabb._fastIntersectsRay(tmpRay);
    }
  }, containsPoint:function(point) {
    this._modelTransform.transformPoint(point, tmpVec3);
    return this._aabb.containsPoint(tmpVec3);
  }, intersectsBoundingSphere:function(sphere) {
    this._modelTransform.transformPoint(sphere.center, tmpSphere.center);
    tmpSphere.radius = sphere.radius;
    if (this._aabb.intersectsBoundingSphere(tmpSphere)) {
      return true;
    }
    return false;
  }};
  Object.defineProperty(OrientedBox.prototype, "worldTransform", {set:function(value) {
    this._modelTransform.copy(value).invert();
  }});
  return {OrientedBox:OrientedBox};
}());
(function() {
  var enums = {ADDRESS_REPEAT:0, ADDRESS_CLAMP_TO_EDGE:1, ADDRESS_MIRRORED_REPEAT:2, BLENDMODE_ZERO:0, BLENDMODE_ONE:1, BLENDMODE_SRC_COLOR:2, BLENDMODE_ONE_MINUS_SRC_COLOR:3, BLENDMODE_DST_COLOR:4, BLENDMODE_ONE_MINUS_DST_COLOR:5, BLENDMODE_SRC_ALPHA:6, BLENDMODE_SRC_ALPHA_SATURATE:7, BLENDMODE_ONE_MINUS_SRC_ALPHA:8, BLENDMODE_DST_ALPHA:9, BLENDMODE_ONE_MINUS_DST_ALPHA:10, BLENDEQUATION_ADD:0, BLENDEQUATION_SUBTRACT:1, BLENDEQUATION_REVERSE_SUBTRACT:2, BLENDEQUATION_MIN:3, BLENDEQUATION_MAX:4, BUFFER_STATIC:0,
  BUFFER_DYNAMIC:1, BUFFER_STREAM:2, BUFFER_GPUDYNAMIC:3, CLEARFLAG_COLOR:1, CLEARFLAG_DEPTH:2, CLEARFLAG_STENCIL:4, CUBEFACE_POSX:0, CUBEFACE_NEGX:1, CUBEFACE_POSY:2, CUBEFACE_NEGY:3, CUBEFACE_POSZ:4, CUBEFACE_NEGZ:5, CULLFACE_NONE:0, CULLFACE_BACK:1, CULLFACE_FRONT:2, CULLFACE_FRONTANDBACK:3, TYPE_INT8:0, TYPE_UINT8:1, TYPE_INT16:2, TYPE_UINT16:3, TYPE_INT32:4, TYPE_UINT32:5, TYPE_FLOAT32:6, FILTER_NEAREST:0, FILTER_LINEAR:1, FILTER_NEAREST_MIPMAP_NEAREST:2, FILTER_NEAREST_MIPMAP_LINEAR:3, FILTER_LINEAR_MIPMAP_NEAREST:4,
  FILTER_LINEAR_MIPMAP_LINEAR:5, FUNC_NEVER:0, FUNC_LESS:1, FUNC_EQUAL:2, FUNC_LESSEQUAL:3, FUNC_GREATER:4, FUNC_NOTEQUAL:5, FUNC_GREATEREQUAL:6, FUNC_ALWAYS:7, INDEXFORMAT_UINT8:0, INDEXFORMAT_UINT16:1, INDEXFORMAT_UINT32:2, PIXELFORMAT_A8:0, PIXELFORMAT_L8:1, PIXELFORMAT_L8_A8:2, PIXELFORMAT_R5_G6_B5:3, PIXELFORMAT_R5_G5_B5_A1:4, PIXELFORMAT_R4_G4_B4_A4:5, PIXELFORMAT_R8_G8_B8:6, PIXELFORMAT_R8_G8_B8_A8:7, PIXELFORMAT_DXT1:8, PIXELFORMAT_DXT3:9, PIXELFORMAT_DXT5:10, PIXELFORMAT_RGB16F:11, PIXELFORMAT_RGBA16F:12,
  PIXELFORMAT_RGB32F:13, PIXELFORMAT_RGBA32F:14, PIXELFORMAT_R32F:15, PIXELFORMAT_DEPTH:16, PIXELFORMAT_DEPTHSTENCIL:17, PIXELFORMAT_111110F:18, PIXELFORMAT_SRGB:19, PIXELFORMAT_SRGBA:20, PIXELFORMAT_ETC1:21, PIXELFORMAT_PVRTC_2BPP_RGB_1:22, PIXELFORMAT_PVRTC_2BPP_RGBA_1:23, PIXELFORMAT_PVRTC_4BPP_RGB_1:24, PIXELFORMAT_PVRTC_4BPP_RGBA_1:25, PRIMITIVE_POINTS:0, PRIMITIVE_LINES:1, PRIMITIVE_LINELOOP:2, PRIMITIVE_LINESTRIP:3, PRIMITIVE_TRIANGLES:4, PRIMITIVE_TRISTRIP:5, PRIMITIVE_TRIFAN:6, SEMANTIC_POSITION:"POSITION",
  SEMANTIC_NORMAL:"NORMAL", SEMANTIC_TANGENT:"TANGENT", SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT", SEMANTIC_BLENDINDICES:"BLENDINDICES", SEMANTIC_COLOR:"COLOR", SEMANTIC_TEXCOORD0:"TEXCOORD0", SEMANTIC_TEXCOORD1:"TEXCOORD1", SEMANTIC_TEXCOORD2:"TEXCOORD2", SEMANTIC_TEXCOORD3:"TEXCOORD3", SEMANTIC_TEXCOORD4:"TEXCOORD4", SEMANTIC_TEXCOORD5:"TEXCOORD5", SEMANTIC_TEXCOORD6:"TEXCOORD6", SEMANTIC_TEXCOORD7:"TEXCOORD7", SEMANTIC_ATTR0:"ATTR0", SEMANTIC_ATTR1:"ATTR1", SEMANTIC_ATTR2:"ATTR2", SEMANTIC_ATTR3:"ATTR3",
  SEMANTIC_ATTR4:"ATTR4", SEMANTIC_ATTR5:"ATTR5", SEMANTIC_ATTR6:"ATTR6", SEMANTIC_ATTR7:"ATTR7", SEMANTIC_ATTR8:"ATTR8", SEMANTIC_ATTR9:"ATTR9", SEMANTIC_ATTR10:"ATTR10", SEMANTIC_ATTR11:"ATTR11", SEMANTIC_ATTR12:"ATTR12", SEMANTIC_ATTR13:"ATTR13", SEMANTIC_ATTR14:"ATTR14", SEMANTIC_ATTR15:"ATTR15", SHADERTAG_MATERIAL:1, STENCILOP_KEEP:0, STENCILOP_ZERO:1, STENCILOP_REPLACE:2, STENCILOP_INCREMENT:3, STENCILOP_INCREMENTWRAP:4, STENCILOP_DECREMENT:5, STENCILOP_DECREMENTWRAP:6, STENCILOP_INVERT:7,
  TEXTURELOCK_READ:1, TEXTURELOCK_WRITE:2, TEXHINT_NONE:0, TEXHINT_SHADOWMAP:1, TEXHINT_ASSET:2, TEXHINT_LIGHTMAP:3, UNIFORMTYPE_BOOL:0, UNIFORMTYPE_INT:1, UNIFORMTYPE_FLOAT:2, UNIFORMTYPE_VEC2:3, UNIFORMTYPE_VEC3:4, UNIFORMTYPE_VEC4:5, UNIFORMTYPE_IVEC2:6, UNIFORMTYPE_IVEC3:7, UNIFORMTYPE_IVEC4:8, UNIFORMTYPE_BVEC2:9, UNIFORMTYPE_BVEC3:10, UNIFORMTYPE_BVEC4:11, UNIFORMTYPE_MAT2:12, UNIFORMTYPE_MAT3:13, UNIFORMTYPE_MAT4:14, UNIFORMTYPE_TEXTURE2D:15, UNIFORMTYPE_TEXTURECUBE:16, UNIFORMTYPE_FLOATARRAY:17,
  UNIFORMTYPE_TEXTURE2D_SHADOW:18, UNIFORMTYPE_TEXTURECUBE_SHADOW:19, UNIFORMTYPE_TEXTURE3D:20};
  pc.extend(pc, enums);
  pc.gfx = {};
  pc.extend(pc.gfx, enums);
})();
pc.extend(pc, function() {
  var ScopeId = function(name) {
    this.name = name;
    this.value = null;
    this.versionObject = new pc.VersionedObject;
  };
  ScopeId.prototype = {setValue:function(value) {
    this.value = value;
    this.versionObject.increment();
  }, getValue:function(value) {
    return this.value;
  }};
  return {ScopeId:ScopeId};
}());
pc.extend(pc, function() {
  var ScopeSpace = function(name) {
    this.name = name;
    this.variables = {};
    this.namespaces = {};
  };
  ScopeSpace.prototype = {resolve:function(name) {
    if (this.variables.hasOwnProperty(name) === false) {
      this.variables[name] = new pc.ScopeId(name);
    }
    return this.variables[name];
  }, getSubSpace:function(name) {
    if (this.namespaces.hasOwnProperty(name) === false) {
      this.namespaces[name] = new pc.ScopeSpace(name);
      logDEBUG("Added ScopeSpace: " + name);
    }
    return this.namespaces[name];
  }};
  return {ScopeSpace:ScopeSpace};
}());
pc.extend(pc, function() {
  var Version = function() {
    this.globalId = 0;
    this.revision = 0;
  };
  Version.prototype = {equals:function(other) {
    return this.globalId === other.globalId && this.revision === other.revision;
  }, notequals:function(other) {
    return this.globalId !== other.globalId || this.revision !== other.revision;
  }, copy:function(other) {
    this.globalId = other.globalId;
    this.revision = other.revision;
  }, reset:function() {
    this.globalId = 0;
    this.revision = 0;
  }};
  return {Version:Version};
}());
pc.extend(pc, function() {
  var idCounter = 0;
  var VersionedObject = function() {
    idCounter++;
    this.version = new pc.Version;
    this.version.globalId = idCounter;
  };
  VersionedObject.prototype = {increment:function() {
    this.version.revision++;
  }};
  return {VersionedObject:VersionedObject};
}());
pc.extend(pc, function() {
  function VertexIteratorSetter(buffer, vertexElement) {
    this.index = 0;
    switch(vertexElement.dataType) {
      case pc.TYPE_INT8:
        this.array = new Int8Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_UINT8:
        this.array = new Uint8Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_INT16:
        this.array = new Int16Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_UINT16:
        this.array = new Uint16Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_INT32:
        this.array = new Int32Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_UINT32:
        this.array = new Uint32Array(buffer, vertexElement.offset);
        break;
      case pc.TYPE_FLOAT32:
        this.array = new Float32Array(buffer, vertexElement.offset);
        break;
    }
    switch(vertexElement.numComponents) {
      case 1:
        this.set = VertexIteratorSetter_set1;
        break;
      case 2:
        this.set = VertexIteratorSetter_set2;
        break;
      case 3:
        this.set = VertexIteratorSetter_set3;
        break;
      case 4:
        this.set = VertexIteratorSetter_set4;
        break;
    }
  }
  function VertexIteratorSetter_set1(a) {
    this.array[this.index] = a;
  }
  function VertexIteratorSetter_set2(a, b) {
    this.array[this.index] = a;
    this.array[this.index + 1] = b;
  }
  function VertexIteratorSetter_set3(a, b, c) {
    this.array[this.index] = a;
    this.array[this.index + 1] = b;
    this.array[this.index + 2] = c;
  }
  function VertexIteratorSetter_set4(a, b, c, d) {
    this.array[this.index] = a;
    this.array[this.index + 1] = b;
    this.array[this.index + 2] = c;
    this.array[this.index + 3] = d;
  }
  function VertexIterator(vertexBuffer) {
    this.vertexBuffer = vertexBuffer;
    this.buffer = this.vertexBuffer.lock();
    this.setters = [];
    this.element = {};
    var vertexFormat = this.vertexBuffer.getFormat();
    for (var i = 0;i < vertexFormat.elements.length;i++) {
      var vertexElement = vertexFormat.elements[i];
      this.setters[i] = new VertexIteratorSetter(this.buffer, vertexElement);
      this.element[vertexElement.name] = this.setters[i];
    }
  }
  VertexIterator.prototype = {next:function() {
    var i = 0;
    var setters = this.setters;
    var numSetters = this.setters.length;
    var vertexFormat = this.vertexBuffer.getFormat();
    while (i < numSetters) {
      var setter = setters[i++];
      setter.index += vertexFormat.size / setter.array.constructor.BYTES_PER_ELEMENT;
    }
  }, end:function() {
    this.vertexBuffer.unlock();
  }};
  return {VertexIterator:VertexIterator};
}());
pc.extend(pc, function() {
  var _typeSize = [];
  _typeSize[pc.TYPE_INT8] = 1;
  _typeSize[pc.TYPE_UINT8] = 1;
  _typeSize[pc.TYPE_INT16] = 2;
  _typeSize[pc.TYPE_UINT16] = 2;
  _typeSize[pc.TYPE_INT32] = 4;
  _typeSize[pc.TYPE_UINT32] = 4;
  _typeSize[pc.TYPE_FLOAT32] = 4;
  var VertexFormat = function(graphicsDevice, description) {
    var i, len, element;
    this.elements = [];
    this.hasUv0 = false;
    this.hasUv1 = false;
    this.hasColor = false;
    this.size = 0;
    for (i = 0, len = description.length;i < len;i++) {
      var elementDesc = description[i];
      element = {name:elementDesc.semantic, offset:0, stride:0, stream:-1, scopeId:graphicsDevice.scope.resolve(elementDesc.semantic), dataType:elementDesc.type, numComponents:elementDesc.components, normalize:elementDesc.normalize === undefined ? false : elementDesc.normalize, size:elementDesc.components * _typeSize[elementDesc.type]};
      this.elements.push(element);
      this.size += Math.ceil(element.size / 4) * 4;
      if (elementDesc.semantic === pc.SEMANTIC_TEXCOORD0) {
        this.hasUv0 = true;
      } else {
        if (elementDesc.semantic === pc.SEMANTIC_TEXCOORD1) {
          this.hasUv1 = true;
        } else {
          if (elementDesc.semantic === pc.SEMANTIC_COLOR) {
            this.hasColor = true;
          }
        }
      }
    }
    var offset = 0;
    for (i = 0, len = this.elements.length;i < len;i++) {
      element = this.elements[i];
      element.offset = offset;
      element.stride = this.size;
      offset += element.size;
    }
  };
  return {VertexFormat:VertexFormat};
}());
pc.extend(pc, function() {
  var VertexBuffer = function(graphicsDevice, format, numVertices, usage, initialData) {
    this.usage = usage || pc.BUFFER_STATIC;
    this.format = format;
    this.numVertices = numVertices;
    this.numBytes = format.size * numVertices;
    graphicsDevice._vram.vb += this.numBytes;
    this.device = graphicsDevice;
    var gl = this.device.gl;
    this.bufferId = gl.createBuffer();
    if (initialData && this.setData(initialData)) {
      return;
    } else {
      this.storage = new ArrayBuffer(this.numBytes);
    }
  };
  VertexBuffer.prototype = {destroy:function() {
    if (!this.bufferId) {
      return;
    }
    var device = this.device;
    var gl = device.gl;
    gl.deleteBuffer(this.bufferId);
    device._vram.vb -= this.storage.byteLength;
    this.bufferId = null;
    device.boundBuffer = null;
    device.vertexBuffers.length = 0;
    device.vbOffsets.length = 0;
    device.attributesInvalidated = true;
    for (var loc in device.enabledAttributes) {
      gl.disableVertexAttribArray(loc);
    }
    device.enabledAttributes = {};
  }, getFormat:function() {
    return this.format;
  }, getUsage:function() {
    return this.usage;
  }, getNumVertices:function() {
    return this.numVertices;
  }, lock:function() {
    return this.storage;
  }, unlock:function() {
    var gl = this.device.gl;
    var glUsage;
    switch(this.usage) {
      case pc.BUFFER_STATIC:
        glUsage = gl.STATIC_DRAW;
        break;
      case pc.BUFFER_DYNAMIC:
        glUsage = gl.DYNAMIC_DRAW;
        break;
      case pc.BUFFER_STREAM:
        glUsage = gl.STREAM_DRAW;
        break;
      case pc.BUFFER_GPUDYNAMIC:
        if (this.device.webgl2) {
          glUsage = gl.DYNAMIC_COPY;
        } else {
          glUsage = gl.STATIC_DRAW;
        }
        break;
    }
    gl.bindBuffer(gl.ARRAY_BUFFER, this.bufferId);
    gl.bufferData(gl.ARRAY_BUFFER, this.storage, glUsage);
  }, setData:function(data) {
    if (data.byteLength !== this.numBytes) {
      console.error("VertexBuffer: wrong initial data size: expected " + this.numBytes + ", got " + data.byteLength);
      return false;
    }
    this.storage = data;
    this.unlock();
    return true;
  }};
  return {VertexBuffer:VertexBuffer};
}());
pc.extend(pc, function() {
  var IndexBuffer = function(graphicsDevice, format, numIndices, usage, initialData) {
    this.usage = usage || pc.BUFFER_STATIC;
    this.format = format;
    this.numIndices = numIndices;
    this.device = graphicsDevice;
    var gl = this.device.gl;
    this.bufferId = gl.createBuffer();
    var bytesPerIndex;
    if (format === pc.INDEXFORMAT_UINT8) {
      bytesPerIndex = 1;
      this.glFormat = gl.UNSIGNED_BYTE;
    } else {
      if (format === pc.INDEXFORMAT_UINT16) {
        bytesPerIndex = 2;
        this.glFormat = gl.UNSIGNED_SHORT;
      } else {
        if (format === pc.INDEXFORMAT_UINT32) {
          bytesPerIndex = 4;
          this.glFormat = gl.UNSIGNED_INT;
        }
      }
    }
    this.bytesPerIndex = bytesPerIndex;
    this.numBytes = this.numIndices * bytesPerIndex;
    if (initialData && this.setData(initialData)) {
      return;
    } else {
      this.storage = new ArrayBuffer(this.numBytes);
    }
    graphicsDevice._vram.ib += this.numBytes;
  };
  IndexBuffer.prototype = {destroy:function() {
    if (!this.bufferId) {
      return;
    }
    var gl = this.device.gl;
    gl.deleteBuffer(this.bufferId);
    this.device._vram.ib -= this.storage.byteLength;
    this.bufferId = null;
    if (this.device.indexBuffer === this) {
      this.device.indexBuffer = null;
    }
  }, getFormat:function() {
    return this.format;
  }, getNumIndices:function() {
    return this.numIndices;
  }, lock:function() {
    return this.storage;
  }, unlock:function() {
    var gl = this.device.gl;
    var glUsage;
    switch(this.usage) {
      case pc.BUFFER_STATIC:
        glUsage = gl.STATIC_DRAW;
        break;
      case pc.BUFFER_DYNAMIC:
        glUsage = gl.DYNAMIC_DRAW;
        break;
      case pc.BUFFER_STREAM:
        glUsage = gl.STREAM_DRAW;
        break;
      case pc.BUFFER_GPUDYNAMIC:
        if (this.device.webgl2) {
          glUsage = gl.DYNAMIC_COPY;
        } else {
          glUsage = gl.STATIC_DRAW;
        }
        break;
    }
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.bufferId);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.storage, glUsage);
  }, setData:function(data) {
    if (data.byteLength !== this.numBytes) {
      console.error("IndexBuffer: wrong initial data size: expected " + this.numBytes + ", got " + data.byteLength);
      return false;
    }
    this.storage = data;
    this.unlock();
    return true;
  }};
  return {IndexBuffer:IndexBuffer};
}());
pc.extend(pc, function() {
  var TransformFeedback = function(inputBuffer, usage) {
    usage = usage || pc.BUFFER_GPUDYNAMIC;
    this.device = inputBuffer.device;
    var gl = this.device.gl;
    this._inputBuffer = inputBuffer;
    if (usage === pc.BUFFER_GPUDYNAMIC && inputBuffer.usage !== usage) {
      gl.bindBuffer(gl.ARRAY_BUFFER, inputBuffer.bufferId);
      gl.bufferData(gl.ARRAY_BUFFER, inputBuffer.storage, gl.DYNAMIC_COPY);
    }
    this._outputBuffer = new pc.VertexBuffer(inputBuffer.device, inputBuffer.format, inputBuffer.numVertices, usage, inputBuffer.storage);
  };
  TransformFeedback.createShader = function(device, vsCode, name) {
    return pc.shaderChunks.createShaderFromCode(device, vsCode, null, name, true);
  };
  TransformFeedback.prototype = {destroy:function() {
    this._outputBuffer.destroy();
  }, process:function(shader, swap) {
    if (swap === undefined) {
      swap = true;
    }
    var device = this.device;
    device.setRenderTarget(null);
    device.updateBegin();
    device.setVertexBuffer(this._inputBuffer, 0);
    device.setRaster(false);
    device.setTransformFeedbackBuffer(this._outputBuffer);
    device.setShader(shader);
    device.draw({type:pc.PRIMITIVE_POINTS, base:0, count:this._inputBuffer.numVertices, indexed:false});
    device.setTransformFeedbackBuffer(null);
    device.setRaster(true);
    device.updateEnd();
    if (swap) {
      var tmp = this._inputBuffer.bufferId;
      this._inputBuffer.bufferId = this._outputBuffer.bufferId;
      this._outputBuffer.bufferId = tmp;
    }
  }};
  Object.defineProperty(TransformFeedback.prototype, "inputBuffer", {get:function() {
    return this._inputBuffer;
  }});
  Object.defineProperty(TransformFeedback.prototype, "outputBuffer", {get:function() {
    return this._outputBuffer;
  }});
  return {TransformFeedback:TransformFeedback};
}());
pc.extend(pc, function() {
  var Texture = function(graphicsDevice, options) {
    this.device = graphicsDevice;
    this.name = null;
    this._width = 4;
    this._height = 4;
    this._depth = 1;
    this._pot = true;
    this._format = pc.PIXELFORMAT_R8_G8_B8_A8;
    this.rgbm = false;
    this._cubemap = false;
    this._volume = false;
    this.fixCubemapSeams = false;
    this._flipY = true;
    this._mipmaps = true;
    this._minFilter = pc.FILTER_LINEAR_MIPMAP_LINEAR;
    this._magFilter = pc.FILTER_LINEAR;
    this._anisotropy = 1;
    this._addressU = pc.ADDRESS_REPEAT;
    this._addressV = pc.ADDRESS_REPEAT;
    this._addressW = pc.ADDRESS_REPEAT;
    this._compareOnRead = false;
    this._compareFunc = pc.FUNC_LESS;
    if (options !== undefined) {
      this._width = options.width !== undefined ? options.width : this._width;
      this._height = options.height !== undefined ? options.height : this._height;
      this._pot = pc.math.powerOfTwo(this._width) && pc.math.powerOfTwo(this._height);
      this._format = options.format !== undefined ? options.format : this._format;
      this.rgbm = options.rgbm !== undefined ? options.rgbm : this.rgbm;
      if (options.mipmaps !== undefined) {
        this._mipmaps = options.mipmaps;
      } else {
        this._mipmaps = options.autoMipmap !== undefined ? options.autoMipmap : this._mipmaps;
      }
      this._cubemap = options.cubemap !== undefined ? options.cubemap : this._cubemap;
      this.fixCubemapSeams = options.fixCubemapSeams !== undefined ? options.fixCubemapSeams : this.fixCubemapSeams;
      this._minFilter = options.minFilter !== undefined ? options.minFilter : this._minFilter;
      this._magFilter = options.magFilter !== undefined ? options.magFilter : this._magFilter;
      this._anisotropy = options.anisotropy !== undefined ? options.anisotropy : this._anisotropy;
      this._addressU = options.addressU !== undefined ? options.addressU : this._addressU;
      this._addressV = options.addressV !== undefined ? options.addressV : this._addressV;
      this._compareOnRead = options.compareOnRead !== undefined ? options.compareOnRead : this._compareOnRead;
      this._compareFunc = options._compareFunc !== undefined ? options._compareFunc : this._compareFunc;
      this._flipY = options.flipY !== undefined ? options.flipY : this._flipY;
      if (graphicsDevice.webgl2) {
        this._depth = options.depth !== undefined ? options.depth : this._depth;
        this._volume = options.volume !== undefined ? options.volume : this._volume;
        this._addressW = options.addressW !== undefined ? options.addressW : this._addressW;
      }
    }
    this._compressed = this._format === pc.PIXELFORMAT_DXT1 || this._format === pc.PIXELFORMAT_DXT3 || this._format === pc.PIXELFORMAT_DXT5 || this._format >= pc.PIXELFORMAT_ETC1;
    this._invalid = false;
    this._levels = this._cubemap ? [[null, null, null, null, null, null]] : [null];
    this._levelsUpdated = this._cubemap ? [[true, true, true, true, true, true]] : [true];
    this._lockedLevel = -1;
    this._needsUpload = true;
    this._needsMipmapsUpload = this._mipmaps;
    this._mipmapsUploaded = false;
    this._minFilterDirty = true;
    this._magFilterDirty = true;
    this._addressUDirty = true;
    this._addressVDirty = true;
    this._addressWDirty = this._volume;
    this._anisotropyDirty = true;
    this._compareModeDirty = true;
    this._gpuSize = 0;
  };
  Object.defineProperty(Texture.prototype, "minFilter", {get:function() {
    return this._minFilter;
  }, set:function(v) {
    if (this._minFilter !== v) {
      this._minFilter = v;
      this._minFilterDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "magFilter", {get:function() {
    return this._magFilter;
  }, set:function(v) {
    if (this._magFilter !== v) {
      this._magFilter = v;
      this._magFilterDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "addressU", {get:function() {
    return this._addressU;
  }, set:function(v) {
    if (this._addressU !== v) {
      this._addressU = v;
      this._addressUDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "addressV", {get:function() {
    return this._addressV;
  }, set:function(v) {
    if (this._addressV !== v) {
      this._addressV = v;
      this._addressVDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "addressW", {get:function() {
    return this._addressW;
  }, set:function(addressW) {
    if (!this.device.webgl2) {
      return;
    }
    if (!this._volume) {
      logWARNING("Can't set W addressing mode for a non-3D texture.");
      return;
    }
    if (addressW !== this._addressW) {
      this._addressW = addressW;
      this._addressWDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "compareOnRead", {get:function() {
    return this._compareOnRead;
  }, set:function(v) {
    if (this._compareOnRead !== v) {
      this._compareOnRead = v;
      this._compareModeDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "compareFunc", {get:function() {
    return this._compareFunc;
  }, set:function(v) {
    if (this._compareFunc !== v) {
      this._compareFunc = v;
      this._compareModeDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "autoMipmap", {get:function() {
    return this._mipmaps;
  }, set:function(v) {
    this._mipmaps = v;
  }});
  Object.defineProperty(Texture.prototype, "mipmaps", {get:function() {
    return this._mipmaps;
  }, set:function(v) {
    if (this._mipmaps !== v) {
      this._mipmaps = v;
      this._minFilterDirty = true;
      if (v) {
        this._needsMipmapsUpload = true;
      }
    }
  }});
  Object.defineProperty(Texture.prototype, "anisotropy", {get:function() {
    return this._anisotropy;
  }, set:function(v) {
    if (this._anisotropy !== v) {
      this._anisotropy = v;
      this._anisotropyDirty = true;
    }
  }});
  Object.defineProperty(Texture.prototype, "width", {get:function() {
    return this._width;
  }});
  Object.defineProperty(Texture.prototype, "height", {get:function() {
    return this._height;
  }});
  Object.defineProperty(Texture.prototype, "depth", {get:function() {
    return this._depth;
  }});
  Object.defineProperty(Texture.prototype, "format", {get:function() {
    return this._format;
  }});
  Object.defineProperty(Texture.prototype, "cubemap", {get:function() {
    return this._cubemap;
  }});
  Object.defineProperty(Texture.prototype, "volume", {get:function() {
    return this._volume;
  }});
  Object.defineProperty(Texture.prototype, "flipY", {get:function() {
    return this._flipY;
  }, set:function(flipY) {
    if (this._flipY !== flipY) {
      this._flipY = flipY;
      this._needsUpload = true;
    }
  }});
  pc.extend(Texture.prototype, {bind:function() {
  }, destroy:function() {
    if (this._glTextureId) {
      var gl = this.device.gl;
      gl.deleteTexture(this._glTextureId);
      this.device._vram.tex -= this._gpuSize;
      this._glTextureId = null;
    }
  }, lock:function(options) {
    options = options || {level:0, face:0, mode:pc.TEXTURELOCK_WRITE};
    if (options.level === undefined) {
      options.level = 0;
    }
    if (options.face === undefined) {
      options.face = 0;
    }
    if (options.mode === undefined) {
      options.mode = pc.TEXTURELOCK_WRITE;
    }
    this._lockedLevel = options.level;
    if (this._levels[options.level] === null) {
      switch(this._format) {
        case pc.PIXELFORMAT_A8:
        case pc.PIXELFORMAT_L8:
          this._levels[options.level] = new Uint8Array(this._width * this._height * this._depth);
          break;
        case pc.PIXELFORMAT_L8_A8:
          this._levels[options.level] = new Uint8Array(this._width * this._height * this._depth * 2);
          break;
        case pc.PIXELFORMAT_R5_G6_B5:
        case pc.PIXELFORMAT_R5_G5_B5_A1:
        case pc.PIXELFORMAT_R4_G4_B4_A4:
          this._levels[options.level] = new Uint16Array(this._width * this._height * this._depth);
          break;
        case pc.PIXELFORMAT_R8_G8_B8:
          this._levels[options.level] = new Uint8Array(this._width * this._height * this._depth * 3);
          break;
        case pc.PIXELFORMAT_R8_G8_B8_A8:
          this._levels[options.level] = new Uint8Array(this._width * this._height * this._depth * 4);
          break;
        case pc.PIXELFORMAT_DXT1:
          this._levels[options.level] = new Uint8Array(Math.floor((this._width + 3) / 4) * Math.floor((this._height + 3) / 4) * 8 * this._depth);
          break;
        case pc.PIXELFORMAT_DXT3:
        case pc.PIXELFORMAT_DXT5:
          this._levels[options.level] = new Uint8Array(Math.floor((this._width + 3) / 4) * Math.floor((this._height + 3) / 4) * 16 * this._depth);
          break;
        case pc.PIXELFORMAT_RGB16F:
          this._levels[options.level] = new Uint16Array(this._width * this._height * this._depth * 3);
          break;
        case pc.PIXELFORMAT_RGB32F:
          this._levels[options.level] = new Float32Array(this._width * this._height * this._depth * 3);
          break;
        case pc.PIXELFORMAT_RGBA16F:
          this._levels[options.level] = new Uint16Array(this._width * this._height * this._depth * 4);
          break;
        case pc.PIXELFORMAT_RGBA32F:
          this._levels[options.level] = new Float32Array(this._width * this._height * this._depth * 4);
          break;
      }
    }
    return this._levels[options.level];
  }, recover:function() {
  }, setSource:function(source) {
    var i;
    var invalid = false;
    var width, height;
    if (this._cubemap) {
      if (source[0]) {
        width = source[0].width || 0;
        height = source[0].height || 0;
        for (i = 0;i < 6;i++) {
          if (!source[i] || source[i].width !== width || source[i].height !== height || !(source[i] instanceof HTMLImageElement) && !(source[i] instanceof HTMLCanvasElement) && !(source[i] instanceof HTMLVideoElement)) {
            invalid = true;
            break;
          }
        }
      } else {
        invalid = true;
      }
      if (!invalid) {
        for (i = 0;i < 6;i++) {
          if (this._levels[0][i] !== source[i]) {
            this._levelsUpdated[0][i] = true;
          }
        }
      }
    } else {
      if (!(source instanceof HTMLImageElement) && !(source instanceof HTMLCanvasElement) && !(source instanceof HTMLVideoElement)) {
        invalid = true;
      }
      if (!invalid) {
        if (source !== this._levels[0]) {
          this._levelsUpdated[0] = true;
        }
        width = source.width;
        height = source.height;
      }
    }
    if (invalid) {
      this._width = 4;
      this._height = 4;
      this._pot = true;
      if (this._cubemap) {
        for (i = 0;i < 6;i++) {
          this._levels[0][i] = null;
          this._levelsUpdated[0][i] = true;
        }
      } else {
        this._levels[0] = null;
        this._levelsUpdated[0] = true;
      }
    } else {
      this._width = width;
      this._height = height;
      this._pot = pc.math.powerOfTwo(this._width) && pc.math.powerOfTwo(this._height);
      this._levels[0] = source;
    }
    if (this._invalid !== invalid || !invalid) {
      this._invalid = invalid;
      this.upload();
    }
  }, getSource:function() {
    return this._levels[0];
  }, unlock:function() {
    logASSERT(this._lockedLevel !== -1, "Attempting to unlock a texture that is not locked");
    this.upload();
    this._lockedLevel = -1;
  }, upload:function() {
    this._needsUpload = true;
    this._needsMipmapsUpload = this._mipmaps;
  }, getDds:function() {
    if (this.format !== pc.PIXELFORMAT_R8_G8_B8_A8) {
      console.error("This format is not implemented yet");
    }
    var fsize = 128;
    var i = 0;
    var j;
    var face;
    while (this._levels[i]) {
      var mipSize;
      if (!this.cubemap) {
        mipSize = this._levels[i].length;
        if (!mipSize) {
          console.error("No byte array for mip " + i);
          return;
        }
        fsize += mipSize;
      } else {
        for (face = 0;face < 6;face++) {
          if (!this._levels[i][face]) {
            console.error("No level data for mip " + i + ", face " + face);
            return;
          }
          mipSize = this._levels[i][face].length;
          if (!mipSize) {
            console.error("No byte array for mip " + i + ", face " + face);
            return;
          }
          fsize += mipSize;
        }
      }
      fsize += this._levels[i].length;
      i++;
    }
    var buff = new ArrayBuffer(fsize);
    var header = new Uint32Array(buff, 0, 128 / 4);
    var DDS_MAGIC = 542327876;
    var DDS_HEADER_SIZE = 124;
    var DDS_FLAGS_REQUIRED = 1 | 2 | 4 | 4096 | 524288;
    var DDS_FLAGS_MIPMAP = 131072;
    var DDS_PIXELFORMAT_SIZE = 32;
    var DDS_PIXELFLAGS_RGBA8 = 1 | 64;
    var DDS_CAPS_REQUIRED = 4096;
    var DDS_CAPS_MIPMAP = 4194304;
    var DDS_CAPS_COMPLEX = 8;
    var DDS_CAPS2_CUBEMAP = 512 | 1024 | 2048 | 4096 | 8192 | 16384 | 32768;
    var flags = DDS_FLAGS_REQUIRED;
    if (this._levels.length > 1) {
      flags |= DDS_FLAGS_MIPMAP;
    }
    var caps = DDS_CAPS_REQUIRED;
    if (this._levels.length > 1) {
      caps |= DDS_CAPS_MIPMAP;
    }
    if (this._levels.length > 1 || this.cubemap) {
      caps |= DDS_CAPS_COMPLEX;
    }
    var caps2 = this.cubemap ? DDS_CAPS2_CUBEMAP : 0;
    header[0] = DDS_MAGIC;
    header[1] = DDS_HEADER_SIZE;
    header[2] = flags;
    header[3] = this.height;
    header[4] = this.width;
    header[5] = this.width * this.height * 4;
    header[6] = 0;
    header[7] = this._levels.length;
    for (i = 0;i < 11;i++) {
      header[8 + i] = 0;
    }
    header[19] = DDS_PIXELFORMAT_SIZE;
    header[20] = DDS_PIXELFLAGS_RGBA8;
    header[21] = 0;
    header[22] = 32;
    header[23] = 16711680;
    header[24] = 65280;
    header[25] = 255;
    header[26] = 4278190080;
    header[27] = caps;
    header[28] = caps2;
    header[29] = 0;
    header[30] = 0;
    header[31] = 0;
    var offset = 128;
    var level, mip;
    if (!this.cubemap) {
      for (i = 0;i < this._levels.length;i++) {
        level = this._levels[i];
        mip = new Uint8Array(buff, offset, level.length);
        for (j = 0;j < level.length;j++) {
          mip[j] = level[j];
        }
        offset += level.length;
      }
    } else {
      for (face = 0;face < 6;face++) {
        for (i = 0;i < this._levels.length;i++) {
          level = this._levels[i][face];
          mip = new Uint8Array(buff, offset, level.length);
          for (j = 0;j < level.length;j++) {
            mip[j] = level[j];
          }
          offset += level.length;
        }
      }
    }
    return buff;
  }});
  return {Texture:Texture};
}());
pc.extend(pc, function() {
  var defaultOptions = {depth:true, face:0};
  var RenderTarget = function(options, _arg2, _arg3) {
    if (options instanceof pc.GraphicsDevice) {
      this._colorBuffer = _arg2;
      options = _arg3;
    } else {
      this._colorBuffer = options.colorBuffer;
    }
    this._glFrameBuffer = null;
    this._glDepthBuffer = null;
    options = options !== undefined ? options : defaultOptions;
    this._depthBuffer = options.depthBuffer;
    this._face = options.face !== undefined ? options.face : 0;
    if (this._depthBuffer) {
      var format = this._depthBuffer._format;
      if (format === pc.PIXELFORMAT_DEPTH) {
        this._depth = true;
        this._stencil = false;
      } else {
        if (format === pc.PIXELFORMAT_DEPTHSTENCIL) {
          this._depth = true;
          this._stencil = true;
        } else {
          this._depth = false;
          this._stencil = false;
        }
      }
    } else {
      this._depth = options.depth !== undefined ? options.depth : true;
      this._stencil = options.stencil !== undefined ? options.stencil : false;
    }
    this._samples = options.samples !== undefined ? options.samples : 1;
    this.autoResolve = options.autoResolve !== undefined ? options.autoResolve : true;
    this._glResolveFrameBuffer = null;
    this._glMsaaColorBuffer = null;
    this._glMsaaDepthBuffer = null;
  };
  RenderTarget.prototype = {destroy:function() {
    if (!this._device) {
      return;
    }
    var gl = this._device.gl;
    if (this._glFrameBuffer) {
      gl.deleteFramebuffer(this._glFrameBuffer);
      this._glFrameBuffer = null;
    }
    if (this._glDepthBuffer) {
      gl.deleteRenderbuffer(this._glDepthBuffer);
      this._glDepthBuffer = null;
    }
    if (this._glResolveFrameBuffer) {
      gl.deleteFramebuffer(this._glResolveFrameBuffer);
      this._glResolveFrameBuffer = null;
    }
    if (this._glMsaaColorBuffer) {
      gl.deleteRenderbuffer(this._glMsaaColorBuffer);
      this._glMsaaColorBuffer = null;
    }
    if (this._glMsaaDepthBuffer) {
      gl.deleteRenderbuffer(this._glMsaaDepthBuffer);
      this._glMsaaDepthBuffer = null;
    }
  }, resolve:function(color, depth) {
    if (!this._device) {
      return;
    }
    if (!this._device.webgl2) {
      return;
    }
    var gl = this._device.gl;
    if (color === undefined) {
      color = true;
    }
    if (depth === undefined && this._depthBuffer) {
      depth = true;
    }
    gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this._glFrameBuffer);
    gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, this._glResolveFrameBuffer);
    gl.blitFramebuffer(0, 0, this.width, this.height, 0, 0, this.width, this.height, (color ? gl.COLOR_BUFFER_BIT : 0) | (depth ? gl.DEPTH_BUFFER_BIT : 0), gl.NEAREST);
    gl.bindFramebuffer(gl.FRAMEBUFFER, this._glFrameBuffer);
  }, copy:function(source, color, depth) {
    if (!this._device) {
      if (source._device) {
        this._device = source._device;
      } else {
        return false;
      }
    }
    return this._device.copyRenderTarget(source, this, color, depth);
  }};
  Object.defineProperty(RenderTarget.prototype, "colorBuffer", {get:function() {
    return this._colorBuffer;
  }});
  Object.defineProperty(RenderTarget.prototype, "depthBuffer", {get:function() {
    return this._depthBuffer;
  }});
  Object.defineProperty(RenderTarget.prototype, "face", {get:function() {
    return this._face;
  }});
  Object.defineProperty(RenderTarget.prototype, "width", {get:function() {
    if (this._colorBuffer) {
      return this._colorBuffer.width;
    } else {
      return this._depthBuffer.width;
    }
  }});
  Object.defineProperty(RenderTarget.prototype, "height", {get:function() {
    if (this._colorBuffer) {
      return this._colorBuffer.height;
    } else {
      return this._depthBuffer.height;
    }
  }});
  return {RenderTarget:RenderTarget};
}());
pc.extend(pc, function() {
  var ShaderInput = function(graphicsDevice, name, type, locationId) {
    this.locationId = locationId;
    this.scopeId = graphicsDevice.scope.resolve(name);
    this.version = new pc.Version;
    if (type === pc.UNIFORMTYPE_FLOAT) {
      if (name.substr(name.length - 3) === "[0]") {
        type = pc.UNIFORMTYPE_FLOATARRAY;
      }
    }
    this.dataType = type;
    this.value = [null, null, null, null];
    this.array = [];
  };
  return {ShaderInput:ShaderInput};
}());
pc.extend(pc, function() {
  function addLineNumbers(src) {
    var chunks = src.split("\n");
    for (var i = 0, len = chunks.length;i < len;i++) {
      chunks[i] = i + 1 + ":\t" + chunks[i];
    }
    return chunks.join("\n");
  }
  function createShader(gl, type, src) {
    var shader = gl.createShader(type);
    gl.shaderSource(shader, src);
    gl.compileShader(shader);
    return shader;
  }
  function createProgram(gl, vertexShader, fragmentShader) {
    var program = gl.createProgram();
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    return program;
  }
  var Shader = function(graphicsDevice, definition) {
    this._refCount = 0;
    this.device = graphicsDevice;
    this.definition = definition;
    this.ready = false;
    var gl = this.device.gl;
    this.vshader = createShader(gl, gl.VERTEX_SHADER, definition.vshader);
    this.fshader = createShader(gl, gl.FRAGMENT_SHADER, definition.fshader);
    this.program = createProgram(gl, this.vshader, this.fshader);
    graphicsDevice._shaderStats.vsCompiled++;
    graphicsDevice._shaderStats.fsCompiled++;
    graphicsDevice._shaderStats.linked++;
    if (definition.tag === pc.SHADERTAG_MATERIAL) {
      graphicsDevice._shaderStats.materialShaders++;
    }
  };
  Shader.prototype = {link:function() {
    var gl = this.device.gl;
    var retValue = true;
    if (this.device.webgl2 && this.definition.useTransformFeedback) {
      var attrs = this.definition.attributes;
      var outNames = [];
      for (var attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          outNames.push("out_" + attr);
        }
      }
      gl.transformFeedbackVaryings(this.program, outNames, gl.INTERLEAVED_ATTRIBS);
    }
    gl.linkProgram(this.program);
    if (!gl.getShaderParameter(this.vshader, gl.COMPILE_STATUS)) {
      logERROR("Failed to compile vertex shader:\n\n" + addLineNumbers(this.definition.vshader) + "\n\n" + gl.getShaderInfoLog(this.vshader));
      retValue = false;
    }
    if (!gl.getShaderParameter(this.fshader, gl.COMPILE_STATUS)) {
      logERROR("Failed to compile fragment shader:\n\n" + addLineNumbers(this.definition.fshader) + "\n\n" + gl.getShaderInfoLog(this.fshader));
      retValue = false;
    }
    if (!gl.getProgramParameter(this.program, gl.LINK_STATUS)) {
      logERROR("Failed to link shader program. Error: " + gl.getProgramInfoLog(this.program));
      retValue = false;
    }
    gl.deleteShader(this.vshader);
    gl.deleteShader(this.fshader);
    this.attributes = [];
    this.uniforms = [];
    this.samplers = [];
    var i = 0;
    var info, location;
    var _typeToPc = {};
    _typeToPc[gl.BOOL] = pc.UNIFORMTYPE_BOOL;
    _typeToPc[gl.INT] = pc.UNIFORMTYPE_INT;
    _typeToPc[gl.FLOAT] = pc.UNIFORMTYPE_FLOAT;
    _typeToPc[gl.FLOAT_VEC2] = pc.UNIFORMTYPE_VEC2;
    _typeToPc[gl.FLOAT_VEC3] = pc.UNIFORMTYPE_VEC3;
    _typeToPc[gl.FLOAT_VEC4] = pc.UNIFORMTYPE_VEC4;
    _typeToPc[gl.INT_VEC2] = pc.UNIFORMTYPE_IVEC2;
    _typeToPc[gl.INT_VEC3] = pc.UNIFORMTYPE_IVEC3;
    _typeToPc[gl.INT_VEC4] = pc.UNIFORMTYPE_IVEC4;
    _typeToPc[gl.BOOL_VEC2] = pc.UNIFORMTYPE_BVEC2;
    _typeToPc[gl.BOOL_VEC3] = pc.UNIFORMTYPE_BVEC3;
    _typeToPc[gl.BOOL_VEC4] = pc.UNIFORMTYPE_BVEC4;
    _typeToPc[gl.FLOAT_MAT2] = pc.UNIFORMTYPE_MAT2;
    _typeToPc[gl.FLOAT_MAT3] = pc.UNIFORMTYPE_MAT3;
    _typeToPc[gl.FLOAT_MAT4] = pc.UNIFORMTYPE_MAT4;
    _typeToPc[gl.SAMPLER_2D] = pc.UNIFORMTYPE_TEXTURE2D;
    _typeToPc[gl.SAMPLER_CUBE] = pc.UNIFORMTYPE_TEXTURECUBE;
    if (this.device.webgl2) {
      _typeToPc[gl.SAMPLER_2D_SHADOW] = pc.UNIFORMTYPE_TEXTURE2D_SHADOW;
      _typeToPc[gl.SAMPLER_CUBE_SHADOW] = pc.UNIFORMTYPE_TEXTURECUBE_SHADOW;
      _typeToPc[gl.SAMPLER_3D] = pc.UNIFORMTYPE_TEXTURE3D;
    }
    var numAttributes = gl.getProgramParameter(this.program, gl.ACTIVE_ATTRIBUTES);
    while (i < numAttributes) {
      info = gl.getActiveAttrib(this.program, i++);
      location = gl.getAttribLocation(this.program, info.name);
      if (this.definition.attributes[info.name] === undefined) {
        console.error('Vertex shader attribute "' + info.name + '" is not mapped to a semantic in shader definition.');
      }
      this.attributes.push(new pc.ShaderInput(this.device, this.definition.attributes[info.name], _typeToPc[info.type], location));
    }
    i = 0;
    var numUniforms = gl.getProgramParameter(this.program, gl.ACTIVE_UNIFORMS);
    while (i < numUniforms) {
      info = gl.getActiveUniform(this.program, i++);
      location = gl.getUniformLocation(this.program, info.name);
      if (info.type === gl.SAMPLER_2D || info.type === gl.SAMPLER_CUBE || this.device.webgl2 && (info.type === gl.SAMPLER_2D_SHADOW || info.type === gl.SAMPLER_CUBE_SHADOW || info.type === gl.SAMPLER_3D)) {
        this.samplers.push(new pc.ShaderInput(this.device, info.name, _typeToPc[info.type], location));
      } else {
        this.uniforms.push(new pc.ShaderInput(this.device, info.name, _typeToPc[info.type], location));
      }
    }
    this.ready = true;
    return retValue;
  }, destroy:function() {
    if (this.program) {
      var gl = this.device.gl;
      gl.deleteProgram(this.program);
      this.program = null;
      this.device.removeShaderFromCache(this);
    }
  }};
  return {Shader:Shader};
}());
pc.extend(pc, function() {
  var ProgramLibrary = function(device) {
    this._device = device;
    this._cache = {};
    this._generators = {};
    this._isClearingCache = false;
  };
  ProgramLibrary.prototype.register = function(name, generator) {
    if (!this.isRegistered(name)) {
      this._generators[name] = generator;
    }
  };
  ProgramLibrary.prototype.unregister = function(name) {
    if (this.isRegistered(name)) {
      delete this._generators[name];
    }
  };
  ProgramLibrary.prototype.isRegistered = function(name) {
    var generator = this._generators[name];
    return generator !== undefined;
  };
  ProgramLibrary.prototype.getProgram = function(name, options) {
    var generator = this._generators[name];
    if (generator === undefined) {
      logERROR("No program library functions registered for: " + name);
      return null;
    }
    var gd = this._device;
    var key = generator.generateKey(gd, options);
    var shader = this._cache[key];
    if (!shader) {
      var shaderDefinition = generator.createShaderDefinition(gd, options);
      shader = this._cache[key] = new pc.Shader(gd, shaderDefinition);
    }
    return shader;
  };
  ProgramLibrary.prototype.clearCache = function() {
    var cache = this._cache;
    this._isClearingCache = true;
    for (var key in cache) {
      if (cache.hasOwnProperty(key)) {
        cache[key].destroy();
      }
    }
    this._cache = {};
    this._isClearingCache = false;
  };
  ProgramLibrary.prototype.removeFromCache = function(shader) {
    if (this._isClearingCache) {
      return;
    }
    var cache = this._cache;
    for (var key in cache) {
      if (cache.hasOwnProperty(key)) {
        if (cache[key] === shader) {
          delete cache[key];
          break;
        }
      }
    }
  };
  return {ProgramLibrary:ProgramLibrary};
}());
pc.extend(pc, function() {
  var EVENT_RESIZE = "resizecanvas";
  var uniformValue;
  var scopeX, scopeY, scopeZ, scopeW;
  function UnsupportedBrowserError(message) {
    this.name = "UnsupportedBrowserError";
    this.message = message || "";
  }
  UnsupportedBrowserError.prototype = Error.prototype;
  function ContextCreationError(message) {
    this.name = "ContextCreationError";
    this.message = message || "";
  }
  ContextCreationError.prototype = Error.prototype;
  var _contextLostHandler = function() {
    logWARNING("Context lost.");
  };
  var _contextRestoredHandler = function() {
    logINFO("Context restored.");
  };
  var _downsampleImage = function(image, size) {
    var srcW = image.width;
    var srcH = image.height;
    if (srcW > size || srcH > size) {
      var scale = size / Math.max(srcW, srcH);
      var dstW = Math.floor(srcW * scale);
      var dstH = Math.floor(srcH * scale);
      console.warn("Image dimensions larger than max supported texture size of " + size + ". " + "Resizing from " + srcW + ", " + srcH + " to " + dstW + ", " + dstH + ".");
      var canvas = document.createElement("canvas");
      canvas.width = dstW;
      canvas.height = dstH;
      var context = canvas.getContext("2d");
      context.drawImage(image, 0, 0, srcW, srcH, 0, 0, dstW, dstH);
      return canvas;
    }
    return image;
  };
  function _isIE() {
    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE ");
    var trident = navigator.userAgent.match(/Trident.*rv:11\./);
    return msie > 0 || !!trident;
  }
  var _pixelFormat2Size = null;
  function gpuTexSize(gl, tex) {
    if (!_pixelFormat2Size) {
      _pixelFormat2Size = {};
      _pixelFormat2Size[pc.PIXELFORMAT_A8] = 1;
      _pixelFormat2Size[pc.PIXELFORMAT_L8] = 1;
      _pixelFormat2Size[pc.PIXELFORMAT_L8_A8] = 1;
      _pixelFormat2Size[pc.PIXELFORMAT_R5_G6_B5] = 2;
      _pixelFormat2Size[pc.PIXELFORMAT_R5_G5_B5_A1] = 2;
      _pixelFormat2Size[pc.PIXELFORMAT_R4_G4_B4_A4] = 2;
      _pixelFormat2Size[pc.PIXELFORMAT_R8_G8_B8] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_R8_G8_B8_A8] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_RGB16F] = 8;
      _pixelFormat2Size[pc.PIXELFORMAT_RGBA16F] = 8;
      _pixelFormat2Size[pc.PIXELFORMAT_RGB32F] = 16;
      _pixelFormat2Size[pc.PIXELFORMAT_RGBA32F] = 16;
      _pixelFormat2Size[pc.PIXELFORMAT_R32F] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_DEPTH] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_DEPTHSTENCIL] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_111110F] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_SRGB] = 4;
      _pixelFormat2Size[pc.PIXELFORMAT_SRGBA] = 4;
    }
    var mips = 1;
    if (tex._pot && (tex._mipmaps || tex._minFilter === gl.NEAREST_MIPMAP_NEAREST || tex._minFilter === gl.NEAREST_MIPMAP_LINEAR || tex._minFilter === gl.LINEAR_MIPMAP_NEAREST || tex._minFilter === gl.LINEAR_MIPMAP_LINEAR) && !(tex._compressed && tex._levels.length === 1)) {
      mips = Math.round(Math.log2(Math.max(tex._width, tex._height)) + 1);
    }
    var mipWidth = tex._width;
    var mipHeight = tex._height;
    var mipDepth = tex._depth;
    var size = 0;
    for (var i = 0;i < mips;i++) {
      if (!tex._compressed) {
        size += mipWidth * mipHeight * mipDepth * _pixelFormat2Size[tex._format];
      } else {
        if (tex._format === pc.PIXELFORMAT_ETC1) {
          size += Math.floor((mipWidth + 3) / 4) * Math.floor((mipHeight + 3) / 4) * 8 * mipDepth;
        } else {
          if (tex._format === pc.PIXELFORMAT_PVRTC_2BPP_RGB_1 || tex._format === pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1) {
            size += Math.max(mipWidth, 16) * Math.max(mipHeight, 8) / 4 * mipDepth;
          } else {
            if (tex._format === pc.PIXELFORMAT_PVRTC_4BPP_RGB_1 || tex._format === pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1) {
              size += Math.max(mipWidth, 8) * Math.max(mipHeight, 8) / 2 * mipDepth;
            } else {
              var DXT_BLOCK_WIDTH = 4;
              var DXT_BLOCK_HEIGHT = 4;
              var blockSize = tex._format === pc.PIXELFORMAT_DXT1 ? 8 : 16;
              var numBlocksAcross = Math.floor((mipWidth + DXT_BLOCK_WIDTH - 1) / DXT_BLOCK_WIDTH);
              var numBlocksDown = Math.floor((mipHeight + DXT_BLOCK_HEIGHT - 1) / DXT_BLOCK_HEIGHT);
              var numBlocks = numBlocksAcross * numBlocksDown;
              size += numBlocks * blockSize * mipDepth;
            }
          }
        }
      }
      mipWidth = Math.max(mipWidth * 0.5, 1);
      mipHeight = Math.max(mipHeight * 0.5, 1);
      mipDepth = Math.max(mipDepth * 0.5, 1);
    }
    if (tex._cubemap) {
      size *= 6;
    }
    return size;
  }
  function testRenderable(gl, ext, pixelFormat) {
    var __texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, __texture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    var __width = 2;
    var __height = 2;
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, __width, __height, 0, gl.RGBA, pixelFormat, null);
    var __fbo = gl.createFramebuffer();
    gl.bindFramebuffer(gl.FRAMEBUFFER, __fbo);
    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, __texture, 0);
    gl.bindTexture(gl.TEXTURE_2D, null);
    if (gl.checkFramebufferStatus(gl.FRAMEBUFFER) != gl.FRAMEBUFFER_COMPLETE) {
      gl.deleteTexture(__texture);
      return false;
    }
    gl.deleteTexture(__texture);
    gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    return true;
  }
  var GraphicsDevice = function(canvas, options) {
    this.gl = undefined;
    this.canvas = canvas;
    this.shader = null;
    this.indexBuffer = null;
    this.vertexBuffers = [];
    this.vbOffsets = [];
    this.precision = "highp";
    this._enableAutoInstancing = false;
    this.autoInstancingMaxObjects = 16384;
    this.attributesInvalidated = true;
    this.boundBuffer = null;
    this.instancedAttribs = {};
    this.enabledAttributes = {};
    this.textureUnits = [];
    this.commitFunction = {};
    this._maxPixelRatio = 1;
    this._width = 0;
    this._height = 0;
    this.updateClientRect();
    if (!window.WebGLRenderingContext) {
      throw new pc.UnsupportedBrowserError;
    }
    if (canvas) {
      var preferWebGl2 = options && options.preferWebGl2 !== undefined ? options.preferWebGl2 : true;
      var names = preferWebGl2 ? ["webgl2", "experimental-webgl2", "webgl", "experimental-webgl"] : ["webgl", "experimental-webgl"];
      var context = null;
      options = options || {};
      options.stencil = true;
      for (var i = 0;i < names.length;i++) {
        try {
          context = canvas.getContext(names[i], options);
        } catch (e) {
        }
        if (context) {
          this.webgl2 = preferWebGl2 && i < 2;
          break;
        }
      }
      this.gl = context;
    }
    if (!this.gl) {
      throw new pc.ContextCreationError;
    }
    var gl = this.gl;
    (function() {
      var i;
      canvas.addEventListener("webglcontextlost", _contextLostHandler, false);
      canvas.addEventListener("webglcontextrestored", _contextRestoredHandler, false);
      this.canvas = canvas;
      this.shader = null;
      this.indexBuffer = null;
      this.vertexBuffers = [];
      this.vbOffsets = [];
      this.precision = "highp";
      this.maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
      this.maxCubeMapSize = gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE);
      this.maxRenderBufferSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);
      if (gl.getShaderPrecisionFormat) {
        var vertexShaderPrecisionHighpFloat = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.HIGH_FLOAT);
        var vertexShaderPrecisionMediumpFloat = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.MEDIUM_FLOAT);
        var vertexShaderPrecisionLowpFloat = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.LOW_FLOAT);
        var fragmentShaderPrecisionHighpFloat = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_FLOAT);
        var fragmentShaderPrecisionMediumpFloat = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.MEDIUM_FLOAT);
        var fragmentShaderPrecisionLowpFloat = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.LOW_FLOAT);
        var vertexShaderPrecisionHighpInt = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.HIGH_INT);
        var vertexShaderPrecisionMediumpInt = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.MEDIUM_INT);
        var vertexShaderPrecisionLowpInt = gl.getShaderPrecisionFormat(gl.VERTEX_SHADER, gl.LOW_INT);
        var fragmentShaderPrecisionHighpInt = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_INT);
        var fragmentShaderPrecisionMediumpInt = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.MEDIUM_INT);
        var fragmentShaderPrecisionLowpInt = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.LOW_INT);
        var highpAvailable = vertexShaderPrecisionHighpFloat.precision > 0 && fragmentShaderPrecisionHighpFloat.precision > 0;
        var mediumpAvailable = vertexShaderPrecisionMediumpFloat.precision > 0 && fragmentShaderPrecisionMediumpFloat.precision > 0;
        if (!highpAvailable) {
          if (mediumpAvailable) {
            this.precision = "mediump";
            console.warn("WARNING: highp not supported, using mediump");
          } else {
            this.precision = "lowp";
            console.warn("WARNING: highp and mediump not supported, using lowp");
          }
        }
      }
      this.maxPrecision = this.precision;
      this.defaultClearOptions = {color:[0, 0, 0, 1], depth:1, stencil:0, flags:pc.CLEARFLAG_COLOR | pc.CLEARFLAG_DEPTH};
      this.glAddress = [gl.REPEAT, gl.CLAMP_TO_EDGE, gl.MIRRORED_REPEAT];
      this.glBlendEquation = [gl.FUNC_ADD, gl.FUNC_SUBTRACT, gl.FUNC_REVERSE_SUBTRACT];
      this.glBlendFunction = [gl.ZERO, gl.ONE, gl.SRC_COLOR, gl.ONE_MINUS_SRC_COLOR, gl.DST_COLOR, gl.ONE_MINUS_DST_COLOR, gl.SRC_ALPHA, gl.SRC_ALPHA_SATURATE, gl.ONE_MINUS_SRC_ALPHA, gl.DST_ALPHA, gl.ONE_MINUS_DST_ALPHA];
      this.glComparison = [gl.NEVER, gl.LESS, gl.EQUAL, gl.LEQUAL, gl.GREATER, gl.NOTEQUAL, gl.GEQUAL, gl.ALWAYS];
      this.glStencilOp = [gl.KEEP, gl.ZERO, gl.REPLACE, gl.INCR, gl.INCR_WRAP, gl.DECR, gl.DECR_WRAP, gl.INVERT];
      this.glClearFlag = [0, gl.COLOR_BUFFER_BIT, gl.DEPTH_BUFFER_BIT, gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT, gl.STENCIL_BUFFER_BIT, gl.STENCIL_BUFFER_BIT | gl.COLOR_BUFFER_BIT, gl.STENCIL_BUFFER_BIT | gl.DEPTH_BUFFER_BIT, gl.STENCIL_BUFFER_BIT | gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT];
      this.glCull = [0, gl.BACK, gl.FRONT, gl.FRONT_AND_BACK];
      this.glFilter = [gl.NEAREST, gl.LINEAR, gl.NEAREST_MIPMAP_NEAREST, gl.NEAREST_MIPMAP_LINEAR, gl.LINEAR_MIPMAP_NEAREST, gl.LINEAR_MIPMAP_LINEAR];
      this.glPrimitive = [gl.POINTS, gl.LINES, gl.LINE_LOOP, gl.LINE_STRIP, gl.TRIANGLES, gl.TRIANGLE_STRIP, gl.TRIANGLE_FAN];
      this.glType = [gl.BYTE, gl.UNSIGNED_BYTE, gl.SHORT, gl.UNSIGNED_SHORT, gl.INT, gl.UNSIGNED_INT, gl.FLOAT];
      this.unmaskedRenderer = null;
      this.unmaskedVendor = null;
      this.extRendererInfo = gl.getExtension("WEBGL_debug_renderer_info");
      if (this.extRendererInfo) {
        this.unmaskedRenderer = gl.getParameter(this.extRendererInfo.UNMASKED_RENDERER_WEBGL);
        this.unmaskedVendor = gl.getParameter(this.extRendererInfo.UNMASKED_VENDOR_WEBGL);
      }
      if (this.webgl2) {
        this.extTextureFloat = true;
        this.extTextureHalfFloat = true;
        this.extTextureHalfFloatLinear = true;
        this.extUintElement = true;
        this.extTextureLod = true;
        this.extStandardDerivatives = true;
        gl.hint(gl.FRAGMENT_SHADER_DERIVATIVE_HINT, gl.NICEST);
        this.extInstancing = true;
        this.extDrawBuffers = true;
        this.maxDrawBuffers = gl.getParameter(gl.MAX_DRAW_BUFFERS);
        this.maxColorAttachments = gl.getParameter(gl.MAX_COLOR_ATTACHMENTS);
        this.feedback = gl.createTransformFeedback();
        this.maxVolumeSize = gl.getParameter(gl.MAX_3D_TEXTURE_SIZE);
        this.extBlendMinmax = true;
        this.glBlendEquation.push(gl.MIN);
        this.glBlendEquation.push(gl.MAX);
      } else {
        this.extTextureFloat = gl.getExtension("OES_texture_float");
        this.extTextureHalfFloat = gl.getExtension("OES_texture_half_float");
        this.extTextureHalfFloatLinear = gl.getExtension("OES_texture_half_float_linear");
        this.extUintElement = gl.getExtension("OES_element_index_uint");
        this.extTextureLod = gl.getExtension("EXT_shader_texture_lod");
        this.extStandardDerivatives = gl.getExtension("OES_standard_derivatives");
        if (this.extStandardDerivatives) {
          gl.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES, gl.NICEST);
        }
        this.extInstancing = gl.getExtension("ANGLE_instanced_arrays");
        this.extDrawBuffers = gl.getExtension("EXT_draw_buffers");
        this.maxDrawBuffers = this.extDrawBuffers ? gl.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT) : 1;
        this.maxColorAttachments = this.extDrawBuffers ? gl.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT) : 1;
        this.maxVolumeSize = 1;
        this.extBlendMinmax = gl.getExtension("EXT_blend_minmax");
        if (this.extBlendMinmax) {
          this.glBlendEquation.push(this.extBlendMinmax.MIN_EXT);
          this.glBlendEquation.push(this.extBlendMinmax.MAX_EXT);
        } else {
          this.glBlendEquation.push(gl.FUNC_ADD);
          this.glBlendEquation.push(gl.FUNC_ADD);
        }
      }
      this.extTextureFloatLinear = gl.getExtension("OES_texture_float_linear");
      this.maxVertexTextures = gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);
      this.supportsBoneTextures = this.extTextureFloat && this.maxVertexTextures > 0;
      this.fragmentUniformsCount = gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS);
      this.samplerCount = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);
      this.useTexCubeLod = this.extTextureLod && this.samplerCount < 16;
      this.extTextureFilterAnisotropic = gl.getExtension("EXT_texture_filter_anisotropic");
      if (!this.extTextureFilterAnisotropic) {
        this.extTextureFilterAnisotropic = gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");
      }
      this.extCompressedTextureS3TC = gl.getExtension("WEBGL_compressed_texture_s3tc");
      if (!this.extCompressedTextureS3TC) {
        this.extCompressedTextureS3TC = gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");
      }
      if (this.extCompressedTextureS3TC && _isIE()) {
        this.extCompressedTextureS3TC = false;
      }
      if (this.extCompressedTextureS3TC) {
        var formats = gl.getParameter(gl.COMPRESSED_TEXTURE_FORMATS);
        for (i = 0;i < formats.length;i++) {
          switch(formats[i]) {
            case this.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT:
              break;
            case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT:
              break;
            case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT:
              break;
            case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT:
              break;
            default:
              break;
          }
        }
      }
      this.extCompressedTextureETC1 = gl.getExtension("WEBGL_compressed_texture_etc1");
      this.extCompressedTexturePVRTC = gl.getExtension("WEBGL_compressed_texture_pvrtc") || gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");
      var contextAttribs = gl.getContextAttributes();
      this.supportsMsaa = contextAttribs.antialias;
      this.supportsStencil = contextAttribs.stencil;
      this.renderTarget = null;
      this.scope = new pc.ScopeSpace("Device");
      this.commitFunction = {};
      this.commitFunction[pc.UNIFORMTYPE_BOOL] = function(uniform, value) {
        if (uniform.value !== value) {
          gl.uniform1i(uniform.locationId, value);
          uniform.value = value;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_INT] = this.commitFunction[pc.UNIFORMTYPE_BOOL];
      this.commitFunction[pc.UNIFORMTYPE_FLOAT] = function(uniform, value) {
        if (uniform.value !== value) {
          gl.uniform1f(uniform.locationId, value);
          uniform.value = value;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_VEC2] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY) {
          gl.uniform2fv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_VEC3] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        scopeZ = value[2];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY || uniformValue[2] !== scopeZ) {
          gl.uniform3fv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
          uniformValue[2] = scopeZ;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_VEC4] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        scopeZ = value[2];
        scopeW = value[3];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY || uniformValue[2] !== scopeZ || uniformValue[3] !== scopeW) {
          gl.uniform4fv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
          uniformValue[2] = scopeZ;
          uniformValue[3] = scopeW;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_IVEC2] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY) {
          gl.uniform2iv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_BVEC2] = this.commitFunction[pc.UNIFORMTYPE_IVEC2];
      this.commitFunction[pc.UNIFORMTYPE_IVEC3] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        scopeZ = value[2];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY || uniformValue[2] !== scopeZ) {
          gl.uniform3iv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
          uniformValue[2] = scopeZ;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_BVEC3] = this.commitFunction[pc.UNIFORMTYPE_IVEC3];
      this.commitFunction[pc.UNIFORMTYPE_IVEC4] = function(uniform, value) {
        uniformValue = uniform.value;
        scopeX = value[0];
        scopeY = value[1];
        scopeZ = value[2];
        scopeW = value[3];
        if (uniformValue[0] !== scopeX || uniformValue[1] !== scopeY || uniformValue[2] !== scopeZ || uniformValue[3] !== scopeW) {
          gl.uniform4iv(uniform.locationId, value);
          uniformValue[0] = scopeX;
          uniformValue[1] = scopeY;
          uniformValue[2] = scopeZ;
          uniformValue[3] = scopeW;
        }
      };
      this.commitFunction[pc.UNIFORMTYPE_BVEC4] = this.commitFunction[pc.UNIFORMTYPE_IVEC4];
      this.commitFunction[pc.UNIFORMTYPE_MAT2] = function(uniform, value) {
        gl.uniformMatrix2fv(uniform.locationId, false, value);
      };
      this.commitFunction[pc.UNIFORMTYPE_MAT3] = function(uniform, value) {
        gl.uniformMatrix3fv(uniform.locationId, false, value);
      };
      this.commitFunction[pc.UNIFORMTYPE_MAT4] = function(uniform, value) {
        gl.uniformMatrix4fv(uniform.locationId, false, value);
      };
      this.commitFunction[pc.UNIFORMTYPE_FLOATARRAY] = function(uniform, value) {
        gl.uniform1fv(uniform.locationId, value);
      };
      this.setBlending(false);
      this.setBlendFunction(pc.BLENDMODE_ONE, pc.BLENDMODE_ZERO);
      this.setBlendEquation(pc.BLENDEQUATION_ADD);
      this.setColorWrite(true, true, true, true);
      this.cullMode = pc.CULLFACE_NONE;
      this.setCullMode(pc.CULLFACE_BACK);
      this.setDepthTest(true);
      this.setDepthFunc(pc.FUNC_LESSEQUAL);
      this.setDepthWrite(true);
      this.setStencilTest(false);
      this.setStencilFunc(pc.FUNC_ALWAYS, 0, 255);
      this.setStencilOperation(pc.STENCILOP_KEEP, pc.STENCILOP_KEEP, pc.STENCILOP_KEEP, 255);
      this.setAlphaToCoverage(false);
      this.setTransformFeedbackBuffer(null);
      this.setRaster(true);
      this.setDepthBias(false);
      this.setClearDepth(1);
      this.setClearColor(0, 0, 0, 0);
      this.setClearStencil(0);
      gl.enable(gl.SCISSOR_TEST);
      this.programLib = new pc.ProgramLibrary(this);
      for (var generator in pc.programlib) {
        this.programLib.register(generator, pc.programlib[generator]);
      }
      var numUniforms = gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS);
      numUniforms -= 4 * 4;
      numUniforms -= 8;
      numUniforms -= 1;
      numUniforms -= 4 * 4;
      this.boneLimit = Math.floor(numUniforms / 4);
      this.boneLimit = Math.min(this.boneLimit, 128);
      if (this.unmaskedRenderer === "Mali-450 MP") {
        this.boneLimit = 34;
      } else {
        if (this.unmaskedRenderer === "Apple A8 GPU") {
          this.forceCpuParticles = true;
        }
      }
      pc.events.attach(this);
      this.vx = this.vy = this.vw = this.vh = 0;
      this.sx = this.sy = this.sw = this.sh = 0;
      this.boundBuffer = null;
      this.instancedAttribs = {};
      this.activeFramebuffer = null;
      this.activeTexture = 0;
      this.textureUnits = [];
      this.attributesInvalidated = true;
      this.enabledAttributes = {};
      this._drawCallsPerFrame = 0;
      this._shaderSwitchesPerFrame = 0;
      this._primsPerFrame = [];
      for (i = pc.PRIMITIVE_POINTS;i <= pc.PRIMITIVE_TRIFAN;i++) {
        this._primsPerFrame[i] = 0;
      }
      this._renderTargetCreationTime = 0;
      this._vram = {tex:0, vb:0, ib:0};
      this._shaderStats = {vsCompiled:0, fsCompiled:0, linked:0, materialShaders:0, compileTime:0};
      var bufferId = gl.createBuffer();
      var storage = new ArrayBuffer(16);
      gl.bindBuffer(gl.ARRAY_BUFFER, bufferId);
      gl.bufferData(gl.ARRAY_BUFFER, storage, gl.STATIC_DRAW);
      gl.getError();
      gl.vertexAttribPointer(0, 4, gl.UNSIGNED_BYTE, false, 4, 0);
      this.supportsUnsignedByte = gl.getError() === 0;
      gl.deleteBuffer(bufferId);
      this.constantTexSource = this.scope.resolve("source");
      gl.pixelStorei(gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, gl.NONE);
      if (!pc._benchmarked) {
        if (this.extTextureFloat) {
          if (this.webgl2) {
            this.extTextureFloatRenderable = gl.getExtension("EXT_color_buffer_float");
          } else {
            this.extTextureFloatRenderable = testRenderable(gl, this.extTextureFloat, gl.FLOAT);
          }
        }
        if (this.extTextureHalfFloat) {
          if (this.webgl2) {
            this.extTextureHalfFloatRenderable = this.extTextureFloatRenderable;
          } else {
            this.extTextureHalfFloatRenderable = testRenderable(gl, this.extTextureHalfFloat, this.extTextureHalfFloat.HALF_FLOAT_OES);
          }
        }
        if (this.extTextureFloatRenderable) {
          var device = this;
          var chunks = pc.shaderChunks;
          var test1 = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.precisionTestPS, "ptest1");
          var test2 = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.precisionTest2PS, "ptest2");
          var size = 1;
          var tex = new pc.Texture(device, {format:pc.PIXELFORMAT_RGBA32F, width:size, height:size, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
          var targ = new pc.RenderTarget(device, tex, {depth:false});
          pc.drawQuadWithShader(device, targ, test1);
          var tex2 = new pc.Texture(device, {format:pc.PIXELFORMAT_R8_G8_B8_A8, width:size, height:size, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
          var targ2 = new pc.RenderTarget(device, tex2, {depth:false});
          this.constantTexSource.setValue(tex);
          pc.drawQuadWithShader(device, targ2, test2);
          var pixels = new Uint8Array(size * size * 4);
          gl.bindFramebuffer(gl.FRAMEBUFFER, targ2._glFrameBuffer);
          gl.readPixels(0, 0, size, size, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
          var x = pixels[0] / 255.0;
          var y = pixels[1] / 255.0;
          var z = pixels[2] / 255.0;
          var w = pixels[3] / 255.0;
          var f = x / (256.0 * 256.0 * 256.0) + y / (256.0 * 256.0) + z / 256.0 + w;
          this.extTextureFloatHighPrecision = f === 0.0;
          tex.destroy();
          targ.destroy();
          tex2.destroy();
          targ2.destroy();
          pc.destroyPostEffectQuad();
          gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        }
        pc.extTextureFloatRenderable = this.extTextureFloatRenderable;
        pc.extTextureHalfFloatRenderable = this.extTextureHalfFloatRenderable;
        pc.extTextureFloatHighPrecision = this.extTextureFloatHighPrecision;
        pc._benchmarked = true;
      } else {
        this.extTextureFloatRenderable = pc.extTextureFloatRenderable;
        this.extTextureHalfFloatRenderable = pc.extTextureHalfFloatRenderable;
        this.extTextureFloatHighPrecision = pc.extTextureFloatHighPrecision;
      }
    }).call(this);
  };
  GraphicsDevice.prototype = {updateClientRect:function() {
    this.clientRect = this.canvas.getBoundingClientRect();
  }, setViewport:function(x, y, w, h) {
    if (this.vx !== x || this.vy !== y || this.vw !== w || this.vh !== h) {
      this.gl.viewport(x, y, w, h);
      this.vx = x;
      this.vy = y;
      this.vw = w;
      this.vh = h;
    }
  }, setScissor:function(x, y, w, h) {
    if (this.sx !== x || this.sy !== y || this.sw !== w || this.sh !== h) {
      this.gl.scissor(x, y, w, h);
      this.sx = x;
      this.sy = y;
      this.sw = w;
      this.sh = h;
    }
  }, getProgramLibrary:function() {
    return this.programLib;
  }, setProgramLibrary:function(programLib) {
    this.programLib = programLib;
  }, setFramebuffer:function(fb) {
    if (this.activeFramebuffer !== fb) {
      this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, fb);
      this.activeFramebuffer = fb;
    }
  }, _checkFbo:function() {
    var gl = this.gl;
    var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
    switch(status) {
      case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:
        console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");
        break;
      case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:
        console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
        break;
      case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:
        console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");
        break;
      case gl.FRAMEBUFFER_UNSUPPORTED:
        console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");
        break;
      case gl.FRAMEBUFFER_COMPLETE:
        break;
      default:
        break;
    }
  }, copyRenderTarget:function(source, dest, color, depth) {
    var gl = this.gl;
    var shaderCopy = false;
    if (!this.webgl2 && depth) {
      return false;
    }
    if (color) {
      if (!source._colorBuffer || !dest._colorBuffer) {
        return false;
      }
      if (source._colorBuffer._format !== dest._colorBuffer._format) {
        return false;
      }
    }
    if (depth) {
      if (!source._depthBuffer || !dest._depthBuffer) {
        return false;
      }
      if (source._depthBuffer._format !== dest._depthBuffer._format) {
        return false;
      }
    }
    if (this.webgl2) {
      var prevRt = this.renderTarget;
      this.renderTarget = dest;
      this.updateBegin();
      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, source ? source._glFrameBuffer : null);
      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, dest._glFrameBuffer);
      var w = source ? source.width : dest.width;
      var h = source ? source.height : dest.height;
      gl.blitFramebuffer(0, 0, w, h, 0, 0, w, h, (color ? gl.COLOR_BUFFER_BIT : 0) | (depth ? gl.DEPTH_BUFFER_BIT : 0), gl.NEAREST);
      this.renderTarget = prevRt;
      gl.bindFramebuffer(gl.FRAMEBUFFER, prevRt ? prevRt._glFrameBuffer : null);
    } else {
      if (!this._copyShader) {
        var chunks = pc.shaderChunks;
        this._copyShader = chunks.createShaderFromCode(this, chunks.fullscreenQuadVS, chunks.outputTex2DPS, "outputTex2D");
      }
      this.constantTexSource.setValue(source._colorBuffer);
      pc.drawQuadWithShader(this, dest, this._copyShader);
    }
    return true;
  }, updateBegin:function() {
    var gl = this.gl;
    this.boundBuffer = null;
    this.indexBuffer = null;
    var target = this.renderTarget;
    if (target) {
      if (!target._glFrameBuffer) {
        target._device = this;
        target._glFrameBuffer = gl.createFramebuffer();
        this.setFramebuffer(target._glFrameBuffer);
        var colorBuffer = target._colorBuffer;
        if (colorBuffer) {
          if (!colorBuffer._glTextureId) {
            colorBuffer._width = Math.min(colorBuffer.width, this.maxRenderBufferSize);
            colorBuffer._height = Math.min(colorBuffer.height, this.maxRenderBufferSize);
            this.setTexture(colorBuffer, 0);
          }
          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, colorBuffer._cubemap ? gl.TEXTURE_CUBE_MAP_POSITIVE_X + target._face : gl.TEXTURE_2D, colorBuffer._glTextureId, 0);
        }
        var depthBuffer = target._depthBuffer;
        if (depthBuffer && this.webgl2) {
          if (!depthBuffer._glTextureId) {
            depthBuffer._width = Math.min(depthBuffer.width, this.maxRenderBufferSize);
            depthBuffer._height = Math.min(depthBuffer.height, this.maxRenderBufferSize);
            this.setTexture(depthBuffer, 0);
          }
          if (target._stencil) {
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_STENCIL_ATTACHMENT, depthBuffer._cubemap ? gl.TEXTURE_CUBE_MAP_POSITIVE_X + target._face : gl.TEXTURE_2D, target._depthBuffer._glTextureId, 0);
          } else {
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, depthBuffer._cubemap ? gl.TEXTURE_CUBE_MAP_POSITIVE_X + target._face : gl.TEXTURE_2D, target._depthBuffer._glTextureId, 0);
          }
        } else {
          if (target._depth) {
            var willRenderMsaa = target._samples > 1 && this.webgl2;
            if (!willRenderMsaa) {
              if (!target._glDepthBuffer) {
                target._glDepthBuffer = gl.createRenderbuffer();
              }
              gl.bindRenderbuffer(gl.RENDERBUFFER, target._glDepthBuffer);
              if (target._stencil) {
                gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_STENCIL, target.width, target.height);
                gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_STENCIL_ATTACHMENT, gl.RENDERBUFFER, target._glDepthBuffer);
              } else {
                gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, target.width, target.height);
                gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, target._glDepthBuffer);
              }
              gl.bindRenderbuffer(gl.RENDERBUFFER, null);
            }
          }
        }
        if (this.webgl2 && target._samples > 1) {
          target._glResolveFrameBuffer = target._glFrameBuffer;
          target._glFrameBuffer = gl.createFramebuffer();
          this.setFramebuffer(target._glFrameBuffer);
          if (colorBuffer) {
            if (!target._glMsaaColorBuffer) {
              target._glMsaaColorBuffer = gl.createRenderbuffer();
            }
            gl.bindRenderbuffer(gl.RENDERBUFFER, target._glMsaaColorBuffer);
            gl.renderbufferStorageMultisample(gl.RENDERBUFFER, target._samples, colorBuffer._glInternalFormat, target.width, target.height);
            gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, target._glMsaaColorBuffer);
          }
          if (target._depth) {
            if (!target._glMsaaDepthBuffer) {
              target._glMsaaDepthBuffer = gl.createRenderbuffer();
            }
            gl.bindRenderbuffer(gl.RENDERBUFFER, target._glMsaaDepthBuffer);
            if (target._stencil) {
              gl.renderbufferStorageMultisample(gl.RENDERBUFFER, target._samples, gl.DEPTH24_STENCIL8, target.width, target.height);
              gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_STENCIL_ATTACHMENT, gl.RENDERBUFFER, target._glMsaaDepthBuffer);
            } else {
              gl.renderbufferStorageMultisample(gl.RENDERBUFFER, target._samples, gl.DEPTH_COMPONENT32F, target.width, target.height);
              gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, target._glMsaaDepthBuffer);
            }
          }
        }
      } else {
        this.setFramebuffer(target._glFrameBuffer);
      }
    } else {
      this.setFramebuffer(null);
    }
    for (var i = 0;i < 16;i++) {
      this.textureUnits[i] = null;
    }
  }, updateEnd:function() {
    var gl = this.gl;
    var target = this.renderTarget;
    if (target) {
      var colorBuffer = target._colorBuffer;
      if (colorBuffer && colorBuffer._glTextureId && colorBuffer.mipmaps && colorBuffer._pot) {
        gl.bindTexture(colorBuffer._glTarget, colorBuffer._glTextureId);
        gl.generateMipmap(colorBuffer._glTarget);
      }
      if (this.webgl2 && target._samples > 1 && target.autoResolve) {
        target.resolve();
      }
    }
  }, initializeTexture:function(texture) {
    var gl = this.gl;
    var ext;
    texture._glTextureId = gl.createTexture();
    texture._glTarget = texture._cubemap ? gl.TEXTURE_CUBE_MAP : texture._volume ? gl.TEXTURE_3D : gl.TEXTURE_2D;
    switch(texture._format) {
      case pc.PIXELFORMAT_A8:
        texture._glFormat = gl.ALPHA;
        texture._glInternalFormat = gl.ALPHA;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_L8:
        texture._glFormat = gl.LUMINANCE;
        texture._glInternalFormat = gl.LUMINANCE;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_L8_A8:
        texture._glFormat = gl.LUMINANCE_ALPHA;
        texture._glInternalFormat = gl.LUMINANCE_ALPHA;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_R5_G6_B5:
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = gl.RGB;
        texture._glPixelType = gl.UNSIGNED_SHORT_5_6_5;
        break;
      case pc.PIXELFORMAT_R5_G5_B5_A1:
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = gl.RGBA;
        texture._glPixelType = gl.UNSIGNED_SHORT_5_5_5_1;
        break;
      case pc.PIXELFORMAT_R4_G4_B4_A4:
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = gl.RGBA;
        texture._glPixelType = gl.UNSIGNED_SHORT_4_4_4_4;
        break;
      case pc.PIXELFORMAT_R8_G8_B8:
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = gl.RGB;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_R8_G8_B8_A8:
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = gl.RGBA;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_DXT1:
        ext = this.extCompressedTextureS3TC;
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = ext.COMPRESSED_RGB_S3TC_DXT1_EXT;
        break;
      case pc.PIXELFORMAT_DXT3:
        ext = this.extCompressedTextureS3TC;
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;
        break;
      case pc.PIXELFORMAT_DXT5:
        ext = this.extCompressedTextureS3TC;
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;
        break;
      case pc.PIXELFORMAT_ETC1:
        ext = this.extCompressedTextureETC1;
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = ext.COMPRESSED_RGB_ETC1_WEBGL;
        break;
      case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:
        ext = this.extCompressedTexturePVRTC;
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;
        break;
      case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:
        ext = this.extCompressedTexturePVRTC;
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;
        break;
      case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:
        ext = this.extCompressedTexturePVRTC;
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;
        break;
      case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:
        ext = this.extCompressedTexturePVRTC;
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;
        break;
      case pc.PIXELFORMAT_RGB16F:
        ext = this.extTextureHalfFloat;
        texture._glFormat = gl.RGB;
        if (this.webgl2) {
          texture._glInternalFormat = gl.RGB16F;
          texture._glPixelType = gl.HALF_FLOAT;
        } else {
          texture._glInternalFormat = gl.RGB;
          texture._glPixelType = ext.HALF_FLOAT_OES;
        }
        break;
      case pc.PIXELFORMAT_RGBA16F:
        ext = this.extTextureHalfFloat;
        texture._glFormat = gl.RGBA;
        if (this.webgl2) {
          texture._glInternalFormat = gl.RGBA16F;
          texture._glPixelType = gl.HALF_FLOAT;
        } else {
          texture._glInternalFormat = gl.RGBA;
          texture._glPixelType = ext.HALF_FLOAT_OES;
        }
        break;
      case pc.PIXELFORMAT_RGB32F:
        texture._glFormat = gl.RGB;
        if (this.webgl2) {
          texture._glInternalFormat = gl.RGB32F;
        } else {
          texture._glInternalFormat = gl.RGB;
        }
        texture._glPixelType = gl.FLOAT;
        break;
      case pc.PIXELFORMAT_RGBA32F:
        texture._glFormat = gl.RGBA;
        if (this.webgl2) {
          texture._glInternalFormat = gl.RGBA32F;
        } else {
          texture._glInternalFormat = gl.RGBA;
        }
        texture._glPixelType = gl.FLOAT;
        break;
      case pc.PIXELFORMAT_R32F:
        texture._glFormat = gl.RED;
        texture._glInternalFormat = gl.R32F;
        texture._glPixelType = gl.FLOAT;
        break;
      case pc.PIXELFORMAT_DEPTH:
        if (this.webgl2) {
          texture._glFormat = gl.DEPTH_COMPONENT;
          texture._glInternalFormat = gl.DEPTH_COMPONENT32F;
          texture._glPixelType = gl.FLOAT;
        } else {
          texture._glFormat = gl.DEPTH_COMPONENT;
          texture._glInternalFormat = gl.DEPTH_COMPONENT;
          texture._glPixelType = gl.UNSIGNED_SHORT;
        }
        break;
      case pc.PIXELFORMAT_DEPTHSTENCIL:
        texture._glFormat = gl.DEPTH_STENCIL;
        texture._glInternalFormat = gl.DEPTH24_STENCIL8;
        texture._glPixelType = gl.UNSIGNED_INT_24_8;
        break;
      case pc.PIXELFORMAT_111110F:
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = gl.R11F_G11F_B10F;
        texture._glPixelType = gl.FLOAT;
        break;
      case pc.PIXELFORMAT_SRGB:
        texture._glFormat = gl.RGB;
        texture._glInternalFormat = gl.SRGB8;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
      case pc.PIXELFORMAT_SRGBA:
        texture._glFormat = gl.RGBA;
        texture._glInternalFormat = gl.SRGB8_ALPHA8;
        texture._glPixelType = gl.UNSIGNED_BYTE;
        break;
    }
  }, uploadTexture:function(texture) {
    var gl = this.gl;
    if (!texture._needsUpload && (texture._needsMipmapsUpload && texture._mipmapsUploaded || !texture._pot)) {
      return;
    }
    var mipLevel = 0;
    var mipObject;
    var resMult;
    while (texture._levels[mipLevel] || mipLevel === 0) {
      if (!texture._needsUpload && mipLevel === 0) {
        mipLevel++;
        continue;
      } else {
        if (mipLevel && (!texture._needsMipmapsUpload || !texture._mipmaps)) {
          break;
        }
      }
      mipObject = texture._levels[mipLevel];
      if (mipLevel == 1 && !texture._compressed) {
        gl.generateMipmap(texture._glTarget);
        texture._mipmapsUploaded = true;
      }
      if (texture._cubemap) {
        var face;
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, false);
        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);
        if (mipObject[0] instanceof HTMLCanvasElement || mipObject[0] instanceof HTMLImageElement || mipObject[0] instanceof HTMLVideoElement) {
          for (face = 0;face < 6;face++) {
            if (!texture._levelsUpdated[0][face]) {
              continue;
            }
            var src = mipObject[face];
            if (src instanceof HTMLImageElement) {
              if (src.width > this.maxCubeMapSize || src.height > this.maxCubeMapSize) {
                src = _downsampleImage(src, this.maxCubeMapSize);
                if (mipLevel === 0) {
                  texture.width = src.width;
                  texture.height = src.height;
                }
              }
            }
            gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + face, mipLevel, texture._glInternalFormat, texture._glFormat, texture._glPixelType, src);
          }
        } else {
          resMult = 1 / Math.pow(2, mipLevel);
          for (face = 0;face < 6;face++) {
            if (!texture._levelsUpdated[0][face]) {
              continue;
            }
            var texData = mipObject[face];
            if (texture._compressed) {
              gl.compressedTexImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + face, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), 0, texData);
            } else {
              gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + face, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), 0, texture._glFormat, texture._glPixelType, texData);
            }
          }
        }
      } else {
        if (texture._volume) {
          gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, false);
          resMult = 1 / Math.pow(2, mipLevel);
          if (texture._compressed) {
            gl.compressedTexImage3D(gl.TEXTURE_3D, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), Math.max(texture._depth * resMult, 1), 0, mipObject);
          } else {
            gl.texImage3D(gl.TEXTURE_3D, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), Math.max(texture._depth * resMult, 1), 0, texture._glFormat, texture._glPixelType, mipObject);
          }
        } else {
          if (mipObject instanceof HTMLCanvasElement || mipObject instanceof HTMLImageElement || mipObject instanceof HTMLVideoElement) {
            if (mipObject instanceof HTMLImageElement) {
              if (mipObject.width > this.maxTextureSize || mipObject.height > this.maxTextureSize) {
                mipObject = _downsampleImage(mipObject, this.maxTextureSize);
                if (mipLevel === 0) {
                  texture.width = mipObject.width;
                  texture.height = mipObject.height;
                }
              }
            }
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, texture._flipY);
            gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);
            gl.texImage2D(gl.TEXTURE_2D, mipLevel, texture._glInternalFormat, texture._glFormat, texture._glPixelType, mipObject);
          } else {
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, false);
            resMult = 1 / Math.pow(2, mipLevel);
            if (texture._compressed) {
              gl.compressedTexImage2D(gl.TEXTURE_2D, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), 0, mipObject);
            } else {
              gl.texImage2D(gl.TEXTURE_2D, mipLevel, texture._glInternalFormat, Math.max(texture._width * resMult, 1), Math.max(texture._height * resMult, 1), 0, texture._glFormat, texture._glPixelType, mipObject);
            }
          }
          if (mipLevel === 0) {
            texture._mipmapsUploaded = false;
          } else {
            texture._mipmapsUploaded = true;
          }
        }
      }
      mipLevel++;
    }
    if (texture._needsUpload) {
      if (texture._cubemap) {
        for (var i = 0;i < 6;i++) {
          texture._levelsUpdated[0][i] = false;
        }
      } else {
        texture._levelsUpdated[0] = false;
      }
    }
    if (!texture._compressed && texture._mipmaps && texture._needsMipmapsUpload && texture._pot && texture._levels.length === 1) {
      gl.generateMipmap(texture._glTarget);
      texture._mipmapsUploaded = true;
    }
    if (texture._gpuSize) {
      this._vram.tex -= texture._gpuSize;
    }
    texture._gpuSize = gpuTexSize(gl, texture);
    this._vram.tex += texture._gpuSize;
  }, setTexture:function(texture, textureUnit) {
    var gl = this.gl;
    if (!texture._glTextureId) {
      this.initializeTexture(texture);
    }
    var paramDirty = texture._minFilterDirty || texture._magFilterDirty || texture._addressUDirty || texture._addressVDirty || texture._addressWDirty || texture._anisotropyDirty || texture._compareModeDirty;
    if (this.textureUnits[textureUnit] !== texture || paramDirty) {
      if (this.activeTexture !== textureUnit) {
        gl.activeTexture(gl.TEXTURE0 + textureUnit);
        this.activeTexture = textureUnit;
      }
      gl.bindTexture(texture._glTarget, texture._glTextureId);
      this.textureUnits[textureUnit] = texture;
    }
    if (paramDirty) {
      if (texture._minFilterDirty) {
        var filter = texture._minFilter;
        if (!texture._pot || !texture._mipmaps || texture._compressed && texture._levels.length === 1) {
          if (filter === pc.FILTER_NEAREST_MIPMAP_NEAREST || filter === pc.FILTER_NEAREST_MIPMAP_LINEAR) {
            filter = pc.FILTER_NEAREST;
          } else {
            if (filter === pc.FILTER_LINEAR_MIPMAP_NEAREST || filter === pc.FILTER_LINEAR_MIPMAP_LINEAR) {
              filter = pc.FILTER_LINEAR;
            }
          }
        }
        gl.texParameteri(texture._glTarget, gl.TEXTURE_MIN_FILTER, this.glFilter[filter]);
        texture._minFilterDirty = false;
      }
      if (texture._magFilterDirty) {
        gl.texParameteri(texture._glTarget, gl.TEXTURE_MAG_FILTER, this.glFilter[texture._magFilter]);
        texture._magFilterDirty = false;
      }
      if (texture._addressUDirty) {
        if (this.webgl2) {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_WRAP_S, this.glAddress[texture._addressU]);
        } else {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_WRAP_S, this.glAddress[texture._pot ? texture._addressU : pc.ADDRESS_CLAMP_TO_EDGE]);
        }
        texture._addressUDirty = false;
      }
      if (texture._addressVDirty) {
        if (this.webgl2) {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_WRAP_T, this.glAddress[texture._addressV]);
        } else {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_WRAP_T, this.glAddress[texture._pot ? texture._addressV : pc.ADDRESS_CLAMP_TO_EDGE]);
        }
        texture._addressVDirty = false;
      }
      if (this.webgl2) {
        if (texture._addressWDirty) {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_WRAP_R, this.glAddress[texture._addressW]);
          texture._addressWDirty = false;
        }
        if (texture._compareModeDirty) {
          gl.texParameteri(texture._glTarget, gl.TEXTURE_COMPARE_MODE, texture._compareOnRead ? gl.COMPARE_REF_TO_TEXTURE : gl.NONE);
          gl.texParameteri(texture._glTarget, gl.TEXTURE_COMPARE_FUNC, this.glComparison[texture._compareFunc]);
          texture._compareModeDirty = false;
        }
      }
      if (texture._anisotropyDirty) {
        var ext = this.extTextureFilterAnisotropic;
        if (ext) {
          gl.texParameterf(texture._glTarget, ext.TEXTURE_MAX_ANISOTROPY_EXT, Math.max(1, Math.min(Math.round(texture._anisotropy), this.maxAnisotropy)));
        }
        texture._anisotropyDirty = false;
      }
    }
    if (texture._needsUpload || texture._needsMipmapsUpload) {
      this.uploadTexture(texture);
      texture._needsUpload = false;
      texture._needsMipmapsUpload = false;
    }
  }, draw:function(primitive, numInstances) {
    var gl = this.gl;
    var i, j, len;
    var sampler, samplerValue, texture, numTextures;
    var uniform, scopeId, uniformVersion, programVersion, locationId;
    var shader = this.shader;
    var samplers = shader.samplers;
    var uniforms = shader.uniforms;
    if (numInstances > 1) {
      this.boundBuffer = null;
      this.attributesInvalidated = true;
    }
    if (this.attributesInvalidated) {
      var attribute, element, vertexBuffer, vbOffset, bufferId;
      var attributes = shader.attributes;
      for (i = 0, len = attributes.length;i < len;i++) {
        attribute = attributes[i];
        element = attribute.scopeId.value;
        if (element !== null) {
          vertexBuffer = this.vertexBuffers[element.stream];
          vbOffset = this.vbOffsets[element.stream] || 0;
          bufferId = vertexBuffer.bufferId;
          if (this.boundBuffer !== bufferId) {
            gl.bindBuffer(gl.ARRAY_BUFFER, bufferId);
            this.boundBuffer = bufferId;
          }
          locationId = attribute.locationId;
          if (!this.enabledAttributes[locationId]) {
            gl.enableVertexAttribArray(locationId);
            this.enabledAttributes[locationId] = true;
          }
          gl.vertexAttribPointer(locationId, element.numComponents, this.glType[element.dataType], element.normalize, element.stride, element.offset + vbOffset);
          if (element.stream === 1 && numInstances > 1) {
            if (!this.instancedAttribs[locationId]) {
              this.extInstancing.vertexAttribDivisorANGLE(locationId, 1);
              this.instancedAttribs[locationId] = true;
            }
          } else {
            if (this.instancedAttribs[locationId]) {
              this.extInstancing.vertexAttribDivisorANGLE(locationId, 0);
              this.instancedAttribs[locationId] = false;
            }
          }
        }
      }
      this.attributesInvalidated = false;
    }
    var textureUnit = 0;
    for (i = 0, len = samplers.length;i < len;i++) {
      sampler = samplers[i];
      samplerValue = sampler.scopeId.value;
      if (!samplerValue) {
        continue;
      }
      if (samplerValue instanceof pc.Texture) {
        texture = samplerValue;
        this.setTexture(texture, textureUnit);
        if (sampler.slot !== textureUnit) {
          gl.uniform1i(sampler.locationId, textureUnit);
          sampler.slot = textureUnit;
        }
        textureUnit++;
      } else {
        sampler.array.length = 0;
        numTextures = samplerValue.length;
        for (j = 0;j < numTextures;j++) {
          texture = samplerValue[j];
          this.setTexture(texture, textureUnit);
          sampler.array[j] = textureUnit;
          textureUnit++;
        }
        gl.uniform1iv(sampler.locationId, sampler.array);
      }
    }
    for (i = 0, len = uniforms.length;i < len;i++) {
      uniform = uniforms[i];
      scopeId = uniform.scopeId;
      uniformVersion = uniform.version;
      programVersion = scopeId.versionObject.version;
      if (uniformVersion.globalId !== programVersion.globalId || uniformVersion.revision !== programVersion.revision) {
        uniformVersion.globalId = programVersion.globalId;
        uniformVersion.revision = programVersion.revision;
        if (scopeId.value !== null) {
          this.commitFunction[uniform.dataType](uniform, scopeId.value);
        }
      }
    }
    this._drawCallsPerFrame++;
    this._primsPerFrame[primitive.type] += primitive.count * (numInstances > 1 ? numInstances : 1);
    if (this.webgl2 && this.transformFeedbackBuffer) {
      gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, this.transformFeedbackBuffer.bufferId);
      gl.beginTransformFeedback(gl.POINTS);
    }
    if (primitive.indexed) {
      if (numInstances > 1) {
        this.extInstancing.drawElementsInstancedANGLE(this.glPrimitive[primitive.type], primitive.count, this.indexBuffer.glFormat, primitive.base * 2, numInstances);
        this.boundBuffer = null;
        this.attributesInvalidated = true;
      } else {
        gl.drawElements(this.glPrimitive[primitive.type], primitive.count, this.indexBuffer.glFormat, primitive.base * this.indexBuffer.bytesPerIndex);
      }
    } else {
      if (numInstances > 1) {
        this.extInstancing.drawArraysInstancedANGLE(this.glPrimitive[primitive.type], primitive.base, primitive.count, numInstances);
        this.boundBuffer = null;
        this.attributesInvalidated = true;
      } else {
        gl.drawArrays(this.glPrimitive[primitive.type], primitive.base, primitive.count);
      }
    }
    if (this.webgl2 && this.transformFeedbackBuffer) {
      gl.endTransformFeedback();
      gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, null);
    }
  }, clear:function(options) {
    var defaultOptions = this.defaultClearOptions;
    options = options || defaultOptions;
    var flags = options.flags == undefined ? defaultOptions.flags : options.flags;
    if (flags !== 0) {
      var gl = this.gl;
      if (flags & pc.CLEARFLAG_COLOR) {
        var color = options.color == undefined ? defaultOptions.color : options.color;
        this.setClearColor(color[0], color[1], color[2], color[3]);
      }
      if (flags & pc.CLEARFLAG_DEPTH) {
        var depth = options.depth == undefined ? defaultOptions.depth : options.depth;
        this.setClearDepth(depth);
        if (!this.depthWrite) {
          gl.depthMask(true);
        }
      }
      if (flags & pc.CLEARFLAG_STENCIL) {
        var stencil = options.stencil == undefined ? defaultOptions.stencil : options.stencil;
        this.setClearStencil(stencil);
      }
      gl.clear(this.glClearFlag[flags]);
      if (flags & pc.CLEARFLAG_DEPTH) {
        if (!this.depthWrite) {
          gl.depthMask(false);
        }
      }
    }
  }, readPixels:function(x, y, w, h, pixels) {
    var gl = this.gl;
    gl.readPixels(x, y, w, h, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
  }, setClearDepth:function(depth) {
    if (depth !== this.clearDepth) {
      this.gl.clearDepth(depth);
      this.clearDepth = depth;
    }
  }, setClearColor:function(r, g, b, a) {
    if (r !== this.clearRed || g !== this.clearGreen || b !== this.clearBlue || a !== this.clearAlpha) {
      this.gl.clearColor(r, g, b, a);
      this.clearRed = r;
      this.clearGreen = g;
      this.clearBlue = b;
      this.clearAlpha = a;
    }
  }, setClearStencil:function(value) {
    if (value !== this.clearStencil) {
      this.gl.clearStencil(value);
      this.clearStencil = value;
    }
  }, setRenderTarget:function(renderTarget) {
    this.renderTarget = renderTarget;
  }, getRenderTarget:function() {
    return this.renderTarget;
  }, getDepthTest:function() {
    return this.depthTest;
  }, setDepthTest:function(depthTest) {
    if (this.depthTest !== depthTest) {
      var gl = this.gl;
      if (depthTest) {
        gl.enable(gl.DEPTH_TEST);
      } else {
        gl.disable(gl.DEPTH_TEST);
      }
      this.depthTest = depthTest;
    }
  }, setDepthFunc:function(func) {
    if (this.depthFunc === func) {
      return;
    }
    this.gl.depthFunc(this.glComparison[func]);
    this.depthFunc = func;
  }, getDepthWrite:function() {
    return this.depthWrite;
  }, setDepthWrite:function(writeDepth) {
    if (this.depthWrite !== writeDepth) {
      this.gl.depthMask(writeDepth);
      this.depthWrite = writeDepth;
    }
  }, setColorWrite:function(writeRed, writeGreen, writeBlue, writeAlpha) {
    if (this.writeRed !== writeRed || this.writeGreen !== writeGreen || this.writeBlue !== writeBlue || this.writeAlpha !== writeAlpha) {
      this.gl.colorMask(writeRed, writeGreen, writeBlue, writeAlpha);
      this.writeRed = writeRed;
      this.writeGreen = writeGreen;
      this.writeBlue = writeBlue;
      this.writeAlpha = writeAlpha;
    }
  }, setAlphaToCoverage:function(state) {
    if (!this.webgl2) {
      return;
    }
    if (this.alphaToCoverage === state) {
      return;
    }
    this.alphaToCoverage = state;
    if (state) {
      this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE);
    } else {
      this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE);
    }
  }, setTransformFeedbackBuffer:function(tf) {
    if (this.transformFeedbackBuffer === tf) {
      return;
    }
    this.transformFeedbackBuffer = tf;
    if (this.webgl2) {
      var gl = this.gl;
      if (tf) {
        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, this.feedback);
      } else {
        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);
      }
    }
  }, setRaster:function(on) {
    if (this.raster === on) {
      return;
    }
    this.raster = on;
    if (this.webgl2) {
      if (on) {
        this.gl.disable(this.gl.RASTERIZER_DISCARD);
      } else {
        this.gl.enable(this.gl.RASTERIZER_DISCARD);
      }
    }
  }, setDepthBias:function(on) {
    if (this.depthBiasEnabled === on) {
      return;
    }
    this.depthBiasEnabled = on;
    if (on) {
      this.gl.enable(this.gl.POLYGON_OFFSET_FILL);
    } else {
      this.gl.disable(this.gl.POLYGON_OFFSET_FILL);
    }
  }, setDepthBiasValues:function(constBias, slopeBias) {
    this.gl.polygonOffset(slopeBias, constBias);
  }, getBlending:function() {
    return this.blending;
  }, setBlending:function(blending) {
    if (this.blending !== blending) {
      var gl = this.gl;
      if (blending) {
        gl.enable(gl.BLEND);
      } else {
        gl.disable(gl.BLEND);
      }
      this.blending = blending;
    }
  }, setStencilTest:function(enable) {
    if (this.stencil !== enable) {
      var gl = this.gl;
      if (enable) {
        gl.enable(gl.STENCIL_TEST);
      } else {
        gl.disable(gl.STENCIL_TEST);
      }
      this.stencil = enable;
    }
  }, setStencilFunc:function(func, ref, mask) {
    if (this.stencilFuncFront !== func || this.stencilRefFront !== ref || this.stencilMaskFront !== mask || this.stencilFuncBack !== func || this.stencilRefBack !== ref || this.stencilMaskBack !== mask) {
      var gl = this.gl;
      gl.stencilFunc(this.glComparison[func], ref, mask);
      this.stencilFuncFront = this.stencilFuncBack = func;
      this.stencilRefFront = this.stencilRefBack = ref;
      this.stencilMaskFront = this.stencilMaskBack = mask;
    }
  }, setStencilFuncFront:function(func, ref, mask) {
    if (this.stencilFuncFront !== func || this.stencilRefFront !== ref || this.stencilMaskFront !== mask) {
      var gl = this.gl;
      gl.stencilFuncSeparate(gl.FRONT, this.glComparison[func], ref, mask);
      this.stencilFuncFront = func;
      this.stencilRefFront = ref;
      this.stencilMaskFront = mask;
    }
  }, setStencilFuncBack:function(func, ref, mask) {
    if (this.stencilFuncBack !== func || this.stencilRefBack !== ref || this.stencilMaskBack !== mask) {
      var gl = this.gl;
      gl.stencilFuncSeparate(gl.BACK, this.glComparison[func], ref, mask);
      this.stencilFuncBack = func;
      this.stencilRefBack = ref;
      this.stencilMaskBack = mask;
    }
  }, setStencilOperation:function(fail, zfail, zpass, writeMask) {
    if (this.stencilFailFront !== fail || this.stencilZfailFront !== zfail || this.stencilZpassFront !== zpass || this.stencilFailBack !== fail || this.stencilZfailBack !== zfail || this.stencilZpassBack !== zpass) {
      this.gl.stencilOp(this.glStencilOp[fail], this.glStencilOp[zfail], this.glStencilOp[zpass]);
      this.stencilFailFront = this.stencilFailBack = fail;
      this.stencilZfailFront = this.stencilZfailBack = zfail;
      this.stencilZpassFront = this.stencilZpassBack = zpass;
    }
    if (this.stencilWriteMaskFront !== writeMask || this.stencilWriteMaskBack !== writeMask) {
      this.gl.stencilMask(writeMask);
      this.stencilWriteMaskFront = writeMask;
      this.stencilWriteMaskBack = writeMask;
    }
  }, setStencilOperationFront:function(fail, zfail, zpass, writeMask) {
    if (this.stencilFailFront !== fail || this.stencilZfailFront !== zfail || this.stencilZpassFront !== zpass) {
      this.gl.stencilOpSeparate(this.gl.FRONT, this.glStencilOp[fail], this.glStencilOp[zfail], this.glStencilOp[zpass]);
      this.stencilFailFront = fail;
      this.stencilZfailFront = zfail;
      this.stencilZpassFront = zpass;
    }
    if (this.stencilWriteMaskFront !== writeMask) {
      this.gl.stencilMaskSeparate(this.gl.FRONT, writeMask);
      this.stencilWriteMaskFront = writeMask;
    }
  }, setStencilOperationBack:function(fail, zfail, zpass, writeMask) {
    if (this.stencilFailBack !== fail || this.stencilZfailBack !== zfail || this.stencilZpassBack !== zpass) {
      this.gl.stencilOpSeparate(this.gl.BACK, this.glStencilOp[fail], this.glStencilOp[zfail], this.glStencilOp[zpass]);
      this.stencilFailBack = fail;
      this.stencilZfailBack = zfail;
      this.stencilZpassBack = zpass;
    }
    if (this.stencilWriteMaskBack !== writeMask) {
      this.gl.stencilMaskSeparate(this.gl.BACK, writeMask);
      this.stencilWriteMaskBack = writeMask;
    }
  }, setBlendFunction:function(blendSrc, blendDst) {
    if (this.blendSrc !== blendSrc || this.blendDst !== blendDst || this.separateAlphaBlend) {
      this.gl.blendFunc(this.glBlendFunction[blendSrc], this.glBlendFunction[blendDst]);
      this.blendSrc = blendSrc;
      this.blendDst = blendDst;
      this.separateAlphaBlend = false;
    }
  }, setBlendFunctionSeparate:function(blendSrc, blendDst, blendSrcAlpha, blendDstAlpha) {
    if (this.blendSrc !== blendSrc || this.blendDst !== blendDst || this.blendSrcAlpha !== blendSrcAlpha || this.blendDstAlpha !== blendDstAlpha || !this.separateAlphaBlend) {
      this.gl.blendFuncSeparate(this.glBlendFunction[blendSrc], this.glBlendFunction[blendDst], this.glBlendFunction[blendSrcAlpha], this.glBlendFunction[blendDstAlpha]);
      this.blendSrc = blendSrc;
      this.blendDst = blendDst;
      this.blendSrcAlpha = blendSrcAlpha;
      this.blendDstAlpha = blendDstAlpha;
      this.separateAlphaBlend = true;
    }
  }, setBlendEquation:function(blendEquation) {
    if (this.blendEquation !== blendEquation || this.separateAlphaEquation) {
      this.gl.blendEquation(this.glBlendEquation[blendEquation]);
      this.blendEquation = blendEquation;
      this.separateAlphaEquation = false;
    }
  }, setBlendEquationSeparate:function(blendEquation, blendAlphaEquation) {
    if (this.blendEquation !== blendEquation || this.blendAlphaEquation !== blendAlphaEquation || !this.separateAlphaEquation) {
      this.gl.blendEquationSeparate(this.glBlendEquation[blendEquation], this.glBlendEquation[blendAlphaEquation]);
      this.blendEquation = blendEquation;
      this.blendAlphaEquation = blendAlphaEquation;
      this.separateAlphaEquation = true;
    }
  }, setCullMode:function(cullMode) {
    if (this.cullMode !== cullMode) {
      if (cullMode === pc.CULLFACE_NONE) {
        this.gl.disable(this.gl.CULL_FACE);
      } else {
        if (this.cullMode === pc.CULLFACE_NONE) {
          this.gl.enable(this.gl.CULL_FACE);
        }
        var mode = this.glCull[cullMode];
        if (this.cullFace !== mode) {
          this.gl.cullFace(mode);
          this.cullFace = mode;
        }
      }
      this.cullMode = cullMode;
    }
  }, getCullMode:function() {
    return this.cullMode;
  }, setIndexBuffer:function(indexBuffer) {
    if (this.indexBuffer !== indexBuffer) {
      this.indexBuffer = indexBuffer;
      var gl = this.gl;
      gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer ? indexBuffer.bufferId : null);
    }
  }, setVertexBuffer:function(vertexBuffer, stream, vbOffset) {
    if (this.vertexBuffers[stream] !== vertexBuffer || this.vbOffsets[stream] !== vbOffset) {
      this.vertexBuffers[stream] = vertexBuffer;
      this.vbOffsets[stream] = vbOffset;
      var vertexFormat = vertexBuffer.getFormat();
      var i = 0;
      var elements = vertexFormat.elements;
      var numElements = elements.length;
      while (i < numElements) {
        var vertexElement = elements[i++];
        vertexElement.stream = stream;
        vertexElement.scopeId.setValue(vertexElement);
      }
      this.attributesInvalidated = true;
    }
  }, setShader:function(shader) {
    if (shader !== this.shader) {
      this.shader = shader;
      if (!shader.ready) {
        if (!shader.link()) {
          return false;
        }
      }
      this._shaderSwitchesPerFrame++;
      this.gl.useProgram(shader.program);
      this.attributesInvalidated = true;
    }
    return true;
  }, getHdrFormat:function() {
    if (this.extTextureHalfFloatRenderable) {
      return pc.PIXELFORMAT_RGB16F;
    } else {
      if (this.extTextureFloatRenderable) {
        return pc.PIXELFORMAT_RGB32F;
      }
    }
    return pc.PIXELFORMAT_R8_G8_B8_A8;
  }, getBoneLimit:function() {
    return this.boneLimit;
  }, setBoneLimit:function(maxBones) {
    this.boneLimit = maxBones;
  }, enableValidation:function(enable) {
    console.warn("enableValidation: This function is deprecated and will be removed shortly.");
  }, validate:function() {
    console.warn("validate: This function is deprecated and will be removed shortly.");
  }, resizeCanvas:function(width, height) {
    this._width = width;
    this._height = height;
    var ratio = Math.min(this._maxPixelRatio, window.devicePixelRatio);
    width *= ratio;
    height *= ratio;
    this.canvas.width = width;
    this.canvas.height = height;
    this.fire(EVENT_RESIZE, width, height);
  }, setResolution:function(width, height) {
    this._width = width;
    this._height = height;
    this.canvas.width = width;
    this.canvas.height = height;
    this.fire(EVENT_RESIZE, width, height);
  }, clearShaderCache:function() {
    this.programLib.clearCache();
  }, removeShaderFromCache:function(shader) {
    this.programLib.removeFromCache(shader);
  }, destroy:function() {
    if (this.webgl2 && this.feedback) {
      this.gl.deleteTransformFeedback(this.feedback);
    }
  }};
  Object.defineProperty(GraphicsDevice.prototype, "width", {get:function() {
    return this.gl.drawingBufferWidth || this.canvas.width;
  }});
  Object.defineProperty(GraphicsDevice.prototype, "height", {get:function() {
    return this.gl.drawingBufferHeight || this.canvas.height;
  }});
  Object.defineProperty(GraphicsDevice.prototype, "fullscreen", {get:function() {
    return !!document.fullscreenElement;
  }, set:function(fullscreen) {
    if (fullscreen) {
      var canvas = this.gl.canvas;
      canvas.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }});
  Object.defineProperty(GraphicsDevice.prototype, "enableAutoInstancing", {get:function() {
    return this._enableAutoInstancing;
  }, set:function(value) {
    this._enableAutoInstancing = value && this.extInstancing;
  }});
  Object.defineProperty(GraphicsDevice.prototype, "maxAnisotropy", {get:function() {
    var maxAniso;
    return function() {
      if (maxAniso === undefined) {
        maxAniso = 1;
        var gl = this.gl;
        var glExt = this.extTextureFilterAnisotropic;
        if (glExt) {
          maxAniso = gl.getParameter(glExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);
        }
      }
      return maxAniso;
    };
  }()});
  Object.defineProperty(GraphicsDevice.prototype, "maxPixelRatio", {get:function() {
    return this._maxPixelRatio;
  }, set:function(ratio) {
    this._maxPixelRatio = ratio;
    this.resizeCanvas(this._width, this._height);
  }});
  return {UnsupportedBrowserError:UnsupportedBrowserError, ContextCreationError:ContextCreationError, GraphicsDevice:GraphicsDevice, precalculatedTangents:true};
}());
pc.extend(pc, function() {
  var shaderChunks = {};
  var attrib2Semantic = {vertex_position:pc.SEMANTIC_POSITION, vertex_normal:pc.SEMANTIC_NORMAL, vertex_tangent:pc.SEMANTIC_TANGENT, vertex_texCoord0:pc.SEMANTIC_TEXCOORD0, vertex_texCoord1:pc.SEMANTIC_TEXCOORD1, vertex_texCoord2:pc.SEMANTIC_TEXCOORD2, vertex_texCoord3:pc.SEMANTIC_TEXCOORD3, vertex_texCoord4:pc.SEMANTIC_TEXCOORD4, vertex_texCoord5:pc.SEMANTIC_TEXCOORD5, vertex_texCoord6:pc.SEMANTIC_TEXCOORD6, vertex_texCoord7:pc.SEMANTIC_TEXCOORD7, vertex_color:pc.SEMANTIC_COLOR, vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,
  vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT};
  shaderChunks.collectAttribs = function(vsCode) {
    var attribs = {};
    var attrs = 0;
    var found = vsCode.indexOf("attribute");
    while (found >= 0) {
      if (found > 0 && vsCode[found - 1] === "/") {
        break;
      }
      var endOfLine = vsCode.indexOf(";", found);
      var startOfAttribName = vsCode.lastIndexOf(" ", endOfLine);
      var attribName = vsCode.substr(startOfAttribName + 1, endOfLine - (startOfAttribName + 1));
      var semantic = attrib2Semantic[attribName];
      if (semantic !== undefined) {
        attribs[attribName] = semantic;
      } else {
        attribs[attribName] = "ATTR" + attrs;
        attrs++;
      }
      found = vsCode.indexOf("attribute", found + 1);
    }
    return attribs;
  };
  shaderChunks.createShader = function(device, vsName, psName, useTransformFeedback) {
    var vsCode = shaderChunks[vsName];
    var psCode = pc.programlib.precisionCode(device) + "\n" + shaderChunks[psName];
    var attribs = this.collectAttribs(vsCode);
    if (device.webgl2) {
      vsCode = pc.programlib.versionCode(device) + this.gles3VS + vsCode;
      psCode = pc.programlib.versionCode(device) + this.gles3PS + psCode;
    }
    return new pc.Shader(device, {attributes:attribs, vshader:vsCode, fshader:psCode, useTransformFeedback:useTransformFeedback});
  };
  shaderChunks.createShaderFromCode = function(device, vsCode, psCode, uName, useTransformFeedback) {
    var shaderCache = device.programLib._cache;
    var cached = shaderCache[uName];
    if (cached !== undefined) {
      return cached;
    }
    psCode = pc.programlib.precisionCode(device) + "\n" + (psCode || pc.programlib.dummyFragmentCode());
    var attribs = this.collectAttribs(vsCode);
    if (device.webgl2) {
      vsCode = pc.programlib.versionCode(device) + this.gles3VS + vsCode;
      psCode = pc.programlib.versionCode(device) + this.gles3PS + psCode;
    }
    shaderCache[uName] = new pc.Shader(device, {attributes:attribs, vshader:vsCode, fshader:psCode, useTransformFeedback:useTransformFeedback});
    return shaderCache[uName];
  };
  return {shaderChunks:shaderChunks};
}());
pc.extend(pc, function() {
  var _postEffectQuadVB = null;
  var _postEffectQuadDraw = {type:pc.PRIMITIVE_TRISTRIP, base:0, count:4, indexed:false};
  function drawQuadWithShader(device, target, shader, rect, scissorRect, useBlend) {
    if (_postEffectQuadVB === null) {
      var vertexFormat = new pc.VertexFormat(device, [{semantic:pc.SEMANTIC_POSITION, components:2, type:pc.TYPE_FLOAT32}]);
      _postEffectQuadVB = new pc.VertexBuffer(device, vertexFormat, 4);
      var iterator = new pc.VertexIterator(_postEffectQuadVB);
      iterator.element[pc.SEMANTIC_POSITION].set(-1.0, -1.0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(1.0, -1.0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(-1.0, 1.0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(1.0, 1.0);
      iterator.end();
    }
    var oldRt = device.renderTarget;
    device.setRenderTarget(target);
    device.updateBegin();
    var x, y, w, h;
    var sx, sy, sw, sh;
    if (!rect) {
      w = target !== null ? target.width : device.width;
      h = target !== null ? target.height : device.height;
      x = 0;
      y = 0;
    } else {
      x = rect.x;
      y = rect.y;
      w = rect.z;
      h = rect.w;
    }
    if (!scissorRect) {
      sx = x;
      sy = y;
      sw = w;
      sh = h;
    } else {
      sx = scissorRect.x;
      sy = scissorRect.y;
      sw = scissorRect.z;
      sh = scissorRect.w;
    }
    device.setViewport(x, y, w, h);
    device.setScissor(sx, sy, sw, sh);
    var oldDepthTest = device.getDepthTest();
    var oldDepthWrite = device.getDepthWrite();
    var oldCull = device.getCullMode();
    device.setDepthTest(false);
    device.setDepthWrite(false);
    device.setCullMode(pc.CULLFACE_NONE);
    if (!useBlend) {
      device.setBlending(false);
    }
    device.setVertexBuffer(_postEffectQuadVB, 0);
    device.setShader(shader);
    device.draw(_postEffectQuadDraw);
    device.setDepthTest(oldDepthTest);
    device.setDepthWrite(oldDepthWrite);
    device.setCullMode(oldCull);
    device.updateEnd();
    device.setRenderTarget(oldRt);
    device.updateBegin();
  }
  function destroyPostEffectQuad() {
    _postEffectQuadVB = null;
  }
  return {drawQuadWithShader:drawQuadWithShader, destroyPostEffectQuad:destroyPostEffectQuad};
}());
pc.extend(pc, function() {
  function fixChrome() {
    var endTime = Date.now() + 10;
    while (Date.now() < endTime) {
    }
  }
  function syncToCpu(device, targ, face) {
    var tex = targ._colorBuffer;
    if (tex.format != pc.PIXELFORMAT_R8_G8_B8_A8) {
      return;
    }
    var pixels = new Uint8Array(tex.width * tex.height * 4);
    var gl = device.gl;
    device.setFramebuffer(targ._glFrameBuffer);
    gl.readPixels(0, 0, tex.width, tex.height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
    if (!tex._levels) {
      tex._levels = [];
    }
    if (!tex._levels[0]) {
      tex._levels[0] = [];
    }
    tex._levels[0][face] = pixels;
  }
  function prefilterCubemap(options) {
    var device = options.device;
    var sourceCubemap = options.sourceCubemap;
    var method = options.method;
    var samples = options.samples;
    var cpuSync = options.cpuSync;
    var chromeFix = options.chromeFix;
    if (cpuSync && !sourceCubemap._levels[0]) {
      console.error("ERROR: prefilter: cubemap must have _levels");
      return;
    }
    var chunks = pc.shaderChunks;
    var rgbmSource = sourceCubemap.rgbm;
    var shader = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.rgbmPS + chunks.prefilterCubemapPS.replace(/\$METHOD/g, method === 0 ? "cos" : "phong").replace(/\$NUMSAMPLES/g, samples).replace(/\$textureCube/g, rgbmSource ? "textureCubeRGBM" : "textureCube"), "prefilter" + method + "" + samples + "" + rgbmSource);
    var shader2 = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.outputCubemapPS, "outputCubemap");
    var constantTexSource = device.scope.resolve("source");
    var constantParams = device.scope.resolve("params");
    var params = new pc.Vec4;
    var size = sourceCubemap.width;
    var format = sourceCubemap.format;
    var cmapsList = [[], options.filteredFixed, options.filteredRgbm, options.filteredFixedRgbm];
    var gloss = method === 0 ? [0.9, 0.85, 0.7, 0.4, 0.25] : [512, 128, 32, 8, 2];
    var mipSize = [64, 32, 16, 8, 4];
    var numMips = 5;
    var targ;
    var i, face, pass;
    var rgbFormat = format === pc.PIXELFORMAT_R8_G8_B8;
    var isImg = false;
    var nextCubemap, cubemap;
    if (cpuSync) {
      isImg = sourceCubemap._levels[0][0] instanceof HTMLImageElement;
    }
    if ((rgbFormat || isImg) && cpuSync) {
      format = pc.PIXELFORMAT_R8_G8_B8_A8;
      nextCubemap = new pc.gfx.Texture(device, {cubemap:true, rgbm:rgbmSource, format:format, width:size, height:size, mipmaps:false});
      for (face = 0;face < 6;face++) {
        targ = new pc.RenderTarget(device, nextCubemap, {face:face, depth:false});
        params.x = face;
        params.y = 0;
        constantTexSource.setValue(sourceCubemap);
        constantParams.setValue(params.data);
        if (chromeFix) {
          fixChrome();
        }
        pc.drawQuadWithShader(device, targ, shader2);
        syncToCpu(device, targ, face);
      }
      sourceCubemap = nextCubemap;
    }
    if (size > 128) {
      var log128 = Math.round(Math.log2(128));
      var logSize = Math.round(Math.log2(size));
      var steps = logSize - log128;
      for (i = 0;i < steps;i++) {
        size = sourceCubemap.width * 0.5;
        var sampleGloss = method === 0 ? 1 : Math.pow(2, Math.round(Math.log2(gloss[0]) + (steps - i) * 2));
        nextCubemap = new pc.gfx.Texture(device, {cubemap:true, rgbm:rgbmSource, format:format, width:size, height:size, mipmaps:false});
        for (face = 0;face < 6;face++) {
          targ = new pc.RenderTarget(device, nextCubemap, {face:face, depth:false});
          params.x = face;
          params.y = sampleGloss;
          params.z = size;
          params.w = rgbmSource ? 3 : 0;
          constantTexSource.setValue(sourceCubemap);
          constantParams.setValue(params.data);
          if (chromeFix) {
            fixChrome();
          }
          pc.drawQuadWithShader(device, targ, shader2);
          if (i === steps - 1 && cpuSync) {
            syncToCpu(device, targ, face);
          }
        }
        sourceCubemap = nextCubemap;
      }
    }
    options.sourceCubemap = sourceCubemap;
    var sourceCubemapRgbm = null;
    if (!rgbmSource && options.filteredFixedRgbm) {
      nextCubemap = new pc.gfx.Texture(device, {cubemap:true, rgbm:true, format:pc.PIXELFORMAT_R8_G8_B8_A8, width:size, height:size, mipmaps:false});
      for (face = 0;face < 6;face++) {
        targ = new pc.RenderTarget(device, nextCubemap, {face:face, depth:false});
        params.x = face;
        params.w = 2;
        constantTexSource.setValue(sourceCubemap);
        constantParams.setValue(params.data);
        if (chromeFix) {
          fixChrome();
        }
        pc.drawQuadWithShader(device, targ, shader2);
        syncToCpu(device, targ, face);
      }
      sourceCubemapRgbm = nextCubemap;
    }
    var unblurredGloss = method === 0 ? 1 : 2048;
    var startPass = method === 0 ? 0 : -1;
    cmapsList[startPass] = [];
    for (i = 0;i < numMips;i++) {
      for (pass = startPass;pass < cmapsList.length;pass++) {
        if (cmapsList[pass] != null) {
          cmapsList[pass][i] = new pc.gfx.Texture(device, {cubemap:true, rgbm:pass < 2 ? rgbmSource : true, format:pass < 2 ? format : pc.PIXELFORMAT_R8_G8_B8_A8, fixCubemapSeams:pass === 1 || pass === 3, width:mipSize[i], height:mipSize[i], mipmaps:false});
        }
      }
    }
    for (pass = startPass;pass < cmapsList.length;pass++) {
      if (cmapsList[pass] != null) {
        if (pass > 1 && rgbmSource) {
          cmapsList[pass] = cmapsList[pass - 2];
          continue;
        }
        for (i = 0;i < numMips;i++) {
          for (face = 0;face < 6;face++) {
            targ = new pc.RenderTarget(device, cmapsList[pass][i], {face:face, depth:false});
            params.x = face;
            params.y = pass < 0 ? unblurredGloss : gloss[i];
            params.z = mipSize[i];
            params.w = rgbmSource ? 3 : pass;
            constantTexSource.setValue(i === 0 ? sourceCubemap : method === 0 ? cmapsList[0][i - 1] : cmapsList[-1][i - 1]);
            constantParams.setValue(params.data);
            if (chromeFix) {
              fixChrome();
            }
            pc.drawQuadWithShader(device, targ, shader);
            if (cpuSync) {
              syncToCpu(device, targ, face);
            }
          }
        }
      }
    }
    options.filtered = cmapsList[0];
    var mips;
    if (cpuSync && options.singleFilteredFixed) {
      mips = [sourceCubemap, options.filteredFixed[0], options.filteredFixed[1], options.filteredFixed[2], options.filteredFixed[3], options.filteredFixed[4], options.filteredFixed[5]];
      cubemap = new pc.gfx.Texture(device, {cubemap:true, rgbm:rgbmSource, fixCubemapSeams:true, format:format, width:128, height:128, addressU:pc.ADDRESS_CLAMP_TO_EDGE, addressV:pc.ADDRESS_CLAMP_TO_EDGE});
      for (i = 0;i < 6;i++) {
        cubemap._levels[i] = mips[i]._levels[0];
      }
      cubemap.upload();
      cubemap._prefilteredMips = true;
      options.singleFilteredFixed = cubemap;
    }
    if (cpuSync && options.singleFilteredFixedRgbm && options.filteredFixedRgbm) {
      mips = [sourceCubemapRgbm, options.filteredFixedRgbm[0], options.filteredFixedRgbm[1], options.filteredFixedRgbm[2], options.filteredFixedRgbm[3], options.filteredFixedRgbm[4], options.filteredFixedRgbm[5]];
      cubemap = new pc.gfx.Texture(device, {cubemap:true, rgbm:true, fixCubemapSeams:true, format:pc.PIXELFORMAT_R8_G8_B8_A8, width:128, height:128, addressU:pc.ADDRESS_CLAMP_TO_EDGE, addressV:pc.ADDRESS_CLAMP_TO_EDGE});
      for (i = 0;i < 6;i++) {
        cubemap._levels[i] = mips[i]._levels[0];
      }
      cubemap.upload();
      cubemap._prefilteredMips = true;
      options.singleFilteredFixedRgbm = cubemap;
    }
  }
  function areaElement(x, y) {
    return Math.atan2(x * y, Math.sqrt(x * x + y * y + 1));
  }
  function texelCoordSolidAngle(u, v, size) {
    var _u = 2.0 * (u + 0.5) / size - 1.0;
    var _v = 2.0 * (v + 0.5) / size - 1.0;
    _u *= 1.0 - 1.0 / size;
    _v *= 1.0 - 1.0 / size;
    var invResolution = 1.0 / size;
    var x0 = _u - invResolution;
    var y0 = _v - invResolution;
    var x1 = _u + invResolution;
    var y1 = _v + invResolution;
    var solidAngle = areaElement(x0, y0) - areaElement(x0, y1) - areaElement(x1, y0) + areaElement(x1, y1);
    if (u === 0 && v === 0 || u === size - 1 && v === 0 || u === 0 && v === size - 1 || u === size - 1 && v === size - 1) {
      solidAngle /= 3;
    } else {
      if (u === 0 || v === 0 || u === size - 1 || v === size - 1) {
        solidAngle *= 0.5;
      }
    }
    return solidAngle;
  }
  function shFromCubemap(source, dontFlipX) {
    var face;
    var cubeSize = source.width;
    var x, y;
    if (source.format != pc.PIXELFORMAT_R8_G8_B8_A8) {
      console.error("ERROR: SH: cubemap must be RGBA8");
      return;
    }
    if (!source._levels[0]) {
      console.error("ERROR: SH: cubemap must be synced to CPU");
      return;
    }
    if (!source._levels[0][0].length) {
      if (source._levels[0][0] instanceof HTMLImageElement) {
        var device = pc.Application.getApplication().graphicsDevice;
        var gl = device.gl;
        var chunks = pc.shaderChunks;
        var shader = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.fullscreenQuadPS, "fsQuadSimple");
        var constantTexSource = device.scope.resolve("source");
        for (face = 0;face < 6;face++) {
          var img = source._levels[0][face];
          var tex = new pc.Texture(device, {cubemap:false, rgbm:false, format:source.format, width:cubeSize, height:cubeSize, mipmaps:false});
          tex._levels[0] = img;
          tex.upload();
          var tex2 = new pc.Texture(device, {cubemap:false, rgbm:false, format:source.format, width:cubeSize, height:cubeSize, mipmaps:false});
          var targ = new pc.RenderTarget(device, tex2, {depth:false});
          constantTexSource.setValue(tex);
          pc.drawQuadWithShader(device, targ, shader);
          var pixels = new Uint8Array(cubeSize * cubeSize * 4);
          gl.bindFramebuffer(gl.FRAMEBUFFER, targ._glFrameBuffer);
          gl.readPixels(0, 0, tex.width, tex.height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
          source._levels[0][face] = pixels;
        }
      } else {
        console.error("ERROR: SH: cubemap must be composed of arrays or images");
        return;
      }
    }
    var dirs = [];
    for (y = 0;y < cubeSize;y++) {
      for (x = 0;x < cubeSize;x++) {
        var u = x / (cubeSize - 1) * 2 - 1;
        var v = y / (cubeSize - 1) * 2 - 1;
        dirs[y * cubeSize + x] = (new pc.Vec3(u, v, 1.0)).normalize();
      }
    }
    var sh = new Float32Array(9 * 3);
    var coef1 = 0;
    var coef2 = 1 * 3;
    var coef3 = 2 * 3;
    var coef4 = 3 * 3;
    var coef5 = 4 * 3;
    var coef6 = 5 * 3;
    var coef7 = 6 * 3;
    var coef8 = 7 * 3;
    var coef9 = 8 * 3;
    var nx = 0;
    var px = 1;
    var ny = 2;
    var py = 3;
    var nz = 4;
    var pz = 5;
    var addr, c, a, value, weight, dir, dx, dy, dz;
    var weight1, weight2, weight3, weight4, weight5;
    var accum = 0;
    for (face = 0;face < 6;face++) {
      for (y = 0;y < cubeSize;y++) {
        for (x = 0;x < cubeSize;x++) {
          addr = y * cubeSize + x;
          weight = texelCoordSolidAngle(x, y, cubeSize);
          weight1 = weight * 4 / 17;
          weight2 = weight * 8 / 17;
          weight3 = weight * 15 / 17;
          weight4 = weight * 5 / 68;
          weight5 = weight * 15 / 68;
          dir = dirs[addr];
          if (face == nx) {
            dx = dir.z;
            dy = -dir.y;
            dz = -dir.x;
          } else {
            if (face == px) {
              dx = -dir.z;
              dy = -dir.y;
              dz = dir.x;
            } else {
              if (face == ny) {
                dx = dir.x;
                dy = dir.z;
                dz = dir.y;
              } else {
                if (face == py) {
                  dx = dir.x;
                  dy = -dir.z;
                  dz = -dir.y;
                } else {
                  if (face == nz) {
                    dx = dir.x;
                    dy = -dir.y;
                    dz = dir.z;
                  } else {
                    if (face == pz) {
                      dx = -dir.x;
                      dy = -dir.y;
                      dz = -dir.z;
                    }
                  }
                }
              }
            }
          }
          if (!dontFlipX) {
            dx = -dx;
          }
          a = source._levels[0][face][addr * 4 + 3] / 255.0;
          for (c = 0;c < 3;c++) {
            value = source._levels[0][face][addr * 4 + c] / 255.0;
            if (source.rgbm) {
              value *= a * 8.0;
              value *= value;
            } else {
              value = Math.pow(value, 2.2);
            }
            sh[coef1 + c] += value * weight1;
            sh[coef2 + c] += value * weight2 * dx;
            sh[coef3 + c] += value * weight2 * dy;
            sh[coef4 + c] += value * weight2 * dz;
            sh[coef5 + c] += value * weight3 * dx * dz;
            sh[coef6 + c] += value * weight3 * dz * dy;
            sh[coef7 + c] += value * weight3 * dy * dx;
            sh[coef8 + c] += value * weight4 * (3.0 * dz * dz - 1.0);
            sh[coef9 + c] += value * weight5 * (dx * dx - dy * dy);
            accum += weight;
          }
        }
      }
    }
    for (c = 0;c < sh.length;c++) {
      sh[c] *= 4 * Math.PI / accum;
    }
    return sh;
  }
  return {prefilterCubemap:prefilterCubemap, shFromCubemap:shFromCubemap};
}());
pc.extend(pc, function() {
  var dpMult = 2.0;
  function paraboloidFromCubemap(device, sourceCubemap, fixSeamsAmount, dontFlipX) {
    var chunks = pc.shaderChunks;
    var shader = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, (sourceCubemap.fixCubemapSeams ? chunks.fixCubemapSeamsStretchPS : chunks.fixCubemapSeamsNonePS) + chunks.genParaboloidPS, "genParaboloid");
    var constantTexSource = device.scope.resolve("source");
    var constantParams = device.scope.resolve("params");
    var params = new pc.Vec4;
    var size = sourceCubemap.width;
    var rgbmSource = sourceCubemap.rgbm;
    var format = sourceCubemap.format;
    size = Math.max(size, 8) * dpMult;
    var tex = new pc.gfx.Texture(device, {rgbm:rgbmSource, format:format, width:size * 2, height:size, mipmaps:false});
    var targ = new pc.RenderTarget(device, tex, {depth:false});
    params.x = fixSeamsAmount;
    params.y = dontFlipX ? -1.0 : 1.0;
    constantTexSource.setValue(sourceCubemap);
    constantParams.setValue(params.data);
    pc.drawQuadWithShader(device, targ, shader);
    return tex;
  }
  function getDpAtlasRect(rect, mip) {
    rect.x = pc.math.clamp(mip - 2.0, 0, 1) * 0.5;
    var t = mip - rect.x * 6.0;
    var i = 1.0 - rect.x;
    rect.y = Math.min(t * 0.5, 0.75) * i + rect.x;
    rect.z = (1.0 - pc.math.clamp(t, 0, 1) * 0.5) * i;
    rect.w = rect.z * 0.5;
    return 1.0 / rect.z;
  }
  function generateDpAtlas(device, sixCubemaps, dontFlipX) {
    var dp, rect;
    rect = new pc.Vec4;
    var params = new pc.Vec4;
    var size = sixCubemaps[0].width * 2 * dpMult;
    var chunks = pc.shaderChunks;
    var shader = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, chunks.dpAtlasQuadPS, "dpAtlasQuad");
    var constantTexSource = device.scope.resolve("source");
    var constantParams = device.scope.resolve("params");
    var tex = new pc.gfx.Texture(device, {rgbm:sixCubemaps[0].rgbm, format:sixCubemaps[0].format, width:size, height:size, mipmaps:false});
    var targ = new pc.RenderTarget(device, tex, {depth:false});
    var borderSize = 2;
    var mip0Width = size;
    var scaleFactor = (mip0Width + borderSize) / mip0Width - 1;
    var scaleAmount;
    for (var i = 0;i < 6;i++) {
      dp = pc.paraboloidFromCubemap(device, sixCubemaps[i], i, dontFlipX);
      constantTexSource.setValue(dp);
      scaleAmount = getDpAtlasRect(rect, i);
      params.x = scaleAmount * scaleFactor;
      params.y = params.x * 2;
      params.x += 1;
      params.y += 1;
      constantParams.setValue(params.data);
      rect.x *= size;
      rect.y *= size;
      rect.z *= size;
      rect.w *= size;
      pc.drawQuadWithShader(device, targ, shader, rect);
    }
    return tex;
  }
  return {paraboloidFromCubemap:paraboloidFromCubemap, generateDpAtlas:generateDpAtlas};
}());
pc.shaderChunks.TBNPS = "void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n";
pc.shaderChunks.TBNfastPS = "void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n";
pc.shaderChunks.alphaTestPS = "uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n";
pc.shaderChunks.ambientConstantPS = "\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n";
pc.shaderChunks.ambientPrefilteredCubePS = "void addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n";
pc.shaderChunks.ambientPrefilteredCubeLodPS = "void addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n";
pc.shaderChunks.ambientSHPS = "uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n";
pc.shaderChunks.aoSpecOccPS = "uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoSpecOccConstPS = "void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoSpecOccConstSimplePS = "void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoSpecOccSimplePS = "uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
pc.shaderChunks.aoTexPS = "uniform sampler2D texture_aoMap;\nvoid applyAO() {\n    dAo = texture2D(texture_aoMap, $UV).$CH;\n    dDiffuseLight *= dAo;\n}\n";
pc.shaderChunks.aoVertPS = "void applyAO() {\n    dAo = saturate(vVertexColor.$CH);\n    dDiffuseLight *= dAo;\n}\n";
pc.shaderChunks.bakeDirLmEndPS = "\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n";
pc.shaderChunks.bakeLmEndPS = "\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n";
pc.shaderChunks.basePS = "\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n    return x*x;\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n";
pc.shaderChunks.baseVS = "\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n";
pc.shaderChunks.biasConstPS = "#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n";
pc.shaderChunks.blurVSMPS = "\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n";
pc.shaderChunks.combineDiffusePS = "vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n";
pc.shaderChunks.combineDiffuseSpecularPS = "vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n";
pc.shaderChunks.combineDiffuseSpecularNoConservePS = "vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n";
pc.shaderChunks.combineDiffuseSpecularNoReflPS = "vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n";
pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS = "uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n";
pc.shaderChunks.combineDiffuseSpecularOldPS = "vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n";
pc.shaderChunks.cookiePS = "vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n";
pc.shaderChunks.cubeMapProjectBoxPS = "uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n";
pc.shaderChunks.cubeMapProjectNonePS = "vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n";
pc.shaderChunks.diffuseConstPS = "uniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = material_diffuse.rgb;\n}\n";
pc.shaderChunks.diffuseTexPS = "uniform sampler2D texture_diffuseMap;\nvoid getAlbedo() {\n    dAlbedo = texture2DSRGB(texture_diffuseMap, $UV).$CH;\n}\n";
pc.shaderChunks.diffuseTexConstPS = "uniform sampler2D texture_diffuseMap;\nuniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = texture2DSRGB(texture_diffuseMap, $UV).$CH * material_diffuse;\n}\n";
pc.shaderChunks.diffuseVertPS = "void getAlbedo() {\n    dAlbedo = gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n";
pc.shaderChunks.diffuseVertConstPS = "uniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = gammaCorrectInput(saturate(vVertexColor.$CH)) * material_diffuse;\n}\n";
pc.shaderChunks.dilatePS = "varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n";
pc.shaderChunks.dpAtlasQuadPS = "varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n";
pc.shaderChunks.emissiveConstPS = "uniform vec3 material_emissive;\nvec3 getEmission() {\n    return material_emissive;\n}\n";
pc.shaderChunks.emissiveTexPS = "uniform sampler2D texture_emissiveMap;\nvec3 getEmission() {\n    return $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n}\n";
pc.shaderChunks.emissiveTexConstPS = "uniform sampler2D texture_emissiveMap;\nuniform vec3 material_emissive;\nvec3 getEmission() {\n    return $texture2DSAMPLE(texture_emissiveMap, $UV).$CH * material_emissive;\n}\n";
pc.shaderChunks.emissiveTexConstFloatPS = "uniform sampler2D texture_emissiveMap;\nuniform float material_emissiveIntensity;\nvec3 getEmission() {\n    return $texture2DSAMPLE(texture_emissiveMap, $UV).$CH * material_emissiveIntensity;\n}\n";
pc.shaderChunks.emissiveVertPS = "vec3 getEmission() {\n    return gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n";
pc.shaderChunks.emissiveVertConstPS = "uniform vec3 material_emissive;\nvec3 getEmission() {\n    return gammaCorrectInput(saturate(vVertexColor.$CH)) * material_emissive;\n}\n";
pc.shaderChunks.emissiveVertConstFloatPS = "uniform float material_emissiveIntensity;\nvec3 getEmission() {\n    return gammaCorrectInput(saturate(vVertexColor.$CH)) * material_emissiveIntensity;\n}\n";
pc.shaderChunks.endPS = "   gl_FragColor.rgb = combineColor();\n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n";
pc.shaderChunks.envConstPS = "vec3 processEnvironment(vec3 color) {\n    return color;\n}\n";
pc.shaderChunks.envMultiplyPS = "uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n";
pc.shaderChunks.extensionPS = "";
pc.shaderChunks.extensionVS = "\n";
pc.shaderChunks.falloffInvSquaredPS = "float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n    return falloff;\n}\n";
pc.shaderChunks.falloffLinearPS = "float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n";
pc.shaderChunks.fixCubemapSeamsNonePS = "vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n";
pc.shaderChunks.fixCubemapSeamsStretchPS = "vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n";
pc.shaderChunks.fogExpPS = "uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.fogExp2PS = "uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.fogLinearPS = "uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.fogNonePS = "vec3 addFog(vec3 color) {\n    return color;\n}\n";
pc.shaderChunks.fresnelSchlickPS = "// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n}\n";
pc.shaderChunks.fullscreenQuadPS = "varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";
pc.shaderChunks.fullscreenQuadVS = "attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n";
pc.shaderChunks.gamma1_0PS = "vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\nfloat gammaCorrectInput(float color) {\n    return color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n";
pc.shaderChunks.gamma2_2PS = "vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n";
pc.shaderChunks.genParaboloidPS = "varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params; // x = mip\nvoid main(void) {\n    vec2 uv = vUv0;\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n    dir = fixSeams(dir, params.x);\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n";
pc.shaderChunks.gles3PS = "#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n";
pc.shaderChunks.gles3VS = "#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n";
pc.shaderChunks.glossConstPS = "uniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess + 0.0000001;\n}\n";
pc.shaderChunks.glossTexPS = "uniform sampler2D texture_glossMap;\nvoid getGlossiness() {\n    dGlossiness = texture2D(texture_glossMap, $UV).$CH + 0.0000001;\n}\n";
pc.shaderChunks.glossTexConstPS = "uniform sampler2D texture_glossMap;\nuniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess * texture2D(texture_glossMap, $UV).$CH + 0.0000001;\n}\n";
pc.shaderChunks.glossVertPS = "void getGlossiness() {\n    dGlossiness = saturate(vVertexColor.$CH) + 0.0000001;\n}\n";
pc.shaderChunks.glossVertConstPS = "uniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess * saturate(vVertexColor.$CH) + 0.0000001;\n}\n";
pc.shaderChunks.instancingVS = "\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n";
pc.shaderChunks.lightDiffuseLambertPS = "float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n";
pc.shaderChunks.lightDirPointPS = "void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n";
pc.shaderChunks.lightSpecularBlinnPS = "// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular() {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, dNormalW ), 0.0 );\n    float specPow = exp2(dGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n";
pc.shaderChunks.lightSpecularPhongPS = "float getLightSpecular() {\n    float specPow = dGlossiness;\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(dReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n";
pc.shaderChunks.lightmapDirPS = "uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n    dDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n";
pc.shaderChunks.lightmapSinglePS = "uniform sampler2D texture_lightMap;\nvoid addLightMap() {\n    dDiffuseLight += $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n}\n";
pc.shaderChunks.lightmapSingleVertPS = "void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n";
pc.shaderChunks.metalnessPS = "void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n";
pc.shaderChunks.metalnessConstPS = "uniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(material_metalness);\n}\n";
pc.shaderChunks.metalnessTexPS = "uniform sampler2D texture_metalnessMap;\nvoid getSpecularity() {\n    processMetalness(texture2D(texture_metalnessMap, $UV).$CH);\n}\n";
pc.shaderChunks.metalnessTexConstPS = "uniform sampler2D texture_metalnessMap;\nuniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(texture2D(texture_metalnessMap, $UV).$CH * material_metalness);\n}\n";
pc.shaderChunks.metalnessVertPS = "void getSpecularity() {\n    processMetalness(saturate(vVertexColor.$CH));\n}\n";
pc.shaderChunks.metalnessVertConstPS = "uniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(saturate(vVertexColor.$CH) * material_metalness);\n}\n";
pc.shaderChunks.msdfPS = "uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\n// msdf way\n// vec4 applyMsdf(vec4 color) {\n//     vec3 tsample = texture(texture_msdfMap, vUv0).rgb;\n   \n//     // separate\n//     vec2 msdfUnit = 4.0 / vec2(512.0, 256.0);\n//     float sigDist = median(tsample.r, tsample.g, tsample.b) - 0.5;\n//     sigDist *= dot(msdfUnit, 0.5/fwidth(vUv0));\n//     float distance = clamp(sigDist + 0.5, 0.0, 1.0);\n//     return mix(vec4(0.0), color, distance);\n// }\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\nvec4 applyMsdf(vec4 color) {\n    float font_size = 16.0; // TODO fix this\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(map(0.0, 2.0 * font_pxrange / font_textureWidth, w.x), 0.0, 0.5);\n    #else\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n        float smoothing = clamp(2.0 * font_pxrange / font_size, 0.0, 0.5);\n        // for small fonts we remap the distance field to intensify it\n        // float mapMin = 0.05;\n        // float mapMax = clamp(((font_size * 0.4 / 40.0) + 0.52), mapMin, 1.0);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n    \n    // remap to a smaller range (used on smaller font sizes)\n    sigDist = map(mapMin, mapMax, sigDist);\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    // float smoothing = clamp(font_smoothing * (1.0-roy), 0.0, center);\n    float opacity = smoothstep(center-smoothing, center+smoothing, sigDist);\n    // return final color\n    return mix(vec4(0.0), color, opacity);\n}";
pc.shaderChunks.normalVS = "vec3 getNormal() {\n    dNormalMatrix = matrix_normal;\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
pc.shaderChunks.normalInstancedVS = "vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
pc.shaderChunks.normalMapPS = "uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    dNormalW = dTBN * normalMap;\n}\n";
pc.shaderChunks.normalMapFloatPS = "uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalW = dTBN * normalMap;\n}\n";
pc.shaderChunks.normalMapFloatTBNfastPS = "uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n    dNormalW = normalize(dTBN * normalMap);\n}\n";
pc.shaderChunks.normalSkinnedVS = "vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
pc.shaderChunks.normalVertexPS = "void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n}\n";
pc.shaderChunks.normalXYPS = "vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n";
pc.shaderChunks.normalXYZPS = "vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n";
pc.shaderChunks.opacityConstPS = "uniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = material_opacity;\n}\n";
pc.shaderChunks.opacityTexPS = "uniform sampler2D texture_opacityMap;\nvoid getOpacity() {\n    dAlpha = texture2D(texture_opacityMap, $UV).$CH;\n}\n";
pc.shaderChunks.opacityTexConstPS = "uniform sampler2D texture_opacityMap;\nuniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = texture2D(texture_opacityMap, $UV).$CH * material_opacity;\n}\n";
pc.shaderChunks.opacityVertPS = "void getOpacity() {\n    dAlpha = saturate(vVertexColor.$CH);\n}\n";
pc.shaderChunks.opacityVertConstPS = "uniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = saturate(vVertexColor.$CH) * material_opacity;\n}\n";
pc.shaderChunks.outputAlphaPS = "gl_FragColor.a = dAlpha;\n";
pc.shaderChunks.outputAlphaOpaquePS = "gl_FragColor.a = 1.0;\n";
pc.shaderChunks.outputAlphaPremulPS = "gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n";
pc.shaderChunks.outputCubemapPS = "varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n    color.rgb /= color.a;\n    return color;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n";
pc.shaderChunks.outputTex2DPS = "varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";
pc.shaderChunks.packDepthPS = "// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";
pc.shaderChunks.packDepthMaskPS = "vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";
pc.shaderChunks.parallaxPS = "uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n";
pc.shaderChunks.particlePS = "varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float camera_far;\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n    ramp.a += texCoordsAlphaLife.z;\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n";
pc.shaderChunks.particleVS = "\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n    float uv = id / numParticlesPot;\n    readInput(uv);\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    float particleLifetime = lifetime;\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n    mat2 rotMatrix;\n";
pc.shaderChunks.particleAnimFrameClampVS = "\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.z), animTexParams.w);\n";
pc.shaderChunks.particleAnimFrameLoopVS = "\n    float animFrame = floor(texCoordsAlphaLife.w * animTexParams.z);\n";
pc.shaderChunks.particleAnimTexVS = "\n    float atlasX = animFrame * animTexParams.x;\n    float atlasY = floor(atlasX) * animTexParams.y;\n    atlasX = fract(atlasX);\n    texCoordsAlphaLife.xy *= animTexParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n    texCoordsAlphaLife.y = 1.0 - texCoordsAlphaLife.y;\n";
pc.shaderChunks.particleInputFloatPS = "void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n";
pc.shaderChunks.particleInputRgba8PS = "//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n";
pc.shaderChunks.particleOutputFloatPS = "void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n";
pc.shaderChunks.particleOutputRgba8PS = "uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n";
pc.shaderChunks.particleUpdaterAABBPS = "uniform mat3 spawnBounds;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    return emitterPos + spawnBounds * (inBounds - vec3(0.5));\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n";
pc.shaderChunks.particleUpdaterEndPS = "\n    writeOutput();\n}\n";
pc.shaderChunks.particleUpdaterInitPS = "varying vec2 vUv0;\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform mat3 emitterMatrix;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n";
pc.shaderChunks.particleUpdaterNoRespawnPS = "    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n";
pc.shaderChunks.particleUpdaterOnStopPS = "    visMode = outLife < 0.0? -1.0: visMode;\n";
pc.shaderChunks.particleUpdaterRespawnPS = "    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n";
pc.shaderChunks.particleUpdaterSpherePS = "uniform float spawnBoundsSphere;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    return emitterPos + normalize(inBounds.xyz - vec3(0.5)) * rnd4 * spawnBoundsSphere;\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n";
pc.shaderChunks.particleUpdaterStartPS = "float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n    float particleRate = rate + rateDiv * rndFactor.x;\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n    outVel = emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale;\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n    bool respawn = outLife <= 0.0 || outLife >= lifetime;\n    outPos = respawn? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : outPos;\n    outAngle = respawn? mix(startAngle, startAngle2, rndFactor.x) : outAngle;\n    outVel = respawn? vec3(0.0) : outVel;\n";
pc.shaderChunks.particle_TBNVS = "\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n";
pc.shaderChunks.particle_billboardVS = "\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n";
pc.shaderChunks.particle_blendAddPS = "\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n";
pc.shaderChunks.particle_blendMultiplyPS = "\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n";
pc.shaderChunks.particle_blendNormalPS = "\n    if (a < 0.01) discard;\n";
pc.shaderChunks.particle_cpuVS = "attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute vec2 particle_vertexData4;     // X = velocity.z, W = particle ID\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n    mat2 rotMatrix;\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n";
pc.shaderChunks.particle_cpu_endVS = "\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n";
pc.shaderChunks.particle_endPS = "    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";
pc.shaderChunks.particle_endVS = "\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n";
pc.shaderChunks.particle_halflambertPS = "\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n";
pc.shaderChunks.particle_initVS = "attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform mat4 matrix_view;\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n";
pc.shaderChunks.particle_lambertPS = "\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n";
pc.shaderChunks.particle_lightingPS = "\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n    rgb *= light;\n";
pc.shaderChunks.particle_localShiftVS = "    particlePos += emitterPos;\n";
pc.shaderChunks.particle_meshVS = "\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n    billboard(particlePos, quadXY);\n";
pc.shaderChunks.particle_normalVS = "\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n";
pc.shaderChunks.particle_normalMapPS = "\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n";
pc.shaderChunks.particle_pointAlongVS = "    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n";
pc.shaderChunks.particle_softPS = "\n    vec2 screenTC = gl_FragCoord.xy * uScreenSize.zw;\n    float depth = unpackFloat( texture2D(uDepthMap, screenTC) ) * camera_far;\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n";
pc.shaderChunks.particle_softVS = "\n    vDepth = -(matrix_view * vec4(localPos,1.0)).z;\n";
pc.shaderChunks.particle_stretchVS = "    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = inPos - moveDir;\n    posPrev += particlePosMoved;\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n    particlePos = mix(particlePos, posPrev, interpolation);\n";
pc.shaderChunks.particle_wrapVS = "\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n";
pc.shaderChunks.precisionTestPS = "void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n";
pc.shaderChunks.precisionTest2PS = "uniform sampler2D source;\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n";
pc.shaderChunks.prefilterCubemapPS = "varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n";
pc.shaderChunks.reflDirPS = "void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n";
pc.shaderChunks.reflectionCubePS = "uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 lookupVec = fixSeams(cubeMapProject(dReflDirW));\n    lookupVec.x *= -1.0;\n    dReflection += vec4($textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionDpAtlasPS = "uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n    uv = uv * rect.zw + rect.xy;\n    return uv;\n}\nvoid addReflection() {\n    vec3 reflDir = normalize(cubeMapProject(dReflDirW));\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n    dReflection += vec4(tex1, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionPrefilteredCubePS = "uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\nuniform samplerCube texture_prefilteredCubeMap4;\nuniform float material_reflectivity;\nvoid addReflection() {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionPrefilteredCubeLodPS = "#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\nuniform float material_reflectivity;\nvoid addReflection() {\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionSpherePS = "uniform mat4 matrix_view;\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = (mat3(matrix_view) * dReflDirW).xyz;\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n";
pc.shaderChunks.reflectionSphereLowPS = "uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = vNormalV;\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n";
pc.shaderChunks.refractionPS = "uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\nvoid addRefraction() {\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n    addReflection();\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n";
pc.shaderChunks.rgbmPS = "vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n";
pc.shaderChunks.shadowCommonPS = "void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n";
pc.shaderChunks.shadowCoordPS = "void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
pc.shaderChunks.shadowCoordVS = "void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
pc.shaderChunks.shadowCoordPerspZbufferPS = "void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n";
pc.shaderChunks.shadowEVSMPS = "float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
pc.shaderChunks.shadowEVSMnPS = "float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
pc.shaderChunks.shadowStandardPS = "vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n// ----- Direct/Spot Sampling -----\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n        float sum = 0.0;\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n// ----- Point Sampling -----\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n    mat3 shadowKernel;\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n";
pc.shaderChunks.shadowStandardGL2PS = "float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n    float sum = 0.0;\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n    sum *= 1.0f / 144.0;\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    return sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n";
pc.shaderChunks.shadowStandardGL2VSPS = "float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n";
pc.shaderChunks.shadowStandardVSPS = "#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n";
pc.shaderChunks.shadowVSM8PS = "float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n";
pc.shaderChunks.shadowVSMVSPS = "float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n";
pc.shaderChunks.shadowVSM_commonPS = "float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n";
pc.shaderChunks.skinBatchConstVS = "attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";
pc.shaderChunks.skinBatchTexVS = "attribute float vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
pc.shaderChunks.skinConstVS = "attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nuniform vec3 skinPosOffset;\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";
pc.shaderChunks.skinTexVS = "attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nuniform vec3 skinPosOffset;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
pc.shaderChunks.skyboxPS = "varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n";
pc.shaderChunks.skyboxVS = "attribute vec3 aPosition;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nvarying vec3 vViewDir;\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n";
pc.shaderChunks.skyboxHDRPS = "varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";
pc.shaderChunks.skyboxPrefilteredCubePS = "varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";
pc.shaderChunks.specularAaNonePS = "float antiAliasGlossiness(float power) {\n    return power;\n}\n";
pc.shaderChunks.specularAaToksvigPS = "float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n";
pc.shaderChunks.specularAaToksvigFloatPS = "float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n";
pc.shaderChunks.specularConstPS = "uniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = material_specular;\n}\n";
pc.shaderChunks.specularTexPS = "uniform sampler2D texture_specularMap;\nvoid getSpecularity() {\n    dSpecularity = texture2D(texture_specularMap, $UV).$CH;\n}\n";
pc.shaderChunks.specularTexConstPS = "uniform sampler2D texture_specularMap;\nuniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = texture2D(texture_specularMap, $UV).$CH * material_specular;\n}\n";
pc.shaderChunks.specularVertPS = "void getSpecularity() {\n    dSpecularity = saturate(vVertexColor.$CH);\n}\n";
pc.shaderChunks.specularVertConstPS = "uniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = saturate(vVertexColor.$CH) * material_specular;\n}\n";
pc.shaderChunks.spotPS = "float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n";
pc.shaderChunks.startPS = "\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n";
pc.shaderChunks.startVS = "\nvoid main(void) {\n    gl_Position = getPosition();\n";
pc.shaderChunks.storeEVSMPS = "float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n";
pc.shaderChunks.tangentBinormalVS = "\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n";
pc.shaderChunks.tonemappingAcesPS = "uniform float exposure;\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n";
pc.shaderChunks.tonemappingAces2PS = "uniform float exposure;\n// ACES approximation by Stephen Hill\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n    return color;\n}\n";
pc.shaderChunks.tonemappingFilmicPS = "const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n    return color;\n}\n";
pc.shaderChunks.tonemappingHejlPS = "uniform float exposure;\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n";
pc.shaderChunks.tonemappingLinearPS = "uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n";
pc.shaderChunks.tonemappingNonePS = "vec3 toneMap(vec3 color) {\n    return color;\n}\n";
pc.shaderChunks.transformVS = "mat4 getModelMatrix() {\n    return matrix_model;\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformBatchSkinnedVS = "mat4 getModelMatrix() {\n    return getBoneMatrix(vertex_boneIndices);\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformDeclVS = "attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n";
pc.shaderChunks.transformInstancedVS = "mat4 getModelMatrix() {\n    return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformScreenSpaceVS = "mat4 getModelMatrix() {\n    return matrix_model;\n}\nvec4 getPosition() {\n    vec4 posW = vec4((getModelMatrix() * vec4(vertex_position, 1.0)).xy, 0.0, 1.0);\n    dPositionW = posW.xyz;\n    return posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformScreenSpaceBatchSkinnedVS = "mat4 getModelMatrix() {\n    return getBoneMatrix(vertex_boneIndices);\n}\nvec4 getPosition() {\n    vec4 posW = vec4((getModelMatrix() * vec4(vertex_position, 1.0)).xy, 0.0, 1.0);\n    dPositionW = posW.xyz;\n    return posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformSkinnedVS = "mat4 getModelMatrix() {\n    return getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n           getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n           getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n           getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w;\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    //posW.xyz /= posW.w;\n    posW.xyz += skinPosOffset;\n    dPositionW = posW.xyz;// / posW.w;\n    return matrix_viewProjection * posW;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.transformUv1VS = "mat4 getModelMatrix() {\n    return matrix_model;\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
pc.shaderChunks.uv0VS = "\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n";
pc.shaderChunks.uv1VS = "\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n";
pc.shaderChunks.viewDirPS = "void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n";
pc.shaderChunks.viewNormalVS = "\nuniform mat4 matrix_view;\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n";
pc.programlib = {gammaCode:function(value) {
  if (value === pc.GAMMA_SRGB || value === pc.GAMMA_SRGBFAST) {
    return pc.shaderChunks.gamma2_2PS;
  } else {
    if (value === pc.GAMMA_SRGBHDR) {
      return "#define HDR\n" + pc.shaderChunks.gamma2_2PS;
    }
  }
  return pc.shaderChunks.gamma1_0PS;
}, tonemapCode:function(value) {
  if (value === pc.TONEMAP_FILMIC) {
    return pc.shaderChunks.tonemappingFilmicPS;
  } else {
    if (value === pc.TONEMAP_LINEAR) {
      return pc.shaderChunks.tonemappingLinearPS;
    } else {
      if (value === pc.TONEMAP_HEJL) {
        return pc.shaderChunks.tonemappingHejlPS;
      } else {
        if (value === pc.TONEMAP_ACES) {
          return pc.shaderChunks.tonemappingAcesPS;
        } else {
          if (value === pc.TONEMAP_ACES2) {
            return pc.shaderChunks.tonemappingAces2PS;
          }
        }
      }
    }
  }
  return pc.shaderChunks.tonemappingNonePS;
}, fogCode:function(value) {
  if (value === "linear") {
    return pc.shaderChunks.fogLinearPS;
  } else {
    if (value === "exp") {
      return pc.shaderChunks.fogExpPS;
    } else {
      if (value === "exp2") {
        return pc.shaderChunks.fogExp2PS;
      } else {
        return pc.shaderChunks.fogNonePS;
      }
    }
  }
}, skinCode:function(device, chunks) {
  if (!chunks) {
    chunks = pc.shaderChunks;
  }
  if (device.supportsBoneTextures) {
    return chunks.skinTexVS;
  } else {
    return "#define BONE_LIMIT " + device.getBoneLimit() + "\n" + chunks.skinConstVS;
  }
}, precisionCode:function(device) {
  var pcode = "precision " + device.precision + " float;\n";
  if (device.webgl2) {
    pcode += "#ifdef GL2\nprecision " + device.precision + " sampler2DShadow;\n#endif\n";
  }
  return pcode;
}, versionCode:function(device) {
  return device.webgl2 ? "#version 300 es\n" : "";
}, dummyFragmentCode:function() {
  return "void main(void) {gl_FragColor = vec4(0.0);}";
}, begin:function() {
  return "void main(void)\n{\n";
}, end:function() {
  return "}\n";
}};
pc.programlib.basic = {generateKey:function(device, options) {
  var key = "basic";
  if (options.fog) {
    key += "_fog";
  }
  if (options.alphaTest) {
    key += "_atst";
  }
  if (options.vertexColors) {
    key += "_vcol";
  }
  if (options.diffuseMap) {
    key += "_diff";
  }
  return key;
}, createShaderDefinition:function(device, options) {
  var attributes = {vertex_position:pc.SEMANTIC_POSITION};
  if (options.skin) {
    attributes.vertex_boneWeights = pc.SEMANTIC_BLENDWEIGHT;
    attributes.vertex_boneIndices = pc.SEMANTIC_BLENDINDICES;
  }
  if (options.vertexColors) {
    attributes.vertex_color = pc.SEMANTIC_COLOR;
  }
  if (options.diffuseMap) {
    attributes.vertex_texCoord0 = pc.SEMANTIC_TEXCOORD0;
  }
  var chunks = pc.shaderChunks;
  var code = "";
  code += chunks.transformDeclVS;
  if (options.skin) {
    code += pc.programlib.skinCode(device);
    code += chunks.transformSkinnedVS;
  } else {
    code += chunks.transformVS;
  }
  if (options.vertexColors) {
    code += "attribute vec4 vertex_color;\n";
    code += "varying vec4 vColor;\n";
  }
  if (options.diffuseMap) {
    code += "attribute vec2 vertex_texCoord0;\n";
    code += "varying vec2 vUv0;\n";
  }
  code += pc.programlib.begin();
  code += "   gl_Position = getPosition();\n";
  if (options.vertexColors) {
    code += "    vColor = vertex_color;\n";
  }
  if (options.diffuseMap) {
    code += "    vUv0 = vertex_texCoord0;\n";
  }
  code += pc.programlib.end();
  var vshader = code;
  code = pc.programlib.precisionCode(device);
  if (options.vertexColors) {
    code += "varying vec4 vColor;\n";
  } else {
    code += "uniform vec4 uColor;\n";
  }
  if (options.diffuseMap) {
    code += "varying vec2 vUv0;\n";
    code += "uniform sampler2D texture_diffuseMap;\n";
  }
  if (options.fog) {
    code += pc.programlib.fogCode(options.fog);
  }
  if (options.alphatest) {
    code += chunks.alphaTestPS;
  }
  code += pc.programlib.begin();
  if (options.vertexColors) {
    code += "    gl_FragColor = vColor;\n";
  } else {
    code += "    gl_FragColor = uColor;\n";
  }
  if (options.diffuseMap) {
    code += "    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n";
  }
  if (options.alphatest) {
    code += "   alphaTest(gl_FragColor.a);\n";
  }
  if (options.fog) {
    code += "   glFragColor.rgb = addFog(gl_FragColor.rgb);\n";
  }
  code += pc.programlib.end();
  var fshader = code;
  return {attributes:attributes, vshader:vshader, fshader:fshader};
}};
pc.programlib.depth = {generateKey:function(device, options) {
  var key = "depth";
  if (options.skin) {
    key += "_skin";
  }
  if (options.opacityMap) {
    key += "_opam";
  }
  if (options.instancing) {
    key += "_inst";
  }
  return key;
}, createShaderDefinition:function(device, options) {
  var attributes = {vertex_position:pc.SEMANTIC_POSITION};
  if (options.skin) {
    attributes.vertex_boneWeights = pc.SEMANTIC_BLENDWEIGHT;
    attributes.vertex_boneIndices = pc.SEMANTIC_BLENDINDICES;
  }
  if (options.opacityMap) {
    attributes.vertex_texCoord0 = pc.SEMANTIC_TEXCOORD0;
  }
  var chunks = pc.shaderChunks;
  var code = "";
  code += chunks.transformDeclVS;
  if (options.skin) {
    code += pc.programlib.skinCode(device);
    code += chunks.transformSkinnedVS;
  } else {
    if (options.instancing) {
      attributes.instance_line1 = pc.SEMANTIC_TEXCOORD2;
      attributes.instance_line2 = pc.SEMANTIC_TEXCOORD3;
      attributes.instance_line3 = pc.SEMANTIC_TEXCOORD4;
      attributes.instance_line4 = pc.SEMANTIC_TEXCOORD5;
      code += chunks.instancingVS;
      code += chunks.transformInstancedVS;
    } else {
      if (options.screenSpace) {
        code += chunks.transformScreenSpaceVS;
      } else {
        code += chunks.transformVS;
      }
    }
  }
  if (options.opacityMap) {
    code += "attribute vec2 vertex_texCoord0;\n\n";
    code += "varying vec2 vUv0;\n\n";
  }
  code += "varying float vDepth;\n";
  code += "uniform mat4 matrix_view;\n";
  code += "uniform float camera_far;\n\n";
  code += pc.programlib.begin();
  code += "   gl_Position = getPosition();\n";
  if (options.opacityMap) {
    code += "    vUv0 = vertex_texCoord0;\n";
  }
  code += "    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z / camera_far;\n";
  code += pc.programlib.end();
  var vshader = code;
  code = pc.programlib.precisionCode(device);
  if (options.opacityMap) {
    code += "varying vec2 vUv0;\n\n";
    code += "uniform sampler2D texture_opacityMap;\n\n";
    code += chunks.alphaTestPS;
  }
  code += "varying float vDepth;\n\n";
  code += "vec4 packFloat(float depth)\n";
  code += "{\n";
  code += "    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";
  code += "    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";
  code += "    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";
  code += "    res -= res.xxyz * bit_mask;\n";
  code += "    return res;\n";
  code += "}\n\n";
  code += pc.programlib.begin();
  if (options.opacityMap) {
    code += "    alphaTest(texture2D(texture_opacityMap, vUv0)." + options.opacityChannel[0] + " );\n\n";
  }
  code += "float depth = vDepth;\n";
  code += "gl_FragColor = packFloat(depth);\n";
  code += pc.programlib.end();
  var fshader = code;
  return {attributes:attributes, vshader:vshader, fshader:fshader};
}};
pc.programlib.depthrgba = {hashCode:function(str) {
  var hash = 0;
  if (str.length === 0) {
    return hash;
  }
  for (var i = 0;i < str.length;i++) {
    var char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  return hash;
}, generateKey:function(device, options) {
  var key = "depthrgba";
  if (options.skin) {
    key += "_skin";
  }
  if (options.opacityMap) {
    key += "_opam" + options.opacityChannel;
  }
  if (options.type) {
    key += options.type;
  }
  if (options.instancing) {
    key += "_inst";
  }
  key += "_" + options.shadowType;
  if (options.chunks) {
    var str = "";
    for (var p in options.chunks) {
      if (options.chunks.hasOwnProperty(p)) {
        str += p + options.chunks[p];
      }
    }
    key += this.hashCode(str);
  }
  return key;
}, createShaderDefinition:function(device, options) {
  var attributes = {vertex_position:pc.SEMANTIC_POSITION};
  if (options.skin) {
    attributes.vertex_boneWeights = pc.SEMANTIC_BLENDWEIGHT;
    attributes.vertex_boneIndices = pc.SEMANTIC_BLENDINDICES;
  }
  if (options.opacityMap) {
    attributes.vertex_texCoord0 = pc.SEMANTIC_TEXCOORD0;
  }
  var chunks = pc.shaderChunks;
  if (options.chunks) {
    var customChunks = [];
    for (var p in chunks) {
      if (chunks.hasOwnProperty(p)) {
        if (!options.chunks[p]) {
          customChunks[p] = chunks[p];
        } else {
          customChunks[p] = options.chunks[p];
        }
      }
    }
    chunks = customChunks;
  }
  var code = "";
  code += chunks.transformDeclVS;
  if (options.chunks && options.attributes) {
    for (var p in options.attributes) {
      if (options.attributes.hasOwnProperty(p)) {
        attributes[p] = options.attributes[p];
      }
    }
  }
  var uvAdded = false;
  if (attributes.vertex_normal) {
    code += "attribute vec3 vertex_normal;\n";
  }
  if (attributes.vertex_tangent) {
    code += "attribute vec4 vertex_tangent;\n";
  }
  if (attributes.vertex_texCoord0) {
    uvAdded = true;
    code += "attribute vec2 vertex_texCoord0;\n";
  }
  if (attributes.vertex_texCoord1) {
    code += "attribute vec2 vertex_texCoord1;\n";
  }
  if (attributes.vertex_color) {
    code += "attribute vec4 vertex_color;\n";
  }
  if (!options.skin && attributes.vertex_boneWeights) {
    code += "attribute vec4 vertex_boneWeights;\n";
  }
  if (!options.skin && attributes.vertex_boneIndices) {
    code += "attribute vec4 vertex_boneIndices;\n";
  }
  if (options.skin) {
    code += pc.programlib.skinCode(device, chunks);
    code += chunks.transformSkinnedVS;
  } else {
    if (options.instancing) {
      attributes.instance_line1 = pc.SEMANTIC_TEXCOORD2;
      attributes.instance_line2 = pc.SEMANTIC_TEXCOORD3;
      attributes.instance_line3 = pc.SEMANTIC_TEXCOORD4;
      attributes.instance_line4 = pc.SEMANTIC_TEXCOORD5;
      code += chunks.instancingVS;
      code += chunks.transformInstancedVS;
    } else {
      if (options.screenSpace) {
        code += chunks.transformScreenSpaceVS;
      } else {
        code += chunks.transformVS;
      }
    }
  }
  if (options.opacityMap) {
    if (!uvAdded) {
      code += "attribute vec2 vertex_texCoord0;\n\n";
    }
    code += "varying vec2 vUv0;\n\n";
  }
  if (options.type !== pc.LIGHTTYPE_DIRECTIONAL) {
    code += "varying vec3 worldPos;\n\n";
  }
  code += pc.programlib.begin();
  code += "   gl_Position = getPosition();\n";
  if (options.opacityMap) {
    code += "    vUv0 = vertex_texCoord0;\n";
  }
  if (options.type !== pc.LIGHTTYPE_DIRECTIONAL) {
    code += "    worldPos = dPositionW;\n";
  }
  code += pc.programlib.end();
  var vshader = code;
  code = "";
  if (device.extStandardDerivatives && !device.webgl2) {
    code += "#extension GL_OES_standard_derivatives : enable\n\n";
  }
  code += pc.programlib.precisionCode(device);
  if (device.extStandardDerivatives && !device.webgl2) {
    code += "uniform vec2 polygonOffset;\n";
  }
  if (options.shadowType === pc.SHADOW_VSM32) {
    if (device.extTextureFloatHighPrecision) {
      code += "#define VSM_EXPONENT 15.0\n\n";
    } else {
      code += "#define VSM_EXPONENT 5.54\n\n";
    }
  } else {
    if (options.shadowType === pc.SHADOW_VSM16) {
      code += "#define VSM_EXPONENT 5.54\n\n";
    }
  }
  if (options.opacityMap) {
    code += "varying vec2 vUv0;\n";
    code += "uniform sampler2D texture_opacityMap;\n";
    code += chunks.alphaTestPS;
  }
  if (options.type !== pc.LIGHTTYPE_DIRECTIONAL) {
    code += "varying vec3 worldPos;\n";
    code += "uniform vec3 view_position;\n";
    code += "uniform float light_radius;\n";
  }
  if (options.shadowType === pc.SHADOW_PCF3 && (!device.webgl2 || options.type === pc.LIGHTTYPE_POINT)) {
    code += chunks.packDepthPS;
  } else {
    if (options.shadowType === pc.SHADOW_VSM8) {
      code += "vec2 encodeFloatRG( float v ) {\n";
      code += "    vec2 enc = vec2(1.0, 255.0) * v;\n";
      code += "    enc = fract(enc);\n";
      code += "    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n";
      code += "    return enc;\n";
      code += "}\n\n";
    }
  }
  code += pc.programlib.begin();
  if (options.opacityMap) {
    code += "    alphaTest( texture2D(texture_opacityMap, vUv0)." + options.opacityChannel + " );\n\n";
  }
  var isVsm = options.shadowType === pc.SHADOW_VSM8 || options.shadowType === pc.SHADOW_VSM16 || options.shadowType === pc.SHADOW_VSM32;
  if (options.type === pc.LIGHTTYPE_POINT || isVsm && options.type !== pc.LIGHTTYPE_DIRECTIONAL) {
    code += "   float depth = min(distance(view_position, worldPos) / light_radius, 0.99999);\n";
  } else {
    code += "   float depth = gl_FragCoord.z;\n";
  }
  if (options.shadowType === pc.SHADOW_PCF3 && (!device.webgl2 || options.type === pc.LIGHTTYPE_POINT)) {
    if (device.extStandardDerivatives && !device.webgl2) {
      code += "   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n";
      code += "   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n";
      code += "   gl_FragData[0] = packFloat(depth);\n";
    } else {
      code += "   gl_FragData[0] = packFloat(depth);\n";
    }
  } else {
    if (options.shadowType === pc.SHADOW_PCF3 || options.shadowType === pc.SHADOW_PCF5) {
      code += "   gl_FragData[0] = vec4(1.0);\n";
    } else {
      if (options.shadowType === pc.SHADOW_VSM8) {
        code += "   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n";
      } else {
        code += chunks.storeEVSMPS;
      }
    }
  }
  code += pc.programlib.end();
  var fshader = code;
  return {attributes:attributes, vshader:vshader, fshader:fshader};
}};
pc.programlib.particle = {generateKey:function(device, options) {
  var key = "particle";
  for (var prop in options) {
    if (options.hasOwnProperty(prop)) {
      key += options[prop];
    }
  }
  return key;
}, _animTex:function(options, chunk) {
  var vshader = "";
  vshader += options.animTexLoop ? chunk.particleAnimFrameLoopVS : chunk.particleAnimFrameClampVS;
  vshader += chunk.particleAnimTexVS;
  return vshader;
}, createShaderDefinition:function(device, options) {
  var chunk = pc.shaderChunks;
  var vshader = "";
  var fshader = pc.programlib.precisionCode(device) + "\n";
  if (options.animTex) {
    vshader += "\nuniform vec4 animTexParams;\n";
  }
  if (options.normal == 2) {
    vshader += "\nvarying mat3 ParticleMat;\n";
  }
  if (options.normal == 1) {
    vshader += "\nvarying vec3 Normal;\n";
  }
  if (options.soft) {
    vshader += "\nvarying float vDepth;\n";
  }
  if (!options.useCpu) {
    vshader += chunk.particle_initVS;
    vshader += options.pack8 ? chunk.particleInputRgba8PS : chunk.particleInputFloatPS;
    vshader += chunk.particleVS;
    if (options.localSpace) {
      vshader += chunk.particle_localShiftVS;
    }
    if (options.animTex) {
      vshader += this._animTex(options, chunk);
    }
    if (options.wrap) {
      vshader += chunk.particle_wrapVS;
    }
    if (options.alignToMotion) {
      vshader += chunk.particle_pointAlongVS;
    }
    vshader += options.mesh ? chunk.particle_meshVS : chunk.particle_billboardVS;
    if (options.normal == 1) {
      vshader += chunk.particle_normalVS;
    }
    if (options.normal == 2) {
      vshader += chunk.particle_TBNVS;
    }
    if (options.stretch > 0.0) {
      vshader += chunk.particle_stretchVS;
    }
    vshader += chunk.particle_endVS;
    if (options.soft > 0) {
      vshader += chunk.particle_softVS;
    }
  } else {
    vshader += chunk.particle_cpuVS;
    if (options.localSpace) {
      vshader += chunk.particle_localShiftVS;
    }
    if (options.animTex) {
      vshader += this._animTex(options, chunk);
    }
    if (options.alignToMotion) {
      vshader += chunk.particle_pointAlongVS;
    }
    vshader += options.mesh ? chunk.particle_meshVS : chunk.particle_billboardVS;
    if (options.normal == 1) {
      vshader += chunk.particle_normalVS;
    }
    if (options.normal == 2) {
      vshader += chunk.particle_TBNVS;
    }
    if (options.stretch > 0.0) {
      vshader += chunk.particle_stretchVS;
    }
    vshader += chunk.particle_cpu_endVS;
    if (options.soft > 0) {
      vshader += chunk.particle_softVS;
    }
  }
  vshader += "}\n";
  if (options.normal > 0) {
    if (options.normal == 1) {
      fshader += "\nvarying vec3 Normal;\n";
    } else {
      if (options.normal == 2) {
        fshader += "\nvarying mat3 ParticleMat;\n";
      }
    }
    fshader += "\nuniform vec3 lightCube[6];\n";
  }
  if (options.soft) {
    fshader += "\nvarying float vDepth;\n";
  }
  if (options.normal === 0 && options.fog === "none") {
    options.srgb = false;
  }
  fshader += pc.programlib.gammaCode(options.gamma);
  fshader += pc.programlib.tonemapCode(options.toneMap);
  if (options.fog === "linear") {
    fshader += chunk.fogLinearPS;
  } else {
    if (options.fog === "exp") {
      fshader += chunk.fogExpPS;
    } else {
      if (options.fog === "exp2") {
        fshader += chunk.fogExp2PS;
      } else {
        fshader += chunk.fogNonePS;
      }
    }
  }
  if (options.normal == 2) {
    fshader += "\nuniform sampler2D normalMap;\n";
  }
  if (options.soft > 0) {
    fshader += "\nuniform sampler2D uDepthMap;\n uniform vec4 uScreenSize;\n";
  }
  fshader += chunk.particlePS;
  if (options.soft > 0) {
    fshader += chunk.particle_softPS;
  }
  if (options.normal == 1) {
    fshader += "\nvec3 normal = Normal;\n";
  }
  if (options.normal == 2) {
    fshader += chunk.particle_normalMapPS;
  }
  if (options.normal > 0) {
    fshader += options.halflambert ? chunk.particle_halflambertPS : chunk.particle_lambertPS;
  }
  if (options.normal > 0) {
    fshader += chunk.particle_lightingPS;
  }
  if (options.blend == pc.BLEND_NORMAL) {
    fshader += chunk.particle_blendNormalPS;
  } else {
    if (options.blend == pc.BLEND_ADDITIVE) {
      fshader += chunk.particle_blendAddPS;
    } else {
      if (options.blend == pc.BLEND_MULTIPLICATIVE) {
        fshader += chunk.particle_blendMultiplyPS;
      }
    }
  }
  fshader += chunk.particle_endPS;
  var attributes = pc.shaderChunks.collectAttribs(vshader);
  return {attributes:attributes, vshader:vshader, fshader:fshader};
}};
pc.programlib.standard = {hashCode:function(str) {
  var hash = 0;
  if (str.length === 0) {
    return hash;
  }
  for (var i = 0;i < str.length;i++) {
    var char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  return hash;
}, generateKey:function(device, options) {
  var props = [];
  var key = "standard";
  var light;
  for (var prop in options) {
    if (options.hasOwnProperty(prop)) {
      if (prop === "chunks") {
        for (var p in options[prop]) {
          if (options[prop].hasOwnProperty(p)) {
            props.push(p + options.chunks[p]);
          }
        }
      } else {
        if (options[prop]) {
          props.push(prop);
        }
      }
    }
  }
  props.sort();
  for (prop in props) {
    if (props.hasOwnProperty(prop)) {
      key += props[prop] + options[props[prop]];
    }
  }
  if (options.lights) {
    for (var i = 0;i < options.lights.length;i++) {
      light = options.lights[i];
      key += light.key;
    }
  }
  return this.hashCode(key);
}, _correctChannel:function(p, chan) {
  if (pc._matTex2D[p] > 0) {
    if (pc._matTex2D[p] < chan.length) {
      return chan.substring(0, pc._matTex2D[p]);
    } else {
      if (pc._matTex2D[p] > chan.length) {
        var str = chan;
        var chr = str.charAt(str.length - 1);
        var addLen = pc._matTex2D[p] - str.length;
        for (var i = 0;i < addLen;i++) {
          str += chr;
        }
        return str;
      }
    }
    return chan;
  }
}, _setMapTransform:function(codes, name, id, uv) {
  codes[0] += "uniform vec4 texture_" + name + "MapTransform;\n";
  var checkId = id + uv * 100;
  if (!codes[3][checkId]) {
    codes[1] += "varying vec2 vUV" + uv + "_" + id + ";\n";
    codes[2] += "   vUV" + uv + "_" + id + " = uv" + uv + " * texture_" + name + "MapTransform.xy + texture_" + name + "MapTransform.zw;\n";
    codes[3][checkId] = true;
  }
  return codes;
}, _uvSource:function(id, uv) {
  return id === 0 ? "vUv" + uv : "vUV" + uv + "_" + id;
}, _addMap:function(p, options, chunks, uvOffset, subCode, format) {
  var cname, tname, uname;
  var mname = p + "Map";
  var tint;
  if (options[mname + "VertexColor"]) {
    cname = mname + "Channel";
    if (!subCode) {
      tint = options[p + "Tint"];
      if (tint) {
        if (tint === 1) {
          subCode = chunks[p + "VertConstFloatPS"];
        } else {
          subCode = chunks[p + "VertConstPS"];
        }
      } else {
        subCode = chunks[p + "VertPS"];
      }
    }
    return subCode.replace(/\$CH/g, options[cname]);
  } else {
    if (options[mname]) {
      tname = mname + "Transform";
      cname = mname + "Channel";
      uname = mname + "Uv";
      var uv = this._uvSource(options[tname], options[uname]) + uvOffset;
      if (!subCode) {
        tint = options[p + "Tint"];
        if (tint) {
          if (tint === 1) {
            subCode = chunks[p + "TexConstFloatPS"];
          } else {
            subCode = chunks[p + "TexConstPS"];
          }
        } else {
          subCode = chunks[p + "TexPS"];
        }
      }
      if (format !== undefined) {
        var fmt = format === 0 ? "texture2DSRGB" : format === 1 ? "texture2DRGBM" : "texture2D";
        subCode = subCode.replace(/\$texture2DSAMPLE/g, fmt);
      }
      return subCode.replace(/\$UV/g, uv).replace(/\$CH/g, options[cname]);
    } else {
      return chunks[p + "ConstPS"];
    }
  }
}, _nonPointShadowMapProjection:function(device, light, shadowCoordArgs) {
  if (!light._normalOffsetBias || light._isVsm) {
    if (light._type === pc.LIGHTTYPE_SPOT) {
      if (light._isPcf && (device.webgl2 || device.extStandardDerivatives)) {
        return "       getShadowCoordPerspZbuffer" + shadowCoordArgs;
      } else {
        return "       getShadowCoordPersp" + shadowCoordArgs;
      }
    } else {
      return "       getShadowCoordOrtho" + shadowCoordArgs;
    }
  } else {
    if (light._type === pc.LIGHTTYPE_SPOT) {
      if (light._isPcf && (device.webgl2 || device.extStandardDerivatives)) {
        return "       getShadowCoordPerspZbufferNormalOffset" + shadowCoordArgs;
      } else {
        return "       getShadowCoordPerspNormalOffset" + shadowCoordArgs;
      }
    } else {
      return "       getShadowCoordOrthoNormalOffset" + shadowCoordArgs;
    }
  }
}, _addVaryingIfNeeded:function(code, type, name) {
  return code.indexOf(name) >= 0 ? "varying " + type + " " + name + ";\n" : "";
}, createShaderDefinition:function(device, options) {
  var i, p;
  var lighting = options.lights.length > 0;
  if (options.dirLightMap) {
    lighting = true;
    options.useSpecular = true;
  }
  if (options.shadingModel === pc.SPECULAR_PHONG) {
    options.fresnelModel = 0;
    options.specularAA = false;
    options.prefilteredCubemap = false;
    options.dpAtlas = false;
    options.ambientSH = false;
  } else {
    options.fresnelModel = options.fresnelModel === 0 ? pc.FRESNEL_SCHLICK : options.fresnelModel;
  }
  var cubemapReflection = options.cubeMap || options.prefilteredCubemap && options.useSpecular;
  var reflections = options.sphereMap || cubemapReflection || options.dpAtlas;
  var useTangents = pc.precalculatedTangents;
  var useTexCubeLod = options.useTexCubeLod;
  if (options.cubeMap || options.prefilteredCubemap) {
    options.sphereMap = null;
  }
  if (options.dpAtlas) {
    options.sphereMap = options.cubeMap = options.prefilteredCubemap = cubemapReflection = null;
  }
  if (!options.useSpecular) {
    options.specularMap = options.glossMap = null;
  }
  var needsNormal = lighting || reflections || options.ambientSH || options.prefilteredCubemap || options.heightMap;
  this.options = options;
  var code = "";
  var codeBody = "";
  var varyings = "";
  var chunks = pc.shaderChunks;
  var lightType;
  var shadowCoordArgs;
  if (options.chunks) {
    var customChunks = [];
    for (p in chunks) {
      if (chunks.hasOwnProperty(p)) {
        if (!options.chunks[p]) {
          customChunks[p] = chunks[p];
        } else {
          customChunks[p] = options.chunks[p];
          if (!needsNormal) {
            customChunks[p] = customChunks[p].replace(/vertex_normal/g, "vec3(0)").replace(/vertex_tangent/g, "vec4(0)");
          }
        }
      }
    }
    chunks = customChunks;
  }
  code += chunks.baseVS;
  var mainShadowLight = -1;
  if (!options.noShadow && !options.twoSidedLighting) {
    for (i = 0;i < options.lights.length;i++) {
      lightType = options.lights[i]._type;
      if (options.lights[i].castShadows) {
        if (lightType === pc.LIGHTTYPE_DIRECTIONAL) {
          code += "uniform mat4 light" + i + "_shadowMatrixVS;\n";
          code += "uniform vec3 light" + i + "_shadowParamsVS;\n";
          code += "uniform vec3 light" + i + (lightType === pc.LIGHTTYPE_DIRECTIONAL ? "_directionVS" : "_positionVS") + ";\n";
          mainShadowLight = i;
          break;
        }
      }
    }
    if (mainShadowLight >= 0) {
      code += chunks.shadowCoordVS;
    }
  }
  var attributes = {vertex_position:pc.SEMANTIC_POSITION};
  codeBody += "   vPositionW    = getWorldPosition();\n";
  if (options.useInstancing) {
    attributes.instance_line1 = pc.SEMANTIC_TEXCOORD2;
    attributes.instance_line2 = pc.SEMANTIC_TEXCOORD3;
    attributes.instance_line3 = pc.SEMANTIC_TEXCOORD4;
    attributes.instance_line4 = pc.SEMANTIC_TEXCOORD5;
    code += chunks.instancingVS;
  }
  if (needsNormal) {
    attributes.vertex_normal = pc.SEMANTIC_NORMAL;
    codeBody += "   vNormalW    = dNormalW = getNormal();\n";
    if (options.sphereMap && device.fragmentUniformsCount <= 16) {
      code += chunks.viewNormalVS;
      codeBody += "   vNormalV    = getViewNormal();\n";
    }
    if ((options.heightMap || options.normalMap) && useTangents) {
      attributes.vertex_tangent = pc.SEMANTIC_TANGENT;
      code += chunks.tangentBinormalVS;
      codeBody += "   vTangentW   = getTangent();\n";
      codeBody += "   vBinormalW  = getBinormal();\n";
    }
    if (mainShadowLight >= 0) {
      lightType = options.lights[mainShadowLight]._type;
      if (lightType === pc.LIGHTTYPE_DIRECTIONAL) {
        codeBody += "   dLightDirNormW = light" + mainShadowLight + "_directionVS;\n";
      } else {
        codeBody += "   getLightDirPoint(light" + mainShadowLight + "_positionVS);\n";
      }
      shadowCoordArgs = "(light" + mainShadowLight + "_shadowMatrixVS, light" + mainShadowLight + "_shadowParamsVS);\n";
      codeBody += this._nonPointShadowMapProjection(device, options.lights[mainShadowLight], shadowCoordArgs);
    }
  }
  var useUv = [];
  var useUnmodifiedUv = [];
  var maxUvSets = 2;
  var cname, mname, tname, uname;
  for (p in pc._matTex2D) {
    mname = p + "Map";
    if (options[mname + "VertexColor"]) {
      cname = mname + "Channel";
      options[cname] = this._correctChannel(p, options[cname]);
    } else {
      if (options[mname]) {
        cname = mname + "Channel";
        tname = mname + "Transform";
        uname = mname + "Uv";
        options[uname] = Math.min(options[uname], maxUvSets - 1);
        options[cname] = this._correctChannel(p, options[cname]);
        var uvSet = options[uname];
        useUv[uvSet] = true;
        useUnmodifiedUv[uvSet] = useUnmodifiedUv[uvSet] || options[mname] && !options[tname];
      }
    }
  }
  if (options.forceUv1) {
    useUv[1] = true;
  }
  for (i = 0;i < maxUvSets;i++) {
    if (useUv[i]) {
      attributes["vertex_texCoord" + i] = pc["SEMANTIC_TEXCOORD" + i];
      code += chunks["uv" + i + "VS"];
      codeBody += "   vec2 uv" + i + " = getUv" + i + "();\n";
    }
    if (useUnmodifiedUv[i]) {
      codeBody += "   vUv" + i + " = uv" + i + ";\n";
    }
  }
  var codes = [code, varyings, codeBody, []];
  for (p in pc._matTex2D) {
    mname = p + "Map";
    if (options[mname]) {
      tname = mname + "Transform";
      if (options[tname]) {
        uname = mname + "Uv";
        this._setMapTransform(codes, p, options[tname], options[uname]);
      }
    }
  }
  code = codes[0];
  varyings = codes[1];
  codeBody = codes[2];
  if (options.vertexColors) {
    attributes.vertex_color = pc.SEMANTIC_COLOR;
    codeBody += "   vVertexColor = vertex_color;\n";
  }
  if (options.screenSpace) {
    code += chunks.transformScreenSpaceVS;
    if (needsNormal) {
      code += chunks.normalVS;
    }
  } else {
    if (options.skin) {
      attributes.vertex_boneWeights = pc.SEMANTIC_BLENDWEIGHT;
      attributes.vertex_boneIndices = pc.SEMANTIC_BLENDINDICES;
      code += pc.programlib.skinCode(device, chunks);
      code += chunks.transformSkinnedVS;
      if (needsNormal) {
        code += chunks.normalSkinnedVS;
      }
    } else {
      if (options.useInstancing) {
        code += chunks.transformInstancedVS;
        if (needsNormal) {
          code += chunks.normalInstancedVS;
        }
      } else {
        code += chunks.transformVS;
        if (needsNormal) {
          code += chunks.normalVS;
        }
      }
    }
  }
  code += "\n";
  code += chunks.startVS;
  code += codeBody;
  code += "}";
  var vshader = code;
  var oldVars = varyings;
  varyings = "";
  varyings += this._addVaryingIfNeeded(code, "vec4", "vMainShadowUv");
  varyings += this._addVaryingIfNeeded(code, "vec4", "vVertexColor");
  varyings += this._addVaryingIfNeeded(code, "vec3", "vPositionW");
  varyings += this._addVaryingIfNeeded(code, "vec3", "vNormalV");
  varyings += this._addVaryingIfNeeded(code, "vec3", "vNormalW");
  varyings += this._addVaryingIfNeeded(code, "vec3", "vTangentW");
  varyings += this._addVaryingIfNeeded(code, "vec3", "vBinormalW");
  varyings += this._addVaryingIfNeeded(code, "vec2", "vUv0");
  varyings += this._addVaryingIfNeeded(code, "vec2", "vUv1");
  varyings += oldVars;
  vshader = varyings + vshader;
  var startCode = "";
  if (device.webgl2) {
    startCode = pc.programlib.versionCode(device);
    if (chunks.extensionVS) {
      startCode += chunks.extensionVS + "\n";
    }
    vshader = startCode + chunks.gles3VS + vshader;
  } else {
    if (chunks.extensionVS) {
      startCode = chunks.extensionVS + "\n";
    }
    vshader = startCode + vshader;
  }
  if (options.forceFragmentPrecision && options.forceFragmentPrecision != "highp" && options.forceFragmentPrecision !== "mediump" && options.forceFragmentPrecision !== "lowp") {
    options.forceFragmentPrecision = null;
  }
  if (options.forceFragmentPrecision) {
    if (options.forceFragmentPrecision === "highp" && device.maxPrecision !== "highp") {
      options.forceFragmentPrecision = "mediump";
    }
    if (options.forceFragmentPrecision === "mediump" && device.maxPrecision === "lowp") {
      options.forceFragmentPrecision = "lowp";
    }
  }
  var fshader;
  code = "";
  if (device.webgl2) {
    code += pc.programlib.versionCode(device);
  }
  if (device.extStandardDerivatives && !device.webgl2) {
    code += "#extension GL_OES_standard_derivatives : enable\n\n";
  }
  if (chunks.extensionPS) {
    code += chunks.extensionPS + "\n";
  }
  if (device.webgl2) {
    code += chunks.gles3PS;
  }
  code += options.forceFragmentPrecision ? "precision " + options.forceFragmentPrecision + " float;\n\n" : pc.programlib.precisionCode(device);
  if (options.customFragmentShader) {
    fshader = code + options.customFragmentShader;
    return {attributes:attributes, vshader:vshader, fshader:fshader, tag:pc.SHADERTAG_MATERIAL};
  }
  code += varyings;
  code += chunks.basePS;
  var codeBegin = code;
  code = "";
  var numShadowLights = 0;
  var shadowTypeUsed = [];
  var useVsm = false;
  var usePerspZbufferShadow = false;
  var light;
  for (i = 0;i < options.lights.length;i++) {
    light = options.lights[i];
    lightType = light._type;
    code += "uniform vec3 light" + i + "_color;\n";
    if (lightType === pc.LIGHTTYPE_DIRECTIONAL) {
      code += "uniform vec3 light" + i + "_direction;\n";
    } else {
      code += "uniform vec3 light" + i + "_position;\n";
      code += "uniform float light" + i + "_radius;\n";
      if (lightType === pc.LIGHTTYPE_SPOT) {
        code += "uniform vec3 light" + i + "_direction;\n";
        code += "uniform float light" + i + "_innerConeAngle;\n";
        code += "uniform float light" + i + "_outerConeAngle;\n";
      }
    }
    if (light.castShadows && !options.noShadow) {
      code += "uniform mat4 light" + i + "_shadowMatrix;\n";
      if (lightType !== pc.LIGHTTYPE_DIRECTIONAL) {
        code += "uniform vec4 light" + i + "_shadowParams;\n";
      } else {
        code += "uniform vec3 light" + i + "_shadowParams;\n";
      }
      if (lightType === pc.LIGHTTYPE_POINT) {
        code += "uniform samplerCube light" + i + "_shadowMap;\n";
      } else {
        if (light._isPcf && device.webgl2) {
          code += "uniform sampler2DShadow light" + i + "_shadowMap;\n";
        } else {
          code += "uniform sampler2D light" + i + "_shadowMap;\n";
        }
      }
      numShadowLights++;
      shadowTypeUsed[light._shadowType] = true;
      if (light._isVsm) {
        useVsm = true;
      }
      if (light._isPcf && (device.webgl2 || device.extStandardDerivatives) && lightType === pc.LIGHTTYPE_SPOT) {
        usePerspZbufferShadow = true;
      }
    }
    if (light._cookie) {
      if (light._cookie._cubemap) {
        if (lightType === pc.LIGHTTYPE_POINT) {
          code += "uniform samplerCube light" + i + "_cookie;\n";
          code += "uniform float light" + i + "_cookieIntensity;\n";
          if (!light.castShadows || options.noShadow) {
            code += "uniform mat4 light" + i + "_shadowMatrix;\n";
          }
        }
      } else {
        if (lightType === pc.LIGHTTYPE_SPOT) {
          code += "uniform sampler2D light" + i + "_cookie;\n";
          code += "uniform float light" + i + "_cookieIntensity;\n";
          if (!light.castShadows || options.noShadow) {
            code += "uniform mat4 light" + i + "_shadowMatrix;\n";
          }
          if (light._cookieTransform) {
            code += "uniform vec4 light" + i + "_cookieMatrix;\n";
            code += "uniform vec2 light" + i + "_cookieOffset;\n";
          }
        }
      }
    }
  }
  code += "\n";
  var uvOffset = options.heightMap ? " + dUvOffset" : "";
  var tbn = options.fastTbn ? chunks.TBNfastPS : chunks.TBNPS;
  if (needsNormal) {
    if (options.normalMap && useTangents) {
      code += options.packedNormal ? chunks.normalXYPS : chunks.normalXYZPS;
      var uv = this._uvSource(options.normalMapTransform, options.normalMapUv) + uvOffset;
      if (options.needsNormalFloat) {
        code += (options.fastTbn ? chunks.normalMapFloatTBNfastPS : chunks.normalMapFloatPS).replace(/\$UV/g, uv);
      } else {
        code += chunks.normalMapPS.replace(/\$UV/g, uv);
      }
      code += tbn;
    } else {
      code += chunks.normalVertexPS;
    }
  }
  code += pc.programlib.gammaCode(options.gamma);
  code += pc.programlib.tonemapCode(options.toneMap);
  code += pc.programlib.fogCode(options.fog);
  if (options.useRgbm) {
    code += chunks.rgbmPS;
  }
  if (cubemapReflection || options.prefilteredCubemap) {
    code += options.fixSeams ? chunks.fixCubemapSeamsStretchPS : chunks.fixCubemapSeamsNonePS;
  }
  if (needsNormal) {
    code += options.cubeMapProjection > 0 ? chunks.cubeMapProjectBoxPS : chunks.cubeMapProjectNonePS;
    code += options.skyboxIntensity ? chunks.envMultiplyPS : chunks.envConstPS;
  }
  code += this._addMap("diffuse", options, chunks, uvOffset);
  if (options.blendType !== pc.BLEND_NONE || options.alphaTest || options.alphaToCoverage) {
    code += this._addMap("opacity", options, chunks, uvOffset);
  }
  code += this._addMap("emissive", options, chunks, uvOffset, null, options.emissiveFormat);
  if (options.useSpecular && (lighting || reflections)) {
    if (options.specularAA && options.normalMap) {
      if (options.needsNormalFloat && needsNormal) {
        code += chunks.specularAaToksvigFloatPS;
      } else {
        code += chunks.specularAaToksvigPS;
      }
    } else {
      code += chunks.specularAaNonePS;
    }
    if (options.useMetalness) {
      code += chunks.metalnessPS;
    }
    code += this._addMap(options.useMetalness ? "metalness" : "specular", options, chunks, uvOffset);
    code += this._addMap("gloss", options, chunks, uvOffset);
    if (options.fresnelModel > 0) {
      if (options.fresnelModel === pc.FRESNEL_SIMPLE) {
        code += chunks.fresnelSimplePS;
      } else {
        if (options.fresnelModel === pc.FRESNEL_SCHLICK) {
          code += chunks.fresnelSchlickPS;
        } else {
          if (options.fresnelModel === pc.FRESNEL_COMPLEX) {
            code += chunks.fresnelComplexPS;
          }
        }
      }
    }
  }
  if (options.heightMap) {
    if (!options.normalMap) {
      code += tbn;
    }
    code += this._addMap("height", options, chunks, "", chunks.parallaxPS);
  }
  var useAo = options.aoMap || options.aoMapVertexColor;
  if (useAo) {
    code += this._addMap("ao", options, chunks, uvOffset, options.aoMapVertexColor ? chunks.aoVertPS : chunks.aoTexPS);
    if (options.occludeSpecular) {
      if (options.occludeSpecular === pc.SPECOCC_AO) {
        code += options.occludeSpecularFloat ? chunks.aoSpecOccSimplePS : chunks.aoSpecOccConstSimplePS;
      } else {
        code += options.occludeSpecularFloat ? chunks.aoSpecOccPS : chunks.aoSpecOccConstPS;
      }
    }
  }
  var reflectionDecode = options.rgbmReflection ? "decodeRGBM" : options.hdrReflection ? "" : "gammaCorrectInput";
  if (cubemapReflection || options.prefilteredCubemap) {
    if (options.prefilteredCubemap) {
      if (useTexCubeLod) {
        code += chunks.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g, reflectionDecode);
      } else {
        code += chunks.reflectionPrefilteredCubePS.replace(/\$DECODE/g, reflectionDecode);
      }
    } else {
      code += chunks.reflectionCubePS.replace(/\$textureCubeSAMPLE/g, options.rgbmReflection ? "textureCubeRGBM" : options.hdrReflection ? "textureCube" : "textureCubeSRGB");
    }
  }
  if (options.sphereMap) {
    var scode = device.fragmentUniformsCount > 16 ? chunks.reflectionSpherePS : chunks.reflectionSphereLowPS;
    scode = scode.replace(/\$texture2DSAMPLE/g, options.rgbmReflection ? "texture2DRGBM" : options.hdrReflection ? "texture2D" : "texture2DSRGB");
    code += scode;
  }
  if (options.dpAtlas) {
    code += chunks.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g, options.rgbmReflection ? "texture2DRGBM" : options.hdrReflection ? "texture2D" : "texture2DSRGB");
  }
  if ((cubemapReflection || options.sphereMap || options.dpAtlas) && options.refraction) {
    code += chunks.refractionPS;
  }
  if (numShadowLights > 0) {
    if (shadowTypeUsed[pc.SHADOW_PCF3]) {
      code += chunks.shadowStandardPS;
    }
    if (shadowTypeUsed[pc.SHADOW_PCF5]) {
      code += chunks.shadowStandardGL2PS;
    }
    if (useVsm) {
      code += chunks.shadowVSM_commonPS;
      if (shadowTypeUsed[pc.SHADOW_VSM8]) {
        code += chunks.shadowVSM8PS;
      }
      if (shadowTypeUsed[pc.SHADOW_VSM16]) {
        code += device.extTextureHalfFloatLinear ? chunks.shadowEVSMPS.replace(/\$/g, "16") : chunks.shadowEVSMnPS.replace(/\$/g, "16");
      }
      if (shadowTypeUsed[pc.SHADOW_VSM32]) {
        code += device.extTextureFloatLinear ? chunks.shadowEVSMPS.replace(/\$/g, "32") : chunks.shadowEVSMnPS.replace(/\$/g, "32");
      }
    }
    if (device.webgl2 || device.extStandardDerivatives) {
    } else {
      code += chunks.biasConstPS;
    }
    code += chunks.shadowCoordPS + chunks.shadowCommonPS;
    if (usePerspZbufferShadow) {
      code += chunks.shadowCoordPerspZbufferPS;
    }
    if (mainShadowLight >= 0) {
      if (shadowTypeUsed[pc.SHADOW_PCF3]) {
        code += chunks.shadowStandardVSPS;
      }
      if (shadowTypeUsed[pc.SHADOW_PCF5]) {
        code += chunks.shadowStandardGL2VSPS;
      }
      if (useVsm) {
        if (shadowTypeUsed[pc.SHADOW_VSM8]) {
          code += chunks.shadowVSMVSPS.replace(/\$VSM/g, "VSM8").replace(/\$/g, "8");
        }
        if (shadowTypeUsed[pc.SHADOW_VSM16]) {
          code += chunks.shadowVSMVSPS.replace(/\$VSM/g, "VSM16").replace(/\$/g, "16");
        }
        if (shadowTypeUsed[pc.SHADOW_VSM32]) {
          code += chunks.shadowVSMVSPS.replace(/\$VSM/g, "VSM32").replace(/\$/g, "32");
        }
      }
    }
  }
  if (lighting) {
    code += chunks.lightDiffuseLambertPS;
  }
  var useOldAmbient = false;
  if (options.useSpecular) {
    if (lighting) {
      code += options.shadingModel === pc.SPECULAR_PHONG ? chunks.lightSpecularPhongPS : chunks.lightSpecularBlinnPS;
    }
    if (options.sphereMap || cubemapReflection || options.dpAtlas || options.fresnelModel > 0) {
      if (options.fresnelModel > 0) {
        if (options.conserveEnergy) {
          code += chunks.combineDiffuseSpecularPS;
        } else {
          code += chunks.combineDiffuseSpecularNoConservePS;
        }
      } else {
        code += chunks.combineDiffuseSpecularOldPS;
      }
    } else {
      if (options.diffuseMap) {
        code += chunks.combineDiffuseSpecularNoReflPS;
      } else {
        code += chunks.combineDiffuseSpecularNoReflSeparateAmbientPS;
        useOldAmbient = true;
      }
    }
  } else {
    code += chunks.combineDiffusePS;
  }
  var addAmbient = true;
  if (options.lightMap || options.lightMapVertexColor) {
    code += this._addMap("light", options, chunks, uvOffset, options.lightMapVertexColor ? chunks.lightmapSingleVertPS : options.dirLightMap ? chunks.lightmapDirPS : chunks.lightmapSinglePS, options.lightMapFormat);
    addAmbient = options.lightMapWithoutAmbient;
  }
  if (addAmbient) {
    if (options.ambientSH) {
      code += chunks.ambientSHPS;
    } else {
      if (options.prefilteredCubemap) {
        if (useTexCubeLod) {
          code += chunks.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g, reflectionDecode);
        } else {
          code += chunks.ambientPrefilteredCubePS.replace(/\$DECODE/g, reflectionDecode);
        }
      } else {
        code += chunks.ambientConstantPS;
      }
    }
  }
  if (options.modulateAmbient && !useOldAmbient) {
    code += "uniform vec3 material_ambient;\n";
  }
  if (options.alphaTest) {
    code += chunks.alphaTestPS;
  }
  if (options.msdf) {
    code += chunks.msdfPS;
  }
  if (needsNormal) {
    code += chunks.viewDirPS;
    if (options.useSpecular) {
      code += chunks.reflDirPS;
    }
  }
  var hasPointLights = false;
  var usesLinearFalloff = false;
  var usesInvSquaredFalloff = false;
  var usesSpot = false;
  var usesCookie = false;
  var usesCookieNow;
  code += chunks.startPS;
  if (needsNormal) {
    if (options.twoSidedLighting) {
      code += "   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n";
    } else {
      code += "   dVertexNormalW = vNormalW;\n";
    }
    if (options.heightMap || options.normalMap) {
      if (options.twoSidedLighting) {
        code += "   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n";
        code += "   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n";
      } else {
        code += "   dTangentW = vTangentW;\n";
        code += "   dBinormalW = vBinormalW;\n";
      }
    }
  }
  var opacityParallax = false;
  if (options.blendType === pc.BLEND_NONE && !options.alphaTest && !options.alphaToCoverage) {
    code += "   dAlpha = 1.0;\n";
  } else {
    if (options.heightMap && options.opacityMap) {
      opacityParallax = true;
    } else {
      code += "   getOpacity();\n";
      if (options.alphaTest) {
        code += "   alphaTest(dAlpha);\n";
      }
    }
  }
  if (needsNormal) {
    code += "   getViewDir();\n";
    if (options.heightMap || options.normalMap) {
      code += "   getTBN();\n";
    }
    if (options.heightMap) {
      code += "   getParallax();\n";
    }
    if (opacityParallax) {
      code += "   getOpacity();\n";
      if (options.alphaTest) {
        code += "   alphaTest(dAlpha);\n";
      }
    }
    code += "   getNormal();\n";
    if (options.useSpecular) {
      code += "   getReflDir();\n";
    }
  }
  code += "   getAlbedo();\n";
  if (lighting && options.useSpecular || reflections) {
    code += "   getSpecularity();\n";
    code += "   getGlossiness();\n";
    if (options.fresnelModel > 0) {
      code += "   getFresnel();\n";
    }
  }
  if (addAmbient) {
    code += "   addAmbient();\n";
  }
  if (options.modulateAmbient && !useOldAmbient) {
    code += "   dDiffuseLight *= material_ambient;\n";
  }
  if (useAo && !options.occludeDirect) {
    code += "    applyAO();\n";
  }
  if (options.lightMap || options.lightMapVertexColor) {
    code += "   addLightMap();\n";
  }
  if (lighting || reflections) {
    if (cubemapReflection || options.sphereMap || options.dpAtlas) {
      code += "   addReflection();\n";
    }
    if (options.dirLightMap) {
      code += "   addDirLightMap();\n";
    }
    for (i = 0;i < options.lights.length;i++) {
      light = options.lights[i];
      lightType = light._type;
      usesCookieNow = false;
      if (lightType === pc.LIGHTTYPE_DIRECTIONAL) {
        code += "   dLightDirNormW = light" + i + "_direction;\n";
        code += "   dAtten = 1.0;\n";
      } else {
        if (light._cookie) {
          if (lightType === pc.LIGHTTYPE_SPOT && !light._cookie._cubemap) {
            usesCookie = true;
            usesCookieNow = true;
          } else {
            if (lightType === pc.LIGHTTYPE_POINT && light._cookie._cubemap) {
              usesCookie = true;
              usesCookieNow = true;
            }
          }
        }
        code += "   getLightDirPoint(light" + i + "_position);\n";
        hasPointLights = true;
        if (usesCookieNow) {
          if (lightType === pc.LIGHTTYPE_SPOT) {
            code += "   dAtten3 = getCookie2D" + (light._cookieFalloff ? "" : "Clip") + (light._cookieTransform ? "Xform" : "") + "(light" + i + "_cookie, light" + i + "_shadowMatrix, light" + i + "_cookieIntensity" + (light._cookieTransform ? ", light" + i + "_cookieMatrix, light" + i + "_cookieOffset" : "") + ")." + light._cookieChannel + ";\n";
          } else {
            code += "   dAtten3 = getCookieCube(light" + i + "_cookie, light" + i + "_shadowMatrix, light" + i + "_cookieIntensity)." + light._cookieChannel + ";\n";
          }
        }
        if (light._falloffMode === pc.LIGHTFALLOFF_LINEAR) {
          code += "   dAtten = getFalloffLinear(light" + i + "_radius);\n";
          usesLinearFalloff = true;
        } else {
          code += "   dAtten = getFalloffInvSquared(light" + i + "_radius);\n";
          usesInvSquaredFalloff = true;
        }
        code += "   if (dAtten > 0.00001) {\n";
        if (lightType === pc.LIGHTTYPE_SPOT) {
          if (!(usesCookieNow && !light._cookieFalloff)) {
            code += "       dAtten *= getSpotEffect(light" + i + "_direction, light" + i + "_innerConeAngle, light" + i + "_outerConeAngle);\n";
            usesSpot = true;
          }
        }
      }
      code += "       dAtten *= getLightDiffuse();\n";
      if (light.castShadows && !options.noShadow) {
        var shadowReadMode = null;
        var evsmExp;
        if (light._shadowType === pc.SHADOW_VSM8) {
          shadowReadMode = "VSM8";
          evsmExp = "0.0";
        } else {
          if (light._shadowType === pc.SHADOW_VSM16) {
            shadowReadMode = "VSM16";
            evsmExp = "5.54";
          } else {
            if (light._shadowType === pc.SHADOW_VSM32) {
              shadowReadMode = "VSM32";
              if (device.extTextureFloatHighPrecision) {
                evsmExp = "15.0";
              } else {
                evsmExp = "5.54";
              }
            } else {
              if (light._shadowType === pc.SHADOW_PCF5) {
                shadowReadMode = "PCF5x5";
              } else {
                shadowReadMode = "PCF3x3";
              }
            }
          }
        }
        if (shadowReadMode !== null) {
          if (lightType === pc.LIGHTTYPE_POINT) {
            shadowCoordArgs = "(light" + i + "_shadowMap, light" + i + "_shadowParams);\n";
            if (light._normalOffsetBias) {
              code += "       normalOffsetPointShadow(light" + i + "_shadowParams);\n";
            }
            code += "       dAtten *= getShadowPoint" + shadowReadMode + shadowCoordArgs;
          } else {
            if (mainShadowLight === i) {
              shadowReadMode += "VS";
            } else {
              shadowCoordArgs = "(light" + i + "_shadowMatrix, light" + i + "_shadowParams);\n";
              code += this._nonPointShadowMapProjection(device, options.lights[i], shadowCoordArgs);
            }
            if (lightType === pc.LIGHTTYPE_SPOT) {
              shadowReadMode = "Spot" + shadowReadMode;
            }
            code += "       dAtten *= getShadow" + shadowReadMode + "(light" + i + "_shadowMap, light" + i + "_shadowParams" + (light._isVsm ? ", " + evsmExp : "") + ");\n";
          }
        }
      }
      code += "       dDiffuseLight += dAtten * light" + i + "_color" + (usesCookieNow ? " * dAtten3" : "") + ";\n";
      if (options.useSpecular) {
        code += "       dAtten *= getLightSpecular();\n";
        code += "       dSpecularLight += dAtten * light" + i + "_color" + (usesCookieNow ? " * dAtten3" : "") + ";\n";
      }
      if (lightType !== pc.LIGHTTYPE_DIRECTIONAL) {
        code += "   }\n";
      }
      code += "\n";
    }
    if ((cubemapReflection || options.sphereMap || options.dpAtlas) && options.refraction) {
      code += "   addRefraction();\n";
    }
  }
  code += "\n";
  if (useAo) {
    if (options.occludeDirect) {
      code += "    applyAO();\n";
    }
    if (options.occludeSpecular) {
      code += "    occludeSpecular();\n";
    }
  }
  code += chunks.endPS;
  if (options.blendType === pc.BLEND_NORMAL || options.blendType === pc.BLEND_ADDITIVEALPHA || options.alphaToCoverage) {
    code += chunks.outputAlphaPS;
  } else {
    if (options.blendType === pc.BLEND_PREMULTIPLIED) {
      code += chunks.outputAlphaPremulPS;
    } else {
      code += chunks.outputAlphaOpaquePS;
    }
  }
  if (options.msdf) {
    code += "   gl_FragColor = applyMsdf(gl_FragColor);\n";
  }
  code += "\n";
  code += pc.programlib.end();
  if (hasPointLights) {
    code = chunks.lightDirPointPS + code;
  }
  if (usesLinearFalloff) {
    code = chunks.falloffLinearPS + code;
  }
  if (usesInvSquaredFalloff) {
    code = chunks.falloffInvSquaredPS + code;
  }
  if (usesSpot) {
    code = chunks.spotPS + code;
  }
  if (usesCookie) {
    code = chunks.cookiePS + code;
  }
  var structCode = "";
  if (code.includes("dReflection")) {
    structCode += "vec4 dReflection;\n";
  }
  if (code.includes("dTBN")) {
    structCode += "mat3 dTBN;\n";
  }
  if (code.includes("dAlbedo")) {
    structCode += "vec3 dAlbedo;\n";
  }
  if (code.includes("dEmission")) {
    structCode += "vec3 dEmission;\n";
  }
  if (code.includes("dNormalW")) {
    structCode += "vec3 dNormalW;\n";
  }
  if (code.includes("dVertexNormalW")) {
    structCode += "vec3 dVertexNormalW;\n";
  }
  if (code.includes("dTangentW")) {
    structCode += "vec3 dTangentW;\n";
  }
  if (code.includes("dBinormalW")) {
    structCode += "vec3 dBinormalW;\n";
  }
  if (code.includes("dViewDirW")) {
    structCode += "vec3 dViewDirW;\n";
  }
  if (code.includes("dReflDirW")) {
    structCode += "vec3 dReflDirW;\n";
  }
  if (code.includes("dDiffuseLight")) {
    structCode += "vec3 dDiffuseLight;\n";
  }
  if (code.includes("dSpecularLight")) {
    structCode += "vec3 dSpecularLight;\n";
  }
  if (code.includes("dLightDirNormW")) {
    structCode += "vec3 dLightDirNormW;\n";
  }
  if (code.includes("dLightDirW")) {
    structCode += "vec3 dLightDirW;\n";
  }
  if (code.includes("dLightPosW")) {
    structCode += "vec3 dLightPosW;\n";
  }
  if (code.includes("dShadowCoord")) {
    structCode += "vec3 dShadowCoord;\n";
  }
  if (code.includes("dNormalMap")) {
    structCode += "vec3 dNormalMap;\n";
  }
  if (code.includes("dSpecularity")) {
    structCode += "vec3 dSpecularity;\n";
  }
  if (code.includes("dUvOffset")) {
    structCode += "vec2 dUvOffset;\n";
  }
  if (code.includes("dGlossiness")) {
    structCode += "float dGlossiness;\n";
  }
  if (code.includes("dAlpha")) {
    structCode += "float dAlpha;\n";
  }
  if (code.includes("dAtten")) {
    structCode += "float dAtten;\n";
  }
  if (code.includes("dAtten3")) {
    structCode += "vec3 dAtten3;\n";
  }
  if (code.includes("dAo")) {
    structCode += "float dAo;\n";
  }
  if (code.includes("dMsdf")) {
    structCode += "vec4 dMsdf;\n";
  }
  code = codeBegin + structCode + code;
  fshader = code;
  return {attributes:attributes, vshader:vshader, fshader:fshader, tag:pc.SHADERTAG_MATERIAL};
}};
pc.programlib.pick = {generateKey:function(device, options) {
  var key = "pick";
  if (options.skin) {
    key += "_skin";
  }
  if (options.opacityMap) {
    key += "_opam" + options.opacityChannel;
  }
  if (options.screenSpace) {
    key += "_screenspace";
  }
  return key;
}, createShaderDefinition:function(device, options) {
  var attributes = {vertex_position:pc.SEMANTIC_POSITION};
  if (options.skin) {
    attributes.vertex_boneWeights = pc.SEMANTIC_BLENDWEIGHT;
    attributes.vertex_boneIndices = pc.SEMANTIC_BLENDINDICES;
  }
  if (options.opacityMap) {
    attributes.vertex_texCoord0 = pc.SEMANTIC_TEXCOORD0;
  }
  var chunks = pc.shaderChunks;
  var code = "";
  code += chunks.transformDeclVS;
  if (options.skin) {
    code += pc.programlib.skinCode(device);
    code += chunks.transformSkinnedVS;
  } else {
    if (options.screenSpace) {
      code += chunks.transformScreenSpaceVS;
    } else {
      code += chunks.transformVS;
    }
  }
  if (options.opacityMap) {
    code += "attribute vec2 vertex_texCoord0;\n\n";
    code += "varying vec2 vUv0;\n\n";
  }
  code += pc.programlib.begin();
  code += "   gl_Position = getPosition();\n";
  if (options.opacityMap) {
    code += "    vUv0 = vertex_texCoord0;\n";
  }
  code += pc.programlib.end();
  var vshader = code;
  code = pc.programlib.precisionCode(device);
  code += "uniform vec4 uColor;";
  if (options.opacityMap) {
    code += "varying vec2 vUv0;\n\n";
    code += "uniform sampler2D texture_opacityMap;\n\n";
    code += chunks.alphaTestPS;
  }
  code += pc.programlib.begin();
  if (options.opacityMap) {
    code += "    alphaTest( texture2D(texture_opacityMap, vUv0)." + options.opacityChannel[0] + " );\n\n";
  }
  code += "    gl_FragColor = uColor;\n";
  code += pc.programlib.end();
  var fshader = code;
  return {attributes:attributes, vshader:vshader, fshader:fshader};
}};
pc.programlib.skybox = {generateKey:function(device, options) {
  var key = "skybox" + options.rgbm + " " + options.hdr + " " + options.fixSeams + "" + options.toneMapping + "" + options.gamma + "" + options.useIntensity + "" + options.mip;
  return key;
}, createShaderDefinition:function(device, options) {
  var chunks = pc.shaderChunks;
  var mip2size = [128, 64, 16, 8, 4, 2];
  return {attributes:{aPosition:pc.SEMANTIC_POSITION}, vshader:chunks.skyboxVS, fshader:pc.programlib.precisionCode(device) + (options.mip ? chunks.fixCubemapSeamsStretchPS : chunks.fixCubemapSeamsNonePS) + (options.useIntensity ? chunks.envMultiplyPS : chunks.envConstPS) + pc.programlib.gammaCode(options.gamma) + pc.programlib.tonemapCode(options.toneMapping) + chunks.rgbmPS + chunks.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g, options.rgbm ? "textureCubeRGBM" : options.hdr ? "textureCube" : "textureCubeSRGB").replace(/\$FIXCONST/g,
  1.0 - 1.0 / mip2size[options.mip] + "")};
}};
pc.extend(pc, function() {
  var primitive = {type:pc.PRIMITIVE_TRISTRIP, base:0, count:4, indexed:false};
  var PostEffect = function(graphicsDevice) {
    this.device = graphicsDevice;
    this.shader = null;
    this.depthMap = null;
    this.vertexBuffer = pc.createFullscreenQuad(graphicsDevice);
    this.needsDepthBuffer = false;
  };
  PostEffect.prototype = {render:function(inputTarget, outputTarget, rect) {
  }};
  function createFullscreenQuad(device) {
    var vertexFormat = new pc.VertexFormat(device, [{semantic:pc.SEMANTIC_POSITION, components:2, type:pc.TYPE_FLOAT32}]);
    var vertexBuffer = new pc.VertexBuffer(device, vertexFormat, 4);
    var iterator = new pc.VertexIterator(vertexBuffer);
    iterator.element[pc.SEMANTIC_POSITION].set(-1.0, -1.0);
    iterator.next();
    iterator.element[pc.SEMANTIC_POSITION].set(1.0, -1.0);
    iterator.next();
    iterator.element[pc.SEMANTIC_POSITION].set(-1.0, 1.0);
    iterator.next();
    iterator.element[pc.SEMANTIC_POSITION].set(1.0, 1.0);
    iterator.end();
    return vertexBuffer;
  }
  function drawFullscreenQuad(device, target, vertexBuffer, shader, rect) {
    device.setRenderTarget(target);
    device.updateBegin();
    var w = target !== null ? target.width : device.width;
    var h = target !== null ? target.height : device.height;
    var x = 0;
    var y = 0;
    if (rect) {
      x = rect.x * w;
      y = rect.y * h;
      w *= rect.z;
      h *= rect.w;
    }
    device.setViewport(x, y, w, h);
    device.setScissor(x, y, w, h);
    var oldBlending = device.getBlending();
    var oldDepthTest = device.getDepthTest();
    var oldDepthWrite = device.getDepthWrite();
    var oldCullMode = device.getCullMode();
    var oldWR = device.writeRed;
    var oldWG = device.writeGreen;
    var oldWB = device.writeBlue;
    var oldWA = device.writeAlpha;
    device.setBlending(false);
    device.setDepthTest(false);
    device.setDepthWrite(false);
    device.setCullMode(pc.CULLFACE_BACK);
    device.setColorWrite(true, true, true, true);
    device.setVertexBuffer(vertexBuffer, 0);
    device.setShader(shader);
    device.draw(primitive);
    device.setBlending(oldBlending);
    device.setDepthTest(oldDepthTest);
    device.setDepthWrite(oldDepthWrite);
    device.setCullMode(oldCullMode);
    device.setColorWrite(oldWR, oldWG, oldWB, oldWA);
    device.updateEnd();
  }
  return {PostEffect:PostEffect, createFullscreenQuad:createFullscreenQuad, drawFullscreenQuad:drawFullscreenQuad};
}());
(function() {
  var enums = {BLEND_SUBTRACTIVE:0, BLEND_ADDITIVE:1, BLEND_NORMAL:2, BLEND_NONE:3, BLEND_PREMULTIPLIED:4, BLEND_MULTIPLICATIVE:5, BLEND_ADDITIVEALPHA:6, BLEND_MULTIPLICATIVE2X:7, BLEND_SCREEN:8, BLEND_MIN:9, BLEND_MAX:10, FOG_NONE:"none", FOG_LINEAR:"linear", FOG_EXP:"exp", FOG_EXP2:"exp2", FRESNEL_NONE:0, FRESNEL_SCHLICK:2, LAYER_HUD:0, LAYER_GIZMO:1, LAYER_FX:2, LAYER_WORLD:15, LIGHTTYPE_DIRECTIONAL:0, LIGHTTYPE_POINT:1, LIGHTTYPE_SPOT:2, LIGHTFALLOFF_LINEAR:0, LIGHTFALLOFF_INVERSESQUARED:1, SHADOW_PCF3:0,
  SHADOW_DEPTH:0, SHADOW_VSM8:1, SHADOW_VSM16:2, SHADOW_VSM32:3, SHADOW_PCF5:4, BLUR_BOX:0, BLUR_GAUSSIAN:1, PARTICLESORT_NONE:0, PARTICLESORT_DISTANCE:1, PARTICLESORT_NEWER_FIRST:2, PARTICLESORT_OLDER_FIRST:3, PARTICLEMODE_GPU:0, PARTICLEMODE_CPU:1, EMITTERSHAPE_BOX:0, EMITTERSHAPE_SPHERE:1, PROJECTION_PERSPECTIVE:0, PROJECTION_ORTHOGRAPHIC:1, RENDERSTYLE_SOLID:0, RENDERSTYLE_WIREFRAME:1, RENDERSTYLE_POINTS:2, CUBEPROJ_NONE:0, CUBEPROJ_BOX:1, SPECULAR_PHONG:0, SPECULAR_BLINN:1, GAMMA_NONE:0, GAMMA_SRGB:1,
  GAMMA_SRGBFAST:2, GAMMA_SRGBHDR:3, TONEMAP_LINEAR:0, TONEMAP_FILMIC:1, TONEMAP_HEJL:2, TONEMAP_ACES:3, TONEMAP_ACES2:4, SPECOCC_NONE:0, SPECOCC_AO:1, SPECOCC_GLOSSDEPENDENT:2, SHADERDEF_NOSHADOW:1, SHADERDEF_SKIN:2, SHADERDEF_UV0:4, SHADERDEF_UV1:8, SHADERDEF_VCOLOR:16, SHADERDEF_INSTANCING:32, SHADERDEF_LM:64, SHADERDEF_DIRLM:128, SHADERDEF_SCREENSPACE:256, LINEBATCH_WORLD:0, LINEBATCH_OVERLAY:1, LINEBATCH_GIZMO:2, SHADOWUPDATE_NONE:0, SHADOWUPDATE_THISFRAME:1, SHADOWUPDATE_REALTIME:2, SORTKEY_FORWARD:0,
  SORTKEY_DEPTH:1, SHADER_FORWARD:0, SHADER_FORWARDHDR:1, SHADER_DEPTH:2, SHADER_SHADOW:3, SHADER_PICK:18, BAKE_COLOR:0, BAKE_COLORDIR:1, VIEW_CENTER:0, VIEW_LEFT:1, VIEW_RIGHT:2};
  pc.extend(pc, enums);
  pc.scene = {};
  pc.extend(pc.scene, enums);
})();
pc.extend(pc, function() {
  var Scene = function Scene() {
    this.root = null;
    this._gravity = new pc.Vec3(0, -9.8, 0);
    this.drawCalls = [];
    this.shadowCasters = [];
    this.immediateDrawCalls = [];
    this._fog = pc.FOG_NONE;
    this.fogColor = new pc.Color(0, 0, 0);
    this.fogStart = 1;
    this.fogEnd = 1000;
    this.fogDensity = 0;
    this.ambientLight = new pc.Color(0, 0, 0);
    this._gammaCorrection = pc.GAMMA_NONE;
    this._toneMapping = 0;
    this.exposure = 1.0;
    this._skyboxPrefiltered = [null, null, null, null, null, null];
    this._skyboxCubeMap = null;
    this._skyboxModel = null;
    this._skyboxIntensity = 1;
    this._skyboxMip = 0;
    this.lightmapSizeMultiplier = 1;
    this.lightmapMaxResolution = 2048;
    this.lightmapMode = pc.BAKE_COLORDIR;
    this._stats = {meshInstances:0, lights:0, dynamicLights:0, bakedLights:0, lastStaticPrepareFullTime:0, lastStaticPrepareSearchTime:0, lastStaticPrepareWriteTime:0, lastStaticPrepareTriAabbTime:0, lastStaticPrepareCombineTime:0, updateShadersTime:0};
    this._models = [];
    this._lights = [];
    this._globalLights = [];
    this._localLights = [[], []];
    this._updateShaders = true;
    this._sceneShadersVersion = 0;
    this._needsStaticPrepare = true;
  };
  Object.defineProperty(Scene.prototype, "updateShaders", {get:function() {
    return this._updateShaders;
  }, set:function(val) {
    if (val !== this._updateShaders) {
      this._updateShaders = val;
      if (!this._models) {
        return;
      }
      if (val) {
        this._sceneShadersVersion++;
      }
      for (var i = 0;i < this._models.length;i++) {
        this._models[i]._shadersVersion = this._sceneShadersVersion;
      }
    }
  }});
  Object.defineProperty(Scene.prototype, "fog", {get:function() {
    return this._fog;
  }, set:function(type) {
    if (type !== this._fog) {
      this._fog = type;
      this.updateShaders = true;
    }
  }});
  Object.defineProperty(Scene.prototype, "gammaCorrection", {get:function() {
    return this._gammaCorrection;
  }, set:function(value) {
    if (value !== this._gammaCorrection) {
      this._gammaCorrection = value;
      this.updateShaders = true;
    }
  }});
  Object.defineProperty(Scene.prototype, "toneMapping", {get:function() {
    return this._toneMapping;
  }, set:function(value) {
    if (value !== this._toneMapping) {
      this._toneMapping = value;
      this.updateShaders = true;
    }
  }});
  Object.defineProperty(Scene.prototype, "skybox", {get:function() {
    return this._skyboxCubeMap;
  }, set:function(value) {
    this._skyboxCubeMap = value;
    this._resetSkyboxModel();
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxIntensity", {get:function() {
    return this._skyboxIntensity;
  }, set:function(value) {
    this._skyboxIntensity = value;
    this._resetSkyboxModel();
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxMip", {get:function() {
    return this._skyboxMip;
  }, set:function(value) {
    this._skyboxMip = value;
    this._resetSkyboxModel();
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered128", {get:function() {
    return this._skyboxPrefiltered[0];
  }, set:function(value) {
    if (this._skyboxPrefiltered[0] === value) {
      return;
    }
    this._skyboxPrefiltered[0] = value;
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered64", {get:function() {
    return this._skyboxPrefiltered[1];
  }, set:function(value) {
    if (this._skyboxPrefiltered[1] === value) {
      return;
    }
    this._skyboxPrefiltered[1] = value;
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered32", {get:function() {
    return this._skyboxPrefiltered[2];
  }, set:function(value) {
    if (this._skyboxPrefiltered[2] === value) {
      return;
    }
    this._skyboxPrefiltered[2] = value;
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered16", {get:function() {
    return this._skyboxPrefiltered[3];
  }, set:function(value) {
    if (this._skyboxPrefiltered[3] === value) {
      return;
    }
    this._skyboxPrefiltered[3] = value;
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered8", {get:function() {
    return this._skyboxPrefiltered[4];
  }, set:function(value) {
    if (this._skyboxPrefiltered[4] === value) {
      return;
    }
    this._skyboxPrefiltered[4] = value;
    this.updateShaders = true;
  }});
  Object.defineProperty(Scene.prototype, "skyboxPrefiltered4", {get:function() {
    return this._skyboxPrefiltered[5];
  }, set:function(value) {
    if (this._skyboxPrefiltered[5] === value) {
      return;
    }
    this._skyboxPrefiltered[5] = value;
    this.updateShaders = true;
  }});
  Scene.prototype.applySettings = function(settings) {
    this._gravity.set(settings.physics.gravity[0], settings.physics.gravity[1], settings.physics.gravity[2]);
    this.ambientLight.set(settings.render.global_ambient[0], settings.render.global_ambient[1], settings.render.global_ambient[2]);
    this._fog = settings.render.fog;
    this.fogColor.set(settings.render.fog_color[0], settings.render.fog_color[1], settings.render.fog_color[2]);
    this.fogStart = settings.render.fog_start;
    this.fogEnd = settings.render.fog_end;
    this.fogDensity = settings.render.fog_density;
    this._gammaCorrection = settings.render.gamma_correction;
    this._toneMapping = settings.render.tonemapping;
    this.lightmapSizeMultiplier = settings.render.lightmapSizeMultiplier;
    this.lightmapMaxResolution = settings.render.lightmapMaxResolution;
    this.lightmapMode = settings.render.lightmapMode;
    this.exposure = settings.render.exposure;
    this._skyboxIntensity = settings.render.skyboxIntensity === undefined ? 1 : settings.render.skyboxIntensity;
    this._skyboxMip = settings.render.skyboxMip === undefined ? 0 : settings.render.skyboxMip;
    this._resetSkyboxModel();
    this.updateShaders = true;
  };
  Scene.prototype.updateShadersFunc = function(device) {
    var i;
    var time = pc.now();
    if (this._skyboxCubeMap && !this._skyboxModel) {
      var material = new pc.Material;
      var scene = this;
      material.updateShader = function(dev, sc, defs, staticLightList, pass) {
        var library = device.getProgramLibrary();
        var shader = library.getProgram("skybox", {rgbm:scene._skyboxCubeMap.rgbm, hdr:scene._skyboxCubeMap.rgbm || scene._skyboxCubeMap.format === pc.PIXELFORMAT_RGBA32F, useIntensity:scene.skyboxIntensity !== 1, mip:scene._skyboxCubeMap.fixCubemapSeams ? scene.skyboxMip : 0, fixSeams:scene._skyboxCubeMap.fixCubemapSeams, gamma:pass === pc.SHADER_FORWARDHDR ? scene.gammaCorrection ? pc.GAMMA_SRGBHDR : pc.GAMMA_NONE : scene.gammaCorrection, toneMapping:pass === pc.SHADER_FORWARDHDR ? pc.TONEMAP_LINEAR :
        scene.toneMapping});
        this.setShader(shader);
      };
      material.updateShader();
      if (!this._skyboxCubeMap.fixCubemapSeams || !scene._skyboxMip) {
        material.setParameter("texture_cubeMap", this._skyboxCubeMap);
      } else {
        var mip2tex = [null, "64", "16", "8", "4"];
        var mipTex = this["skyboxPrefiltered" + mip2tex[scene._skyboxMip]];
        if (mipTex) {
          material.setParameter("texture_cubeMap", mipTex);
        }
      }
      material.cull = pc.CULLFACE_NONE;
      var node = new pc.GraphNode;
      var mesh = pc.createBox(device);
      var meshInstance = new pc.MeshInstance(node, mesh, material);
      meshInstance.updateKey = function() {
        var material = this.material;
        this.key = pc._getDrawcallSortKey(this.layer, material.blendType, false, 0);
      };
      meshInstance.updateKey();
      meshInstance.cull = false;
      meshInstance.drawToDepth = false;
      var model = new pc.Model;
      model.graph = node;
      model.meshInstances = [meshInstance];
      this._skyboxModel = model;
      this.addModel(model);
    }
    var materials = [];
    var drawCalls = this.drawCalls;
    for (i = 0;i < drawCalls.length;i++) {
      var drawCall = drawCalls[i];
      if (drawCall.material !== undefined) {
        if (materials.indexOf(drawCall.material) === -1) {
          materials.push(drawCall.material);
        }
      }
    }
    for (i = 0;i < materials.length;i++) {
      var mat = materials[i];
      if (mat.updateShader !== pc.Material.prototype.updateShader) {
        mat.clearVariants();
        mat.shader = null;
      }
    }
    this._stats.updateShadersTime += pc.now() - time;
  };
  Scene.prototype.getModels = function() {
    return this._models;
  };
  Scene.prototype._updateStats = function() {
  };
  Scene.prototype._updateLightStats = function() {
    var stats = this._stats;
    stats.lights = this._lights.length;
    stats.dynamicLights = 0;
    stats.bakedLights = 0;
    var l;
    for (var i = 0;i < stats.lights;i++) {
      l = this._lights[i];
      if (l._enabled) {
        if (l._mask & pc.MASK_DYNAMIC || l._mask & pc.MASK_BAKED) {
          stats.dynamicLights++;
        }
        if (l._mask & pc.MASK_LIGHTMAP) {
          stats.bakedLights++;
        }
      }
    }
  };
  Scene.prototype.addModel = function(model) {
    var i, len;
    var updateModelShaders = model._shadersVersion !== this._sceneShadersVersion;
    model._shadersVersion = this._sceneShadersVersion;
    var index = this._models.indexOf(model);
    if (index === -1) {
      this._models.push(model);
      var materials = model.getMaterials();
      for (i = 0;i < materials.length;i++) {
        materials[i].scene = this;
      }
      var meshInstance;
      var numMeshInstances = model.meshInstances.length;
      for (i = 0;i < numMeshInstances;i++) {
        meshInstance = model.meshInstances[i];
        if (updateModelShaders) {
          meshInstance.material.clearVariants();
        }
        if (this.drawCalls.indexOf(meshInstance) === -1) {
          this.drawCalls.push(meshInstance);
        }
        if (meshInstance.castShadow) {
          if (this.shadowCasters.indexOf(meshInstance) === -1) {
            this.shadowCasters.push(meshInstance);
          }
        }
      }
      var lights = model.getLights();
      for (i = 0, len = lights.length;i < len;i++) {
        this.addLight(lights[i]);
      }
      this._updateStats();
    }
  };
  Scene.prototype.addShadowCaster = function(model) {
    var meshInstance;
    var numMeshInstances = model.meshInstances.length;
    for (var i = 0;i < numMeshInstances;i++) {
      meshInstance = model.meshInstances[i];
      if (meshInstance.castShadow) {
        if (this.shadowCasters.indexOf(meshInstance) === -1) {
          this.shadowCasters.push(meshInstance);
        }
      }
    }
  };
  Scene.prototype.removeModel = function(model) {
    var i, j, len, drawCall, spliceOffset, spliceCount;
    var index = this._models.indexOf(model);
    if (index !== -1) {
      this._models.splice(index, 1);
      var materials = model.getMaterials();
      for (i = 0;i < materials.length;i++) {
        materials[i].scene = null;
      }
      var meshInstance;
      var numMeshInstances = model.meshInstances.length;
      for (i = 0;i < numMeshInstances;i++) {
        meshInstance = model.meshInstances[i];
        spliceOffset = -1;
        spliceCount = 0;
        len = this.drawCalls.length;
        for (j = 0;j < len;j++) {
          drawCall = this.drawCalls[j];
          if (drawCall === meshInstance) {
            spliceOffset = j;
            spliceCount = 1;
            break;
          }
          if (drawCall._staticSource === meshInstance) {
            if (spliceOffset < 0) {
              spliceOffset = j;
            }
            spliceCount++;
          } else {
            if (spliceOffset >= 0) {
              break;
            }
          }
        }
        if (spliceOffset >= 0) {
          this.drawCalls.splice(spliceOffset, spliceCount);
        }
        if (meshInstance.castShadow) {
          index = this.shadowCasters.indexOf(meshInstance);
          if (index !== -1) {
            this.shadowCasters.splice(index, 1);
          }
        }
      }
      var lights = model.getLights();
      for (i = 0, len = lights.length;i < len;i++) {
        this.removeLight(lights[i]);
      }
      this._updateStats();
    }
  };
  Scene.prototype.removeShadowCaster = function(model) {
    var meshInstance, index;
    var numMeshInstances = model.meshInstances.length;
    for (var i = 0;i < numMeshInstances;i++) {
      meshInstance = model.meshInstances[i];
      if (meshInstance.castShadow) {
        index = this.shadowCasters.indexOf(meshInstance);
        if (index !== -1) {
          this.shadowCasters.splice(index, 1);
        }
      }
    }
  };
  Scene.prototype.containsModel = function(model) {
    return this._models.indexOf(model) >= 0;
  };
  Scene.prototype.addLight = function(light) {
    var index = this._lights.indexOf(light);
    if (index !== -1) {
      console.warn("pc.Scene#addLight: light is already in the scene");
    } else {
      this._lights.push(light);
      light._scene = this;
      this.updateShaders = true;
    }
    this._updateLightStats();
  };
  Scene.prototype.removeLight = function(light) {
    var index = this._lights.indexOf(light);
    if (index === -1) {
      console.warn("pc.Scene#removeLight: light is not in the scene");
    } else {
      this._lights.splice(index, 1);
      light._scene = null;
      this.updateShaders = true;
    }
    this._updateLightStats();
  };
  Scene.prototype._resetSkyboxModel = function() {
    if (this._skyboxModel) {
      if (this.containsModel(this._skyboxModel)) {
        this.removeModel(this._skyboxModel);
      }
    }
    this._skyboxModel = null;
  };
  Scene.prototype.setSkybox = function(cubemaps) {
    var i;
    if (!cubemaps) {
      cubemaps = [null, null, null, null, null, null, null];
    }
    var different = false;
    if (this._skyboxCubeMap !== cubemaps[0]) {
      different = true;
    }
    if (!different) {
      for (i = 0;i < 6 && !different;i++) {
        if (this._skyboxPrefiltered[i] !== cubemaps[i + 1]) {
          different = true;
        }
      }
    }
    if (!different) {
      return;
    }
    for (i = 0;i < 6;i++) {
      this._skyboxPrefiltered[i] = cubemaps[i + 1];
    }
    this.skybox = cubemaps[0];
  };
  Scene.prototype.update = function() {
    for (var i = 0, len = this._models.length;i < len;i++) {
      this._models[i].getGraph().syncHierarchy();
    }
  };
  Scene.prototype.destroy = function() {
    var i;
    var models = this.getModels();
    for (i = 0;i < models.length;i++) {
      this.removeModel(models[i]);
    }
    for (i = 0;i < this._lights.length;i++) {
      this.removeLight(this._lights[i]);
    }
    this.skybox = null;
  };
  return {Scene:Scene};
}());
pc.extend(pc, function() {
  var scaleShift = (new pc.Mat4).mul2((new pc.Mat4).setTranslate(0.5, 0.5, 0.5), (new pc.Mat4).setScale(0.5, 0.5, 0.5));
  var rgbaDepthClearOptions = {color:[254.0 / 255, 254.0 / 255, 254.0 / 255, 254.0 / 255], depth:1.0, flags:pc.CLEARFLAG_COLOR | pc.CLEARFLAG_DEPTH};
  var opChanId = {r:1, g:2, b:3, a:4};
  var numShadowModes = 5;
  var shadowMapCache = [{}, {}, {}, {}, {}];
  var directionalShadowEpsilon = 0.01;
  var pixelOffset = new pc.Vec2;
  var blurScissorRect = {x:1, y:1, z:0, w:0};
  var shadowCamView = new pc.Mat4;
  var shadowCamViewProj = new pc.Mat4;
  var c2sc = new pc.Mat4;
  var viewInvMat = new pc.Mat4;
  var viewMat = new pc.Mat4;
  var viewMat3 = new pc.Mat3;
  var viewProjMat = new pc.Mat4;
  var projMat;
  var viewInvL = new pc.Mat4;
  var viewInvR = new pc.Mat4;
  var viewL = new pc.Mat4;
  var viewR = new pc.Mat4;
  var viewPosL = new pc.Vec3;
  var viewPosR = new pc.Vec3;
  var projL, projR;
  var viewMat3L = new pc.Mat4;
  var viewMat3R = new pc.Mat4;
  var viewProjMatL = new pc.Mat4;
  var viewProjMatR = new pc.Mat4;
  var frustumDiagonal = new pc.Vec3;
  var tempSphere = {center:null, radius:0};
  var meshPos;
  var visibleSceneAabb = new pc.BoundingBox;
  var lightBounds = new pc.BoundingBox;
  var culled = [];
  var filtered = [];
  var boneTextureSize = [0, 0];
  var boneTexture, instancingData, modelMatrix, normalMatrix;
  var shadowMapCubeCache = {};
  var maxBlurSize = 25;
  var keyA, keyB;
  var frustumPoints = [];
  for (var i = 0;i < 8;i++) {
    frustumPoints.push(new pc.Vec3);
  }
  function _getFrustumPoints(camera, farClip, points) {
    var nearClip = camera._nearClip;
    var fov = camera._fov * Math.PI / 180.0;
    var aspect = camera._aspect;
    var projection = camera._projection;
    var x, y;
    if (projection === pc.PROJECTION_PERSPECTIVE) {
      y = Math.tan(fov / 2.0) * nearClip;
    } else {
      y = camera._orthoHeight;
    }
    x = y * aspect;
    points[0].x = x;
    points[0].y = -y;
    points[0].z = -nearClip;
    points[1].x = x;
    points[1].y = y;
    points[1].z = -nearClip;
    points[2].x = -x;
    points[2].y = y;
    points[2].z = -nearClip;
    points[3].x = -x;
    points[3].y = -y;
    points[3].z = -nearClip;
    if (projection === pc.PROJECTION_PERSPECTIVE) {
      y = Math.tan(fov / 2.0) * farClip;
      x = y * aspect;
    }
    points[4].x = x;
    points[4].y = -y;
    points[4].z = -farClip;
    points[5].x = x;
    points[5].y = y;
    points[5].z = -farClip;
    points[6].x = -x;
    points[6].y = y;
    points[6].z = -farClip;
    points[7].x = -x;
    points[7].y = -y;
    points[7].z = -farClip;
    return points;
  }
  function StaticArray(size) {
    var data = new Array(size);
    var obj = function(idx) {
      return data[idx];
    };
    obj.size = 0;
    obj.push = function(v) {
      data[this.size] = v;
      ++this.size;
    };
    obj.data = data;
    return obj;
  }
  var intersectCache = {temp:[new pc.Vec3, new pc.Vec3, new pc.Vec3], vertices:new Array(3), negative:new StaticArray(3), positive:new StaticArray(3), intersections:new StaticArray(3), zCollection:new StaticArray(36)};
  function _groupVertices(coord, face, smallerIsNegative) {
    var intersections = intersectCache.intersections;
    var small, large;
    if (smallerIsNegative) {
      small = intersectCache.negative;
      large = intersectCache.positive;
    } else {
      small = intersectCache.positive;
      large = intersectCache.negative;
    }
    intersections.size = 0;
    small.size = 0;
    large.size = 0;
    var intersectCount = 0;
    var v;
    for (var j = 0;j < 3;++j) {
      v = intersectCache.vertices[j];
      if (v[coord] < face) {
        small.push(v);
      } else {
        if (v[coord] === face) {
          intersections.push(intersectCache.temp[intersections.size].copy(v));
        } else {
          large.push(v);
        }
      }
    }
  }
  function _triXFace(zs, x, y, faceTest, yMin, yMax) {
    var negative = intersectCache.negative;
    var positive = intersectCache.positive;
    var intersections = intersectCache.intersections;
    if (negative.size === 3) {
      return false;
    }
    if (negative.size && positive.size) {
      intersections.push(intersectCache.temp[intersections.size].lerp(negative(0), positive(0), (faceTest - negative(0)[x]) / (positive(0)[x] - negative(0)[x])));
      if (negative.size === 2) {
        intersections.push(intersectCache.temp[intersections.size].lerp(negative(1), positive(0), (faceTest - negative(1)[x]) / (positive(0)[x] - negative(1)[x])));
      } else {
        if (positive.size === 2) {
          intersections.push(intersectCache.temp[intersections.size].lerp(negative(0), positive(1), (faceTest - negative(0)[x]) / (positive(1)[x] - negative(0)[x])));
        }
      }
    }
    if (intersections.size === 0) {
      return true;
    }
    if (intersections.size === 1) {
      if (yMin <= intersections(0)[y] && intersections(0)[y] <= yMax) {
        zs.push(intersections(0).z);
      }
      return true;
    }
    if (intersections(1)[y] === intersections(0)[y]) {
      if (yMin <= intersections(0)[y] && intersections(0)[y] <= yMax) {
        zs.push(intersections(0).z);
        zs.push(intersections(1).z);
      }
    } else {
      var delta = (intersections(1).z - intersections(0).z) / (intersections(1)[y] - intersections(0)[y]);
      if (intersections(0)[y] > yMax) {
        zs.push(intersections(0).z + delta * (yMax - intersections(0)[y]));
      } else {
        if (intersections(0)[y] < yMin) {
          zs.push(intersections(0).z + delta * (yMin - intersections(0)[y]));
        } else {
          zs.push(intersections(0).z);
        }
      }
      if (intersections(1)[y] > yMax) {
        zs.push(intersections(1).z + delta * (yMax - intersections(1)[y]));
      } else {
        if (intersections(1)[y] < yMin) {
          zs.push(intersections(1).z + delta * (yMin - intersections(1)[y]));
        } else {
          zs.push(intersections(1).z);
        }
      }
    }
    return true;
  }
  var _sceneAABB_LS = [new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3];
  var iAABBTriIndexes = [0, 1, 2, 1, 2, 3, 4, 5, 6, 5, 6, 7, 0, 2, 4, 2, 4, 6, 1, 3, 5, 3, 5, 7, 0, 1, 4, 1, 4, 5, 2, 3, 6, 3, 6, 7];
  function _getZFromAABB(w2sc, aabbMin, aabbMax, lcamMinX, lcamMaxX, lcamMinY, lcamMaxY) {
    _sceneAABB_LS[0].x = _sceneAABB_LS[1].x = _sceneAABB_LS[2].x = _sceneAABB_LS[3].x = aabbMin.x;
    _sceneAABB_LS[1].y = _sceneAABB_LS[3].y = _sceneAABB_LS[7].y = _sceneAABB_LS[5].y = aabbMin.y;
    _sceneAABB_LS[2].z = _sceneAABB_LS[3].z = _sceneAABB_LS[6].z = _sceneAABB_LS[7].z = aabbMin.z;
    _sceneAABB_LS[4].x = _sceneAABB_LS[5].x = _sceneAABB_LS[6].x = _sceneAABB_LS[7].x = aabbMax.x;
    _sceneAABB_LS[0].y = _sceneAABB_LS[2].y = _sceneAABB_LS[4].y = _sceneAABB_LS[6].y = aabbMax.y;
    _sceneAABB_LS[0].z = _sceneAABB_LS[1].z = _sceneAABB_LS[4].z = _sceneAABB_LS[5].z = aabbMax.z;
    for (var i = 0;i < 8;++i) {
      w2sc.transformPoint(_sceneAABB_LS[i], _sceneAABB_LS[i]);
    }
    var minz = 9999999999;
    var maxz = -9999999999;
    var vertices = intersectCache.vertices;
    var positive = intersectCache.positive;
    var zs = intersectCache.zCollection;
    zs.size = 0;
    for (var AABBTriIter = 0;AABBTriIter < 12;++AABBTriIter) {
      vertices[0] = _sceneAABB_LS[iAABBTriIndexes[AABBTriIter * 3 + 0]];
      vertices[1] = _sceneAABB_LS[iAABBTriIndexes[AABBTriIter * 3 + 1]];
      vertices[2] = _sceneAABB_LS[iAABBTriIndexes[AABBTriIter * 3 + 2]];
      var verticesWithinBound = 0;
      _groupVertices("x", lcamMinX, true);
      if (!_triXFace(zs, "x", "y", lcamMinX, lcamMinY, lcamMaxY)) {
        continue;
      }
      verticesWithinBound += positive.size;
      _groupVertices("x", lcamMaxX, false);
      if (!_triXFace(zs, "x", "y", lcamMaxX, lcamMinY, lcamMaxY)) {
        continue;
      }
      verticesWithinBound += positive.size;
      _groupVertices("y", lcamMinY, true);
      if (!_triXFace(zs, "y", "x", lcamMinY, lcamMinX, lcamMaxX)) {
        continue;
      }
      verticesWithinBound += positive.size;
      _groupVertices("y", lcamMaxY, false);
      _triXFace(zs, "y", "x", lcamMaxY, lcamMinX, lcamMaxX);
      if (verticesWithinBound + positive.size == 12) {
        zs.push(vertices[0].z);
        zs.push(vertices[1].z);
        zs.push(vertices[2].z);
      }
    }
    var z;
    for (var j = 0, len = zs.size;j < len;j++) {
      z = zs(j);
      if (z < minz) {
        minz = z;
      }
      if (z > maxz) {
        maxz = z;
      }
    }
    return {min:minz, max:maxz};
  }
  function _getZFromAABBSimple(w2sc, aabbMin, aabbMax, lcamMinX, lcamMaxX, lcamMinY, lcamMaxY) {
    _sceneAABB_LS[0].x = _sceneAABB_LS[1].x = _sceneAABB_LS[2].x = _sceneAABB_LS[3].x = aabbMin.x;
    _sceneAABB_LS[1].y = _sceneAABB_LS[3].y = _sceneAABB_LS[7].y = _sceneAABB_LS[5].y = aabbMin.y;
    _sceneAABB_LS[2].z = _sceneAABB_LS[3].z = _sceneAABB_LS[6].z = _sceneAABB_LS[7].z = aabbMin.z;
    _sceneAABB_LS[4].x = _sceneAABB_LS[5].x = _sceneAABB_LS[6].x = _sceneAABB_LS[7].x = aabbMax.x;
    _sceneAABB_LS[0].y = _sceneAABB_LS[2].y = _sceneAABB_LS[4].y = _sceneAABB_LS[6].y = aabbMax.y;
    _sceneAABB_LS[0].z = _sceneAABB_LS[1].z = _sceneAABB_LS[4].z = _sceneAABB_LS[5].z = aabbMax.z;
    var minz = 9999999999;
    var maxz = -9999999999;
    var z;
    for (var i = 0;i < 8;++i) {
      w2sc.transformPoint(_sceneAABB_LS[i], _sceneAABB_LS[i]);
      z = _sceneAABB_LS[i].z;
      if (z < minz) {
        minz = z;
      }
      if (z > maxz) {
        maxz = z;
      }
    }
    return {min:minz, max:maxz};
  }
  function getShadowFormat(device, shadowType) {
    if (shadowType === pc.SHADOW_VSM32) {
      return pc.PIXELFORMAT_RGBA32F;
    } else {
      if (shadowType === pc.SHADOW_VSM16) {
        return pc.PIXELFORMAT_RGBA16F;
      } else {
        if (shadowType === pc.SHADOW_PCF5) {
          return pc.PIXELFORMAT_DEPTH;
        } else {
          if (shadowType === pc.SHADOW_PCF3 && device.webgl2) {
            return pc.PIXELFORMAT_DEPTH;
          }
        }
      }
    }
    return pc.PIXELFORMAT_R8_G8_B8_A8;
  }
  function getShadowFiltering(device, shadowType) {
    if (shadowType === pc.SHADOW_PCF3 && !device.webgl2) {
      return pc.FILTER_NEAREST;
    } else {
      if (shadowType === pc.SHADOW_VSM32) {
        return device.extTextureFloatLinear ? pc.FILTER_LINEAR : pc.FILTER_NEAREST;
      } else {
        if (shadowType === pc.SHADOW_VSM16) {
          return device.extTextureHalfFloatLinear ? pc.FILTER_LINEAR : pc.FILTER_NEAREST;
        }
      }
    }
    return pc.FILTER_LINEAR;
  }
  function createShadowMap(device, width, height, shadowType) {
    var format = getShadowFormat(device, shadowType);
    var filter = getShadowFiltering(device, shadowType);
    var shadowMap = new pc.Texture(device, {format:format, width:width, height:height, mipmaps:false, minFilter:filter, magFilter:filter, addressU:pc.ADDRESS_CLAMP_TO_EDGE, addressV:pc.ADDRESS_CLAMP_TO_EDGE});
    if (shadowType === pc.SHADOW_PCF5 || shadowType === pc.SHADOW_PCF3 && device.webgl2) {
      shadowMap.compareOnRead = true;
      shadowMap.compareFunc = pc.FUNC_LESS;
      return new pc.RenderTarget({depthBuffer:shadowMap});
    }
    return new pc.RenderTarget({colorBuffer:shadowMap, depth:true});
  }
  function createShadowCubeMap(device, size) {
    var cubemap = new pc.Texture(device, {format:pc.PIXELFORMAT_R8_G8_B8_A8, width:size, height:size, cubemap:true, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST, addressU:pc.ADDRESS_CLAMP_TO_EDGE, addressV:pc.ADDRESS_CLAMP_TO_EDGE});
    var targets = [];
    var target;
    for (var i = 0;i < 6;i++) {
      target = new pc.RenderTarget({colorBuffer:cubemap, face:i, depth:true});
      targets.push(target);
    }
    return targets;
  }
  function gauss(x, sigma) {
    return Math.exp(-(x * x) / (2.0 * sigma * sigma));
  }
  function gaussWeights(kernelSize) {
    if (kernelSize > maxBlurSize) {
      kernelSize = maxBlurSize;
    }
    var sigma = (kernelSize - 1) / (2 * 3);
    var i, values, sum, halfWidth;
    halfWidth = (kernelSize - 1) * 0.5;
    values = new Array(kernelSize);
    sum = 0.0;
    for (i = 0;i < kernelSize;++i) {
      values[i] = gauss(i - halfWidth, sigma);
      sum += values[i];
    }
    for (i = 0;i < kernelSize;++i) {
      values[i] /= sum;
    }
    return values;
  }
  function createShadowCamera(device, shadowType, type) {
    var flags = pc.CLEARFLAG_DEPTH;
    var hwPcf = shadowType === pc.SHADOW_PCF5 || shadowType === pc.SHADOW_PCF3 && device.webgl2;
    if (type === pc.LIGHTTYPE_POINT) {
      hwPcf = false;
    }
    if (!hwPcf) {
      flags |= pc.CLEARFLAG_COLOR;
    }
    var shadowCam = new pc.Camera;
    if (shadowType >= pc.SHADOW_VSM8 && shadowType <= pc.SHADOW_VSM32) {
      shadowCam.clearColor[0] = 0;
      shadowCam.clearColor[1] = 0;
      shadowCam.clearColor[2] = 0;
      shadowCam.clearColor[3] = 0;
    } else {
      shadowCam.clearColor[0] = 1;
      shadowCam.clearColor[1] = 1;
      shadowCam.clearColor[2] = 1;
      shadowCam.clearColor[3] = 1;
    }
    shadowCam.clearDepth = 1;
    shadowCam.clearFlags = flags;
    shadowCam.clearStencil = null;
    shadowCam._node = new pc.GraphNode;
    return shadowCam;
  }
  function getShadowMapFromCache(device, res, mode, layer) {
    if (!layer) {
      layer = 0;
    }
    var id = layer * 10000 + res;
    var shadowBuffer = shadowMapCache[mode][id];
    if (!shadowBuffer) {
      shadowBuffer = createShadowMap(device, res, res, mode ? mode : pc.SHADOW_PCF3);
      shadowMapCache[mode][id] = shadowBuffer;
    }
    return shadowBuffer;
  }
  function createShadowBuffer(device, light) {
    var shadowBuffer;
    if (light._type === pc.LIGHTTYPE_POINT) {
      if (light._shadowType > pc.SHADOW_PCF3) {
        light._shadowType = pc.SHADOW_PCF3;
      }
      if (light._cacheShadowMap) {
        shadowBuffer = shadowMapCubeCache[light._shadowResolution];
        if (!shadowBuffer) {
          shadowBuffer = createShadowCubeMap(device, light._shadowResolution);
          shadowMapCubeCache[light._shadowResolution] = shadowBuffer;
        }
      } else {
        shadowBuffer = createShadowCubeMap(device, light._shadowResolution);
      }
      light._shadowCamera.renderTarget = shadowBuffer[0];
      light._shadowCubeMap = shadowBuffer;
    } else {
      if (light._cacheShadowMap) {
        shadowBuffer = getShadowMapFromCache(device, light._shadowResolution, light._shadowType);
      } else {
        shadowBuffer = createShadowMap(device, light._shadowResolution, light._shadowResolution, light._shadowType);
      }
      light._shadowCamera.renderTarget = shadowBuffer;
    }
    light._isCachedShadowMap = light._cacheShadowMap;
  }
  function getDepthKey(meshInstance) {
    var material = meshInstance.material;
    var x = meshInstance.skinInstance ? 10 : 0;
    var y = 0;
    if (material.opacityMap) {
      var opChan = material.opacityMapChannel;
      if (opChan) {
        y = opChanId[opChan];
      }
    }
    return x + y;
  }
  function ForwardRenderer(graphicsDevice) {
    this.device = graphicsDevice;
    var device = this.device;
    this._depthDrawCalls = 0;
    this._shadowDrawCalls = 0;
    this._forwardDrawCalls = 0;
    this._skinDrawCalls = 0;
    this._instancedDrawCalls = 0;
    this._immediateRendered = 0;
    this._removedByInstancing = 0;
    this._camerasRendered = 0;
    this._materialSwitches = 0;
    this._shadowMapUpdates = 0;
    this._shadowMapTime = 0;
    this._depthMapTime = 0;
    this._forwardTime = 0;
    this._cullTime = 0;
    this._sortTime = 0;
    this._skinTime = 0;
    this._morphTime = 0;
    this._instancingTime = 0;
    var library = device.getProgramLibrary();
    this.library = library;
    this.frontToBack = false;
    this._depthShaderStatic = library.getProgram("depth", {skin:false});
    this._depthShaderSkin = library.getProgram("depth", {skin:true});
    this._depthShaderStaticOp = {};
    this._depthShaderSkinOp = {};
    var chan = ["r", "g", "b", "a"];
    for (var c = 0;c < 4;c++) {
      this._depthShaderStaticOp[chan[c]] = library.getProgram("depth", {skin:false, opacityMap:true, opacityChannel:chan[c]});
      this._depthShaderSkinOp[chan[c]] = library.getProgram("depth", {skin:true, opacityMap:true, opacityChannel:chan[c]});
      this._depthShaderStaticOp[chan[c]] = library.getProgram("depth", {skin:false, opacityMap:true, opacityChannel:chan[c]});
      this._depthShaderSkinOp[chan[c]] = library.getProgram("depth", {skin:true, opacityMap:true, opacityChannel:chan[c]});
    }
    var scope = device.scope;
    this.projId = scope.resolve("matrix_projection");
    this.viewId = scope.resolve("matrix_view");
    this.viewId3 = scope.resolve("matrix_view3");
    this.viewInvId = scope.resolve("matrix_viewInverse");
    this.viewProjId = scope.resolve("matrix_viewProjection");
    this.viewPosId = scope.resolve("view_position");
    this.nearClipId = scope.resolve("camera_near");
    this.farClipId = scope.resolve("camera_far");
    this.shadowMapLightRadiusId = scope.resolve("light_radius");
    this.fogColorId = scope.resolve("fog_color");
    this.fogStartId = scope.resolve("fog_start");
    this.fogEndId = scope.resolve("fog_end");
    this.fogDensityId = scope.resolve("fog_density");
    this.modelMatrixId = scope.resolve("matrix_model");
    this.normalMatrixId = scope.resolve("matrix_normal");
    this.poseMatrixId = scope.resolve("matrix_pose[0]");
    this.boneTextureId = scope.resolve("texture_poseMap");
    this.boneTextureSizeId = scope.resolve("texture_poseMapSize");
    this.skinPosOffsetId = scope.resolve("skinPosOffset");
    this.alphaTestId = scope.resolve("alpha_ref");
    this.opacityMapId = scope.resolve("texture_opacityMap");
    this.ambientId = scope.resolve("light_globalAmbient");
    this.exposureId = scope.resolve("exposure");
    this.skyboxIntensityId = scope.resolve("skyboxIntensity");
    this.lightColorId = [];
    this.lightDirId = [];
    this.lightShadowMapId = [];
    this.lightShadowMatrixId = [];
    this.lightShadowParamsId = [];
    this.lightShadowMatrixVsId = [];
    this.lightShadowParamsVsId = [];
    this.lightDirVsId = [];
    this.lightRadiusId = [];
    this.lightPosId = [];
    this.lightInAngleId = [];
    this.lightOutAngleId = [];
    this.lightPosVsId = [];
    this.lightCookieId = [];
    this.lightCookieIntId = [];
    this.lightCookieMatrixId = [];
    this.lightCookieOffsetId = [];
    this.depthMapId = scope.resolve("uDepthMap");
    this.screenSizeId = scope.resolve("uScreenSize");
    this._screenSize = new pc.Vec4;
    this.sourceId = scope.resolve("source");
    this.pixelOffsetId = scope.resolve("pixelOffset");
    this.weightId = scope.resolve("weight[0]");
    var chunks = pc.shaderChunks;
    this.blurVsmShaderCode = [chunks.blurVSMPS, "#define GAUSS\n" + chunks.blurVSMPS];
    var packed = "#define PACKED\n";
    this.blurPackedVsmShaderCode = [packed + this.blurVsmShaderCode[0], packed + this.blurVsmShaderCode[1]];
    this.blurVsmShader = [{}, {}];
    this.blurPackedVsmShader = [{}, {}];
    this.blurVsmWeights = {};
    this.polygonOffsetId = scope.resolve("polygonOffset");
    this.polygonOffset = new Float32Array(2);
    this.fogColor = new Float32Array(3);
    this.ambientColor = new Float32Array(3);
  }
  function mat3FromMat4(m3, m4) {
    m3.data[0] = m4.data[0];
    m3.data[1] = m4.data[1];
    m3.data[2] = m4.data[2];
    m3.data[3] = m4.data[4];
    m3.data[4] = m4.data[5];
    m3.data[5] = m4.data[6];
    m3.data[6] = m4.data[8];
    m3.data[7] = m4.data[9];
    m3.data[8] = m4.data[10];
  }
  pc.extend(ForwardRenderer.prototype, {sortCompare:function(drawCallA, drawCallB) {
    if (drawCallA.layer === drawCallB.layer) {
      if (drawCallA.drawOrder && drawCallB.drawOrder) {
        return drawCallA.drawOrder - drawCallB.drawOrder;
      } else {
        if (drawCallA.zdist && drawCallB.zdist) {
          return drawCallB.zdist - drawCallA.zdist;
        } else {
          if (drawCallA.zdist2 && drawCallB.zdist2) {
            return drawCallA.zdist2 - drawCallB.zdist2;
          }
        }
      }
    }
    return drawCallB._key[pc.SORTKEY_FORWARD] - drawCallA._key[pc.SORTKEY_FORWARD];
  }, sortCompareMesh:function(drawCallA, drawCallB) {
    if (drawCallA.layer === drawCallB.layer) {
      if (drawCallA.drawOrder && drawCallB.drawOrder) {
        return drawCallA.drawOrder - drawCallB.drawOrder;
      } else {
        if (drawCallA.zdist && drawCallB.zdist) {
          return drawCallB.zdist - drawCallA.zdist;
        }
      }
    }
    keyA = drawCallA._key[pc.SORTKEY_FORWARD];
    keyB = drawCallB._key[pc.SORTKEY_FORWARD];
    if (keyA === keyB && drawCallA.mesh && drawCallB.mesh) {
      return drawCallB.mesh.id - drawCallA.mesh.id;
    }
    return keyB - keyA;
  }, depthSortCompare:function(drawCallA, drawCallB) {
    keyA = drawCallA._key[pc.SORTKEY_DEPTH];
    keyB = drawCallB._key[pc.SORTKEY_DEPTH];
    if (keyA === keyB && drawCallA.mesh && drawCallB.mesh) {
      return drawCallB.mesh.id - drawCallA.mesh.id;
    }
    return keyB - keyA;
  }, lightCompare:function(lightA, lightB) {
    return lightA.key - lightB.key;
  }, _isVisible:function(camera, meshInstance) {
    if (!meshInstance.visible) {
      return false;
    }
    meshPos = meshInstance.aabb.center;
    if (meshInstance._aabb._radiusVer !== meshInstance._aabbVer) {
      meshInstance._aabb._radius = meshInstance._aabb.halfExtents.length();
      meshInstance._aabb._radiusVer = meshInstance._aabbVer;
    }
    tempSphere.radius = meshInstance._aabb._radius;
    tempSphere.center = meshPos;
    return camera.frustum.containsSphere(tempSphere);
  }, getShadowCamera:function(device, light) {
    var shadowCam = light._shadowCamera;
    var shadowBuffer;
    if (shadowCam === null) {
      shadowCam = light._shadowCamera = createShadowCamera(device, light._shadowType, light._type);
      createShadowBuffer(device, light);
    } else {
      shadowBuffer = shadowCam.renderTarget;
      if (shadowBuffer.width !== light._shadowResolution || shadowBuffer.height !== light._shadowResolution) {
        createShadowBuffer(device, light);
      }
    }
    return shadowCam;
  }, updateCameraFrustum:function(camera) {
    if (camera.vrDisplay && camera.vrDisplay.presenting) {
      projMat = camera.vrDisplay.combinedProj;
      var parent = camera._node.getParent();
      if (parent) {
        viewMat.copy(parent.getWorldTransform()).mul(camera.vrDisplay.combinedViewInv).invert();
      } else {
        viewMat.copy(camera.vrDisplay.combinedView);
      }
      viewInvMat.copy(viewMat).invert();
      this.viewInvId.setValue(viewInvMat.data);
      camera.frustum.update(projMat, viewMat);
      return;
    }
    projMat = camera.getProjectionMatrix();
    if (camera.overrideCalculateProjection) {
      camera.calculateProjection(projMat, pc.VIEW_CENTER);
    }
    if (camera.overrideCalculateTransform) {
      camera.calculateTransform(viewInvMat, pc.VIEW_CENTER);
    } else {
      var pos = camera._node.getPosition();
      var rot = camera._node.getRotation();
      viewInvMat.setTRS(pos, rot, pc.Vec3.ONE);
      this.viewInvId.setValue(viewInvMat.data);
    }
    viewMat.copy(viewInvMat).invert();
    camera.frustum.update(projMat, viewMat);
  }, setCamera:function(camera, cullBorder) {
    var vrDisplay = camera.vrDisplay;
    if (!vrDisplay || !vrDisplay.presenting) {
      projMat = camera.getProjectionMatrix();
      if (camera.overrideCalculateProjection) {
        camera.calculateProjection(projMat, pc.VIEW_CENTER);
      }
      this.projId.setValue(projMat.data);
      if (camera.overrideCalculateTransform) {
        camera.calculateTransform(viewInvMat, pc.VIEW_CENTER);
      } else {
        var pos = camera._node.getPosition();
        var rot = camera._node.getRotation();
        viewInvMat.setTRS(pos, rot, pc.Vec3.ONE);
      }
      this.viewInvId.setValue(viewInvMat.data);
      viewMat.copy(viewInvMat).invert();
      this.viewId.setValue(viewMat.data);
      mat3FromMat4(viewMat3, viewMat);
      this.viewId3.setValue(viewMat3.data);
      viewProjMat.mul2(projMat, viewMat);
      this.viewProjId.setValue(viewProjMat.data);
      this.viewPosId.setValue(camera._node.getPosition().data);
      camera.frustum.update(projMat, viewMat);
    } else {
      projL = vrDisplay.leftProj;
      projR = vrDisplay.rightProj;
      projMat = vrDisplay.combinedProj;
      if (camera.overrideCalculateProjection) {
        camera.calculateProjection(projL, pc.VIEW_LEFT);
        camera.calculateProjection(projR, pc.VIEW_RIGHT);
        camera.calculateProjection(projMat, pc.VIEW_CENTER);
      }
      if (camera.overrideCalculateTransform) {
        camera.calculateTransform(viewInvL, pc.VIEW_LEFT);
        camera.calculateTransform(viewInvR, pc.VIEW_RIGHT);
        camera.calculateTransform(viewInvMat, pc.VIEW_CENTER);
        viewL.copy(viewInvL).invert();
        viewR.copy(viewInvR).invert();
        viewMat.copy(viewInvMat).invert();
      } else {
        var parent = camera._node.getParent();
        if (parent) {
          var transform = parent.getWorldTransform();
          viewInvL.mul2(transform, vrDisplay.leftViewInv);
          viewInvR.mul2(transform, vrDisplay.rightViewInv);
          viewL.copy(viewInvL).invert();
          viewR.copy(viewInvR).invert();
          viewMat.copy(parent.getWorldTransform()).mul(vrDisplay.combinedViewInv).invert();
        } else {
          viewInvL.copy(vrDisplay.leftViewInv);
          viewInvR.copy(vrDisplay.rightViewInv);
          viewL.copy(vrDisplay.leftView);
          viewR.copy(vrDisplay.rightView);
          viewMat.copy(vrDisplay.combinedView);
        }
      }
      mat3FromMat4(viewMat3L, viewL);
      mat3FromMat4(viewMat3R, viewR);
      viewProjMatL.mul2(projL, viewL);
      viewProjMatR.mul2(projR, viewR);
      viewPosL.data[0] = viewInvL.data[12];
      viewPosL.data[1] = viewInvL.data[13];
      viewPosL.data[2] = viewInvL.data[14];
      viewPosR.data[0] = viewInvR.data[12];
      viewPosR.data[1] = viewInvR.data[13];
      viewPosR.data[2] = viewInvR.data[14];
      camera.frustum.update(projMat, viewMat);
    }
    this.nearClipId.setValue(camera._nearClip);
    this.farClipId.setValue(camera._farClip);
    var device = this.device;
    var target = camera.renderTarget;
    device.setRenderTarget(target);
    device.updateBegin();
    var rect = camera.getRect();
    var pixelWidth = target ? target.width : device.width;
    var pixelHeight = target ? target.height : device.height;
    var x = Math.floor(rect.x * pixelWidth);
    var y = Math.floor(rect.y * pixelHeight);
    var w = Math.floor(rect.width * pixelWidth);
    var h = Math.floor(rect.height * pixelHeight);
    device.setViewport(x, y, w, h);
    device.setScissor(x, y, w, h);
    device.clear(camera._clearOptions);
    rect = camera._scissorRect;
    x = Math.floor(rect.x * pixelWidth);
    y = Math.floor(rect.y * pixelHeight);
    w = Math.floor(rect.width * pixelWidth);
    h = Math.floor(rect.height * pixelHeight);
    device.setScissor(x, y, w, h);
    if (cullBorder) {
      device.setScissor(1, 1, pixelWidth - 2, pixelHeight - 2);
    }
  }, dispatchGlobalLights:function(scene) {
    var i;
    this.mainLight = -1;
    var scope = this.device.scope;
    this.ambientColor[0] = scene.ambientLight.data[0];
    this.ambientColor[1] = scene.ambientLight.data[1];
    this.ambientColor[2] = scene.ambientLight.data[2];
    if (scene.gammaCorrection) {
      for (i = 0;i < 3;i++) {
        this.ambientColor[i] = Math.pow(this.ambientColor[i], 2.2);
      }
    }
    this.ambientId.setValue(this.ambientColor);
    this.exposureId.setValue(scene.exposure);
    if (scene._skyboxModel) {
      this.skyboxIntensityId.setValue(scene.skyboxIntensity);
    }
  }, _resolveLight:function(scope, i) {
    var light = "light" + i;
    this.lightColorId[i] = scope.resolve(light + "_color");
    this.lightDirId[i] = scope.resolve(light + "_direction");
    this.lightShadowMapId[i] = scope.resolve(light + "_shadowMap");
    this.lightShadowMatrixId[i] = scope.resolve(light + "_shadowMatrix");
    this.lightShadowParamsId[i] = scope.resolve(light + "_shadowParams");
    this.lightShadowMatrixVsId[i] = scope.resolve(light + "_shadowMatrixVS");
    this.lightShadowParamsVsId[i] = scope.resolve(light + "_shadowParamsVS");
    this.lightDirVsId[i] = scope.resolve(light + "_directionVS");
    this.lightRadiusId[i] = scope.resolve(light + "_radius");
    this.lightPosId[i] = scope.resolve(light + "_position");
    this.lightInAngleId[i] = scope.resolve(light + "_innerConeAngle");
    this.lightOutAngleId[i] = scope.resolve(light + "_outerConeAngle");
    this.lightPosVsId[i] = scope.resolve(light + "_positionVS");
    this.lightCookieId[i] = scope.resolve(light + "_cookie");
    this.lightCookieIntId[i] = scope.resolve(light + "_cookieIntensity");
    this.lightCookieMatrixId[i] = scope.resolve(light + "_cookieMatrix");
    this.lightCookieOffsetId[i] = scope.resolve(light + "_cookieOffset");
  }, dispatchDirectLights:function(scene, mask) {
    var dirs = scene._globalLights;
    var numDirs = dirs.length;
    var i;
    var directional, wtm;
    var cnt = 0;
    var scope = this.device.scope;
    for (i = 0;i < numDirs;i++) {
      if (!(dirs[i]._mask & mask)) {
        continue;
      }
      directional = dirs[i];
      wtm = directional._node.getWorldTransform();
      if (!this.lightColorId[cnt]) {
        this._resolveLight(scope, cnt);
      }
      this.lightColorId[cnt].setValue(scene.gammaCorrection ? directional._linearFinalColor.data : directional._finalColor.data);
      wtm.getY(directional._direction).scale(-1);
      this.lightDirId[cnt].setValue(directional._direction.normalize().data);
      if (directional.castShadows) {
        var shadowMap = directional._isPcf && this.device.webgl2 ? directional._shadowCamera.renderTarget.depthBuffer : directional._shadowCamera.renderTarget.colorBuffer;
        var bias;
        if (directional._isVsm) {
          bias = -0.00001 * 20;
        } else {
          bias = directional.shadowBias / directional._shadowCamera._farClip * 100;
          if (!this.device.webgl2 && this.device.extStandardDerivatives) {
            bias *= -100;
          }
        }
        var normalBias = directional._isVsm ? directional.vsmBias / (directional._shadowCamera._farClip / 7.0) : directional._normalOffsetBias;
        this.lightShadowMapId[cnt].setValue(shadowMap);
        this.lightShadowMatrixId[cnt].setValue(directional._shadowMatrix.data);
        var params = directional._rendererParams;
        if (params.length !== 3) {
          params.length = 3;
        }
        params[0] = directional._shadowResolution;
        params[1] = normalBias;
        params[2] = bias;
        this.lightShadowParamsId[cnt].setValue(params);
        if (this.mainLight < 0) {
          this.lightShadowMatrixVsId[cnt].setValue(directional._shadowMatrix.data);
          this.lightShadowParamsVsId[cnt].setValue(params);
          this.lightDirVsId[cnt].setValue(directional._direction.normalize().data);
          this.mainLight = i;
        }
      }
      cnt++;
    }
    return cnt;
  }, dispatchPointLight:function(scene, scope, point, cnt) {
    var wtm = point._node.getWorldTransform();
    if (!this.lightColorId[cnt]) {
      this._resolveLight(scope, cnt);
    }
    this.lightRadiusId[cnt].setValue(point.attenuationEnd);
    this.lightColorId[cnt].setValue(scene.gammaCorrection ? point._linearFinalColor.data : point._finalColor.data);
    wtm.getTranslation(point._position);
    this.lightPosId[cnt].setValue(point._position.data);
    if (point.castShadows) {
      var shadowMap = point._shadowCamera.renderTarget.colorBuffer;
      this.lightShadowMapId[cnt].setValue(shadowMap);
      var params = point._rendererParams;
      if (params.length !== 4) {
        params.length = 4;
      }
      params[0] = point._shadowResolution;
      params[1] = point._normalOffsetBias;
      params[2] = point.shadowBias;
      params[3] = 1.0 / point.attenuationEnd;
      this.lightShadowParamsId[cnt].setValue(params);
    }
    if (point._cookie) {
      this.lightCookieId[cnt].setValue(point._cookie);
      this.lightShadowMatrixId[cnt].setValue(wtm.data);
      this.lightCookieIntId[cnt].setValue(point.cookieIntensity);
    }
  }, dispatchSpotLight:function(scene, scope, spot, cnt) {
    var wtm = spot._node.getWorldTransform();
    if (!this.lightColorId[cnt]) {
      this._resolveLight(scope, cnt);
    }
    this.lightInAngleId[cnt].setValue(spot._innerConeAngleCos);
    this.lightOutAngleId[cnt].setValue(spot._outerConeAngleCos);
    this.lightRadiusId[cnt].setValue(spot.attenuationEnd);
    this.lightColorId[cnt].setValue(scene.gammaCorrection ? spot._linearFinalColor.data : spot._finalColor.data);
    wtm.getTranslation(spot._position);
    this.lightPosId[cnt].setValue(spot._position.data);
    wtm.getY(spot._direction).scale(-1);
    this.lightDirId[cnt].setValue(spot._direction.normalize().data);
    if (spot.castShadows) {
      var bias;
      if (spot._isVsm) {
        bias = -0.00001 * 20;
      } else {
        bias = spot.shadowBias * 20;
        if (!this.device.webgl2 && this.device.extStandardDerivatives) {
          bias *= -100;
        }
      }
      var normalBias = spot._isVsm ? spot.vsmBias / (spot.attenuationEnd / 7.0) : spot._normalOffsetBias;
      var shadowMap = spot._isPcf && this.device.webgl2 ? spot._shadowCamera.renderTarget.depthBuffer : spot._shadowCamera.renderTarget.colorBuffer;
      this.lightShadowMapId[cnt].setValue(shadowMap);
      this.lightShadowMatrixId[cnt].setValue(spot._shadowMatrix.data);
      var params = spot._rendererParams;
      if (params.length !== 4) {
        params.length = 4;
      }
      params[0] = spot._shadowResolution;
      params[1] = normalBias;
      params[2] = bias;
      params[3] = 1.0 / spot.attenuationEnd;
      this.lightShadowParamsId[cnt].setValue(params);
      if (this.mainLight < 0) {
        this.lightShadowMatrixVsId[cnt].setValue(spot._shadowMatrix.data);
        this.lightShadowParamsVsId[cnt].setValue(params);
        this.lightPosVsId[cnt].setValue(spot._position.data);
        this.mainLight = i;
      }
    }
    if (spot._cookie) {
      this.lightCookieId[cnt].setValue(spot._cookie);
      if (!spot.castShadows) {
        var shadowCam = this.getShadowCamera(this.device, spot);
        var shadowCamNode = shadowCam._node;
        shadowCamNode.setPosition(spot._node.getPosition());
        shadowCamNode.setRotation(spot._node.getRotation());
        shadowCamNode.rotateLocal(-90, 0, 0);
        shadowCam.projection = pc.PROJECTION_PERSPECTIVE;
        shadowCam.aspectRatio = 1;
        shadowCam.fov = spot._outerConeAngle * 2;
        shadowCamView.setTRS(shadowCamNode.getPosition(), shadowCamNode.getRotation(), pc.Vec3.ONE).invert();
        shadowCamViewProj.mul2(shadowCam.getProjectionMatrix(), shadowCamView);
        spot._shadowMatrix.mul2(scaleShift, shadowCamViewProj);
      }
      this.lightShadowMatrixId[cnt].setValue(spot._shadowMatrix.data);
      this.lightCookieIntId[cnt].setValue(spot.cookieIntensity);
      if (spot._cookieTransform) {
        this.lightCookieMatrixId[cnt].setValue(spot._cookieTransform.data);
        this.lightCookieOffsetId[cnt].setValue(spot._cookieOffset.data);
      }
    }
  }, dispatchLocalLights:function(scene, mask, usedDirLights, staticLightList) {
    var i;
    var point, spot;
    var localLights = scene._localLights;
    var pnts = localLights[pc.LIGHTTYPE_POINT - 1];
    var spts = localLights[pc.LIGHTTYPE_SPOT - 1];
    var numDirs = usedDirLights;
    var numPnts = pnts.length;
    var numSpts = spts.length;
    var cnt = numDirs;
    var scope = this.device.scope;
    for (i = 0;i < numPnts;i++) {
      point = pnts[i];
      if (!(point._mask & mask)) {
        continue;
      }
      if (point.isStatic) {
        continue;
      }
      this.dispatchPointLight(scene, scope, point, cnt);
      cnt++;
    }
    var staticId = 0;
    if (staticLightList) {
      point = staticLightList[staticId];
      while (point && point._type === pc.LIGHTTYPE_POINT) {
        this.dispatchPointLight(scene, scope, point, cnt);
        cnt++;
        staticId++;
        point = staticLightList[staticId];
      }
    }
    for (i = 0;i < numSpts;i++) {
      spot = spts[i];
      if (!(spot._mask & mask)) {
        continue;
      }
      if (spot.isStatic) {
        continue;
      }
      this.dispatchSpotLight(scene, scope, spot, cnt);
      cnt++;
    }
    if (staticLightList) {
      spot = staticLightList[staticId];
      while (spot && spot._type === pc.LIGHTTYPE_SPOT) {
        this.dispatchSpotLight(scene, scope, spot, cnt);
        cnt++;
        staticId++;
        spot = staticLightList[staticId];
      }
    }
  }, cull:function(camera, drawCalls) {
    culled.length = 0;
    var i, drawCall, visible;
    var drawCallsCount = drawCalls.length;
    var cullingMask = camera.cullingMask || 4294967295;
    if (!camera.frustumCulling) {
      for (i = 0;i < drawCallsCount;i++) {
        drawCall = drawCalls[i];
        if (!drawCall.visible && !drawCall.command) {
          continue;
        }
        if (drawCall.mask && (drawCall.mask & cullingMask) === 0) {
          continue;
        }
        culled.push(drawCall);
      }
      return culled;
    }
    for (i = 0;i < drawCallsCount;i++) {
      drawCall = drawCalls[i];
      if (!drawCall.command) {
        if (!drawCall.visible) {
          continue;
        }
        visible = true;
        if (drawCall.mask && (drawCall.mask & cullingMask) === 0) {
          continue;
        }
        if (drawCall.layer > pc.LAYER_FX) {
          if (drawCall.cull) {
            visible = this._isVisible(camera, drawCall);
          }
        }
        if (visible) {
          culled.push(drawCall);
        }
      } else {
        culled.push(drawCall);
      }
    }
    return culled;
  }, calculateSortDistances:function(drawCalls, camPos, camFwd, frontToBack) {
    var i, drawCall, btype, meshPos;
    var tempx, tempy, tempz;
    var drawCallsCount = drawCalls.length;
    for (i = 0;i < drawCallsCount;i++) {
      drawCall = drawCalls[i];
      if (drawCall.command) {
        continue;
      }
      if (drawCall.layer <= pc.scene.LAYER_FX) {
        continue;
      }
      btype = drawCall.material.blendType;
      if (btype !== pc.BLEND_NONE) {
        meshPos = drawCall.aabb.center.data;
        tempx = meshPos[0] - camPos[0];
        tempy = meshPos[1] - camPos[1];
        tempz = meshPos[2] - camPos[2];
        drawCall.zdist = tempx * camFwd[0] + tempy * camFwd[1] + tempz * camFwd[2];
      } else {
        if (drawCall.material.alphaTest || drawCall.material.alphaToCoverage) {
          drawCall.zdist = Number.MAX_VALUE;
        } else {
          if (drawCall.zdist !== undefined) {
            delete drawCall.zdist;
          }
        }
      }
      if (frontToBack && btype === pc.BLEND_NONE) {
        meshPos = drawCall.aabb.center.data;
        tempx = meshPos[0] - camPos[0];
        tempy = meshPos[1] - camPos[1];
        tempz = meshPos[2] - camPos[2];
        drawCall.zdist2 = tempx * camFwd[0] + tempy * camFwd[1] + tempz * camFwd[2];
      }
    }
  }, updateCpuSkinMatrices:function(drawCalls) {
    var drawCallsCount = drawCalls.length;
    if (drawCallsCount === 0) {
      return;
    }
    var i, skin;
    for (i = 0;i < drawCallsCount;i++) {
      skin = drawCalls[i].skinInstance;
      if (skin) {
        skin.updateMatrices();
        skin._dirty = true;
      }
    }
  }, updateGpuSkinMatrices:function(drawCalls) {
    var i, skin;
    var drawCallsCount = drawCalls.length;
    for (i = 0;i < drawCallsCount;i++) {
      skin = drawCalls[i].skinInstance;
      if (skin) {
        if (skin._dirty) {
          skin.updateMatrixPalette();
          skin._dirty = false;
        }
      }
    }
  }, updateMorphedBounds:function(drawCalls) {
    var i, morph;
    var drawCallsCount = drawCalls.length;
    for (i = 0;i < drawCallsCount;i++) {
      morph = drawCalls[i].morphInstance;
      if (morph && morph._dirty) {
        morph.updateBounds(drawCalls[i].mesh);
      }
    }
  }, updateMorphing:function(drawCalls) {
    var i, morph;
    var drawCallsCount = drawCalls.length;
    for (i = 0;i < drawCallsCount;i++) {
      morph = drawCalls[i].morphInstance;
      if (morph && morph._dirty) {
        morph.update(drawCalls[i].mesh);
        morph._dirty = false;
      }
    }
  }, sortDrawCalls:function(drawCalls, sortFunc, keyType) {
    var drawCallsCount = drawCalls.length;
    if (drawCallsCount === 0) {
      return;
    }
    drawCalls.sort(sortFunc);
  }, prepareInstancing:function(device, drawCalls, keyType, shaderType) {
    if (!device.extInstancing) {
      return;
    }
    var drawCallsCount = drawCalls.length;
    var i, j, meshInstance, mesh, next, autoInstances, key, data;
    var offset = 0;
    if (device.enableAutoInstancing) {
      for (i = 0;i < drawCallsCount - 1;i++) {
        meshInstance = drawCalls[i];
        mesh = meshInstance.mesh;
        key = meshInstance._key[keyType];
        next = i + 1;
        autoInstances = 0;
        if (drawCalls[next].mesh === mesh && drawCalls[next]._key[keyType] === key) {
          for (j = 0;j < 16;j++) {
            pc._autoInstanceBufferData[offset + j] = meshInstance.node.worldTransform.data[j];
          }
          autoInstances = 1;
          while (next !== drawCallsCount && drawCalls[next].mesh === mesh && drawCalls[next]._key[keyType] === key) {
            for (j = 0;j < 16;j++) {
              pc._autoInstanceBufferData[offset + autoInstances * 16 + j] = drawCalls[next].node.worldTransform.data[j];
            }
            autoInstances++;
            next++;
          }
          data = meshInstance.instancingData;
          if (!data) {
            meshInstance.instancingData = data = {};
          }
          data.count = autoInstances;
          data.offset = offset * 4;
          data._buffer = pc._autoInstanceBuffer;
          i = next - 1;
        }
        offset += autoInstances * 16;
      }
      if (offset > 0) {
        pc._autoInstanceBuffer.unlock();
      }
    }
    for (i = 0;i < drawCallsCount;i++) {
      meshInstance = drawCalls[i];
      if (meshInstance.instancingData) {
        if (!(meshInstance._shaderDefs & pc.SHADERDEF_INSTANCING)) {
          meshInstance._shaderDefs |= pc.SHADERDEF_INSTANCING;
          meshInstance._shader[shaderType] = null;
        }
        if (!meshInstance.instancingData._buffer) {
          meshInstance.instancingData._buffer = new pc.VertexBuffer(device, pc._instanceVertexFormat, meshInstance.instancingData.count, meshInstance.instancingData.usage, meshInstance.instancingData.buffer);
        }
      } else {
        if (meshInstance._shaderDefs & pc.SHADERDEF_INSTANCING) {
          meshInstance._shaderDefs &= ~pc.SHADERDEF_INSTANCING;
          meshInstance._shader[shaderType] = null;
        }
      }
    }
  }, setBaseConstants:function(device, material) {
    device.setCullMode(material.cull);
    if (material.opacityMap) {
      this.opacityMapId.setValue(material.opacityMap);
      this.alphaTestId.setValue(material.alphaTest);
    }
  }, setSkinning:function(device, meshInstance, material) {
    if (meshInstance.skinInstance) {
      this._skinDrawCalls++;
      this.skinPosOffsetId.setValue(meshInstance.skinInstance.rootNode.getPosition().data);
      if (device.supportsBoneTextures) {
        boneTexture = meshInstance.skinInstance.boneTexture;
        this.boneTextureId.setValue(boneTexture);
        boneTextureSize[0] = boneTexture.width;
        boneTextureSize[1] = boneTexture.height;
        this.boneTextureSizeId.setValue(boneTextureSize);
      } else {
        this.poseMatrixId.setValue(meshInstance.skinInstance.matrixPalette);
      }
    }
  }, drawInstance:function(device, meshInstance, mesh, style, normal) {
    instancingData = meshInstance.instancingData;
    if (instancingData) {
      this._instancedDrawCalls++;
      this._removedByInstancing += instancingData.count;
      device.setVertexBuffer(instancingData._buffer, 1, instancingData.offset);
      device.draw(mesh.primitive[style], instancingData.count);
      if (instancingData._buffer === pc._autoInstanceBuffer) {
        meshInstance.instancingData = null;
        return instancingData.count - 1;
      }
    } else {
      modelMatrix = meshInstance.node.worldTransform;
      this.modelMatrixId.setValue(modelMatrix.data);
      if (normal) {
        normalMatrix = meshInstance.node.normalMatrix;
        if (meshInstance.node._dirtyNormal) {
          modelMatrix.invertTo3x3(normalMatrix);
          normalMatrix.transpose();
          meshInstance.node._dirtyNormal = false;
        }
        this.normalMatrixId.setValue(normalMatrix.data);
      }
      device.draw(mesh.primitive[style]);
      return 0;
    }
  }, drawInstance2:function(device, meshInstance, mesh, style) {
    instancingData = meshInstance.instancingData;
    if (instancingData) {
      this._instancedDrawCalls++;
      this._removedByInstancing += instancingData.count;
      device.setVertexBuffer(instancingData._buffer, 1, instancingData.offset);
      device.draw(mesh.primitive[style], instancingData.count);
      if (instancingData._buffer === pc._autoInstanceBuffer) {
        meshInstance.instancingData = null;
        return instancingData.count - 1;
      }
    } else {
      device.draw(mesh.primitive[style]);
      return 0;
    }
  }, findShadowShader:function(meshInstance, type, shadowType, scene) {
    if (shadowType >= numShadowModes) {
      shadowType -= numShadowModes;
    }
    var material = meshInstance.material;
    var smode = shadowType + type * numShadowModes;
    if (!material.shader) {
      material.updateShader(this.device, scene, meshInstance._shaderDefs, meshInstance._staticLightList);
    }
    return this.library.getProgram("depthrgba", {skin:!!meshInstance.skinInstance, opacityMap:!!material.opacityMap, opacityChannel:material.opacityMap ? material.opacityMapChannel || "r" : null, shadowType:shadowType, instancing:meshInstance.instancingData, type:type, chunks:material.chunks, attributes:material.shader.definition.attributes});
  }, renderShadows:function(device, camera, drawCalls, lights, scene) {
    var i, j, light, shadowShader, type, shadowCam, shadowCamNode, lightNode, passes, pass, frustumSize, shadowType, smode;
    var unitPerTexel, delta, p;
    var minx, miny, minz, maxx, maxy, maxz, centerx, centery;
    var opChan;
    var visible, cullTime, numInstances;
    var meshInstance, mesh, material;
    var style;
    var emptyAabb;
    var drawCallAabb;
    var passFlag = 1 << pc.SHADER_SHADOW;
    var paramName, parameter, parameters;
    for (i = 0;i < lights.length;i++) {
      light = lights[i];
      type = light._type;
      if (light.castShadows && light._enabled && light.shadowUpdateMode !== pc.SHADOWUPDATE_NONE) {
        shadowCam = this.getShadowCamera(device, light);
        shadowCamNode = shadowCam._node;
        lightNode = light._node;
        passes = 1;
        shadowCamNode.setPosition(lightNode.getPosition());
        shadowCamNode.setRotation(lightNode.getRotation());
        shadowCamNode.rotateLocal(-90, 0, 0);
        if (type === pc.LIGHTTYPE_DIRECTIONAL) {
          _getFrustumPoints(camera, light.shadowDistance || camera._farClip, frustumPoints);
          frustumSize = frustumDiagonal.sub2(frustumPoints[0], frustumPoints[6]).length();
          frustumSize = Math.max(frustumSize, frustumDiagonal.sub2(frustumPoints[4], frustumPoints[6]).length());
          shadowCamView.copy(shadowCamNode.getWorldTransform()).invert();
          c2sc.copy(shadowCamView).mul(camera._node.worldTransform);
          for (j = 0;j < 8;j++) {
            c2sc.transformPoint(frustumPoints[j], frustumPoints[j]);
          }
          minx = miny = minz = 1000000;
          maxx = maxy = maxz = -1000000;
          for (j = 0;j < 8;j++) {
            p = frustumPoints[j];
            if (p.x < minx) {
              minx = p.x;
            }
            if (p.x > maxx) {
              maxx = p.x;
            }
            if (p.y < miny) {
              miny = p.y;
            }
            if (p.y > maxy) {
              maxy = p.y;
            }
            if (p.z < minz) {
              minz = p.z;
            }
            if (p.z > maxz) {
              maxz = p.z;
            }
          }
          unitPerTexel = frustumSize / light._shadowResolution;
          delta = (frustumSize - (maxx - minx)) * 0.5;
          minx = Math.floor((minx - delta) / unitPerTexel) * unitPerTexel;
          delta = (frustumSize - (maxy - miny)) * 0.5;
          miny = Math.floor((miny - delta) / unitPerTexel) * unitPerTexel;
          maxx = minx + frustumSize;
          maxy = miny + frustumSize;
          centerx = (maxx + minx) * 0.5;
          centery = (maxy + miny) * 0.5;
          shadowCamNode.translateLocal(centerx, centery, 100000);
          shadowCam.projection = pc.PROJECTION_ORTHOGRAPHIC;
          shadowCam.nearClip = 0;
          shadowCam.farClip = 200000;
          shadowCam.aspectRatio = 1;
          shadowCam.orthoHeight = frustumSize * 0.5;
        } else {
          if (type === pc.LIGHTTYPE_SPOT) {
            if (camera.frustumCulling && light.shadowUpdateMode === pc.SHADOWUPDATE_REALTIME) {
              light.getBoundingSphere(tempSphere);
              if (!camera.frustum.containsSphere(tempSphere)) {
                continue;
              }
            }
            shadowCam.projection = pc.PROJECTION_PERSPECTIVE;
            shadowCam.nearClip = light.attenuationEnd / 1000;
            shadowCam.farClip = light.attenuationEnd;
            shadowCam.aspectRatio = 1;
            shadowCam.fov = light._outerConeAngle * 2;
            this.viewPosId.setValue(shadowCamNode.getPosition().data);
            this.shadowMapLightRadiusId.setValue(light.attenuationEnd);
          } else {
            if (type === pc.LIGHTTYPE_POINT) {
              if (camera.frustumCulling && light.shadowUpdateMode === pc.SHADOWUPDATE_REALTIME) {
                light.getBoundingSphere(tempSphere);
                if (!camera.frustum.containsSphere(tempSphere)) {
                  continue;
                }
              }
              shadowCam.projection = pc.PROJECTION_PERSPECTIVE;
              shadowCam.nearClip = light.attenuationEnd / 1000;
              shadowCam.farClip = light.attenuationEnd;
              shadowCam.aspectRatio = 1;
              shadowCam.fov = 90;
              passes = 6;
              this.viewPosId.setValue(shadowCamNode.getPosition().data);
              this.shadowMapLightRadiusId.setValue(light.attenuationEnd);
            }
          }
        }
        if (device.webgl2) {
          if (type === pc.LIGHTTYPE_POINT) {
            device.setDepthBias(false);
          } else {
            device.setDepthBias(true);
            device.setDepthBiasValues(light.shadowBias * -1000.0, light.shadowBias * -1000.0);
          }
        } else {
          if (device.extStandardDerivatives) {
            if (type === pc.LIGHTTYPE_POINT) {
              this.polygonOffset[0] = 0;
              this.polygonOffset[1] = 0;
              this.polygonOffsetId.setValue(this.polygonOffset);
            } else {
              this.polygonOffset[0] = light.shadowBias * -1000.0;
              this.polygonOffset[1] = light.shadowBias * -1000.0;
              this.polygonOffsetId.setValue(this.polygonOffset);
            }
          }
        }
        if (light.shadowUpdateMode === pc.SHADOWUPDATE_THISFRAME) {
          light.shadowUpdateMode = pc.SHADOWUPDATE_NONE;
        }
        this._shadowMapUpdates += passes;
        for (pass = 0;pass < passes;pass++) {
          device.setBlending(false);
          device.setDepthWrite(true);
          device.setDepthTest(true);
          if (light._isPcf && device.webgl2 && type !== pc.LIGHTTYPE_POINT) {
            device.setColorWrite(false, false, false, false);
          } else {
            device.setColorWrite(true, true, true, true);
          }
          if (type === pc.LIGHTTYPE_POINT) {
            if (pass === 0) {
              shadowCamNode.setEulerAngles(0, 90, 180);
            } else {
              if (pass === 1) {
                shadowCamNode.setEulerAngles(0, -90, 180);
              } else {
                if (pass === 2) {
                  shadowCamNode.setEulerAngles(90, 0, 0);
                } else {
                  if (pass === 3) {
                    shadowCamNode.setEulerAngles(-90, 0, 0);
                  } else {
                    if (pass === 4) {
                      shadowCamNode.setEulerAngles(0, 180, 180);
                    } else {
                      if (pass === 5) {
                        shadowCamNode.setEulerAngles(0, 0, 180);
                      }
                    }
                  }
                }
              }
            }
            shadowCamNode.setPosition(lightNode.getPosition());
            shadowCam.renderTarget = light._shadowCubeMap[pass];
          }
          this.setCamera(shadowCam, type !== pc.LIGHTTYPE_POINT);
          culled.length = 0;
          for (j = 0, numInstances = drawCalls.length;j < numInstances;j++) {
            meshInstance = drawCalls[j];
            visible = true;
            if (meshInstance.cull) {
              visible = this._isVisible(shadowCam, meshInstance);
            }
            if (visible) {
              culled.push(meshInstance);
            }
          }
          this.updateGpuSkinMatrices(culled);
          this.updateMorphing(culled);
          shadowType = light._shadowType;
          smode = shadowType + type * numShadowModes;
          this.sortDrawCalls(culled, this.depthSortCompare, pc.SORTKEY_DEPTH);
          this.prepareInstancing(device, culled, pc.SORTKEY_DEPTH, pc.SHADER_SHADOW + smode);
          if (type === pc.LIGHTTYPE_DIRECTIONAL) {
            emptyAabb = true;
            for (j = 0;j < culled.length;j++) {
              meshInstance = culled[j];
              drawCallAabb = meshInstance.aabb;
              if (emptyAabb) {
                visibleSceneAabb.copy(drawCallAabb);
                emptyAabb = false;
              } else {
                visibleSceneAabb.add(drawCallAabb);
              }
            }
            var z = _getZFromAABBSimple(shadowCamView, visibleSceneAabb.getMin(), visibleSceneAabb.getMax(), minx, maxx, miny, maxy);
            maxz = z.max;
            if (z.min > minz) {
              minz = z.min;
            }
            shadowCamNode.setPosition(lightNode.getPosition());
            shadowCamNode.translateLocal(centerx, centery, maxz + directionalShadowEpsilon);
            shadowCam.farClip = maxz - minz;
            this.setCamera(shadowCam, true);
          }
          if (type !== pc.LIGHTTYPE_POINT) {
            shadowCamView.setTRS(shadowCamNode.getPosition(), shadowCamNode.getRotation(), pc.Vec3.ONE).invert();
            shadowCamViewProj.mul2(shadowCam.getProjectionMatrix(), shadowCamView);
            light._shadowMatrix.mul2(scaleShift, shadowCamViewProj);
          }
          for (j = 0, numInstances = culled.length;j < numInstances;j++) {
            meshInstance = culled[j];
            mesh = meshInstance.mesh;
            material = meshInstance.material;
            this.setBaseConstants(device, material);
            this.setSkinning(device, meshInstance, material);
            if (material.chunks) {
              parameters = material.parameters;
              for (paramName in parameters) {
                parameter = parameters[paramName];
                if (parameter.passFlags & passFlag) {
                  if (!parameter.scopeId) {
                    parameter.scopeId = device.scope.resolve(paramName);
                  }
                  parameter.scopeId.setValue(parameter.data);
                }
              }
              parameters = meshInstance.parameters;
              for (paramName in parameters) {
                parameter = parameters[paramName];
                if (parameter.passFlags & passFlag) {
                  if (!parameter.scopeId) {
                    parameter.scopeId = device.scope.resolve(paramName);
                  }
                  parameter.scopeId.setValue(parameter.data);
                }
              }
            }
            shadowShader = meshInstance._shader[pc.SHADER_SHADOW + smode];
            if (!shadowShader) {
              shadowShader = this.findShadowShader(meshInstance, type, shadowType, scene);
              meshInstance._shader[pc.SHADER_SHADOW + smode] = shadowShader;
              meshInstance._key[pc.SORTKEY_DEPTH] = getDepthKey(meshInstance);
            }
            device.setShader(shadowShader);
            style = meshInstance.renderStyle;
            device.setVertexBuffer(meshInstance.morphInstance && meshInstance.morphInstance._vertexBuffer ? meshInstance.morphInstance._vertexBuffer : mesh.vertexBuffer, 0);
            device.setIndexBuffer(mesh.indexBuffer[style]);
            j += this.drawInstance(device, meshInstance, mesh, style);
            this._shadowDrawCalls++;
          }
        }
        if (light._isVsm) {
          var filterSize = light._vsmBlurSize;
          if (filterSize > 1) {
            var origShadowMap = shadowCam.renderTarget;
            var tempRt = getShadowMapFromCache(device, light._shadowResolution, light._shadowType, 1);
            var blurMode = light.vsmBlurMode;
            var blurShader = (light._shadowType === pc.SHADOW_VSM8 ? this.blurPackedVsmShader : this.blurVsmShader)[blurMode][filterSize];
            if (!blurShader) {
              this.blurVsmWeights[filterSize] = gaussWeights(filterSize);
              var chunks = pc.shaderChunks;
              (light._shadowType === pc.SHADOW_VSM8 ? this.blurPackedVsmShader : this.blurVsmShader)[blurMode][filterSize] = blurShader = chunks.createShaderFromCode(this.device, chunks.fullscreenQuadVS, "#define SAMPLES " + filterSize + "\n" + (light._shadowType === pc.SHADOW_VSM8 ? this.blurPackedVsmShaderCode : this.blurVsmShaderCode)[blurMode], "blurVsm" + blurMode + "" + filterSize + "" + (light._shadowType === pc.SHADOW_VSM8));
            }
            blurScissorRect.z = light._shadowResolution - 2;
            blurScissorRect.w = blurScissorRect.z;
            this.sourceId.setValue(origShadowMap.colorBuffer);
            pixelOffset.x = 1.0 / light._shadowResolution;
            pixelOffset.y = 0.0;
            this.pixelOffsetId.setValue(pixelOffset.data);
            if (blurMode === pc.BLUR_GAUSSIAN) {
              this.weightId.setValue(this.blurVsmWeights[filterSize]);
            }
            pc.drawQuadWithShader(device, tempRt, blurShader, null, blurScissorRect);
            this.sourceId.setValue(tempRt.colorBuffer);
            pixelOffset.y = pixelOffset.x;
            pixelOffset.x = 0.0;
            this.pixelOffsetId.setValue(pixelOffset.data);
            pc.drawQuadWithShader(device, origShadowMap, blurShader, null, blurScissorRect);
          }
        }
      }
    }
    if (device.webgl2) {
      device.setDepthBias(false);
    } else {
      if (device.extStandardDerivatives) {
        this.polygonOffset[0] = 0;
        this.polygonOffset[1] = 0;
        this.polygonOffsetId.setValue(this.polygonOffset);
      }
    }
  }, findDepthShader:function(meshInstance) {
    var material = meshInstance.material;
    return this.library.getProgram("depth", {skin:!!meshInstance.skinInstance, opacityMap:!!material.opacityMap, opacityChannel:material.opacityMap ? material.opacityMapChannel || "r" : null, instancing:meshInstance.instancingData});
  }, filterDepthMapDrawCalls:function(drawCalls) {
    filtered.length = 0;
    var meshInstance;
    for (var i = 0;i < drawCalls.length;i++) {
      meshInstance = drawCalls[i];
      if (!meshInstance.command && meshInstance.drawToDepth && meshInstance.material.blendType === pc.BLEND_NONE) {
        filtered.push(meshInstance);
      }
    }
    return filtered;
  }, renderDepth:function(device, camera, drawCalls) {
    if (camera._renderDepthRequests) {
      var i;
      var shadowType;
      var rect = camera._rect;
      var target = camera.renderTarget;
      var width = target ? target.width : device.width;
      var height = target ? target.height : device.height;
      width = Math.floor(rect.width * width);
      height = Math.floor(rect.height * height);
      var meshInstance, mesh, material, style, depthShader;
      var vrDisplay = camera.vrDisplay;
      var halfWidth = device.width * 0.5;
      drawCalls = this.filterDepthMapDrawCalls(drawCalls);
      var drawCallsCount = drawCalls.length;
      this.sortDrawCalls(drawCalls, this.depthSortCompare, pc.SORTKEY_DEPTH);
      this.prepareInstancing(device, drawCalls, pc.SORTKEY_DEPTH, pc.SHADER_DEPTH);
      if (camera._depthTarget && (camera._depthTarget.width !== width || camera._depthTarget.height !== height)) {
        camera._depthTarget.destroy();
        camera._depthTarget = null;
      }
      if (!camera._depthTarget) {
        var colorBuffer = new pc.Texture(device, {format:pc.PIXELFORMAT_R8_G8_B8_A8, width:width, height:height});
        colorBuffer.minFilter = pc.FILTER_NEAREST;
        colorBuffer.magFilter = pc.FILTER_NEAREST;
        colorBuffer.addressU = pc.ADDRESS_CLAMP_TO_EDGE;
        colorBuffer.addressV = pc.ADDRESS_CLAMP_TO_EDGE;
        camera._depthTarget = new pc.RenderTarget(device, colorBuffer, {depth:true, stencil:device.supportsStencil});
      }
      device.setBlending(false);
      device.setColorWrite(true, true, true, true);
      device.setDepthWrite(true);
      device.setDepthTest(true);
      var oldTarget = camera.renderTarget;
      var oldClear = camera._clearOptions;
      camera.renderTarget = camera._depthTarget;
      camera._clearOptions = rgbaDepthClearOptions;
      this.setCamera(camera);
      for (i = 0;i < drawCallsCount;i++) {
        meshInstance = drawCalls[i];
        mesh = meshInstance.mesh;
        material = meshInstance.material;
        if (camera._cullFaces) {
          if (camera._flipFaces) {
            device.setCullMode(material.cull > 0 ? material.cull === pc.CULLFACE_FRONT ? pc.CULLFACE_BACK : pc.CULLFACE_FRONT : 0);
          } else {
            device.setCullMode(material.cull);
          }
        } else {
          device.setCullMode(pc.CULLFACE_NONE);
        }
        if (material.opacityMap) {
          this.opacityMapId.setValue(material.opacityMap);
          this.alphaTestId.setValue(material.alphaTest);
        }
        this.setSkinning(device, meshInstance, material);
        depthShader = meshInstance._shader[pc.SHADER_DEPTH];
        if (!depthShader) {
          depthShader = this.findDepthShader(meshInstance);
          meshInstance._shader[pc.SHADER_DEPTH] = depthShader;
          meshInstance._key[pc.SORTKEY_DEPTH] = getDepthKey(meshInstance);
        }
        device.setShader(depthShader);
        style = meshInstance.renderStyle;
        device.setVertexBuffer(meshInstance.morphInstance && meshInstance.morphInstance._vertexBuffer ? meshInstance.morphInstance._vertexBuffer : mesh.vertexBuffer, 0);
        device.setIndexBuffer(mesh.indexBuffer[style]);
        if (vrDisplay && vrDisplay.presenting) {
          device.setViewport(0, 0, halfWidth, device.height);
          this.viewProjId.setValue(viewProjMatL.data);
          this.viewPosId.setValue(viewPosL.data);
          i += this.drawInstance(device, meshInstance, mesh, style, true);
          this._depthDrawCalls++;
          device.setViewport(halfWidth, 0, halfWidth, device.height);
          this.viewProjId.setValue(viewProjMatR.data);
          this.viewPosId.setValue(viewPosR.data);
          i += this.drawInstance2(device, meshInstance, mesh, style);
          this._depthDrawCalls++;
        } else {
          i += this.drawInstance(device, meshInstance, mesh, style);
          this._depthDrawCalls++;
        }
      }
      camera.renderTarget = oldTarget;
      camera._clearOptions = oldClear;
    } else {
      if (camera._depthTarget) {
        camera._depthTarget.destroy();
        camera._depthTarget = null;
      }
    }
  }, renderForward:function(device, camera, drawCalls, scene, pass) {
    var passFlag = 1 << pass;
    var drawCallsCount = drawCalls.length;
    var vrDisplay = camera.vrDisplay;
    this.sortDrawCalls(drawCalls, this.frontToBack ? this.sortCompare : this.sortCompareMesh, pc.SORTKEY_FORWARD);
    this.prepareInstancing(device, drawCalls, pc.SORTKEY_FORWARD, pass);
    var i, drawCall, mesh, material, objDefs, variantKey, lightMask, style, usedDirLights;
    var prevMeshInstance = null, prevMaterial = null, prevObjDefs, prevLightMask, prevStatic;
    var paramName, parameter, parameters;
    var stencilFront, stencilBack;
    device.setColorWrite(true, true, true, true);
    this.setCamera(camera);
    this.dispatchGlobalLights(scene);
    if (scene.fog !== pc.FOG_NONE) {
      this.fogColor[0] = scene.fogColor.data[0];
      this.fogColor[1] = scene.fogColor.data[1];
      this.fogColor[2] = scene.fogColor.data[2];
      if (scene.gammaCorrection) {
        for (i = 0;i < 3;i++) {
          this.fogColor[i] = Math.pow(this.fogColor[i], 2.2);
        }
      }
      this.fogColorId.setValue(this.fogColor);
      if (scene.fog === pc.FOG_LINEAR) {
        this.fogStartId.setValue(scene.fogStart);
        this.fogEndId.setValue(scene.fogEnd);
      } else {
        this.fogDensityId.setValue(scene.fogDensity);
      }
    }
    this._screenSize.x = device.width;
    this._screenSize.y = device.height;
    this._screenSize.z = 1.0 / device.width;
    this._screenSize.w = 1.0 / device.height;
    this.screenSizeId.setValue(this._screenSize.data);
    var halfWidth = device.width * 0.5;
    if (camera._depthTarget) {
      this.depthMapId.setValue(camera._depthTarget.colorBuffer);
    }
    for (i = 0;i < drawCallsCount;i++) {
      drawCall = drawCalls[i];
      if (drawCall.command) {
        drawCall.command();
      } else {
        mesh = drawCall.mesh;
        material = drawCall.material;
        objDefs = drawCall._shaderDefs;
        lightMask = drawCall.mask;
        this.setSkinning(device, drawCall, material);
        if (material && material === prevMaterial && objDefs !== prevObjDefs) {
          prevMaterial = null;
        }
        if (drawCall.isStatic || prevStatic) {
          prevMaterial = null;
        }
        if (material !== prevMaterial) {
          this._materialSwitches++;
          if (!drawCall._shader[pass] || drawCall._shaderDefs !== objDefs) {
            if (!drawCall.isStatic) {
              variantKey = pass + "_" + objDefs;
              drawCall._shader[pass] = material.variants[variantKey];
              if (!drawCall._shader[pass]) {
                material.updateShader(device, scene, objDefs, null, pass);
                drawCall._shader[pass] = material.variants[variantKey] = material.shader;
              }
            } else {
              material.updateShader(device, scene, objDefs, drawCall._staticLightList, pass);
              drawCall._shader[pass] = material.shader;
            }
            drawCall._shaderDefs = objDefs;
          }
          device.setShader(drawCall._shader[pass]);
          parameters = material.parameters;
          for (paramName in parameters) {
            parameter = parameters[paramName];
            if (parameter.passFlags & passFlag) {
              if (!parameter.scopeId) {
                parameter.scopeId = device.scope.resolve(paramName);
              }
              parameter.scopeId.setValue(parameter.data);
            }
          }
          if (!prevMaterial || lightMask !== prevLightMask) {
            usedDirLights = this.dispatchDirectLights(scene, lightMask);
            this.dispatchLocalLights(scene, lightMask, usedDirLights, drawCall._staticLightList);
          }
          this.alphaTestId.setValue(material.alphaTest);
          device.setBlending(material.blend);
          if (material.blend) {
            if (material.separateAlphaBlend) {
              device.setBlendFunctionSeparate(material.blendSrc, material.blendDst, material.blendSrcAlpha, material.blendDstAlpha);
              device.setBlendEquationSeparate(material.blendEquation, material.blendAlphaEquation);
            } else {
              device.setBlendFunction(material.blendSrc, material.blendDst);
              device.setBlendEquation(material.blendEquation);
            }
          }
          device.setColorWrite(material.redWrite, material.greenWrite, material.blueWrite, material.alphaWrite);
          if (camera._cullFaces) {
            if (camera._flipFaces) {
              device.setCullMode(material.cull > 0 ? material.cull === pc.CULLFACE_FRONT ? pc.CULLFACE_BACK : pc.CULLFACE_FRONT : 0);
            } else {
              device.setCullMode(material.cull);
            }
          } else {
            device.setCullMode(pc.CULLFACE_NONE);
          }
          device.setDepthWrite(material.depthWrite);
          device.setDepthTest(material.depthTest);
          device.setAlphaToCoverage(material.alphaToCoverage);
          stencilFront = material.stencilFront;
          stencilBack = material.stencilBack;
          if (stencilFront || stencilBack) {
            device.setStencilTest(true);
            if (stencilFront === stencilBack) {
              device.setStencilFunc(stencilFront.func, stencilFront.ref, stencilFront.readMask);
              device.setStencilOperation(stencilFront.fail, stencilFront.zfail, stencilFront.zpass, stencilFront.writeMask);
            } else {
              if (stencilFront) {
                device.setStencilFuncFront(stencilFront.func, stencilFront.ref, stencilFront.readMask);
                device.setStencilOperationFront(stencilFront.fail, stencilFront.zfail, stencilFront.zpass, stencilFront.writeMask);
              } else {
                device.setStencilFuncFront(pc.FUNC_ALWAYS, 0, 255);
                device.setStencilOperationFront(pc.STENCILOP_KEEP, pc.STENCILOP_KEEP, pc.STENCILOP_KEEPP, 255);
              }
              if (stencilBack) {
                device.setStencilFuncBack(stencilBack.func, stencilBack.ref, stencilBack.readMask);
                device.setStencilOperationBack(stencilBack.fail, stencilBack.zfail, stencilBack.zpass, stencilBack.writeMask);
              } else {
                device.setStencilFuncBack(pc.FUNC_ALWAYS, 0, 255);
                device.setStencilOperationBack(pc.STENCILOP_KEEP, pc.STENCILOP_KEEP, pc.STENCILOP_KEEP, 255);
              }
            }
          } else {
            device.setStencilTest(false);
          }
        }
        parameters = drawCall.parameters;
        for (paramName in parameters) {
          parameter = parameters[paramName];
          if (parameter.passFlags & passFlag) {
            if (!parameter.scopeId) {
              parameter.scopeId = device.scope.resolve(paramName);
            }
            parameter.scopeId.setValue(parameter.data);
          }
        }
        device.setVertexBuffer(drawCall.morphInstance && drawCall.morphInstance._vertexBuffer ? drawCall.morphInstance._vertexBuffer : mesh.vertexBuffer, 0);
        style = drawCall.renderStyle;
        device.setIndexBuffer(mesh.indexBuffer[style]);
        if (vrDisplay && vrDisplay.presenting) {
          device.setViewport(0, 0, halfWidth, device.height);
          this.projId.setValue(projL.data);
          this.viewInvId.setValue(viewInvL.data);
          this.viewId.setValue(viewL.data);
          this.viewId3.setValue(viewMat3L.data);
          this.viewProjId.setValue(viewProjMatL.data);
          this.viewPosId.setValue(viewPosL.data);
          i += this.drawInstance(device, drawCall, mesh, style, true);
          this._forwardDrawCalls++;
          device.setViewport(halfWidth, 0, halfWidth, device.height);
          this.projId.setValue(projR.data);
          this.viewInvId.setValue(viewInvR.data);
          this.viewId.setValue(viewR.data);
          this.viewId3.setValue(viewMat3R.data);
          this.viewProjId.setValue(viewProjMatR.data);
          this.viewPosId.setValue(viewPosR.data);
          i += this.drawInstance2(device, drawCall, mesh, style);
          this._forwardDrawCalls++;
        } else {
          i += this.drawInstance(device, drawCall, mesh, style, true);
          this._forwardDrawCalls++;
        }
        if (i < drawCallsCount - 1 && drawCalls[i + 1].material === material) {
          for (paramName in parameters) {
            parameter = material.parameters[paramName];
            if (parameter) {
              parameter.scopeId.setValue(parameter.data);
            }
          }
        }
        prevMaterial = material;
        prevMeshInstance = drawCall;
        prevObjDefs = objDefs;
        prevLightMask = lightMask;
        prevStatic = drawCall.isStatic;
      }
    }
    device.setStencilTest(false);
    device.setAlphaToCoverage(false);
    device.updateEnd();
  }, sortLights:function(scene) {
    var light;
    var lights = scene._lights;
    scene._globalLights.length = 0;
    scene._localLights[0].length = 0;
    scene._localLights[1].length = 0;
    for (i = 0;i < lights.length;i++) {
      light = lights[i];
      if (light._enabled) {
        if (light._type === pc.LIGHTTYPE_DIRECTIONAL) {
          scene._globalLights.push(light);
        } else {
          scene._localLights[light._type === pc.LIGHTTYPE_POINT ? 0 : 1].push(light);
        }
      }
    }
    return lights;
  }, setupInstancing:function(device) {
    if (!pc._instanceVertexFormat) {
      var formatDesc = [{semantic:pc.SEMANTIC_TEXCOORD2, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_TEXCOORD3, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_TEXCOORD4, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_TEXCOORD5, components:4, type:pc.TYPE_FLOAT32}];
      pc._instanceVertexFormat = new pc.VertexFormat(device, formatDesc);
    }
    if (device.enableAutoInstancing) {
      if (!pc._autoInstanceBuffer) {
        pc._autoInstanceBuffer = new pc.VertexBuffer(device, pc._instanceVertexFormat, device.autoInstancingMaxObjects, pc.BUFFER_DYNAMIC);
        pc._autoInstanceBufferData = new Float32Array(pc._autoInstanceBuffer.lock());
      }
    }
  }, prepareStaticMeshes:function(device, scene) {
    var i, j, k, v, s, index;
    var drawCalls = scene.drawCalls;
    var lights = scene._lights;
    var drawCallsCount = drawCalls.length;
    var drawCall, light;
    var newDrawCalls = [];
    if (!scene._needsStaticPrepare) {
      var prevStaticSource;
      for (i = 0;i < drawCallsCount;i++) {
        drawCall = drawCalls[i];
        if (drawCall._staticSource) {
          if (drawCall._staticSource !== prevStaticSource) {
            newDrawCalls.push(drawCall._staticSource);
            prevStaticSource = drawCall._staticSource;
          }
        } else {
          newDrawCalls.push(drawCall);
        }
      }
      drawCalls = newDrawCalls;
      drawCallsCount = drawCalls.length;
      newDrawCalls = [];
    }
    var mesh;
    var indices, verts, numTris, elems, vertSize, offsetP, baseIndex;
    var _x, _y, _z;
    var minx, miny, minz, maxx, maxy, maxz;
    var minv, maxv;
    var minVec = new pc.Vec3;
    var maxVec = new pc.Vec3;
    var triAabb = new pc.BoundingBox;
    var localLightBounds = new pc.BoundingBox;
    var invMatrix = new pc.Mat4;
    var triLightComb = [];
    var triLightCombUsed;
    var indexBuffer, vertexBuffer;
    var combIndices, combIbName, combIb;
    var lightTypePass;
    var lightAabb = [];
    var aabb;
    var triBounds = [];
    var staticLights = [];
    var bit;
    var lht;
    for (i = 0;i < drawCallsCount;i++) {
      drawCall = drawCalls[i];
      if (!drawCall.isStatic) {
        newDrawCalls.push(drawCall);
      } else {
        aabb = drawCall.aabb;
        staticLights.length = 0;
        for (lightTypePass = pc.LIGHTTYPE_POINT;lightTypePass <= pc.LIGHTTYPE_SPOT;lightTypePass++) {
          for (j = 0;j < lights.length;j++) {
            light = lights[j];
            if (light._type !== lightTypePass) {
              continue;
            }
            if (light._enabled) {
              if (light._mask & drawCall.mask) {
                if (light.isStatic) {
                  if (!lightAabb[j]) {
                    lightAabb[j] = new pc.BoundingBox;
                    light._node.getWorldTransform();
                    light.getBoundingSphere(tempSphere);
                    lightAabb[j].center.copy(tempSphere.center);
                    lightAabb[j].halfExtents.x = tempSphere.radius;
                    lightAabb[j].halfExtents.y = tempSphere.radius;
                    lightAabb[j].halfExtents.z = tempSphere.radius;
                  }
                  if (!lightAabb[j].intersects(aabb)) {
                    continue;
                  }
                  staticLights.push(j);
                }
              }
            }
          }
        }
        if (staticLights.length === 0) {
          newDrawCalls.push(drawCall);
          continue;
        }
        mesh = drawCall.mesh;
        vertexBuffer = mesh.vertexBuffer;
        indexBuffer = mesh.indexBuffer[drawCall.renderStyle];
        indices = indexBuffer.bytesPerIndex === 2 ? new Uint16Array(indexBuffer.lock()) : new Uint32Array(indexBuffer.lock());
        numTris = mesh.primitive[drawCall.renderStyle].count / 3;
        baseIndex = mesh.primitive[drawCall.renderStyle].base;
        elems = vertexBuffer.format.elements;
        vertSize = vertexBuffer.format.size / 4;
        verts = new Float32Array(vertexBuffer.storage);
        for (k = 0;k < elems.length;k++) {
          if (elems[k].name === pc.SEMANTIC_POSITION) {
            offsetP = elems[k].offset / 4;
          }
        }
        triLightComb.length = numTris;
        for (k = 0;k < numTris;k++) {
          triLightComb[k] = 0;
        }
        triLightCombUsed = false;
        triBounds.length = numTris * 6;
        for (k = 0;k < numTris;k++) {
          minx = Number.MAX_VALUE;
          miny = Number.MAX_VALUE;
          minz = Number.MAX_VALUE;
          maxx = -Number.MAX_VALUE;
          maxy = -Number.MAX_VALUE;
          maxz = -Number.MAX_VALUE;
          for (v = 0;v < 3;v++) {
            index = indices[k * 3 + v + baseIndex];
            index = index * vertSize + offsetP;
            _x = verts[index];
            _y = verts[index + 1];
            _z = verts[index + 2];
            if (_x < minx) {
              minx = _x;
            }
            if (_y < miny) {
              miny = _y;
            }
            if (_z < minz) {
              minz = _z;
            }
            if (_x > maxx) {
              maxx = _x;
            }
            if (_y > maxy) {
              maxy = _y;
            }
            if (_z > maxz) {
              maxz = _z;
            }
          }
          index = k * 6;
          triBounds[index] = minx;
          triBounds[index + 1] = miny;
          triBounds[index + 2] = minz;
          triBounds[index + 3] = maxx;
          triBounds[index + 4] = maxy;
          triBounds[index + 5] = maxz;
        }
        for (s = 0;s < staticLights.length;s++) {
          j = staticLights[s];
          light = lights[j];
          invMatrix.copy(drawCall.node.worldTransform).invert();
          localLightBounds.setFromTransformedAabb(lightAabb[j], invMatrix);
          minv = localLightBounds.getMin().data;
          maxv = localLightBounds.getMax().data;
          bit = 1 << s;
          for (k = 0;k < numTris;k++) {
            index = k * 6;
            if (triBounds[index] <= maxv[0] && triBounds[index + 3] >= minv[0] && triBounds[index + 1] <= maxv[1] && triBounds[index + 4] >= minv[1] && triBounds[index + 2] <= maxv[2] && triBounds[index + 5] >= minv[2]) {
              triLightComb[k] |= bit;
              triLightCombUsed = true;
            }
          }
        }
        if (triLightCombUsed) {
          combIndices = {};
          for (k = 0;k < numTris;k++) {
            j = k * 3 + baseIndex;
            combIbName = triLightComb[k];
            if (!combIndices[combIbName]) {
              combIndices[combIbName] = [];
            }
            combIb = combIndices[combIbName];
            combIb.push(indices[j]);
            combIb.push(indices[j + 1]);
            combIb.push(indices[j + 2]);
          }
          for (combIbName in combIndices) {
            combIb = combIndices[combIbName];
            var ib = new pc.IndexBuffer(device, indexBuffer.format, combIb.length, indexBuffer.usage);
            var ib2 = ib.bytesPerIndex === 2 ? new Uint16Array(ib.lock()) : new Uint32Array(ib.lock());
            ib2.set(combIb);
            ib.unlock();
            minx = Number.MAX_VALUE;
            miny = Number.MAX_VALUE;
            minz = Number.MAX_VALUE;
            maxx = -Number.MAX_VALUE;
            maxy = -Number.MAX_VALUE;
            maxz = -Number.MAX_VALUE;
            for (k = 0;k < combIb.length;k++) {
              index = combIb[k];
              _x = verts[index * vertSize + offsetP];
              _y = verts[index * vertSize + offsetP + 1];
              _z = verts[index * vertSize + offsetP + 2];
              if (_x < minx) {
                minx = _x;
              }
              if (_y < miny) {
                miny = _y;
              }
              if (_z < minz) {
                minz = _z;
              }
              if (_x > maxx) {
                maxx = _x;
              }
              if (_y > maxy) {
                maxy = _y;
              }
              if (_z > maxz) {
                maxz = _z;
              }
            }
            minVec.set(minx, miny, minz);
            maxVec.set(maxx, maxy, maxz);
            var chunkAabb = new pc.BoundingBox;
            chunkAabb.setMinMax(minVec, maxVec);
            var mesh2 = new pc.Mesh;
            mesh2.vertexBuffer = vertexBuffer;
            mesh2.indexBuffer[0] = ib;
            mesh2.primitive[0].type = pc.PRIMITIVE_TRIANGLES;
            mesh2.primitive[0].base = 0;
            mesh2.primitive[0].count = combIb.length;
            mesh2.primitive[0].indexed = true;
            mesh2.aabb = chunkAabb;
            var instance = new pc.MeshInstance(drawCall.node, mesh2, drawCall.material);
            instance.isStatic = drawCall.isStatic;
            instance.visible = drawCall.visible;
            instance.layer = drawCall.layer;
            instance.castShadow = drawCall.castShadow;
            instance._receiveShadow = drawCall._receiveShadow;
            instance.drawToDepth = drawCall.drawToDepth;
            instance.cull = drawCall.cull;
            instance.pick = drawCall.pick;
            instance.mask = drawCall.mask;
            instance.parameters = drawCall.parameters;
            instance._shaderDefs = drawCall._shaderDefs;
            instance._staticSource = drawCall;
            if (drawCall._staticLightList) {
              instance._staticLightList = drawCall._staticLightList;
            } else {
              instance._staticLightList = [];
            }
            for (k = 0;k < staticLights.length;k++) {
              bit = 1 << k;
              if (combIbName & bit) {
                lht = lights[staticLights[k]];
                if (instance._staticLightList.indexOf(lht) < 0) {
                  instance._staticLightList.push(lht);
                }
              }
            }
            instance._staticLightList.sort(this.lightCompare);
            newDrawCalls.push(instance);
          }
        } else {
          newDrawCalls.push(drawCall);
        }
      }
    }
    scene.drawCalls = newDrawCalls;
  }, render:function(scene, camera) {
    var device = this.device;
    scene._activeCamera = camera;
    if (scene.updateShaders) {
      scene.updateShadersFunc(device);
      scene.updateShaders = false;
    }
    if (scene._needsStaticPrepare) {
      this.prepareStaticMeshes(device, scene);
      scene._needsStaticPrepare = false;
    }
    var target = camera.renderTarget;
    var isHdr = false;
    var oldExposure = scene.exposure;
    if (target && target.colorBuffer) {
      var format = target.colorBuffer.format;
      if (format === pc.PIXELFORMAT_RGB16F || format === pc.PIXELFORMAT_RGB32F || format === pc.PIXELFORMAT_RGBA16F || format === pc.PIXELFORMAT_RGBA32F || format === pc.PIXELFORMAT_111110F) {
        isHdr = true;
        scene.exposure = 1;
      }
    }
    var i;
    var drawCalls = scene.drawCalls;
    var shadowCasters = scene.shadowCasters;
    var lights = this.sortLights(scene);
    var camPos = camera._node.getPosition().data;
    var camFwd = camera._node.forward.data;
    this.setupInstancing(device);
    this.updateCameraFrustum(camera);
    this.updateCpuSkinMatrices(drawCalls);
    this.updateMorphedBounds(drawCalls);
    this.renderShadows(device, camera, shadowCasters, lights, scene);
    drawCalls = this.cull(camera, drawCalls);
    this.calculateSortDistances(drawCalls, camPos, camFwd, this.frontToBack);
    this.updateGpuSkinMatrices(drawCalls);
    this.updateMorphing(drawCalls);
    for (i = 0;i < scene.immediateDrawCalls.length;i++) {
      drawCalls.push(scene.immediateDrawCalls[i]);
    }
    this._immediateRendered += scene.immediateDrawCalls.length;
    this.renderDepth(device, camera, drawCalls);
    this.renderForward(device, camera, drawCalls, scene, isHdr ? pc.SHADER_FORWARDHDR : pc.SHADER_FORWARD);
    device.setColorWrite(true, true, true, true);
    if (scene.immediateDrawCalls.length > 0) {
      scene.immediateDrawCalls = [];
    }
    if (isHdr) {
      scene.exposure = oldExposure;
    }
    this._camerasRendered++;
  }});
  return {ForwardRenderer:ForwardRenderer, gaussWeights:gaussWeights};
}());
pc.extend(pc, function() {
  var scaleCompensatePosTransform = new pc.Mat4;
  var scaleCompensatePos = new pc.Vec3;
  var scaleCompensateRot = new pc.Quat;
  var scaleCompensateRot2 = new pc.Quat;
  var scaleCompensateScale = new pc.Vec3;
  var scaleCompensateScaleForParent = new pc.Vec3;
  var GraphNode = function GraphNode(name) {
    this.name = typeof name === "string" ? name : "Untitled";
    this.tags = new pc.Tags(this);
    this._labels = {};
    this.localPosition = new pc.Vec3(0, 0, 0);
    this.localRotation = new pc.Quat(0, 0, 0, 1);
    this.localScale = new pc.Vec3(1, 1, 1);
    this.localEulerAngles = new pc.Vec3(0, 0, 0);
    this.position = new pc.Vec3(0, 0, 0);
    this.rotation = new pc.Quat(0, 0, 0, 1);
    this.eulerAngles = new pc.Vec3(0, 0, 0);
    this.localTransform = new pc.Mat4;
    this._dirtyLocal = false;
    this._aabbVer = 0;
    this.worldTransform = new pc.Mat4;
    this._dirtyWorld = false;
    this.normalMatrix = new pc.Mat3;
    this._dirtyNormal = true;
    this._right = new pc.Vec3;
    this._up = new pc.Vec3;
    this._forward = new pc.Vec3;
    this._parent = null;
    this._children = [];
    this._enabled = true;
    this._enabledInHierarchy = false;
    this.scaleCompensation = false;
  };
  Object.defineProperty(GraphNode.prototype, "right", {get:function() {
    return this.getWorldTransform().getX(this._right).normalize();
  }});
  Object.defineProperty(GraphNode.prototype, "up", {get:function() {
    return this.getWorldTransform().getY(this._up).normalize();
  }});
  Object.defineProperty(GraphNode.prototype, "forward", {get:function() {
    return this.getWorldTransform().getZ(this._forward).normalize().scale(-1);
  }});
  Object.defineProperty(GraphNode.prototype, "enabled", {get:function() {
    return this._enabled && this._enabledInHierarchy;
  }, set:function(enabled) {
    if (this._enabled !== enabled) {
      this._enabled = enabled;
      if (!this._parent || this._parent.enabled) {
        this._notifyHierarchyStateChanged(this, enabled);
      }
    }
  }});
  Object.defineProperty(GraphNode.prototype, "parent", {get:function() {
    return this._parent;
  }});
  Object.defineProperty(GraphNode.prototype, "root", {get:function() {
    var parent = this._parent;
    if (!parent) {
      return this;
    }
    while (parent._parent) {
      parent = parent._parent;
    }
    return parent;
  }});
  Object.defineProperty(GraphNode.prototype, "children", {get:function() {
    return this._children;
  }});
  pc.extend(GraphNode.prototype, {_notifyHierarchyStateChanged:function(node, enabled) {
    node._onHierarchyStateChanged(enabled);
    var c = node._children;
    for (var i = 0, len = c.length;i < len;i++) {
      if (c[i]._enabled) {
        this._notifyHierarchyStateChanged(c[i], enabled);
      }
    }
  }, _onHierarchyStateChanged:function(enabled) {
    this._enabledInHierarchy = enabled;
  }, _cloneInternal:function(clone) {
    clone.name = this.name;
    var tags = this.tags._list;
    for (var i = 0;i < tags.length;i++) {
      clone.tags.add(tags[i]);
    }
    clone._labels = pc.extend(this._labels, {});
    clone.localPosition.copy(this.localPosition);
    clone.localRotation.copy(this.localRotation);
    clone.localScale.copy(this.localScale);
    clone.localEulerAngles.copy(this.localEulerAngles);
    clone.position.copy(this.position);
    clone.rotation.copy(this.rotation);
    clone.eulerAngles.copy(this.eulerAngles);
    clone.localTransform.copy(this.localTransform);
    clone._dirtyLocal = this._dirtyLocal;
    clone.worldTransform.copy(this.worldTransform);
    clone._dirtyWorld = this._dirtyWorld;
    clone._dirtyNormal = this._dirtyNormal;
    clone._aabbVer = this._aabbVer + 1;
    clone._enabled = this._enabled;
    clone.scaleCompensation = this.scaleCompensation;
    clone._enabledInHierarchy = false;
  }, clone:function() {
    var clone = new pc.GraphNode;
    this._cloneInternal(clone);
    return clone;
  }, find:function(attr, value) {
    var results = [];
    var len = this._children.length;
    var i, descendants;
    if (attr instanceof Function) {
      var fn = attr;
      for (i = 0;i < len;i++) {
        if (fn(this._children[i])) {
          results.push(this._children[i]);
        }
        descendants = this._children[i].find(fn);
        if (descendants.length) {
          results = results.concat(descendants);
        }
      }
    } else {
      var testValue;
      if (this[attr]) {
        if (this[attr] instanceof Function) {
          testValue = this[attr]();
        } else {
          testValue = this[attr];
        }
        if (testValue === value) {
          results.push(this);
        }
      }
      for (i = 0;i < len;++i) {
        descendants = this._children[i].find(attr, value);
        if (descendants.length) {
          results = results.concat(descendants);
        }
      }
    }
    return results;
  }, findOne:function(attr, value) {
    var i;
    var len = this._children.length;
    var result = null;
    if (attr instanceof Function) {
      var fn = attr;
      result = fn(this);
      if (result) {
        return this;
      }
      for (i = 0;i < len;i++) {
        result = this._children[i].findOne(fn);
        if (result) {
          return this._children[i];
        }
      }
    } else {
      var testValue;
      if (this[attr]) {
        if (this[attr] instanceof Function) {
          testValue = this[attr]();
        } else {
          testValue = this[attr];
        }
        if (testValue === value) {
          return this;
        }
      }
      for (i = 0;i < len;i++) {
        result = this._children[i].findOne(attr, value);
        if (result !== null) {
          return result;
        }
      }
    }
    return null;
  }, findByTag:function() {
    var tags = this.tags._processArguments(arguments);
    return this._findByTag(tags);
  }, _findByTag:function(tags) {
    var result = [];
    var i, len = this._children.length;
    var descendants;
    for (i = 0;i < len;i++) {
      if (this._children[i].tags._has(tags)) {
        result.push(this._children[i]);
      }
      descendants = this._children[i]._findByTag(tags);
      if (descendants.length) {
        result = result.concat(descendants);
      }
    }
    return result;
  }, findByName:function(name) {
    if (this.name === name) {
      return this;
    }
    for (var i = 0;i < this._children.length;i++) {
      var found = this._children[i].findByName(name);
      if (found !== null) {
        return found;
      }
    }
    return null;
  }, findByPath:function(path) {
    var parts = path.split("/");
    var currentParent = this;
    var result = null;
    for (var i = 0, imax = parts.length;i < imax && currentParent;i++) {
      var part = parts[i];
      result = null;
      var children = currentParent._children;
      for (var j = 0, jmax = children.length;j < jmax;j++) {
        if (children[j].name == part) {
          result = children[j];
          break;
        }
      }
      currentParent = result;
    }
    return result;
  }, getPath:function() {
    var parent = this._parent;
    if (parent) {
      var path = this.name;
      var format = "{0}/{1}";
      while (parent && parent._parent) {
        path = pc.string.format(format, parent.name, path);
        parent = parent._parent;
      }
      return path;
    } else {
      return "";
    }
  }, getRoot:function() {
    var parent = this._parent;
    if (!parent) {
      return this;
    }
    while (parent._parent) {
      parent = parent._parent;
    }
    return parent;
  }, getParent:function() {
    return this._parent;
  }, isDescendantOf:function(node) {
    var parent = this._parent;
    while (parent) {
      if (parent === node) {
        return true;
      }
      parent = parent._parent;
    }
    return false;
  }, isAncestorOf:function(node) {
    return node.isDescendantOf(this);
  }, getChildren:function() {
    return this._children;
  }, getEulerAngles:function() {
    this.getWorldTransform().getEulerAngles(this.eulerAngles);
    return this.eulerAngles;
  }, getLocalEulerAngles:function() {
    this.localRotation.getEulerAngles(this.localEulerAngles);
    return this.localEulerAngles;
  }, getLocalPosition:function() {
    return this.localPosition;
  }, getLocalRotation:function() {
    return this.localRotation;
  }, getLocalScale:function() {
    return this.localScale;
  }, getLocalTransform:function() {
    if (this._dirtyLocal) {
      this.localTransform.setTRS(this.localPosition, this.localRotation, this.localScale);
      this._dirtyLocal = false;
    }
    return this.localTransform;
  }, getName:function() {
    return this.name;
  }, getPosition:function() {
    this.getWorldTransform().getTranslation(this.position);
    return this.position;
  }, getRotation:function() {
    this.rotation.setFromMat4(this.getWorldTransform());
    return this.rotation;
  }, getWorldTransform:function() {
    if (!this._dirtyLocal && !this._dirtyWorld) {
      return this.worldTransform;
    }
    if (this._parent) {
      this._parent.getWorldTransform();
    }
    this._sync();
    return this.worldTransform;
  }, reparent:function(parent, index) {
    var current = this._parent;
    if (current) {
      current.removeChild(this);
    }
    if (parent) {
      if (index >= 0) {
        parent.insertChild(this, index);
      } else {
        parent.addChild(this);
      }
    }
  }, setLocalEulerAngles:function(x, y, z) {
    if (x instanceof pc.Vec3) {
      this.localRotation.setFromEulerAngles(x.data[0], x.data[1], x.data[2]);
    } else {
      this.localRotation.setFromEulerAngles(x, y, z);
    }
    if (!this._dirtyLocal) {
      this._dirtify(true);
    }
  }, setLocalPosition:function(x, y, z) {
    if (x instanceof pc.Vec3) {
      this.localPosition.copy(x);
    } else {
      this.localPosition.set(x, y, z);
    }
    if (!this._dirtyLocal) {
      this._dirtify(true);
    }
  }, setLocalRotation:function(x, y, z, w) {
    if (x instanceof pc.Quat) {
      this.localRotation.copy(x);
    } else {
      this.localRotation.set(x, y, z, w);
    }
    if (!this._dirtyLocal) {
      this._dirtify(true);
    }
  }, setLocalScale:function(x, y, z) {
    if (x instanceof pc.Vec3) {
      this.localScale.copy(x);
    } else {
      this.localScale.set(x, y, z);
    }
    if (!this._dirtyLocal) {
      this._dirtify(true);
    }
  }, setName:function(name) {
    this.name = name;
  }, _dirtify:function(local) {
    if ((!local || local && this._dirtyLocal) && this._dirtyWorld) {
      return;
    }
    if (local) {
      this._dirtyLocal = true;
    }
    if (!this._dirtyWorld) {
      this._dirtyWorld = true;
      var i = this._children.length;
      while (i--) {
        if (this._children[i]._dirtyWorld) {
          continue;
        }
        this._children[i]._dirtify();
      }
    }
    this._dirtyNormal = true;
    this._aabbVer++;
  }, setPosition:function() {
    var position = new pc.Vec3;
    var invParentWtm = new pc.Mat4;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        position.copy(x);
      } else {
        position.set(x, y, z);
      }
      if (this._parent === null) {
        this.localPosition.copy(position);
      } else {
        invParentWtm.copy(this._parent.getWorldTransform()).invert();
        invParentWtm.transformPoint(position, this.localPosition);
      }
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), setRotation:function() {
    var rotation = new pc.Quat;
    var invParentRot = new pc.Quat;
    return function(x, y, z, w) {
      if (x instanceof pc.Quat) {
        rotation.copy(x);
      } else {
        rotation.set(x, y, z, w);
      }
      if (this._parent === null) {
        this.localRotation.copy(rotation);
      } else {
        var parentRot = this._parent.getRotation();
        invParentRot.copy(parentRot).invert();
        this.localRotation.copy(invParentRot).mul(rotation);
      }
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), setEulerAngles:function() {
    var invParentRot = new pc.Quat;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        this.localRotation.setFromEulerAngles(x.data[0], x.data[1], x.data[2]);
      } else {
        this.localRotation.setFromEulerAngles(x, y, z);
      }
      if (this._parent !== null) {
        var parentRot = this._parent.getRotation();
        invParentRot.copy(parentRot).invert();
        this.localRotation.mul2(invParentRot, this.localRotation);
      }
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), addChild:function(node) {
    if (node._parent !== null) {
      throw new Error("GraphNode is already parented");
    }
    this._children.push(node);
    this._onInsertChild(node);
  }, addChildAndSaveTransform:function(node) {
    var wPos = node.getPosition();
    var wRot = node.getRotation();
    var current = node._parent;
    if (current) {
      current.removeChild(node);
    }
    if (this.tmpMat4 === undefined) {
      this.tmpMat4 = new pc.Mat4;
      this.tmpQuat = new pc.Quat;
    }
    node.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(wPos));
    node.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(wRot));
    this._children.push(node);
    this._onInsertChild(node);
  }, insertChild:function(node, index) {
    if (node._parent !== null) {
      throw new Error("GraphNode is already parented");
    }
    this._children.splice(index, 0, node);
    this._onInsertChild(node);
  }, _onInsertChild:function(node) {
    node._parent = this;
    var enabledInHierarchy = node._enabled && this.enabled;
    if (node._enabledInHierarchy !== enabledInHierarchy) {
      node._enabledInHierarchy = enabledInHierarchy;
      node._notifyHierarchyStateChanged(node, enabledInHierarchy);
    }
    node._dirtify();
    if (node.fire) {
      node.fire("insert", this);
    }
  }, removeChild:function(child) {
    var i;
    var length = this._children.length;
    for (i = 0;i < length;++i) {
      if (this._children[i] === child) {
        this._children.splice(i, 1);
        child._parent = null;
        return;
      }
    }
  }, addLabel:function(label) {
    this._labels[label] = true;
  }, getLabels:function() {
    return Object.keys(this._labels);
  }, hasLabel:function(label) {
    return !!this._labels[label];
  }, removeLabel:function(label) {
    delete this._labels[label];
  }, findByLabel:function(label, results) {
    var i, length = this._children.length;
    results = results || [];
    if (this.hasLabel(label)) {
      results.push(this);
    }
    for (i = 0;i < length;++i) {
      results = this._children[i].findByLabel(label, results);
    }
    return results;
  }, _sync:function() {
    if (this._dirtyLocal) {
      this.localTransform.setTRS(this.localPosition, this.localRotation, this.localScale);
      this._dirtyLocal = false;
    }
    if (this._dirtyWorld) {
      if (this._parent === null) {
        this.worldTransform.copy(this.localTransform);
      } else {
        if (this.scaleCompensation) {
          var parentWorldScale;
          var parent = this._parent;
          var scale = this.localScale;
          var parentToUseScaleFrom = parent;
          if (parentToUseScaleFrom) {
            while (parentToUseScaleFrom && parentToUseScaleFrom.scaleCompensation) {
              parentToUseScaleFrom = parentToUseScaleFrom._parent;
            }
            if (parentToUseScaleFrom) {
              parentToUseScaleFrom = parentToUseScaleFrom._parent;
              if (parentToUseScaleFrom) {
                parentWorldScale = parentToUseScaleFrom.worldTransform.getScale();
                scaleCompensateScale.mul2(parentWorldScale, this.localScale);
                scale = scaleCompensateScale;
              }
            }
          }
          scaleCompensateRot2.setFromMat4(parent.worldTransform);
          scaleCompensateRot.mul2(scaleCompensateRot2, this.localRotation);
          var tmatrix = parent.worldTransform;
          if (parent.scaleCompensation) {
            scaleCompensateScaleForParent.mul2(parentWorldScale, parent.getLocalScale());
            scaleCompensatePosTransform.setTRS(parent.worldTransform.getTranslation(scaleCompensatePos), scaleCompensateRot2, scaleCompensateScaleForParent);
            tmatrix = scaleCompensatePosTransform;
          }
          tmatrix.transformPoint(this.localPosition, scaleCompensatePos);
          this.worldTransform.setTRS(scaleCompensatePos, scaleCompensateRot, scale);
        } else {
          this.worldTransform.mul2(this._parent.worldTransform, this.localTransform);
        }
      }
      this._dirtyWorld = false;
    }
  }, syncHierarchy:function() {
    if (!this._enabled) {
      return;
    }
    if (this._dirtyLocal || this._dirtyWorld) {
      this._sync();
    }
    for (var i = 0;i < this._children.length;i++) {
      this._children[i].syncHierarchy();
    }
  }, lookAt:function() {
    var matrix = new pc.Mat4;
    var target = new pc.Vec3;
    var up = new pc.Vec3;
    var rotation = new pc.Quat;
    return function(tx, ty, tz, ux, uy, uz) {
      if (tx instanceof pc.Vec3) {
        target.copy(tx);
        if (ty instanceof pc.Vec3) {
          up.copy(ty);
        } else {
          up.copy(pc.Vec3.UP);
        }
      } else {
        if (tz === undefined) {
          return;
        } else {
          target.set(tx, ty, tz);
          if (ux !== undefined) {
            up.set(ux, uy, uz);
          } else {
            up.copy(pc.Vec3.UP);
          }
        }
      }
      matrix.setLookAt(this.getPosition(), target, up);
      rotation.setFromMat4(matrix);
      this.setRotation(rotation);
    };
  }(), translate:function() {
    var translation = new pc.Vec3;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        translation.copy(x);
      } else {
        translation.set(x, y, z);
      }
      translation.add(this.getPosition());
      this.setPosition(translation);
    };
  }(), translateLocal:function() {
    var translation = new pc.Vec3;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        translation.copy(x);
      } else {
        translation.set(x, y, z);
      }
      this.localRotation.transformVector(translation, translation);
      this.localPosition.add(translation);
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), rotate:function() {
    var quaternion = new pc.Quat;
    var invParentRot = new pc.Quat;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        quaternion.setFromEulerAngles(x.data[0], x.data[1], x.data[2]);
      } else {
        quaternion.setFromEulerAngles(x, y, z);
      }
      if (this._parent === null) {
        this.localRotation.mul2(quaternion, this.localRotation);
      } else {
        var rot = this.getRotation();
        var parentRot = this._parent.getRotation();
        invParentRot.copy(parentRot).invert();
        quaternion.mul2(invParentRot, quaternion);
        this.localRotation.mul2(quaternion, rot);
      }
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), rotateLocal:function() {
    var quaternion = new pc.Quat;
    return function(x, y, z) {
      if (x instanceof pc.Vec3) {
        quaternion.setFromEulerAngles(x.data[0], x.data[1], x.data[2]);
      } else {
        quaternion.setFromEulerAngles(x, y, z);
      }
      this.localRotation.mul(quaternion);
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }()});
  return {GraphNode:GraphNode};
}());
pc.extend(pc, function() {
  var _deviceCoord = new pc.Vec3;
  var _far = new pc.Vec3;
  var _farW = new pc.Vec3;
  var _invViewProjMat = new pc.Mat4;
  var Camera = function() {
    this._projection = pc.PROJECTION_PERSPECTIVE;
    this._nearClip = 0.1;
    this._farClip = 10000;
    this._fov = 45;
    this._orthoHeight = 10;
    this._aspect = 16 / 9;
    this._horizontalFov = false;
    this.frustumCulling = false;
    this.cullingMask = 4294967295;
    this._renderDepthRequests = 0;
    this._projMatDirty = true;
    this._projMat = new pc.Mat4;
    this._viewMat = new pc.Mat4;
    this._viewProjMat = new pc.Mat4;
    this.vrDisplay = null;
    this._rect = {x:0, y:0, width:1, height:1};
    this._scissorRect = {x:0, y:0, width:1, height:1};
    this.frustum = new pc.Frustum(this._projMat, this._viewMat);
    this.renderTarget = null;
    this._depthTarget = null;
    this._clearOptions = {color:[0.5, 0.5, 0.5, 1.0], depth:1.0, stencil:0, flags:pc.CLEARFLAG_COLOR | pc.CLEARFLAG_DEPTH | pc.CLEARFLAG_STENCIL};
    this._node = null;
    this.calculateTransform = null;
    this.overrideCalculateTransform = false;
    this.calculateProjection = null;
    this.overrideCalculateProjection = false;
    this._cullFaces = true;
    this._flipFaces = false;
  };
  Camera.prototype = {clone:function() {
    var clone = new pc.Camera;
    clone.projection = this._projection;
    clone.nearClip = this._nearClip;
    clone.farClip = this._farClip;
    clone.fov = this._fov;
    clone.aspectRatio = this._aspect;
    clone.renderTarget = this.renderTarget;
    clone.setClearOptions(this.getClearOptions());
    clone.frustumCulling = this.frustumCulling;
    clone.cullingMask = this.cullingMask;
    return clone;
  }, worldToScreen:function(worldCoord, cw, ch, screenCoord) {
    if (screenCoord === undefined) {
      screenCoord = new pc.Vec3;
    }
    var projMat = this.getProjectionMatrix();
    var wtm = this._node.getWorldTransform();
    this._viewMat.copy(wtm).invert();
    this._viewProjMat.mul2(projMat, this._viewMat);
    this._viewProjMat.transformPoint(worldCoord, screenCoord);
    var wp = worldCoord.data;
    var vpm = this._viewProjMat.data;
    var w = wp[0] * vpm[3] + wp[1] * vpm[7] + wp[2] * vpm[11] + 1 * vpm[15];
    screenCoord.x = (screenCoord.x / w + 1) * 0.5 * cw;
    screenCoord.y = (1 - screenCoord.y / w) * 0.5 * ch;
    return screenCoord;
  }, screenToWorld:function(x, y, z, cw, ch, worldCoord) {
    if (worldCoord === undefined) {
      worldCoord = new pc.Vec3;
    }
    var projMat = this.getProjectionMatrix();
    var wtm = this._node.getWorldTransform();
    this._viewMat.copy(wtm).invert();
    this._viewProjMat.mul2(projMat, this._viewMat);
    _invViewProjMat.copy(this._viewProjMat).invert();
    if (this._projection === pc.PROJECTION_PERSPECTIVE) {
      _far.set(x / cw * 2 - 1, (ch - y) / ch * 2 - 1, 1);
      _invViewProjMat.transformPoint(_far, _farW);
      var w = _far.x * _invViewProjMat.data[3] + _far.y * _invViewProjMat.data[7] + _far.z * _invViewProjMat.data[11] + _invViewProjMat.data[15];
      _farW.scale(1 / w);
      var alpha = z / this._farClip;
      worldCoord.lerp(this._node.getPosition(), _farW, alpha);
    } else {
      var range = this._farClip - this._nearClip;
      _deviceCoord.set(x / cw, (ch - y) / ch, z / range);
      _deviceCoord.scale(2);
      _deviceCoord.sub(pc.Vec3.ONE);
      _invViewProjMat.transformPoint(_deviceCoord, worldCoord);
    }
    return worldCoord;
  }, getClearOptions:function() {
    return this._clearOptions;
  }, getProjectionMatrix:function() {
    if (this._projMatDirty) {
      if (this._projection === pc.PROJECTION_PERSPECTIVE) {
        this._projMat.setPerspective(this._fov, this._aspect, this._nearClip, this._farClip, this._horizontalFov);
      } else {
        var y = this._orthoHeight;
        var x = y * this._aspect;
        this._projMat.setOrtho(-x, x, -y, y, this._nearClip, this._farClip);
      }
      this._projMatDirty = false;
    }
    return this._projMat;
  }, getRect:function() {
    return this._rect;
  }, setClearOptions:function(options) {
    this._clearOptions.color[0] = options.color[0];
    this._clearOptions.color[1] = options.color[1];
    this._clearOptions.color[2] = options.color[2];
    this._clearOptions.color[3] = options.color[3];
    this._clearOptions.depth = options.depth;
    this._clearOptions.stencil = options.stencil;
    this._clearOptions.flags = options.flags;
  }, setRect:function(x, y, width, height) {
    this._rect.x = x;
    this._rect.y = y;
    this._rect.width = width;
    this._rect.height = height;
  }, setScissorRect:function(x, y, width, height) {
    this._scissorRect.x = x;
    this._scissorRect.y = y;
    this._scissorRect.width = width;
    this._scissorRect.height = height;
  }, requestDepthMap:function() {
    this._renderDepthRequests++;
  }, releaseDepthMap:function() {
    this._renderDepthRequests--;
  }};
  Object.defineProperty(Camera.prototype, "aspectRatio", {get:function() {
    return this._aspect;
  }, set:function(v) {
    if (this._aspect !== v) {
      this._aspect = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "projection", {get:function() {
    return this._projection;
  }, set:function(v) {
    if (this._projection !== v) {
      this._projection = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "nearClip", {get:function() {
    return this._nearClip;
  }, set:function(v) {
    if (this._nearClip !== v) {
      this._nearClip = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "farClip", {get:function() {
    return this._farClip;
  }, set:function(v) {
    if (this._farClip !== v) {
      this._farClip = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "fov", {get:function() {
    return this._fov;
  }, set:function(v) {
    if (this._fov !== v) {
      this._fov = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "horizontalFov", {get:function() {
    return this._horizontalFov;
  }, set:function(v) {
    if (this._horizontalFov !== v) {
      this._horizontalFov = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "orthoHeight", {get:function() {
    return this._orthoHeight;
  }, set:function(v) {
    if (this._orthoHeight !== v) {
      this._orthoHeight = v;
      this._projMatDirty = true;
    }
  }});
  Object.defineProperty(Camera.prototype, "clearColor", {get:function() {
    return this._clearOptions.color;
  }, set:function(v) {
    this._clearOptions.color[0] = v[0];
    this._clearOptions.color[1] = v[1];
    this._clearOptions.color[2] = v[2];
    this._clearOptions.color[3] = v[3];
  }});
  Object.defineProperty(Camera.prototype, "clearDepth", {get:function() {
    return this._clearOptions.depth;
  }, set:function(v) {
    this._clearOptions.depth = v;
  }});
  Object.defineProperty(Camera.prototype, "clearStencil", {get:function() {
    return this._clearOptions.stencil;
  }, set:function(v) {
    this._clearOptions.stencil = v;
  }});
  Object.defineProperty(Camera.prototype, "clearFlags", {get:function() {
    return this._clearOptions.flags;
  }, set:function(v) {
    this._clearOptions.flags = v;
  }});
  return {Camera:Camera};
}());
pc.extend(pc, function() {
  var spotCenter = new pc.Vec3;
  var spotEndPoint = new pc.Vec3;
  var tmpVec = new pc.Vec3;
  var chanId = {r:0, g:1, b:2, a:3};
  var Light = function Light() {
    this._type = pc.LIGHTTYPE_DIRECTIONAL;
    this._color = new pc.Color(0.8, 0.8, 0.8);
    this._intensity = 1;
    this._castShadows = false;
    this._enabled = false;
    this._mask = 1;
    this.isStatic = false;
    this.key = 0;
    this.bakeDir = true;
    this.attenuationStart = 10;
    this.attenuationEnd = 10;
    this._falloffMode = 0;
    this._shadowType = pc.SHADOW_PCF3;
    this._vsmBlurSize = 11;
    this.vsmBlurMode = pc.BLUR_GAUSSIAN;
    this.vsmBias = 0.01 * 0.25;
    this._cookie = null;
    this.cookieIntensity = 1;
    this._cookieFalloff = true;
    this._cookieChannel = "rgb";
    this._cookieTransform = null;
    this._cookieOffset = null;
    this._cookieTransformSet = false;
    this._cookieOffsetSet = false;
    this._innerConeAngle = 40;
    this._outerConeAngle = 45;
    this._finalColor = new pc.Vec3(0.8, 0.8, 0.8);
    var c = Math.pow(this._finalColor.data[0], 2.2);
    this._linearFinalColor = new pc.Vec3(c, c, c);
    this._position = new pc.Vec3(0, 0, 0);
    this._direction = new pc.Vec3(0, 0, 0);
    this._innerConeAngleCos = Math.cos(this._innerConeAngle * Math.PI / 180);
    this._outerConeAngleCos = Math.cos(this._outerConeAngle * Math.PI / 180);
    this._shadowCamera = null;
    this._shadowMatrix = new pc.Mat4;
    this.shadowDistance = 40;
    this._shadowResolution = 1024;
    this.shadowBias = -0.0005;
    this._normalOffsetBias = 0.0;
    this.shadowUpdateMode = pc.SHADOWUPDATE_REALTIME;
    this._scene = null;
    this._node = null;
    this._rendererParams = [];
    this._isVsm = false;
    this._isPcf = true;
    this._cacheShadowMap = false;
    this._isCachedShadowMap = false;
  };
  Light.prototype = {clone:function() {
    var clone = new pc.Light;
    clone.type = this._type;
    clone.setColor(this._color);
    clone.intensity = this._intensity;
    clone.castShadows = this.castShadows;
    clone.enabled = this._enabled;
    clone.attenuationStart = this.attenuationStart;
    clone.attenuationEnd = this.attenuationEnd;
    clone.falloffMode = this._falloffMode;
    clone.shadowType = this._shadowType;
    clone.vsmBlurSize = this._vsmBlurSize;
    clone.vsmBlurMode = this.vsmBlurMode;
    clone.vsmBias = this.vsmBias;
    clone.shadowUpdateMode = this.shadowUpdateMode;
    clone.mask = this._mask;
    clone.innerConeAngle = this._innerConeAngle;
    clone.outerConeAngle = this._outerConeAngle;
    clone.shadowBias = this.shadowBias;
    clone.normalOffsetBias = this._normalOffsetBias;
    clone.shadowResolution = this._shadowResolution;
    clone.shadowDistance = this.shadowDistance;
    return clone;
  }, getColor:function() {
    return this._color;
  }, getBoundingSphere:function(sphere) {
    if (this._type === pc.LIGHTTYPE_SPOT) {
      var range = this.attenuationEnd;
      var angle = this._outerConeAngle;
      var f = Math.cos(angle * pc.math.DEG_TO_RAD);
      var node = this._node;
      spotCenter.copy(node.up);
      spotCenter.scale(-range * 0.5 * f);
      spotCenter.add(node.getPosition());
      sphere.center = spotCenter;
      spotEndPoint.copy(node.up);
      spotEndPoint.scale(-range);
      tmpVec.copy(node.right);
      tmpVec.scale(Math.sin(angle * pc.math.DEG_TO_RAD) * range);
      spotEndPoint.add(tmpVec);
      sphere.radius = spotEndPoint.length() * 0.5;
    } else {
      if (this._type === pc.LIGHTTYPE_POINT) {
        sphere.center = this._node.getPosition();
        sphere.radius = this.attenuationEnd;
      }
    }
  }, getBoundingBox:function(box) {
    if (this._type === pc.LIGHTTYPE_SPOT) {
      var range = this.attenuationEnd;
      var angle = this._outerConeAngle;
      var node = this._node;
      var scl = Math.abs(Math.sin(angle * pc.math.DEG_TO_RAD) * range);
      box.center.set(0, -range * 0.5, 0);
      box.halfExtents.set(scl, range * 0.5, scl);
      box.setFromTransformedAabb(box, node.getWorldTransform());
    } else {
      if (this._type === pc.LIGHTTYPE_POINT) {
        box.center.copy(this._node.getPosition());
        box.halfExtents.set(this.attenuationEnd, this.attenuationEnd, this.attenuationEnd);
      }
    }
  }, setColor:function() {
    var r, g, b;
    if (arguments.length === 1) {
      r = arguments[0].r;
      g = arguments[0].g;
      b = arguments[0].b;
    } else {
      if (arguments.length === 3) {
        r = arguments[0];
        g = arguments[1];
        b = arguments[2];
      }
    }
    this._color.set(r, g, b);
    var i = this._intensity;
    this._finalColor.set(r * i, g * i, b * i);
    for (var c = 0;c < 3;c++) {
      if (i >= 1) {
        this._linearFinalColor.data[c] = Math.pow(this._finalColor.data[c] / i, 2.2) * i;
      } else {
        this._linearFinalColor.data[c] = Math.pow(this._finalColor.data[c], 2.2);
      }
    }
  }, _destroyShadowMap:function() {
    if (this._shadowCamera) {
      if (!this._isCachedShadowMap) {
        var rt = this._shadowCamera.renderTarget;
        var i;
        if (rt) {
          if (rt.length) {
            for (i = 0;i < rt.length;i++) {
              if (rt[i].colorBuffer) {
                rt[i].colorBuffer.destroy();
              }
              rt[i].destroy();
            }
          } else {
            if (rt.colorBuffer) {
              rt.colorBuffer.destroy();
            }
            rt.destroy();
          }
        }
      }
      this._shadowCamera.renderTarget = null;
      this._shadowCamera = null;
      this._shadowCubeMap = null;
      if (this.shadowUpdateMode === pc.SHADOWUPDATE_NONE) {
        this.shadowUpdateMode = pc.SHADOWUPDATE_THISFRAME;
      }
    }
  }, updateShadow:function() {
    if (this.shadowUpdateMode !== pc.SHADOWUPDATE_REALTIME) {
      this.shadowUpdateMode = pc.SHADOWUPDATE_THISFRAME;
    }
  }, updateKey:function() {
    var key = this._type << 29 | (this._castShadows ? 1 : 0) << 28 | this._shadowType << 25 | this._falloffMode << 23 | (this._normalOffsetBias !== 0.0 ? 1 : 0) << 22 | (this._cookie ? 1 : 0) << 21 | (this._cookieFalloff ? 1 : 0) << 20 | chanId[this._cookieChannel.charAt(0)] << 18 | (this._cookieTransform ? 1 : 0) << 12;
    if (this._cookieChannel.length === 3) {
      key |= chanId[this._cookieChannel.charAt(1)] << 16;
      key |= chanId[this._cookieChannel.charAt(2)] << 14;
    }
    this.key = key;
  }};
  Object.defineProperty(Light.prototype, "enabled", {get:function() {
    return this._type;
  }, set:function(value) {
    if (this._type === value) {
      return;
    }
    this._enabled = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
  }});
  Object.defineProperty(Light.prototype, "type", {get:function() {
    return this._type;
  }, set:function(value) {
    if (this._type === value) {
      return;
    }
    this._type = value;
    this._destroyShadowMap();
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
    var stype = this._shadowType;
    this._shadowType = null;
    this.shadowType = stype;
  }});
  Object.defineProperty(Light.prototype, "mask", {get:function() {
    return this._mask;
  }, set:function(value) {
    if (this._mask === value) {
      return;
    }
    this._mask = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
  }});
  Object.defineProperty(Light.prototype, "shadowType", {get:function() {
    return this._shadowType;
  }, set:function(value) {
    if (this._shadowType === value) {
      return;
    }
    var device = pc.Application.getApplication().graphicsDevice;
    if (this._type === pc.LIGHTTYPE_POINT) {
      value = pc.SHADOW_PCF3;
    }
    if (value === pc.SHADOW_PCF5 && !device.webgl2) {
      value = pc.SHADOW_PCF3;
    }
    if (value === pc.SHADOW_VSM32 && !device.extTextureFloatRenderable) {
      value = pc.SHADOW_VSM16;
    }
    if (value === pc.SHADOW_VSM16 && !device.extTextureHalfFloatRenderable) {
      value = pc.SHADOW_VSM8;
    }
    this._isVsm = value >= pc.SHADOW_VSM8 && value <= pc.SHADOW_VSM32;
    this._isPcf = value === pc.SHADOW_PCF5 || value === pc.SHADOW_PCF3;
    this._shadowType = value;
    this._destroyShadowMap();
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "castShadows", {get:function() {
    return this._castShadows && this._mask !== pc.MASK_LIGHTMAP && this._mask !== 0;
  }, set:function(value) {
    if (this._castShadows === value) {
      return;
    }
    this._castShadows = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "shadowResolution", {get:function() {
    return this._shadowResolution;
  }, set:function(value) {
    if (this._shadowResolution === value) {
      return;
    }
    var device = pc.Application.getApplication().graphicsDevice;
    if (this._type === pc.LIGHTTYPE_POINT) {
      value = Math.min(value, device.maxCubeMapSize);
    } else {
      value = Math.min(value, device.maxTextureSize);
    }
    this._shadowResolution = value;
  }});
  Object.defineProperty(Light.prototype, "vsmBlurSize", {get:function() {
    return this._vsmBlurSize;
  }, set:function(value) {
    if (this._vsmBlurSize === value) {
      return;
    }
    if (value % 2 === 0) {
      value++;
    }
    this._vsmBlurSize = value;
  }});
  Object.defineProperty(Light.prototype, "normalOffsetBias", {get:function() {
    return this._normalOffsetBias;
  }, set:function(value) {
    if (this._normalOffsetBias === value) {
      return;
    }
    if (!this._normalOffsetBias && value || this._normalOffsetBias && !value) {
      if (this._scene !== null) {
        this._scene.updateShaders = true;
      }
      this.updateKey();
    }
    this._normalOffsetBias = value;
  }});
  Object.defineProperty(Light.prototype, "falloffMode", {get:function() {
    return this._falloffMode;
  }, set:function(value) {
    if (this._falloffMode === value) {
      return;
    }
    this._falloffMode = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "innerConeAngle", {get:function() {
    return this._innerConeAngle;
  }, set:function(value) {
    if (this._innerConeAngle === value) {
      return;
    }
    this._innerConeAngle = value;
    this._innerConeAngleCos = Math.cos(value * Math.PI / 180);
  }});
  Object.defineProperty(Light.prototype, "outerConeAngle", {get:function() {
    return this._outerConeAngle;
  }, set:function(value) {
    if (this._outerConeAngle === value) {
      return;
    }
    this._outerConeAngle = value;
    this._outerConeAngleCos = Math.cos(value * Math.PI / 180);
  }});
  Object.defineProperty(Light.prototype, "intensity", {get:function() {
    return this._intensity;
  }, set:function(value) {
    if (this._intensity === value) {
      return;
    }
    this._intensity = value;
    var c = this._color.data;
    var r = c[0];
    var g = c[1];
    var b = c[2];
    var i = this._intensity;
    this._finalColor.set(r * i, g * i, b * i);
    for (var j = 0;j < 3;j++) {
      if (i >= 1) {
        this._linearFinalColor.data[j] = Math.pow(this._finalColor.data[j] / i, 2.2) * i;
      } else {
        this._linearFinalColor.data[j] = Math.pow(this._finalColor.data[j], 2.2);
      }
    }
  }});
  Object.defineProperty(Light.prototype, "cookie", {get:function() {
    return this._cookie;
  }, set:function(value) {
    if (this._cookie === value) {
      return;
    }
    this._cookie = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "cookieFalloff", {get:function() {
    return this._cookieFalloff;
  }, set:function(value) {
    if (this._cookieFalloff === value) {
      return;
    }
    this._cookieFalloff = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "cookieChannel", {get:function() {
    return this._cookieChannel;
  }, set:function(value) {
    if (this._cookieChannel === value) {
      return;
    }
    if (value.length < 3) {
      var chr = value.charAt(value.length - 1);
      var addLen = 3 - value.length;
      for (var i = 0;i < addLen;i++) {
        value += chr;
      }
    }
    this._cookieChannel = value;
    if (this._scene !== null) {
      this._scene.updateShaders = true;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "cookieTransform", {get:function() {
    return this._cookieTransform;
  }, set:function(value) {
    if (this._cookieTransform === value) {
      return;
    }
    var xformOld = !!(this._cookieTransformSet || this._cookieOffsetSet);
    var xformNew = !!(value || this._cookieOffsetSet);
    if (xformOld !== xformNew) {
      if (this._scene !== null) {
        this._scene.updateShaders = true;
      }
    }
    this._cookieTransform = value;
    this._cookieTransformSet = !!value;
    if (value && !this._cookieOffset) {
      this.cookieOffset = new pc.Vec2;
      this._cookieOffsetSet = false;
    }
    this.updateKey();
  }});
  Object.defineProperty(Light.prototype, "cookieOffset", {get:function() {
    return this._cookieOffset;
  }, set:function(value) {
    if (this._cookieOffset === value) {
      return;
    }
    var xformOld = !!(this._cookieTransformSet || this._cookieOffsetSet);
    var xformNew = !!(this._cookieTransformSet || value);
    if (xformOld !== xformNew) {
      if (this._scene !== null) {
        this._scene.updateShaders = true;
      }
    }
    if (xformNew && !value && this._cookieOffset) {
      this._cookieOffset.set(0, 0);
    } else {
      this._cookieOffset = value;
    }
    this._cookieOffsetSet = !!value;
    if (value && !this._cookieTransform) {
      this.cookieTransform = new pc.Vec4(1, 1, 0, 0);
      this._cookieTransformSet = false;
    }
    this.updateKey();
  }});
  return {Light:Light};
}());
pc.extend(pc, function() {
  var id = 0;
  var Material = function Material() {
    this.name = "Untitled";
    this.id = id++;
    this._shader = null;
    this.variants = {};
    this.parameters = {};
    this.alphaTest = 0;
    this.alphaToCoverage = false;
    this.blend = false;
    this.blendSrc = pc.BLENDMODE_ONE;
    this.blendDst = pc.BLENDMODE_ZERO;
    this.blendEquation = pc.BLENDEQUATION_ADD;
    this.separateAlphaBlend = false;
    this.blendSrcAlpha = pc.BLENDMODE_ONE;
    this.blendDstAlpha = pc.BLENDMODE_ZERO;
    this.blendAlphaEquation = pc.BLENDEQUATION_ADD;
    this.cull = pc.CULLFACE_BACK;
    this.depthTest = true;
    this.depthWrite = true;
    this.stencilFront = null;
    this.stencilBack = null;
    this.redWrite = true;
    this.greenWrite = true;
    this.blueWrite = true;
    this.alphaWrite = true;
    this.meshInstances = [];
  };
  Object.defineProperty(Material.prototype, "shader", {get:function() {
    return this._shader;
  }, set:function(shader) {
    this.setShader(shader);
  }});
  Object.defineProperty(Material.prototype, "blendType", {get:function() {
    if (!this.blend && this.blendSrc === pc.BLENDMODE_ONE && this.blendDst === pc.BLENDMODE_ZERO && this.blendEquation === pc.BLENDEQUATION_ADD) {
      return pc.BLEND_NONE;
    } else {
      if (this.blend && this.blendSrc === pc.BLENDMODE_SRC_ALPHA && this.blendDst === pc.BLENDMODE_ONE_MINUS_SRC_ALPHA && this.blendEquation === pc.BLENDEQUATION_ADD) {
        return pc.BLEND_NORMAL;
      } else {
        if (this.blend && this.blendSrc === pc.BLENDMODE_ONE && this.blendDst === pc.BLENDMODE_ONE && this.blendEquation === pc.BLENDEQUATION_ADD) {
          return pc.BLEND_ADDITIVE;
        } else {
          if (this.blend && this.blendSrc === pc.BLENDMODE_SRC_ALPHA && this.blendDst === pc.BLENDMODE_ONE && this.blendEquation === pc.BLENDEQUATION_ADD) {
            return pc.BLEND_ADDITIVEALPHA;
          } else {
            if (this.blend && this.blendSrc === pc.BLENDMODE_DST_COLOR && this.blendDst === pc.BLENDMODE_SRC_COLOR && this.blendEquation === pc.BLENDEQUATION_ADD) {
              return pc.BLEND_MULTIPLICATIVE2X;
            } else {
              if (this.blend && this.blendSrc === pc.BLENDMODE_ONE_MINUS_DST_COLOR && this.blendDst === pc.BLENDMODE_ONE && this.blendEquation === pc.BLENDEQUATION_ADD) {
                return pc.BLEND_SCREEN;
              } else {
                if (this.blend && this.blendSrc === pc.BLENDMODE_ONE && this.blendDst === pc.BLENDMODE_ONE && this.blendEquation === pc.BLENDEQUATION_MIN) {
                  return pc.BLEND_MIN;
                } else {
                  if (this.blend && this.blendSrc === pc.BLENDMODE_ONE && this.blendDst === pc.BLENDMODE_ONE && this.blendEquation === pc.BLENDEQUATION_MAX) {
                    return pc.BLEND_MAX;
                  } else {
                    if (this.blend && this.blendSrc === pc.BLENDMODE_DST_COLOR && this.blendDst === pc.BLENDMODE_ZERO && this.blendEquation === pc.BLENDEQUATION_ADD) {
                      return pc.BLEND_MULTIPLICATIVE;
                    } else {
                      if (this.blend && this.blendSrc === pc.BLENDMODE_ONE && this.blendDst === pc.BLENDMODE_ONE_MINUS_SRC_ALPHA && this.blendEquation === pc.BLENDEQUATION_ADD) {
                        return pc.BLEND_PREMULTIPLIED;
                      } else {
                        return pc.BLEND_NORMAL;
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }, set:function(type) {
    switch(type) {
      case pc.BLEND_NONE:
        this.blend = false;
        this.blendSrc = pc.BLENDMODE_ONE;
        this.blendDst = pc.BLENDMODE_ZERO;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_NORMAL:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_SRC_ALPHA;
        this.blendDst = pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_PREMULTIPLIED:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_ONE;
        this.blendDst = pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_ADDITIVE:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_ONE;
        this.blendDst = pc.BLENDMODE_ONE;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_ADDITIVEALPHA:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_SRC_ALPHA;
        this.blendDst = pc.BLENDMODE_ONE;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_MULTIPLICATIVE2X:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_DST_COLOR;
        this.blendDst = pc.BLENDMODE_SRC_COLOR;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_SCREEN:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_ONE_MINUS_DST_COLOR;
        this.blendDst = pc.BLENDMODE_ONE;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_MULTIPLICATIVE:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_DST_COLOR;
        this.blendDst = pc.BLENDMODE_ZERO;
        this.blendEquation = pc.BLENDEQUATION_ADD;
        break;
      case pc.BLEND_MIN:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_ONE;
        this.blendDst = pc.BLENDMODE_ONE;
        this.blendEquation = pc.BLENDEQUATION_MIN;
        break;
      case pc.BLEND_MAX:
        this.blend = true;
        this.blendSrc = pc.BLENDMODE_ONE;
        this.blendDst = pc.BLENDMODE_ONE;
        this.blendEquation = pc.BLENDEQUATION_MAX;
        break;
    }
    this._updateMeshInstanceKeys();
  }});
  Material.prototype._cloneInternal = function(clone) {
    clone.name = this.name;
    clone.id = id++;
    clone.variants = {};
    clone.shader = this.shader;
    clone.parameters = {};
    for (var parameterName in this.parameters) {
      if (this.parameters.hasOwnProperty(parameterName)) {
        clone.parameters[parameterName] = {scopeId:null, data:this.parameters[parameterName].data};
      }
    }
    clone.alphaTest = this.alphaTest;
    clone.alphaToCoverage = this.alphaToCoverage;
    clone.blend = this.blend;
    clone.blendSrc = this.blendSrc;
    clone.blendDst = this.blendDst;
    clone.blendEquation = this.blendEquation;
    clone.separateAlphaBlend = this.separateAlphaBlend;
    clone.blendSrcAlpha = this.blendSrcAlpha;
    clone.blendDstAlpha = this.blendDstAlpha;
    clone.blendAlphaEquation = this.blendAlphaEquation;
    clone.cull = this.cull;
    clone.depthTest = this.depthTest;
    clone.depthWrite = this.depthWrite;
    if (this.stencilFront) {
      clone.stencilFront = this.stencilFront.clone();
    }
    if (this.stencilBack) {
      if (this.stencilFront === this.stencilBack) {
        clone.stencilBack = clone.stencilFront;
      } else {
        clone.stencilBack = this.stencilBack.clone();
      }
    }
    clone.redWrite = this.redWrite;
    clone.greenWrite = this.greenWrite;
    clone.blueWrite = this.blueWrite;
    clone.alphaWrite = this.alphaWrite;
    clone.meshInstances = [];
  };
  Material.prototype.clone = function() {
    var clone = new pc.Material;
    this._cloneInternal(clone);
    return clone;
  };
  Material.prototype._updateMeshInstanceKeys = function() {
    var i, meshInstances = this.meshInstances;
    for (i = 0;i < meshInstances.length;i++) {
      meshInstances[i].updateKey();
    }
  };
  Material.prototype.updateShader = function(device, scene, objDefs) {
  };
  Material.prototype.clearParameters = function() {
    this.parameters = {};
  };
  Material.prototype.getParameters = function() {
    return this.parameters;
  };
  Material.prototype.clearVariants = function() {
    var meshInstance;
    for (var s in this.variants) {
      if (this.variants.hasOwnProperty(s)) {
        this.variants[s]._refCount--;
      }
    }
    this.variants = {};
    var j;
    for (var i = 0;i < this.meshInstances.length;i++) {
      meshInstance = this.meshInstances[i];
      for (j = 0;j < meshInstance._shader.length;j++) {
        meshInstance._shader[j] = null;
      }
    }
  };
  Material.prototype.getParameter = function(name) {
    return this.parameters[name];
  };
  Material.prototype.setParameter = function(arg, data, passFlags) {
    if (passFlags === undefined) {
      passFlags = 1 << pc.SHADER_FORWARD | 1 << pc.SHADER_FORWARDHDR;
    }
    var name;
    if (data === undefined && typeof arg === "object") {
      var uniformObject = arg;
      if (uniformObject.length) {
        for (var i = 0;i < uniformObject.length;i++) {
          this.setParameter(uniformObject[i]);
        }
        return;
      } else {
        name = uniformObject.name;
        data = uniformObject.value;
      }
    } else {
      name = arg;
    }
    var param = this.parameters[name];
    if (param) {
      param.data = data;
      param.passFlags = passFlags;
    } else {
      this.parameters[name] = {scopeId:null, data:data, passFlags:passFlags};
    }
  };
  Material.prototype.deleteParameter = function(name) {
    if (this.parameters[name]) {
      delete this.parameters[name];
    }
  };
  Material.prototype.setParameters = function() {
    for (var paramName in this.parameters) {
      var parameter = this.parameters[paramName];
      parameter.scopeId.setValue(parameter.data);
    }
  };
  Material.prototype.update = function() {
    throw Error("Not Implemented in base class");
  };
  Material.prototype.init = function(data) {
    throw Error("Not Implemented in base class");
  };
  Material.prototype.getName = function() {
    return this.name;
  };
  Material.prototype.setName = function(name) {
    this.name = name;
  };
  Material.prototype.getShader = function() {
    return this.shader;
  };
  Material.prototype.setShader = function(shader) {
    if (this._shader) {
      this._shader._refCount--;
    }
    this._shader = shader;
    if (shader) {
      shader._refCount++;
    }
  };
  Material.prototype.destroy = function() {
    if (this.shader) {
      this.shader._refCount--;
      if (this.shader._refCount < 1) {
        this.shader.destroy();
      }
    }
    var variant;
    for (var s in this.variants) {
      if (this.variants.hasOwnProperty(s)) {
        variant = this.variants[s];
        if (variant === this.shader) {
          continue;
        }
        variant._refCount--;
        if (variant._refCount < 1) {
          variant.destroy();
        }
      }
    }
    this.variants = {};
    this.shader = null;
    var meshInstance, j;
    for (var i = 0;i < this.meshInstances.length;i++) {
      meshInstance = this.meshInstances[i];
      for (j = 0;j < meshInstance._shader.length;j++) {
        meshInstance._shader[j] = null;
      }
      meshInstance._material = null;
      if (this !== pc.Scene.defaultMaterial) {
        meshInstance.material = pc.Scene.defaultMaterial;
      }
    }
  };
  var StencilParameters = function(options) {
    this.func = options.func === undefined ? pc.FUNC_ALWAYS : options.func;
    this.ref = options.ref || 0;
    this.readMask = options.readMask === undefined ? 255 : options.readMask;
    this.writeMask = options.writeMask === undefined ? 255 : options.writeMask;
    this.fail = options.fail || pc.STENCILOP_KEEP;
    this.zfail = options.zfail || pc.STENCILOP_KEEP;
    this.zpass = options.zpass || pc.STENCILOP_KEEP;
  };
  StencilParameters.prototype.clone = function() {
    var clone = new pc.StencilParameters({func:this.func, ref:this.ref, readMask:this.readMask, writeMask:this.writeMask, fail:this.fail, zfail:this.zfail, zpass:this.zpass});
    return clone;
  };
  return {Material:Material, StencilParameters:StencilParameters};
}());
pc.extend(pc, function() {
  var BasicMaterial = function() {
    this.color = new pc.Color(1, 1, 1, 1);
    this.colorMap = null;
    this.vertexColors = false;
    this.update();
  };
  BasicMaterial = pc.inherits(BasicMaterial, pc.Material);
  pc.extend(BasicMaterial.prototype, {clone:function() {
    var clone = new pc.BasicMaterial;
    pc.Material.prototype._cloneInternal.call(this, clone);
    clone.color.copy(this.color);
    clone.colorMap = this.colorMap;
    clone.vertexColors = this.vertexColors;
    clone.update();
    return clone;
  }, update:function() {
    this.clearParameters();
    this.setParameter("uColor", this.color.data);
    if (this.colorMap) {
      this.setParameter("texture_diffuseMap", this.colorMap);
    }
  }, updateShader:function(device) {
    var options = {skin:!!this.meshInstances[0].skinInstance, vertexColors:this.vertexColors, diffuseMap:this.colorMap};
    var library = device.getProgramLibrary();
    this.shader = library.getProgram("basic", options);
  }});
  return {BasicMaterial:BasicMaterial};
}());
pc.extend(pc, function() {
  var DepthMaterial = function() {
  };
  DepthMaterial = pc.inherits(DepthMaterial, pc.Material);
  pc.extend(DepthMaterial.prototype, {clone:function() {
    var clone = new pc.DepthMaterial;
    pc.Material.prototype._cloneInternal.call(this, clone);
    clone.update();
    return clone;
  }, update:function() {
  }, updateShader:function(device) {
    var options = {skin:!!this.meshInstances[0].skinInstance};
    var library = device.getProgramLibrary();
    this.shader = library.getProgram("depth", options);
  }});
  return {DepthMaterial:DepthMaterial};
}());
pc.extend(pc, function() {
  var _tempTiling = new pc.Vec3;
  var _tempOffset = new pc.Vec3;
  var lightBounds = new pc.BoundingBox;
  var tempSphere = {center:null, radius:0};
  var StandardMaterial = function() {
    this.reset();
    this.update();
  };
  var _createTexture = function(param) {
    if (param.data) {
      if (param.data instanceof pc.Texture) {
        return param.data;
      } else {
        return null;
      }
    } else {
      return null;
    }
  };
  var _createCubemap = function(param) {
    if (param.data) {
      if (param.data instanceof pc.Texture) {
        return param.data;
      }
    }
    return null;
  };
  var _createVec2 = function(param) {
    return new pc.Vec2(param.data[0], param.data[1]);
  };
  var _createVec3 = function(param) {
    return new pc.Vec3(param.data[0], param.data[1], param.data[2]);
  };
  var _createBoundingBox = function(param) {
    var center, halfExtents;
    if (param.data && param.data.center) {
      center = new pc.Vec3(param.data.center[0], param.data.center[1], param.data.center[2]);
    } else {
      center = new pc.Vec3(0, 0, 0);
    }
    if (param.data && param.data.halfExtents) {
      halfExtents = new pc.Vec3(param.data.halfExtents[0], param.data.halfExtents[1], param.data.halfExtents[2]);
    } else {
      halfExtents = new pc.Vec3(0.5, 0.5, 0.5);
    }
    return new pc.BoundingBox(center, halfExtents);
  };
  var _createRgb = function(param) {
    return new pc.Color(param.data[0], param.data[1], param.data[2]);
  };
  var _propsSerial = [];
  var _propsSerialDefaultVal = [];
  var _propsInternalNull = [];
  var _propsInternalVec3 = [];
  var _prop2Uniform = {};
  var _defineTex2D = function(obj, name, uv, channels) {
    var privMap = "_" + name + "Map";
    var privMapTiling = privMap + "Tiling";
    var privMapOffset = privMap + "Offset";
    var mapTransform = privMap.substring(1) + "Transform";
    var privMapUv = privMap + "Uv";
    var privMapChannel = privMap + "Channel";
    var privMapVertexColor = privMap + "VertexColor";
    obj[privMap] = null;
    obj[privMapTiling] = new pc.Vec2(1, 1);
    obj[privMapOffset] = new pc.Vec2(0, 0);
    obj[mapTransform] = null;
    obj[privMapUv] = uv;
    if (channels > 0) {
      obj[privMapChannel] = channels > 1 ? "rgb" : "g";
    }
    obj[privMapVertexColor] = false;
    if (!pc._matTex2D) {
      pc._matTex2D = [];
    }
    pc._matTex2D[name] = channels;
    Object.defineProperty(StandardMaterial.prototype, privMap.substring(1), {get:function() {
      return this[privMap];
    }, set:function(value) {
      var oldVal = this[privMap];
      if (!!oldVal ^ !!value) {
        this.dirtyShader = true;
      }
      if (oldVal && value) {
        if (oldVal.rgbm !== value.rgbm || oldVal.fixCubemapSeams !== value.fixCubemapSeams || oldVal.format !== value.format) {
          this.dirtyShader = true;
        }
      }
      this[privMap] = value;
    }});
    var mapTiling = privMapTiling.substring(1);
    var mapOffset = privMapOffset.substring(1);
    Object.defineProperty(StandardMaterial.prototype, mapTiling, {get:function() {
      return this[privMapTiling];
    }, set:function(value) {
      this.dirtyShader = true;
      this[privMapTiling] = value;
    }});
    _prop2Uniform[mapTiling] = function(mat, val, changeMat) {
      var tform = mat._updateMapTransform(changeMat ? mat[mapTransform] : null, val, mat[privMapOffset]);
      return {name:"texture_" + mapTransform, value:tform.data};
    };
    Object.defineProperty(StandardMaterial.prototype, mapOffset, {get:function() {
      return this[privMapOffset];
    }, set:function(value) {
      this.dirtyShader = true;
      this[privMapOffset] = value;
    }});
    _prop2Uniform[mapOffset] = function(mat, val, changeMat) {
      var tform = mat._updateMapTransform(changeMat ? mat[mapTransform] : null, mat[privMapTiling], val);
      return {name:"texture_" + mapTransform, value:tform.data};
    };
    Object.defineProperty(StandardMaterial.prototype, privMapUv.substring(1), {get:function() {
      return this[privMapUv];
    }, set:function(value) {
      if (this[privMapUv] !== value) {
        this.dirtyShader = true;
      }
      this[privMapUv] = value;
    }});
    Object.defineProperty(StandardMaterial.prototype, privMapChannel.substring(1), {get:function() {
      return this[privMapChannel];
    }, set:function(value) {
      if (this[privMapChannel] !== value) {
        this.dirtyShader = true;
      }
      this[privMapChannel] = value;
    }});
    Object.defineProperty(StandardMaterial.prototype, privMapVertexColor.substring(1), {get:function() {
      return this[privMapVertexColor];
    }, set:function(value) {
      this.dirtyShader = true;
      this[privMapVertexColor] = value;
    }});
    _propsSerial.push(privMap.substring(1));
    _propsSerial.push(privMapTiling.substring(1));
    _propsSerial.push(privMapOffset.substring(1));
    _propsSerial.push(privMapUv.substring(1));
    _propsSerial.push(privMapChannel.substring(1));
    _propsSerial.push(privMapVertexColor.substring(1));
    _propsInternalNull.push(mapTransform);
  };
  var _propsColor = [];
  var _defineColor = function(obj, name, defaultValue, hasMultiplier) {
    var priv = "_" + name;
    var uform = name + "Uniform";
    var mult = name + "Intensity";
    var pmult = "_" + mult;
    obj[priv] = defaultValue;
    obj[uform] = new Float32Array(3);
    Object.defineProperty(StandardMaterial.prototype, name, {get:function() {
      this.dirtyColor = true;
      this.dirtyShader = true;
      return this[priv];
    }, set:function(value) {
      var oldVal = this[priv];
      var wasBw = oldVal.data[0] === 0 && oldVal.data[1] === 0 && oldVal.data[2] === 0 || oldVal.data[0] === 1 && oldVal.data[1] === 1 && oldVal.data[2] === 1;
      var isBw = value.data[0] === 0 && value.data[1] === 0 && value.data[2] === 0 || value.data[0] === 1 && value.data[1] === 1 && value.data[2] === 1;
      if (wasBw ^ isBw) {
        this.dirtyShader = true;
      }
      this.dirtyColor = true;
      this[priv] = value;
    }});
    _propsSerial.push(name);
    _propsInternalVec3.push(uform);
    _propsColor.push(name);
    _prop2Uniform[name] = function(mat, val, changeMat) {
      var arr = changeMat ? mat[uform] : new Float32Array(3);
      var gammaCorrection = false;
      if (mat.useGammaTonemap) {
        var scene = mat._scene || pc.Application.getApplication().scene;
        gammaCorrection = scene.gammaCorrection;
      }
      for (var c = 0;c < 3;c++) {
        if (gammaCorrection) {
          arr[c] = Math.pow(val.data[c], 2.2);
        } else {
          arr[c] = val.data[c];
        }
        if (hasMultiplier) {
          arr[c] *= mat[pmult];
        }
      }
      return {name:"material_" + name, value:arr};
    };
    if (hasMultiplier) {
      obj[pmult] = 1;
      Object.defineProperty(StandardMaterial.prototype, mult, {get:function() {
        return this[pmult];
      }, set:function(value) {
        var oldVal = this[pmult];
        var wasBw = oldVal === 0 || oldVal === 1;
        var isBw = value === 0 || value === 1;
        if (wasBw ^ isBw) {
          this.dirtyShader = true;
        }
        this.dirtyColor = true;
        this[pmult] = value;
      }});
      _propsSerial.push(mult);
      _prop2Uniform[mult] = function(mat, val, changeMat) {
        var arr = changeMat ? mat[uform] : new Float32Array(3);
        var gammaCorrection = false;
        if (mat.useGammaTonemap) {
          var scene = mat._scene || pc.Application.getApplication().scene;
          gammaCorrection = scene.gammaCorrection;
        }
        for (var c = 0;c < 3;c++) {
          if (gammaCorrection) {
            arr[c] = Math.pow(mat[priv].data[c], 2.2);
          } else {
            arr[c] = mat[priv].data[c];
          }
          arr[c] *= mat[pmult];
        }
        return {name:"material_" + name, value:arr};
      };
    }
  };
  var _defineFloat = function(obj, name, defaultValue, func) {
    var priv = "_" + name;
    obj[priv] = defaultValue;
    Object.defineProperty(StandardMaterial.prototype, name, {get:function() {
      return this[priv];
    }, set:function(value) {
      var oldVal = this[priv];
      var wasBw = oldVal === 0 || oldVal === 1;
      var isBw = value === 0 || value === 1;
      if (wasBw ^ isBw) {
        this.dirtyShader = true;
      }
      this[priv] = value;
    }});
    _propsSerial.push(name);
    _prop2Uniform[name] = func !== undefined ? func : function(mat, val, changeMat) {
      return {name:"material_" + name, value:val};
    };
  };
  var _defineObject = function(obj, name, func) {
    var priv = "_" + name;
    obj[priv] = null;
    Object.defineProperty(StandardMaterial.prototype, name, {get:function() {
      return this[priv];
    }, set:function(value) {
      var oldVal = this[priv];
      if (!!oldVal ^ !!value) {
        this.dirtyShader = true;
      }
      this[priv] = value;
    }});
    _propsSerial.push(name);
    _prop2Uniform[name] = func;
  };
  var _defineChunks = function(obj) {
    this._chunks = null;
    Object.defineProperty(StandardMaterial.prototype, "chunks", {get:function() {
      this.dirtyShader = true;
      return this._chunks;
    }, set:function(value) {
      this.dirtyShader = true;
      this._chunks = value;
    }});
    _propsSerial.push("chunks");
  };
  var _defineFlag = function(obj, name, defaultValue) {
    var priv = "_" + name;
    obj[priv] = defaultValue;
    Object.defineProperty(StandardMaterial.prototype, name, {get:function() {
      return this[priv];
    }, set:function(value) {
      if (this[priv] !== value) {
        this.dirtyShader = true;
      }
      this[priv] = value;
    }});
    _propsSerial.push(name);
  };
  var Chunks = function() {
  };
  Chunks.prototype.copy = function(from) {
    for (var p in from) {
      if (from.hasOwnProperty(p) && p !== "copy") {
        this[p] = from[p];
      }
    }
  };
  StandardMaterial = pc.inherits(StandardMaterial, pc.Material);
  pc.extend(StandardMaterial.prototype, {reset:function() {
    this.blendType = pc.BLEND_NONE;
    var i;
    for (i = 0;i < _propsSerial.length;i++) {
      var defVal = _propsSerialDefaultVal[i];
      this[_propsSerial[i]] = defVal ? defVal.clone ? defVal.clone() : defVal : defVal;
    }
    for (i = 0;i < _propsInternalNull.length;i++) {
      this[_propsInternalNull[i]] = null;
    }
    for (i = 0;i < _propsInternalVec3.length;i++) {
      this[_propsInternalVec3[i]] = new Float32Array(3);
    }
    this._chunks = new Chunks;
    this.cubeMapMinUniform = new Float32Array(3);
    this.cubeMapMaxUniform = new Float32Array(3);
  }, clone:function() {
    var clone = new pc.StandardMaterial;
    pc.Material.prototype._cloneInternal.call(this, clone);
    var pname;
    for (var i = 0;i < _propsSerial.length;i++) {
      pname = _propsSerial[i];
      if (this[pname] !== undefined) {
        if (this[pname] && this[pname].copy) {
          if (clone[pname]) {
            clone[pname].copy(this[pname]);
          } else {
            clone[pname] = this[pname].clone();
          }
        } else {
          clone[pname] = this[pname];
        }
      }
    }
    if (!clone.shader) {
      clone.update();
    }
    return clone;
  }, init:function(data) {
    this.reset();
    this.name = data.name;
    if (data.chunks) {
      this.chunks.copy(data.chunks);
    }
    for (var i = 0;i < data.parameters.length;i++) {
      var param = data.parameters[i];
      if (param.type === "vec3") {
        this[param.name] = _createRgb(param);
      } else {
        if (param.type === "vec2") {
          this[param.name] = _createVec2(param);
        } else {
          if (param.type === "texture") {
            this[param.name] = _createTexture(param);
          } else {
            if (param.type === "cubemap") {
              this[param.name] = _createCubemap(param);
            } else {
              if (param.name === "bumpMapFactor") {
                this.bumpiness = param.data;
              } else {
                if (param.type === "boundingbox") {
                  this[param.name] = _createBoundingBox(param);
                } else {
                  this[param.name] = param.data;
                }
              }
            }
          }
        }
      }
    }
    this.update();
  }, _updateMapTransform:function(transform, tiling, offset) {
    transform = transform || new pc.Vec4;
    transform.set(tiling.x, tiling.y, offset.x, offset.y);
    if (transform.x === 1 && transform.y === 1 && transform.z === 0 && transform.w === 0) {
      return null;
    }
    return transform;
  }, _collectLights:function(lType, lights, lightsSorted, mask, staticLightList) {
    var light;
    var i;
    for (i = 0;i < lights.length;i++) {
      light = lights[i];
      if (light._enabled) {
        if (light._mask & mask) {
          if (light._type === lType) {
            if (lType !== pc.LIGHTTYPE_DIRECTIONAL) {
              if (light.isStatic) {
                continue;
              }
            }
            lightsSorted.push(light);
          }
        }
      }
    }
    if (staticLightList) {
      for (i = 0;i < staticLightList.length;i++) {
        light = staticLightList[i];
        if (light._type === lType) {
          lightsSorted.push(light);
        }
      }
    }
  }, _setParameter:function(name, value) {
    this.setParameter(name, value);
    this._propsSet.push(name);
  }, _clearParameters:function() {
    var props = this._propsSet;
    for (var i = 0;i < props.length;i++) {
      delete this.parameters[props[i]];
    }
    this._propsSet = [];
  }, _updateMap:function(p) {
    var mname = p + "Map";
    if (this[mname]) {
      this._setParameter("texture_" + mname, this[mname]);
      var tname = mname + "Transform";
      this[tname] = this._updateMapTransform(this[tname], this[mname + "Tiling"], this[mname + "Offset"]);
      if (this[tname]) {
        this._setParameter("texture_" + tname, this[tname].data);
      }
    }
  }, getUniform:function(varName, value, changeMat) {
    var func = _prop2Uniform[varName];
    if (func) {
      return func(this, value, changeMat);
    }
    return null;
  }, update:function() {
    this._clearParameters();
    this._setParameter("material_ambient", this.ambientUniform);
    if (!this.diffuseMap || this.diffuseMapTint) {
      this._setParameter("material_diffuse", this.diffuseUniform);
    }
    if (!this.useMetalness) {
      if (!this.specularMap || this.specularMapTint) {
        this._setParameter("material_specular", this.specularUniform);
      }
    } else {
      if (!this.metalnessMap || this.metalness < 1) {
        this._setParameter("material_metalness", this.metalness);
      }
    }
    this._setParameter(this.getUniform("shininess", this.shininess, true));
    if (!this.emissiveMap || this.emissiveMapTint) {
      this._setParameter("material_emissive", this.emissiveUniform);
    }
    if (this.emissiveMap) {
      this._setParameter("material_emissiveIntensity", this.emissiveIntensity);
    }
    if (this.refraction > 0) {
      this._setParameter("material_refraction", this.refraction);
      this._setParameter("material_refractionIndex", this.refractionIndex);
    }
    this._setParameter("material_opacity", this.opacity);
    if (this.occludeSpecular) {
      this._setParameter("material_occludeSpecularIntensity", this.occludeSpecularIntensity);
    }
    if (this.cubeMapProjection === pc.CUBEPROJ_BOX) {
      this._setParameter(this.getUniform("cubeMapProjectionBox", this.cubeMapProjectionBox, true));
    }
    for (var p in pc._matTex2D) {
      this._updateMap(p);
    }
    if (this.ambientSH) {
      this._setParameter("ambientSH[0]", this.ambientSH);
    }
    if (this.normalMap) {
      this._setParameter("material_bumpiness", this.bumpiness);
    }
    if (this.heightMap) {
      this._setParameter(this.getUniform("heightMapFactor", this.heightMapFactor, true));
    }
    if (this.cubeMap) {
      this._setParameter("texture_cubeMap", this.cubeMap);
    }
    if (this.prefilteredCubeMap128) {
      this._setParameter("texture_prefilteredCubeMap128", this.prefilteredCubeMap128);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[0]) {
        this._setParameter("texture_prefilteredCubeMap128", this._scene._skyboxPrefiltered[0]);
      }
    }
    if (this.prefilteredCubeMap64) {
      this._setParameter("texture_prefilteredCubeMap64", this.prefilteredCubeMap64);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[1]) {
        this._setParameter("texture_prefilteredCubeMap64", this._scene._skyboxPrefiltered[1]);
      }
    }
    if (this.prefilteredCubeMap32) {
      this._setParameter("texture_prefilteredCubeMap32", this.prefilteredCubeMap32);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[2]) {
        this._setParameter("texture_prefilteredCubeMap32", this._scene._skyboxPrefiltered[2]);
      }
    }
    if (this.prefilteredCubeMap16) {
      this._setParameter("texture_prefilteredCubeMap16", this.prefilteredCubeMap16);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[3]) {
        this._setParameter("texture_prefilteredCubeMap16", this._scene._skyboxPrefiltered[3]);
      }
    }
    if (this.prefilteredCubeMap8) {
      this._setParameter("texture_prefilteredCubeMap8", this.prefilteredCubeMap8);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[4]) {
        this._setParameter("texture_prefilteredCubeMap8", this._scene._skyboxPrefiltered[4]);
      }
    }
    if (this.prefilteredCubeMap4) {
      this._setParameter("texture_prefilteredCubeMap4", this.prefilteredCubeMap4);
    } else {
      if (this._scene && this._scene._skyboxPrefiltered[5]) {
        this._setParameter("texture_prefilteredCubeMap4", this._scene._skyboxPrefiltered[5]);
      }
    }
    if (this.sphereMap) {
      this._setParameter("texture_sphereMap", this.sphereMap);
    }
    if (this.dpAtlas) {
      this._setParameter("texture_sphereMap", this.dpAtlas);
    }
    this._setParameter("material_reflectivity", this.reflectivity);
    if (this.dirtyShader || !this._scene) {
      this.shader = null;
      this.clearVariants();
    }
    this._processColor();
  }, _processColor:function() {
    var c, i;
    if (!this.dirtyColor) {
      return;
    }
    if (!this._scene && this.useGammaTonemap) {
      return;
    }
    var gammaCorrection = false;
    if (this.useGammaTonemap) {
      gammaCorrection = this._scene.gammaCorrection;
    }
    for (i = 0;i < _propsColor.length;i++) {
      var clr = this["_" + _propsColor[i]];
      var arr = this[_propsColor[i] + "Uniform"];
      for (c = 0;c < 3;c++) {
        if (gammaCorrection) {
          arr[c] = Math.pow(clr.data[c], 2.2);
        } else {
          arr[c] = clr.data[c];
        }
      }
    }
    for (c = 0;c < 3;c++) {
      this.emissiveUniform[c] *= this.emissiveIntensity;
    }
    this.dirtyColor = false;
  }, _getMapTransformID:function(xform, uv) {
    if (!xform) {
      return 0;
    }
    if (!this._mapXForms[uv]) {
      this._mapXForms[uv] = [];
    }
    var i, j, same;
    for (i = 0;i < this._mapXForms[uv].length;i++) {
      same = true;
      for (j = 0;j < xform.data.length;j++) {
        if (this._mapXForms[uv][i][j] != xform.data[j]) {
          same = false;
          break;
        }
      }
      if (same) {
        return i + 1;
      }
    }
    var newID = this._mapXForms[uv].length;
    this._mapXForms[uv][newID] = [];
    for (j = 0;j < xform.data.length;j++) {
      this._mapXForms[uv][newID][j] = xform.data[j];
    }
    return newID + 1;
  }, updateShader:function(device, scene, objDefs, staticLightList, pass) {
    var i, c;
    if (!this._scene) {
      this._scene = scene;
      this._processColor();
    }
    var lights = scene._lights;
    this._mapXForms = [];
    var useTexCubeLod = device.useTexCubeLod;
    var useDp = !device.extTextureLod;
    var globalSky128, globalSky64, globalSky32, globalSky16, globalSky8, globalSky4;
    if (this.useSkybox) {
      globalSky128 = scene._skyboxPrefiltered[0];
      globalSky64 = scene._skyboxPrefiltered[1];
      globalSky32 = scene._skyboxPrefiltered[2];
      globalSky16 = scene._skyboxPrefiltered[3];
      globalSky8 = scene._skyboxPrefiltered[4];
      globalSky4 = scene._skyboxPrefiltered[5];
    }
    var prefilteredCubeMap128 = this.prefilteredCubeMap128 || globalSky128;
    var prefilteredCubeMap64 = this.prefilteredCubeMap64 || globalSky64;
    var prefilteredCubeMap32 = this.prefilteredCubeMap32 || globalSky32;
    var prefilteredCubeMap16 = this.prefilteredCubeMap16 || globalSky16;
    var prefilteredCubeMap8 = this.prefilteredCubeMap8 || globalSky8;
    var prefilteredCubeMap4 = this.prefilteredCubeMap4 || globalSky4;
    if (prefilteredCubeMap128) {
      var allMips = prefilteredCubeMap128 && prefilteredCubeMap64 && prefilteredCubeMap32 && prefilteredCubeMap16 && prefilteredCubeMap8 && prefilteredCubeMap4;
      if (useDp && allMips) {
        if (!prefilteredCubeMap128.dpAtlas) {
          prefilteredCubeMap128.dpAtlas = pc.generateDpAtlas(device, [prefilteredCubeMap128, prefilteredCubeMap64, prefilteredCubeMap32, prefilteredCubeMap16, prefilteredCubeMap8, prefilteredCubeMap4]);
          prefilteredCubeMap128.sh = pc.shFromCubemap(prefilteredCubeMap16);
        }
        this.dpAtlas = prefilteredCubeMap128.dpAtlas;
        this.ambientSH = prefilteredCubeMap128.sh;
        this._setParameter("ambientSH[0]", this.ambientSH);
        this._setParameter("texture_sphereMap", this.dpAtlas);
      } else {
        if (useTexCubeLod) {
          if (prefilteredCubeMap128._levels.length < 6) {
            if (allMips) {
              this._setParameter("texture_prefilteredCubeMap128", prefilteredCubeMap128);
            } else {
              console.log("Can't use prefiltered cubemap: " + allMips + ", " + useTexCubeLod + ", " + prefilteredCubeMap128._levels);
            }
          } else {
            this._setParameter("texture_prefilteredCubeMap128", prefilteredCubeMap128);
          }
        } else {
          if (allMips) {
            this._setParameter("texture_prefilteredCubeMap128", prefilteredCubeMap128);
            this._setParameter("texture_prefilteredCubeMap64", prefilteredCubeMap64);
            this._setParameter("texture_prefilteredCubeMap32", prefilteredCubeMap32);
            this._setParameter("texture_prefilteredCubeMap16", prefilteredCubeMap16);
            this._setParameter("texture_prefilteredCubeMap8", prefilteredCubeMap8);
            this._setParameter("texture_prefilteredCubeMap4", prefilteredCubeMap4);
          } else {
            console.log("Can't use prefiltered cubemap: " + allMips + ", " + useTexCubeLod + ", " + prefilteredCubeMap128._levels);
          }
        }
      }
    }
    var specularTint = false;
    var useSpecular = (this.useMetalness ? true : !!this.specularMap) || !!this.sphereMap || !!this.cubeMap || !!this.dpAtlas;
    useSpecular = useSpecular || (this.useMetalness ? true : !(this.specular.data[0] === 0 && this.specular.data[1] === 0 && this.specular.data[2] === 0));
    if (useSpecular) {
      if (this.specularMapTint && !this.useMetalness) {
        specularTint = this.specular.data[0] !== 1 || this.specular.data[1] !== 1 || this.specular.data[2] !== 1;
      }
    }
    var rgbmReflection = (prefilteredCubeMap128 ? prefilteredCubeMap128.rgbm : false) || (this.cubeMap ? this.cubeMap.rgbm : false) || (this.sphereMap ? this.sphereMap.rgbm : false) || (this.dpAtlas ? this.dpAtlas.rgbm : false);
    var hdrReflection = (prefilteredCubeMap128 ? prefilteredCubeMap128.rgbm || prefilteredCubeMap128.format === pc.PIXELFORMAT_RGBA32F : false) || (this.cubeMap ? this.cubeMap.rgbm || this.cubeMap.format === pc.PIXELFORMAT_RGBA32F : false) || (this.sphereMap ? this.sphereMap.rgbm || this.sphereMap.format === pc.PIXELFORMAT_RGBA32F : false) || (this.dpAtlas ? this.dpAtlas.rgbm || this.dpAtlas.format === pc.PIXELFORMAT_RGBA32F : false);
    var emissiveTint = (this.emissive.data[0] !== 1 || this.emissive.data[1] !== 1 || this.emissive.data[2] !== 1 || this.emissiveIntensity !== 1) && this.emissiveMapTint;
    emissiveTint = emissiveTint ? 3 : this.emissiveIntensity !== 1 ? 1 : 0;
    var options = {fog:this.useFog ? scene.fog : "none", gamma:this.useGammaTonemap ? scene.gammaCorrection : pc.GAMMA_NONE, toneMap:this.useGammaTonemap ? scene.toneMapping : -1, blendMapsWithColors:true, modulateAmbient:this.ambientTint, diffuseTint:(this.diffuse.data[0] !== 1 || this.diffuse.data[1] !== 1 || this.diffuse.data[2] !== 1) && this.diffuseMapTint, specularTint:specularTint, metalnessTint:this.useMetalness && this.metalness < 1, glossTint:true, emissiveTint:emissiveTint, opacityTint:this.opacity !==
    1 && this.blendType !== pc.BLEND_NONE, alphaTest:this.alphaTest > 0, alphaToCoverage:this.alphaToCoverage, needsNormalFloat:this.normalizeNormalMap, sphereMap:!!this.sphereMap, cubeMap:!!this.cubeMap, dpAtlas:!!this.dpAtlas, ambientSH:!!this.ambientSH, useSpecular:useSpecular, rgbmReflection:rgbmReflection, hdrReflection:hdrReflection, fixSeams:prefilteredCubeMap128 ? prefilteredCubeMap128.fixCubemapSeams : this.cubeMap ? this.cubeMap.fixCubemapSeams : false, prefilteredCubemap:!!prefilteredCubeMap128,
    emissiveFormat:this.emissiveMap ? this.emissiveMap.rgbm ? 1 : this.emissiveMap.format === pc.PIXELFORMAT_RGBA32F ? 2 : 0 : null, lightMapFormat:this.lightMap ? this.lightMap.rgbm ? 1 : this.lightMap.format === pc.PIXELFORMAT_RGBA32F ? 2 : 0 : null, useRgbm:rgbmReflection || (this.emissiveMap ? this.emissiveMap.rgbm : 0) || (this.lightMap ? this.lightMap.rgbm : 0), specularAA:this.specularAntialias, conserveEnergy:this.conserveEnergy, occludeSpecular:this.occludeSpecular, occludeSpecularFloat:this.occludeSpecularIntensity !==
    1.0, occludeDirect:this.occludeDirect, shadingModel:this.shadingModel, fresnelModel:this.fresnelModel, packedNormal:this.normalMap ? this.normalMap.format === pc.PIXELFORMAT_DXT5 : false, forceFragmentPrecision:this.forceFragmentPrecision, fastTbn:this.fastTbn, cubeMapProjection:this.cubeMapProjection, chunks:this.chunks, customFragmentShader:this.customFragmentShader, refraction:!!this.refraction, useMetalness:this.useMetalness, blendType:this.blendType, skyboxIntensity:prefilteredCubeMap128 ===
    globalSky128 && prefilteredCubeMap128 && scene.skyboxIntensity !== 1, forceUv1:this.forceUv1, useTexCubeLod:useTexCubeLod, msdf:!!this.msdfMap, twoSidedLighting:this.twoSidedLighting};
    if (pass === pc.SHADER_FORWARDHDR) {
      if (options.gamma) {
        options.gamma = pc.GAMMA_SRGBHDR;
      }
      options.toneMap = pc.TONEMAP_LINEAR;
    }
    var hasUv0 = false;
    var hasUv1 = false;
    var hasVcolor = false;
    if (objDefs) {
      options.noShadow = (objDefs & pc.SHADERDEF_NOSHADOW) !== 0;
      options.screenSpace = (objDefs & pc.SHADERDEF_SCREENSPACE) !== 0;
      options.skin = (objDefs & pc.SHADERDEF_SKIN) !== 0;
      options.useInstancing = (objDefs & pc.SHADERDEF_INSTANCING) !== 0;
      if ((objDefs & pc.SHADERDEF_LM) !== 0) {
        options.lightMapFormat = 1;
        options.lightMap = true;
        options.lightMapChannel = "rgb";
        options.lightMapUv = 1;
        options.lightMapTransform = 0;
        options.lightMapWithoutAmbient = !this.lightMap;
        options.useRgbm = true;
        if ((objDefs & pc.SHADERDEF_DIRLM) !== 0) {
          options.dirLightMap = true;
        }
      }
      hasUv0 = (objDefs & pc.SHADERDEF_UV0) !== 0;
      hasUv1 = (objDefs & pc.SHADERDEF_UV1) !== 0;
      hasVcolor = (objDefs & pc.SHADERDEF_VCOLOR) !== 0;
    }
    for (var p in pc._matTex2D) {
      if (p === "opacity" && this.blendType === pc.BLEND_NONE && this.alphaTest === 0.0 && !this.alphaToCoverage) {
        continue;
      }
      var cname;
      var mname = p + "Map";
      var vname = mname + "VertexColor";
      if (p !== "height" && this[vname]) {
        if (hasVcolor) {
          cname = mname + "Channel";
          options[vname] = this[vname];
          options[cname] = this[cname];
          options.vertexColors = true;
        }
      } else {
        if (this[mname]) {
          var uname = mname + "Uv";
          var allow = true;
          if (this[uname] === 0 && !hasUv0) {
            allow = false;
          }
          if (this[uname] === 1 && !hasUv1) {
            allow = false;
          }
          if (allow) {
            options[mname] = !!this[mname];
            var tname = mname + "Transform";
            cname = mname + "Channel";
            options[tname] = this._getMapTransformID(this[tname], this[uname]);
            options[cname] = this[cname];
            options[uname] = this[uname];
          }
        }
      }
    }
    options.aoMapUv = options.aoMapUv || this.aoUvSet;
    this._mapXForms = null;
    if (this.useLighting) {
      var lightsSorted = [];
      var mask = objDefs ? objDefs >> 16 : 1;
      this._collectLights(pc.LIGHTTYPE_DIRECTIONAL, lights, lightsSorted, mask);
      this._collectLights(pc.LIGHTTYPE_POINT, lights, lightsSorted, mask, staticLightList);
      this._collectLights(pc.LIGHTTYPE_SPOT, lights, lightsSorted, mask, staticLightList);
      options.lights = lightsSorted;
    } else {
      options.lights = [];
    }
    if (options.lights.length === 0) {
      options.noShadow = false;
    }
    var library = device.getProgramLibrary();
    this.shader = library.getProgram("standard", options);
    if (!objDefs) {
      this.clearVariants();
      this.variants[0] = this.shader;
    }
    this.dirtyShader = false;
  }});
  var _defineMaterialProps = function(obj) {
    obj.dirtyShader = true;
    obj.dirtyColor = true;
    obj._scene = null;
    _defineColor(obj, "ambient", new pc.Color(0.7, 0.7, 0.7));
    _defineColor(obj, "diffuse", new pc.Color(1, 1, 1));
    _defineColor(obj, "specular", new pc.Color(0, 0, 0));
    _defineColor(obj, "emissive", new pc.Color(0, 0, 0), true);
    _defineFloat(obj, "shininess", 25, function(mat, shininess) {
      var value;
      if (mat.shadingModel === pc.SPECULAR_PHONG) {
        value = Math.pow(2, shininess * 0.01 * 11);
      } else {
        value = shininess * 0.01;
      }
      return {name:"material_shininess", value:value};
    });
    _defineFloat(obj, "heightMapFactor", 1, function(mat, height) {
      return {name:"material_heightMapFactor", value:height * 0.025};
    });
    _defineFloat(obj, "opacity", 1);
    _defineFloat(obj, "alphaTest", 0);
    _defineFloat(obj, "bumpiness", 1);
    _defineFloat(obj, "reflectivity", 1);
    _defineFloat(obj, "occludeSpecularIntensity", 1);
    _defineFloat(obj, "refraction", 0);
    _defineFloat(obj, "refractionIndex", 1.0 / 1.5);
    _defineFloat(obj, "metalness", 1);
    _defineFloat(obj, "aoUvSet", 0, null);
    _defineObject(obj, "ambientSH", function(mat, val, changeMat) {
      return {name:"ambientSH[0]", value:val};
    });
    _defineObject(obj, "cubeMapProjectionBox", function(mat, val, changeMat) {
      var bmin = changeMat ? mat.cubeMapMinUniform : new Float32Array(3);
      var bmax = changeMat ? mat.cubeMapMaxUniform : new Float32Array(3);
      bmin[0] = val.center.x - val.halfExtents.x;
      bmin[1] = val.center.y - val.halfExtents.y;
      bmin[2] = val.center.z - val.halfExtents.z;
      bmax[0] = val.center.x + val.halfExtents.x;
      bmax[1] = val.center.y + val.halfExtents.y;
      bmax[2] = val.center.z + val.halfExtents.z;
      return [{name:"envBoxMin", value:bmin}, {name:"envBoxMax", value:bmax}];
    });
    _defineChunks(obj);
    _defineFlag(obj, "ambientTint", false);
    _defineFlag(obj, "diffuseMapTint", false);
    _defineFlag(obj, "specularMapTint", false);
    _defineFlag(obj, "emissiveMapTint", false);
    _defineFlag(obj, "fastTbn", false);
    _defineFlag(obj, "specularAntialias", false);
    _defineFlag(obj, "useMetalness", false);
    _defineFlag(obj, "occludeDirect", false);
    _defineFlag(obj, "normalizeNormalMap", true);
    _defineFlag(obj, "conserveEnergy", true);
    _defineFlag(obj, "occludeSpecular", pc.SPECOCC_AO);
    _defineFlag(obj, "shadingModel", pc.SPECULAR_BLINN);
    _defineFlag(obj, "fresnelModel", pc.FRESNEL_NONE);
    _defineFlag(obj, "cubeMapProjection", pc.CUBEPROJ_NONE);
    _defineFlag(obj, "customFragmentShader", null);
    _defineFlag(obj, "forceFragmentPrecision", null);
    _defineFlag(obj, "useFog", true);
    _defineFlag(obj, "useLighting", true);
    _defineFlag(obj, "useGammaTonemap", true);
    _defineFlag(obj, "useSkybox", true);
    _defineFlag(obj, "forceUv1", false);
    _defineFlag(obj, "twoSidedLighting", false);
    _defineTex2D(obj, "diffuse", 0, 3);
    _defineTex2D(obj, "specular", 0, 3);
    _defineTex2D(obj, "emissive", 0, 3);
    _defineTex2D(obj, "normal", 0, -1);
    _defineTex2D(obj, "metalness", 0, 1);
    _defineTex2D(obj, "gloss", 0, 1);
    _defineTex2D(obj, "opacity", 0, 1);
    _defineTex2D(obj, "height", 0, 1);
    _defineTex2D(obj, "ao", 0, 1);
    _defineTex2D(obj, "light", 1, 3);
    _defineTex2D(obj, "msdf", 0, 3);
    _defineObject(obj, "cubeMap");
    _defineObject(obj, "sphereMap");
    _defineObject(obj, "dpAtlas");
    _defineObject(obj, "prefilteredCubeMap128");
    _defineObject(obj, "prefilteredCubeMap64");
    _defineObject(obj, "prefilteredCubeMap32");
    _defineObject(obj, "prefilteredCubeMap16");
    _defineObject(obj, "prefilteredCubeMap8");
    _defineObject(obj, "prefilteredCubeMap4");
    for (var i = 0;i < _propsSerial.length;i++) {
      _propsSerialDefaultVal[i] = obj[_propsSerial[i]];
    }
    obj._propsSet = [];
  };
  _defineMaterialProps(StandardMaterial.prototype);
  return {StandardMaterial:StandardMaterial};
}());
pc.extend(pc, function() {
  var id = 0;
  var Mesh = function() {
    this._refCount = 0;
    this.id = id++;
    this.vertexBuffer = null;
    this.indexBuffer = [null];
    this.primitive = [{type:0, base:0, count:0}];
    this.skin = null;
    this.morph = null;
    this._aabb = new pc.BoundingBox;
    this.boneAabb = null;
  };
  Object.defineProperty(Mesh.prototype, "aabb", {get:function() {
    return this.morph ? this.morph.aabb : this._aabb;
  }, set:function(aabb) {
    if (this.morph) {
      this._aabb = this.morph._baseAabb = aabb;
      this.morph._calculateAabb();
    } else {
      this._aabb = aabb;
    }
  }});
  var MeshInstance = function MeshInstance(node, mesh, material) {
    this._key = [0, 0];
    this._shader = [null, null, null];
    this.isStatic = false;
    this._staticLightList = null;
    this._staticSource = null;
    this.node = node;
    this._mesh = mesh;
    mesh._refCount++;
    this.material = material;
    this._shaderDefs = 1 << 16;
    this._shaderDefs |= mesh.vertexBuffer.format.hasUv0 ? pc.SHADERDEF_UV0 : 0;
    this._shaderDefs |= mesh.vertexBuffer.format.hasUv1 ? pc.SHADERDEF_UV1 : 0;
    this._shaderDefs |= mesh.vertexBuffer.format.hasColor ? pc.SHADERDEF_VCOLOR : 0;
    this.visible = true;
    this.layer = pc.LAYER_WORLD;
    this.renderStyle = pc.RENDERSTYLE_SOLID;
    this.castShadow = false;
    this._receiveShadow = true;
    this._screenSpace = false;
    this.drawToDepth = true;
    this.cull = true;
    this.pick = true;
    this._updateAabb = true;
    this.updateKey();
    this._skinInstance = null;
    this.morphInstance = null;
    this.instancingData = null;
    this.aabb = new pc.BoundingBox;
    this._boneAabb = null;
    this._aabbVer = -1;
    this.parameters = {};
  };
  Object.defineProperty(MeshInstance.prototype, "mesh", {get:function() {
    return this._mesh;
  }, set:function(mesh) {
    if (this._mesh) {
      this._mesh._refCount--;
    }
    this._mesh = mesh;
    if (mesh) {
      mesh._refCount++;
    }
  }});
  Object.defineProperty(MeshInstance.prototype, "aabb", {get:function() {
    if (!this._updateAabb) {
      return this._aabb;
    }
    if (this.skinInstance) {
      var numBones = this.mesh.skin.boneNames.length;
      var boneUsed, i;
      if (!this.mesh.boneAabb) {
        this.mesh.boneAabb = [];
        this.mesh.boneUsed = [];
        var elems = this.mesh.vertexBuffer.format.elements;
        var numVerts = this.mesh.vertexBuffer.numVertices;
        var vertSize = this.mesh.vertexBuffer.format.size;
        var index;
        var offsetP, offsetI, offsetW;
        var j, k, l, p;
        for (i = 0;i < elems.length;i++) {
          if (elems[i].name === pc.SEMANTIC_POSITION) {
            offsetP = elems[i].offset;
          } else {
            if (elems[i].name === pc.SEMANTIC_BLENDINDICES) {
              offsetI = elems[i].offset;
            } else {
              if (elems[i].name === pc.SEMANTIC_BLENDWEIGHT) {
                offsetW = elems[i].offset;
              }
            }
          }
        }
        var data8 = new Uint8Array(this.mesh.vertexBuffer.storage);
        var dataF = new Float32Array(this.mesh.vertexBuffer.storage);
        var offsetPF = offsetP / 4;
        var offsetWF = offsetW / 4;
        var vertSizeF = vertSize / 4;
        var bMax, bMin;
        var x, y, z;
        var boneMin = [];
        var boneMax = [];
        boneUsed = this.mesh.boneUsed;
        for (i = 0;i < numBones;i++) {
          boneMin[i] = new pc.Vec3(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE);
          boneMax[i] = new pc.Vec3(-Number.MAX_VALUE, -Number.MAX_VALUE, -Number.MAX_VALUE);
        }
        for (j = 0;j < numVerts;j++) {
          for (k = 0;k < 4;k++) {
            if (dataF[j * vertSizeF + offsetWF + k] > 0) {
              index = data8[j * vertSize + offsetI + k];
              x = dataF[j * vertSizeF + offsetPF];
              y = dataF[j * vertSizeF + offsetPF + 1];
              z = dataF[j * vertSizeF + offsetPF + 2];
              bMax = boneMax[index];
              bMin = boneMin[index];
              if (bMin.x > x) {
                bMin.x = x;
              }
              if (bMin.y > y) {
                bMin.y = y;
              }
              if (bMin.z > z) {
                bMin.z = z;
              }
              if (bMax.x < x) {
                bMax.x = x;
              }
              if (bMax.y < y) {
                bMax.y = y;
              }
              if (bMax.z < z) {
                bMax.z = z;
              }
              boneUsed[index] = true;
            }
          }
        }
        if (this.morphInstance) {
          var vertIndex;
          var targets = this.morphInstance.morph._targets;
          var minMorphedPos = new Float32Array(numVerts * 3);
          var maxMorphedPos = new Float32Array(numVerts * 3);
          var m, dx, dy, dz;
          var target, mtIndices, mtIndicesLength, deltaPos;
          for (j = 0;j < numVerts;j++) {
            minMorphedPos[j * 3] = maxMorphedPos[j * 3] = dataF[j * vertSizeF + offsetPF];
            minMorphedPos[j * 3 + 1] = maxMorphedPos[j * 3 + 1] = dataF[j * vertSizeF + offsetPF + 1];
            minMorphedPos[j * 3 + 2] = maxMorphedPos[j * 3 + 2] = dataF[j * vertSizeF + offsetPF + 2];
          }
          for (l = 0;l < targets.length;l++) {
            target = targets[l];
            mtIndices = target.indices;
            mtIndicesLength = mtIndices.length;
            deltaPos = target.deltaPositions;
            for (k = 0;k < mtIndicesLength;k++) {
              vertIndex = mtIndices[k];
              dx = deltaPos[k * 3];
              dy = deltaPos[k * 3 + 1];
              dz = deltaPos[k * 3 + 2];
              if (dx < 0) {
                minMorphedPos[vertIndex * 3] += dx;
              } else {
                maxMorphedPos[vertIndex * 3] += dx;
              }
              if (dy < 0) {
                minMorphedPos[vertIndex * 3 + 1] += dy;
              } else {
                maxMorphedPos[vertIndex * 3 + 1] += dy;
              }
              if (dz < 0) {
                minMorphedPos[vertIndex * 3 + 2] += dz;
              } else {
                maxMorphedPos[vertIndex * 3 + 2] += dz;
              }
            }
          }
          for (l = 0;l < targets.length;l++) {
            target = targets[l];
            mtIndices = target.indices;
            mtIndicesLength = mtIndices.length;
            deltaPos = target.deltaPositions;
            for (k = 0;k < mtIndicesLength;k++) {
              vertIndex = mtIndices[k];
              for (m = 0;m < 4;m++) {
                if (dataF[vertIndex * vertSizeF + offsetWF + m] > 0) {
                  index = data8[vertIndex * vertSize + offsetI + m];
                  bMax = boneMax[index];
                  bMin = boneMin[index];
                  x = minMorphedPos[vertIndex * 3];
                  y = minMorphedPos[vertIndex * 3 + 1];
                  z = minMorphedPos[vertIndex * 3 + 2];
                  if (bMin.x > x) {
                    bMin.x = x;
                  }
                  if (bMin.y > y) {
                    bMin.y = y;
                  }
                  if (bMin.z > z) {
                    bMin.z = z;
                  }
                  x = maxMorphedPos[vertIndex * 3];
                  y = maxMorphedPos[vertIndex * 3 + 1];
                  z = maxMorphedPos[vertIndex * 3 + 2];
                  if (bMax.x < x) {
                    bMax.x = x;
                  }
                  if (bMax.y < y) {
                    bMax.y = y;
                  }
                  if (bMax.z < z) {
                    bMax.z = z;
                  }
                }
              }
            }
          }
        }
        var aabb;
        for (i = 0;i < numBones;i++) {
          aabb = new pc.BoundingBox;
          aabb.setMinMax(boneMin[i], boneMax[i]);
          this.mesh.boneAabb.push(aabb);
        }
      }
      if (!this._boneAabb) {
        this._boneAabb = [];
        for (i = 0;i < this.mesh.boneAabb.length;i++) {
          this._boneAabb[i] = new pc.BoundingBox;
        }
      }
      boneUsed = this.mesh.boneUsed;
      for (i = 0;i < this.mesh.boneAabb.length;i++) {
        if (!boneUsed[i]) {
          continue;
        }
        this._boneAabb[i].setFromTransformedAabb(this.mesh.boneAabb[i], this.skinInstance.matrices[i]);
        this._boneAabb[i].center.add(this.skinInstance.rootNode.getPosition());
      }
      var first = true;
      for (i = 0;i < this.mesh.boneAabb.length;i++) {
        if (!boneUsed[i]) {
          continue;
        }
        if (first) {
          this._aabb.center.copy(this._boneAabb[i].center);
          this._aabb.halfExtents.copy(this._boneAabb[i].halfExtents);
          first = false;
        } else {
          this._aabb.add(this._boneAabb[i]);
        }
      }
    } else {
      if (this.node._aabbVer !== this._aabbVer) {
        this._aabb.setFromTransformedAabb(this.mesh.aabb, this.node.getWorldTransform());
        this._aabbVer = this.node._aabbVer;
      }
    }
    return this._aabb;
  }, set:function(aabb) {
    this._aabb = aabb;
  }});
  Object.defineProperty(MeshInstance.prototype, "material", {get:function() {
    return this._material;
  }, set:function(material) {
    var i;
    for (i = 0;i < this._shader.length;i++) {
      this._shader[i] = null;
    }
    if (this._material) {
      var meshInstances = this._material.meshInstances;
      i = meshInstances.indexOf(this);
      if (i !== -1) {
        meshInstances.splice(i, 1);
      }
    }
    this._material = material;
    if (this._material) {
      this._material.meshInstances.push(this);
      this.updateKey();
    }
  }});
  Object.defineProperty(MeshInstance.prototype, "layer", {get:function() {
    return this._layer;
  }, set:function(layer) {
    this._layer = layer;
    this.updateKey();
  }});
  Object.defineProperty(MeshInstance.prototype, "receiveShadow", {get:function() {
    return this._receiveShadow;
  }, set:function(val) {
    this._receiveShadow = val;
    this._shaderDefs = val ? this._shaderDefs & ~pc.SHADERDEF_NOSHADOW : this._shaderDefs | pc.SHADERDEF_NOSHADOW;
    this._shader[pc.SHADER_FORWARD] = null;
    this._shader[pc.SHADER_FORWARDHDR] = null;
  }});
  Object.defineProperty(MeshInstance.prototype, "skinInstance", {get:function() {
    return this._skinInstance;
  }, set:function(val) {
    this._skinInstance = val;
    this._shaderDefs = val ? this._shaderDefs | pc.SHADERDEF_SKIN : this._shaderDefs & ~pc.SHADERDEF_SKIN;
    for (var i = 0;i < this._shader.length;i++) {
      this._shader[i] = null;
    }
  }});
  Object.defineProperty(MeshInstance.prototype, "screenSpace", {get:function() {
    return this._screenSpace;
  }, set:function(val) {
    this._screenSpace = val;
    this._shaderDefs = val ? this._shaderDefs | pc.SHADERDEF_SCREENSPACE : this._shaderDefs & ~pc.SHADERDEF_SCREENSPACE;
    this._shader[pc.SHADER_FORWARD] = null;
  }});
  Object.defineProperty(MeshInstance.prototype, "key", {get:function() {
    return this._key[pc.SORTKEY_FORWARD];
  }, set:function(val) {
    this._key[pc.SORTKEY_FORWARD] = val;
  }});
  Object.defineProperty(MeshInstance.prototype, "mask", {get:function() {
    return this._shaderDefs >> 16;
  }, set:function(val) {
    var toggles = this._shaderDefs & 65535;
    this._shaderDefs = toggles | val << 16;
    this._shader[pc.SHADER_FORWARD] = null;
    this._shader[pc.SHADER_FORWARDHDR] = null;
  }});
  pc.extend(MeshInstance.prototype, {syncAabb:function() {
  }, updateKey:function() {
    var material = this.material;
    this._key[pc.SORTKEY_FORWARD] = getKey(this.layer, material.alphaToCoverage || material.alphaTest ? pc.BLEND_NORMAL : material.blendType, false, material.id);
  }, setParameter:pc.Material.prototype.setParameter, setParameters:pc.Material.prototype.setParameters, deleteParameter:pc.Material.prototype.deleteParameter, getParameter:pc.Material.prototype.getParameter, getParameters:pc.Material.prototype.getParameters, clearParameters:pc.Material.prototype.clearParameters});
  var Command = function(layer, blendType, command) {
    this._key = [];
    this._key[pc.SORTKEY_FORWARD] = getKey(layer, blendType, true, 0);
    this.command = command;
  };
  Object.defineProperty(Command.prototype, "key", {get:function() {
    return this._key[pc.SORTKEY_FORWARD];
  }, set:function(val) {
    this._key[pc.SORTKEY_FORWARD] = val;
  }});
  var InstancingData = function(numObjects, dynamic, instanceSize) {
    instanceSize = instanceSize || 16;
    this.buffer = new Float32Array(numObjects * instanceSize);
    this.count = numObjects;
    this.offset = 0;
    this.usage = dynamic ? pc.BUFFER_DYNAMIC : pc.BUFFER_STATIC;
    this._buffer = null;
  };
  InstancingData.prototype = {update:function() {
    if (this._buffer) {
      this._buffer.setData(this.buffer);
    }
  }};
  function getKey(layer, blendType, isCommand, materialId) {
    return (layer & 15) << 27 | (blendType === pc.BLEND_NONE ? 1 : 0) << 26 | (isCommand ? 1 : 0) << 25 | (materialId & 33554431) << 0;
  }
  return {Command:Command, Mesh:Mesh, MeshInstance:MeshInstance, InstancingData:InstancingData, _getDrawcallSortKey:getKey};
}());
pc.extend(pc, function() {
  var Skin = function(graphicsDevice, ibp, boneNames) {
    this.device = graphicsDevice;
    this.inverseBindPose = ibp;
    this.boneNames = boneNames;
  };
  var SkinInstance = function(skin, node) {
    this.skin = skin;
    this.rootNode = node;
    this._dirty = true;
    this.bones = [];
    var numBones = skin.inverseBindPose.length;
    var device = skin.device;
    if (device.supportsBoneTextures) {
      var size;
      if (numBones > 256) {
        size = 64;
      } else {
        if (numBones > 64) {
          size = 32;
        } else {
          if (numBones > 16) {
            size = 16;
          } else {
            size = 8;
          }
        }
      }
      this.boneTexture = new pc.Texture(device, {width:size, height:size, format:pc.PIXELFORMAT_RGBA32F, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
      this.matrixPalette = this.boneTexture.lock();
    } else {
      this.matrixPalette = new Float32Array(numBones * 16);
    }
    this.matrices = [];
    for (var i = 0;i < numBones;i++) {
      this.matrices[i] = new pc.Mat4;
    }
  };
  SkinInstance.prototype = {updateMatrices:function() {
    var pos = this.rootNode.getPosition();
    for (var i = this.bones.length - 1;i >= 0;i--) {
      this.matrices[i].mul2(this.bones[i].getWorldTransform(), this.skin.inverseBindPose[i]);
      this.matrices[i].data[12] -= pos.x;
      this.matrices[i].data[13] -= pos.y;
      this.matrices[i].data[14] -= pos.z;
    }
  }, updateMatrixPalette:function() {
    var pe;
    var mp = this.matrixPalette;
    var base;
    for (var i = this.bones.length - 1;i >= 0;i--) {
      pe = this.matrices[i].data;
      base = i * 16;
      mp[base] = pe[0];
      mp[base + 1] = pe[1];
      mp[base + 2] = pe[2];
      mp[base + 3] = pe[3];
      mp[base + 4] = pe[4];
      mp[base + 5] = pe[5];
      mp[base + 6] = pe[6];
      mp[base + 7] = pe[7];
      mp[base + 8] = pe[8];
      mp[base + 9] = pe[9];
      mp[base + 10] = pe[10];
      mp[base + 11] = pe[11];
      mp[base + 12] = pe[12];
      mp[base + 13] = pe[13];
      mp[base + 14] = pe[14];
      mp[base + 15] = pe[15];
    }
    if (this.skin.device.supportsBoneTextures) {
      this.boneTexture.lock();
      this.boneTexture.unlock();
    }
  }};
  return {Skin:Skin, SkinInstance:SkinInstance};
}());
pc.extend(pc, function() {
  function PartitionedVertex() {
    this.index = 0;
    this.boneIndices = [0, 0, 0, 0];
  }
  function SkinPartition() {
    this.partition = 0;
    this.vertexStart = 0;
    this.vertexCount = 0;
    this.indexStart = 0;
    this.indexCount = 0;
    this.boneIndices = [];
    this.vertices = [];
    this.indices = [];
    this.indexMap = {};
  }
  SkinPartition.prototype = {addVertex:function(vertex, idx, vertexArray) {
    var remappedIndex = -1;
    if (this.indexMap[idx] !== undefined) {
      remappedIndex = this.indexMap[idx];
      this.indices.push(remappedIndex);
    } else {
      for (var influence = 0;influence < 4;influence++) {
        if (vertexArray.blendWeight.data[idx * 4 + influence] === 0) {
          continue;
        }
        var originalBoneIndex = vertexArray.blendIndices.data[vertex.index * 4 + influence];
        vertex.boneIndices[influence] = this.getBoneRemap(originalBoneIndex);
      }
      remappedIndex = this.vertices.length;
      this.indices.push(remappedIndex);
      this.vertices.push(vertex);
      this.indexMap[idx] = remappedIndex;
    }
  }, addPrimitive:function(vertices, vertexIndices, vertexArray, boneLimit) {
    var i, j;
    var bonesToAdd = [];
    var bonesToAddCount = 0;
    var vertexCount = vertices.length;
    for (i = 0;i < vertexCount;i++) {
      var vertex = vertices[i];
      var idx = vertex.index;
      for (var influence = 0;influence < 4;influence++) {
        if (vertexArray.blendWeight.data[idx * 4 + influence] > 0) {
          var boneIndex = vertexArray.blendIndices.data[idx * 4 + influence];
          var needToAdd = true;
          for (j = 0;j < bonesToAddCount;j++) {
            if (bonesToAdd[j] == boneIndex) {
              needToAdd = false;
              break;
            }
          }
          if (needToAdd) {
            bonesToAdd[bonesToAddCount] = boneIndex;
            var boneRemap = this.getBoneRemap(boneIndex);
            bonesToAddCount += boneRemap === -1 ? 1 : 0;
          }
        }
      }
    }
    if (this.boneIndices.length + bonesToAddCount > boneLimit) {
      return false;
    }
    for (i = 0;i < bonesToAddCount;i++) {
      this.boneIndices.push(bonesToAdd[i]);
    }
    for (i = 0;i < vertexCount;i++) {
      this.addVertex(vertices[i], vertexIndices[i], vertexArray);
    }
    return true;
  }, getBoneRemap:function(boneIndex) {
    for (var i = 0;i < this.boneIndices.length;i++) {
      if (this.boneIndices[i] === boneIndex) {
        return i;
      }
    }
    return -1;
  }};
  function indicesToReferences(model) {
    var i;
    var vertices = model.vertices;
    var skins = model.skins;
    var meshes = model.meshes;
    var meshInstances = model.meshInstances;
    for (i = 0;i < meshes.length;i++) {
      meshes[i].vertices = vertices[meshes[i].vertices];
      if (meshes[i].skin !== undefined) {
        meshes[i].skin = skins[meshes[i].skin];
      }
    }
    for (i = 0;i < meshInstances.length;i++) {
      meshInstances[i].mesh = meshes[meshInstances[i].mesh];
    }
  }
  function referencesToIndices(model) {
    var i;
    var vertices = model.vertices;
    var skins = model.skins;
    var meshes = model.meshes;
    var meshInstances = model.meshInstances;
    for (i = 0;i < meshes.length;i++) {
      meshes[i].vertices = vertices.indexOf(meshes[i].vertices);
      if (meshes[i].skin !== undefined) {
        meshes[i].skin = skins.indexOf(meshes[i].skin);
      }
    }
    for (i = 0;i < meshInstances.length;i++) {
      meshInstances[i].mesh = meshes.indexOf(meshInstances[i].mesh);
    }
  }
  function partitionSkin(model, materialMappings, boneLimit) {
    var i, j, k, index;
    indicesToReferences(model);
    var vertexArrays = model.vertices;
    var skins = model.skins;
    var mesh;
    var meshes = model.meshes;
    var meshInstances = model.meshInstances;
    var getVertex = function(idx) {
      var vert = new PartitionedVertex;
      vert.index = idx;
      return vert;
    };
    for (i = skins.length - 1;i >= 0;i--) {
      if (skins[i].boneNames.length > boneLimit) {
        var skin = skins.splice(i, 1)[0];
        var meshesToSplit = [];
        for (j = 0;j < meshes.length;j++) {
          if (meshes[j].skin === skin) {
            meshesToSplit.push(meshes[j]);
          }
        }
        for (j = 0;j < meshesToSplit.length;j++) {
          index = meshes.indexOf(meshesToSplit[j]);
          if (index !== -1) {
            meshes.splice(index, 1);
          }
        }
        if (meshesToSplit.length === 0) {
          throw new Error("partitionSkin: There should be at least one mesh that references a skin");
        }
        var vertexArray = meshesToSplit[0].vertices;
        for (j = 1;j < meshesToSplit.length;j++) {
          if (meshesToSplit[j].vertices !== vertexArray) {
            throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");
          }
        }
        var partition;
        var partitions = [];
        var primitiveVertices = [];
        var primitiveIndices = [];
        var basePartition = 0;
        for (j = 0;j < meshesToSplit.length;j++) {
          mesh = meshesToSplit[j];
          var indices = mesh.indices;
          for (var iIndex = mesh.base;iIndex < mesh.base + mesh.count;) {
            index = indices[iIndex++];
            primitiveVertices[0] = getVertex(index);
            primitiveIndices[0] = index;
            index = indices[iIndex++];
            primitiveVertices[1] = getVertex(index);
            primitiveIndices[1] = index;
            index = indices[iIndex++];
            primitiveVertices[2] = getVertex(index);
            primitiveIndices[2] = index;
            var added = false;
            for (var iBonePartition = basePartition;iBonePartition < partitions.length;iBonePartition++) {
              partition = partitions[iBonePartition];
              if (partition.addPrimitive(primitiveVertices, primitiveIndices, vertexArray, boneLimit)) {
                added = true;
                break;
              }
            }
            if (!added) {
              partition = new SkinPartition;
              partition.originalMesh = mesh;
              partition.addPrimitive(primitiveVertices, primitiveIndices, vertexArray, boneLimit);
              partitions.push(partition);
            }
          }
          basePartition = partitions.length;
        }
        var partitionedVertices = [];
        var partitionedIndices = [];
        for (j = 0;j < partitions.length;j++) {
          partition = partitions[j];
          if (partition.vertices.length && partition.indices.length) {
            var vertexStart = partitionedVertices.length;
            var vertexCount = partition.vertices.length;
            var indexStart = partitionedIndices.length;
            var indexCount = partition.indices.length;
            partition.partition = j;
            partition.vertexStart = vertexStart;
            partition.vertexCount = vertexCount;
            partition.indexStart = indexStart;
            partition.indexCount = indexCount;
            var iSour;
            var iDest;
            iSour = 0;
            iDest = vertexStart;
            while (iSour < vertexCount) {
              partitionedVertices[iDest++] = partition.vertices[iSour++];
            }
            iSour = 0;
            iDest = indexStart;
            while (iSour < indexCount) {
              partitionedIndices[iDest++] = partition.indices[iSour++] + vertexStart;
            }
          }
        }
        var splitSkins = [];
        for (j = 0;j < partitions.length;j++) {
          partition = partitions[j];
          var ibp = [];
          var boneNames = [];
          for (k = 0;k < partition.boneIndices.length;k++) {
            ibp.push(skin.inverseBindMatrices[partition.boneIndices[k]]);
            boneNames.push(skin.boneNames[partition.boneIndices[k]]);
          }
          var splitSkin = {inverseBindMatrices:ibp, boneNames:boneNames};
          splitSkins.push(splitSkin);
          skins.push(splitSkin);
        }
        var attrib, attribName, data, components;
        var splitVertexArray = {};
        for (attribName in vertexArray) {
          splitVertexArray[attribName] = {components:vertexArray[attribName].components, data:[], type:vertexArray[attribName].type};
        }
        for (attribName in vertexArray) {
          if (attribName === "blendIndices") {
            var dstBoneIndices = splitVertexArray[attribName].data;
            for (j = 0;j < partitionedVertices.length;j++) {
              var srcBoneIndices = partitionedVertices[j].boneIndices;
              dstBoneIndices.push(srcBoneIndices[0], srcBoneIndices[1], srcBoneIndices[2], srcBoneIndices[3]);
            }
          } else {
            attrib = vertexArray[attribName];
            data = attrib.data;
            components = attrib.components;
            for (j = 0;j < partitionedVertices.length;j++) {
              index = partitionedVertices[j].index;
              for (k = 0;k < components;k++) {
                splitVertexArray[attribName].data.push(data[index * components + k]);
              }
            }
          }
        }
        vertexArrays[vertexArrays.indexOf(vertexArray)] = splitVertexArray;
        var base = 0;
        for (j = 0;j < partitions.length;j++) {
          partition = partitions[j];
          mesh = {aabb:{min:[0, 0, 0], max:[0, 0, 0]}, vertices:splitVertexArray, skin:splitSkins[j], indices:partitionedIndices.splice(0, partition.indexCount), type:"triangles", base:0, count:partition.indexCount};
          meshes.push(mesh);
          for (k = meshInstances.length - 1;k >= 0;k--) {
            if (meshInstances[k].mesh === partition.originalMesh) {
              meshInstances.push({mesh:mesh, node:meshInstances[k].node});
              if (materialMappings) {
                materialMappings.push({material:materialMappings[k].material, path:materialMappings[k].path});
              }
            }
          }
          base += partition.indexCount;
        }
        for (j = 0;j < partitions.length;j++) {
          partition = partitions[j];
          for (k = meshInstances.length - 1;k >= 0;k--) {
            if (meshInstances[k].mesh === partition.originalMesh) {
              meshInstances.splice(k, 1);
              if (materialMappings) {
                materialMappings.splice(k, 1);
              }
            }
          }
        }
      }
    }
    referencesToIndices(model);
  }
  return {partitionSkin:partitionSkin};
}());
pc.extend(pc, function() {
  var _morphMin = new pc.Vec3;
  var _morphMax = new pc.Vec3;
  var MorphTarget = function(options) {
    if (options.indices) {
      this.indices = options.indices;
    } else {
      var arr = options.deltaPositions;
      this.indices = [];
      this.indices.length = arr.length;
      for (var i = 0;i < arr.length;i++) {
        this.indices[i] = i;
      }
    }
    this.deltaPositions = options.deltaPositions;
    this.deltaNormals = options.deltaNormals;
    this.deltaTangents = options.deltaTangents;
    this.name = options.name;
    this.aabb = options.aabb;
  };
  var Morph = function(targets) {
    this.aabb = new pc.BoundingBox;
    this._baseBuffer = null;
    this._baseAabb = null;
    this._targets = targets;
    this._dirty = true;
    this._aabbDirty = true;
    this._baseData = null;
    this._offsetPF = 0;
    this._offsetNF = 0;
    this._offsetTF = 0;
    this._vertSizeF = 0;
  };
  pc.extend(Morph.prototype, {_setBaseMesh:function(baseMesh) {
    this._baseBuffer = baseMesh.vertexBuffer;
    this._baseAabb = baseMesh._aabb;
    this._baseData = new Float32Array(this._baseBuffer.storage);
    var offsetP = -1;
    var offsetN = -1;
    var offsetT = -1;
    var elems = this._baseBuffer.format.elements;
    var vertSize = this._baseBuffer.format.size;
    for (var j = 0;j < elems.length;j++) {
      if (elems[j].name === pc.SEMANTIC_POSITION) {
        offsetP = elems[j].offset;
      } else {
        if (elems[j].name === pc.SEMANTIC_NORMAL) {
          offsetN = elems[j].offset;
        } else {
          if (elems[j].name === pc.SEMANTIC_TANGENT) {
            offsetT = elems[j].offset;
          }
        }
      }
    }
    this._offsetPF = offsetP / 4;
    this._offsetNF = offsetN / 4;
    this._offsetTF = offsetT / 4;
    this._vertSizeF = vertSize / 4;
    this._dirty = true;
  }, _calculateAabb:function() {
    if (!this._baseBuffer) {
      return;
    }
    this.aabb.copy(this._baseAabb);
    var numVerts = this._baseBuffer.numVertices;
    var numIndices;
    var i, j, k, target, index, id;
    var x, y, z;
    var vertSizeF = this._vertSizeF;
    var offsetPF = this._offsetPF;
    var baseData = this._baseData;
    for (i = 0;i < this._targets.length;i++) {
      target = this._targets[i];
      if (!target.aabb && target.indices.length > 0) {
        target.aabb = this.aabb.clone();
        _morphMin.set(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE);
        _morphMax.set(-Number.MAX_VALUE, -Number.MAX_VALUE, -Number.MAX_VALUE);
        numIndices = target.indices.length;
        for (j = 0;j < numIndices;j++) {
          index = target.indices[j];
          id = index * vertSizeF + offsetPF;
          x = baseData[id] + target.deltaPositions[j * 3];
          y = baseData[id + 1] + target.deltaPositions[j * 3 + 1];
          z = baseData[id + 2] + target.deltaPositions[j * 3 + 2];
          if (_morphMin.x > x) {
            _morphMin.x = x;
          }
          if (_morphMin.y > y) {
            _morphMin.y = y;
          }
          if (_morphMin.z > z) {
            _morphMin.z = z;
          }
          if (_morphMax.x < x) {
            _morphMax.x = x;
          }
          if (_morphMax.y < y) {
            _morphMax.y = y;
          }
          if (_morphMax.z < z) {
            _morphMax.z = z;
          }
        }
        target.aabb.setMinMax(_morphMin, _morphMax);
      }
      if (target.aabb) {
        this.aabb.add(target.aabb);
      }
    }
    this._aabbDirty = false;
  }, addTarget:function(target) {
    this._targets.push(target);
    this._aabbDirty = true;
  }, removeTarget:function(target) {
    var index = this._targets.indexOf(target);
    if (index !== -1) {
      this._targets.splice(index, 1);
      this._aabbDirty = true;
    }
  }, getTarget:function(index) {
    return this._targets[index];
  }});
  var MorphInstance = function(morph) {
    this.morph = morph;
    this._vertexBuffer = null;
    this._vertexData = null;
    this._weights = [];
    this._dirty = true;
  };
  MorphInstance.prototype = {_setBaseMesh:function(baseMesh) {
    this.destroy();
    this._vertexBuffer = new pc.VertexBuffer(this.morph._baseBuffer.device, this.morph._baseBuffer.format, this.morph._baseBuffer.numVertices, pc.BUFFER_DYNAMIC, this.morph._baseBuffer.storage.slice(0));
    this._vertexData = new Float32Array(this._vertexBuffer.storage);
    this._weights = [];
    this._weights.length = this.morph._targets.length;
    for (var i = 0;i < this.morph._targets.length;i++) {
      this._weights[i] = 0;
    }
    this._dirty = true;
  }, destroy:function() {
    if (this._vertexBuffer) {
      this._vertexBuffer.destroy();
      this._vertexBuffer = null;
    }
  }, getWeight:function(index) {
    return this._weights[index];
  }, setWeight:function(index, weight) {
    this._weights[index] = weight;
    this._dirty = true;
  }, updateBounds:function(mesh) {
    if (this.morph._baseBuffer !== mesh.vertexBuffer) {
      this.morph._setBaseMesh(mesh);
    }
    if (!this._vertexData) {
      this._setBaseMesh(mesh);
    }
    if (this.morph._aabbDirty) {
      this.morph._calculateAabb();
    }
  }, update:function(mesh) {
    if (this.morph._baseBuffer !== mesh.vertexBuffer) {
      this.morph._setBaseMesh(mesh);
    }
    if (!this._vertexData) {
      this._setBaseMesh(mesh);
    }
    var numVerts = this.morph._baseBuffer.numVertices;
    var numIndices, index;
    var targets = this.morph._targets;
    var weights = this._weights;
    var target, weight, j, id, j3, j4;
    var vertSizeF = this.morph._vertSizeF;
    var offsetPF = this.morph._offsetPF;
    var offsetNF = this.morph._offsetNF;
    var offsetTF = this.morph._offsetTF;
    var baseData = this.morph._baseData;
    var vdata = this._vertexData;
    vdata.set(this.morph._baseData);
    for (var i = 0;i < targets.length;i++) {
      weight = weights[i];
      if (weight === 0) {
        continue;
      }
      target = targets[i];
      numIndices = target.indices.length;
      for (j = 0;j < numIndices;j++) {
        j3 = j * 3;
        index = target.indices[j];
        id = index * vertSizeF + offsetPF;
        vdata[id] += target.deltaPositions[j3] * weight;
        vdata[id + 1] += target.deltaPositions[j3 + 1] * weight;
        vdata[id + 2] += target.deltaPositions[j3 + 2] * weight;
        if (target.deltaNormals) {
          id = index * vertSizeF + offsetNF;
          vdata[id] += target.deltaNormals[j3] * weight;
          vdata[id + 1] += target.deltaNormals[j3 + 1] * weight;
          vdata[id + 2] += target.deltaNormals[j3 + 2] * weight;
          if (target.deltaTangents) {
            j4 = j * 4;
            id = index * vertSizeF + offsetTF;
            vdata[id] += target.deltaTangents[j4] * weight;
            vdata[id + 1] += target.deltaTangents[j4 + 1] * weight;
            vdata[id + 2] += target.deltaTangents[j4 + 2] * weight;
            vdata[id + 3] += target.deltaTangents[j4 + 3] * weight;
            vdata[id + 3] = vdata[id + 3] > 0 ? 1 : -1;
          }
        }
      }
    }
    this._vertexBuffer.unlock();
  }};
  return {MorphTarget:MorphTarget, Morph:Morph, MorphInstance:MorphInstance};
}());
pc.extend(pc, function() {
  var Model = function Model() {
    this.graph = null;
    this.meshInstances = [];
    this.skinInstances = [];
    this.morphInstances = [];
    this.cameras = [];
    this.lights = [];
    this._shadersVersion = 0;
  };
  Model.prototype = {getGraph:function() {
    return this.graph;
  }, setGraph:function(graph) {
    this.graph = graph;
  }, getCameras:function() {
    return this.cameras;
  }, setCameras:function(cameras) {
    this.cameras = cameras;
  }, getLights:function() {
    return this.lights;
  }, setLights:function(lights) {
    this.lights = lights;
  }, getMaterials:function() {
    var i;
    var materials = [];
    for (i = 0;i < this.meshInstances.length;i++) {
      var meshInstance = this.meshInstances[i];
      if (materials.indexOf(meshInstance.material) === -1) {
        materials.push(meshInstance.material);
      }
    }
    return materials;
  }, clone:function() {
    var i, j;
    var srcNodes = [];
    var cloneNodes = [];
    var _duplicate = function(node) {
      var newNode = node.clone();
      srcNodes.push(node);
      cloneNodes.push(newNode);
      for (var i = 0;i < node._children.length;i++) {
        newNode.addChild(_duplicate(node._children[i]));
      }
      return newNode;
    };
    var cloneGraph = _duplicate(this.graph);
    var cloneMeshInstances = [];
    var cloneSkinInstances = [];
    var cloneMorphInstances = [];
    for (i = 0;i < this.skinInstances.length;i++) {
      var skin = this.skinInstances[i].skin;
      var cloneSkinInstance = new pc.SkinInstance(skin, cloneGraph);
      var bones = [];
      for (j = 0;j < skin.boneNames.length;j++) {
        var boneName = skin.boneNames[j];
        var bone = cloneGraph.findByName(boneName);
        bones.push(bone);
      }
      cloneSkinInstance.bones = bones;
      cloneSkinInstances.push(cloneSkinInstance);
    }
    for (i = 0;i < this.morphInstances.length;i++) {
      var morph = this.morphInstances[i].morph;
      var cloneMorphInstance = new pc.MorphInstance(morph);
      cloneMorphInstances.push(cloneMorphInstance);
    }
    for (i = 0;i < this.meshInstances.length;i++) {
      var meshInstance = this.meshInstances[i];
      var nodeIndex = srcNodes.indexOf(meshInstance.node);
      var cloneMeshInstance = new pc.MeshInstance(cloneNodes[nodeIndex], meshInstance.mesh, meshInstance.material);
      if (meshInstance.skinInstance) {
        var skinInstanceIndex = this.skinInstances.indexOf(meshInstance.skinInstance);
        cloneMeshInstance.skinInstance = cloneSkinInstances[skinInstanceIndex];
      }
      if (meshInstance.morphInstance) {
        var morphInstanceIndex = this.morphInstances.indexOf(meshInstance.morphInstance);
        cloneMeshInstance.morphInstance = cloneMorphInstances[morphInstanceIndex];
      }
      cloneMeshInstances.push(cloneMeshInstance);
    }
    var clone = new pc.Model;
    clone.graph = cloneGraph;
    clone.meshInstances = cloneMeshInstances;
    clone.skinInstances = cloneSkinInstances;
    clone.morphInstances = cloneMorphInstances;
    clone.getGraph().syncHierarchy();
    return clone;
  }, destroy:function() {
    var meshInstances = this.meshInstances;
    var meshInstance, mesh, skin, morph, ib, boneTex, j;
    var device;
    for (var i = 0;i < meshInstances.length;i++) {
      meshInstance = meshInstances[i];
      mesh = meshInstance.mesh;
      if (mesh) {
        mesh._refCount--;
        if (mesh._refCount < 1) {
          if (mesh.vertexBuffer) {
            device = device || mesh.vertexBuffer.device;
            mesh.vertexBuffer.destroy();
            mesh.vertexBuffer = null;
          }
          for (j = 0;j < mesh.indexBuffer.length;j++) {
            device = device || mesh.indexBuffer.device;
            ib = mesh.indexBuffer[j];
            if (!ib) {
              continue;
            }
            ib.destroy();
          }
          mesh.indexBuffer.length = 0;
        }
      }
      skin = meshInstance.skinInstance;
      if (skin) {
        boneTex = skin.boneTexture;
        if (boneTex) {
          boneTex.destroy();
        }
      }
      meshInstance.skinInstance = null;
      morph = meshInstance.morphInstance;
      if (morph) {
        morph.destroy();
      }
      meshInstance.morphInstance = null;
      meshInstance.material = null;
    }
  }, generateWireframe:function() {
    var i, j, k;
    var i1, i2;
    var mesh, base, count, indexBuffer, wireBuffer;
    var srcIndices, dstIndices;
    var meshes = [];
    for (i = 0;i < this.meshInstances.length;i++) {
      mesh = this.meshInstances[i].mesh;
      if (meshes.indexOf(mesh) === -1) {
        meshes.push(mesh);
      }
    }
    var offsets = [[0, 1], [1, 2], [2, 0]];
    for (i = 0;i < meshes.length;i++) {
      mesh = meshes[i];
      base = mesh.primitive[pc.RENDERSTYLE_SOLID].base;
      count = mesh.primitive[pc.RENDERSTYLE_SOLID].count;
      indexBuffer = mesh.indexBuffer[pc.RENDERSTYLE_SOLID];
      srcIndices = new Uint16Array(indexBuffer.lock());
      var uniqueLineIndices = {};
      var lines = [];
      for (j = base;j < base + count;j += 3) {
        for (k = 0;k < 3;k++) {
          i1 = srcIndices[j + offsets[k][0]];
          i2 = srcIndices[j + offsets[k][1]];
          var line = i1 > i2 ? i2 << 16 | i1 : i1 << 16 | i2;
          if (uniqueLineIndices[line] === undefined) {
            uniqueLineIndices[line] = 0;
            lines.push(i1, i2);
          }
        }
      }
      indexBuffer.unlock();
      wireBuffer = new pc.IndexBuffer(indexBuffer.device, pc.INDEXFORMAT_UINT16, lines.length);
      dstIndices = new Uint16Array(wireBuffer.lock());
      dstIndices.set(lines);
      wireBuffer.unlock();
      mesh.primitive[pc.RENDERSTYLE_WIREFRAME] = {type:pc.PRIMITIVE_LINES, base:0, count:lines.length, indexed:true};
      mesh.indexBuffer[pc.RENDERSTYLE_WIREFRAME] = wireBuffer;
    }
  }};
  return {Model:Model};
}());
pc.extend(pc, function() {
  var particleVerts = [[-1, -1], [1, -1], [1, 1], [-1, 1]];
  var _createTexture = function(device, width, height, pixelData, format, mult8Bit, filter) {
    if (!format) {
      format = pc.PIXELFORMAT_RGBA32F;
    }
    var mipFilter = pc.FILTER_NEAREST;
    if (filter && format === pc.PIXELFORMAT_R8_G8_B8_A8) {
      mipFilter = pc.FILTER_LINEAR;
    }
    var texture = new pc.Texture(device, {width:width, height:height, format:format, cubemap:false, mipmaps:false, minFilter:mipFilter, magFilter:mipFilter, addressU:pc.ADDRESS_CLAMP_TO_EDGE, addressV:pc.ADDRESS_CLAMP_TO_EDGE});
    var pixels = texture.lock();
    if (format === pc.PIXELFORMAT_R8_G8_B8_A8) {
      var temp = new Uint8Array(pixelData.length);
      for (var i = 0;i < pixelData.length;i++) {
        temp[i] = pixelData[i] * mult8Bit * 255;
      }
      pixelData = temp;
    }
    pixels.set(pixelData);
    texture.unlock();
    return texture;
  };
  function saturate(x) {
    return Math.max(Math.min(x, 1), 0);
  }
  function glMod(x, y) {
    return x - y * Math.floor(x / y);
  }
  var default0Curve = new pc.Curve([0, 0, 1, 0]);
  var default1Curve = new pc.Curve([0, 1, 1, 1]);
  var default0Curve3 = new pc.CurveSet([0, 0, 1, 0], [0, 0, 1, 0], [0, 0, 1, 0]);
  var default1Curve3 = new pc.CurveSet([0, 1, 1, 1], [0, 1, 1, 1], [0, 1, 1, 1]);
  var particleTexHeight = 2;
  var particleTexChannels = 4;
  var velocityVec = new pc.Vec3;
  var localVelocityVec = new pc.Vec3;
  var velocityVec2 = new pc.Vec3;
  var localVelocityVec2 = new pc.Vec3;
  var rndFactor3Vec = new pc.Vec3;
  var particlePosPrev = new pc.Vec3;
  var particlePos = new pc.Vec3;
  var particleFinalPos = new pc.Vec3;
  var moveDirVec = new pc.Vec3;
  var rotMat = new pc.Mat4;
  var spawnMatrix3 = new pc.Mat3;
  var emitterMatrix3 = new pc.Mat3;
  var uniformScale = 1;
  var nonUniformScale;
  var spawnMatrix = new pc.Mat4;
  var randomPos = new pc.Vec3;
  var randomPosTformed = new pc.Vec3;
  var tmpVec3 = new pc.Vec3;
  var velocityV = new pc.Vec3;
  var bMin = new pc.Vec3;
  var bMax = new pc.Vec3;
  var setPropertyTarget;
  var setPropertyOptions;
  function setProperty(pName, defaultVal) {
    if (setPropertyOptions[pName] !== undefined && setPropertyOptions[pName] !== null) {
      setPropertyTarget[pName] = setPropertyOptions[pName];
    } else {
      setPropertyTarget[pName] = defaultVal;
    }
  }
  function pack3NFloats(a, b, c) {
    var packed = a * 255 << 16 | b * 255 << 8 | c * 255;
    return packed / (1 << 24);
  }
  function packTextureXYZ_NXYZ(qXYZ, qXYZ2) {
    var num = qXYZ.length / 3;
    var colors = new Array(num * 4);
    for (var i = 0;i < num;i++) {
      colors[i * 4] = qXYZ[i * 3];
      colors[i * 4 + 1] = qXYZ[i * 3 + 1];
      colors[i * 4 + 2] = qXYZ[i * 3 + 2];
      colors[i * 4 + 3] = pack3NFloats(qXYZ2[i * 3], qXYZ2[i * 3 + 1], qXYZ2[i * 3 + 2]);
    }
    return colors;
  }
  function packTextureRGBA(qRGB, qA) {
    var colors = new Array(qA.length * 4);
    for (var i = 0;i < qA.length;i++) {
      colors[i * 4] = qRGB[i * 3];
      colors[i * 4 + 1] = qRGB[i * 3 + 1];
      colors[i * 4 + 2] = qRGB[i * 3 + 2];
      colors[i * 4 + 3] = qA[i];
    }
    return colors;
  }
  function packTexture5Floats(qA, qB, qC, qD, qE) {
    var colors = new Array(qA.length * 4);
    for (var i = 0;i < qA.length;i++) {
      colors[i * 4] = qA[i];
      colors[i * 4 + 1] = qB[i];
      colors[i * 4 + 2] = 0;
      colors[i * 4 + 3] = pack3NFloats(qC[i], qD[i], qE[i]);
    }
    return colors;
  }
  function syncToCpu(device, targ) {
    var tex = targ._colorBuffer;
    var pixels = new Uint8Array(tex.width * tex.height * 4);
    var gl = device.gl;
    device.setFramebuffer(targ._glFrameBuffer);
    gl.readPixels(0, 0, tex.width, tex.height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
    if (!tex._levels) {
      tex._levels = [];
    }
    tex._levels[0] = pixels;
  }
  var ParticleEmitter = function(graphicsDevice, options) {
    this.graphicsDevice = graphicsDevice;
    var gd = graphicsDevice;
    var precision = 32;
    this.precision = precision;
    this._addTimeTime = 0;
    if (!ParticleEmitter.DEFAULT_PARAM_TEXTURE) {
      var resolution = 16;
      var centerPoint = resolution * 0.5 + 0.5;
      var dtex = new Float32Array(resolution * resolution * 4);
      var x, y, xgrad, ygrad, p, c;
      for (y = 0;y < resolution;y++) {
        for (x = 0;x < resolution;x++) {
          xgrad = x + 1 - centerPoint;
          ygrad = y + 1 - centerPoint;
          c = saturate(1 - saturate(Math.sqrt(xgrad * xgrad + ygrad * ygrad) / resolution) - 0.5);
          p = y * resolution + x;
          dtex[p * 4] = 1;
          dtex[p * 4 + 1] = 1;
          dtex[p * 4 + 2] = 1;
          dtex[p * 4 + 3] = c;
        }
      }
      ParticleEmitter.DEFAULT_PARAM_TEXTURE = _createTexture(gd, resolution, resolution, dtex, pc.PIXELFORMAT_R8_G8_B8_A8, 1.0, true);
      ParticleEmitter.DEFAULT_PARAM_TEXTURE.minFilter = pc.FILTER_LINEAR;
      ParticleEmitter.DEFAULT_PARAM_TEXTURE.magFilter = pc.FILTER_LINEAR;
    }
    setPropertyTarget = this;
    setPropertyOptions = options;
    setProperty("numParticles", 1);
    if (this.numParticles > graphicsDevice.maxTextureSize) {
      console.warn("WARNING: can't create more than " + graphicsDevice.maxTextureSize + " particles on this device.");
      this.numParticles = graphicsDevice.maxTextureSize;
    }
    setProperty("rate", 1);
    setProperty("rate2", this.rate);
    setProperty("lifetime", 50);
    setProperty("emitterExtents", new pc.Vec3(0, 0, 0));
    setProperty("emitterRadius", 0);
    setProperty("emitterShape", pc.EMITTERSHAPE_BOX);
    setProperty("initialVelocity", 1);
    setProperty("wrap", false);
    setProperty("localSpace", false);
    setProperty("wrapBounds", null);
    setProperty("colorMap", ParticleEmitter.DEFAULT_PARAM_TEXTURE);
    setProperty("normalMap", null);
    setProperty("loop", true);
    setProperty("preWarm", false);
    setProperty("sort", pc.PARTICLESORT_NONE);
    setProperty("mode", pc.PARTICLEMODE_GPU);
    setProperty("scene", null);
    setProperty("lighting", false);
    setProperty("halfLambert", false);
    setProperty("intensity", 1.0);
    setProperty("stretch", 0.0);
    setProperty("alignToMotion", false);
    setProperty("depthSoftening", 0);
    setProperty("mesh", null);
    setProperty("depthWrite", false);
    setProperty("noFog", false);
    setProperty("blendType", pc.BLEND_NORMAL);
    setProperty("node", null);
    setProperty("startAngle", 0);
    setProperty("startAngle2", this.startAngle);
    setProperty("animTilesX", 1);
    setProperty("animTilesY", 1);
    setProperty("animNumFrames", 1);
    setProperty("animSpeed", 1);
    setProperty("animLoop", true);
    this.frameRandom = new pc.Vec3(0, 0, 0);
    setProperty("colorGraph", default1Curve3);
    setProperty("colorGraph2", this.colorGraph);
    setProperty("scaleGraph", default1Curve);
    setProperty("scaleGraph2", this.scaleGraph);
    setProperty("alphaGraph", default1Curve);
    setProperty("alphaGraph2", this.alphaGraph);
    setProperty("localVelocityGraph", default0Curve3);
    setProperty("localVelocityGraph2", this.localVelocityGraph);
    setProperty("velocityGraph", default0Curve3);
    setProperty("velocityGraph2", this.velocityGraph);
    setProperty("rotationSpeedGraph", default0Curve);
    setProperty("rotationSpeedGraph2", this.rotationSpeedGraph);
    this.constantParticleTexIN = gd.scope.resolve("particleTexIN");
    this.constantParticleTexOUT = gd.scope.resolve("particleTexOUT");
    this.constantEmitterPos = gd.scope.resolve("emitterPos");
    this.constantEmitterScale = gd.scope.resolve("emitterScale");
    this.constantSpawnBounds = gd.scope.resolve("spawnBounds");
    this.constantSpawnBoundsSphere = gd.scope.resolve("spawnBoundsSphere");
    this.constantInitialVelocity = gd.scope.resolve("initialVelocity");
    this.constantFrameRandom = gd.scope.resolve("frameRandom");
    this.constantDelta = gd.scope.resolve("delta");
    this.constantRate = gd.scope.resolve("rate");
    this.constantRateDiv = gd.scope.resolve("rateDiv");
    this.constantLifetime = gd.scope.resolve("lifetime");
    this.constantLightCube = gd.scope.resolve("lightCube[0]");
    this.constantGraphSampleSize = gd.scope.resolve("graphSampleSize");
    this.constantGraphNumSamples = gd.scope.resolve("graphNumSamples");
    this.constantInternalTex0 = gd.scope.resolve("internalTex0");
    this.constantInternalTex1 = gd.scope.resolve("internalTex1");
    this.constantInternalTex2 = gd.scope.resolve("internalTex2");
    this.constantEmitterMatrix = gd.scope.resolve("emitterMatrix");
    this.constantNumParticles = gd.scope.resolve("numParticles");
    this.constantNumParticlesPot = gd.scope.resolve("numParticlesPot");
    this.constantLocalVelocityDivMult = gd.scope.resolve("localVelocityDivMult");
    this.constantVelocityDivMult = gd.scope.resolve("velocityDivMult");
    this.constantRotSpeedDivMult = gd.scope.resolve("rotSpeedDivMult");
    this.constantSeed = gd.scope.resolve("seed");
    this.constantStartAngle = gd.scope.resolve("startAngle");
    this.constantStartAngle2 = gd.scope.resolve("startAngle2");
    this.constantOutBoundsMul = gd.scope.resolve("outBoundsMul");
    this.constantOutBoundsAdd = gd.scope.resolve("outBoundsAdd");
    this.constantInBoundsSize = gd.scope.resolve("inBoundsSize");
    this.constantInBoundsCenter = gd.scope.resolve("inBoundsCenter");
    this.constantMaxVel = gd.scope.resolve("maxVel");
    this.lightCube = new Float32Array(6 * 3);
    this.lightCubeDir = new Array(6);
    this.lightCubeDir[0] = new pc.Vec3(-1, 0, 0);
    this.lightCubeDir[1] = new pc.Vec3(1, 0, 0);
    this.lightCubeDir[2] = new pc.Vec3(0, -1, 0);
    this.lightCubeDir[3] = new pc.Vec3(0, 1, 0);
    this.lightCubeDir[4] = new pc.Vec3(0, 0, -1);
    this.lightCubeDir[5] = new pc.Vec3(0, 0, 1);
    this.animParams = new pc.Vec4;
    this.internalTex0 = null;
    this.internalTex1 = null;
    this.internalTex2 = null;
    this.internalTex3 = null;
    this.vbToSort = null;
    this.vbOld = null;
    this.particleDistance = null;
    this.camera = null;
    this.swapTex = false;
    this.useMesh = true;
    this.useCpu = false;
    this.pack8 = true;
    this.localBounds = new pc.BoundingBox;
    this.worldBoundsNoTrail = new pc.BoundingBox;
    this.worldBoundsTrail = [new pc.BoundingBox, new pc.BoundingBox];
    this.worldBounds = new pc.BoundingBox;
    this.worldBoundsSize = new pc.Vec3;
    this.prevWorldBoundsSize = new pc.Vec3;
    this.prevWorldBoundsCenter = new pc.Vec3;
    this.worldBoundsMul = new pc.Vec3;
    this.worldBoundsAdd = new pc.Vec3;
    this.timeToSwitchBounds = 0;
    this.shaderParticleUpdateRespawn = null;
    this.shaderParticleUpdateNoRespawn = null;
    this.shaderParticleUpdateOnStop = null;
    this.numParticleVerts = 0;
    this.numParticleIndices = 0;
    this.material = null;
    this.meshInstance = null;
    this.seed = 0;
    this.fixedTimeStep = 1.0 / 60;
    this.maxSubSteps = 10;
    this.simTime = 0;
    this.simTimeTotal = 0;
    this.beenReset = false;
    this.rebuild();
  };
  function calcEndTime(emitter) {
    var interval = Math.max(emitter.rate, emitter.rate2) * emitter.numParticles + emitter.lifetime;
    return Date.now() + interval * 1000;
  }
  function subGraph(A, B) {
    var r = new Float32Array(A.length);
    for (var i = 0;i < A.length;i++) {
      r[i] = A[i] - B[i];
    }
    return r;
  }
  function maxUnsignedGraphValue(A, outUMax) {
    var i, j;
    var chans = outUMax.length;
    var values = A.length / chans;
    for (i = 0;i < values;i++) {
      for (j = 0;j < chans;j++) {
        var a = Math.abs(A[i * chans + j]);
        outUMax[j] = Math.max(outUMax[j], a);
      }
    }
  }
  function normalizeGraph(A, uMax) {
    var chans = uMax.length;
    var i, j;
    var values = A.length / chans;
    for (i = 0;i < values;i++) {
      for (j = 0;j < chans;j++) {
        A[i * chans + j] /= uMax[j];
        A[i * chans + j] *= 0.5;
        A[i * chans + j] += 0.5;
      }
    }
  }
  function divGraphFrom2Curves(curve1, curve2, outUMax) {
    var sub = subGraph(curve2, curve1);
    maxUnsignedGraphValue(sub, outUMax);
    normalizeGraph(sub, outUMax);
    return sub;
  }
  function mat4ToMat3(mat4, mat3) {
    mat3.data[0] = mat4.data[0];
    mat3.data[1] = mat4.data[1];
    mat3.data[2] = mat4.data[2];
    mat3.data[3] = mat4.data[4];
    mat3.data[4] = mat4.data[5];
    mat3.data[5] = mat4.data[6];
    mat3.data[6] = mat4.data[8];
    mat3.data[7] = mat4.data[9];
    mat3.data[8] = mat4.data[10];
  }
  ParticleEmitter.prototype = {onChangeCamera:function() {
    if (this.depthSoftening > 0) {
      if (this.camera) {
        this.camera.requestDepthMap();
      }
    }
    this.regenShader();
    this.resetMaterial();
  }, calculateBoundsMad:function() {
    this.worldBoundsMul.x = 1.0 / this.worldBoundsSize.x;
    this.worldBoundsMul.y = 1.0 / this.worldBoundsSize.y;
    this.worldBoundsMul.z = 1.0 / this.worldBoundsSize.z;
    this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);
    this.worldBoundsAdd.x += 0.5;
    this.worldBoundsAdd.y += 0.5;
    this.worldBoundsAdd.z += 0.5;
  }, calculateWorldBounds:function() {
    if (!this.node) {
      return;
    }
    var pos = this.node.getPosition();
    this.prevWorldBoundsSize.copy(this.worldBoundsSize);
    this.prevWorldBoundsCenter.copy(this.worldBounds.center);
    this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds, this.node.getWorldTransform());
    this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);
    var now = this.simTimeTotal;
    if (now > this.timeToSwitchBounds) {
      var tmp = this.worldBoundsTrail[0];
      this.worldBoundsTrail[0] = this.worldBoundsTrail[1];
      this.worldBoundsTrail[1] = tmp;
      this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail);
      this.timeToSwitchBounds = now + this.lifetime;
    }
    this.worldBounds.copy(this.worldBoundsTrail[0]);
    this.worldBounds.add(this.worldBoundsTrail[1]);
    this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);
    this.meshInstance.mesh.aabb = this.worldBounds;
    this.meshInstance._aabbVer = 1 - this.meshInstance._aabbVer;
    if (this.pack8) {
      this.calculateBoundsMad();
    }
  }, calculateLocalBounds:function() {
    var minx = Number.MAX_VALUE;
    var miny = Number.MAX_VALUE;
    var minz = Number.MAX_VALUE;
    var maxx = -Number.MAX_VALUE;
    var maxy = -Number.MAX_VALUE;
    var maxz = -Number.MAX_VALUE;
    var maxScale = 0;
    var stepWeight = this.lifetime / this.precision;
    var vels = [this.qVelocity, this.qVelocity2, this.qLocalVelocity, this.qLocalVelocity2];
    var accumX = [0, 0, 0, 0];
    var accumY = [0, 0, 0, 0];
    var accumZ = [0, 0, 0, 0];
    var i, j;
    var index;
    var x, y, z;
    for (i = 0;i < this.precision + 1;i++) {
      index = Math.min(i, this.precision - 1);
      for (j = 0;j < 4;j++) {
        x = vels[j][index * 3] * stepWeight + accumX[j];
        y = vels[j][index * 3 + 1] * stepWeight + accumY[j];
        z = vels[j][index * 3 + 2] * stepWeight + accumZ[j];
        if (minx > x) {
          minx = x;
        }
        if (miny > y) {
          miny = y;
        }
        if (minz > z) {
          minz = z;
        }
        if (maxx < x) {
          maxx = x;
        }
        if (maxy < y) {
          maxy = y;
        }
        if (maxz < z) {
          maxz = z;
        }
        accumX[j] = x;
        accumY[j] = y;
        accumZ[j] = z;
      }
      maxScale = Math.max(maxScale, this.qScale[index]);
    }
    if (this.emitterShape === pc.EMITTERSHAPE_BOX) {
      x = this.emitterExtents.x * 0.5;
      y = this.emitterExtents.y * 0.5;
      z = this.emitterExtents.z * 0.5;
      if (maxx < x) {
        maxx = x;
      }
      if (maxy < y) {
        maxy = y;
      }
      if (maxz < z) {
        maxz = z;
      }
      x = -x;
      y = -y;
      z = -z;
      if (minx > x) {
        minx = x;
      }
      if (miny > y) {
        miny = y;
      }
      if (minz > z) {
        minz = z;
      }
    } else {
      x = this.emitterRadius;
      y = this.emitterRadius;
      z = this.emitterRadius;
      if (maxx < x) {
        maxx = x;
      }
      if (maxy < y) {
        maxy = y;
      }
      if (maxz < z) {
        maxz = z;
      }
      x = -x;
      y = -y;
      z = -z;
      if (minx > x) {
        minx = x;
      }
      if (miny > y) {
        miny = y;
      }
      if (minz > z) {
        minz = z;
      }
    }
    bMin.x = minx - maxScale;
    bMin.y = miny - maxScale;
    bMin.z = minz - maxScale;
    bMax.x = maxx + maxScale;
    bMax.y = maxy + maxScale;
    bMax.z = maxz + maxScale;
    this.localBounds.setMinMax(bMin, bMax);
  }, rebuild:function() {
    var i, len;
    var precision = this.precision;
    var gd = this.graphicsDevice;
    if (this.colorMap === null) {
      this.colorMap = ParticleEmitter.DEFAULT_PARAM_TEXTURE;
    }
    this.spawnBounds = this.emitterShape === pc.EMITTERSHAPE_BOX ? this.emitterExtents : this.emitterRadius;
    this.useCpu = this.useCpu || this.sort > pc.PARTICLESORT_NONE || gd.maxVertexTextures <= 1 || gd.fragmentUniformsCount < 64 || gd.forceCpuParticles || !gd.extTextureFloat;
    this.vertexBuffer = undefined;
    this.pack8 = (this.pack8 || !gd.extTextureFloatRenderable) && !this.useCpu;
    particleTexHeight = this.useCpu || this.pack8 ? 4 : 2;
    this.useMesh = false;
    if (this.mesh) {
      var totalVertCount = this.numParticles * this.mesh.vertexBuffer.numVertices;
      if (totalVertCount > 65535) {
        console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles.");
      } else {
        this.useMesh = true;
      }
    }
    this.numParticlesPot = pc.math.nextPowerOfTwo(this.numParticles);
    this.rebuildGraphs();
    this.calculateLocalBounds();
    if (this.node) {
      this.worldBounds.setFromTransformedAabb(this.localBounds, this.node.getWorldTransform());
      this.worldBoundsTrail[0].copy(this.worldBounds);
      this.worldBoundsTrail[1].copy(this.worldBounds);
      this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);
      this.prevWorldBoundsSize.copy(this.worldBoundsSize);
      this.prevWorldBoundsCenter.copy(this.worldBounds.center);
      if (this.pack8) {
        this.calculateBoundsMad();
      }
    }
    this.vbToSort = new Array(this.numParticles);
    this.particleDistance = new Float32Array(this.numParticles);
    this.frameRandom.x = Math.random();
    this.frameRandom.y = Math.random();
    this.frameRandom.z = Math.random();
    this.particleTex = new Float32Array(this.numParticlesPot * particleTexHeight * particleTexChannels);
    var emitterPos = this.node === null || this.localSpace ? pc.Vec3.ZERO : this.node.getPosition();
    if (this.emitterShape === pc.EMITTERSHAPE_BOX) {
      if (this.node === null) {
        spawnMatrix.setTRS(pc.Vec3.ZERO, pc.Quat.IDENTITY, this.spawnBounds);
      } else {
        spawnMatrix.setTRS(pc.Vec3.ZERO, this.node.getRotation(), tmpVec3.copy(this.spawnBounds).mul(this.node.localScale));
      }
    }
    for (i = 0;i < this.numParticles;i++) {
      this.calcSpawnPosition(emitterPos, i);
      if (this.useCpu) {
        this.particleTex[i * particleTexChannels + 3 + this.numParticlesPot * 2 * particleTexChannels] = 1;
      }
    }
    this.particleTexStart = new Float32Array(this.numParticlesPot * particleTexHeight * particleTexChannels);
    for (i = 0;i < this.particleTexStart.length;i++) {
      this.particleTexStart[i] = this.particleTex[i];
    }
    if (!this.useCpu) {
      if (this.pack8) {
        this.particleTexIN = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTex, pc.PIXELFORMAT_R8_G8_B8_A8, 1, false);
        this.particleTexOUT = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTex, pc.PIXELFORMAT_R8_G8_B8_A8, 1, false);
        this.particleTexStart = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTexStart, pc.PIXELFORMAT_R8_G8_B8_A8, 1, false);
      } else {
        this.particleTexIN = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTex);
        this.particleTexOUT = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTex);
        this.particleTexStart = _createTexture(gd, this.numParticlesPot, particleTexHeight, this.particleTexStart);
      }
      this.rtParticleTexIN = new pc.RenderTarget(gd, this.particleTexIN, {depth:false});
      this.rtParticleTexOUT = new pc.RenderTarget(gd, this.particleTexOUT, {depth:false});
      this.swapTex = false;
    }
    var chunks = pc.shaderChunks;
    var shaderCodeStart = chunks.particleUpdaterInitPS + (this.pack8 ? chunks.particleInputRgba8PS + chunks.particleOutputRgba8PS : chunks.particleInputFloatPS + chunks.particleOutputFloatPS) + (this.emitterShape === pc.EMITTERSHAPE_BOX ? chunks.particleUpdaterAABBPS : chunks.particleUpdaterSpherePS) + chunks.particleUpdaterStartPS;
    var shaderCodeRespawn = shaderCodeStart + chunks.particleUpdaterRespawnPS + chunks.particleUpdaterEndPS;
    var shaderCodeNoRespawn = shaderCodeStart + chunks.particleUpdaterNoRespawnPS + chunks.particleUpdaterEndPS;
    var shaderCodeOnStop = shaderCodeStart + chunks.particleUpdaterOnStopPS + chunks.particleUpdaterEndPS;
    this.shaderParticleUpdateRespawn = chunks.createShaderFromCode(gd, chunks.fullscreenQuadVS, shaderCodeRespawn, "fsQuad0" + this.emitterShape + "" + this.pack8);
    this.shaderParticleUpdateNoRespawn = chunks.createShaderFromCode(gd, chunks.fullscreenQuadVS, shaderCodeNoRespawn, "fsQuad1" + this.emitterShape + "" + this.pack8);
    this.shaderParticleUpdateOnStop = chunks.createShaderFromCode(gd, chunks.fullscreenQuadVS, shaderCodeOnStop, "fsQuad2" + this.emitterShape + "" + this.pack8);
    this.numParticleVerts = this.useMesh ? this.mesh.vertexBuffer.numVertices : 4;
    this.numParticleIndices = this.useMesh ? this.mesh.indexBuffer[0].numIndices : 6;
    this._allocate(this.numParticles);
    var mesh = new pc.Mesh;
    mesh.vertexBuffer = this.vertexBuffer;
    mesh.indexBuffer[0] = this.indexBuffer;
    mesh.primitive[0].type = pc.PRIMITIVE_TRIANGLES;
    mesh.primitive[0].base = 0;
    mesh.primitive[0].count = this.numParticles * this.numParticleIndices;
    mesh.primitive[0].indexed = true;
    this.material = new pc.Material;
    this.material.cullMode = pc.CULLFACE_NONE;
    this.material.alphaWrite = false;
    this.material.blend = true;
    this.material.blendType = this.blendType;
    this.material.depthWrite = this.depthWrite;
    this.material.emitter = this;
    this.regenShader();
    this.resetMaterial();
    this.meshInstance = new pc.MeshInstance(this.node, mesh, this.material);
    this.meshInstance.updateKey();
    this.meshInstance.drawToDepth = false;
    this.meshInstance.cull = true;
    this.meshInstance.aabb = this.worldBounds;
    this.meshInstance._updateAabb = false;
    this._initializeTextures();
    this.addTime(0);
    if (this.preWarm) {
      this.prewarm(this.lifetime);
    }
    this.resetTime();
  }, _isAnimated:function() {
    return this.animNumFrames >= 1 && (this.animTilesX > 1 || this.animTilesY > 1) && (this.colorMap && this.colorMap !== ParticleEmitter.DEFAULT_PARAM_TEXTURE || this.normalMap);
  }, calcSpawnPosition:function(emitterPos, i) {
    var rX = Math.random();
    var rY = Math.random();
    var rZ = Math.random();
    var rW = Math.random();
    if (this.useCpu) {
      this.particleTex[i * particleTexChannels + 0 + this.numParticlesPot * 2 * particleTexChannels] = rX;
      this.particleTex[i * particleTexChannels + 1 + this.numParticlesPot * 2 * particleTexChannels] = rY;
      this.particleTex[i * particleTexChannels + 2 + this.numParticlesPot * 2 * particleTexChannels] = rZ;
    }
    randomPos.data[0] = rX - 0.5;
    randomPos.data[1] = rY - 0.5;
    randomPos.data[2] = rZ - 0.5;
    if (this.emitterShape === pc.EMITTERSHAPE_BOX) {
      randomPosTformed.copy(emitterPos).add(spawnMatrix.transformPoint(randomPos));
    } else {
      randomPos.normalize();
      randomPosTformed.copy(emitterPos).add(randomPos.scale(rW * this.spawnBounds));
    }
    var particleRate, startSpawnTime;
    if (this.pack8) {
      var packX = (randomPosTformed.data[0] - this.worldBounds.center.data[0]) / this.worldBoundsSize.data[0] + 0.5;
      var packY = (randomPosTformed.data[1] - this.worldBounds.center.data[1]) / this.worldBoundsSize.data[1] + 0.5;
      var packZ = (randomPosTformed.data[2] - this.worldBounds.center.data[2]) / this.worldBoundsSize.data[2] + 0.5;
      var packA = pc.math.lerp(this.startAngle * pc.math.DEG_TO_RAD, this.startAngle2 * pc.math.DEG_TO_RAD, rX);
      packA = packA % (Math.PI * 2) / (Math.PI * 2);
      var rg0 = encodeFloatRG(packX);
      this.particleTex[i * particleTexChannels] = rg0[0];
      this.particleTex[i * particleTexChannels + 1] = rg0[1];
      var ba0 = encodeFloatRG(packY);
      this.particleTex[i * particleTexChannels + 2] = ba0[0];
      this.particleTex[i * particleTexChannels + 3] = ba0[1];
      var rg1 = encodeFloatRG(packZ);
      this.particleTex[i * particleTexChannels + 0 + this.numParticlesPot * particleTexChannels] = rg1[0];
      this.particleTex[i * particleTexChannels + 1 + this.numParticlesPot * particleTexChannels] = rg1[1];
      var ba1 = encodeFloatRG(packA);
      this.particleTex[i * particleTexChannels + 2 + this.numParticlesPot * particleTexChannels] = ba1[0];
      this.particleTex[i * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels] = ba1[1];
      var a2 = 1.0;
      this.particleTex[i * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels * 2] = a2;
      particleRate = pc.math.lerp(this.rate, this.rate2, rX);
      startSpawnTime = -particleRate * i;
      var maxNegLife = Math.max(this.lifetime, (this.numParticles - 1.0) * Math.max(this.rate, this.rate2));
      var maxPosLife = this.lifetime + 1.0;
      startSpawnTime = (startSpawnTime + maxNegLife) / (maxNegLife + maxPosLife);
      var rgba3 = encodeFloatRGBA(startSpawnTime);
      this.particleTex[i * particleTexChannels + 0 + this.numParticlesPot * particleTexChannels * 3] = rgba3[0];
      this.particleTex[i * particleTexChannels + 1 + this.numParticlesPot * particleTexChannels * 3] = rgba3[1];
      this.particleTex[i * particleTexChannels + 2 + this.numParticlesPot * particleTexChannels * 3] = rgba3[2];
      this.particleTex[i * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels * 3] = rgba3[3];
    } else {
      this.particleTex[i * particleTexChannels] = randomPosTformed.data[0];
      this.particleTex[i * particleTexChannels + 1] = randomPosTformed.data[1];
      this.particleTex[i * particleTexChannels + 2] = randomPosTformed.data[2];
      this.particleTex[i * particleTexChannels + 3] = pc.math.lerp(this.startAngle * pc.math.DEG_TO_RAD, this.startAngle2 * pc.math.DEG_TO_RAD, rX);
      particleRate = pc.math.lerp(this.rate, this.rate2, rX);
      startSpawnTime = -particleRate * i;
      this.particleTex[i * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels] = startSpawnTime;
    }
  }, rebuildGraphs:function() {
    var precision = this.precision;
    var gd = this.graphicsDevice;
    var i;
    this.qLocalVelocity = this.localVelocityGraph.quantize(precision);
    this.qVelocity = this.velocityGraph.quantize(precision);
    this.qColor = this.colorGraph.quantize(precision);
    this.qRotSpeed = this.rotationSpeedGraph.quantize(precision);
    this.qScale = this.scaleGraph.quantize(precision);
    this.qAlpha = this.alphaGraph.quantize(precision);
    this.qLocalVelocity2 = this.localVelocityGraph2.quantize(precision);
    this.qVelocity2 = this.velocityGraph2.quantize(precision);
    this.qColor2 = this.colorGraph2.quantize(precision);
    this.qRotSpeed2 = this.rotationSpeedGraph2.quantize(precision);
    this.qScale2 = this.scaleGraph2.quantize(precision);
    this.qAlpha2 = this.alphaGraph2.quantize(precision);
    for (i = 0;i < precision;i++) {
      this.qRotSpeed[i] *= pc.math.DEG_TO_RAD;
      this.qRotSpeed2[i] *= pc.math.DEG_TO_RAD;
    }
    this.localVelocityUMax = new pc.Vec3(0, 0, 0);
    this.velocityUMax = new pc.Vec3(0, 0, 0);
    this.colorUMax = new pc.Vec3(0, 0, 0);
    this.rotSpeedUMax = [0];
    this.scaleUMax = [0];
    this.alphaUMax = [0];
    this.qLocalVelocityDiv = divGraphFrom2Curves(this.qLocalVelocity, this.qLocalVelocity2, this.localVelocityUMax.data);
    this.qVelocityDiv = divGraphFrom2Curves(this.qVelocity, this.qVelocity2, this.velocityUMax.data);
    this.qColorDiv = divGraphFrom2Curves(this.qColor, this.qColor2, this.colorUMax.data);
    this.qRotSpeedDiv = divGraphFrom2Curves(this.qRotSpeed, this.qRotSpeed2, this.rotSpeedUMax);
    this.qScaleDiv = divGraphFrom2Curves(this.qScale, this.qScale2, this.scaleUMax);
    this.qAlphaDiv = divGraphFrom2Curves(this.qAlpha, this.qAlpha2, this.alphaUMax);
    if (this.pack8) {
      var umax = [0, 0, 0];
      maxUnsignedGraphValue(this.qVelocity, umax);
      var umax2 = [0, 0, 0];
      maxUnsignedGraphValue(this.qVelocity2, umax2);
      var lumax = [0, 0, 0];
      maxUnsignedGraphValue(this.qLocalVelocity, lumax);
      var lumax2 = [0, 0, 0];
      maxUnsignedGraphValue(this.qLocalVelocity2, lumax2);
      var maxVel = Math.max(umax[0], umax2[0]);
      maxVel = Math.max(maxVel, umax[1]);
      maxVel = Math.max(maxVel, umax2[1]);
      maxVel = Math.max(maxVel, umax[2]);
      maxVel = Math.max(maxVel, umax2[2]);
      var lmaxVel = Math.max(lumax[0], lumax2[0]);
      lmaxVel = Math.max(lmaxVel, lumax[1]);
      lmaxVel = Math.max(lmaxVel, lumax2[1]);
      lmaxVel = Math.max(lmaxVel, lumax[2]);
      lmaxVel = Math.max(lmaxVel, lumax2[2]);
      this.maxVel = maxVel + lmaxVel;
    }
    if (!this.useCpu) {
      this.internalTex0 = _createTexture(gd, precision, 1, packTextureXYZ_NXYZ(this.qLocalVelocity, this.qLocalVelocityDiv));
      this.internalTex1 = _createTexture(gd, precision, 1, packTextureXYZ_NXYZ(this.qVelocity, this.qVelocityDiv));
      this.internalTex2 = _createTexture(gd, precision, 1, packTexture5Floats(this.qRotSpeed, this.qScale, this.qScaleDiv, this.qRotSpeedDiv, this.qAlphaDiv));
    }
    this.internalTex3 = _createTexture(gd, precision, 1, packTextureRGBA(this.qColor, this.qAlpha), pc.PIXELFORMAT_R8_G8_B8_A8, 1.0, true);
  }, _initializeTextures:function() {
    if (this.colorMap) {
      this.material.setParameter("colorMap", this.colorMap);
      if (this.lighting && this.normalMap) {
        this.material.setParameter("normalMap", this.normalMap);
      }
    }
  }, regenShader:function() {
    var programLib = this.graphicsDevice.getProgramLibrary();
    var hasNormal = this.normalMap !== null;
    this.normalOption = 0;
    if (this.lighting) {
      this.normalOption = hasNormal ? 2 : 1;
    }
    this.material.updateShader = function() {
      if (this.emitter.scene) {
        if (this.emitter.camera != this.emitter.scene._activeCamera) {
          this.emitter.camera = this.emitter.scene._activeCamera;
          this.emitter.onChangeCamera();
        }
      }
      var shader = programLib.getProgram("particle", {useCpu:this.emitter.useCpu, normal:this.emitter.normalOption, halflambert:this.emitter.halfLambert, stretch:this.emitter.stretch, alignToMotion:this.emitter.alignToMotion, soft:this.emitter.depthSoftening, mesh:this.emitter.useMesh, gamma:this.emitter.scene ? this.emitter.scene.gammaCorrection : 0, toneMap:this.emitter.scene ? this.emitter.scene.toneMapping : 0, fog:this.emitter.scene && !this.emitter.noFog ? this.emitter.scene.fog : "none", wrap:this.emitter.wrap &&
      this.emitter.wrapBounds, localSpace:this.emitter.localSpace, blend:this.blendType, animTex:this.emitter._isAnimated(), animTexLoop:this.emitter.animLoop, pack8:this.emitter.pack8});
      this.setShader(shader);
    };
    this.material.updateShader();
  }, resetMaterial:function() {
    var material = this.material;
    var gd = this.graphicsDevice;
    material.setParameter("stretch", this.stretch);
    if (this._isAnimated()) {
      material.setParameter("animTexParams", this.animParams.data);
    }
    material.setParameter("colorMult", this.intensity);
    if (!this.useCpu) {
      material.setParameter("internalTex0", this.internalTex0);
      material.setParameter("internalTex1", this.internalTex1);
      material.setParameter("internalTex2", this.internalTex2);
    }
    material.setParameter("internalTex3", this.internalTex3);
    material.setParameter("numParticles", this.numParticles);
    material.setParameter("numParticlesPot", this.numParticlesPot);
    material.setParameter("lifetime", this.lifetime);
    material.setParameter("rate", this.rate);
    material.setParameter("rateDiv", this.rate2 - this.rate);
    material.setParameter("seed", this.seed);
    material.setParameter("scaleDivMult", this.scaleUMax[0]);
    material.setParameter("alphaDivMult", this.alphaUMax[0]);
    material.setParameter("graphNumSamples", this.precision);
    material.setParameter("graphSampleSize", 1.0 / this.precision);
    material.setParameter("emitterScale", pc.Vec3.ONE.data);
    if (this.pack8) {
      material.setParameter("inBoundsSize", this.worldBoundsSize.data);
      material.setParameter("inBoundsCenter", this.worldBounds.center.data);
      material.setParameter("maxVel", this.maxVel);
    }
    if (this.wrap && this.wrapBounds) {
      material.setParameter("wrapBounds", this.wrapBounds.data);
    }
    if (this.colorMap) {
      material.setParameter("colorMap", this.colorMap);
    }
    if (this.lighting) {
      if (this.normalMap) {
        material.setParameter("normalMap", this.normalMap);
      }
    }
    if (this.depthSoftening > 0) {
      material.setParameter("softening", 1.0 / (this.depthSoftening * this.depthSoftening * 100));
    }
    if (this.stretch > 0.0) {
      material.cull = pc.CULLFACE_NONE;
    }
  }, _allocate:function(numParticles) {
    var psysVertCount = numParticles * this.numParticleVerts;
    var psysIndexCount = numParticles * this.numParticleIndices;
    var elements, particleFormat;
    var i;
    if (this.vertexBuffer === undefined || this.vertexBuffer.getNumVertices() !== psysVertCount) {
      if (!this.useCpu) {
        elements = [{semantic:pc.SEMANTIC_ATTR0, components:4, type:pc.TYPE_FLOAT32}];
        particleFormat = new pc.VertexFormat(this.graphicsDevice, elements);
        this.vertexBuffer = new pc.VertexBuffer(this.graphicsDevice, particleFormat, psysVertCount, pc.BUFFER_DYNAMIC);
        this.indexBuffer = new pc.IndexBuffer(this.graphicsDevice, pc.INDEXFORMAT_UINT16, psysIndexCount);
      } else {
        elements = [{semantic:pc.SEMANTIC_ATTR0, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_ATTR1, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_ATTR2, components:4, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_ATTR3, components:2, type:pc.TYPE_FLOAT32}];
        particleFormat = new pc.VertexFormat(this.graphicsDevice, elements);
        this.vertexBuffer = new pc.VertexBuffer(this.graphicsDevice, particleFormat, psysVertCount, pc.BUFFER_DYNAMIC);
        this.indexBuffer = new pc.IndexBuffer(this.graphicsDevice, pc.INDEXFORMAT_UINT16, psysIndexCount);
      }
      var data = new Float32Array(this.vertexBuffer.lock());
      var meshData, stride;
      if (this.useMesh) {
        meshData = new Float32Array(this.mesh.vertexBuffer.lock());
        stride = meshData.length / this.mesh.vertexBuffer.numVertices;
      }
      var id, rnd;
      for (i = 0;i < psysVertCount;i++) {
        id = Math.floor(i / this.numParticleVerts);
        if (this.useCpu) {
          if (i % this.numParticleVerts === 0) {
            rnd = this.particleTex[i * particleTexChannels + 0 + this.numParticlesPot * 2 * particleTexChannels];
          }
        }
        if (!this.useMesh) {
          var vertID = i % 4;
          data[i * 4] = particleVerts[vertID][0];
          data[i * 4 + 1] = particleVerts[vertID][1];
          data[i * 4 + 2] = 0;
        } else {
          var vert = i % this.numParticleVerts;
          data[i * 4] = meshData[vert * stride];
          data[i * 4 + 1] = meshData[vert * stride + 1];
          data[i * 4 + 2] = meshData[vert * stride + 2];
        }
        data[i * 4 + 3] = id;
      }
      if (this.useCpu) {
        this.vbCPU = new Float32Array(data);
        this.vbOld = new Float32Array(this.vbCPU.length);
      }
      this.vertexBuffer.unlock();
      if (this.useMesh) {
        this.mesh.vertexBuffer.unlock();
      }
      var dst = 0;
      var indices = new Uint16Array(this.indexBuffer.lock());
      if (this.useMesh) {
        meshData = new Uint16Array(this.mesh.indexBuffer[0].lock());
      }
      for (i = 0;i < numParticles;i++) {
        if (!this.useMesh) {
          var baseIndex = i * 4;
          indices[dst++] = baseIndex;
          indices[dst++] = baseIndex + 1;
          indices[dst++] = baseIndex + 2;
          indices[dst++] = baseIndex;
          indices[dst++] = baseIndex + 2;
          indices[dst++] = baseIndex + 3;
        } else {
          for (var j = 0;j < this.numParticleIndices;j++) {
            indices[i * this.numParticleIndices + j] = meshData[j] + i * this.numParticleVerts;
          }
        }
      }
      this.indexBuffer.unlock();
      if (this.useMesh) {
        this.mesh.indexBuffer[0].unlock();
      }
    }
  }, reset:function() {
    this.beenReset = true;
    this.seed = Math.random();
    this.material.setParameter("seed", this.seed);
    if (this.useCpu) {
      for (var i = 0;i < this.particleTexStart.length;i++) {
        this.particleTex[i] = this.particleTexStart[i];
      }
    } else {
      this._initializeTextures();
    }
    this.resetTime();
    var origLoop = this.loop;
    this.loop = true;
    this.addTime(0);
    this.loop = origLoop;
    if (this.preWarm) {
      this.prewarm(this.lifetime);
    }
  }, prewarm:function(time) {
    var lifetimeFraction = time / this.lifetime;
    var iterations = Math.min(Math.floor(lifetimeFraction * this.precision), this.precision);
    var stepDelta = time / iterations;
    for (var i = 0;i < iterations;i++) {
      this.addTime(stepDelta);
    }
  }, resetTime:function() {
    this.endTime = calcEndTime(this);
  }, onEnableDepth:function() {
    if (this.depthSoftening > 0 && this.camera) {
      this.camera.requestDepthMap();
    }
  }, onDisableDepth:function() {
    if (this.depthSoftening > 0 && this.camera) {
      this.camera.releaseDepthMap();
    }
  }, finishFrame:function() {
    if (this.useCpu) {
      this.vertexBuffer.unlock();
    }
  }, addTime:function(delta, isOnStop) {
    var a, b, c, i, j;
    var device = this.graphicsDevice;
    this.simTimeTotal += delta;
    this.calculateWorldBounds();
    if (this._isAnimated()) {
      var params = this.animParams;
      params.x = 1.0 / this.animTilesX;
      params.y = 1.0 / this.animTilesY;
      params.z = this.animNumFrames * this.animSpeed;
      params.w = this.animNumFrames - 1;
    }
    if (this.lighting) {
      if (!this.scene) {
        console.error("There is no scene defined for lighting particles");
        return;
      }
      for (i = 0;i < 6;i++) {
        this.lightCube[i * 3] = this.scene.ambientLight.data[0];
        this.lightCube[i * 3 + 1] = this.scene.ambientLight.data[1];
        this.lightCube[i * 3 + 2] = this.scene.ambientLight.data[2];
      }
      var dirs = this.scene._globalLights;
      for (i = 0;i < dirs.length;i++) {
        for (c = 0;c < 6;c++) {
          var weight = Math.max(this.lightCubeDir[c].dot(dirs[i]._direction), 0) * dirs[i]._intensity;
          this.lightCube[c * 3] += dirs[i]._color.data[0] * weight;
          this.lightCube[c * 3 + 1] += dirs[i]._color.data[1] * weight;
          this.lightCube[c * 3 + 2] += dirs[i]._color.data[2] * weight;
        }
      }
      this.constantLightCube.setValue(this.lightCube);
    }
    if (this.scene) {
      if (this.camera != this.scene._activeCamera) {
        this.camera = this.scene._activeCamera;
        this.onChangeCamera();
      }
    }
    if (this.emitterShape === pc.EMITTERSHAPE_BOX) {
      if (this.meshInstance.node === null) {
        spawnMatrix.setTRS(pc.Vec3.ZERO, pc.Quat.IDENTITY, this.emitterExtents);
      } else {
        spawnMatrix.setTRS(pc.Vec3.ZERO, this.meshInstance.node.getRotation(), tmpVec3.copy(this.emitterExtents).mul(this.meshInstance.node.localScale));
      }
    }
    var emitterPos;
    var emitterScale = this.meshInstance.node === null ? pc.Vec3.ONE.data : this.meshInstance.node.localScale.data;
    this.material.setParameter("emitterScale", emitterScale);
    if (this.localSpace && this.meshInstance.node) {
      this.material.setParameter("emitterPos", this.meshInstance.node.getPosition().data);
    }
    if (!this.useCpu) {
      device.setBlending(false);
      device.setColorWrite(true, true, true, true);
      device.setCullMode(pc.CULLFACE_NONE);
      device.setDepthTest(false);
      device.setDepthWrite(false);
      this.frameRandom.x = Math.random();
      this.frameRandom.y = Math.random();
      this.frameRandom.z = Math.random();
      this.constantGraphSampleSize.setValue(1.0 / this.precision);
      this.constantGraphNumSamples.setValue(this.precision);
      this.constantNumParticles.setValue(this.numParticles);
      this.constantNumParticlesPot.setValue(this.numParticlesPot);
      this.constantInternalTex0.setValue(this.internalTex0);
      this.constantInternalTex1.setValue(this.internalTex1);
      this.constantInternalTex2.setValue(this.internalTex2);
      if (this.pack8) {
        this.constantOutBoundsMul.setValue(this.worldBoundsMul.data);
        this.constantOutBoundsAdd.setValue(this.worldBoundsAdd.data);
        this.constantInBoundsSize.setValue(this.prevWorldBoundsSize.data);
        this.constantInBoundsCenter.setValue(this.prevWorldBoundsCenter.data);
        var maxVel = this.maxVel * Math.max(Math.max(emitterScale[0], emitterScale[1]), emitterScale[2]);
        maxVel = Math.max(maxVel, 1);
        this.constantMaxVel.setValue(maxVel);
      }
      emitterPos = this.meshInstance.node === null || this.localSpace ? pc.Vec3.ZERO.data : this.meshInstance.node.getPosition().data;
      var emitterMatrix = this.meshInstance.node === null ? pc.Mat4.IDENTITY : this.meshInstance.node.getWorldTransform();
      if (this.emitterShape === pc.EMITTERSHAPE_BOX) {
        mat4ToMat3(spawnMatrix, spawnMatrix3);
        this.constantSpawnBounds.setValue(spawnMatrix3.data);
      } else {
        this.constantSpawnBoundsSphere.setValue(this.emitterRadius);
      }
      this.constantInitialVelocity.setValue(this.initialVelocity);
      mat4ToMat3(emitterMatrix, emitterMatrix3);
      this.constantEmitterPos.setValue(emitterPos);
      this.constantFrameRandom.setValue(this.frameRandom.data);
      this.constantDelta.setValue(delta);
      this.constantRate.setValue(this.rate);
      this.constantRateDiv.setValue(this.rate2 - this.rate);
      this.constantStartAngle.setValue(this.startAngle * pc.math.DEG_TO_RAD);
      this.constantStartAngle2.setValue(this.startAngle2 * pc.math.DEG_TO_RAD);
      this.constantSeed.setValue(this.seed);
      this.constantLifetime.setValue(this.lifetime);
      this.constantEmitterScale.setValue(emitterScale);
      this.constantEmitterMatrix.setValue(emitterMatrix3.data);
      this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data);
      this.constantVelocityDivMult.setValue(this.velocityUMax.data);
      this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]);
      var texIN = this.swapTex ? this.particleTexOUT : this.particleTexIN;
      texIN = this.beenReset ? this.particleTexStart : texIN;
      var texOUT = this.swapTex ? this.particleTexIN : this.particleTexOUT;
      this.constantParticleTexIN.setValue(texIN);
      if (!isOnStop) {
        pc.drawQuadWithShader(device, this.swapTex ? this.rtParticleTexIN : this.rtParticleTexOUT, this.loop ? this.shaderParticleUpdateRespawn : this.shaderParticleUpdateNoRespawn);
      } else {
        pc.drawQuadWithShader(device, this.swapTex ? this.rtParticleTexIN : this.rtParticleTexOUT, this.shaderParticleUpdateOnStop);
      }
      this.constantParticleTexOUT.setValue(texOUT);
      this.material.setParameter("particleTexOUT", texIN);
      this.material.setParameter("particleTexIN", texOUT);
      this.beenReset = false;
      this.swapTex = !this.swapTex;
      device.setDepthTest(true);
      device.setDepthWrite(true);
    } else {
      var data = new Float32Array(this.vertexBuffer.lock());
      if (this.meshInstance.node) {
        var fullMat = this.meshInstance.node.worldTransform;
        for (j = 0;j < 12;j++) {
          rotMat.data[j] = fullMat.data[j];
        }
        nonUniformScale = this.meshInstance.node.localScale;
        uniformScale = Math.max(Math.max(nonUniformScale.x, nonUniformScale.y), nonUniformScale.z);
      }
      emitterPos = this.meshInstance.node === null || this.localSpace ? pc.Vec3.ZERO : this.meshInstance.node.getPosition();
      var posCam = this.camera ? this.camera._node.getPosition() : pc.Vec3.ZERO;
      var vertSize = 14;
      var cf, cc;
      var rotSpeed, rotSpeed2, scale2, alpha, alpha2;
      var precision1 = this.precision - 1;
      for (i = 0;i < this.numParticles;i++) {
        var id = Math.floor(this.vbCPU[i * this.numParticleVerts * 4 + 3]);
        var rndFactor = this.particleTex[id * particleTexChannels + 0 + this.numParticlesPot * 2 * particleTexChannels];
        rndFactor3Vec.data[0] = rndFactor;
        rndFactor3Vec.data[1] = this.particleTex[id * particleTexChannels + 1 + this.numParticlesPot * 2 * particleTexChannels];
        rndFactor3Vec.data[2] = this.particleTex[id * particleTexChannels + 2 + this.numParticlesPot * 2 * particleTexChannels];
        var particleRate = this.rate + (this.rate2 - this.rate) * rndFactor;
        var particleLifetime = this.lifetime;
        var startSpawnTime = -particleRate * id;
        var life = this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels] + delta;
        var nlife = saturate(life / particleLifetime);
        var scale = 0;
        var alphaDiv = 0;
        var angle = 0;
        var len;
        var interpolation;
        var particleEnabled = life > 0.0 && life < particleLifetime;
        if (particleEnabled) {
          c = nlife * precision1;
          cf = Math.floor(c);
          cc = Math.ceil(c);
          c = c % 1;
          a = this.qRotSpeed[cf];
          b = this.qRotSpeed[cc];
          rotSpeed = a + (b - a) * c;
          a = this.qRotSpeed2[cf];
          b = this.qRotSpeed2[cc];
          rotSpeed2 = a + (b - a) * c;
          a = this.qScale[cf];
          b = this.qScale[cc];
          scale = a + (b - a) * c;
          a = this.qScale2[cf];
          b = this.qScale2[cc];
          scale2 = a + (b - a) * c;
          a = this.qAlpha[cf];
          b = this.qAlpha[cc];
          alpha = a + (b - a) * c;
          a = this.qAlpha2[cf];
          b = this.qAlpha2[cc];
          alpha2 = a + (b - a) * c;
          cf *= 3;
          cc *= 3;
          a = this.qLocalVelocity[cf];
          b = this.qLocalVelocity[cc];
          localVelocityVec.data[0] = a + (b - a) * c;
          a = this.qLocalVelocity[cf + 1];
          b = this.qLocalVelocity[cc + 1];
          localVelocityVec.data[1] = a + (b - a) * c;
          a = this.qLocalVelocity[cf + 2];
          b = this.qLocalVelocity[cc + 2];
          localVelocityVec.data[2] = a + (b - a) * c;
          a = this.qLocalVelocity2[cf];
          b = this.qLocalVelocity2[cc];
          localVelocityVec2.data[0] = a + (b - a) * c;
          a = this.qLocalVelocity2[cf + 1];
          b = this.qLocalVelocity2[cc + 1];
          localVelocityVec2.data[1] = a + (b - a) * c;
          a = this.qLocalVelocity2[cf + 2];
          b = this.qLocalVelocity2[cc + 2];
          localVelocityVec2.data[2] = a + (b - a) * c;
          a = this.qVelocity[cf];
          b = this.qVelocity[cc];
          velocityVec.data[0] = a + (b - a) * c;
          a = this.qVelocity[cf + 1];
          b = this.qVelocity[cc + 1];
          velocityVec.data[1] = a + (b - a) * c;
          a = this.qVelocity[cf + 2];
          b = this.qVelocity[cc + 2];
          velocityVec.data[2] = a + (b - a) * c;
          a = this.qVelocity2[cf];
          b = this.qVelocity2[cc];
          velocityVec2.data[0] = a + (b - a) * c;
          a = this.qVelocity2[cf + 1];
          b = this.qVelocity2[cc + 1];
          velocityVec2.data[1] = a + (b - a) * c;
          a = this.qVelocity2[cf + 2];
          b = this.qVelocity2[cc + 2];
          velocityVec2.data[2] = a + (b - a) * c;
          localVelocityVec.data[0] = localVelocityVec.data[0] + (localVelocityVec2.data[0] - localVelocityVec.data[0]) * rndFactor3Vec.data[0];
          localVelocityVec.data[1] = localVelocityVec.data[1] + (localVelocityVec2.data[1] - localVelocityVec.data[1]) * rndFactor3Vec.data[1];
          localVelocityVec.data[2] = localVelocityVec.data[2] + (localVelocityVec2.data[2] - localVelocityVec.data[2]) * rndFactor3Vec.data[2];
          if (this.initialVelocity > 0) {
            if (this.emitterShape === pc.EMITTERSHAPE_SPHERE) {
              randomPos.copy(rndFactor3Vec).scale(2).sub(pc.Vec3.ONE).normalize();
              localVelocityVec.add(randomPos.scale(this.initialVelocity));
            } else {
              localVelocityVec.add(pc.Vec3.FORWARD.scale(this.initialVelocity));
            }
          }
          velocityVec.data[0] = velocityVec.data[0] + (velocityVec2.data[0] - velocityVec.data[0]) * rndFactor3Vec.data[0];
          velocityVec.data[1] = velocityVec.data[1] + (velocityVec2.data[1] - velocityVec.data[1]) * rndFactor3Vec.data[1];
          velocityVec.data[2] = velocityVec.data[2] + (velocityVec2.data[2] - velocityVec.data[2]) * rndFactor3Vec.data[2];
          rotSpeed = rotSpeed + (rotSpeed2 - rotSpeed) * rndFactor3Vec.data[1];
          scale = (scale + (scale2 - scale) * (rndFactor * 10000.0 % 1.0)) * uniformScale;
          alphaDiv = (alpha2 - alpha) * (rndFactor * 1000.0 % 1.0);
          if (this.meshInstance.node) {
            rotMat.transformPoint(localVelocityVec, localVelocityVec);
          }
          localVelocityVec.add(velocityVec.mul(nonUniformScale));
          moveDirVec.copy(localVelocityVec);
          particlePosPrev.data[0] = this.particleTex[id * particleTexChannels];
          particlePosPrev.data[1] = this.particleTex[id * particleTexChannels + 1];
          particlePosPrev.data[2] = this.particleTex[id * particleTexChannels + 2];
          particlePos.copy(particlePosPrev).add(localVelocityVec.scale(delta));
          particleFinalPos.copy(particlePos);
          this.particleTex[id * particleTexChannels] = particleFinalPos.data[0];
          this.particleTex[id * particleTexChannels + 1] = particleFinalPos.data[1];
          this.particleTex[id * particleTexChannels + 2] = particleFinalPos.data[2];
          this.particleTex[id * particleTexChannels + 3] += rotSpeed * delta;
          if (this.wrap && this.wrapBounds) {
            particleFinalPos.sub(emitterPos);
            particleFinalPos.data[0] = glMod(particleFinalPos.data[0], this.wrapBounds.data[0]) - this.wrapBounds.data[0] * 0.5;
            particleFinalPos.data[1] = glMod(particleFinalPos.data[1], this.wrapBounds.data[1]) - this.wrapBounds.data[1] * 0.5;
            particleFinalPos.data[2] = glMod(particleFinalPos.data[2], this.wrapBounds.data[2]) - this.wrapBounds.data[2] * 0.5;
            particleFinalPos.add(emitterPos);
          }
          if (this.sort > 0) {
            if (this.sort === 1) {
              tmpVec3.copy(particleFinalPos).sub(posCam);
              this.particleDistance[id] = -(tmpVec3.data[0] * tmpVec3.data[0] + tmpVec3.data[1] * tmpVec3.data[1] + tmpVec3.data[2] * tmpVec3.data[2]);
            } else {
              if (this.sort === 2) {
                this.particleDistance[id] = life;
              } else {
                if (this.sort === 3) {
                  this.particleDistance[id] = -life;
                }
              }
            }
          }
        } else {
          this.calcSpawnPosition(emitterPos, id);
        }
        if (isOnStop) {
          if (life < 0) {
            this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * 2 * particleTexChannels] = -1;
          }
        } else {
          if (life >= particleLifetime) {
            life -= Math.max(particleLifetime, (this.numParticles - 1) * particleRate);
            this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * 2 * particleTexChannels] = this.loop ? 1 : -1;
          }
          if (life < 0 && this.loop) {
            this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * 2 * particleTexChannels] = 1;
          }
        }
        if (this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * 2 * particleTexChannels] < 0) {
          particleEnabled = false;
        }
        this.particleTex[id * particleTexChannels + 3 + this.numParticlesPot * particleTexChannels] = life;
        for (var v = 0;v < this.numParticleVerts;v++) {
          var quadX = this.vbCPU[i * this.numParticleVerts * 4 + v * 4];
          var quadY = this.vbCPU[i * this.numParticleVerts * 4 + v * 4 + 1];
          var quadZ = this.vbCPU[i * this.numParticleVerts * 4 + v * 4 + 2];
          if (!particleEnabled) {
            quadX = quadY = quadZ = 0;
          }
          var w = i * this.numParticleVerts * vertSize + v * vertSize;
          data[w] = particleFinalPos.data[0];
          data[w + 1] = particleFinalPos.data[1];
          data[w + 2] = particleFinalPos.data[2];
          data[w + 3] = nlife;
          data[w + 4] = this.alignToMotion ? angle : this.particleTex[id * particleTexChannels + 3];
          data[w + 5] = scale;
          data[w + 6] = alphaDiv;
          data[w + 7] = moveDirVec.data[0];
          data[w + 8] = quadX;
          data[w + 9] = quadY;
          data[w + 10] = quadZ;
          data[w + 11] = moveDirVec.data[1];
          data[w + 12] = moveDirVec.data[2];
        }
      }
      if (this.sort > pc.PARTICLESORT_NONE && this.camera) {
        for (i = 0;i < this.numParticles;i++) {
          this.vbToSort[i] = [i, Math.floor(this.vbCPU[i * this.numParticleVerts * 4 + 3])];
        }
        for (i = 0;i < this.vbCPU.length;i++) {
          this.vbOld[i] = this.vbCPU[i];
        }
        var particleDistance = this.particleDistance;
        this.vbToSort.sort(function(a, b) {
          return particleDistance[a[1]] - particleDistance[b[1]];
        });
        for (i = 0;i < this.numParticles;i++) {
          var start = this.vbToSort[i][0];
          for (var corner = 0;corner < this.numParticleVerts;corner++) {
            for (j = 0;j < 4;j++) {
              this.vbCPU[i * this.numParticleVerts * 4 + corner * 4 + j] = this.vbOld[start * this.numParticleVerts * 4 + corner * 4 + j];
            }
          }
        }
      }
    }
    if (!this.loop) {
      if (Date.now() > this.endTime) {
        if (this.onFinished) {
          this.onFinished();
        }
        this.meshInstance.visible = false;
      }
    }
  }, destroy:function() {
    if (this.particleTexIN) {
      this.particleTexIN.destroy();
    }
    if (this.particleTexOUT) {
      this.particleTexOUT.destroy();
    }
    if (!this.useCpu && this.particleTexStart) {
      this.particleTexStart.destroy();
    }
    if (this.rtParticleTexIN) {
      this.rtParticleTexIN.destroy();
    }
    if (this.rtParticleTexOUT) {
      this.rtParticleTexOUT.destroy();
    }
    this.particleTexIN = null;
    this.particleTexOUT = null;
    this.particleTexStart = null;
    this.rtParticleTexIN = null;
    this.rtParticleTexOUT = null;
    this.shaderParticleUpdateRespawn = null;
    this.shaderParticleUpdateNoRespawn = null;
    this.shaderParticleUpdateOnStop = null;
  }};
  return {ParticleEmitter:ParticleEmitter};
}());
function frac(f) {
  return f - Math.floor(f);
}
function encodeFloatRGBA(v) {
  var encX = frac(v);
  var encY = frac(255.0 * v);
  var encZ = frac(65025.0 * v);
  var encW = frac(160581375.0 * v);
  encX -= encY / 255.0;
  encY -= encZ / 255.0;
  encZ -= encW / 255.0;
  encW -= encW / 255.0;
  return [encX, encY, encZ, encW];
}
function encodeFloatRG(v) {
  var encX = frac(v);
  var encY = frac(255.0 * v);
  encX -= encY / 255.0;
  encY -= encY / 255.0;
  return [encX, encY];
}
;pc.extend(pc, function() {
  function sortDrawCalls(drawCallA, drawCallB) {
    if (drawCallA.layer === drawCallB.layer) {
      if (drawCallA.drawOrder && drawCallB.drawOrder) {
        return drawCallA.drawOrder - drawCallB.drawOrder;
      }
    }
    return drawCallB.key - drawCallA.key;
  }
  var Picker = function(device, width, height) {
    this.device = device;
    this.library = device.getProgramLibrary();
    this.pickColor = new Float32Array(4);
    this.scene = null;
    this.drawCalls = [];
    this.clearOptions = {color:[1, 1, 1, 1], depth:1, flags:pc.CLEARFLAG_COLOR | pc.CLEARFLAG_DEPTH};
    this.resize(width, height);
    this._ignoreOpacityFor = null;
  };
  Picker.prototype.getSelection = function(x, y, width, height) {
    var device = this.device;
    if (typeof x === "object") {
      var rect = x;
      x = rect.x;
      y = rect.y;
      width = rect.width;
      height = rect.height;
    } else {
      y = this._pickBufferTarget.height - (y + (height || 1));
    }
    width = width || 1;
    height = height || 1;
    var prevRenderTarget = device.renderTarget;
    device.setRenderTarget(this._pickBufferTarget);
    device.updateBegin();
    var pixels = new Uint8Array(4 * width * height);
    device.readPixels(x, y, width, height, pixels);
    device.updateEnd();
    device.setRenderTarget(prevRenderTarget);
    var selection = [];
    for (var i = 0;i < width * height;i++) {
      var r = pixels[4 * i + 0];
      var g = pixels[4 * i + 1];
      var b = pixels[4 * i + 2];
      var index = r << 16 | g << 8 | b;
      if (index !== 16777215) {
        var selectedMeshInstance = this.drawCalls[index];
        if (selection.indexOf(selectedMeshInstance) === -1) {
          selection.push(selectedMeshInstance);
        }
      }
    }
    return selection;
  };
  Picker.prototype.prepare = function(camera, scene) {
    var device = this.device;
    this.scene = scene;
    var prevRenderTarget = device.renderTarget;
    device.setRenderTarget(this._pickBufferTarget);
    device.updateBegin();
    device.setViewport(0, 0, this._pickBufferTarget.width, this._pickBufferTarget.height);
    device.setScissor(0, 0, this._pickBufferTarget.width, this._pickBufferTarget.height);
    device.clear(this.clearOptions);
    var i;
    var mesh, meshInstance, material;
    var type;
    var shader, isLastSelected;
    var scope = device.scope;
    var modelMatrixId = scope.resolve("matrix_model");
    var boneTextureId = scope.resolve("texture_poseMap");
    var boneTextureSizeId = scope.resolve("texture_poseMapSize");
    var skinPosOffsetId = scope.resolve("skinPosOffset");
    var poseMatrixId = scope.resolve("matrix_pose[0]");
    var pickColorId = scope.resolve("uColor");
    var projId = scope.resolve("matrix_projection");
    var viewProjId = scope.resolve("matrix_viewProjection");
    var opacityMapId = scope.resolve("texture_opacityMap");
    var alphaTestId = scope.resolve("alpha_ref");
    var wtm = camera._node.getWorldTransform();
    var projMat = camera.getProjectionMatrix();
    var viewMat = wtm.clone().invert();
    var viewProjMat = new pc.Mat4;
    viewProjMat.mul2(projMat, viewMat);
    projId.setValue(projMat.data);
    viewProjId.setValue(viewProjMat.data);
    this.drawCalls = scene.drawCalls.slice(0);
    this.drawCalls.sort(sortDrawCalls);
    for (i = 0;i < this.drawCalls.length;i++) {
      if (this.drawCalls[i].command) {
        this.drawCalls[i].command();
      } else {
        if (!this.drawCalls[i].pick) {
          continue;
        }
        meshInstance = this.drawCalls[i];
        mesh = meshInstance.mesh;
        material = meshInstance.material;
        type = mesh.primitive[pc.RENDERSTYLE_SOLID].type;
        var isSolid = type === pc.PRIMITIVE_TRIANGLES || type === pc.PRIMITIVE_TRISTRIP || type === pc.PRIMITIVE_TRIFAN;
        var isPickable = material instanceof pc.StandardMaterial || material instanceof pc.BasicMaterial;
        if (isSolid && isPickable) {
          device.setBlending(false);
          device.setCullMode(material.cull);
          device.setDepthWrite(material.depthWrite);
          device.setDepthTest(material.depthTest);
          modelMatrixId.setValue(meshInstance.node.worldTransform.data);
          if (meshInstance.skinInstance) {
            skinPosOffsetId.setValue(meshInstance.node.getPosition().data);
            if (device.supportsBoneTextures) {
              boneTextureId.setValue(meshInstance.skinInstance.boneTexture);
              var w = meshInstance.skinInstance.boneTexture.width;
              var h = meshInstance.skinInstance.boneTexture.height;
              boneTextureSizeId.setValue([w, h]);
            } else {
              poseMatrixId.setValue(meshInstance.skinInstance.matrixPalette);
            }
          }
          if (material.opacityMap) {
            opacityMapId.setValue(material.opacityMap);
            alphaTestId.setValue(meshInstance === this._ignoreOpacityFor ? 0 : material.alphaTest);
          }
          this.pickColor[0] = (i >> 16 & 255) / 255;
          this.pickColor[1] = (i >> 8 & 255) / 255;
          this.pickColor[2] = (i & 255) / 255;
          this.pickColor[3] = 1;
          pickColorId.setValue(this.pickColor);
          shader = meshInstance._shader[pc.SHADER_PICK];
          if (!shader) {
            shader = this.library.getProgram("pick", {skin:!!meshInstance.skinInstance, screenSpace:meshInstance.screenSpace, opacityMap:!!material.opacityMap, opacityChannel:material.opacityMap ? material.opacityMapChannel || "r" : null});
            meshInstance._shader[pc.SHADER_PICK] = shader;
          }
          device.setShader(shader);
          device.setVertexBuffer(meshInstance.morphInstance && meshInstance.morphInstance._vertexBuffer ? meshInstance.morphInstance._vertexBuffer : mesh.vertexBuffer, 0);
          device.setIndexBuffer(mesh.indexBuffer[pc.RENDERSTYLE_SOLID]);
          device.draw(mesh.primitive[pc.RENDERSTYLE_SOLID]);
        }
      }
    }
    device.setViewport(0, 0, device.width, device.height);
    device.setScissor(0, 0, device.width, device.height);
    device.updateEnd();
    device.setRenderTarget(prevRenderTarget);
  };
  Picker.prototype.resize = function(width, height) {
    var colorBuffer = new pc.Texture(this.device, {format:pc.PIXELFORMAT_R8_G8_B8_A8, width:width, height:height, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
    this._pickBufferTarget = new pc.RenderTarget(this.device, colorBuffer, {depth:true});
  };
  Object.defineProperty(Picker.prototype, "renderTarget", {get:function() {
    return this._pickBufferTarget;
  }});
  Object.defineProperty(Picker.prototype, "width", {get:function() {
    return this._pickBufferTarget.width;
  }});
  Object.defineProperty(Picker.prototype, "height", {get:function() {
    return this._pickBufferTarget.height;
  }});
  return {Picker:Picker};
}());
var primitiveUv1Padding = 4.0 / 64;
var primitiveUv1PaddingScale = 1.0 - primitiveUv1Padding * 2;
pc.calculateNormals = function(positions, indices) {
  var triangleCount = indices.length / 3;
  var vertexCount = positions.length / 3;
  var i1, i2, i3;
  var i;
  var p1 = new pc.Vec3;
  var p2 = new pc.Vec3;
  var p3 = new pc.Vec3;
  var p1p2 = new pc.Vec3;
  var p1p3 = new pc.Vec3;
  var faceNormal = new pc.Vec3;
  var vertexNormal = new pc.Vec3;
  var normals = [];
  for (i = 0;i < positions.length;i++) {
    normals[i] = 0;
  }
  for (i = 0;i < triangleCount;i++) {
    i1 = indices[i * 3];
    i2 = indices[i * 3 + 1];
    i3 = indices[i * 3 + 2];
    p1.set(positions[i1 * 3], positions[i1 * 3 + 1], positions[i1 * 3 + 2]);
    p2.set(positions[i2 * 3], positions[i2 * 3 + 1], positions[i2 * 3 + 2]);
    p3.set(positions[i3 * 3], positions[i3 * 3 + 1], positions[i3 * 3 + 2]);
    p1p2.sub2(p2, p1);
    p1p3.sub2(p3, p1);
    faceNormal.cross(p1p2, p1p3).normalize();
    normals[i1 * 3] += faceNormal.x;
    normals[i1 * 3 + 1] += faceNormal.y;
    normals[i1 * 3 + 2] += faceNormal.z;
    normals[i2 * 3] += faceNormal.x;
    normals[i2 * 3 + 1] += faceNormal.y;
    normals[i2 * 3 + 2] += faceNormal.z;
    normals[i3 * 3] += faceNormal.x;
    normals[i3 * 3 + 1] += faceNormal.y;
    normals[i3 * 3 + 2] += faceNormal.z;
  }
  for (i = 0;i < vertexCount;i++) {
    var nx = normals[i * 3];
    var ny = normals[i * 3 + 1];
    var nz = normals[i * 3 + 2];
    var invLen = 1 / Math.sqrt(nx * nx + ny * ny + nz * nz);
    normals[i * 3] *= invLen;
    normals[i * 3 + 1] *= invLen;
    normals[i * 3 + 2] *= invLen;
  }
  return normals;
};
pc.calculateTangents = function(positions, normals, uvs, indices) {
  var triangleCount = indices.length / 3;
  var vertexCount = positions.length / 3;
  var i1, i2, i3;
  var x1, x2, y1, y2, z1, z2, s1, s2, t1, t2, r;
  var sdir = new pc.Vec3;
  var tdir = new pc.Vec3;
  var v1 = new pc.Vec3;
  var v2 = new pc.Vec3;
  var v3 = new pc.Vec3;
  var w1 = new pc.Vec2;
  var w2 = new pc.Vec2;
  var w3 = new pc.Vec2;
  var i;
  var tan1 = new Float32Array(vertexCount * 3);
  var tan2 = new Float32Array(vertexCount * 3);
  var tangents = [];
  var area = 0.0;
  for (i = 0;i < triangleCount;i++) {
    i1 = indices[i * 3];
    i2 = indices[i * 3 + 1];
    i3 = indices[i * 3 + 2];
    v1.set(positions[i1 * 3], positions[i1 * 3 + 1], positions[i1 * 3 + 2]);
    v2.set(positions[i2 * 3], positions[i2 * 3 + 1], positions[i2 * 3 + 2]);
    v3.set(positions[i3 * 3], positions[i3 * 3 + 1], positions[i3 * 3 + 2]);
    w1.set(uvs[i1 * 2], uvs[i1 * 2 + 1]);
    w2.set(uvs[i2 * 2], uvs[i2 * 2 + 1]);
    w3.set(uvs[i3 * 2], uvs[i3 * 2 + 1]);
    x1 = v2.x - v1.x;
    x2 = v3.x - v1.x;
    y1 = v2.y - v1.y;
    y2 = v3.y - v1.y;
    z1 = v2.z - v1.z;
    z2 = v3.z - v1.z;
    s1 = w2.x - w1.x;
    s2 = w3.x - w1.x;
    t1 = w2.y - w1.y;
    t2 = w3.y - w1.y;
    area = s1 * t2 - s2 * t1;
    if (area == 0.0) {
      sdir.set(0.0, 1.0, 0.0);
      tdir.set(1.0, 0.0, 0.0);
    } else {
      r = 1.0 / area;
      sdir.set((t2 * x1 - t1 * x2) * r, (t2 * y1 - t1 * y2) * r, (t2 * z1 - t1 * z2) * r);
      tdir.set((s1 * x2 - s2 * x1) * r, (s1 * y2 - s2 * y1) * r, (s1 * z2 - s2 * z1) * r);
    }
    tan1[i1 * 3 + 0] += sdir.x;
    tan1[i1 * 3 + 1] += sdir.y;
    tan1[i1 * 3 + 2] += sdir.z;
    tan1[i2 * 3 + 0] += sdir.x;
    tan1[i2 * 3 + 1] += sdir.y;
    tan1[i2 * 3 + 2] += sdir.z;
    tan1[i3 * 3 + 0] += sdir.x;
    tan1[i3 * 3 + 1] += sdir.y;
    tan1[i3 * 3 + 2] += sdir.z;
    tan2[i1 * 3 + 0] += tdir.x;
    tan2[i1 * 3 + 1] += tdir.y;
    tan2[i1 * 3 + 2] += tdir.z;
    tan2[i2 * 3 + 0] += tdir.x;
    tan2[i2 * 3 + 1] += tdir.y;
    tan2[i2 * 3 + 2] += tdir.z;
    tan2[i3 * 3 + 0] += tdir.x;
    tan2[i3 * 3 + 1] += tdir.y;
    tan2[i3 * 3 + 2] += tdir.z;
  }
  t1 = new pc.Vec3;
  t2 = new pc.Vec3;
  var n = new pc.Vec3;
  var temp = new pc.Vec3;
  for (i = 0;i < vertexCount;i++) {
    n.set(normals[i * 3], normals[i * 3 + 1], normals[i * 3 + 2]);
    t1.set(tan1[i * 3], tan1[i * 3 + 1], tan1[i * 3 + 2]);
    t2.set(tan2[i * 3], tan2[i * 3 + 1], tan2[i * 3 + 2]);
    var ndott = n.dot(t1);
    temp.copy(n).scale(ndott);
    temp.sub2(t1, temp).normalize();
    tangents[i * 4] = temp.x;
    tangents[i * 4 + 1] = temp.y;
    tangents[i * 4 + 2] = temp.z;
    temp.cross(n, t1);
    tangents[i * 4 + 3] = temp.dot(t2) < 0.0 ? -1.0 : 1.0;
  }
  return tangents;
};
pc.createMesh = function(device, positions, opts) {
  var normals = opts && opts.normals !== undefined ? opts.normals : null;
  var tangents = opts && opts.tangents !== undefined ? opts.tangents : null;
  var colors = opts && opts.colors !== undefined ? opts.colors : null;
  var uvs = opts && opts.uvs !== undefined ? opts.uvs : null;
  var uvs1 = opts && opts.uvs1 !== undefined ? opts.uvs1 : null;
  var indices = opts && opts.indices !== undefined ? opts.indices : null;
  var blendIndices = opts && opts.blendIndices !== undefined ? opts.blendIndices : null;
  var blendWeights = opts && opts.blendWeights !== undefined ? opts.blendWeights : null;
  var vertexDesc = [{semantic:pc.SEMANTIC_POSITION, components:3, type:pc.TYPE_FLOAT32}];
  if (normals !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_NORMAL, components:3, type:pc.TYPE_FLOAT32});
  }
  if (tangents !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_TANGENT, components:4, type:pc.TYPE_FLOAT32});
  }
  if (colors !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_COLOR, components:4, type:pc.TYPE_UINT8, normalize:true});
  }
  if (uvs !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_TEXCOORD0, components:2, type:pc.TYPE_FLOAT32});
  }
  if (uvs1 !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_TEXCOORD1, components:2, type:pc.TYPE_FLOAT32});
  }
  if (blendIndices !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_BLENDINDICES, components:2, type:pc.TYPE_UINT8});
  }
  if (blendWeights !== null) {
    vertexDesc.push({semantic:pc.SEMANTIC_BLENDWEIGHT, components:2, type:pc.TYPE_FLOAT32});
  }
  var vertexFormat = new pc.VertexFormat(device, vertexDesc);
  var numVertices = positions.length / 3;
  var vertexBuffer = new pc.VertexBuffer(device, vertexFormat, numVertices);
  var iterator = new pc.VertexIterator(vertexBuffer);
  for (var i = 0;i < numVertices;i++) {
    iterator.element[pc.SEMANTIC_POSITION].set(positions[i * 3], positions[i * 3 + 1], positions[i * 3 + 2]);
    if (normals !== null) {
      iterator.element[pc.SEMANTIC_NORMAL].set(normals[i * 3], normals[i * 3 + 1], normals[i * 3 + 2]);
    }
    if (tangents !== null) {
      iterator.element[pc.SEMANTIC_TANGENT].set(tangents[i * 4], tangents[i * 4 + 1], tangents[i * 4 + 2], tangents[i * 4 + 3]);
    }
    if (colors !== null) {
      iterator.element[pc.SEMANTIC_COLOR].set(colors[i * 4], colors[i * 4 + 1], colors[i * 4 + 2], colors[i * 4 + 3]);
    }
    if (uvs !== null) {
      iterator.element[pc.SEMANTIC_TEXCOORD0].set(uvs[i * 2], uvs[i * 2 + 1]);
    }
    if (uvs1 !== null) {
      iterator.element[pc.SEMANTIC_TEXCOORD1].set(uvs1[i * 2], uvs1[i * 2 + 1]);
    }
    if (blendIndices !== null) {
      iterator.element[pc.SEMANTIC_BLENDINDICES].set(blendIndices[i * 2], blendIndices[i * 2 + 1]);
    }
    if (blendWeights !== null) {
      iterator.element[pc.SEMANTIC_BLENDWEIGHT].set(blendWeights[i * 2], blendWeights[i * 2 + 1]);
    }
    iterator.next();
  }
  iterator.end();
  var indexBuffer = null;
  var indexed = indices !== null;
  if (indexed) {
    indexBuffer = new pc.IndexBuffer(device, pc.INDEXFORMAT_UINT16, indices.length);
    var dst = new Uint16Array(indexBuffer.lock());
    dst.set(indices);
    indexBuffer.unlock();
  }
  var aabb = new pc.BoundingBox;
  aabb.compute(positions);
  var mesh = new pc.Mesh;
  mesh.vertexBuffer = vertexBuffer;
  mesh.indexBuffer[0] = indexBuffer;
  mesh.primitive[0].type = pc.PRIMITIVE_TRIANGLES;
  mesh.primitive[0].base = 0;
  mesh.primitive[0].count = indexed ? indices.length : numVertices;
  mesh.primitive[0].indexed = indexed;
  mesh.aabb = aabb;
  return mesh;
};
pc.createTorus = function(device, opts) {
  var rc = opts && opts.tubeRadius !== undefined ? opts.tubeRadius : 0.2;
  var rt = opts && opts.ringRadius !== undefined ? opts.ringRadius : 0.3;
  var segments = opts && opts.segments !== undefined ? opts.segments : 30;
  var sides = opts && opts.sides !== undefined ? opts.sides : 20;
  var i, j;
  var x, y, z, nx, ny, nz, u, v;
  var positions = [];
  var normals = [];
  var uvs = [];
  var indices = [];
  for (i = 0;i <= sides;i++) {
    for (j = 0;j <= segments;j++) {
      x = Math.cos(2.0 * Math.PI * j / segments) * (rt + rc * Math.cos(2.0 * Math.PI * i / sides));
      y = Math.sin(2.0 * Math.PI * i / sides) * rc;
      z = Math.sin(2.0 * Math.PI * j / segments) * (rt + rc * Math.cos(2.0 * Math.PI * i / sides));
      nx = Math.cos(2.0 * Math.PI * j / segments) * Math.cos(2.0 * Math.PI * i / sides);
      ny = Math.sin(2.0 * Math.PI * i / sides);
      nz = Math.sin(2.0 * Math.PI * j / segments) * Math.cos(2.0 * Math.PI * i / sides);
      u = i / sides;
      v = 1.0 - j / segments;
      positions.push(x, y, z);
      normals.push(nx, ny, nz);
      uvs.push(u, v);
      if (i < sides && j < segments) {
        var first, second, third, fourth;
        first = i * (segments + 1) + j;
        second = (i + 1) * (segments + 1) + j;
        third = i * (segments + 1) + (j + 1);
        fourth = (i + 1) * (segments + 1) + (j + 1);
        indices.push(first, second, third);
        indices.push(second, fourth, third);
      }
    }
  }
  var options = {normals:normals, uvs:uvs, indices:indices};
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(positions, normals, uvs, indices);
  }
  return pc.createMesh(device, positions, options);
};
pc._createConeData = function(baseRadius, peakRadius, height, heightSegments, capSegments, roundedCaps) {
  var i, j;
  var x, y, z, u, v;
  var pos = new pc.Vec3;
  var bottomToTop = new pc.Vec3;
  var norm = new pc.Vec3;
  var top, bottom, tangent;
  var positions = [];
  var normals = [];
  var uvs = [];
  var uvs1 = [];
  var indices = [];
  var theta, cosTheta, sinTheta;
  var phi, sinPhi, cosPhi;
  var first, second, third, fourth;
  var offset;
  if (height > 0) {
    for (i = 0;i <= heightSegments;i++) {
      for (j = 0;j <= capSegments;j++) {
        theta = j / capSegments * 2.0 * Math.PI - Math.PI;
        sinTheta = Math.sin(theta);
        cosTheta = Math.cos(theta);
        bottom = new pc.Vec3(sinTheta * baseRadius, -height / 2.0, cosTheta * baseRadius);
        top = new pc.Vec3(sinTheta * peakRadius, height / 2.0, cosTheta * peakRadius);
        pos.lerp(bottom, top, i / heightSegments);
        bottomToTop.sub2(top, bottom).normalize();
        tangent = new pc.Vec3(cosTheta, 0.0, -sinTheta);
        norm.cross(tangent, bottomToTop).normalize();
        positions.push(pos.x, pos.y, pos.z);
        normals.push(norm.x, norm.y, norm.z);
        u = j / capSegments;
        v = i / heightSegments;
        uvs.push(u, v);
        var _v = v;
        v = u;
        u = _v;
        u /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        uvs1.push(u, v);
        if (i < heightSegments && j < capSegments) {
          first = i * (capSegments + 1) + j;
          second = i * (capSegments + 1) + (j + 1);
          third = (i + 1) * (capSegments + 1) + j;
          fourth = (i + 1) * (capSegments + 1) + (j + 1);
          indices.push(first, second, third);
          indices.push(second, fourth, third);
        }
      }
    }
  }
  if (roundedCaps) {
    var lat, lon;
    var latitudeBands = Math.floor(capSegments / 2);
    var longitudeBands = capSegments;
    var capOffset = height / 2;
    for (lat = 0;lat <= latitudeBands;lat++) {
      theta = lat * Math.PI * 0.5 / latitudeBands;
      sinTheta = Math.sin(theta);
      cosTheta = Math.cos(theta);
      for (lon = 0;lon <= longitudeBands;lon++) {
        phi = lon * 2 * Math.PI / longitudeBands - Math.PI / 2.0;
        sinPhi = Math.sin(phi);
        cosPhi = Math.cos(phi);
        x = cosPhi * sinTheta;
        y = cosTheta;
        z = sinPhi * sinTheta;
        u = 1.0 - lon / longitudeBands;
        v = 1.0 - lat / latitudeBands;
        positions.push(x * peakRadius, y * peakRadius + capOffset, z * peakRadius);
        normals.push(x, y, z);
        uvs.push(u, v);
        u /= 3;
        v /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        u += 1.0 / 3;
        uvs1.push(u, v);
      }
    }
    offset = (heightSegments + 1) * (capSegments + 1);
    for (lat = 0;lat < latitudeBands;++lat) {
      for (lon = 0;lon < longitudeBands;++lon) {
        first = lat * (longitudeBands + 1) + lon;
        second = first + longitudeBands + 1;
        indices.push(offset + first + 1, offset + second, offset + first);
        indices.push(offset + first + 1, offset + second + 1, offset + second);
      }
    }
    for (lat = 0;lat <= latitudeBands;lat++) {
      theta = Math.PI * 0.5 + lat * Math.PI * 0.5 / latitudeBands;
      sinTheta = Math.sin(theta);
      cosTheta = Math.cos(theta);
      for (lon = 0;lon <= longitudeBands;lon++) {
        phi = lon * 2 * Math.PI / longitudeBands - Math.PI / 2.0;
        sinPhi = Math.sin(phi);
        cosPhi = Math.cos(phi);
        x = cosPhi * sinTheta;
        y = cosTheta;
        z = sinPhi * sinTheta;
        u = 1.0 - lon / longitudeBands;
        v = 1.0 - lat / latitudeBands;
        positions.push(x * peakRadius, y * peakRadius - capOffset, z * peakRadius);
        normals.push(x, y, z);
        uvs.push(u, v);
        u /= 3;
        v /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        u += 2.0 / 3;
        uvs1.push(u, v);
      }
    }
    offset = (heightSegments + 1) * (capSegments + 1) + (longitudeBands + 1) * (latitudeBands + 1);
    for (lat = 0;lat < latitudeBands;++lat) {
      for (lon = 0;lon < longitudeBands;++lon) {
        first = lat * (longitudeBands + 1) + lon;
        second = first + longitudeBands + 1;
        indices.push(offset + first + 1, offset + second, offset + first);
        indices.push(offset + first + 1, offset + second + 1, offset + second);
      }
    }
  } else {
    offset = (heightSegments + 1) * (capSegments + 1);
    if (baseRadius > 0.0) {
      for (i = 0;i < capSegments;i++) {
        theta = i / capSegments * 2.0 * Math.PI;
        x = Math.sin(theta);
        y = -height / 2.0;
        z = Math.cos(theta);
        u = 1.0 - (x + 1.0) / 2.0;
        v = (z + 1.0) / 2.0;
        positions.push(x * baseRadius, y, z * baseRadius);
        normals.push(0.0, -1.0, 0.0);
        uvs.push(u, v);
        u /= 3;
        v /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        u += 1.0 / 3;
        uvs1.push(u, v);
        if (i > 1) {
          indices.push(offset, offset + i, offset + i - 1);
        }
      }
    }
    offset += capSegments;
    if (peakRadius > 0.0) {
      for (i = 0;i < capSegments;i++) {
        theta = i / capSegments * 2.0 * Math.PI;
        x = Math.sin(theta);
        y = height / 2.0;
        z = Math.cos(theta);
        u = 1.0 - (x + 1.0) / 2.0;
        v = (z + 1.0) / 2.0;
        positions.push(x * peakRadius, y, z * peakRadius);
        normals.push(0.0, 1.0, 0.0);
        uvs.push(u, v);
        u /= 3;
        v /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        u += 2.0 / 3;
        uvs1.push(u, v);
        if (i > 1) {
          indices.push(offset, offset + i - 1, offset + i);
        }
      }
    }
  }
  return {positions:positions, normals:normals, uvs:uvs, uvs1:uvs1, indices:indices};
};
pc.createCylinder = function(device, opts) {
  var radius = opts && (opts.radius || opts.baseRadius);
  radius = radius !== undefined ? radius : 0.5;
  var height = opts && opts.height !== undefined ? opts.height : 1.0;
  var heightSegments = opts && opts.heightSegments !== undefined ? opts.heightSegments : 5;
  var capSegments = opts && opts.capSegments !== undefined ? opts.capSegments : 20;
  var options = pc._createConeData(radius, radius, height, heightSegments, capSegments, false);
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(options.positions, options.normals, options.uvs, options.indices);
  }
  return pc.createMesh(device, options.positions, options);
};
pc.createCapsule = function(device, opts) {
  var radius = opts && opts.radius !== undefined ? opts.radius : 0.3;
  var height = opts && opts.height !== undefined ? opts.height : 1.0;
  var heightSegments = opts && opts.heightSegments !== undefined ? opts.heightSegments : 1;
  var sides = opts && opts.sides !== undefined ? opts.sides : 20;
  var options = pc._createConeData(radius, radius, height - 2 * radius, heightSegments, sides, true);
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(options.positions, options.normals, options.uvs, options.indices);
  }
  return pc.createMesh(device, options.positions, options);
};
pc.createCone = function(device, opts) {
  var baseRadius = opts && opts.baseRadius !== undefined ? opts.baseRadius : 0.5;
  var peakRadius = opts && opts.peakRadius !== undefined ? opts.peakRadius : 0.0;
  var height = opts && opts.height !== undefined ? opts.height : 1.0;
  var heightSegments = opts && opts.heightSegments !== undefined ? opts.heightSegments : 5;
  var capSegments = opts && opts.capSegments !== undefined ? opts.capSegments : 18;
  var options = pc._createConeData(baseRadius, peakRadius, height, heightSegments, capSegments, false);
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(options.positions, options.normals, options.uvs, options.indices);
  }
  return pc.createMesh(device, options.positions, options);
};
pc.createSphere = function(device, opts) {
  var radius = opts && opts.radius !== undefined ? opts.radius : 0.5;
  var latitudeBands = opts && opts.latitudeBands !== undefined ? opts.latitudeBands : 16;
  var longitudeBands = opts && opts.longitudeBands !== undefined ? opts.longitudeBands : 16;
  var lon, lat;
  var theta, sinTheta, cosTheta, phi, sinPhi, cosPhi;
  var first, second;
  var x, y, z, u, v;
  var positions = [];
  var normals = [];
  var uvs = [];
  var indices = [];
  for (lat = 0;lat <= latitudeBands;lat++) {
    theta = lat * Math.PI / latitudeBands;
    sinTheta = Math.sin(theta);
    cosTheta = Math.cos(theta);
    for (lon = 0;lon <= longitudeBands;lon++) {
      phi = lon * 2 * Math.PI / longitudeBands - Math.PI / 2.0;
      sinPhi = Math.sin(phi);
      cosPhi = Math.cos(phi);
      x = cosPhi * sinTheta;
      y = cosTheta;
      z = sinPhi * sinTheta;
      u = 1.0 - lon / longitudeBands;
      v = 1.0 - lat / latitudeBands;
      positions.push(x * radius, y * radius, z * radius);
      normals.push(x, y, z);
      uvs.push(u, v);
    }
  }
  for (lat = 0;lat < latitudeBands;++lat) {
    for (lon = 0;lon < longitudeBands;++lon) {
      first = lat * (longitudeBands + 1) + lon;
      second = first + longitudeBands + 1;
      indices.push(first + 1, second, first);
      indices.push(first + 1, second + 1, second);
    }
  }
  var options = {normals:normals, uvs:uvs, uvs1:uvs, indices:indices};
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(positions, normals, uvs, indices);
  }
  return pc.createMesh(device, positions, options);
};
pc.createPlane = function(device, opts) {
  var he = opts && opts.halfExtents !== undefined ? opts.halfExtents : new pc.Vec2(0.5, 0.5);
  var ws = opts && opts.widthSegments !== undefined ? opts.widthSegments : 5;
  var ls = opts && opts.lengthSegments !== undefined ? opts.lengthSegments : 5;
  var i, j;
  var x, y, z, u, v;
  var positions = [];
  var normals = [];
  var uvs = [];
  var indices = [];
  for (i = 0;i <= ws;i++) {
    for (j = 0;j <= ls;j++) {
      x = -he.x + 2.0 * he.x * i / ws;
      y = 0.0;
      z = -(-he.y + 2.0 * he.y * j / ls);
      u = i / ws;
      v = j / ls;
      positions.push(x, y, z);
      normals.push(0.0, 1.0, 0.0);
      uvs.push(u, v);
      if (i < ws && j < ls) {
        indices.push(j + i * (ws + 1), j + (i + 1) * (ws + 1), j + i * (ws + 1) + 1);
        indices.push(j + (i + 1) * (ws + 1), j + (i + 1) * (ws + 1) + 1, j + i * (ws + 1) + 1);
      }
    }
  }
  var options = {normals:normals, uvs:uvs, uvs1:uvs, indices:indices};
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(positions, normals, uvs, indices);
  }
  return pc.createMesh(device, positions, options);
};
pc.createBox = function(device, opts) {
  var he = opts && opts.halfExtents !== undefined ? opts.halfExtents : new pc.Vec3(0.5, 0.5, 0.5);
  var ws = opts && opts.widthSegments !== undefined ? opts.widthSegments : 1;
  var ls = opts && opts.lengthSegments !== undefined ? opts.lengthSegments : 1;
  var hs = opts && opts.heightSegments !== undefined ? opts.heightSegments : 1;
  var corners = [new pc.Vec3(-he.x, -he.y, he.z), new pc.Vec3(he.x, -he.y, he.z), new pc.Vec3(he.x, he.y, he.z), new pc.Vec3(-he.x, he.y, he.z), new pc.Vec3(he.x, -he.y, -he.z), new pc.Vec3(-he.x, -he.y, -he.z), new pc.Vec3(-he.x, he.y, -he.z), new pc.Vec3(he.x, he.y, -he.z)];
  var faceAxes = [[0, 1, 3], [4, 5, 7], [3, 2, 6], [1, 0, 4], [1, 4, 2], [5, 0, 6]];
  var faceNormals = [[0, 0, 1], [0, 0, -1], [0, 1, 0], [0, -1, 0], [1, 0, 0], [-1, 0, 0]];
  var sides = {FRONT:0, BACK:1, TOP:2, BOTTOM:3, RIGHT:4, LEFT:5};
  var side, i, j;
  var positions = [];
  var normals = [];
  var uvs = [];
  var uvs1 = [];
  var indices = [];
  var generateFace = function(side, uSegments, vSegments) {
    var x, y, z, u, v;
    var i, j;
    var offset = positions.length / 3;
    for (i = 0;i <= uSegments;i++) {
      for (j = 0;j <= vSegments;j++) {
        var temp1 = new pc.Vec3;
        var temp2 = new pc.Vec3;
        var temp3 = new pc.Vec3;
        var r = new pc.Vec3;
        temp1.lerp(corners[faceAxes[side][0]], corners[faceAxes[side][1]], i / uSegments);
        temp2.lerp(corners[faceAxes[side][0]], corners[faceAxes[side][2]], j / vSegments);
        temp3.sub2(temp2, corners[faceAxes[side][0]]);
        r.add2(temp1, temp3);
        u = i / uSegments;
        v = j / vSegments;
        positions.push(r.x, r.y, r.z);
        normals.push(faceNormals[side][0], faceNormals[side][1], faceNormals[side][2]);
        uvs.push(u, v);
        u /= 3;
        v /= 3;
        u = u * primitiveUv1PaddingScale + primitiveUv1Padding;
        v = v * primitiveUv1PaddingScale + primitiveUv1Padding;
        u += side % 3 / 3;
        v += Math.floor(side / 3) / 3;
        uvs1.push(u, v);
        if (i < uSegments && j < vSegments) {
          indices.push(offset + j + i * (uSegments + 1), offset + j + (i + 1) * (uSegments + 1), offset + j + i * (uSegments + 1) + 1);
          indices.push(offset + j + (i + 1) * (uSegments + 1), offset + j + (i + 1) * (uSegments + 1) + 1, offset + j + i * (uSegments + 1) + 1);
        }
      }
    }
  };
  generateFace(sides.FRONT, ws, hs);
  generateFace(sides.BACK, ws, hs);
  generateFace(sides.TOP, ws, ls);
  generateFace(sides.BOTTOM, ws, ls);
  generateFace(sides.RIGHT, ls, hs);
  generateFace(sides.LEFT, ls, hs);
  var options = {normals:normals, uvs:uvs, uvs1:uvs1, indices:indices};
  if (pc.precalculatedTangents) {
    options.tangents = pc.calculateTangents(positions, normals, uvs, indices);
  }
  return pc.createMesh(device, positions, options);
};
pc.Scene.defaultMaterial = new pc.StandardMaterial;
pc.Scene.defaultMaterial.shadingModel = pc.SPECULAR_BLINN;
pc.extend(pc, function() {
  var Key = function Key(time, position, rotation, scale) {
    this.time = time;
    this.position = position;
    this.rotation = rotation;
    this.scale = scale;
  };
  var Node = function Node() {
    this._name = "";
    this._keys = [];
  };
  var Animation = function Animation() {
    this.name = "";
    this.duration = 0;
    this._nodes = [];
    this._nodeDict = {};
  };
  Animation.prototype.getDuration = function() {
    return this.duration;
  };
  Animation.prototype.getName = function() {
    return this.name;
  };
  Animation.prototype.getNode = function(name) {
    return this._nodeDict[name];
  };
  Object.defineProperty(Animation.prototype, "nodes", {get:function() {
    return this._nodes;
  }});
  Animation.prototype.getNodes = function() {
    return this._nodes;
  };
  Animation.prototype.setDuration = function(value) {
    this.duration = value;
  };
  Animation.prototype.setName = function(value) {
    this.name = value;
  };
  Animation.prototype.addNode = function(node) {
    this._nodes.push(node);
    this._nodeDict[node._name] = node;
  };
  return {Animation:Animation, Key:Key, Node:Node};
}());
pc.extend(pc, function() {
  function InterpolatedKey() {
    this._written = false;
    this._name = "";
    this._keyFrames = [];
    this._quat = new pc.Quat;
    this._pos = new pc.Vec3;
    this._scale = new pc.Vec3;
    this._targetNode = null;
  }
  InterpolatedKey.prototype = {getTarget:function() {
    return this._targetNode;
  }, setTarget:function(node) {
    this._targetNode = node;
  }};
  var Skeleton = function Skeleton(graph) {
    this._animation = null;
    this._time = 0;
    this.looping = true;
    this._interpolatedKeys = [];
    this._interpolatedKeyDict = {};
    this._currKeyIndices = {};
    this.graph = null;
    var self = this;
    function addInterpolatedKeys(node) {
      var interpKey = new InterpolatedKey;
      interpKey._name = node.name;
      self._interpolatedKeys.push(interpKey);
      self._interpolatedKeyDict[node.name] = interpKey;
      self._currKeyIndices[node.name] = 0;
      for (var i = 0;i < node._children.length;i++) {
        addInterpolatedKeys(node._children[i]);
      }
    }
    addInterpolatedKeys(graph);
  };
  Skeleton.prototype.addTime = function(delta) {
    if (this._animation !== null) {
      var i;
      var node, nodeName;
      var keys, interpKey;
      var k1, k2, alpha;
      var nodes = this._animation._nodes;
      var duration = this._animation.duration;
      if (this._time === duration && !this.looping) {
        return;
      }
      this._time += delta;
      if (this._time > duration) {
        this._time = this.looping ? 0.0 : duration;
        for (i = 0;i < nodes.length;i++) {
          node = nodes[i];
          nodeName = node._name;
          this._currKeyIndices[nodeName] = 0;
        }
      } else {
        if (this._time < 0) {
          this._time = this.looping ? duration : 0.0;
          for (i = 0;i < nodes.length;i++) {
            node = nodes[i];
            nodeName = node._name;
            this._currKeyIndices[nodeName] = node._keys.length - 2;
          }
        }
      }
      var offset = delta >= 0 ? 1 : -1;
      var foundKey;
      for (i = 0;i < nodes.length;i++) {
        node = nodes[i];
        nodeName = node._name;
        keys = node._keys;
        interpKey = this._interpolatedKeyDict[nodeName];
        foundKey = false;
        if (keys.length !== 1) {
          for (var currKeyIndex = this._currKeyIndices[nodeName];currKeyIndex < keys.length - 1 && currKeyIndex >= 0;currKeyIndex += offset) {
            k1 = keys[currKeyIndex];
            k2 = keys[currKeyIndex + 1];
            if (k1.time <= this._time && k2.time >= this._time) {
              alpha = (this._time - k1.time) / (k2.time - k1.time);
              interpKey._pos.lerp(k1.position, k2.position, alpha);
              interpKey._quat.slerp(k1.rotation, k2.rotation, alpha);
              interpKey._scale.lerp(k1.scale, k2.scale, alpha);
              interpKey._written = true;
              this._currKeyIndices[nodeName] = currKeyIndex;
              foundKey = true;
              break;
            }
          }
        }
        if (keys.length === 1 || !foundKey && this._time === 0.0 && this.looping) {
          interpKey._pos.copy(keys[0].position);
          interpKey._quat.copy(keys[0].rotation);
          interpKey._scale.copy(keys[0].scale);
          interpKey._written = true;
        }
      }
    }
  };
  Skeleton.prototype.blend = function(skel1, skel2, alpha) {
    var numNodes = this._interpolatedKeys.length;
    for (var i = 0;i < numNodes;i++) {
      var key1 = skel1._interpolatedKeys[i];
      var key2 = skel2._interpolatedKeys[i];
      var dstKey = this._interpolatedKeys[i];
      if (key1._written && key2._written) {
        dstKey._quat.slerp(key1._quat, skel2._interpolatedKeys[i]._quat, alpha);
        dstKey._pos.lerp(key1._pos, skel2._interpolatedKeys[i]._pos, alpha);
        dstKey._scale.lerp(key1._scale, key2._scale, alpha);
        dstKey._written = true;
      } else {
        if (key1._written) {
          dstKey._quat.copy(key1._quat);
          dstKey._pos.copy(key1._pos);
          dstKey._scale.copy(key1._scale);
          dstKey._written = true;
        } else {
          if (key2._written) {
            dstKey._quat.copy(key2._quat);
            dstKey._pos.copy(key2._pos);
            dstKey._scale.copy(key2._scale);
            dstKey._written = true;
          }
        }
      }
    }
  };
  Object.defineProperty(Skeleton.prototype, "animation", {get:function() {
    return this._animation;
  }, set:function(value) {
    this._animation = value;
    this.currentTime = 0;
  }});
  Skeleton.prototype.getAnimation = function() {
    return this._animation;
  };
  Object.defineProperty(Skeleton.prototype, "currentTime", {get:function() {
    return this._time;
  }, set:function(value) {
    this._time = value;
    var numNodes = this._interpolatedKeys.length;
    for (var i = 0;i < numNodes;i++) {
      var node = this._interpolatedKeys[i];
      var nodeName = node._name;
      this._currKeyIndices[nodeName] = 0;
    }
    this.addTime(0);
    this.updateGraph();
  }});
  Skeleton.prototype.getCurrentTime = function() {
    return this._time;
  };
  Skeleton.prototype.setCurrentTime = function(time) {
    this.currentTime = time;
  };
  Object.defineProperty(Skeleton.prototype, "numNodes", {get:function() {
    return this._interpolatedKeys.length;
  }});
  Skeleton.prototype.getNumNodes = function() {
    return this._interpolatedKeys.length;
  };
  Skeleton.prototype.setAnimation = function(animation) {
    this.animation = animation;
  };
  Skeleton.prototype.setGraph = function(graph) {
    var i;
    this.graph = graph;
    if (graph) {
      for (i = 0;i < this._interpolatedKeys.length;i++) {
        var interpKey = this._interpolatedKeys[i];
        var graphNode = graph.findByName(interpKey._name);
        this._interpolatedKeys[i].setTarget(graphNode);
      }
    } else {
      for (i = 0;i < this._interpolatedKeys.length;i++) {
        this._interpolatedKeys[i].setTarget(null);
      }
    }
  };
  Skeleton.prototype.updateGraph = function() {
    if (this.graph) {
      for (var i = 0;i < this._interpolatedKeys.length;i++) {
        var interpKey = this._interpolatedKeys[i];
        if (interpKey._written) {
          var transform = interpKey.getTarget();
          transform.localPosition.copy(interpKey._pos);
          transform.localRotation.copy(interpKey._quat);
          transform.localScale.copy(interpKey._scale);
          if (!transform._dirtyLocal) {
            transform._dirtify(true);
          }
          interpKey._written = false;
        }
      }
    }
  };
  Skeleton.prototype.setLooping = function(looping) {
    this.looping = looping;
  };
  Skeleton.prototype.getLooping = function() {
    return this.looping;
  };
  return {Skeleton:Skeleton};
}());
pc.extend(pc, function() {
  function hasAudio() {
    return typeof Audio !== "undefined";
  }
  function hasAudioContext() {
    return !!(typeof AudioContext !== "undefined" || typeof webkitAudioContext !== "undefined");
  }
  var SoundManager = function(options) {
    if (hasAudioContext() || options.forceWebAudioApi) {
      if (typeof AudioContext !== "undefined") {
        this.context = new AudioContext;
      } else {
        if (typeof webkitAudioContext !== "undefined") {
          this.context = new webkitAudioContext;
        }
      }
      if (this.context) {
        var context = this.context;
        if (pc.platform.ios) {
          var unlock = function() {
            var buffer = context.createBuffer(1, 1, 44100);
            var source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);
            source.disconnect();
            window.removeEventListener("touchend", unlock);
          };
          window.addEventListener("touchend", unlock);
        }
      }
    } else {
      console.warn("No support for 3D audio found");
    }
    if (!hasAudio()) {
      console.warn("No support for 2D audio found");
    }
    this.listener = new pc.Listener(this);
    this._volume = 1;
    this.suspended = false;
    pc.events.attach(this);
  };
  SoundManager.hasAudio = hasAudio;
  SoundManager.hasAudioContext = hasAudioContext;
  SoundManager.prototype = {suspend:function() {
    this.suspended = true;
    this.fire("suspend");
  }, resume:function() {
    this.suspended = false;
    this.fire("resume");
  }, destroy:function() {
    this.fire("destroy");
    if (this.context && this.context.close) {
      this.context.close();
      this.context = null;
    }
  }, getListener:function() {
    console.warn('DEPRECATED: getListener is deprecated. Get the "listener" field instead.');
    return this.listener;
  }, getVolume:function() {
    console.warn('DEPRECATED: getVolume is deprecated. Get the "volume" property instead.');
    return this.volume;
  }, setVolume:function(volume) {
    console.warn('DEPRECATED: setVolume is deprecated. Set the "volume" property instead.');
    this.volume = volume;
  }, playSound:function(sound, options) {
    options = options || {};
    var channel = null;
    if (pc.Channel) {
      channel = new pc.Channel(this, sound, options);
      channel.play();
    }
    return channel;
  }, playSound3d:function(sound, position, options) {
    options = options || {};
    var channel = null;
    if (pc.Channel3d) {
      channel = new pc.Channel3d(this, sound, options);
      channel.setPosition(position);
      if (options.volume) {
        channel.setVolume(options.volume);
      }
      if (options.loop) {
        channel.setLoop(options.loop);
      }
      if (options.maxDistance) {
        channel.setMaxDistance(options.maxDistance);
      }
      if (options.minDistance) {
        channel.setMinDistance(options.minDistance);
      }
      if (options.rollOffFactor) {
        channel.setRollOffFactor(options.rollOffFactor);
      }
      if (options.distanceModel) {
        channel.setDistanceModel(options.distanceModel);
      }
      channel.play();
    }
    return channel;
  }};
  Object.defineProperty(SoundManager.prototype, "volume", {get:function() {
    return this._volume;
  }, set:function(volume) {
    volume = pc.math.clamp(volume, 0, 1);
    this._volume = volume;
    this.fire("volumechange", volume);
  }});
  pc.AudioManager = SoundManager;
  return {SoundManager:SoundManager};
}());
pc.extend(pc, function() {
  var Sound = function(resource) {
    if (resource instanceof Audio) {
      this.audio = resource;
    } else {
      this.buffer = resource;
    }
  };
  Object.defineProperty(Sound.prototype, "duration", {get:function() {
    var duration = 0;
    if (this.buffer) {
      duration = this.buffer.duration;
    } else {
      if (this.audio) {
        duration = this.audio.duration;
      }
    }
    return duration || 0;
  }});
  return {Sound:Sound};
}());
pc.extend(pc, function() {
  var Listener = function(manager) {
    this.position = new pc.Vec3;
    this.velocity = new pc.Vec3;
    this.orientation = new pc.Mat4;
    if (pc.AudioManager.hasAudioContext()) {
      this.listener = manager.context.listener;
    }
  };
  Listener.prototype = {getPosition:function() {
    return this.position;
  }, setPosition:function(position) {
    this.position.copy(position);
    if (this.listener) {
      this.listener.setPosition(position.x, position.y, position.z);
    }
  }, getVelocity:function() {
    return this.velocity;
  }, setVelocity:function(velocity) {
    this.velocity.copy(velocity);
    if (this.listener) {
      this.listener.setPosition(velocity.x, velocity.y, velocity.z);
    }
  }, setOrientation:function(orientation) {
    this.orientation.copy(orientation);
    if (this.listener) {
      this.listener.setOrientation(-orientation.data[8], -orientation.data[9], -orientation.data[10], orientation.data[4], orientation.data[5], orientation.data[6]);
    }
  }, getOrientation:function() {
    return this.orientation;
  }};
  return {Listener:Listener};
}());
pc.extend(pc, function() {
  var SoundInstance;
  var STATE_PLAYING = 0;
  var STATE_PAUSED = 1;
  var STATE_STOPPED = 2;
  var capTime = function(time, duration) {
    return time % duration || 0;
  };
  if (pc.SoundManager.hasAudioContext()) {
    SoundInstance = function(manager, sound, options) {
      pc.events.attach(this);
      options = options || {};
      this._volume = options.volume !== undefined ? pc.math.clamp(Number(options.volume) || 0, 0, 1) : 1;
      this._pitch = options.pitch !== undefined ? Math.max(0.01, Number(options.pitch) || 0) : 1;
      this._loop = !!(options.loop !== undefined ? options.loop : false);
      this._sound = sound;
      this._state = STATE_STOPPED;
      this._suspended = false;
      this._suspendEndEvent = false;
      this._suspendInstanceEvents = false;
      this._startTime = Math.max(0, Number(options.startTime) || 0);
      this._duration = Math.max(0, Number(options.duration) || 0);
      this._startedAt = 0;
      this._startOffset = null;
      this._currentTime = 0;
      this._currentOffset = 0;
      this._playWhenLoaded = true;
      this._manager = manager;
      this._inputNode = null;
      this._connectorNode = null;
      this._firstNode = null;
      this._lastNode = null;
      this._initializeNodes();
      this._onPlayCallback = options.onPlay;
      this._onPauseCallback = options.onPause;
      this._onResumeCallback = options.onResume;
      this._onStopCallback = options.onStop;
      this._onEndCallback = options.onEnd;
      this._endedHandler = this._onEnded.bind(this);
      this.source = null;
    };
    SoundInstance.prototype = {_initializeNodes:function() {
      this.gain = this._manager.context.createGain();
      this._inputNode = this.gain;
      this._connectorNode = this.gain;
      this._connectorNode.connect(this._manager.context.destination);
    }, play:function() {
      if (this._state !== STATE_STOPPED) {
        this.stop();
      }
      if (!this.source) {
        this._createSource();
      }
      var offset = capTime(this._startOffset, this.duration);
      offset = capTime(this._startTime + offset, this._sound.duration);
      this._startOffset = null;
      if (this._duration) {
        this.source.start(0, offset, this._duration);
      } else {
        this.source.start(0, offset);
      }
      this._startedAt = this._manager.context.currentTime;
      this._currentTime = 0;
      this._currentOffset = offset;
      this._state = STATE_PLAYING;
      this._playWhenLoaded = false;
      this.volume = this._volume;
      this.loop = this._loop;
      this.pitch = this._pitch;
      this._manager.on("volumechange", this._onManagerVolumeChange, this);
      this._manager.on("suspend", this._onManagerSuspend, this);
      this._manager.on("resume", this._onManagerResume, this);
      this._manager.on("destroy", this._onManagerDestroy, this);
      if (this._manager.suspended) {
        this._onManagerSuspend();
      }
      if (!this._suspendInstanceEvents) {
        this._onPlay();
      }
      return true;
    }, pause:function() {
      if (this._state !== STATE_PLAYING || !this.source) {
        return false;
      }
      this._updateCurrentTime();
      this._state = STATE_PAUSED;
      this._suspendEndEvent = true;
      this.source.stop(0);
      this.source = null;
      this._playWhenLoaded = false;
      this._startOffset = null;
      if (!this._suspendInstanceEvents) {
        this._onPause();
      }
      return true;
    }, resume:function() {
      if (this._state !== STATE_PAUSED) {
        return false;
      }
      if (!this.source) {
        this._createSource();
      }
      var offset = this.currentTime;
      if (this._startOffset !== null) {
        offset = capTime(this._startOffset, this.duration);
        offset = capTime(this._startTime + offset, this._sound.duration);
        this._startOffset = null;
      }
      if (this._duration) {
        this.source.start(0, offset, this._duration);
      } else {
        this.source.start(0, offset);
      }
      this._state = STATE_PLAYING;
      this._startedAt = this._manager.context.currentTime;
      this._currentOffset = offset;
      this.volume = this._volume;
      this.loop = this._loop;
      this.pitch = this._pitch;
      this._playWhenLoaded = false;
      if (!this._suspendInstanceEvents) {
        this._onResume();
      }
      return true;
    }, stop:function() {
      if (this._state === STATE_STOPPED || !this.source) {
        return false;
      }
      this._manager.off("volumechange", this._onManagerVolumeChange, this);
      this._manager.off("suspend", this._onManagerSuspend, this);
      this._manager.off("resume", this._onManagerResume, this);
      this._manager.off("destroy", this._onManagerDestroy, this);
      this._startedAt = 0;
      this._currentTime = 0;
      this._currentOffset = 0;
      this._startOffset = null;
      this._playWhenLoaded = false;
      this._suspendEndEvent = true;
      if (this._state === STATE_PLAYING) {
        this.source.stop(0);
      }
      this.source = null;
      this._state = STATE_STOPPED;
      if (!this._suspendInstanceEvents) {
        this._onStop();
      }
      return true;
    }, setExternalNodes:function(firstNode, lastNode) {
      if (!firstNode) {
        console.error("The firstNode must be a valid Audio Node");
        return;
      }
      if (!lastNode) {
        lastNode = firstNode;
      }
      var speakers = this._manager.context.destination;
      if (this._firstNode !== firstNode) {
        if (this._firstNode) {
          this._connectorNode.disconnect(this._firstNode);
        } else {
          this._connectorNode.disconnect(speakers);
        }
        this._firstNode = firstNode;
        this._connectorNode.connect(firstNode);
      }
      if (this._lastNode !== lastNode) {
        if (this._lastNode) {
          this._lastNode.disconnect(speakers);
        }
        this._lastNode = lastNode;
        this._lastNode.connect(speakers);
      }
    }, clearExternalNodes:function() {
      var speakers = this._manager.context.destination;
      if (this._firstNode) {
        this._connectorNode.disconnect(this._firstNode);
        this._firstNode = null;
      }
      if (this._lastNode) {
        this._lastNode.disconnect(speakers);
        this._lastNode = null;
      }
      this._connectorNode.connect(speakers);
    }, getExternalNodes:function() {
      return [this._firstNode, this._lastNode];
    }, _createSource:function() {
      if (!this._sound) {
        return null;
      }
      var context = this._manager.context;
      if (this._sound.buffer) {
        this.source = context.createBufferSource();
        this.source.buffer = this._sound.buffer;
        this.source.connect(this._inputNode);
        this.source.onended = this._endedHandler;
        this.source.loopStart = capTime(this._startTime, this.source.buffer.duration);
        if (this._duration) {
          this.source.loopEnd = Math.max(this.source.loopStart, capTime(this._startTime + this._duration, this.source.buffer.duration));
        }
      }
      return this.source;
    }, _updateCurrentTime:function() {
      this._currentTime = capTime((this._manager.context.currentTime - this._startedAt) * this.pitch + this._currentOffset, this.duration);
    }, _onManagerDestroy:function() {
      if (this.source && this.isPlaying) {
        this.source.stop(0);
        this.source = null;
      }
    }};
    Object.defineProperty(SoundInstance.prototype, "volume", {get:function() {
      return this._volume;
    }, set:function(volume) {
      volume = pc.math.clamp(volume, 0, 1);
      this._volume = volume;
      if (this.gain) {
        this.gain.gain.value = volume * this._manager.volume;
      }
    }});
    Object.defineProperty(SoundInstance.prototype, "pitch", {get:function() {
      return this._pitch;
    }, set:function(pitch) {
      var old = this._pitch;
      this._currentOffset = this.currentTime;
      this._startedAt = this._manager.context.currentTime;
      this._pitch = Math.max(Number(pitch) || 0, 0.01);
      if (this.source) {
        this.source.playbackRate.value = this._pitch;
      }
    }});
    Object.defineProperty(SoundInstance.prototype, "loop", {get:function() {
      return this._loop;
    }, set:function(loop) {
      this._loop = !!loop;
      if (this.source) {
        this.source.loop = this._loop;
      }
    }});
    Object.defineProperty(SoundInstance.prototype, "sound", {get:function() {
      return this._sound;
    }, set:function(value) {
      this._sound = value;
      if (!this.isStopped) {
        this.stop();
      } else {
        this._createSource();
      }
    }});
    Object.defineProperty(SoundInstance.prototype, "currentTime", {get:function() {
      if (this._startOffset !== null) {
        return this._startOffset;
      }
      if (this.isPaused) {
        return this._currentTime;
      }
      if (this.isStopped || !this.source) {
        return 0;
      }
      this._updateCurrentTime();
      return this._currentTime;
    }, set:function(value) {
      if (value < 0) {
        return;
      }
      if (this.isPlaying) {
        this.stop();
        var suspend = this._suspendInstanceEvents;
        this._suspendInstanceEvents = true;
        this._startOffset = value;
        this.play();
        this._suspendInstanceEvents = suspend;
      } else {
        this._startOffset = value;
        this._currentTime = value;
      }
    }});
  } else {
    if (pc.SoundManager.hasAudio()) {
      SoundInstance = function(manager, resource, options) {
        pc.events.attach(this);
        options = options || {};
        this._volume = options.volume !== undefined ? pc.math.clamp(Number(options.volume) || 0, 0, 1) : 1;
        this._pitch = options.pitch !== undefined ? Math.max(0.01, Number(options.pitch) || 0) : 1;
        this._loop = !!(options.loop !== undefined ? options.loop : false);
        this._sound = resource;
        this._state = STATE_STOPPED;
        this._suspended = false;
        this._suspendEndEvent = false;
        this._suspendInstanceEvents = false;
        this._playWhenLoaded = true;
        this._startTime = Math.max(0, Number(options.startTime) || 0);
        this._duration = Math.max(0, Number(options.duration) || 0);
        this._startOffset = null;
        this._isReady = false;
        this._manager = manager;
        this._loadedMetadataHandler = this._onLoadedMetadata.bind(this);
        this._timeUpdateHandler = this._onTimeUpdate.bind(this);
        this._endedHandler = this._onEnded.bind(this);
        this._onPlayCallback = options.onPlay;
        this._onPauseCallback = options.onPause;
        this._onResumeCallback = options.onResume;
        this._onStopCallback = options.onStop;
        this._onEndCallback = options.onEnd;
        this.source = null;
        this._createSource();
      };
      SoundInstance.prototype = {play:function() {
        if (this._state !== STATE_STOPPED) {
          this.stop();
        }
        if (!this.source) {
          if (!this._createSource()) {
            return false;
          }
        }
        this.volume = this._volume;
        this.pitch = this._pitch;
        this.loop = this._loop;
        this.source.play();
        this._state = STATE_PLAYING;
        this._playWhenLoaded = false;
        this._manager.on("volumechange", this._onManagerVolumeChange, this);
        this._manager.on("suspend", this._onManagerSuspend, this);
        this._manager.on("resume", this._onManagerResume, this);
        this._manager.on("destroy", this._onManagerDestroy, this);
        if (this._manager.suspended) {
          this._onManagerSuspend();
        }
        if (!this._suspendInstanceEvents) {
          this._onPlay();
        }
        return true;
      }, pause:function() {
        if (!this.source || this._state !== STATE_PLAYING) {
          return false;
        }
        this._suspendEndEvent = true;
        this.source.pause();
        this._playWhenLoaded = false;
        this._state = STATE_PAUSED;
        this._startOffset = null;
        if (!this._suspendInstanceEvents) {
          this._onPause();
        }
        return true;
      }, resume:function() {
        if (!this.source || this._state !== STATE_PAUSED) {
          return false;
        }
        this._state = STATE_PLAYING;
        this._playWhenLoaded = false;
        if (this.source.paused) {
          this.source.play();
          if (!this._suspendInstanceEvents) {
            this._onResume();
          }
        }
        return true;
      }, stop:function() {
        if (!this.source || this._state === STATE_STOPPED) {
          return false;
        }
        this._manager.off("volumechange", this._onManagerVolumeChange, this);
        this._manager.off("suspend", this._onManagerSuspend, this);
        this._manager.off("resume", this._onManagerResume, this);
        this._manager.off("destroy", this._onManagerDestroy, this);
        this._suspendEndEvent = true;
        this.source.pause();
        this._playWhenLoaded = false;
        this._state = STATE_STOPPED;
        this._startOffset = null;
        if (!this._suspendInstanceEvents) {
          this._onStop();
        }
        return true;
      }, setExternalNodes:function() {
      }, clearExternalNodes:function() {
      }, getExternalNodes:function() {
        return [null, null];
      }, _onLoadedMetadata:function() {
        this.source.removeEventListener("loadedmetadata", this._loadedMetadataHandler);
        this._isReady = true;
        var offset = capTime(this._startOffset, this.duration);
        offset = capTime(this._startTime + offset, this._sound.duration);
        this._startOffset = null;
        this.source.currentTime = offset;
      }, _createSource:function() {
        if (this._sound && this._sound.audio) {
          this._isReady = false;
          this.source = this._sound.audio.cloneNode(true);
          this.source.addEventListener("loadedmetadata", this._loadedMetadataHandler);
          this.source.addEventListener("timeupdate", this._timeUpdateHandler);
          this.source.onended = this._endedHandler;
        }
        return this.source;
      }, _onTimeUpdate:function() {
        if (!this._duration) {
          return;
        }
        if (this.source.currentTime > capTime(this._startTime + this._duration, this.source.duration)) {
          if (this.loop) {
            this.source.currentTime = capTime(this._startTime, this.source.duration);
          } else {
            this.source.removeEventListener("timeupdate", this._timeUpdateHandler);
            this.source.pause();
            this._onEnded();
          }
        }
      }, _onManagerDestroy:function() {
        if (this.source) {
          this.source.pause();
        }
      }};
      Object.defineProperty(SoundInstance.prototype, "volume", {get:function() {
        return this._volume;
      }, set:function(volume) {
        volume = pc.math.clamp(volume, 0, 1);
        this._volume = volume;
        if (this.source) {
          this.source.volume = volume * this._manager.volume;
        }
      }});
      Object.defineProperty(SoundInstance.prototype, "pitch", {get:function() {
        return this._pitch;
      }, set:function(pitch) {
        this._pitch = Math.max(Number(pitch) || 0, 0.01);
        if (this.source) {
          this.source.playbackRate = this._pitch;
        }
      }});
      Object.defineProperty(SoundInstance.prototype, "loop", {get:function() {
        return this._loop;
      }, set:function(loop) {
        this._loop = !!loop;
        if (this.source) {
          this.source.loop = this._loop;
        }
      }});
      Object.defineProperty(SoundInstance.prototype, "sound", {get:function() {
        return this._sound;
      }, set:function(value) {
        this.stop();
        this._sound = value;
      }});
      Object.defineProperty(SoundInstance.prototype, "currentTime", {get:function() {
        if (this._startOffset !== null) {
          return this._startOffset;
        }
        if (this.isStopped || !this.source) {
          return 0;
        }
        return this.source.currentTime - this._startTime;
      }, set:function(value) {
        if (value < 0) {
          return;
        }
        this._startOffset = value;
        if (this.source && this._isReady) {
          this.source.currentTime = capTime(this._startTime + capTime(value, this.duration), this._sound.duration);
          this._startOffset = null;
        }
      }});
    } else {
      SoundInstance = function() {
      };
    }
  }
  pc.extend(SoundInstance.prototype, {_onPlay:function() {
    this.fire("play");
    if (this._onPlayCallback) {
      this._onPlayCallback(this);
    }
  }, _onPause:function() {
    this.fire("pause");
    if (this._onPauseCallback) {
      this._onPauseCallback(this);
    }
  }, _onResume:function() {
    this.fire("resume");
    if (this._onResumeCallback) {
      this._onResumeCallback(this);
    }
  }, _onStop:function() {
    this.fire("stop");
    if (this._onStopCallback) {
      this._onStopCallback(this);
    }
  }, _onEnded:function() {
    if (this._suspendEndEvent) {
      this._suspendEndEvent = false;
      return;
    }
    this.fire("end");
    if (this._onEndCallback) {
      this._onEndCallback(this);
    }
    this.stop();
  }, _onManagerVolumeChange:function() {
    this.volume = this._volume;
  }, _onManagerSuspend:function() {
    if (this.isPlaying && !this._suspended) {
      this._suspended = true;
      this.pause();
    }
  }, _onManagerResume:function() {
    if (this._suspended) {
      this._suspended = false;
      this.resume();
    }
  }});
  Object.defineProperty(SoundInstance.prototype, "startTime", {get:function() {
    return this._startTime;
  }, set:function(value) {
    this._startTime = Math.max(0, Number(value) || 0);
    var isPlaying = this.isPlaying;
    this.stop();
    if (isPlaying) {
      this.play();
    }
  }});
  Object.defineProperty(SoundInstance.prototype, "duration", {get:function() {
    if (!this._sound) {
      return 0;
    }
    if (this._duration) {
      return capTime(this._duration, this._sound.duration);
    } else {
      return this._sound.duration;
    }
  }, set:function(value) {
    this._duration = Math.max(0, Number(value) || 0);
    var isPlaying = this.isPlaying;
    this.stop();
    if (isPlaying) {
      this.play();
    }
  }});
  Object.defineProperty(SoundInstance.prototype, "isPlaying", {get:function() {
    return this._state === STATE_PLAYING;
  }});
  Object.defineProperty(SoundInstance.prototype, "isPaused", {get:function() {
    return this._state === STATE_PAUSED;
  }});
  Object.defineProperty(SoundInstance.prototype, "isStopped", {get:function() {
    return this._state === STATE_STOPPED;
  }});
  Object.defineProperty(SoundInstance.prototype, "isSuspended", {get:function() {
    return this._suspended;
  }});
  return {SoundInstance:SoundInstance};
}());
pc.extend(pc, function() {
  var MAX_DISTANCE = 10000;
  var SoundInstance3d;
  if (pc.SoundManager.hasAudioContext()) {
    SoundInstance3d = function(manager, sound, options) {
      options = options || {};
      this._position = new pc.Vec3;
      if (options.position) {
        this.position = options.position;
      }
      this._velocity = new pc.Vec3;
      if (options.velocity) {
        this.velocity = options.velocity;
      }
      this.maxDistance = options.maxDistance !== undefined ? Number(options.maxDistance) : MAX_DISTANCE;
      this.refDistance = options.refDistance !== undefined ? Number(options.refDistance) : 1;
      this.rollOffFactor = options.rollOffFactor !== undefined ? Number(options.rollOffFactor) : 1;
      this.distanceModel = options.distanceModel !== undefined ? options.distanceModel : pc.DISTANCE_LINEAR;
    };
    SoundInstance3d = pc.inherits(SoundInstance3d, pc.SoundInstance);
    SoundInstance3d.prototype = pc.extend(SoundInstance3d.prototype, {_initializeNodes:function() {
      this.gain = this._manager.context.createGain();
      this.panner = this._manager.context.createPanner();
      this.panner.connect(this.gain);
      this._inputNode = this.panner;
      this._connectorNode = this.gain;
      this._connectorNode.connect(this._manager.context.destination);
    }});
    Object.defineProperty(SoundInstance3d.prototype, "position", {get:function() {
      return this._position;
    }, set:function(position) {
      this._position.copy(position);
      this.panner.setPosition(position.x, position.y, position.z);
    }});
    Object.defineProperty(SoundInstance3d.prototype, "velocity", {get:function() {
      return this._velocity;
    }, set:function(velocity) {
      this._velocity.copy(velocity);
      this.panner.setVelocity(velocity.x, velocity.y, velocity.z);
    }});
    Object.defineProperty(SoundInstance3d.prototype, "maxDistance", {get:function() {
      return this.panner.maxDistance;
    }, set:function(value) {
      this.panner.maxDistance = value;
    }});
    Object.defineProperty(SoundInstance3d.prototype, "refDistance", {get:function() {
      return this.panner.refDistance;
    }, set:function(value) {
      this.panner.refDistance = value;
    }});
    Object.defineProperty(SoundInstance3d.prototype, "rollOffFactor", {get:function() {
      return this.panner.rolloffFactor;
    }, set:function(value) {
      this.panner.rolloffFactor = value;
    }});
    Object.defineProperty(SoundInstance3d.prototype, "distanceModel", {get:function() {
      return this.panner.distanceModel;
    }, set:function(value) {
      this.panner.distanceModel = value;
    }});
  } else {
    if (pc.SoundManager.hasAudio()) {
      var offset = new pc.Vec3;
      var fallOff = function(posOne, posTwo, refDistance, maxDistance, rollOffFactor, distanceModel) {
        offset = offset.sub2(posOne, posTwo);
        var distance = offset.length();
        if (distance < refDistance) {
          return 1;
        } else {
          if (distance > maxDistance) {
            return 0;
          } else {
            var result = 0;
            if (distanceModel === pc.DISTANCE_LINEAR) {
              result = 1 - rollOffFactor * (distance - refDistance) / (maxDistance - refDistance);
            } else {
              if (distanceModel === pc.DISTANCE_INVERSE) {
                result = refDistance / (refDistance + rollOffFactor * (distance - refDistance));
              } else {
                if (distanceModel === pc.DISTANCE_EXPONENTIAL) {
                  result = Math.pow(distance / refDistance, -rollOffFactor);
                }
              }
            }
            return pc.math.clamp(result, 0, 1);
          }
        }
      };
      SoundInstance3d = function(manager, sound, options) {
        options = options || {};
        this._position = new pc.Vec3;
        if (options.position) {
          this.position = options.position;
        }
        this._velocity = new pc.Vec3;
        if (options.velocity) {
          this.velocity = options.velocity;
        }
        this._maxDistance = options.maxDistance !== undefined ? Number(options.maxDistance) : MAX_DISTANCE;
        this._refDistance = options.refDistance !== undefined ? Number(options.refDistance) : 1;
        this._rollOffFactor = options.rollOffFactor !== undefined ? Number(options.rollOffFactor) : 1;
        this._distanceModel = options.distanceModel !== undefined ? options.distanceModel : pc.DISTANCE_LINEAR;
      };
      SoundInstance3d = pc.inherits(SoundInstance3d, pc.SoundInstance);
      Object.defineProperty(SoundInstance3d.prototype, "position", {get:function() {
        return this._position;
      }, set:function(position) {
        this._position.copy(position);
        if (this.source) {
          var listener = this._manager.listener;
          var lpos = listener.getPosition();
          var factor = fallOff(lpos, this._position, this.refDistance, this.maxDistance, this.rollOffFactor, this.distanceModel);
          var v = this.volume;
          this.source.volume = v * factor * this._manager.volume;
        }
      }});
      Object.defineProperty(SoundInstance3d.prototype, "velocity", {get:function() {
        return this._velocity;
      }, set:function(velocity) {
        this._velocity.copy(velocity);
      }});
      Object.defineProperty(SoundInstance3d.prototype, "maxDistance", {get:function() {
        return this._maxDistance;
      }, set:function(value) {
        this._maxDistance = value;
      }});
      Object.defineProperty(SoundInstance3d.prototype, "refDistance", {get:function() {
        return this._refDistance;
      }, set:function(value) {
        this._refDistance = value;
      }});
      Object.defineProperty(SoundInstance3d.prototype, "rollOffFactor", {get:function() {
        return this._rollOffFactor;
      }, set:function(value) {
        this._rollOffFactor = value;
      }});
      Object.defineProperty(SoundInstance3d.prototype, "distanceModel", {get:function() {
        return this._distanceModel;
      }, set:function(value) {
        this._distanceModel = value;
      }});
    } else {
      SoundInstance3d = function() {
      };
    }
  }
  return {SoundInstance3d:SoundInstance3d};
}());
pc.extend(pc, function() {
  var Channel;
  if (pc.AudioManager.hasAudioContext()) {
    Channel = function(manager, sound, options) {
      options = options || {};
      this.volume = options.volume === undefined ? 1 : options.volume;
      this.loop = options.loop === undefined ? false : options.loop;
      this.pitch = options.pitch === undefined ? 1 : options.pitch;
      this.sound = sound;
      this.paused = false;
      this.suspended = false;
      this.startTime = 0;
      this.startOffset = 0;
      this.manager = manager;
      this.source = null;
      var context = manager.context;
      this.gain = context.createGain();
    };
    Channel.prototype = {play:function() {
      if (this.source) {
        throw new Error("Call stop() before calling play()");
      }
      this._createSource();
      if (!this.source) {
        return;
      }
      this.startTime = this.manager.context.currentTime;
      this.source.start(0, this.startOffset % this.source.buffer.duration);
      this.setVolume(this.volume);
      this.setLoop(this.loop);
      this.setPitch(this.pitch);
      this.manager.on("volumechange", this.onManagerVolumeChange, this);
      this.manager.on("suspend", this.onManagerSuspend, this);
      this.manager.on("resume", this.onManagerResume, this);
      if (this.manager.suspended) {
        this.onManagerSuspend();
      }
    }, pause:function() {
      if (this.source) {
        this.paused = true;
        this.startOffset += this.manager.context.currentTime - this.startTime;
        this.source.stop(0);
        this.source = null;
      }
    }, unpause:function() {
      if (this.source || !this.paused) {
        console.warn("Call pause() before unpausing.");
        return;
      }
      this._createSource();
      if (!this.source) {
        return;
      }
      this.startTime = this.manager.context.currentTime;
      this.source.start(0, this.startOffset % this.source.buffer.duration);
      this.setVolume(this.volume);
      this.setLoop(this.loop);
      this.setPitch(this.pitch);
      this.paused = false;
    }, stop:function() {
      if (this.source) {
        this.source.stop(0);
        this.source = null;
      }
      this.manager.off("volumechange", this.onManagerVolumeChange, this);
      this.manager.off("suspend", this.onManagerSuspend, this);
      this.manager.off("resume", this.onManagerResume, this);
    }, setLoop:function(loop) {
      this.loop = loop;
      if (this.source) {
        this.source.loop = loop;
      }
    }, setVolume:function(volume) {
      volume = pc.math.clamp(volume, 0, 1);
      this.volume = volume;
      if (this.gain) {
        this.gain.gain.value = volume * this.manager.volume;
      }
    }, setPitch:function(pitch) {
      this.pitch = pitch;
      if (this.source) {
        this.source.playbackRate.value = pitch;
      }
    }, isPlaying:function() {
      return !this.paused && this.source.playbackState === this.source.PLAYING_STATE;
    }, getDuration:function() {
      if (this.source) {
        return this.source.buffer.duration;
      } else {
        return 0;
      }
    }, _createSource:function() {
      var context = this.manager.context;
      if (this.sound.buffer) {
        this.source = context.createBufferSource();
        this.source.buffer = this.sound.buffer;
        this.source.connect(this.gain);
        this.gain.connect(context.destination);
        if (!this.loop) {
          this.source.onended = this.pause.bind(this);
        }
      }
    }};
  } else {
    if (pc.AudioManager.hasAudio()) {
      Channel = function(manager, sound, options) {
        this.volume = options.volume || 1;
        this.loop = options.loop || false;
        this.sound = sound;
        this.pitch = options.pitch !== undefined ? options.pitch : 1;
        this.paused = false;
        this.suspended = false;
        this.manager = manager;
        if (sound.audio) {
          this.source = sound.audio.cloneNode(false);
          this.source.pause();
        }
      };
      Channel.prototype = {play:function() {
        if (this.source) {
          this.paused = false;
          this.setVolume(this.volume);
          this.setLoop(this.loop);
          this.setPitch(this.pitch);
          this.source.play();
        }
        this.manager.on("volumechange", this.onManagerVolumeChange, this);
        this.manager.on("suspend", this.onManagerSuspend, this);
        this.manager.on("resume", this.onManagerResume, this);
        if (this.manager.suspended) {
          this.onManagerSuspend();
        }
      }, pause:function() {
        if (this.source) {
          this.paused = true;
          this.source.pause();
        }
      }, unpause:function() {
        if (this.source) {
          this.paused = false;
          this.source.play();
        }
      }, stop:function() {
        if (this.source) {
          this.source.pause();
        }
        this.manager.off("volumechange", this.onManagerVolumeChange, this);
        this.manager.off("suspend", this.onManagerSuspend, this);
        this.manager.off("resume", this.onManagerResume, this);
      }, setVolume:function(volume) {
        volume = pc.math.clamp(volume, 0, 1);
        this.volume = volume;
        if (this.source) {
          this.source.volume = volume * this.manager.volume;
        }
      }, setLoop:function(loop) {
        this.loop = loop;
        if (this.source) {
          this.source.loop = loop;
        }
      }, setPitch:function(pitch) {
        this.pitch = pitch;
        if (this.source) {
          this.source.playbackRate = pitch;
        }
      }, getDuration:function() {
        if (this.source) {
          var d = this.source.duration;
          if (d === d) {
            return d;
          }
        }
        return 0;
      }, isPlaying:function() {
        return !this.source.paused;
      }};
    } else {
      Channel = function() {
      };
    }
  }
  pc.extend(Channel.prototype, {getVolume:function() {
    return this.volume;
  }, getLoop:function() {
    return this.loop;
  }, getPitch:function() {
    return this.pitch;
  }, onManagerVolumeChange:function() {
    this.setVolume(this.getVolume());
  }, onManagerSuspend:function() {
    if (this.isPlaying() && !this.suspended) {
      this.suspended = true;
      this.pause();
    }
  }, onManagerResume:function() {
    if (this.suspended) {
      this.suspended = false;
      this.unpause();
    }
  }});
  return {Channel:Channel};
}());
pc.extend(pc, function() {
  var MAX_DISTANCE = 10000;
  var Channel3d;
  if (pc.AudioManager.hasAudioContext()) {
    Channel3d = function(manager, sound, options) {
      this.position = new pc.Vec3;
      this.velocity = new pc.Vec3;
      var context = manager.context;
      this.panner = context.createPanner();
    };
    Channel3d = pc.inherits(Channel3d, pc.Channel);
    Channel3d.prototype = pc.extend(Channel3d.prototype, {getPosition:function() {
      return this.position;
    }, setPosition:function(position) {
      this.position.copy(position);
      this.panner.setPosition(position.x, position.y, position.z);
    }, getVelocity:function() {
      return this.velocity;
    }, setVelocity:function(velocity) {
      this.velocity.copy(velocity);
      this.panner.setVelocity(velocity.x, velocity.y, velocity.z);
    }, getMaxDistance:function() {
      return this.panner.maxDistance;
    }, setMaxDistance:function(max) {
      this.panner.maxDistance = max;
    }, getMinDistance:function() {
      return this.panner.refDistance;
    }, setMinDistance:function(min) {
      this.panner.refDistance = min;
    }, getRollOffFactor:function() {
      return this.panner.rolloffFactor;
    }, setRollOffFactor:function(factor) {
      this.panner.rolloffFactor = factor;
    }, getDistanceModel:function() {
      return this.pannel.distanceModel;
    }, setDistanceModel:function(distanceModel) {
      this.panner.distanceModel = distanceModel;
    }, _createSource:function() {
      var context = this.manager.context;
      this.source = context.createBufferSource();
      this.source.buffer = this.sound.buffer;
      this.source.connect(this.panner);
      this.panner.connect(this.gain);
      this.gain.connect(context.destination);
      if (!this.loop) {
        this.source.onended = this.pause.bind(this);
      }
    }});
  } else {
    if (pc.AudioManager.hasAudio()) {
      var offset = new pc.Vec3;
      var fallOff = function(posOne, posTwo, refDistance, maxDistance, rolloffFactor, distanceModel) {
        offset = offset.sub2(posOne, posTwo);
        var distance = offset.length();
        if (distance < refDistance) {
          return 1;
        } else {
          if (distance > maxDistance) {
            return 0;
          } else {
            var result = 0;
            if (distanceModel === pc.DISTANCE_LINEAR) {
              result = 1 - rolloffFactor * (distance - refDistance) / (maxDistance - refDistance);
            } else {
              if (distanceModel === pc.DISTANCE_INVERSE) {
                result = refDistance / (refDistance + rolloffFactor * (distance - refDistance));
              } else {
                if (distanceModel === pc.DISTANCE_EXPONENTIAL) {
                  result = Math.pow(distance / refDistance, -rolloffFactor);
                }
              }
            }
            return pc.math.clamp(result, 0, 1);
          }
        }
      };
      Channel3d = function(manager, sound) {
        this.position = new pc.Vec3;
        this.velocity = new pc.Vec3;
        this.maxDistance = MAX_DISTANCE;
        this.minDistance = 1;
        this.rollOffFactor = 1;
        this.distanceModel = pc.DISTANCE_INVERSE;
      };
      Channel3d = pc.inherits(Channel3d, pc.Channel);
      Channel3d.prototype = pc.extend(Channel3d.prototype, {getPosition:function() {
        return this.position;
      }, setPosition:function(position) {
        this.position.copy(position);
        if (this.source) {
          var listener = this.manager.listener;
          var lpos = listener.getPosition();
          var factor = fallOff(lpos, this.position, this.minDistance, this.maxDistance, this.rollOffFactor, this.distanceModel);
          var v = this.getVolume();
          this.source.volume = v * factor;
        }
      }, getVelocity:function() {
        return this.velocity;
      }, setVelocity:function(velocity) {
        this.velocity.copy(velocity);
      }, getMaxDistance:function() {
        return this.maxDistance;
      }, setMaxDistance:function(max) {
        this.maxDistance = max;
      }, getMinDistance:function() {
        return this.minDistance;
      }, setMinDistance:function(min) {
        this.minDistance = min;
      }, getRollOffFactor:function() {
        return this.rollOffFactor;
      }, setRollOffFactor:function(factor) {
        this.rollOffFactor = factor;
      }, getDistanceModel:function() {
        return this.distanceModel;
      }, setDistanceModel:function(distanceModel) {
        this.distanceModel = distanceModel;
      }});
    } else {
      Channel3d = function() {
      };
    }
  }
  return {Channel3d:Channel3d};
}());
(function() {
  var enums = {ACTION_MOUSE:"mouse", ACTION_KEYBOARD:"keyboard", ACTION_GAMEPAD:"gamepad", AXIS_MOUSE_X:"mousex", AXIS_MOUSE_Y:"mousey", AXIS_PAD_L_X:"padlx", AXIS_PAD_L_Y:"padly", AXIS_PAD_R_X:"padrx", AXIS_PAD_R_Y:"padry", AXIS_KEY:"key", EVENT_KEYDOWN:"keydown", EVENT_KEYUP:"keyup", EVENT_MOUSEDOWN:"mousedown", EVENT_MOUSEMOVE:"mousemove", EVENT_MOUSEUP:"mouseup", EVENT_MOUSEWHEEL:"mousewheel", EVENT_TOUCHSTART:"touchstart", EVENT_TOUCHEND:"touchend", EVENT_TOUCHMOVE:"touchmove", EVENT_TOUCHCANCEL:"touchcancel",
  KEY_BACKSPACE:8, KEY_TAB:9, KEY_RETURN:13, KEY_ENTER:13, KEY_SHIFT:16, KEY_CONTROL:17, KEY_ALT:18, KEY_PAUSE:19, KEY_CAPS_LOCK:20, KEY_ESCAPE:27, KEY_SPACE:32, KEY_PAGE_UP:33, KEY_PAGE_DOWN:34, KEY_END:35, KEY_HOME:36, KEY_LEFT:37, KEY_UP:38, KEY_RIGHT:39, KEY_DOWN:40, KEY_PRINT_SCREEN:44, KEY_INSERT:45, KEY_DELETE:46, KEY_0:48, KEY_1:49, KEY_2:50, KEY_3:51, KEY_4:52, KEY_5:53, KEY_6:54, KEY_7:55, KEY_8:56, KEY_9:57, KEY_SEMICOLON:59, KEY_EQUAL:61, KEY_A:65, KEY_B:66, KEY_C:67, KEY_D:68, KEY_E:69,
  KEY_F:70, KEY_G:71, KEY_H:72, KEY_I:73, KEY_J:74, KEY_K:75, KEY_L:76, KEY_M:77, KEY_N:78, KEY_O:79, KEY_P:80, KEY_Q:81, KEY_R:82, KEY_S:83, KEY_T:84, KEY_U:85, KEY_V:86, KEY_W:87, KEY_X:88, KEY_Y:89, KEY_Z:90, KEY_WINDOWS:91, KEY_CONTEXT_MENU:93, KEY_NUMPAD_0:96, KEY_NUMPAD_1:97, KEY_NUMPAD_2:98, KEY_NUMPAD_3:99, KEY_NUMPAD_4:100, KEY_NUMPAD_5:101, KEY_NUMPAD_6:102, KEY_NUMPAD_7:103, KEY_NUMPAD_8:104, KEY_NUMPAD_9:105, KEY_MULTIPLY:106, KEY_ADD:107, KEY_SEPARATOR:108, KEY_SUBTRACT:109, KEY_DECIMAL:110,
  KEY_DIVIDE:111, KEY_F1:112, KEY_F2:113, KEY_F3:114, KEY_F4:115, KEY_F5:116, KEY_F6:117, KEY_F7:118, KEY_F8:119, KEY_F9:120, KEY_F10:121, KEY_F11:122, KEY_F12:123, KEY_COMMA:188, KEY_PERIOD:190, KEY_SLASH:191, KEY_OPEN_BRACKET:219, KEY_BACK_SLASH:220, KEY_CLOSE_BRACKET:221, KEY_META:224, MOUSEBUTTON_NONE:-1, MOUSEBUTTON_LEFT:0, MOUSEBUTTON_MIDDLE:1, MOUSEBUTTON_RIGHT:2, PAD_1:0, PAD_2:1, PAD_3:2, PAD_4:3, PAD_FACE_1:0, PAD_FACE_2:1, PAD_FACE_3:2, PAD_FACE_4:3, PAD_L_SHOULDER_1:4, PAD_R_SHOULDER_1:5,
  PAD_L_SHOULDER_2:6, PAD_R_SHOULDER_2:7, PAD_SELECT:8, PAD_START:9, PAD_L_STICK_BUTTON:10, PAD_R_STICK_BUTTON:11, PAD_UP:12, PAD_DOWN:13, PAD_LEFT:14, PAD_RIGHT:15, PAD_VENDOR:16, PAD_L_STICK_X:0, PAD_L_STICK_Y:1, PAD_R_STICK_X:2, PAD_R_STICK_Y:3};
  pc.extend(pc, enums);
  pc.input = {};
  pc.extend(pc.input, enums);
})();
pc.extend(pc, function() {
  var MouseEvent = function(mouse, event) {
    var coords = {x:0, y:0};
    if (event) {
      if (event instanceof MouseEvent) {
        throw Error("Expected MouseEvent");
      }
      coords = mouse._getTargetCoords(event);
    } else {
      event = {};
    }
    if (coords) {
      this.x = coords.x;
      this.y = coords.y;
    } else {
      if (pc.Mouse.isPointerLocked()) {
        this.x = 0;
        this.y = 0;
      } else {
        return;
      }
    }
    if (event.detail) {
      this.wheel = -1 * event.detail;
    } else {
      if (event.wheelDelta) {
        this.wheel = event.wheelDelta / 120;
      } else {
        this.wheel = 0;
      }
    }
    if (pc.Mouse.isPointerLocked()) {
      this.dx = event.movementX || event.webkitMovementX || event.mozMovementX || 0;
      this.dy = event.movementY || event.webkitMovementY || event.mozMovementY || 0;
    } else {
      this.dx = this.x - mouse._lastX;
      this.dy = this.y - mouse._lastY;
    }
    if (event.type === "mousedown" || event.type === "mouseup") {
      this.button = event.button;
    } else {
      this.button = pc.MOUSEBUTTON_NONE;
    }
    this.buttons = mouse._buttons.slice(0);
    this.element = event.target;
    this.ctrlKey = event.ctrlKey || false;
    this.altKey = event.altKey || false;
    this.shiftKey = event.shiftKey || false;
    this.metaKey = event.metaKey || false;
    this.event = event;
  };
  var Mouse = function(element) {
    this._lastX = 0;
    this._lastY = 0;
    this._buttons = [false, false, false];
    this._lastbuttons = [false, false, false];
    this._upHandler = this._handleUp.bind(this);
    this._downHandler = this._handleDown.bind(this);
    this._moveHandler = this._handleMove.bind(this);
    this._wheelHandler = this._handleWheel.bind(this);
    this._contextMenuHandler = function(event) {
      event.preventDefault();
    };
    this._target = null;
    this._attached = false;
    this.attach(element);
    pc.events.attach(this);
  };
  Mouse.isPointerLocked = function() {
    return !!(document.pointerLockElement || document.mozPointerLockElement || document.webkitPointerLockElement);
  };
  Mouse.prototype = {attach:function(element) {
    this._target = element;
    if (this._attached) {
      return;
    }
    this._attached = true;
    window.addEventListener("mouseup", this._upHandler, false);
    window.addEventListener("mousedown", this._downHandler, false);
    window.addEventListener("mousemove", this._moveHandler, false);
    window.addEventListener("mousewheel", this._wheelHandler, false);
    window.addEventListener("DOMMouseScroll", this._wheelHandler, false);
  }, detach:function() {
    if (!this._attached) {
      return;
    }
    this._attached = false;
    window.removeEventListener("mouseup", this._upHandler);
    window.removeEventListener("mousedown", this._downHandler);
    window.removeEventListener("mousemove", this._moveHandler);
    window.removeEventListener("mousewheel", this._wheelHandler);
    window.removeEventListener("DOMMouseScroll", this._wheelHandler);
  }, disableContextMenu:function() {
    if (!this._target) {
      return;
    }
    this._target.addEventListener("contextmenu", this._contextMenuHandler);
  }, enableContextMenu:function() {
    if (!this._target) {
      return;
    }
    this._target.removeEventListener("contextmenu", this._contextMenuHandler);
  }, enablePointerLock:function(success, error) {
    if (!document.body.requestPointerLock) {
      if (error) {
        error();
      }
      return;
    }
    var s = function() {
      success();
      document.removeEventListener("pointerlockchange", s);
    };
    var e = function() {
      error();
      document.removeEventListener("pointerlockerror", e);
    };
    if (success) {
      document.addEventListener("pointerlockchange", s, false);
    }
    if (error) {
      document.addEventListener("pointerlockerror", e, false);
    }
    document.body.requestPointerLock();
  }, disablePointerLock:function(success) {
    if (!document.exitPointerLock) {
      return;
    }
    var s = function() {
      success();
      document.removeEventListener("pointerlockchange", s);
    };
    if (success) {
      document.addEventListener("pointerlockchange", s, false);
    }
    document.exitPointerLock();
  }, update:function(dt) {
    this._lastbuttons[0] = this._buttons[0];
    this._lastbuttons[1] = this._buttons[1];
    this._lastbuttons[2] = this._buttons[2];
  }, isPressed:function(button) {
    return this._buttons[button];
  }, wasPressed:function(button) {
    return this._buttons[button] && !this._lastbuttons[button];
  }, wasReleased:function(button) {
    return !this._buttons[button] && this._lastbuttons[button];
  }, _handleUp:function(event) {
    this._buttons[event.button] = false;
    var e = new MouseEvent(this, event);
    if (!e.event) {
      return;
    }
    this.fire(pc.EVENT_MOUSEUP, e);
  }, _handleDown:function(event) {
    this._buttons[event.button] = true;
    var e = new MouseEvent(this, event);
    if (!e.event) {
      return;
    }
    this.fire(pc.EVENT_MOUSEDOWN, e);
  }, _handleMove:function(event) {
    var e = new MouseEvent(this, event);
    if (!e.event) {
      return;
    }
    this.fire(pc.EVENT_MOUSEMOVE, e);
    this._lastX = e.x;
    this._lastY = e.y;
  }, _handleWheel:function(event) {
    var e = new MouseEvent(this, event);
    if (!e.event) {
      return;
    }
    this.fire(pc.EVENT_MOUSEWHEEL, e);
  }, _getTargetCoords:function(event) {
    var rect = this._target.getBoundingClientRect();
    var left = Math.floor(rect.left);
    var top = Math.floor(rect.top);
    if (event.clientX < left || event.clientX >= left + this._target.clientWidth || event.clientY < top || event.clientY >= top + this._target.clientHeight) {
      return null;
    }
    return {x:event.clientX - left, y:event.clientY - top};
  }};
  (function() {
    if (typeof navigator === "undefined" || typeof document === "undefined") {
      return;
    }
    navigator.pointer = navigator.pointer || navigator.webkitPointer || navigator.mozPointer;
    var pointerlockchange = function() {
      var e = document.createEvent("CustomEvent");
      e.initCustomEvent("pointerlockchange", true, false, null);
      document.dispatchEvent(e);
    };
    var pointerlockerror = function() {
      var e = document.createEvent("CustomEvent");
      e.initCustomEvent("pointerlockerror", true, false, null);
      document.dispatchEvent(e);
    };
    document.addEventListener("webkitpointerlockchange", pointerlockchange, false);
    document.addEventListener("webkitpointerlocklost", pointerlockchange, false);
    document.addEventListener("mozpointerlockchange", pointerlockchange, false);
    document.addEventListener("mozpointerlocklost", pointerlockchange, false);
    document.addEventListener("webkitpointerlockerror", pointerlockerror, false);
    document.addEventListener("mozpointerlockerror", pointerlockerror, false);
    if (Element.prototype.mozRequestPointerLock) {
      Element.prototype.requestPointerLock = function() {
        this.mozRequestPointerLock();
      };
    } else {
      Element.prototype.requestPointerLock = Element.prototype.requestPointerLock || Element.prototype.webkitRequestPointerLock || Element.prototype.mozRequestPointerLock;
    }
    if (!Element.prototype.requestPointerLock && navigator.pointer) {
      Element.prototype.requestPointerLock = function() {
        var el = this;
        document.pointerLockElement = el;
        navigator.pointer.lock(el, pointerlockchange, pointerlockerror);
      };
    }
    document.exitPointerLock = document.exitPointerLock || document.webkitExitPointerLock || document.mozExitPointerLock;
    if (!document.exitPointerLock) {
      document.exitPointerLock = function() {
        if (navigator.pointer) {
          document.pointerLockElement = null;
          navigator.pointer.unlock();
        }
      };
    }
  })();
  return {Mouse:Mouse, MouseEvent:MouseEvent};
}());
pc.extend(pc, function() {
  var KeyboardEvent = function(keyboard, event) {
    if (event) {
      this.key = event.keyCode;
      this.element = event.target;
      this.event = event;
    } else {
      this.key = null;
      this.element = null;
      this.event = null;
    }
  };
  var _keyboardEvent = new KeyboardEvent;
  function makeKeyboardEvent(event) {
    _keyboardEvent.key = event.keyCode;
    _keyboardEvent.element = event.target;
    _keyboardEvent.event = event;
    return _keyboardEvent;
  }
  function toKeyCode(s) {
    if (typeof s == "string") {
      return s.toUpperCase().charCodeAt(0);
    } else {
      return s;
    }
  }
  var _keyCodeToKeyIdentifier = {9:"Tab", 13:"Enter", 16:"Shift", 17:"Control", 18:"Alt", 27:"Escape", 37:"Left", 38:"Up", 39:"Right", 40:"Down", 46:"Delete", 91:"Win"};
  var Keyboard = function(element, options) {
    options = options || {};
    this._element = null;
    this._keyDownHandler = this._handleKeyDown.bind(this);
    this._keyUpHandler = this._handleKeyUp.bind(this);
    this._keyPressHandler = this._handleKeyPress.bind(this);
    pc.events.attach(this);
    this._keymap = {};
    this._lastmap = {};
    if (element) {
      this.attach(element);
    }
    this.preventDefault = options.preventDefault || false;
    this.stopPropagation = options.stopPropagation || false;
  };
  Keyboard.prototype.attach = function(element) {
    if (this._element) {
      this.detach();
    }
    this._element = element;
    this._element.addEventListener("keydown", this._keyDownHandler, false);
    this._element.addEventListener("keypress", this._keyPressHandler, false);
    this._element.addEventListener("keyup", this._keyUpHandler, false);
  };
  Keyboard.prototype.detach = function() {
    this._element.removeEventListener("keydown", this._keyDownHandler);
    this._element.removeEventListener("keypress", this._keyPressHandler);
    this._element.removeEventListener("keyup", this._keyUpHandler);
    this._element = null;
  };
  Keyboard.prototype.toKeyIdentifier = function(keyCode) {
    keyCode = toKeyCode(keyCode);
    var count;
    var hex;
    var length;
    var id = _keyCodeToKeyIdentifier[keyCode.toString()];
    if (id) {
      return id;
    }
    hex = keyCode.toString(16).toUpperCase();
    length = hex.length;
    for (count = 0;count < 4 - length;count++) {
      hex = "0" + hex;
    }
    return "U+" + hex;
  };
  Keyboard.prototype._handleKeyDown = function(event) {
    var code = event.keyCode || event.charCode;
    var id = this.toKeyIdentifier(code);
    this._keymap[id] = true;
    this.fire("keydown", makeKeyboardEvent(event));
    if (this.preventDefault) {
      event.preventDefault();
    }
    if (this.stopPropagation) {
      event.stopPropagation();
    }
  };
  Keyboard.prototype._handleKeyUp = function(event) {
    var code = event.keyCode || event.charCode;
    var id = this.toKeyIdentifier(code);
    delete this._keymap[id];
    this.fire("keyup", makeKeyboardEvent(event));
    if (this.preventDefault) {
      event.preventDefault();
    }
    if (this.stopPropagation) {
      event.stopPropagation();
    }
  };
  Keyboard.prototype._handleKeyPress = function(event) {
    var code = event.keyCode || event.charCode;
    var id = this.toKeyIdentifier(code);
    this.fire("keypress", makeKeyboardEvent(event));
    if (this.preventDefault) {
      event.preventDefault();
    }
    if (this.stopPropagation) {
      event.stopPropagation();
    }
  };
  Keyboard.prototype.update = function(dt) {
    var prop;
    for (prop in this._lastmap) {
      delete this._lastmap[prop];
    }
    for (prop in this._keymap) {
      if (this._keymap.hasOwnProperty(prop)) {
        this._lastmap[prop] = this._keymap[prop];
      }
    }
  };
  Keyboard.prototype.isPressed = function(key) {
    var keyCode = toKeyCode(key);
    var id = this.toKeyIdentifier(keyCode);
    return !!this._keymap[id];
  };
  Keyboard.prototype.wasPressed = function(key) {
    var keyCode = toKeyCode(key);
    var id = this.toKeyIdentifier(keyCode);
    return !!this._keymap[id] && !!!this._lastmap[id];
  };
  Keyboard.prototype.wasReleased = function(key) {
    var keyCode = toKeyCode(key);
    var id = this.toKeyIdentifier(keyCode);
    return !!!this._keymap[id] && !!this._lastmap[id];
  };
  return {Keyboard:Keyboard};
}());
pc.extend(pc, function() {
  var GamePads = function() {
    this.gamepadsSupported = !!navigator.getGamepads || !!navigator.webkitGetGamepads;
    this.current = [];
    this.previous = [];
    this.deadZone = 0.25;
  };
  var MAPS = {DEFAULT:{buttons:["PAD_FACE_1", "PAD_FACE_2", "PAD_FACE_3", "PAD_FACE_4", "PAD_L_SHOULDER_1", "PAD_R_SHOULDER_1", "PAD_L_SHOULDER_2", "PAD_R_SHOULDER_2", "PAD_SELECT", "PAD_START", "PAD_L_STICK_BUTTON", "PAD_R_STICK_BUTTON", "PAD_UP", "PAD_DOWN", "PAD_LEFT", "PAD_RIGHT", "PAD_VENDOR"], axes:["PAD_L_STICK_X", "PAD_L_STICK_Y", "PAD_R_STICK_X", "PAD_R_STICK_Y"]}, PS3:{buttons:["PAD_FACE_1", "PAD_FACE_2", "PAD_FACE_4", "PAD_FACE_3", "PAD_L_SHOULDER_1", "PAD_R_SHOULDER_1", "PAD_L_SHOULDER_2",
  "PAD_R_SHOULDER_2", "PAD_SELECT", "PAD_START", "PAD_L_STICK_BUTTON", "PAD_R_STICK_BUTTON", "PAD_UP", "PAD_DOWN", "PAD_LEFT", "PAD_RIGHT", "PAD_VENDOR"], axes:["PAD_L_STICK_X", "PAD_L_STICK_Y", "PAD_R_STICK_X", "PAD_R_STICK_Y"]}};
  var PRODUCT_CODES = {"Product: 0268":"PS3"};
  GamePads.prototype = {update:function(dt) {
    var i, j, l;
    var buttons, buttonsLen;
    for (i = 0, l = this.current.length;i < l;i++) {
      buttons = this.current[i].pad.buttons;
      buttonsLen = buttons.length;
      for (j = 0;j < buttonsLen;j++) {
        if (this.previous[i] === undefined) {
          this.previous[i] = [];
        }
        this.previous[i][j] = buttons[j].pressed;
      }
    }
    var pads = this.poll();
    for (i = 0, l = pads.length;i < l;i++) {
      this.current[i] = pads[i];
    }
  }, poll:function() {
    var pads = [];
    if (this.gamepadsSupported) {
      var padDevices = navigator.getGamepads ? navigator.getGamepads() : navigator.webkitGetGamepads();
      var i, len = padDevices.length;
      for (i = 0;i < len;i++) {
        if (padDevices[i]) {
          pads.push({map:this.getMap(padDevices[i]), pad:padDevices[i]});
        }
      }
    }
    return pads;
  }, getMap:function(pad) {
    for (var code in PRODUCT_CODES) {
      if (pad.id.indexOf(code) >= 0) {
        return MAPS[PRODUCT_CODES[code]];
      }
    }
    return MAPS.DEFAULT;
  }, isPressed:function(index, button) {
    if (!this.current[index]) {
      return false;
    }
    var key = this.current[index].map.buttons[button];
    return this.current[index].pad.buttons[pc[key]].pressed;
  }, wasPressed:function(index, button) {
    if (!this.current[index]) {
      return false;
    }
    var key = this.current[index].map.buttons[button];
    var i = pc[key];
    return this.current[index].pad.buttons[i].pressed && !this.previous[index][i];
  }, getAxis:function(index, axes) {
    if (!this.current[index]) {
      return false;
    }
    var key = this.current[index].map.axes[axes];
    var value = this.current[index].pad.axes[pc[key]];
    if (Math.abs(value) < this.deadZone) {
      value = 0;
    }
    return value;
  }};
  return {GamePads:GamePads};
}());
pc.extend(pc, function() {
  var TouchEvent = function(device, event) {
    this.element = event.target;
    this.event = event;
    this.touches = [];
    this.changedTouches = [];
    if (event) {
      var i, l = event.touches.length;
      for (i = 0;i < l;i++) {
        this.touches.push(new Touch(event.touches[i]));
      }
      l = event.changedTouches.length;
      for (i = 0;i < l;i++) {
        this.changedTouches.push(new Touch(event.changedTouches[i]));
      }
    }
  };
  TouchEvent.prototype = {getTouchById:function(id, list) {
    var i, l = list.length;
    for (i = 0;i < l;i++) {
      if (list[i].id === id) {
        return list[i];
      }
    }
    return null;
  }};
  var Touch = function(touch) {
    var coords = pc.getTouchTargetCoords(touch);
    this.id = touch.identifier;
    this.x = coords.x;
    this.y = coords.y;
    this.target = touch.target;
    this.touch = touch;
  };
  var TouchDevice = function(element) {
    this._startHandler = this._handleTouchStart.bind(this);
    this._endHandler = this._handleTouchEnd.bind(this);
    this._moveHandler = this._handleTouchMove.bind(this);
    this._cancelHandler = this._handleTouchCancel.bind(this);
    this.attach(element);
    pc.events.attach(this);
  };
  TouchDevice.prototype = {attach:function(element) {
    if (this._element) {
      this.detach();
    }
    this._element = element;
    this._element.addEventListener("touchstart", this._startHandler, false);
    this._element.addEventListener("touchend", this._endHandler, false);
    this._element.addEventListener("touchmove", this._moveHandler, false);
    this._element.addEventListener("touchcancel", this._cancelHandler, false);
  }, detach:function() {
    if (this._element) {
      this._element.removeEventListener("touchstart", this._startHandler, false);
      this._element.removeEventListener("touchend", this._endHandler, false);
      this._element.removeEventListener("touchmove", this._moveHandler, false);
      this._element.removeEventListener("touchcancel", this._cancelHandler, false);
    }
    this._element = null;
  }, _handleTouchStart:function(e) {
    this.fire("touchstart", new TouchEvent(this, e));
  }, _handleTouchEnd:function(e) {
    this.fire("touchend", new TouchEvent(this, e));
  }, _handleTouchMove:function(e) {
    e.preventDefault();
    this.fire("touchmove", new TouchEvent(this, e));
  }, _handleTouchCancel:function(e) {
    this.fire("touchcancel", new TouchEvent(this, e));
  }};
  return {getTouchTargetCoords:function(touch) {
    var totalOffsetX = 0;
    var totalOffsetY = 0;
    var canvasX = 0;
    var canvasY = 0;
    var target = touch.target;
    while (!(target instanceof HTMLElement)) {
      target = target.parentNode;
    }
    var currentElement = target;
    do {
      totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
      totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
      currentElement = currentElement.offsetParent;
    } while (currentElement);
    return {x:touch.pageX - totalOffsetX, y:touch.pageY - totalOffsetY};
  }, TouchDevice:TouchDevice};
}());
pc.extend(pc, function() {
  var Controller = function(element, options) {
    options = options || {};
    this._keyboard = options.keyboard || null;
    this._mouse = options.mouse || null;
    this._gamepads = options.gamepads || null;
    this._element = null;
    this._actions = {};
    this._axes = {};
    this._axesValues = {};
    if (element) {
      this.attach(element);
    }
  };
  Controller.prototype.attach = function(element) {
    this._element = element;
    if (this._keyboard) {
      this._keyboard.attach(element);
    }
    if (this._mouse) {
      this._mouse.attach(element);
    }
  };
  Controller.prototype.detach = function() {
    if (this._keyboard) {
      this._keyboard.detach();
    }
    if (this._mouse) {
      this._mouse.detach();
    }
    this._element = null;
  };
  Controller.prototype.disableContextMenu = function() {
    if (!this._mouse) {
      this._enableMouse();
    }
    this._mouse.disableContextMenu();
  };
  Controller.prototype.enableContextMenu = function() {
    if (!this._mouse) {
      this._enableMouse();
    }
    this._mouse.enableContextMenu();
  };
  Controller.prototype.update = function(dt) {
    if (this._keyboard) {
      this._keyboard.update(dt);
    }
    if (this._mouse) {
      this._mouse.update(dt);
    }
    if (this._gamepads) {
      this._gamepads.update(dt);
    }
    this._axesValues = {};
    for (var key in this._axes) {
      this._axesValues[key] = [];
    }
  };
  Controller.prototype.registerKeys = function(action, keys) {
    if (!this._keyboard) {
      this._enableKeyboard();
    }
    if (this._actions[action]) {
      throw new Error(pc.string.format("Action: {0} already registered", action));
    }
    if (keys === undefined) {
      throw new Error("Invalid button");
    }
    if (!keys.length) {
      keys = [keys];
    }
    if (this._actions[action]) {
      this._actions[action].push({type:pc.ACTION_KEYBOARD, keys:keys});
    } else {
      this._actions[action] = [{type:pc.ACTION_KEYBOARD, keys:keys}];
    }
  };
  Controller.prototype.registerMouse = function(action, button) {
    if (!this._mouse) {
      this._enableMouse();
    }
    if (button === undefined) {
      throw new Error("Invalid button");
    }
    if (this._actions[action]) {
      this._actions[action].push({type:pc.ACTION_MOUSE, button:button});
    } else {
      this._actions[action] = [{type:pc.ACTION_MOUSE, button:-button}];
    }
  };
  Controller.prototype.registerPadButton = function(action, pad, button) {
    if (button === undefined) {
      throw new Error("Invalid button");
    }
    if (this._actions[action]) {
      this._actions[action].push({type:pc.ACTION_GAMEPAD, button:button, pad:pad});
    } else {
      this._actions[action] = [{type:pc.ACTION_GAMEPAD, button:button, pad:pad}];
    }
  };
  Controller.prototype.registerAxis = function(options) {
    var name = options.name;
    if (!this._axes[name]) {
      this._axes[name] = [];
    }
    var i = this._axes[name].push(name);
    options = options || {};
    options.pad = options.pad || pc.PAD_1;
    var bind = function(controller, source, value, key) {
      switch(source) {
        case "mousex":
          controller._mouse.on(pc.EVENT_MOUSEMOVE, function(e) {
            controller._axesValues[name][i] = e.dx / 10;
          });
          break;
        case "mousey":
          controller._mouse.on(pc.EVENT_MOUSEMOVE, function(e) {
            controller._axesValues[name][i] = e.dy / 10;
          });
          break;
        case "key":
          controller._axes[name].push(function() {
            return controller._keyboard.isPressed(key) ? value : 0;
          });
          break;
        case "padrx":
          controller._axes[name].push(function() {
            return controller._gamepads.getAxis(options.pad, pc.PAD_R_STICK_X);
          });
          break;
        case "padry":
          controller._axes[name].push(function() {
            return controller._gamepads.getAxis(options.pad, pc.PAD_R_STICK_Y);
          });
          break;
        case "padlx":
          controller._axes[name].push(function() {
            return controller._gamepads.getAxis(options.pad, pc.PAD_L_STICK_X);
          });
          break;
        case "padly":
          controller._axes[name].push(function() {
            return controller._gamepads.getAxis(options.pad, pc.PAD_L_STICK_Y);
          });
          break;
        default:
          throw new Error("Unknown axis");
      }
    };
    bind(this, options.positive, 1, options.positiveKey);
    if (options.negativeKey || options.negative !== options.positive) {
      bind(this, options.negative, -1, options.negativeKey);
    }
  };
  Controller.prototype.isPressed = function(actionName) {
    if (!this._actions[actionName]) {
      return false;
    }
    var action;
    var index = 0;
    var length = this._actions[actionName].length;
    for (index = 0;index < length;++index) {
      action = this._actions[actionName][index];
      switch(action.type) {
        case pc.ACTION_KEYBOARD:
          if (this._keyboard) {
            var i, len = action.keys.length;
            for (i = 0;i < len;i++) {
              if (this._keyboard.isPressed(action.keys[i])) {
                return true;
              }
            }
          }
          break;
        case pc.ACTION_MOUSE:
          if (this._mouse && this._mouse.isPressed(action.button)) {
            return true;
          }
          break;
        case pc.ACTION_GAMEPAD:
          if (this._gamepads && this._gamepads.isPressed(action.pad, action.button)) {
            return true;
          }
          break;
      }
    }
    return false;
  };
  Controller.prototype.wasPressed = function(actionName) {
    if (!this._actions[actionName]) {
      return false;
    }
    var index = 0;
    var length = this._actions[actionName].length;
    for (index = 0;index < length;++index) {
      var action = this._actions[actionName][index];
      switch(action.type) {
        case pc.ACTION_KEYBOARD:
          if (this._keyboard) {
            var i, len = action.keys.length;
            for (i = 0;i < len;i++) {
              if (this._keyboard.wasPressed(action.keys[i])) {
                return true;
              }
            }
          }
          break;
        case pc.ACTION_MOUSE:
          if (this._mouse && this._mouse.wasPressed(action.button)) {
            return true;
          }
          break;
        case pc.ACTION_GAMEPAD:
          if (this._gamepads && this._gamepads.wasPressed(action.pad, action.button)) {
            return true;
          }
          break;
      }
    }
    return false;
  };
  Controller.prototype.getAxis = function(name) {
    var value = 0;
    if (this._axes[name]) {
      var i, len = this._axes[name].length;
      for (i = 0;i < len;i++) {
        if (pc.type(this._axes[name][i]) === "function") {
          var v = this._axes[name][i]();
          if (Math.abs(v) > Math.abs(value)) {
            value = v;
          }
        } else {
          if (this._axesValues[name]) {
            if (Math.abs(this._axesValues[name][i]) > Math.abs(value)) {
              value = this._axesValues[name][i];
            }
          }
        }
      }
    }
    return value;
  };
  Controller.prototype._enableMouse = function() {
    this._mouse = new pc.Mouse;
    if (!this._element) {
      throw new Error("Controller must be attached to an Element");
    }
    this._mouse.attach(this._element);
  };
  Controller.prototype._enableKeyboard = function() {
    this._keyboard = new pc.Keyboard;
    if (!this._element) {
      throw new Error("Controller must be attached to an Element");
    }
    this._keyboard.attach(this._element);
  };
  return {Controller:Controller};
}());
pc.extend(pc, function() {
  var targetX, targetY;
  var vecA = new pc.Vec3;
  var vecB = new pc.Vec3;
  var _pq = new pc.Vec3;
  var _pa = new pc.Vec3;
  var _pb = new pc.Vec3;
  var _pc = new pc.Vec3;
  var _pd = new pc.Vec3;
  var _m = new pc.Vec3;
  var _sct = new pc.Vec3;
  var intersectLineQuad = function(p, q, corners) {
    _pq.sub2(q, p);
    _pa.sub2(corners[0], p);
    _pb.sub2(corners[1], p);
    _pc.sub2(corners[2], p);
    _m.cross(_pc, _pq);
    var v = _pa.dot(_m);
    if (v >= 0) {
      if (-_pb.dot(_m) < 0) {
        return false;
      }
      if (scalarTriple(_pq, _pb, _pa) < 0) {
        return false;
      }
    } else {
      _pd.sub2(corners[3], p);
      if (_pd.dot(_m) < 0) {
        return false;
      }
      if (scalarTriple(_pq, _pa, _pd) < 0) {
        return false;
      }
    }
    return true;
  };
  var scalarTriple = function(p1, p2, p3) {
    return _sct.cross(p1, p2).dot(p3);
  };
  var ElementInputEvent = function(event, element) {
    this.event = event;
    this.element = element;
    this._stopPropagation = false;
  };
  ElementInputEvent.prototype = {stopPropagation:function() {
    this._stopPropagation = true;
    this.event.stopImmediatePropagation();
    this.event.stopPropagation();
  }};
  var ElementMouseEvent = function(event, element, x, y, lastX, lastY) {
    this.x = x;
    this.y = y;
    this.ctrlKey = event.ctrlKey || false;
    this.altKey = event.altKey || false;
    this.shiftKey = event.shiftKey || false;
    this.metaKey = event.metaKey || false;
    this.button = event.button;
    if (pc.Mouse.isPointerLocked()) {
      this.dx = event.movementX || event.webkitMovementX || event.mozMovementX || 0;
      this.dy = event.movementY || event.webkitMovementY || event.mozMovementY || 0;
    } else {
      this.dx = x - lastX;
      this.dy = y - lastY;
    }
    if (event.detail) {
      this.wheel = -1 * event.detail;
    } else {
      if (event.wheelDelta) {
        this.wheel = event.wheelDelta / 120;
      } else {
        this.wheel = 0;
      }
    }
  };
  ElementMouseEvent = pc.inherits(ElementMouseEvent, ElementInputEvent);
  var ElementTouchEvent = function(event, element, input) {
    this.touches = event.touches;
    this.changedTouches = event.changedTouches;
  };
  ElementTouchEvent = pc.inherits(ElementTouchEvent, ElementInputEvent);
  var ElementInput = function(domElement) {
    this._app = null;
    this._attached = false;
    this._target = null;
    this._lastX = 0;
    this._lastY = 0;
    this._upHandler = this._handleUp.bind(this);
    this._downHandler = this._handleDown.bind(this);
    this._moveHandler = this._handleMove.bind(this);
    this._wheelHandler = this._handleWheel.bind(this);
    this._touchstartHandler = this._handleTouchStart.bind(this);
    this._touchendHandler = this._handleTouchEnd.bind(this);
    this._touchcancelHandler = this._touchendHandler;
    this._touchmoveHandler = this._handleTouchMove.bind(this);
    this._elements = [];
    this._hoveredElement = null;
    this._pressedElement = null;
    this._touchedElements = {};
    if ("ontouchstart" in window) {
      this._clickedEntities = {};
    }
    this.attach(domElement);
  };
  ElementInput.prototype = {attach:function(domElement) {
    if (this._attached) {
      this._attached = false;
      this.detach();
    }
    this._target = domElement;
    this._attached = true;
    window.addEventListener("mouseup", this._upHandler, {passive:true});
    window.addEventListener("mousedown", this._downHandler, {passive:true});
    window.addEventListener("mousemove", this._moveHandler, {passive:true});
    window.addEventListener("mousewheel", this._wheelHandler, {passive:true});
    window.addEventListener("DOMMouseScroll", this._wheelHandler, {passive:true});
    if ("ontouchstart" in window) {
      this._target.addEventListener("touchstart", this._touchstartHandler, {passive:true});
      this._target.addEventListener("touchend", this._touchendHandler, {passive:true});
      this._target.addEventListener("touchmove", this._touchmoveHandler, false);
      this._target.addEventListener("touchcancel", this._touchcancelHandler, {passive:true});
    }
  }, detach:function() {
    if (!this._attached) {
      return;
    }
    this._attached = false;
    this._target = null;
    window.removeEventListener("mouseup", this._upHandler, false);
    window.removeEventListener("mousedown", this._downHandler, false);
    window.removeEventListener("mousemove", this._moveHandler, false);
    window.removeEventListener("mousewheel", this._wheelHandler, false);
    window.removeEventListener("DOMMouseScroll", this._wheelHandler, false);
    this._target.removeEventListener("touchstart", this._touchstartHandler, false);
    this._target.removeEventListener("touchend", this._touchendHandler, false);
    this._target.removeEventListener("touchmove", this._touchmoveHandler, false);
    this._target.removeEventListener("touchcancel", this._touchcancelHandler, false);
  }, addElement:function(element) {
    if (this._elements.indexOf(element) === -1) {
      this._elements.push(element);
    }
  }, removeElement:function(element) {
    var idx = this._elements.indexOf(element);
    if (idx !== -1) {
      this._elements.splice(idx, 1);
    }
  }, _handleUp:function(event) {
    if (pc.Mouse.isPointerLocked()) {
      return;
    }
    this._calcMouseCoords(event);
    if (targetX === null) {
      return;
    }
    this._onElementMouseEvent(event);
  }, _handleDown:function(event) {
    if (pc.Mouse.isPointerLocked()) {
      return;
    }
    this._calcMouseCoords(event);
    if (targetX === null) {
      return;
    }
    this._onElementMouseEvent(event);
  }, _handleMove:function(event) {
    this._calcMouseCoords(event);
    if (targetX === null) {
      return;
    }
    this._onElementMouseEvent(event);
    this._lastX = targetX;
    this._lastY = targetY;
  }, _handleWheel:function(event) {
    this._calcMouseCoords(event);
    if (targetX === null) {
      return;
    }
    this._onElementMouseEvent(event);
  }, _handleTouchStart:function(event) {
    var cameras = this.app.systems.camera.cameras;
    for (var i = cameras.length - 1;i >= 0;i--) {
      var camera = cameras[i];
      var done = 0;
      for (var j = 0, len = event.changedTouches.length;j < len;j++) {
        if (this._touchedElements[event.changedTouches[j].identifier]) {
          done++;
          continue;
        }
        var coords = this._calcTouchCoords(event.changedTouches[j]);
        var element = this._getTargetElement(camera, coords.x, coords.y);
        if (element) {
          done++;
          this._touchedElements[event.changedTouches[j].identifier] = element;
          this._fireEvent(event.type, new ElementTouchEvent(event, element, this));
        }
      }
      if (done === len) {
        break;
      }
    }
  }, _handleTouchEnd:function(event) {
    var cameras = this.app.systems.camera.cameras;
    for (var key in this._clickedEntities) {
      delete this._clickedEntities[key];
    }
    for (var i = 0, len = event.changedTouches.length;i < len;i++) {
      var touch = event.changedTouches[i];
      var element = this._touchedElements[touch.identifier];
      if (!element) {
        continue;
      }
      delete this._touchedElements[touch.identifier];
      this._fireEvent(event.type, new ElementTouchEvent(event, element, this));
      if (event.touches.length === 0) {
        var coords = this._calcTouchCoords(touch);
        for (var c = cameras.length - 1;c >= 0;c--) {
          var hovered = this._getTargetElement(cameras[c], coords.x, coords.y);
          if (hovered === element) {
            if (!this._clickedEntities[element.entity.getGuid()]) {
              this._fireEvent("click", new ElementTouchEvent(event, element, this));
              this._clickedEntities[element.entity.getGuid()] = true;
            }
          }
        }
      }
    }
  }, _handleTouchMove:function(event) {
    event.preventDefault();
    for (var i = 0, len = event.changedTouches.length;i < len;i++) {
      var element = this._touchedElements[event.changedTouches[i].identifier];
      if (element) {
        this._fireEvent(event.type, new ElementTouchEvent(event, element, this));
      }
    }
  }, _onElementMouseEvent:function(event) {
    var element;
    var hovered = this._hoveredElement;
    this._hoveredElement = null;
    var cameras = this.app.systems.camera.cameras;
    for (var i = cameras.length - 1;i >= 0;i--) {
      var camera = cameras[i];
      element = this._getTargetElement(camera, targetX, targetY);
      if (element) {
        break;
      }
    }
    if (element) {
      this._fireEvent(event.type, new ElementMouseEvent(event, element, targetX, targetY, this._lastX, this._lastY));
      this._hoveredElement = element;
      if (event.type === pc.EVENT_MOUSEDOWN) {
        this._pressedElement = element;
      }
    }
    if (hovered !== this._hoveredElement) {
      if (hovered) {
        this._fireEvent("mouseleave", new ElementMouseEvent(event, hovered, targetX, targetY, this._lastX, this._lastY));
      }
      if (this._hoveredElement) {
        this._fireEvent("mouseenter", new ElementMouseEvent(event, this._hoveredElement, targetX, targetY, this._lastX, this._lastY));
      }
    }
    if (event.type === pc.EVENT_MOUSEUP && this._pressedElement) {
      if (this._pressedElement === this._hoveredElement) {
        this._pressedElement = null;
        if (!this._clickedEntities || !this._clickedEntities[this._hoveredElement.entity.getGuid()]) {
          this._fireEvent("click", new ElementMouseEvent(event, this._hoveredElement, targetX, targetY, this._lastX, this._lastY));
        }
      } else {
        this._pressedElement = null;
      }
    }
  }, _fireEvent:function(name, evt) {
    var element = evt.element;
    while (true) {
      element.fire(name, evt);
      if (evt._stopPropagation) {
        break;
      }
      if (!element.entity.parent) {
        break;
      }
      element = element.entity.parent.element;
      if (!element) {
        break;
      }
    }
  }, _calcMouseCoords:function(event) {
    var rect = this._target.getBoundingClientRect();
    var left = Math.floor(rect.left);
    var top = Math.floor(rect.top);
    if (event.clientX < left || event.clientX >= left + this._target.clientWidth || event.clientY < top || event.clientY >= top + this._target.clientHeight) {
      targetX = null;
      targetY = null;
    } else {
      targetX = event.clientX - left;
      targetY = event.clientY - top;
    }
  }, _calcTouchCoords:function(touch) {
    var totalOffsetX = 0;
    var totalOffsetY = 0;
    var canvasX = 0;
    var canvasY = 0;
    var target = touch.target;
    while (!(target instanceof HTMLElement)) {
      target = target.parentNode;
    }
    var currentElement = target;
    do {
      totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
      totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
      currentElement = currentElement.offsetParent;
    } while (currentElement);
    return {x:touch.pageX - totalOffsetX, y:touch.pageY - totalOffsetY};
  }, _sortElements:function(a, b) {
    if (a.screen && !b.screen) {
      return -1;
    }
    if (!a.screen && b.screen) {
      return 1;
    }
    if (!a.screen && !b.screen) {
      return 0;
    }
    if (a.screen.screen.screenSpace && !b.screen.screen.screenSpace) {
      return -1;
    }
    if (b.screen.screen.screenSpace && !a.screen.screen.screenSpace) {
      return 1;
    }
    return b.drawOrder - a.drawOrder;
  }, _getTargetElement:function(camera, x, y) {
    var result = null;
    this._elements.sort(this._sortElements);
    for (var i = 0, len = this._elements.length;i < len;i++) {
      var element = this._elements[i];
      if (element.screen && element.screen.screen.screenSpace) {
        if (this._checkElement2d(x, y, element, camera)) {
          result = element;
          break;
        }
      } else {
        if (this._checkElement3d(x, y, element, camera)) {
          result = element;
          break;
        }
      }
    }
    return result;
  }, _checkElement2d:function(x, y, element, camera) {
    var sw = this.app.graphicsDevice.width;
    var sh = this.app.graphicsDevice.height;
    var cameraWidth = camera.rect.z * sw;
    var cameraHeight = camera.rect.w * sh;
    var cameraLeft = camera.rect.x * sw;
    var cameraRight = cameraLeft + cameraWidth;
    var cameraBottom = (1 - camera.rect.y) * sh;
    var cameraTop = cameraBottom - cameraHeight;
    var _x = x * sw / this._target.clientWidth;
    var _y = y * sh / this._target.clientHeight;
    if (_x >= cameraLeft && _x <= cameraRight && _y <= cameraBottom && _y >= cameraTop) {
      _x = sw * (_x - cameraLeft) / cameraWidth;
      _y = sh * (_y - cameraTop) / cameraHeight;
      _y = sh - _y;
      var screenCorners = element.screenCorners;
      vecA.set(_x, _y, 1);
      vecB.set(_x, _y, -1);
      if (intersectLineQuad(vecA, vecB, screenCorners)) {
        return true;
      }
    }
    return false;
  }, _checkElement3d:function(x, y, element, camera) {
    var sw = this._target.clientWidth;
    var sh = this._target.clientHeight;
    var cameraWidth = camera.rect.z * sw;
    var cameraHeight = camera.rect.w * sh;
    var cameraLeft = camera.rect.x * sw;
    var cameraRight = cameraLeft + cameraWidth;
    var cameraBottom = (1 - camera.rect.y) * sh;
    var cameraTop = cameraBottom - cameraHeight;
    var _x = x;
    var _y = y;
    if (x >= cameraLeft && x <= cameraRight && y <= cameraBottom && _y >= cameraTop) {
      _x = sw * (_x - cameraLeft) / cameraWidth;
      _y = sh * (_y - cameraTop) / cameraHeight;
      var worldCorners = element.worldCorners;
      var start = camera.entity.getPosition();
      var end = vecA;
      camera.screenToWorld(_x, _y, camera.farClip, end);
      if (intersectLineQuad(start, end, worldCorners)) {
        return true;
      }
    }
    return false;
  }};
  Object.defineProperty(ElementInput.prototype, "app", {get:function() {
    return this._app || pc.app;
  }, set:function(value) {
    this._app = value;
  }});
  return {ElementInput:ElementInput, ElementInputEvent:ElementInputEvent, ElementMouseEvent:ElementMouseEvent, ElementTouchEvent:ElementTouchEvent};
}());
pc.extend(pc, function() {
  var VrManager = function(app) {
    pc.events.attach(this);
    var self = this;
    this.isSupported = VrManager.isSupported;
    this.usesPolyfill = VrManager.usesPolyfill;
    if (window.InitializeWebVRPolyfill) {
      window.InitializeWebVRPolyfill();
    }
    this._index = {};
    this.displays = [];
    this.display = null;
    this._app = app;
    this._onDisplayConnect = this._onDisplayConnect.bind(this);
    this._onDisplayDisconnect = this._onDisplayDisconnect.bind(this);
    self._attach();
    this._getDisplays(function(err, displays) {
      if (err) {
        self.fire("error", err);
      } else {
        for (var i = 0;i < displays.length;i++) {
          self._addDisplay(displays[i]);
        }
        self.fire("ready", self.displays);
      }
    });
  };
  VrManager.isSupported = !!navigator.getVRDisplays;
  VrManager.usesPolyfill = !!window.InitializeWebVRPolyfill;
  VrManager.prototype = {_attach:function() {
    window.addEventListener("vrdisplayconnect", this._onDisplayConnect);
    window.addEventListener("vrdisplaydisconnect", this._onDisplayDisconnect);
  }, _detach:function() {
    window.removeEventListener("vrdisplayconnect", this._onDisplayConnect);
    window.removeEventListener("vrdisplaydisconnect", this._onDisplayDisconnect);
  }, destroy:function() {
    this._detach();
  }, poll:function() {
    var l = this.displays.length;
    if (!l) {
      return;
    }
    for (var i = 0;i < l;i++) {
      if (this.displays[i]._camera) {
        this.displays[i].poll();
      }
    }
  }, _getDisplays:function(callback) {
    var self = this;
    if (navigator.getVRDisplays) {
      navigator.getVRDisplays().then(function(displays) {
        if (callback) {
          callback(null, displays);
        }
      });
    } else {
      if (callback) {
        callback(new Error("WebVR not supported"));
      }
    }
  }, _addDisplay:function(vrDisplay) {
    if (this._index[vrDisplay.displayId]) {
      return;
    }
    var display = new pc.VrDisplay(this._app, vrDisplay);
    this._index[display.id] = display;
    this.displays.push(display);
    if (!this.display) {
      this.display = display;
    }
    this.fire("displayconnect", display);
  }, _onDisplayConnect:function(e) {
    if (e.detail && e.detail.display) {
      this._addDisplay(e.detail.display);
    } else {
      this._addDisplay(e.display);
    }
  }, _onDisplayDisconnect:function(e) {
    var id;
    if (e.detail && e.detail.display) {
      id = e.detail.display.displayId;
    } else {
      id = e.display.displayId;
    }
    var display = this._index[id];
    if (!display) {
      return;
    }
    display.destroy();
    delete this._index[display.id];
    var ind = this.displays.indexOf(display);
    this.displays.splice(ind, 1);
    if (this.display === display) {
      if (this.displays.length) {
        this.display = this.displays[0];
      } else {
        this.display = null;
      }
    }
    this.fire("displaydisconnect", display);
  }};
  return {VrManager:VrManager};
}());
pc.extend(pc, function() {
  var VrDisplay = function(app, display) {
    var self = this;
    this._app = app;
    this._device = app.graphicsDevice;
    this.id = display.displayId;
    this._frameData = null;
    if (window.VRFrameData) {
      this._frameData = new window.VRFrameData;
    }
    this.display = display;
    this._camera = null;
    this.sitToStandInv = new pc.Mat4;
    this.leftView = new pc.Mat4;
    this.leftProj = new pc.Mat4;
    this.leftViewInv = new pc.Mat4;
    this.leftPos = new pc.Vec3;
    this.rightView = new pc.Mat4;
    this.rightProj = new pc.Mat4;
    this.rightViewInv = new pc.Mat4;
    this.rightPos = new pc.Vec3;
    this.combinedPos = new pc.Vec3;
    this.combinedView = new pc.Mat4;
    this.combinedProj = new pc.Mat4;
    this.combinedViewInv = new pc.Mat4;
    this.combinedFov = 0;
    this.combinedAspect = 0;
    this.presenting = false;
    self._presentChange = function(event) {
      var display;
      if (event.display) {
        display = event.display;
      } else {
        if (event.detail && event.detail.display) {
          display = event.detail.display;
        } else {
          if (event.detail && event.detail.vrdisplay) {
            display = event.detail.vrdisplay;
          } else {
            display = self.display;
          }
        }
      }
      if (display === self.display) {
        self.presenting = self.display && self.display.isPresenting;
        if (self.presenting) {
          var leftEye = self.display.getEyeParameters("left");
          var rightEye = self.display.getEyeParameters("right");
          var w = Math.max(leftEye.renderWidth, rightEye.renderWidth) * 2;
          var h = Math.max(leftEye.renderHeight, rightEye.renderHeight);
          self._app.graphicsDevice.setResolution(w, h);
          self._app._allowResize = false;
        } else {
          self._app.setCanvasResolution(pc.RESOLUTION_AUTO);
          self._app._allowResize = true;
        }
        self.fire("beforepresentchange", self);
        self.fire("presentchange", self);
      }
    };
    window.addEventListener("vrdisplaypresentchange", self._presentChange, false);
    pc.events.attach(this);
  };
  VrDisplay.prototype = {destroy:function() {
    window.removeEventListener("vrdisplaypresentchange", self._presentChange);
    if (this._camera) {
      this._camera.vrDisplay = null;
    }
    this._camera = null;
  }, poll:function() {
    if (this.display) {
      this.display.getFrameData(this._frameData);
      this.leftProj.data = this._frameData.leftProjectionMatrix;
      this.rightProj.data = this._frameData.rightProjectionMatrix;
      var stage = this.display.stageParameters;
      if (stage) {
        this.sitToStandInv.set(stage.sittingToStandingTransform).invert();
        this.combinedView.set(this._frameData.leftViewMatrix);
        this.leftView.mul2(this.combinedView, this.sitToStandInv);
        this.combinedView.set(this._frameData.rightViewMatrix);
        this.rightView.mul2(this.combinedView, this.sitToStandInv);
      } else {
        this.leftView.set(this._frameData.leftViewMatrix);
        this.rightView.set(this._frameData.rightViewMatrix);
      }
      var nx = this.leftProj.data[3] + this.leftProj.data[0];
      var nz = this.leftProj.data[11] + this.leftProj.data[8];
      var l = 1.0 / Math.sqrt(nx * nx + nz * nz);
      nx *= l;
      nz *= l;
      var maxFov = -Math.atan2(nz, nx);
      nx = this.rightProj.data[3] + this.rightProj.data[0];
      nz = this.rightProj.data[11] + this.rightProj.data[8];
      l = 1.0 / Math.sqrt(nx * nx + nz * nz);
      nx *= l;
      nz *= l;
      maxFov = Math.max(maxFov, -Math.atan2(nz, nx));
      maxFov *= 2.0;
      this.combinedFov = maxFov;
      var aspect = this.rightProj.data[5] / this.rightProj.data[0];
      this.combinedAspect = aspect;
      var view = this.combinedView;
      view.copy(this.leftView);
      view.invert();
      this.leftViewInv.copy(view);
      var pos = this.combinedPos.data;
      pos[0] = this.leftPos.data[0] = view.data[12];
      pos[1] = this.leftPos.data[1] = view.data[13];
      pos[2] = this.leftPos.data[2] = view.data[14];
      view.copy(this.rightView);
      view.invert();
      this.rightViewInv.copy(view);
      var deltaX = pos[0] - view.data[12];
      var deltaY = pos[1] - view.data[13];
      var deltaZ = pos[2] - view.data[14];
      var dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
      this.rightPos.data[0] = view.data[12];
      this.rightPos.data[1] = view.data[13];
      this.rightPos.data[2] = view.data[14];
      pos[0] += view.data[12];
      pos[1] += view.data[13];
      pos[2] += view.data[14];
      pos[0] *= 0.5;
      pos[1] *= 0.5;
      pos[2] *= 0.5;
      var b = Math.PI * 0.5;
      var c = maxFov * 0.5;
      var a = Math.PI - (b + c);
      var offset = dist * 0.5 * Math.sin(a);
      var fwdX = view.data[8];
      var fwdY = view.data[9];
      var fwdZ = view.data[10];
      view.data[12] = pos[0] + fwdX * offset;
      view.data[13] = pos[1] + fwdY * offset;
      view.data[14] = pos[2] + fwdZ * offset;
      this.combinedViewInv.copy(view);
      view.invert();
      this.combinedProj.setPerspective(maxFov * pc.math.RAD_TO_DEG, aspect, this.display.depthNear + offset, this.display.depthFar + offset, true);
    }
  }, requestPresent:function(callback) {
    if (!this.display) {
      if (callback) {
        callback(new Error("No VrDisplay to requestPresent"));
      }
      return;
    }
    if (this.presenting) {
      if (callback) {
        callback(new Error("VrDisplay already presenting"));
      }
      return;
    }
    this.display.requestPresent([{source:this._device.canvas}]).then(function() {
      if (callback) {
        callback();
      }
    }, function(err) {
      if (callback) {
        callback(err);
      }
    });
  }, exitPresent:function(callback) {
    if (!this.display) {
      if (callback) {
        callback(new Error("No VrDisplay to exitPresent"));
      }
    }
    if (!this.presenting) {
      if (callback) {
        callback(new Error("VrDisplay not presenting"));
      }
      return;
    }
    this.display.exitPresent().then(function() {
      if (callback) {
        callback();
      }
    }, function() {
      if (callback) {
        callback(new Error("exitPresent failed"));
      }
    });
  }, requestAnimationFrame:function(fn) {
    if (this.display) {
      this.display.requestAnimationFrame(fn);
    }
  }, submitFrame:function() {
    if (this.display) {
      this.display.submitFrame();
    }
  }, reset:function() {
    if (this.display) {
      this.display.resetPose();
    }
  }, setClipPlanes:function(n, f) {
    if (this.display) {
      this.display.depthNear = n;
      this.display.depthFar = f;
    }
  }, getFrameData:function() {
    if (this.display) {
      return this._frameData;
    }
  }};
  Object.defineProperty(VrDisplay.prototype, "capabilities", {get:function() {
    if (this.display) {
      return this.display.capabilities;
    }
    return {};
  }});
  return {VrDisplay:VrDisplay};
}());
pc.extend(pc, function() {
  var Http = function Http() {
  };
  Http.ContentType = {FORM_URLENCODED:"application/x-www-form-urlencoded", GIF:"image/gif", JPEG:"image/jpeg", DDS:"image/dds", JSON:"application/json", PNG:"image/png", TEXT:"text/plain", XML:"application/xml", WAV:"audio/x-wav", OGG:"audio/ogg", MP3:"audio/mpeg", MP4:"audio/mp4", AAC:"audio/aac", BIN:"application/octet-stream"};
  Http.ResponseType = {TEXT:"text", ARRAY_BUFFER:"arraybuffer", BLOB:"blob", DOCUMENT:"document"};
  Http.binaryExtensions = [".model", ".wav", ".ogg", ".mp3", ".mp4", ".m4a", ".aac", ".dds"];
  Http.prototype = {ContentType:Http.ContentType, ResponseType:Http.ResponseType, binaryExtensions:Http.binaryExtensions, get:function(url, options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    }
    return this.request("GET", url, options, callback);
  }, post:function(url, data, options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    }
    options.postdata = data;
    return this.request("POST", url, options, callback);
  }, put:function(url, data, options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    }
    options.postdata = data;
    return this.request("PUT", url, options, callback);
  }, del:function(url, options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    }
    return this.request("DELETE", url, options, callback);
  }, request:function(method, url, options, callback) {
    var uri, query, timestamp, postdata, xhr;
    var errored = false;
    if (typeof options === "function") {
      callback = options;
      options = {};
    }
    options.callback = callback;
    if (options.async == null) {
      options.async = true;
    }
    if (options.headers == null) {
      options.headers = {};
    }
    if (options.postdata != null) {
      if (options.postdata instanceof Document) {
        postdata = options.postdata;
      } else {
        if (options.postdata instanceof FormData) {
          postdata = options.postdata;
        } else {
          if (options.postdata instanceof Object) {
            var contentType = options.headers["Content-Type"];
            if (contentType === undefined) {
              options.headers["Content-Type"] = Http.ContentType.FORM_URLENCODED;
              contentType = options.headers["Content-Type"];
            }
            switch(contentType) {
              case Http.ContentType.FORM_URLENCODED:
                postdata = "";
                var bFirstItem = true;
                for (var key in options.postdata) {
                  if (options.postdata.hasOwnProperty(key)) {
                    if (bFirstItem) {
                      bFirstItem = false;
                    } else {
                      postdata += "&";
                    }
                    postdata += escape(key) + "=" + escape(options.postdata[key]);
                  }
                }
                break;
              default:
              case Http.ContentType.JSON:
                if (contentType == null) {
                  options.headers["Content-Type"] = Http.ContentType.JSON;
                }
                postdata = JSON.stringify(options.postdata);
                break;
            }
          } else {
            postdata = options.postdata;
          }
        }
      }
    }
    if (!xhr) {
      xhr = new XMLHttpRequest;
    }
    if (options.cache === false) {
      timestamp = pc.time.now();
      uri = new pc.URI(url);
      if (!uri.query) {
        uri.query = "ts=" + timestamp;
      } else {
        uri.query = uri.query + "&ts=" + timestamp;
      }
      url = uri.toString();
    }
    if (options.query) {
      uri = new pc.URI(url);
      query = pc.extend(uri.getQuery(), options.query);
      uri.setQuery(query);
      url = uri.toString();
    }
    xhr.open(method, url, options.async);
    xhr.withCredentials = options.withCredentials !== undefined ? options.withCredentials : false;
    xhr.responseType = options.responseType || this._guessResponseType(url);
    for (var header in options.headers) {
      if (options.headers.hasOwnProperty(header)) {
        xhr.setRequestHeader(header, options.headers[header]);
      }
    }
    xhr.onreadystatechange = function() {
      this._onReadyStateChange(method, url, options, xhr);
    }.bind(this);
    xhr.onerror = function() {
      this._onError(method, url, options, xhr);
      errored = true;
    }.bind(this);
    try {
      xhr.send(postdata);
    } catch (e) {
      if (!errored) {
        options.error(xhr.status, xhr, e);
      }
    }
    return xhr;
  }, _guessResponseType:function(url) {
    var uri = new pc.URI(url);
    var ext = pc.path.getExtension(uri.path);
    if (Http.binaryExtensions.indexOf(ext) >= 0) {
      return Http.ResponseType.ARRAY_BUFFER;
    }
    if (ext === ".xml") {
      return Http.ResponseType.DOCUMENT;
    }
    return Http.ResponseType.TEXT;
  }, _isBinaryContentType:function(contentType) {
    var binTypes = [Http.ContentType.MP4, Http.ContentType.WAV, Http.ContentType.OGG, Http.ContentType.MP3, Http.ContentType.BIN, Http.ContentType.DDS];
    if (binTypes.indexOf(contentType) >= 0) {
      return true;
    }
    return false;
  }, _onReadyStateChange:function(method, url, options, xhr) {
    if (xhr.readyState === 4) {
      switch(xhr.status) {
        case 0:
          {
            if (url[0] != "/") {
              this._onSuccess(method, url, options, xhr);
            }
            break;
          }
        case 200:
        case 201:
        case 206:
        case 304:
          {
            this._onSuccess(method, url, options, xhr);
            break;
          }
        default:
          {
            this._onError(method, url, options, xhr);
            break;
          }
      }
    }
  }, _onSuccess:function(method, url, options, xhr) {
    var response;
    var header;
    var contentType;
    var parameter;
    var parts;
    header = xhr.getResponseHeader("Content-Type");
    if (header) {
      parts = header.split(";");
      contentType = parts[0].trim();
      if (parts[1]) {
        parameter = parts[1].trim();
      }
    }
    if (contentType === this.ContentType.JSON || url.split("?")[0].endsWith(".json")) {
      response = JSON.parse(xhr.responseText);
    } else {
      if (this._isBinaryContentType(contentType)) {
        response = xhr.response;
      } else {
        if (xhr.responseType === Http.ResponseType.ARRAY_BUFFER) {
          logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}", Http.ResponseType.ARRAY_BUFFER, contentType));
          response = xhr.response;
        } else {
          if (xhr.responseType === Http.ResponseType.DOCUMENT || contentType === this.ContentType.XML) {
            response = xhr.responseXML;
          } else {
            response = xhr.responseText;
          }
        }
      }
    }
    options.callback(null, response);
  }, _onError:function(method, url, options, xhr) {
    options.callback(xhr.status, null);
  }};
  return {Http:Http, http:new Http};
}());
pc.extend(pc, function() {
  var ScriptRegistry = function(app) {
    pc.events.attach(this);
    this.app = app;
    this._scripts = {};
    this._list = [];
  };
  ScriptRegistry.prototype.add = function(script) {
    var self = this;
    if (this._scripts.hasOwnProperty(script.__name)) {
      setTimeout(function() {
        if (script.prototype.swap) {
          var old = self._scripts[script.__name];
          var ind = self._list.indexOf(old);
          self._list[ind] = script;
          self._scripts[script.__name] = script;
          self.fire("swap", script.__name, script);
          self.fire("swap:" + script.__name, script);
        } else {
          console.warn("script registry already has '" + script.__name + "' script, define 'swap' method for new script type to enable code hot swapping");
        }
      });
      return false;
    }
    this._scripts[script.__name] = script;
    this._list.push(script);
    this.fire("add", script.__name, script);
    this.fire("add:" + script.__name, script);
    setTimeout(function() {
      if (!self._scripts.hasOwnProperty(script.__name)) {
        return;
      }
      var components = self.app.systems.script._components;
      var i, s, scriptInstance, attributes;
      var scriptInstances = [];
      var scriptInstancesInitialized = [];
      for (i = 0;i < components.length;i++) {
        if (components[i]._scriptsIndex[script.__name] && components[i]._scriptsIndex[script.__name].awaiting) {
          if (components[i]._scriptsData && components[i]._scriptsData[script.__name]) {
            attributes = components[i]._scriptsData[script.__name].attributes;
          }
          scriptInstance = components[i].create(script.__name, {preloading:true, ind:components[i]._scriptsIndex[script.__name].ind, attributes:attributes});
          if (scriptInstance) {
            scriptInstances.push(scriptInstance);
          }
        }
      }
      for (i = 0;i < scriptInstances.length;i++) {
        scriptInstances[i].__initializeAttributes();
      }
      for (i = 0;i < scriptInstances.length;i++) {
        if (scriptInstances[i].enabled) {
          scriptInstances[i]._initialized = true;
          scriptInstancesInitialized.push(scriptInstances[i]);
          if (scriptInstances[i].initialize) {
            scriptInstances[i].initialize();
          }
        }
      }
      for (i = 0;i < scriptInstancesInitialized.length;i++) {
        scriptInstancesInitialized[i]._postInitialized = true;
        if (scriptInstancesInitialized[i].postInitialize) {
          scriptInstancesInitialized[i].postInitialize();
        }
      }
    });
    return true;
  };
  ScriptRegistry.prototype.remove = function(script) {
    var name = script;
    if (typeof script === "function") {
      name = script.__name;
    }
    if (!this._scripts.hasOwnProperty(name)) {
      return false;
    }
    var item = this._scripts[name];
    delete this._scripts[name];
    var ind = this._list.indexOf(item);
    this._list.splice(ind, 1);
    this.fire("remove", name, item);
    this.fire("remove:" + name, item);
    return true;
  };
  ScriptRegistry.prototype.get = function(name) {
    return this._scripts[name] || null;
  };
  ScriptRegistry.prototype.has = function(name) {
    return this._scripts.hasOwnProperty(name);
  };
  ScriptRegistry.prototype.list = function() {
    return this._list;
  };
  return {ScriptRegistry:ScriptRegistry};
}());
pc.extend(pc, function() {
  var rawToValue = function(app, args, value, old) {
    var i;
    switch(args.type) {
      case "boolean":
        return !!value;
      case "number":
        if (typeof value === "number") {
          return value;
        } else {
          if (typeof value === "string") {
            var v = parseInt(value, 10);
            if (isNaN(v)) {
              return null;
            }
            return v;
          } else {
            if (typeof value === "boolean") {
              return 0 + value;
            } else {
              return null;
            }
          }
        }
        break;
      case "json":
        if (typeof value === "object") {
          return value;
        } else {
          try {
            return JSON.parse(value);
          } catch (ex) {
            return null;
          }
        }
        break;
      case "asset":
        if (args.array) {
          var result = [];
          if (value instanceof Array) {
            for (i = 0;i < value.length;i++) {
              if (value[i] instanceof pc.Asset) {
                result.push(value[i]);
              } else {
                if (typeof value[i] === "number") {
                  result.push(app.assets.get(value[i]) || null);
                } else {
                  if (typeof value[i] === "string") {
                    result.push(app.assets.get(parseInt(value[i], 10)) || null);
                  } else {
                    result.push(null);
                  }
                }
              }
            }
          }
          return result;
        } else {
          if (value instanceof pc.Asset) {
            return value;
          } else {
            if (typeof value === "number") {
              return app.assets.get(value) || null;
            } else {
              if (typeof value === "string") {
                return app.assets.get(parseInt(value, 10)) || null;
              } else {
                return null;
              }
            }
          }
        }
        break;
      case "entity":
        if (value instanceof pc.GraphNode) {
          return value;
        } else {
          if (typeof value === "string") {
            return app.root.findByGuid(value);
          } else {
            return null;
          }
        }
        break;
      case "rgb":
      case "rgba":
        if (value instanceof pc.Color) {
          if (old instanceof pc.Color) {
            old.copy(value);
            return old;
          } else {
            return value.clone();
          }
        } else {
          if (value instanceof Array && value.length >= 3 && value.length <= 4) {
            for (i = 0;i < value.length;i++) {
              if (typeof value[i] !== "number") {
                return null;
              }
            }
            if (!old) {
              old = new pc.Color;
            }
            for (i = 0;i < 4;i++) {
              old.data[i] = i === 4 && value.length === 3 ? 1 : value[i];
            }
            return old;
          } else {
            if (typeof value === "string" && /#([0-9abcdef]{2}){3,4}/i.test(value)) {
              if (!old) {
                old = new pc.Color;
              }
              old.fromString(value);
              return old;
            } else {
              return null;
            }
          }
        }
        break;
      case "vec2":
      case "vec3":
      case "vec4":
        var len = parseInt(args.type.slice(3), 10);
        if (value instanceof pc["Vec" + len]) {
          if (old instanceof pc["Vec" + len]) {
            old.copy(value);
            return old;
          } else {
            return value.clone();
          }
        } else {
          if (value instanceof Array && value.length === len) {
            for (i = 0;i < value.length;i++) {
              if (typeof value[i] !== "number") {
                return null;
              }
            }
            if (!old) {
              old = new pc["Vec" + len];
            }
            for (i = 0;i < len;i++) {
              old.data[i] = value[i];
            }
            return old;
          } else {
            return null;
          }
        }
        break;
      case "curve":
        if (value) {
          var curve;
          if (value instanceof pc.Curve || value instanceof pc.CurveSet) {
            curve = value.clone();
          } else {
            var CurveType = value.keys[0] instanceof Array ? pc.CurveSet : pc.Curve;
            curve = new CurveType(value.keys);
            curve.type = value.type;
          }
          return curve;
        }
        break;
    }
    return value;
  };
  var ScriptAttributes = function(scriptType) {
    this.scriptType = scriptType;
    this.index = {};
  };
  ScriptAttributes.prototype.add = function(name, args) {
    if (this.index[name]) {
      console.warn("attribute '" + name + "' is already defined for script type '" + this.scriptType.name + "'");
      return;
    } else {
      if (pc.createScript.reservedAttributes[name]) {
        console.warn("attribute '" + name + "' is a reserved attribute name");
        return;
      }
    }
    this.index[name] = args;
    Object.defineProperty(this.scriptType.prototype, name, {get:function() {
      return this.__attributes[name];
    }, set:function(raw) {
      var old = this.__attributes[name];
      this.__attributes[name] = rawToValue(this.app, args, raw, old);
      this.fire("attr", name, this.__attributes[name], old);
      this.fire("attr:" + name, this.__attributes[name], old);
    }});
  };
  ScriptAttributes.prototype.remove = function(name) {
    if (!this.index[name]) {
      return false;
    }
    delete this.index[name];
    delete this.scriptType.prototype[name];
    return true;
  };
  ScriptAttributes.prototype.has = function(name) {
    return !!this.index[name];
  };
  ScriptAttributes.prototype.get = function(name) {
    return this.index[name] || null;
  };
  var createScript = function(name, app) {
    if (pc.script.legacy) {
      console.error("This project is using the legacy script system. You cannot call pc.createScript(). See: http://developer.playcanvas.com/en/user-manual/scripting/legacy/");
      return null;
    }
    if (createScript.reservedScripts[name]) {
      throw new Error("script name: '" + name + "' is reserved, please change script name");
    }
    var script = function(args) {
      if (!args || !args.app || !args.entity) {
        console.warn("script '" + name + "' has missing arguments in consructor");
      }
      pc.events.attach(this);
      this.app = args.app;
      this.entity = args.entity;
      this._enabled = typeof args.enabled === "boolean" ? args.enabled : true;
      this._enabledOld = this.enabled;
      this.__attributes = {};
      this.__attributesRaw = args.attributes || null;
      this.__scriptType = script;
    };
    script.__name = name;
    script.attributes = new ScriptAttributes(script);
    script.prototype.__initializeAttributes = function(force) {
      if (!force && !this.__attributesRaw) {
        return;
      }
      for (var key in script.attributes.index) {
        if (this.__attributesRaw && this.__attributesRaw.hasOwnProperty(key)) {
          this[key] = this.__attributesRaw[key];
        } else {
          if (!this.__attributes.hasOwnProperty(key)) {
            if (script.attributes.index[key].hasOwnProperty("default")) {
              this[key] = script.attributes.index[key]["default"];
            } else {
              this[key] = null;
            }
          }
        }
      }
      this.__attributesRaw = null;
    };
    script.extend = function(methods) {
      for (var key in methods) {
        if (!methods.hasOwnProperty(key)) {
          continue;
        }
        script.prototype[key] = methods[key];
      }
    };
    Object.defineProperty(script.prototype, "enabled", {get:function() {
      return this._enabled && this.entity.script.enabled && this.entity.enabled;
    }, set:function(value) {
      value = !!value;
      if (this._enabled !== value) {
        this._enabled = value;
      }
      if (this.enabled !== this._enabledOld) {
        this._enabledOld = this.enabled;
        this.fire(this.enabled ? "enable" : "disable");
        this.fire("state", this.enabled);
      }
    }});
    var registry = app ? app.scripts : pc.Application.getApplication().scripts;
    registry.add(script);
    pc.ScriptHandler._push(script);
    return script;
  };
  createScript.reservedScripts = ["system", "entity", "create", "destroy", "swap", "move", "scripts", "_scripts", "_scriptsIndex", "_scriptsData", "enabled", "_oldState", "onEnable", "onDisable", "onPostStateChange", "_onSetEnabled", "_checkState", "_onBeforeRemove", "_onInitializeAttributes", "_onInitialize", "_onPostInitialize", "_onUpdate", "_onPostUpdate", "_callbacks", "has", "on", "off", "fire", "once", "hasEvent"];
  var reservedScripts = {};
  var i;
  for (i = 0;i < createScript.reservedScripts.length;i++) {
    reservedScripts[createScript.reservedScripts[i]] = 1;
  }
  createScript.reservedScripts = reservedScripts;
  createScript.reservedAttributes = ["app", "entity", "enabled", "_enabled", "_enabledOld", "__attributes", "__attributesRaw", "__scriptType", "_callbacks", "has", "on", "off", "fire", "once", "hasEvent"];
  var reservedAttributes = {};
  for (i = 0;i < createScript.reservedAttributes.length;i++) {
    reservedAttributes[createScript.reservedAttributes[i]] = 1;
  }
  createScript.reservedAttributes = reservedAttributes;
  return {createScript:createScript};
}());
pc.script = function() {
  var _main = null;
  var _loader = null;
  var _legacy = false;
  var _createdLoadingScreen = false;
  var script = {app:null, create:function(name, callback) {
    if (!_legacy) {
      return;
    }
    var ScriptType = callback(pc.script.app);
    ScriptType._pcScriptName = name;
    pc.ScriptHandler._push(ScriptType);
    this.fire("created", name, callback);
  }, attribute:function(name, type, defaultValue, options) {
  }, createLoadingScreen:function(callback) {
    if (_createdLoadingScreen) {
      return;
    }
    _createdLoadingScreen = true;
    var app = pc.Application.getApplication();
    callback(app);
  }};
  Object.defineProperty(script, "legacy", {get:function() {
    return _legacy;
  }, set:function(value) {
    _legacy = value;
  }});
  pc.events.attach(script);
  return script;
}();
pc.extend(pc, function() {
  var Application = function(canvas, options) {
    options = options || {};
    pc.log.open();
    pc.events.attach(this);
    Application._applications[canvas.id] = this;
    Application._currentApplication = this;
    this._time = 0;
    this.timeScale = 1;
    this.autoRender = true;
    this.renderNextFrame = false;
    this._librariesLoaded = false;
    this._fillMode = pc.FILLMODE_KEEP_ASPECT;
    this._resolutionMode = pc.RESOLUTION_FIXED;
    this._allowResize = true;
    this.context = this;
    this.graphicsDevice = new pc.GraphicsDevice(canvas, options.graphicsDeviceOptions);
    this.stats = new pc.ApplicationStats(this.graphicsDevice);
    this.systems = new pc.ComponentSystemRegistry;
    this._audioManager = new pc.SoundManager(options);
    this.loader = new pc.ResourceLoader;
    this.scene = new pc.Scene;
    this.root = new pc.Entity(this);
    this.root._enabledInHierarchy = true;
    this._enableList = [];
    this._enableList.size = 0;
    this.assets = new pc.AssetRegistry(this.loader);
    if (options.assetPrefix) {
      this.assets.prefix = options.assetPrefix;
    }
    this.scriptsOrder = options.scriptsOrder || [];
    this.scripts = new pc.ScriptRegistry(this);
    this.renderer = new pc.ForwardRenderer(this.graphicsDevice);
    this.lightmapper = new pc.Lightmapper(this.graphicsDevice, this.root, this.scene, this.renderer, this.assets);
    this.once("prerender", this._firstBake, this);
    this.batcher = new pc.BatchManager(this.graphicsDevice, this.root, this.scene);
    this.once("prerender", this._firstBatch, this);
    this.keyboard = options.keyboard || null;
    this.mouse = options.mouse || null;
    this.touch = options.touch || null;
    this.gamepads = options.gamepads || null;
    this.elementInput = options.elementInput || null;
    if (this.elementInput) {
      this.elementInput.app = this;
    }
    this.vr = null;
    if (options.vr) {
      this._onVrChange(options.vr);
    }
    this._inTools = false;
    this._skyboxLast = 0;
    this._scriptPrefix = options.scriptPrefix || "";
    this.loader.addHandler("animation", new pc.AnimationHandler);
    this.loader.addHandler("model", new pc.ModelHandler(this.graphicsDevice));
    this.loader.addHandler("material", new pc.MaterialHandler(this));
    this.loader.addHandler("texture", new pc.TextureHandler(this.graphicsDevice, this.assets, this.loader));
    this.loader.addHandler("text", new pc.TextHandler);
    this.loader.addHandler("json", new pc.JsonHandler);
    this.loader.addHandler("audio", new pc.AudioHandler(this._audioManager));
    this.loader.addHandler("script", new pc.ScriptHandler(this));
    this.loader.addHandler("scene", new pc.SceneHandler(this));
    this.loader.addHandler("cubemap", new pc.CubemapHandler(this.graphicsDevice, this.assets, this.loader));
    this.loader.addHandler("html", new pc.HtmlHandler);
    this.loader.addHandler("css", new pc.CssHandler);
    this.loader.addHandler("shader", new pc.ShaderHandler);
    this.loader.addHandler("hierarchy", new pc.HierarchyHandler(this));
    this.loader.addHandler("scenesettings", new pc.SceneSettingsHandler(this));
    this.loader.addHandler("folder", new pc.FolderHandler);
    this.loader.addHandler("font", new pc.FontHandler(this.loader));
    this.loader.addHandler("binary", new pc.BinaryHandler);
    var rigidbodysys = new pc.RigidBodyComponentSystem(this);
    var collisionsys = new pc.CollisionComponentSystem(this);
    var animationsys = new pc.AnimationComponentSystem(this);
    var modelsys = new pc.ModelComponentSystem(this);
    var camerasys = new pc.CameraComponentSystem(this);
    var lightsys = new pc.LightComponentSystem(this);
    if (pc.script.legacy) {
      new pc.ScriptLegacyComponentSystem(this);
    } else {
      new pc.ScriptComponentSystem(this);
    }
    var audiosourcesys = new pc.AudioSourceComponentSystem(this, this._audioManager);
    var soundsys = new pc.SoundComponentSystem(this, this._audioManager);
    var audiolistenersys = new pc.AudioListenerComponentSystem(this, this._audioManager);
    var particlesystemsys = new pc.ParticleSystemComponentSystem(this);
    var screensys = new pc.ScreenComponentSystem(this);
    var elementsys = new pc.ElementComponentSystem(this);
    var zonesys = new pc.ZoneComponentSystem(this);
    this._visibilityChangeHandler = this.onVisibilityChange.bind(this);
    if (document.hidden !== undefined) {
      this._hiddenAttr = "hidden";
      document.addEventListener("visibilitychange", this._visibilityChangeHandler, false);
    } else {
      if (document.mozHidden !== undefined) {
        this._hiddenAttr = "mozHidden";
        document.addEventListener("mozvisibilitychange", this._visibilityChangeHandler, false);
      } else {
        if (document.msHidden !== undefined) {
          this._hiddenAttr = "msHidden";
          document.addEventListener("msvisibilitychange", this._visibilityChangeHandler, false);
        } else {
          if (document.webkitHidden !== undefined) {
            this._hiddenAttr = "webkitHidden";
            document.addEventListener("webkitvisibilitychange", this._visibilityChangeHandler, false);
          }
        }
      }
    }
    this.tick = makeTick(this);
  };
  Application._currentApplication = null;
  Application._applications = {};
  Application.getApplication = function(id) {
    if (id) {
      return Application._applications[id];
    } else {
      return Application._currentApplication;
    }
  };
  var Progress = function(length) {
    this.length = length;
    this.count = 0;
    this.inc = function() {
      this.count++;
    };
    this.done = function() {
      return this.count === this.length;
    };
  };
  Application.prototype = {configure:function(url, callback) {
    var self = this;
    pc.http.get(url, function(err, response) {
      if (err) {
        callback(err);
        return;
      }
      var props = response.application_properties;
      var assets = response.assets;
      var scripts = response.scripts;
      var priorityScripts = response.priority_scripts;
      self._parseApplicationProperties(props, function(err) {
        self._onVrChange(props.vr);
        self._parseAssets(assets);
        if (!err) {
          callback(null);
        } else {
          callback(err);
        }
      });
    });
  }, preload:function(callback) {
    var self = this;
    self.fire("preload:start");
    var assets = this.assets.list({preload:true});
    var _assets = new Progress(assets.length);
    var _done = false;
    var done = function() {
      if (!self.graphicsDevice) {
        return;
      }
      if (!_done && _assets.done()) {
        _done = true;
        self.fire("preload:end");
        callback();
      }
    };
    var total = assets.length;
    var count = function() {
      return _assets.count;
    };
    var i;
    if (_assets.length) {
      var onAssetLoad = function(asset) {
        _assets.inc();
        self.fire("preload:progress", count() / total);
        if (_assets.done()) {
          done();
        }
      };
      var onAssetError = function(err, asset) {
        _assets.inc();
        self.fire("preload:progress", count() / total);
        if (_assets.done()) {
          done();
        }
      };
      for (i = 0;i < assets.length;i++) {
        if (!assets[i].loaded) {
          assets[i].once("load", onAssetLoad);
          assets[i].once("error", onAssetError);
          this.assets.load(assets[i]);
        } else {
          _assets.inc();
          self.fire("preload:progress", count() / total);
          if (_assets.done()) {
            done();
          }
        }
      }
    } else {
      done();
    }
  }, loadSceneHierarchy:function(url, callback) {
    var self = this;
    var handler = this.loader.getHandler("hierarchy");
    if (this.assets && this.assets.prefix && !pc.ABSOLUTE_URL.test(url)) {
      url = pc.path.join(this.assets.prefix, url);
    }
    handler.load(url, function(err, data) {
      if (err) {
        if (callback) {
          callback(err);
        }
        return;
      }
      var _loaded = function() {
        var entity = handler.open(url, data);
        self.loader.clearCache(url, "hierarchy");
        self.root.addChild(entity);
        pc.ComponentSystem.initialize(entity);
        pc.ComponentSystem.postInitialize(entity);
        if (callback) {
          callback(err, entity);
        }
      };
      self._preloadScripts(data, _loaded);
    });
  }, loadSceneSettings:function(url, callback) {
    if (this.assets && this.assets.prefix && !pc.ABSOLUTE_URL.test(url)) {
      url = pc.path.join(this.assets.prefix, url);
    }
    this.loader.load(url, "scenesettings", function(err, settings) {
      if (!err) {
        this.applySceneSettings(settings);
        if (callback) {
          callback(null);
        }
      } else {
        if (callback) {
          callback(err);
        }
      }
    }.bind(this));
  }, loadScene:function(url, callback) {
    var self = this;
    var handler = this.loader.getHandler("scene");
    if (this.assets && this.assets.prefix && !pc.ABSOLUTE_URL.test(url)) {
      url = pc.path.join(this.assets.prefix, url);
    }
    handler.load(url, function(err, data) {
      if (!err) {
        var _loaded = function() {
          var scene = handler.open(url, data);
          self.loader.clearCache(url, "scene");
          self.loader.patch({resource:scene, type:"scene"}, self.assets);
          self.root.addChild(scene.root);
          if (self.systems.rigidbody && typeof Ammo !== "undefined") {
            self.systems.rigidbody.setGravity(scene._gravity.x, scene._gravity.y, scene._gravity.z);
          }
          if (callback) {
            callback(null, scene);
          }
        };
        this._preloadScripts(data, _loaded);
      } else {
        if (callback) {
          callback(err);
        }
      }
    }.bind(this));
  }, _preloadScripts:function(sceneData, callback) {
    if (!pc.script.legacy) {
      callback();
      return;
    }
    var self = this;
    self.systems.script.preloading = true;
    var scripts = this._getScriptReferences(sceneData);
    var i = 0, l = scripts.length;
    var progress = new Progress(l);
    var scriptUrl;
    var regex = /^http(s)?:\/\//;
    if (l) {
      var onLoad = function(err, ScriptType) {
        if (err) {
          console.error(err);
        }
        progress.inc();
        if (progress.done()) {
          self.systems.script.preloading = false;
          callback();
        }
      };
      for (i = 0;i < l;i++) {
        scriptUrl = scripts[i];
        if (!regex.test(scriptUrl.toLowerCase()) && self._scriptPrefix) {
          scriptUrl = pc.path.join(self._scriptPrefix, scripts[i]);
        }
        this.loader.load(scriptUrl, "script", onLoad);
      }
    } else {
      self.systems.script.preloading = false;
      callback();
    }
  }, _parseApplicationProperties:function(props, callback) {
    if (!props.useDevicePixelRatio) {
      props.useDevicePixelRatio = props.use_device_pixel_ratio;
    }
    if (!props.resolutionMode) {
      props.resolutionMode = props.resolution_mode;
    }
    if (!props.fillMode) {
      props.fillMode = props.fill_mode;
    }
    if (!props.vrPolyfillUrl) {
      props.vrPolyfillUrl = props.vr_polyfill_url;
    }
    this._width = props.width;
    this._height = props.height;
    if (props.useDevicePixelRatio) {
      this.graphicsDevice.maxPixelRatio = window.devicePixelRatio;
    }
    this.setCanvasResolution(props.resolutionMode, this._width, this._height);
    this.setCanvasFillMode(props.fillMode, this._width, this._height);
    if (props.vr && props.vrPolyfillUrl) {
      if (!pc.VrManager.isSupported || pc.platform.android) {
        props.libraries.push(props.vrPolyfillUrl);
      }
    }
    if (props.batchGroups) {
      for (var i = 0, len = props.batchGroups.length;i < len;i++) {
        var grp = props.batchGroups[i];
        this.batcher.addGroup(grp.name, grp.dynamic, grp.maxAabbSize, grp.id);
      }
    }
    this._loadLibraries(props.libraries, callback);
  }, _loadLibraries:function(urls, callback) {
    var len = urls.length;
    var count = len;
    var self = this;
    var regex = /^http(s)?:\/\//;
    if (len) {
      var onLoad = function(err, script) {
        count--;
        if (err) {
          callback(err);
        } else {
          if (count === 0) {
            self.onLibrariesLoaded();
            callback(null);
          }
        }
      };
      for (var i = 0;i < len;++i) {
        var url = urls[i];
        if (!regex.test(url.toLowerCase()) && self._scriptPrefix) {
          url = pc.path.join(self._scriptPrefix, url);
        }
        this.loader.load(url, "script", onLoad);
      }
    } else {
      callback(null);
    }
  }, _parseAssets:function(assets) {
    var i, id;
    var scripts = [];
    var list = [];
    var scriptsIndex = {};
    if (!pc.script.legacy) {
      for (i = 0;i < this.scriptsOrder.length;i++) {
        id = this.scriptsOrder[i];
        if (!assets[id]) {
          continue;
        }
        scriptsIndex[id] = true;
        list.push(assets[id]);
      }
      for (id in assets) {
        if (scriptsIndex[id]) {
          continue;
        }
        list.push(assets[id]);
      }
    } else {
      for (id in assets) {
        list.push(assets[id]);
      }
    }
    for (i = 0;i < list.length;i++) {
      var data = list[i];
      var asset = new pc.Asset(data.name, data.type, data.file, data.data);
      asset.id = parseInt(data.id);
      asset.preload = data.preload ? data.preload : false;
      asset.tags.add(data.tags);
      this.assets.add(asset);
    }
  }, _getScriptReferences:function(scene) {
    var i, key;
    var priorityScripts = [];
    if (scene.settings.priority_scripts) {
      priorityScripts = scene.settings.priority_scripts;
    }
    var _scripts = [];
    var _index = {};
    for (i = 0;i < priorityScripts.length;i++) {
      _scripts.push(priorityScripts[i]);
      _index[priorityScripts[i]] = true;
    }
    var entities = scene.entities;
    for (key in entities) {
      if (!entities[key].components.script) {
        continue;
      }
      var scripts = entities[key].components.script.scripts;
      for (i = 0;i < scripts.length;i++) {
        if (_index[scripts[i].url]) {
          continue;
        }
        _scripts.push(scripts[i].url);
        _index[scripts[i].url] = true;
      }
    }
    return _scripts;
  }, start:function() {
    this.fire("start", {timestamp:pc.now(), target:this});
    if (!this._librariesLoaded) {
      this.onLibrariesLoaded();
    }
    pc.ComponentSystem.initialize(this.root);
    this.fire("initialize");
    pc.ComponentSystem.postInitialize(this.root);
    this.fire("postinitialize");
    this.tick();
  }, update:function(dt) {
    this.graphicsDevice.updateClientRect();
    if (this.vr) {
      this.vr.poll();
    }
    if (pc.script.legacy) {
      pc.ComponentSystem.fixedUpdate(1.0 / 60.0, this._inTools);
    }
    pc.ComponentSystem.update(dt, this._inTools);
    pc.ComponentSystem.postUpdate(dt, this._inTools);
    this.fire("update", dt);
    if (this.controller) {
      this.controller.update(dt);
    }
    if (this.mouse) {
      this.mouse.update(dt);
    }
    if (this.keyboard) {
      this.keyboard.update(dt);
    }
    if (this.gamepads) {
      this.gamepads.update(dt);
    }
  }, render:function() {
    this.fire("prerender");
    var cameras = this.systems.camera.cameras;
    var camera = null;
    var renderer = this.renderer;
    this.root.syncHierarchy();
    this.batcher.updateAll();
    for (var i = 0, len = cameras.length;i < len;i++) {
      camera = cameras[i];
      camera.frameBegin();
      renderer.render(this.scene, camera.camera);
      camera.frameEnd();
    }
  }, _fillFrameStats:function(now, dt, ms) {
    var stats = this.stats.frame;
    stats.dt = dt;
    stats.ms = ms;
    if (now > stats._timeToCountFrames) {
      stats.fps = stats._fpsAccum;
      stats._fpsAccum = 0;
      stats._timeToCountFrames = now + 1000;
    } else {
      stats._fpsAccum++;
    }
    stats.cameras = this.renderer._camerasRendered;
    stats.materials = this.renderer._materialSwitches;
    stats.shaders = this.graphicsDevice._shaderSwitchesPerFrame;
    stats.shadowMapUpdates = this.renderer._shadowMapUpdates;
    stats.shadowMapTime = this.renderer._shadowMapTime;
    stats.depthMapTime = this.renderer._depthMapTime;
    stats.forwardTime = this.renderer._forwardTime;
    var prims = this.graphicsDevice._primsPerFrame;
    stats.triangles = prims[pc.PRIMITIVE_TRIANGLES] / 3 + Math.max(prims[pc.PRIMITIVE_TRISTRIP] - 2, 0) + Math.max(prims[pc.PRIMITIVE_TRIFAN] - 2, 0);
    stats.cullTime = this.renderer._cullTime;
    stats.sortTime = this.renderer._sortTime;
    stats.skinTime = this.renderer._skinTime;
    stats.morphTime = this.renderer._morphTime;
    stats.instancingTime = this.renderer._instancingTime;
    stats.otherPrimitives = 0;
    for (var i = 0;i < prims.length;i++) {
      if (i < pc.PRIMITIVE_TRIANGLES) {
        stats.otherPrimitives += prims[i];
      }
      prims[i] = 0;
    }
    this.renderer._camerasRendered = 0;
    this.renderer._materialSwitches = 0;
    this.renderer._shadowMapUpdates = 0;
    this.graphicsDevice._shaderSwitchesPerFrame = 0;
    this.renderer._cullTime = 0;
    this.renderer._sortTime = 0;
    this.renderer._skinTime = 0;
    this.renderer._morphTime = 0;
    this.renderer._instancingTime = 0;
    this.renderer._shadowMapTime = 0;
    this.renderer._depthMapTime = 0;
    this.renderer._forwardTime = 0;
    stats = this.stats.drawCalls;
    stats.forward = this.renderer._forwardDrawCalls;
    stats.depth = this.renderer._depthDrawCalls;
    stats.shadow = this.renderer._shadowDrawCalls;
    stats.skinned = this.renderer._skinDrawCalls;
    stats.immediate = this.renderer._immediateRendered;
    stats.instanced = this.renderer._instancedDrawCalls;
    stats.removedByInstancing = this.renderer._removedByInstancing;
    stats.total = this.graphicsDevice._drawCallsPerFrame;
    stats.misc = stats.total - (stats.forward + stats.depth + stats.shadow);
    this.renderer._depthDrawCalls = 0;
    this.renderer._shadowDrawCalls = 0;
    this.renderer._forwardDrawCalls = 0;
    this.renderer._skinDrawCalls = 0;
    this.renderer._immediateRendered = 0;
    this.renderer._instancedDrawCalls = 0;
    this.renderer._removedByInstancing = 0;
    this.graphicsDevice._drawCallsPerFrame = 0;
    this.stats.misc.renderTargetCreationTime = this.graphicsDevice.renderTargetCreationTime;
    stats = this.stats.particles;
    stats.updatesPerFrame = stats._updatesPerFrame;
    stats.frameTime = stats._frameTime;
    stats._updatesPerFrame = 0;
    stats._frameTime = 0;
  }, setCanvasFillMode:function(mode, width, height) {
    this._fillMode = mode;
    this.resizeCanvas(width, height);
  }, setCanvasResolution:function(mode, width, height) {
    this._resolutionMode = mode;
    if (mode === pc.RESOLUTION_AUTO && width === undefined) {
      width = this.graphicsDevice.canvas.clientWidth;
      height = this.graphicsDevice.canvas.clientHeight;
    }
    this.graphicsDevice.resizeCanvas(width, height);
  }, isFullscreen:function() {
    return !!document.fullscreenElement;
  }, enableFullscreen:function(element, success, error) {
    element = element || this.graphicsDevice.canvas;
    var s = function() {
      success();
      document.removeEventListener("fullscreenchange", s);
    };
    var e = function() {
      error();
      document.removeEventListener("fullscreenerror", e);
    };
    if (success) {
      document.addEventListener("fullscreenchange", s, false);
    }
    if (error) {
      document.addEventListener("fullscreenerror", e, false);
    }
    if (element.requestFullscreen) {
      element.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    } else {
      error();
    }
  }, disableFullscreen:function(success) {
    var s = function() {
      success();
      document.removeEventListener("fullscreenchange", s);
    };
    if (success) {
      document.addEventListener("fullscreenchange", s, false);
    }
    document.exitFullscreen();
  }, isHidden:function() {
    return document[this._hiddenAttr];
  }, onVisibilityChange:function(e) {
    if (this.isHidden()) {
      this._audioManager.suspend();
    } else {
      this._audioManager.resume();
    }
  }, resizeCanvas:function(width, height) {
    if (!this._allowResize) {
      return;
    }
    var windowWidth = window.innerWidth;
    var windowHeight = window.innerHeight;
    if (navigator.isCocoonJS) {
      width = windowWidth;
      height = windowHeight;
      this.graphicsDevice.resizeCanvas(width, height);
    } else {
      if (this._fillMode === pc.FILLMODE_KEEP_ASPECT) {
        var r = this.graphicsDevice.canvas.width / this.graphicsDevice.canvas.height;
        var winR = windowWidth / windowHeight;
        if (r > winR) {
          width = windowWidth;
          height = width / r;
        } else {
          height = windowHeight;
          width = height * r;
        }
      } else {
        if (this._fillMode === pc.FILLMODE_FILL_WINDOW) {
          width = windowWidth;
          height = windowHeight;
        } else {
        }
      }
      this.graphicsDevice.canvas.style.width = width + "px";
      this.graphicsDevice.canvas.style.height = height + "px";
      if (this._resolutionMode === pc.RESOLUTION_AUTO) {
        this.setCanvasResolution(pc.RESOLUTION_AUTO);
      }
    }
    return {width:width, height:height};
  }, onLibrariesLoaded:function() {
    this._librariesLoaded = true;
    this.systems.rigidbody.onLibraryLoaded();
    this.systems.collision.onLibraryLoaded();
  }, applySceneSettings:function(settings) {
    var asset;
    if (this.systems.rigidbody && typeof Ammo !== "undefined") {
      var gravity = settings.physics.gravity;
      this.systems.rigidbody.setGravity(gravity[0], gravity[1], gravity[2]);
    }
    this.scene.applySettings(settings);
    if (settings.render.hasOwnProperty("skybox")) {
      if (settings.render.skybox) {
        asset = this.assets.get(settings.render.skybox);
        if (asset) {
          this.setSkybox(asset);
        } else {
          this.assets.once("add:" + settings.render.skybox, this.setSkybox, this);
        }
      } else {
        this.setSkybox(null);
      }
    }
  }, setSkybox:function(asset) {
    if (asset) {
      if (this._skyboxLast === asset.id) {
        if (this.scene.skyboxMip === 0 && !asset.loadFaces) {
          this._skyboxLoad(asset);
        } else {
          this._onSkyboxChange(asset);
        }
        return;
      }
      if (this._skyboxLast) {
        this.assets.off("add:" + this._skyboxLast, this.setSkybox, this);
        this.assets.off("load:" + this._skyboxLast, this._onSkyboxChange, this);
        this.assets.off("remove:" + this._skyboxLast, this._skyboxRemove, this);
      }
      this._skyboxLast = asset.id;
      this.assets.on("load:" + asset.id, this._onSkyboxChange, this);
      this.assets.once("remove:" + asset.id, this._skyboxRemove, this);
      if (asset.resource) {
        this.scene.setSkybox(asset.resources);
      }
      this._skyboxLoad(asset);
    } else {
      if (!this._skyboxLast) {
        return;
      }
      this._skyboxRemove({id:this._skyboxLast});
    }
  }, _onVrChange:function(enabled) {
    if (enabled) {
      if (!this.vr) {
        this.vr = new pc.VrManager(this);
      }
    } else {
      if (this.vr) {
        this.vr.destroy();
        this.vr = null;
      }
    }
  }, _onSkyboxChange:function(asset) {
    this.scene.setSkybox(asset.resources);
  }, _skyboxLoad:function(asset) {
    if (this.scene.skyboxMip === 0) {
      asset.loadFaces = true;
    }
    this.assets.load(asset);
    this._onSkyboxChange(asset);
  }, _skyboxRemove:function(asset) {
    if (!this._skyboxLast) {
      return;
    }
    this.assets.off("add:" + asset.id, this.setSkybox, this);
    this.assets.off("load:" + asset.id, this._onSkyboxChange, this);
    this.assets.off("remove:" + asset.id, this._skyboxRemove, this);
    this.scene.setSkybox(null);
    this._skyboxLast = null;
  }, _firstBake:function() {
    this.lightmapper.bake(null, this.scene.lightmapMode);
  }, _firstBatch:function() {
    if (this.scene._needsStaticPrepare) {
      this.renderer.prepareStaticMeshes(this.graphicsDevice, this.scene);
      this.scene._needsStaticPrepare = false;
    }
    this.batcher.generate();
  }, destroy:function() {
    Application._applications[this.graphicsDevice.canvas.id] = null;
    this.off("librariesloaded");
    document.removeEventListener("visibilitychange", this._visibilityChangeHandler);
    document.removeEventListener("mozvisibilitychange", this._visibilityChangeHandler);
    document.removeEventListener("msvisibilitychange", this._visibilityChangeHandler);
    document.removeEventListener("webkitvisibilitychange", this._visibilityChangeHandler);
    this.root.destroy();
    this.root = null;
    if (this.mouse) {
      this.mouse.off("mouseup");
      this.mouse.off("mousedown");
      this.mouse.off("mousewheel");
      this.mouse.off("mousemove");
      this.mouse = null;
    }
    if (this.keyboard) {
      this.keyboard.off("keydown");
      this.keyboard.off("keyup");
      this.keyboard.off("keypress");
      this.keyboard = null;
    }
    if (this.touch) {
      this.touch.off("touchstart");
      this.touch.off("touchend");
      this.touch.off("touchmove");
      this.touch.off("touchcancel");
      this.touch = null;
    }
    if (this.controller) {
      this.controller = null;
    }
    pc.ComponentSystem.destroy();
    var assets = this.assets.list();
    for (var i = 0;i < assets.length;i++) {
      assets[i].unload();
    }
    this.loader.destroy();
    this.loader = null;
    this.scene = null;
    this.systems = [];
    this.context = null;
    this.graphicsDevice.clearShaderCache();
    this.graphicsDevice.destroy();
    this.graphicsDevice.destroyed = true;
    this.graphicsDevice = null;
    this.renderer = null;
    if (this._audioManager) {
      this._audioManager.destroy();
      this._audioManager = null;
    }
    pc.http = new pc.Http;
    pc.ParticleEmitter.DEFAULT_PARAM_TEXTURE = null;
    pc.destroyPostEffectQuad();
  }};
  var makeTick = function(_app) {
    var app = _app;
    return function() {
      if (!app.graphicsDevice) {
        return;
      }
      Application._currentApplication = app;
      pc.app = app;
      var now = pc.now();
      var ms = now - (app._time || now);
      var dt = ms / 1000.0;
      app._time = now;
      dt = pc.math.clamp(dt, 0, 0.1);
      dt *= app.timeScale;
      if (app.vr && app.vr.display) {
        app.vr.display.requestAnimationFrame(app.tick);
      } else {
        window.requestAnimationFrame(app.tick);
      }
      app.update(dt);
      if (app.autoRender || app.renderNextFrame) {
        app.render();
        app.renderNextFrame = false;
      }
      _frameEndData.timestamp = pc.now();
      _frameEndData.target = app;
      app.fire("frameend", _frameEndData);
      app.fire("frameEnd", _frameEndData);
      if (app.vr && app.vr.display && app.vr.display.presenting) {
        app.vr.display.submitFrame();
      }
    };
  };
  var _frameEndData = {};
  return {FILLMODE_NONE:"NONE", FILLMODE_FILL_WINDOW:"FILL_WINDOW", FILLMODE_KEEP_ASPECT:"KEEP_ASPECT", RESOLUTION_AUTO:"AUTO", RESOLUTION_FIXED:"FIXED", Application:Application};
}());
pc.ApplicationStats = function(device) {
  this.frame = {fps:0, ms:0, dt:0, updateStart:0, updateTime:0, renderStart:0, renderTime:0, physicsStart:0, physicsTime:0, cullTime:0, sortTime:0, skinTime:0, morphTime:0, instancingTime:0, triangles:0, otherPrimitives:0, shaders:0, materials:0, cameras:0, shadowMapUpdates:0, shadowMapTime:0, depthMapTime:0, forwardTime:0, _timeToCountFrames:0, _fpsAccum:0};
  this.drawCalls = {forward:0, depth:0, shadow:0, immediate:0, misc:0, total:0, skinned:0, instanced:0, removedByInstancing:0};
  this.misc = {renderTargetCreationTime:0};
  this.particles = {updatesPerFrame:0, _updatesPerFrame:0, frameTime:0, _frameTime:0};
  this.vram = device._vram;
  this.shaders = device._shaderStats;
  Object.defineProperty(this.vram, "totalUsed", {get:function() {
    return this.tex + this.vb + this.ib;
  }});
  Object.defineProperty(this, "scene", {get:function() {
    return pc.Application._currentApplication.scene._stats;
  }});
  Object.defineProperty(this, "lightmapper", {get:function() {
    return pc.Application._currentApplication.lightmapper._stats;
  }});
  Object.defineProperty(this, "batcher", {get:function() {
    return pc.Application._currentApplication.batcher._stats;
  }});
  pc.events.attach(this);
};
pc.extend(pc, function() {
  var ComponentSystemRegistry = function() {
  };
  ComponentSystemRegistry.prototype = {add:function(name, system) {
    if (!this[name]) {
      this[name] = system;
      system.name = name;
    } else {
      throw new Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed", name));
    }
  }, remove:function(name) {
    if (!this[name]) {
      throw new Error(pc.string.format("No ComponentSystem named '{0}' registered", name));
    }
    delete this[name];
  }, list:function() {
    var list = Object.keys(this);
    var defaultPriority = 1;
    var priorities = {"collisionrect":0.5, "collisioncircle":0.5};
    list.sort(function(a, b) {
      var pa = priorities[a] || defaultPriority;
      var pb = priorities[b] || defaultPriority;
      if (pa < pb) {
        return -1;
      } else {
        if (pa > pb) {
          return 1;
        }
      }
      return 0;
    });
    return list.map(function(key) {
      return this[key];
    }, this);
  }, getComponentSystemOrder:function() {
    var index;
    var names = Object.keys(this);
    index = names.indexOf("collisionrect");
    names.splice(index, 1);
    names.unshift("collisionrect");
    index = names.indexOf("collisioncircle");
    names.splice(index, 1);
    names.unshift("collisioncircle");
    return names;
  }};
  return {ComponentSystemRegistry:ComponentSystemRegistry};
}());
pc.extend(pc, function() {
  var ComponentSystem = function(app) {
    this.app = app;
    this.dataStore = {};
    this.schema = [];
    pc.events.attach(this);
  };
  pc.extend(ComponentSystem, {initialize:function(root) {
    ComponentSystem.fire("initialize", root);
  }, postInitialize:function(root) {
    ComponentSystem.fire("postInitialize", root);
  }, update:function(dt, inTools) {
    if (inTools) {
      ComponentSystem.fire("toolsUpdate", dt);
    } else {
      ComponentSystem.fire("update", dt);
    }
  }, fixedUpdate:function(dt, inTools) {
    ComponentSystem.fire("fixedUpdate", dt);
  }, postUpdate:function(dt, inTools) {
    ComponentSystem.fire("postUpdate", dt);
  }});
  ComponentSystem.prototype = {get store() {
    return this.dataStore;
  }, addComponent:function(entity, data) {
    var component = new this.ComponentType(this, entity);
    var componentData = new this.DataType;
    data = data || {};
    this.dataStore[entity._guid] = {entity:entity, data:componentData};
    entity[this.id] = component;
    entity.c[this.id] = component;
    this.initializeComponentData(component, data, []);
    this.fire("add", entity, component);
    return component;
  }, removeComponent:function(entity) {
    var record = this.dataStore[entity._guid];
    var component = entity.c[this.id];
    this.fire("beforeremove", entity, component);
    delete this.dataStore[entity._guid];
    delete entity[this.id];
    delete entity.c[this.id];
    this.fire("remove", entity, record.data);
  }, cloneComponent:function(entity, clone) {
    var src = this.dataStore[entity._guid];
    return this.addComponent(clone, src.data);
  }, initializeComponentData:function(component, data, properties) {
    data = data || {};
    properties.forEach(function(value) {
      if (data[value] !== undefined) {
        component[value] = data[value];
      } else {
        component[value] = component.data[value];
      }
    }, this);
    if (component.enabled && component.entity.enabled) {
      component.onEnable();
    }
  }};
  pc.events.attach(ComponentSystem);
  ComponentSystem.destroy = function() {
    ComponentSystem.off("initialize");
    ComponentSystem.off("postInitialize");
    ComponentSystem.off("toolsUpdate");
    ComponentSystem.off("update");
    ComponentSystem.off("fixedUpdate");
    ComponentSystem.off("postUpdate");
  };
  return {ComponentSystem:ComponentSystem};
}());
pc.extend(pc, function() {
  var Component = function(system, entity) {
    this.system = system;
    this.entity = entity;
    pc.events.attach(this);
    if (this.system.schema && !this._accessorsBuilt) {
      this.buildAccessors(this.system.schema);
    }
    this.on("set", function(name, oldValue, newValue) {
      this.fire("set_" + name, name, oldValue, newValue);
    });
    this.on("set_enabled", this.onSetEnabled, this);
  };
  Component._buildAccessors = function(obj, schema) {
    schema.forEach(function(prop) {
      Object.defineProperty(obj, prop, {get:function() {
        return this.data[prop];
      }, set:function(value) {
        var data = this.data;
        var oldValue = data[prop];
        data[prop] = value;
        this.fire("set", prop, oldValue, value);
      }, configurable:true});
    });
    obj._accessorsBuilt = true;
  };
  Component.prototype = {get data() {
    var record = this.system.store[this.entity._guid];
    if (record) {
      return record.data;
    } else {
      return null;
    }
  }, buildAccessors:function(schema) {
    Component._buildAccessors(this, schema);
  }, onSetEnabled:function(name, oldValue, newValue) {
    if (oldValue !== newValue) {
      if (this.entity.enabled) {
        if (newValue) {
          this.onEnable();
        } else {
          this.onDisable();
        }
      }
    }
  }, onEnable:function() {
  }, onDisable:function() {
  }, onPostStateChange:function() {
  }};
  return {Component:Component};
}());
pc.extend(pc, function() {
  var ComponentData = function() {
  };
  return {ComponentData:ComponentData};
}());
pc.extend(pc, function() {
  var AnimationComponent = function(system, entity) {
    this.animationsIndex = {};
    this.on("set_animations", this.onSetAnimations, this);
    this.on("set_assets", this.onSetAssets, this);
    this.on("set_loop", this.onSetLoop, this);
  };
  AnimationComponent = pc.inherits(AnimationComponent, pc.Component);
  pc.extend(AnimationComponent.prototype, {play:function(name, blendTime) {
    if (!this.data.animations[name]) {
      console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist", name));
      return;
    }
    if (!this.enabled || !this.entity.enabled) {
      return;
    }
    blendTime = blendTime || 0;
    var data = this.data;
    data.prevAnim = data.currAnim;
    data.currAnim = name;
    if (data.model) {
      data.blending = blendTime > 0 && data.prevAnim;
      if (data.blending) {
        data.blendTime = blendTime;
        data.blendTimeRemaining = blendTime;
        data.fromSkel.animation = data.animations[data.prevAnim];
        data.fromSkel.addTime(data.skeleton._time);
        data.toSkel.animation = data.animations[data.currAnim];
      } else {
        data.skeleton.animation = data.animations[data.currAnim];
      }
    }
    data.playing = true;
  }, getAnimation:function(name) {
    return this.data.animations[name];
  }, setModel:function(model) {
    var data = this.data;
    if (model) {
      var graph = model.getGraph();
      data.fromSkel = new pc.Skeleton(graph);
      data.toSkel = new pc.Skeleton(graph);
      data.skeleton = new pc.Skeleton(graph);
      data.skeleton.looping = data.loop;
      data.skeleton.setGraph(graph);
    }
    data.model = model;
    if (data.animations && data.currAnim && data.animations[data.currAnim]) {
      this.play(data.currAnim);
    }
  }, loadAnimationAssets:function(ids) {
    if (!ids || !ids.length) {
      return;
    }
    var self = this;
    var assets = this.system.app.assets;
    var i, l = ids.length;
    var onAssetReady = function(asset) {
      self.animations[asset.name] = asset.resource;
      self.animationsIndex[asset.id] = asset.name;
      self.animations = self.animations;
    };
    var onAssetAdd = function(asset) {
      asset.off("change", self.onAssetChanged, self);
      asset.on("change", self.onAssetChanged, self);
      asset.off("remove", self.onAssetRemoved, self);
      asset.on("remove", self.onAssetRemoved, self);
      if (asset.resource) {
        onAssetReady(asset);
      } else {
        asset.once("load", onAssetReady, self);
        if (self.enabled && self.entity.enabled) {
          assets.load(asset);
        }
      }
    };
    for (i = 0;i < l;i++) {
      var asset = assets.get(ids[i]);
      if (asset) {
        onAssetAdd(asset);
      } else {
        assets.on("add:" + ids[i], onAssetAdd);
      }
    }
  }, onAssetChanged:function(asset, attribute, newValue, oldValue) {
    if (attribute === "resource") {
      if (newValue) {
        this.animations[asset.name] = newValue;
        this.animationsIndex[asset.id] = asset.name;
        if (this.data.currAnim === asset.name) {
          if (this.data.playing && this.data.enabled && this.entity.enabled) {
            this.play(asset.name, 0);
          }
        }
      } else {
        delete this.animations[asset.name];
        delete this.animationsIndex[asset.id];
      }
    }
  }, onAssetRemoved:function(asset) {
    asset.off("remove", this.onAssetRemoved, this);
    if (this.animations && this.animations[asset.name]) {
      delete this.animations[asset.name];
      delete this.animationsIndex[asset.id];
      if (this.data.currAnim === asset.name) {
        this._stopCurrentAnimation();
      }
    }
  }, _stopCurrentAnimation:function() {
    this.data.currAnim = null;
    this.data.playing = false;
    if (this.data.skeleton) {
      this.data.skeleton.currentTime = 0;
      this.data.skeleton.animation = null;
    }
  }, onSetAnimations:function(name, oldValue, newValue) {
    var data = this.data;
    var modelComponent = this.entity.model;
    if (modelComponent) {
      var m = modelComponent.model;
      if (m && m !== data.model) {
        this.entity.animation.setModel(m);
      }
    }
    if (!data.currAnim && data.activate && data.enabled && this.entity.enabled) {
      for (var animName in data.animations) {
        this.play(animName, 0);
        break;
      }
    }
  }, onSetAssets:function(name, oldValue, newValue) {
    if (oldValue && oldValue.length) {
      for (var i = 0;i < oldValue.length;i++) {
        if (oldValue[i]) {
          var asset = this.system.app.assets.get(oldValue[i]);
          if (asset) {
            asset.off("change", this.onAssetChanged, this);
            asset.off("remove", this.onAssetRemoved, this);
            var animName = this.animationsIndex[asset.id];
            if (this.data.currAnim === animName) {
              this._stopCurrentAnimation();
            }
            delete this.animations[animName];
            delete this.animationsIndex[asset.id];
          }
        }
      }
    }
    var ids = newValue.map(function(value) {
      if (value instanceof pc.Asset) {
        return value.id;
      } else {
        return value;
      }
    });
    this.loadAnimationAssets(ids);
  }, onSetLoop:function(name, oldValue, newValue) {
    if (this.data.skeleton) {
      this.data.skeleton.looping = this.data.loop;
    }
  }, onSetCurrentTime:function(name, oldValue, newValue) {
    this.data.skeleton.currentTime = newValue;
    this.data.skeleton.addTime(0);
    this.data.skeleton.updateGraph();
  }, onEnable:function() {
    AnimationComponent._super.onEnable.call(this);
    var assets = this.data.assets;
    var registry = this.system.app.assets;
    if (assets) {
      for (var i = 0, len = assets.length;i < len;i++) {
        var asset = assets[i];
        if (!(asset instanceof pc.Asset)) {
          asset = registry.get(asset);
        }
        if (asset && !asset.resource) {
          registry.load(asset);
        }
      }
    }
    if (this.data.activate && !this.data.currAnim) {
      for (var animName in this.data.animations) {
        this.play(animName, 0);
        break;
      }
    }
  }, onBeforeRemove:function() {
    for (var i = 0;i < this.assets.length;i++) {
      var asset = this.system.app.assets.get(this.assets[i]);
      if (!asset) {
        continue;
      }
      asset.off("change", this.onAssetChanged, this);
      asset.off("remove", this.onAssetRemoved, this);
    }
    delete this.data.animation;
    delete this.data.skeleton;
    delete this.data.fromSkel;
    delete this.data.toSkel;
  }});
  Object.defineProperties(AnimationComponent.prototype, {currentTime:{get:function() {
    return this.data.skeleton._time;
  }, set:function(currentTime) {
    this.data.skeleton.currentTime = currentTime;
    this.data.skeleton.addTime(0);
    this.data.skeleton.updateGraph();
  }}, duration:{get:function() {
    return this.data.animations[this.data.currAnim].duration;
  }}});
  return {AnimationComponent:AnimationComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "assets", "speed", "loop", "activate", "animations", "skeleton", "model", "prevAnim", "currAnim", "fromSkel", "toSkel", "blending", "blendTimeRemaining", "playing"];
  var AnimationComponentSystem = function AnimationComponentSystem(app) {
    this.id = "animation";
    this.description = "Specifies the animation assets that can run on the model specified by the Entity's model Component.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.AnimationComponent;
    this.DataType = pc.AnimationComponentData;
    this.schema = _schema;
    this.on("beforeremove", this.onBeforeRemove, this);
    this.on("update", this.onUpdate, this);
    pc.ComponentSystem.on("update", this.onUpdate, this);
  };
  AnimationComponentSystem = pc.inherits(AnimationComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.AnimationComponent.prototype, _schema);
  pc.extend(AnimationComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    properties = ["activate", "enabled", "loop", "speed", "assets"];
    AnimationComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, cloneComponent:function(entity, clone) {
    var key;
    var component = this.addComponent(clone, {});
    clone.animation.data.assets = pc.extend([], entity.animation.assets);
    clone.animation.data.speed = entity.animation.speed;
    clone.animation.data.loop = entity.animation.loop;
    clone.animation.data.activate = entity.animation.activate;
    clone.animation.data.enabled = entity.animation.enabled;
    var clonedAnimations = {};
    var animations = entity.animation.animations;
    for (key in animations) {
      if (animations.hasOwnProperty(key)) {
        clonedAnimations[key] = animations[key];
      }
    }
    clone.animation.animations = clonedAnimations;
    var clonedAnimationsIndex = {};
    var animationsIndex = entity.animation.animationsIndex;
    for (key in animationsIndex) {
      if (animationsIndex.hasOwnProperty(key)) {
        clonedAnimationsIndex[key] = animationsIndex[key];
      }
    }
    clone.animation.animationsIndex = clonedAnimationsIndex;
  }, onBeforeRemove:function(entity, component) {
    component.onBeforeRemove();
  }, onUpdate:function(dt) {
    var components = this.store;
    for (var id in components) {
      if (components.hasOwnProperty(id)) {
        var component = components[id];
        var componentData = component.data;
        if (componentData.enabled && componentData.playing && component.entity.enabled) {
          var skeleton = componentData.skeleton;
          if (skeleton !== null && componentData.model !== null) {
            if (componentData.blending) {
              componentData.blendTimeRemaining -= dt;
              if (componentData.blendTimeRemaining < 0.0) {
                componentData.blendTimeRemaining = 0.0;
              }
              var alpha = 1.0 - componentData.blendTimeRemaining / componentData.blendTime;
              skeleton.blend(componentData.fromSkel, componentData.toSkel, alpha);
            } else {
              var delta = dt * componentData.speed;
              skeleton.addTime(delta);
              if (skeleton._time === skeleton._animation.duration && !componentData.loop) {
                componentData.playing = false;
              }
            }
            if (componentData.blending && componentData.blendTimeRemaining === 0.0) {
              componentData.blending = false;
              skeleton.animation = componentData.toSkel._animation;
            }
            skeleton.updateGraph();
          }
        }
      }
    }
  }});
  return {AnimationComponentSystem:AnimationComponentSystem};
}());
pc.extend(pc, function() {
  var AnimationComponentData = function() {
    this.assets = [];
    this.speed = 1.0;
    this.loop = true;
    this.activate = true;
    this.enabled = true;
    this.animations = {};
    this.skeleton = null;
    this.model = null;
    this.prevAnim = null;
    this.currAnim = null;
    this.fromSkel = null;
    this.toSkel = null;
    this.blending = false;
    this.blendTime = 0;
    this.blendTimeRemaining = 0;
    this.playing = false;
  };
  AnimationComponentData = pc.inherits(AnimationComponentData, pc.ComponentData);
  return {AnimationComponentData:AnimationComponentData};
}());
pc.extend(pc, function() {
  var ModelComponent = function ModelComponent(system, entity) {
    this.on("set_type", this.onSetType, this);
    this.on("set_asset", this.onSetAsset, this);
    this.on("set_castShadows", this.onSetCastShadows, this);
    this.on("set_receiveShadows", this.onSetReceiveShadows, this);
    this.on("set_castShadowsLightmap", this.onSetCastShadowsLightmap, this);
    this.on("set_lightmapped", this.onSetLightmapped, this);
    this.on("set_lightmapSizeMultiplier", this.onSetLightmapSizeMultiplier, this);
    this.on("set_isStatic", this.onSetIsStatic, this);
    this.on("set_model", this.onSetModel, this);
    this.on("set_material", this.onSetMaterial, this);
    this.on("set_mapping", this.onSetMapping, this);
    this.on("set_batchGroupId", this.onSetBatchGroupId, this);
    Object.defineProperty(this, "materialAsset", {set:this.setMaterialAsset.bind(this), get:this.getMaterialAsset.bind(this)});
    this._assetOld = 0;
    this._materialEvents = null;
    this._dirtyModelAsset = false;
    this._dirtyMaterialAsset = false;
    this._clonedModel = false;
  };
  ModelComponent = pc.inherits(ModelComponent, pc.Component);
  pc.extend(ModelComponent.prototype, {setVisible:function(visible) {
    console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");
    this.enabled = visible;
  }, _onAssetLoad:function(asset) {
    if (asset.resource) {
      this._onModelLoaded(asset.resource.clone());
      this._clonedModel = true;
    }
  }, _onAssetUnload:function(asset) {
    if (!this.model) {
      return;
    }
    this.system.app.scene.removeModel(this.model);
    var device = this.system.app.graphicsDevice;
    this.model = null;
  }, _onAssetChange:function(asset, attribute, newValue, oldValue) {
    if (attribute === "data") {
      this.mapping = this.data.mapping;
    }
  }, _onAssetRemove:function(asset) {
    if (this.asset === asset.id) {
      this.asset = null;
    }
  }, _setModelAsset:function(id) {
    if (this._assetOld === id) {
      return;
    }
    var assets = this.system.app.assets;
    var asset = id !== null ? assets.get(id) : null;
    this._dirtyModelAsset = true;
    this._onModelAsset(asset || null);
    if (!asset && id !== null) {
      assets.once("add:" + id, this._onModelAsset, this);
    }
  }, _onModelAsset:function(asset) {
    var assets = this.system.app.assets;
    if (this._assetOld) {
      assets.off("add:" + this._assetOld, this._onModelAsset, this);
      var assetOld = assets.get(this._assetOld);
      if (assetOld) {
        assetOld.off("load", this._onAssetLoad, this);
        assetOld.off("unload", this._onAssetUnload, this);
        assetOld.off("change", this._onAssetChange, this);
        assetOld.off("remove", this._onAssetRemove, this);
      }
    }
    this._assetOld = asset ? asset.id : 0;
    if (asset) {
      asset.on("load", this._onAssetLoad, this);
      asset.on("unload", this._onAssetUnload, this);
      asset.on("change", this._onAssetChange, this);
      asset.on("remove", this._onAssetRemove, this);
      if (asset.resource) {
        this._dirtyModelAsset = false;
        this._onModelLoaded(asset.resource.clone());
        this._clonedModel = true;
      } else {
        if (this.enabled && this.entity.enabled) {
          this._dirtyModelAsset = false;
          assets.load(asset);
        }
      }
    } else {
      this._dirtyModelAsset = false;
    }
  }, remove:function() {
    this._onModelAsset(null);
  }, _onModelLoaded:function(model) {
    if (this.data.type === "asset") {
      this.model = model;
    }
  }, onSetType:function(name, oldValue, newValue) {
    var data = this.data;
    if (newValue) {
      var mesh = null;
      this._area = null;
      if (newValue === "asset") {
        if (this.data.asset !== null) {
          this._setModelAsset(this.data.asset);
        } else {
          this.model = null;
        }
      } else {
        switch(newValue) {
          case "box":
            mesh = this.system.box;
            this._area = {x:2, y:2, z:2, uv:2.0 / 3};
            break;
          case "capsule":
            mesh = this.system.capsule;
            this._area = {x:Math.PI * 2, y:Math.PI, z:Math.PI * 2, uv:1.0 / 3 + 1.0 / 3 / 3 * 2};
            break;
          case "sphere":
            mesh = this.system.sphere;
            this._area = {x:Math.PI, y:Math.PI, z:Math.PI, uv:1};
            break;
          case "cone":
            mesh = this.system.cone;
            this._area = {x:2.54, y:2.54, z:2.54, uv:1.0 / 3 + 1.0 / 3 / 3};
            break;
          case "cylinder":
            mesh = this.system.cylinder;
            this._area = {x:Math.PI, y:0.79 * 2, z:Math.PI, uv:1.0 / 3 + 1.0 / 3 / 3 * 2};
            break;
          case "plane":
            mesh = this.system.plane;
            this._area = {x:0, y:1, z:0, uv:1};
            break;
          default:
            throw new Error("Invalid model type: " + newValue);
        }
        var node = new pc.GraphNode;
        var model = new pc.Model;
        model.graph = node;
        model.meshInstances = [new pc.MeshInstance(node, mesh, data.material)];
        if (this.system._inTools) {
          model.generateWireframe();
        }
        this.model = model;
        this.asset = null;
      }
    }
  }, onSetAsset:function(name, oldValue, newValue) {
    var id = null;
    if (this.data.type === "asset") {
      if (newValue !== null) {
        id = newValue;
        if (newValue instanceof pc.Asset) {
          this.data.asset = newValue.id;
          id = newValue.id;
        }
      } else {
        this.model = null;
      }
    }
    if (id === null) {
      this.data.asset = null;
    }
    this._setModelAsset(id);
  }, onSetCastShadows:function(name, oldValue, newValue) {
    var model = this.data.model;
    if (model) {
      var scene = this.system.app.scene;
      var inScene = scene.containsModel(model);
      if (inScene && oldValue && !newValue) {
        scene.removeShadowCaster(model);
      }
      var meshInstances = model.meshInstances;
      for (var i = 0;i < meshInstances.length;i++) {
        meshInstances[i].castShadow = newValue;
      }
      if (inScene && !oldValue && newValue) {
        scene.addShadowCaster(model);
      }
    }
  }, onSetCastShadowsLightmap:function(name, oldValue, newValue) {
  }, onSetLightmapped:function(name, oldValue, newValue) {
    var i, m;
    if (this.data.model) {
      var rcv = this.data.model.meshInstances;
      if (newValue) {
        for (i = 0;i < rcv.length;i++) {
          m = rcv[i];
          m.mask = pc.MASK_BAKED;
        }
      } else {
        for (i = 0;i < rcv.length;i++) {
          m = rcv[i];
          m.deleteParameter("texture_lightMap");
          m.deleteParameter("texture_dirLightMap");
          m._shaderDefs &= ~pc.SHADERDEF_LM;
          m.mask = pc.MASK_DYNAMIC;
        }
      }
    }
  }, onSetLightmapSizeMultiplier:function(name, oldValue, newValue) {
    this.data.lightmapSizeMultiplier = newValue;
  }, onSetIsStatic:function(name, oldValue, newValue) {
    var i, m;
    if (this.data.model) {
      var rcv = this.data.model.meshInstances;
      for (i = 0;i < rcv.length;i++) {
        m = rcv[i];
        m.isStatic = newValue;
      }
    }
  }, onSetBatchGroupId:function(name, oldValue, newValue) {
    if (oldValue >= 0) {
      this.system.app.batcher._markGroupDirty(oldValue);
    }
    if (newValue >= 0) {
      this.system.app.batcher._markGroupDirty(newValue);
    }
    if (newValue < 0 && oldValue >= 0 && this.enabled && this.entity.enabled) {
      this.system.app.scene.addModel(this.model);
    }
  }, onSetModel:function(name, oldValue, newValue) {
    if (oldValue) {
      this.system.app.scene.removeModel(oldValue);
      this.entity.removeChild(oldValue.getGraph());
      delete oldValue._entity;
      if (this._clonedModel) {
        oldValue.destroy();
        this._clonedModel = false;
      }
    }
    if (newValue) {
      var componentData = this.data;
      var meshInstances = newValue.meshInstances;
      for (var i = 0;i < meshInstances.length;i++) {
        meshInstances[i].castShadow = componentData.castShadows;
        meshInstances[i].receiveShadow = componentData.receiveShadows;
      }
      this.lightmapped = componentData.lightmapped;
      this.isStatic = componentData.isStatic;
      this.entity.addChild(newValue.graph);
      if (this.enabled && this.entity.enabled) {
        this.system.app.scene.addModel(newValue);
      }
      newValue._entity = this.entity;
      if (this.entity.animation) {
        this.entity.animation.setModel(newValue);
      }
      if (this.data.type === "asset") {
        this.mapping = this.data.mapping;
      } else {
        this._unsetMaterialEvents();
      }
    } else {
      this._unsetMaterialEvents();
    }
  }, _onMaterialAssetRemove:function(asset) {
    var assets = this.system.app.assets;
    var id = isNaN(asset) ? asset.id : asset;
    if (asset && isNaN(asset) && asset.resource === this.material) {
      this.material = pc.ModelHandler.DEFAULT_MATERIAL;
    }
    assets.off("add:" + id, this._onMaterialAssetAdd, this);
    assets.off("load:" + id, this._onMaterialAssetLoad, this);
    assets.off("unload:" + id, this._onMaterialAssetUnload, this);
    assets.off("remove:" + id, this._onMaterialAssetRemove, this);
  }, _onMaterialAssetAdd:function(asset) {
    var assets = this.system.app.assets;
    if (asset.resource) {
      this.material = asset.resource;
      this._dirtyMaterialAsset = false;
    } else {
      if (this.enabled && this.entity.enabled) {
        this._dirtyMaterialAsset = false;
        assets.load(asset);
      }
    }
  }, _onMaterialAssetLoad:function(asset) {
    var assets = this.system.app.assets;
    if (asset.resource) {
      this.material = asset.resource;
      this._dirtyMaterialAsset = false;
    } else {
      if (this.enabled && this.entity.enabled) {
        this._dirtyMaterialAsset = false;
        assets.load(asset);
      }
    }
  }, _onMaterialAssetUnload:function(asset) {
    var assets = this.system.app.assets;
    var id = isNaN(asset) ? asset.id : asset;
    if (asset && isNaN(asset) && asset.resource === this.material) {
      this.material = pc.ModelHandler.DEFAULT_MATERIAL;
    }
  }, setMaterialAsset:function(value) {
    this._dirtyMaterialAsset = true;
    var id = typeof value === "number" || !value ? value : value.id;
    var assets = this.system.app.assets;
    var self = this;
    if (this.data.materialAsset !== id) {
      if (this.data.materialAsset) {
        this._onMaterialAssetRemove(this.data.materialAsset);
      }
      if (id) {
        assets.on("load:" + id, this._onMaterialAssetLoad, this);
        assets.on("unload:" + id, this._onMaterialAssetUnload, this);
        assets.on("remove:" + id, this._onMaterialAssetRemove, this);
      }
    }
    if (id !== undefined && id !== null) {
      var asset = assets.get(id);
      if (asset) {
        this._onMaterialAssetLoad(asset);
      }
      assets.once("add:" + id, this._onMaterialAssetAdd, this);
    } else {
      if (id === null) {
        self.material = pc.ModelHandler.DEFAULT_MATERIAL;
        self._dirtyMaterialAsset = false;
      }
    }
    var valueOld = this.data.materialAsset;
    this.data.materialAsset = id;
    this.fire("set", "materialAsset", valueOld, id);
  }, getMaterialAsset:function() {
    return this.system.app.assets.get(this.data.materialAsset);
  }, onSetMaterial:function(name, oldValue, newValue) {
    if (newValue !== oldValue) {
      this.data.material = newValue;
      if (this.data.model && this.data.type !== "asset") {
        var meshInstances = this.data.model.meshInstances;
        for (var i = 0;i < meshInstances.length;i++) {
          meshInstances[i].material = newValue;
        }
      }
    }
  }, onSetMapping:function(name, oldValue, newValue) {
    if (this.data.type !== "asset" || !this.data.model) {
      return;
    }
    this._unsetMaterialEvents();
    if (!newValue) {
      newValue = {};
    }
    var meshInstances = this.data.model.meshInstances;
    var modelAsset = this.asset ? this.system.app.assets.get(this.asset) : null;
    var assetMapping = modelAsset ? modelAsset.data.mapping : null;
    for (var i = 0, len = meshInstances.length;i < len;i++) {
      if (newValue[i] !== undefined) {
        if (newValue[i]) {
          this._loadAndSetMeshInstanceMaterial(newValue[i], meshInstances[i], i);
        } else {
          meshInstances[i].material = pc.ModelHandler.DEFAULT_MATERIAL;
        }
      } else {
        if (assetMapping) {
          if (assetMapping[i] && (assetMapping[i].material || assetMapping[i].path)) {
            var idOrPath = assetMapping[i].material || assetMapping[i].path;
            this._loadAndSetMeshInstanceMaterial(idOrPath, meshInstances[i], i);
          } else {
            meshInstances[i].material = pc.ModelHandler.DEFAULT_MATERIAL;
          }
        }
      }
    }
  }, _setMaterialEvent:function(index, event, id, handler) {
    var evt = event + ":" + id;
    this.system.app.assets.on(evt, handler, this);
    if (!this._materialEvents) {
      this._materialEvents = [];
    }
    if (!this._materialEvents[index]) {
      this._materialEvents[index] = {};
    }
    this._materialEvents[index][evt] = {id:id, handler:handler};
  }, _unsetMaterialEvents:function() {
    var assets = this.system.app.assets;
    var events = this._materialEvents;
    if (!events) {
      return;
    }
    for (var i = 0, len = events.length;i < len;i++) {
      if (!events[i]) {
        continue;
      }
      var evt = events[i];
      for (var key in evt) {
        assets.off(key, evt[key].handler, this);
      }
    }
    this._materialEvents = null;
  }, _getAssetByIdOrPath:function(idOrPath) {
    var asset = null;
    var isPath = isNaN(parseInt(idOrPath, 10));
    if (!isPath) {
      asset = this.system.app.assets.get(idOrPath);
    } else {
      if (this.asset) {
        var url = this._getMaterialAssetUrl(idOrPath);
        if (url) {
          asset = this.system.app.assets.getByUrl(url);
        }
      }
    }
    return asset;
  }, _getMaterialAssetUrl:function(path) {
    if (!this.asset) {
      return null;
    }
    var modelAsset = this.system.app.assets.get(this.asset);
    if (!modelAsset) {
      return null;
    }
    var fileUrl = modelAsset.getFileUrl();
    var dirUrl = pc.path.getDirectory(fileUrl);
    return pc.path.join(dirUrl, path);
  }, _loadAndSetMeshInstanceMaterial:function(idOrPath, meshInstance, index) {
    var self = this;
    var assets = this.system.app.assets;
    var asset = this._getAssetByIdOrPath(idOrPath);
    if (!asset) {
      return;
    }
    var handleMaterial = function(asset) {
      if (asset.resource) {
        meshInstance.material = asset.resource;
        self._setMaterialEvent(index, "remove", asset.id, function() {
          meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
        });
      } else {
        self._setMaterialEvent(index, "load", asset.id, function(asset) {
          meshInstance.material = asset.resource;
          self._setMaterialEvent(index, "remove", asset.id, function() {
            meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
          });
        });
        if (self.enabled && self.entity.enabled) {
          assets.load(asset);
        }
      }
    };
    if (asset) {
      handleMaterial(asset);
    } else {
      meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
      var isPath = isNaN(parseInt(idOrPath, 10));
      self._setMaterialEvent(index, isPath ? "add:url" : "add", idOrPath, handleMaterial);
    }
  }, onSetReceiveShadows:function(name, oldValue, newValue) {
    if (newValue !== undefined) {
      var componentData = this.data;
      if (componentData.model) {
        var meshInstances = componentData.model.meshInstances;
        for (var i = 0;i < meshInstances.length;i++) {
          meshInstances[i].receiveShadow = newValue;
        }
      }
    }
  }, onEnable:function() {
    ModelComponent._super.onEnable.call(this);
    var asset;
    var model = this.data.model;
    var isAsset = this.data.type === "asset";
    if (model) {
      var inScene = this.system.app.scene.containsModel(model);
      if (!inScene) {
        this.system.app.scene.addModel(model);
      }
    } else {
      if (isAsset && this._dirtyModelAsset) {
        asset = this.data.asset;
        if (!asset) {
          return;
        }
        asset = this.system.app.assets.get(asset);
        if (asset) {
          this._onModelAsset(asset);
        }
      }
    }
    if (this._dirtyMaterialAsset) {
      var materialAsset = this.data.materialAsset;
      if (materialAsset) {
        materialAsset = this.system.app.assets.get(materialAsset);
        if (materialAsset && !materialAsset.resource) {
          this._onMaterialAssetLoad(materialAsset);
        }
      }
    }
    if (isAsset) {
      var mapping = this.data.mapping;
      if (mapping) {
        for (var index in mapping) {
          if (mapping[index]) {
            asset = this._getAssetByIdOrPath(mapping[index]);
            if (asset && !asset.resource) {
              this.system.app.assets.load(asset);
            }
          }
        }
      }
    }
  }, onDisable:function() {
    ModelComponent._super.onDisable.call(this);
    var model = this.data.model;
    if (model) {
      var inScene = this.system.app.scene.containsModel(model);
      if (inScene) {
        this.system.app.scene.removeModel(model);
      }
    }
  }, hide:function() {
    var model = this.data.model;
    if (model) {
      var i, l;
      var instances = model.meshInstances;
      for (i = 0, l = instances.length;i < l;i++) {
        instances[i].visible = false;
      }
    }
  }, show:function() {
    var model = this.data.model;
    if (model) {
      var i, l;
      var instances = model.meshInstances;
      for (i = 0, l = instances.length;i < l;i++) {
        instances[i].visible = true;
      }
    }
  }});
  Object.defineProperty(ModelComponent.prototype, "meshInstances", {get:function() {
    if (!this.model) {
      return null;
    }
    return this.model.meshInstances;
  }, set:function(value) {
    if (!this.model) {
      return;
    }
    this.model.meshInstances = value;
  }});
  return {ModelComponent:ModelComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "type", "asset", "materialAsset", "castShadows", "receiveShadows", "castShadowsLightmap", "lightmapped", "lightmapSizeMultiplier", "isStatic", "material", "model", "mapping", "batchGroupId"];
  var ModelComponentSystem = function ModelComponentSystem(app) {
    this.id = "model";
    this.description = "Renders a 3D model at the location of the Entity.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.ModelComponent;
    this.DataType = pc.ModelComponentData;
    this.schema = _schema;
    var gd = app.graphicsDevice;
    this.box = pc.createBox(gd, {halfExtents:new pc.Vec3(0.5, 0.5, 0.5)});
    this.capsule = pc.createCapsule(gd, {radius:0.5, height:2});
    this.sphere = pc.createSphere(gd, {radius:0.5});
    this.cone = pc.createCone(gd, {baseRadius:0.5, peakRadius:0, height:1});
    this.cylinder = pc.createCylinder(gd, {radius:0.5, height:1});
    this.plane = pc.createPlane(gd, {halfExtents:new pc.Vec2(0.5, 0.5), widthSegments:1, lengthSegments:1});
    this.defaultMaterial = new pc.StandardMaterial;
    this.on("beforeremove", this.onRemove, this);
  };
  ModelComponentSystem = pc.inherits(ModelComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ModelComponent.prototype, _schema);
  pc.extend(ModelComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    data.material = this.defaultMaterial;
    if (data.batchGroupId === null || data.batchGroupId === undefined) {
      data.batchGroupId = -1;
    }
    properties = ["enabled", "material", "materialAsset", "asset", "castShadows", "receiveShadows", "castShadowsLightmap", "lightmapped", "lightmapSizeMultiplier", "type", "mapping", "isStatic", "batchGroupId"];
    ModelComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, removeComponent:function(entity) {
    var data = entity.model.data;
    entity.model.asset = null;
    if (data.type !== "asset" && data.model) {
      this.app.scene.removeModel(data.model);
      entity.removeChild(data.model.getGraph());
      data.model = null;
    }
    ModelComponentSystem._super.removeComponent.call(this, entity);
  }, cloneComponent:function(entity, clone) {
    var data = {type:entity.model.type, asset:entity.model.asset, castShadows:entity.model.castShadows, receiveShadows:entity.model.receiveShadows, castShadowsLightmap:entity.model.castShadowsLightmap, lightmapped:entity.model.lightmapped, lightmapSizeMultiplier:entity.model.lightmapSizeMultiplier, isStatic:entity.model.isStatic, enabled:entity.model.enabled, batchGroupId:entity.model.batchGroupId, mapping:pc.extend({}, entity.model.mapping)};
    var materialAsset = entity.model.materialAsset;
    if (!(materialAsset instanceof pc.Asset) && materialAsset != null) {
      materialAsset = this.app.assets.get(materialAsset);
    }
    var material = entity.model.material;
    if (!material || material === pc.ModelHandler.DEFAULT_MATERIAL || !materialAsset || material === materialAsset.resource) {
      data.materialAsset = materialAsset;
    }
    var component = this.addComponent(clone, data);
    if (!data.materialAsset) {
      component.material = material;
    }
    if (entity.model.model) {
      var meshInstances = entity.model.model.meshInstances;
      var meshInstancesClone = component.model.meshInstances;
      for (var i = 0;i < meshInstances.length;i++) {
        meshInstancesClone[i].mask = meshInstances[i].mask;
        meshInstancesClone[i].material = meshInstances[i].material;
        meshInstancesClone[i].layer = meshInstances[i].layer;
        meshInstancesClone[i].receiveShadow = meshInstances[i].receiveShadow;
      }
    }
  }, onRemove:function(entity, component) {
    component.remove();
  }});
  return {ModelComponentSystem:ModelComponentSystem};
}());
pc.extend(pc, function() {
  var ModelComponentData = function() {
    this.enabled = true;
    this.type = "asset";
    this.asset = null;
    this.castShadows = true;
    this.receiveShadows = true;
    this.materialAsset = null;
    this.mapping = null;
    this.castShadowsLightmap = true;
    this.lightmapped = false;
    this.lightmapSizeMultiplier = 1;
    this.isStatic = false;
    this.batchGroupId = -1;
    this.material = null;
    this.model = null;
  };
  ModelComponentData = pc.inherits(ModelComponentData, pc.ComponentData);
  return {ModelComponentData:ModelComponentData};
}());
pc.extend(pc, function() {
  var CameraComponent = function CameraComponent(system, entity) {
    this.on("set_aspectRatio", this.onSetAspectRatio, this);
    this.on("set_camera", this.onSetCamera, this);
    this.on("set_clearColor", this.onSetClearColor, this);
    this.on("set_fov", this.onSetFov, this);
    this.on("set_orthoHeight", this.onSetOrthoHeight, this);
    this.on("set_nearClip", this.onSetNearClip, this);
    this.on("set_farClip", this.onSetFarClip, this);
    this.on("set_projection", this.onSetProjection, this);
    this.on("set_priority", this.onSetPriority, this);
    this.on("set_clearColorBuffer", this.updateClearFlags, this);
    this.on("set_clearDepthBuffer", this.updateClearFlags, this);
    this.on("set_clearStencilBuffer", this.updateClearFlags, this);
    this.on("set_renderTarget", this.onSetRenderTarget, this);
    this.on("set_rect", this.onSetRect, this);
    this.on("set_scissorRect", this.onSetScissorRect, this);
    this.on("set_horizontalFov", this.onSetHorizontalFov, this);
    this.on("set_frustumCulling", this.onSetFrustumCulling, this);
    this.on("set_calculateTransform", this.onSetCalculateTransform, this);
    this.on("set_calculateProjection", this.onSetCalculateProjection, this);
    this.on("set_cullFaces", this.onSetCullFaces, this);
    this.on("set_flipFaces", this.onSetFlipFaces, this);
  };
  CameraComponent = pc.inherits(CameraComponent, pc.Component);
  Object.defineProperty(CameraComponent.prototype, "projectionMatrix", {get:function() {
    return this.data.camera.getProjectionMatrix();
  }});
  Object.defineProperty(CameraComponent.prototype, "viewMatrix", {get:function() {
    var wtm = this.data.camera._node.getWorldTransform();
    return wtm.clone().invert();
  }});
  Object.defineProperty(CameraComponent.prototype, "frustum", {get:function() {
    return this.data.camera.frustum;
  }});
  Object.defineProperty(CameraComponent.prototype, "vrDisplay", {get:function() {
    return this.data.camera.vrDisplay;
  }, set:function(value) {
    this.data.camera.vrDisplay = value;
    if (value) {
      value._camera = this.data.camera;
    }
  }});
  Object.defineProperty(CameraComponent.prototype, "node", {get:function() {
    return this.data.camera._node;
  }});
  pc.extend(CameraComponent.prototype, {screenToWorld:function(screenx, screeny, cameraz, worldCoord) {
    var device = this.system.app.graphicsDevice;
    return this.data.camera.screenToWorld(screenx, screeny, cameraz, device.clientRect.width, device.clientRect.height, worldCoord);
  }, worldToScreen:function(worldCoord, screenCoord) {
    var device = this.system.app.graphicsDevice;
    return this.data.camera.worldToScreen(worldCoord, device.clientRect.width, device.clientRect.height, screenCoord);
  }, onSetAspectRatio:function(name, oldValue, newValue) {
    this.data.camera.aspectRatio = newValue;
  }, onSetCamera:function(name, oldValue, newValue) {
    if (oldValue) {
      oldValue._node = null;
    }
    newValue._node = this.entity;
  }, onSetClearColor:function(name, oldValue, newValue) {
    this.data.camera.clearColor[0] = newValue.data[0];
    this.data.camera.clearColor[1] = newValue.data[1];
    this.data.camera.clearColor[2] = newValue.data[2];
    this.data.camera.clearColor[3] = newValue.data[3];
  }, onSetFov:function(name, oldValue, newValue) {
    this.data.camera.fov = newValue;
  }, onSetOrthoHeight:function(name, oldValue, newValue) {
    this.data.camera.orthoHeight = newValue;
  }, onSetNearClip:function(name, oldValue, newValue) {
    this.data.camera.nearClip = newValue;
  }, onSetFarClip:function(name, oldValue, newValue) {
    this.data.camera.farClip = newValue;
  }, onSetHorizontalFov:function(name, oldValue, newValue) {
    this.data.camera.horizontalFov = newValue;
  }, onSetFrustumCulling:function(name, oldValue, newValue) {
    this.data.camera.frustumCulling = newValue;
  }, onSetCalculateTransform:function(name, oldValue, newValue) {
    this._calculateTransform = newValue;
    this.camera.overrideCalculateTransform = !!newValue;
  }, onSetCalculateProjection:function(name, oldValue, newValue) {
    this._calculateProjection = newValue;
    this.camera._projMatDirty = true;
    this.camera.overrideCalculateProjection = !!newValue;
  }, onSetCullFaces:function(name, oldValue, newValue) {
    this.camera._cullFaces = newValue;
  }, onSetFlipFaces:function(name, oldValue, newValue) {
    this.camera._flipFaces = newValue;
  }, onSetProjection:function(name, oldValue, newValue) {
    this.data.camera.projection = newValue;
  }, onSetPriority:function(name, oldValue, newValue) {
    this.system.sortCamerasByPriority();
  }, updateClearFlags:function() {
    var flags = 0;
    if (this.clearColorBuffer) {
      flags = flags | pc.CLEARFLAG_COLOR;
    }
    if (this.clearDepthBuffer) {
      flags = flags | pc.CLEARFLAG_DEPTH;
    }
    if (this.clearStencilBuffer) {
      flags = flags | pc.CLEARFLAG_STENCIL;
    }
    this.data.camera.clearFlags = flags;
  }, onSetRenderTarget:function(name, oldValue, newValue) {
    this.data.camera.renderTarget = newValue;
  }, onSetRect:function(name, oldValue, newValue) {
    this.data.camera.setRect(newValue.data[0], newValue.data[1], newValue.data[2], newValue.data[3]);
    this._resetAspectRatio();
  }, onSetScissorRect:function(name, oldValue, newValue) {
    this.data.camera.setScissorRect(newValue.data[0], newValue.data[1], newValue.data[2], newValue.data[3]);
  }, onEnable:function() {
    CameraComponent._super.onEnable.call(this);
    this.system.addCamera(this);
    this.postEffects.enable();
  }, onDisable:function() {
    CameraComponent._super.onDisable.call(this);
    this.postEffects.disable();
    this.system.removeCamera(this);
  }, _resetAspectRatio:function() {
    var camera = this.camera;
    if (camera) {
      if (camera.renderTarget) {
        return;
      }
      var device = this.system.app.graphicsDevice;
      var rect = this.rect;
      this.aspectRatio = device.width * rect.z / (device.height * rect.w);
    }
  }, frameBegin:function() {
    this._resetAspectRatio();
    this.data.isRendering = true;
  }, frameEnd:function() {
    this.data.isRendering = false;
  }, enterVr:function(display, callback) {
    if (display instanceof Function && !callback) {
      callback = display;
      display = null;
    }
    if (!this.system.app.vr) {
      callback("VrManager not created. Enable VR in project settings.");
      return;
    }
    if (!display) {
      display = this.system.app.vr.display;
    }
    if (display) {
      var self = this;
      if (display.capabilities.canPresent) {
        display.requestPresent(function(err) {
          if (!err) {
            self.vrDisplay = display;
            self.vrDisplay.once("beforepresentchange", function(display) {
              if (!display.presenting) {
                self.vrDisplay = null;
              }
            });
          }
          callback(err);
        });
      } else {
        self.vrDisplay = display;
        callback();
      }
    } else {
      callback("No pc.VrDisplay to present");
    }
  }, exitVr:function(callback) {
    if (this.vrDisplay) {
      if (this.vrDisplay.capabilities.canPresent) {
        var display = this.vrDisplay;
        this.vrDisplay = null;
        display.exitPresent(callback);
      } else {
        this.vrDisplay = null;
        callback();
      }
    } else {
      callback("Not presenting VR");
    }
  }});
  return {CameraComponent:CameraComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "clearColorBuffer", "clearColor", "clearDepthBuffer", "clearStencilBuffer", "frustumCulling", "projection", "fov", "orthoHeight", "nearClip", "farClip", "priority", "rect", "scissorRect", "camera", "aspectRatio", "horizontalFov", "model", "renderTarget", "calculateTransform", "calculateProjection", "cullFaces", "flipFaces"];
  var CameraComponentSystem = function(app) {
    this.id = "camera";
    this.description = "Renders the scene from the location of the Entity.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.CameraComponent;
    this.DataType = pc.CameraComponentData;
    this.schema = _schema;
    this.cameras = [];
    this.on("beforeremove", this.onBeforeRemove, this);
    this.on("remove", this.onRemove, this);
    pc.ComponentSystem.on("update", this.onUpdate, this);
  };
  CameraComponentSystem = pc.inherits(CameraComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.CameraComponent.prototype, _schema);
  pc.extend(CameraComponentSystem.prototype, {initializeComponentData:function(component, _data, properties) {
    properties = ["postEffects", "enabled", "model", "camera", "aspectRatio", "horizontalFov", "renderTarget", "clearColor", "fov", "orthoHeight", "nearClip", "farClip", "projection", "priority", "clearColorBuffer", "clearDepthBuffer", "clearStencilBuffer", "frustumCulling", "rect", "scissorRect", "calculateTransform", "calculateProjection", "cullFaces", "flipFaces"];
    var data = {};
    properties.forEach(function(prop) {
      data[prop] = _data[prop];
    });
    if (data.clearColor && pc.type(data.clearColor) === "array") {
      var c = data.clearColor;
      data.clearColor = new pc.Color(c[0], c[1], c[2], c[3]);
    }
    if (data.rect && pc.type(data.rect) === "array") {
      var rect = data.rect;
      data.rect = new pc.Vec4(rect[0], rect[1], rect[2], rect[3]);
    }
    if (data.scissorRect && pc.type(data.scissorRect) === "array") {
      var scissorRect = data.scissorRect;
      data.scissorRect = new pc.Vec4(scissorRect[0], scissorRect[1], scissorRect[2], scissorRect[3]);
    }
    if (data.activate) {
      console.warn("WARNING: activate: Property is deprecated. Set enabled property instead.");
      data.enabled = data.activate;
    }
    data.camera = new pc.Camera;
    data._node = component.entity;
    var self = component;
    data.camera.calculateTransform = function(mat, mode) {
      if (!self._calculateTransform) {
        return null;
      }
      return self._calculateTransform(mat, mode);
    };
    data.camera.calculateProjection = function(mat, mode) {
      if (!self._calculateProjection) {
        return null;
      }
      return self._calculateProjection(mat, mode);
    };
    data.postEffects = new pc.PostEffectQueue(this.app, component);
    CameraComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, onBeforeRemove:function(entity, component) {
    this.removeCamera(component);
  }, onRemove:function(entity, data) {
    data.camera = null;
  }, onUpdate:function(dt) {
    var components = this.store;
    var component, componentData, cam, vrDisplay;
    if (this.app.vr) {
      for (var id in components) {
        component = components[id];
        componentData = component.data;
        cam = componentData.camera;
        vrDisplay = cam.vrDisplay;
        if (componentData.enabled && component.entity.enabled && vrDisplay) {
          vrDisplay.setClipPlanes(cam._nearClip, cam._farClip);
          if (cam._node) {
            cam._node.localTransform.copy(vrDisplay.combinedViewInv);
            cam._node._dirtyLocal = false;
            cam._node._dirtify();
          }
        }
      }
    }
  }, addCamera:function(camera) {
    this.cameras.push(camera);
    this.sortCamerasByPriority();
  }, removeCamera:function(camera) {
    var index = this.cameras.indexOf(camera);
    if (index >= 0) {
      this.cameras.splice(index, 1);
      this.sortCamerasByPriority();
    }
  }, sortCamerasByPriority:function() {
    this.cameras.sort(function(a, b) {
      return a.priority - b.priority;
    });
  }});
  return {CameraComponentSystem:CameraComponentSystem};
}());
pc.extend(pc, function() {
  var CameraComponentData = function() {
    this.clearColor = new pc.Color(0.722, 0.722, 0.722, 1);
    this.clearColorBuffer = true;
    this.clearDepthBuffer = true;
    this.clearStencilBuffer = true;
    this.nearClip = 0.1;
    this.farClip = 1000;
    this.fov = 45;
    this.orthoHeight = 100;
    this.projection = pc.PROJECTION_PERSPECTIVE;
    this.priority = 0;
    this.rect = new pc.Vec4(0, 0, 1, 1);
    this.scissorRect = new pc.Vec4(0, 0, 1, 1);
    this.enabled = true;
    this.frustumCulling = false;
    this.cullFaces = true;
    this.flipFaces = false;
    this.camera = null;
    this.aspectRatio = 16 / 9;
    this.renderTarget = null;
    this.postEffects = null;
    this.isRendering = false;
    this.calculateTransform = null;
    this.calculateProjection = null;
  };
  CameraComponentData = pc.inherits(CameraComponentData, pc.ComponentData);
  return {CameraComponentData:CameraComponentData};
}());
pc.extend(pc, function() {
  function PostEffectQueue(app, camera) {
    var self = this;
    this.app = app;
    this.camera = camera;
    this.effects = [];
    this.enabled = false;
    this.depthTarget = null;
    this.renderTargetScale = 1;
    this.resizeTimeout = null;
    this.resizeLast = 0;
    this._resizeTimeoutCallback = function() {
      self.resizeRenderTargets();
    };
    camera.on("set_rect", this.onCameraRectChanged, this);
  }
  PostEffectQueue.prototype = {_createOffscreenTarget:function(useDepth, hdr) {
    var rect = this.camera.rect;
    var width = Math.floor(rect.z * this.app.graphicsDevice.width * this.renderTargetScale);
    var height = Math.floor(rect.w * this.app.graphicsDevice.height * this.renderTargetScale);
    var device = this.app.graphicsDevice;
    var format = hdr ? device.getHdrFormat() : pc.PIXELFORMAT_R8_G8_B8_A8;
    var colorBuffer = new pc.Texture(device, {format:format, width:width, height:height});
    colorBuffer.minFilter = pc.FILTER_NEAREST;
    colorBuffer.magFilter = pc.FILTER_NEAREST;
    colorBuffer.addressU = pc.ADDRESS_CLAMP_TO_EDGE;
    colorBuffer.addressV = pc.ADDRESS_CLAMP_TO_EDGE;
    return new pc.RenderTarget(this.app.graphicsDevice, colorBuffer, {depth:useDepth});
  }, setRenderTargetScale:function(scale) {
    this.renderTargetScale = scale;
    this.resizeRenderTargets();
  }, addEffect:function(effect) {
    var isFirstEffect = this.effects.length === 0;
    var effects = this.effects;
    var newEntry = {effect:effect, inputTarget:this._createOffscreenTarget(isFirstEffect, effect.hdr), outputTarget:null};
    if (isFirstEffect) {
      this.camera.renderTarget = newEntry.inputTarget;
    }
    effects.push(newEntry);
    var len = effects.length;
    if (len > 1) {
      effects[len - 2].outputTarget = newEntry.inputTarget;
    }
    this.enable();
  }, removeEffect:function(effect) {
    var index = -1;
    for (var i = 0, len = this.effects.length;i < len;i++) {
      if (this.effects[i].effect === effect) {
        index = i;
        break;
      }
    }
    if (index >= 0) {
      if (index > 0) {
        this.effects[index - 1].outputTarget = index + 1 < this.effects.length ? this.effects[index + 1].inputTarget : null;
      } else {
        if (this.effects.length > 1) {
          if (!this.effects[1].inputTarget._depth) {
            this.effects[1].inputTarget.destroy();
            this.effects[1].inputTarget = this._createOffscreenTarget(true, this.effects[1].hdr);
          }
          this.camera.renderTarget = this.effects[1].inputTarget;
        }
      }
      this.effects[index].inputTarget.destroy();
      this.effects.splice(index, 1);
    }
    if (this.enabled) {
      if (effect.needsDepthBuffer) {
        this.camera.releaseDepthMap();
      }
    }
    if (this.effects.length === 0) {
      this.disable();
    }
  }, requestDepthMap:function() {
    for (var i = 0, len = this.effects.length;i < len;i++) {
      var effect = this.effects[i].effect;
      if (effect.needsDepthBuffer) {
        this.camera.camera.requestDepthMap();
      }
    }
  }, releaseDepthMap:function() {
    for (var i = 0, len = this.effects.length;i < len;i++) {
      var effect = this.effects[i].effect;
      if (effect.needsDepthBuffer) {
        this.camera.releaseDepthMap();
      }
    }
  }, destroy:function() {
    for (var i = 0, len = this.effects.length;i < len;i++) {
      this.effects[i].inputTarget.destroy();
    }
    this.effects.length = 0;
    this.disable();
  }, enable:function() {
    if (!this.enabled && this.effects.length) {
      this.enabled = true;
      var self = this;
      this.requestDepthMap();
      this.app.graphicsDevice.on("resizecanvas", this._onCanvasResized, this);
      self.camera.camera.setRect(0, 0, 1, 1);
      this.command = new pc.Command(pc.LAYER_FX, pc.BLEND_NONE, function() {
        if (self.enabled && self.camera.data.isRendering) {
          var rect = null;
          var len = self.effects.length;
          if (len) {
            self.camera.renderTarget = self.effects[0].inputTarget;
            self.depthTarget = self.camera.camera._depthTarget;
            for (var i = 0;i < len;i++) {
              var fx = self.effects[i];
              if (self.depthTarget) {
                fx.effect.depthMap = self.depthTarget.colorBuffer;
              }
              if (i === len - 1) {
                rect = self.camera.rect;
              }
              fx.effect.render(fx.inputTarget, fx.outputTarget, rect);
            }
          }
        }
      });
      this.app.scene.drawCalls.push(this.command);
    }
  }, disable:function() {
    if (this.enabled) {
      this.enabled = false;
      this.app.graphicsDevice.off("resizecanvas", this._onCanvasResized, this);
      this.camera.renderTarget = null;
      this.releaseDepthMap();
      var rect = this.camera.rect;
      this.camera.camera.setRect(rect.x, rect.y, rect.z, rect.w);
      var i = this.app.scene.drawCalls.indexOf(this.command);
      if (i >= 0) {
        this.app.scene.drawCalls.splice(i, 1);
      }
    }
  }, _onCanvasResized:function(width, height) {
    var rect = this.camera.rect;
    var device = this.app.graphicsDevice;
    this.camera.camera.aspectRatio = device.width * rect.z / (device.height * rect.w);
    if (this.resizeTimeout) {
      return;
    }
    if (pc.now() - this.resizeLast > 100) {
      this.resizeRenderTargets();
    } else {
      this.resizeTimeout = setTimeout(this._resizeTimeoutCallback, 100);
    }
  }, resizeRenderTargets:function() {
    if (this.resizeTimeout) {
      clearTimeout(this.resizeTimeout);
      this.resizeTimeout = null;
    }
    this.resizeLast = pc.now();
    var rect = this.camera.rect;
    var desiredWidth = Math.floor(rect.z * this.app.graphicsDevice.width * this.renderTargetScale);
    var desiredHeight = Math.floor(rect.w * this.app.graphicsDevice.height * this.renderTargetScale);
    var effects = this.effects;
    for (var i = 0, len = effects.length;i < len;i++) {
      var fx = effects[i];
      if (fx.inputTarget.width !== desiredWidth || fx.inputTarget.height !== desiredHeight) {
        fx.inputTarget.destroy();
        fx.inputTarget = this._createOffscreenTarget(fx.effect.needsDepthBuffer || i === 0, fx.hdr);
        if (i > 0) {
          effects[i - 1].outputTarget = fx.inputTarget;
        } else {
          this.camera.renderTarget = fx.inputTarget;
        }
      }
    }
  }, onCameraRectChanged:function(name, oldValue, newValue) {
    if (this.enabled) {
      this.camera.camera.setRect(0, 0, 1, 1);
      this.resizeRenderTargets();
    }
  }};
  return {PostEffectQueue:PostEffectQueue};
}());
pc.extend(pc, function() {
  var _props = [];
  var _propsDefault = [];
  function _defineProperty(name, defaultValue, setFunc, skipEqualsCheck) {
    var c = LightComponent.prototype;
    _props.push(name);
    _propsDefault.push(defaultValue);
    Object.defineProperty(c, name, {get:function() {
      return this.data[name];
    }, set:function(value) {
      var data = this.data;
      var oldValue = data[name];
      if (!skipEqualsCheck && oldValue === value) {
        return;
      }
      data[name] = value;
      if (setFunc) {
        setFunc.call(this, value, oldValue);
      }
    }, configurable:true});
  }
  var LightComponent = function LightComponent(system, entity) {
    this._cookieAsset = null;
    this._cookieAssetId = null;
    this._cookieAssetAdd = false;
    this._cookieMatrix = null;
  };
  LightComponent = pc.inherits(LightComponent, pc.Component);
  var _defineProps = function(c, d, s) {
    _defineProperty("enabled", true, function(newValue, oldValue) {
      this.onSetEnabled(null, oldValue, newValue);
    });
    _defineProperty("light", null);
    _defineProperty("type", "directional", function(newValue, oldValue) {
      this.system.changeType(this, oldValue, newValue);
      this.refreshProperties();
    });
    _defineProperty("color", new pc.Color(1, 1, 1), function(newValue, oldValue) {
      this.light.setColor(newValue);
    }, true);
    _defineProperty("intensity", 1, function(newValue, oldValue) {
      this.light.intensity = newValue;
    });
    _defineProperty("castShadows", false, function(newValue, oldValue) {
      this.light.castShadows = newValue;
    });
    _defineProperty("shadowDistance", 40, function(newValue, oldValue) {
      this.light.shadowDistance = newValue;
    });
    _defineProperty("shadowResolution", 1024, function(newValue, oldValue) {
      this.light.shadowResolution = newValue;
    });
    _defineProperty("shadowBias", 0.05, function(newValue, oldValue) {
      this.light.shadowBias = -0.01 * newValue;
    });
    _defineProperty("normalOffsetBias", 0, function(newValue, oldValue) {
      this.light.normalOffsetBias = newValue;
    });
    _defineProperty("range", 10, function(newValue, oldValue) {
      this.light.attenuationEnd = newValue;
    });
    _defineProperty("innerConeAngle", 40, function(newValue, oldValue) {
      this.light.innerConeAngle = newValue;
    });
    _defineProperty("outerConeAngle", 45, function(newValue, oldValue) {
      this.light.outerConeAngle = newValue;
    });
    _defineProperty("falloffMode", pc.LIGHTFALLOFF_LINEAR, function(newValue, oldValue) {
      this.light.falloffMode = newValue;
    });
    _defineProperty("shadowType", pc.SHADOW_PCF3, function(newValue, oldValue) {
      this.light.shadowType = newValue;
    });
    _defineProperty("vsmBlurSize", 11, function(newValue, oldValue) {
      this.light.vsmBlurSize = newValue;
    });
    _defineProperty("vsmBlurMode", pc.BLUR_GAUSSIAN, function(newValue, oldValue) {
      this.light.vsmBlurMode = newValue;
    });
    _defineProperty("vsmBias", 0.01 * 0.25, function(newValue, oldValue) {
      this.light.vsmBias = newValue;
    });
    _defineProperty("cookieAsset", null, function(newValue, oldValue) {
      if (this._cookieAssetId && (newValue instanceof pc.Asset && newValue.id === this._cookieAssetId || newValue === this._cookieAssetId)) {
        return;
      }
      this.onCookieAssetRemove();
      this._cookieAssetId = null;
      if (newValue instanceof pc.Asset) {
        this.data.cookieAsset = newValue.id;
        this._cookieAssetId = newValue.id;
        this.onCookieAssetAdd(newValue);
      } else {
        if (typeof newValue === "number") {
          this._cookieAssetId = newValue;
          var asset = this.system.app.assets.get(newValue);
          if (asset) {
            this.onCookieAssetAdd(asset);
          } else {
            this._cookieAssetAdd = true;
            this.system.app.assets.on("add:" + this._cookieAssetId, this.onCookieAssetAdd, this);
          }
        }
      }
    });
    _defineProperty("cookie", null, function(newValue, oldValue) {
      this.light.cookie = newValue;
    });
    _defineProperty("cookieIntensity", 1, function(newValue, oldValue) {
      this.light.cookieIntensity = newValue;
    });
    _defineProperty("cookieFalloff", true, function(newValue, oldValue) {
      this.light.cookieFalloff = newValue;
    });
    _defineProperty("cookieChannel", "rgb", function(newValue, oldValue) {
      this.light.cookieChannel = newValue;
    });
    _defineProperty("cookieAngle", 0, function(newValue, oldValue) {
      if (newValue !== 0 || this.cookieScale !== null) {
        if (!this._cookieMatrix) {
          this._cookieMatrix = new pc.Vec4;
        }
        var scx = 1;
        var scy = 1;
        if (this.cookieScale) {
          scx = this.cookieScale.x;
          scy = this.cookieScale.y;
        }
        var c = Math.cos(newValue * pc.math.DEG_TO_RAD);
        var s = Math.sin(newValue * pc.math.DEG_TO_RAD);
        this._cookieMatrix.set(c / scx, -s / scx, s / scy, c / scy);
        this.light.cookieTransform = this._cookieMatrix;
      } else {
        this.light.cookieTransform = null;
      }
    });
    _defineProperty("cookieScale", null, function(newValue, oldValue) {
      if (newValue !== null || this.cookieAngle !== 0) {
        if (!this._cookieMatrix) {
          this._cookieMatrix = new pc.Vec4;
        }
        var scx = newValue.x;
        var scy = newValue.y;
        var c = Math.cos(this.cookieAngle * pc.math.DEG_TO_RAD);
        var s = Math.sin(this.cookieAngle * pc.math.DEG_TO_RAD);
        this._cookieMatrix.set(c / scx, -s / scx, s / scy, c / scy);
        this.light.cookieTransform = this._cookieMatrix;
      } else {
        this.light.cookieTransform = null;
      }
    }, true);
    _defineProperty("cookieOffset", null, function(newValue, oldValue) {
      this.light.cookieOffset = newValue;
    }, true);
    _defineProperty("shadowUpdateMode", pc.SHADOWUPDATE_REALTIME, function(newValue, oldValue) {
      this.light.shadowUpdateMode = newValue;
    });
    _defineProperty("mask", 1, function(newValue, oldValue) {
      this.light.mask = newValue;
    });
    _defineProperty("affectDynamic", true, function(newValue, oldValue) {
      if (newValue) {
        this.light.mask |= pc.MASK_DYNAMIC;
      } else {
        this.light.mask &= ~pc.MASK_DYNAMIC;
      }
      this.light.mask = this.light._mask;
    });
    _defineProperty("affectLightmapped", false, function(newValue, oldValue) {
      if (newValue) {
        this.light.mask |= pc.MASK_BAKED;
        if (this.bake) {
          this.light.mask &= ~pc.MASK_LIGHTMAP;
        }
      } else {
        this.light.mask &= ~pc.MASK_BAKED;
        if (this.bake) {
          this.light.mask |= pc.MASK_LIGHTMAP;
        }
      }
      this.light.mask = this.light._mask;
    });
    _defineProperty("bake", false, function(newValue, oldValue) {
      if (newValue) {
        this.light.mask |= pc.MASK_LIGHTMAP;
        if (this.affectLightmapped) {
          this.light.mask &= ~pc.MASK_BAKED;
        }
      } else {
        this.light.mask &= ~pc.MASK_LIGHTMAP;
        if (this.affectLightmapped) {
          this.light.mask |= pc.MASK_BAKED;
        }
      }
      this.light.mask = this.light._mask;
    });
    _defineProperty("bakeDir", true, function(newValue, oldValue) {
      this.light.bakeDir = newValue;
    });
    _defineProperty("isStatic", false, function(newValue, oldValue) {
      this.light.isStatic = newValue;
    });
  };
  _defineProps();
  Object.defineProperty(LightComponent.prototype, "enable", {get:function() {
    console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");
    return this.enabled;
  }, set:function(value) {
    console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");
    this.enabled = value;
  }});
  pc.extend(LightComponent.prototype, {refreshProperties:function() {
    var name;
    for (var i = 0;i < _props.length;i++) {
      name = _props[i];
      this[name] = this[name];
    }
    if (this.enabled && this.entity.enabled) {
      this.onEnable();
    }
  }, updateShadow:function() {
    this.light.updateShadow();
  }, onCookieAssetSet:function() {
    var forceLoad = false;
    if (this._cookieAsset.type === "cubemap" && !this._cookieAsset.loadFaces) {
      this._cookieAsset.loadFaces = true;
      forceLoad = true;
    }
    if (!this._cookieAsset.resource || forceLoad) {
      this.system.app.assets.load(this._cookieAsset);
    }
    if (this._cookieAsset.resource) {
      this.onCookieAssetLoad();
    }
  }, onCookieAssetAdd:function(asset) {
    if (this._cookieAssetId !== asset.id) {
      return;
    }
    this._cookieAsset = asset;
    if (this.light._enabled) {
      this.onCookieAssetSet();
    }
    this._cookieAsset.on("load", this.onCookieAssetLoad, this);
    this._cookieAsset.on("remove", this.onCookieAssetRemove, this);
  }, onCookieAssetLoad:function() {
    if (!this._cookieAsset || !this._cookieAsset.resource) {
      return;
    }
    this.cookie = this._cookieAsset.resource;
  }, onCookieAssetRemove:function() {
    if (!this._cookieAssetId) {
      return;
    }
    if (this._cookieAssetAdd) {
      this.system.app.assets.off("add:" + this._cookieAssetId, this.onCookieAssetAdd, this);
      this._cookieAssetAdd = false;
    }
    if (this._cookieAsset) {
      this._cookieAsset.off("load", this.onCookieAssetLoad, this);
      this._cookieAsset.off("remove", this.onCookieAssetRemove, this);
      this._cookieAsset = null;
    }
    this.cookie = null;
  }, onEnable:function() {
    LightComponent._super.onEnable.call(this);
    this.light.enabled = true;
    if (this._cookieAsset && !this.cookie) {
      this.onCookieAssetSet();
    }
  }, onDisable:function() {
    LightComponent._super.onDisable.call(this);
    this.light.enabled = false;
  }});
  return {LightComponent:LightComponent, _lightProps:_props, _lightPropsDefault:_propsDefault};
}());
pc.extend(pc, function() {
  var lightTypes = {"directional":pc.LIGHTTYPE_DIRECTIONAL, "point":pc.LIGHTTYPE_POINT, "spot":pc.LIGHTTYPE_SPOT};
  var LightComponentSystem = function(app) {
    this.id = "light";
    this.description = "Enables the Entity to emit light.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.LightComponent;
    this.DataType = pc.LightComponentData;
    this.on("remove", this.onRemove, this);
  };
  LightComponentSystem = pc.inherits(LightComponentSystem, pc.ComponentSystem);
  pc.extend(LightComponentSystem.prototype, {initializeComponentData:function(component, _data) {
    var data = {};
    var _props = pc._lightProps;
    var name;
    for (var i = 0;i < _props.length;i++) {
      name = _props[i];
      data[name] = _data[name];
    }
    if (!data.type) {
      data.type = component.data.type;
    }
    component.data.type = data.type;
    if (data.color && pc.type(data.color) === "array") {
      data.color = new pc.Color(data.color[0], data.color[1], data.color[2]);
    }
    if (data.cookieOffset && data.cookieOffset instanceof Array) {
      data.cookieOffset = new pc.Vec2(data.cookieOffset[0], data.cookieOffset[1]);
    }
    if (data.cookieScale && data.cookieScale instanceof Array) {
      data.cookieScale = new pc.Vec2(data.cookieScale[0], data.cookieScale[1]);
    }
    if (data.enable) {
      console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");
      data.enabled = data.enable;
    }
    var light = new pc.Light;
    light.type = lightTypes[data.type];
    light._node = component.entity;
    this.app.scene.addLight(light);
    component.data.light = light;
    LightComponentSystem._super.initializeComponentData.call(this, component, data, _props);
  }, onRemove:function(entity, data) {
    this.app.scene.removeLight(data.light);
  }, cloneComponent:function(entity, clone) {
    var light = entity.light;
    var data = [];
    var name;
    var _props = pc._lightProps;
    for (var i = 0;i < _props.length;i++) {
      name = _props[i];
      if (name === "light") {
        continue;
      }
      if (light[name] && light[name].clone) {
        data[name] = light[name].clone();
      } else {
        data[name] = light[name];
      }
    }
    this.addComponent(clone, data);
  }, changeType:function(component, oldValue, newValue) {
    if (oldValue !== newValue) {
      component.light.type = lightTypes[newValue];
    }
  }});
  return {LightComponentSystem:LightComponentSystem};
}());
pc.extend(pc, function() {
  var LightComponentData = function() {
    var _props = pc._lightProps;
    var _propsDefault = pc._lightPropsDefault;
    var value;
    for (var i = 0;i < _props.length;i++) {
      value = _propsDefault[i];
      if (value && value.clone) {
        this[_props[i]] = value.clone();
      } else {
        this[_props[i]] = value;
      }
    }
  };
  LightComponentData = pc.inherits(LightComponentData, pc.ComponentData);
  return {LightComponentData:LightComponentData};
}());
pc.extend(pc, function() {
  var ScriptComponent = function ScriptComponent(system, entity) {
    this._scripts = [];
    this._scriptsIndex = {};
    this._scriptsData = null;
    this._oldState = true;
    this.on("set_enabled", this._onSetEnabled, this);
  };
  ScriptComponent = pc.inherits(ScriptComponent, pc.Component);
  ScriptComponent.scriptMethods = {initialize:"initialize", postInitialize:"postInitialize", update:"update", postUpdate:"postUpdate", swap:"swap"};
  pc.extend(ScriptComponent.prototype, {onEnable:function() {
    ScriptComponent._super.onEnable.call(this);
    this._checkState();
  }, onDisable:function() {
    ScriptComponent._super.onDisable.call(this);
    this._checkState();
  }, onPostStateChange:function() {
    var script;
    for (var i = 0;i < this.scripts.length;i++) {
      script = this.scripts[i];
      if (script._initialized && !script._postInitialized) {
        script._postInitialized = true;
        if (script.postInitialize) {
          this._scriptMethod(script, ScriptComponent.scriptMethods.postInitialize);
        }
      }
    }
  }, _onSetEnabled:function(prop, old, value) {
    this._checkState();
  }, _checkState:function() {
    var state = this.enabled && this.entity.enabled;
    if (state === this._oldState) {
      return;
    }
    this._oldState = state;
    this.fire(this.enabled ? "enable" : "disable");
    this.fire("state", this.enabled);
    var script;
    for (var i = 0, len = this.scripts.length;i < len;i++) {
      script = this.scripts[i];
      script.enabled = script._enabled;
      if (!script._initialized && script.enabled) {
        script._initialized = true;
        script.__initializeAttributes(true);
        if (script.initialize) {
          this._scriptMethod(script, ScriptComponent.scriptMethods.initialize);
        }
      }
    }
  }, _onBeforeRemove:function() {
    this.fire("remove");
    var destroyed = true;
    while (this.scripts.length > 0 && destroyed) {
      destroyed = this.destroy(this.scripts[0].__scriptType.__name);
    }
  }, _onInitializeAttributes:function() {
    for (var i = 0, len = this.scripts.length;i < len;i++) {
      this.scripts[i].__initializeAttributes();
    }
  }, _scriptMethod:function(script, method, arg) {
    try {
      script[method](arg);
    } catch (ex) {
      script.enabled = false;
      if (!script._callbacks || !script._callbacks.error) {
        console.warn('unhandled exception while calling "' + method + '" for "' + script.__scriptType.__name + '" script: ', ex);
        console.error(ex);
      }
      script.fire("error", ex, method);
      this.fire("error", script, ex, method);
    }
  }, _onInitialize:function() {
    var script, scripts = this._scripts;
    for (var i = 0, len = scripts.length;i < len;i++) {
      script = scripts[i];
      if (!script._initialized && script.enabled) {
        script._initialized = true;
        if (script.initialize) {
          this._scriptMethod(script, ScriptComponent.scriptMethods.initialize);
        }
      }
    }
  }, _onPostInitialize:function() {
    var script, scripts = this._scripts;
    for (var i = 0, len = scripts.length;i < len;i++) {
      script = scripts[i];
      if (!script._postInitialized && script.enabled) {
        script._postInitialized = true;
        if (script.postInitialize) {
          this._scriptMethod(script, ScriptComponent.scriptMethods.postInitialize);
        }
      }
    }
  }, _onUpdate:function(dt) {
    var script, scripts = this._scripts;
    for (var i = 0, len = scripts.length;i < len;i++) {
      script = scripts[i];
      if (script.update && script.enabled) {
        this._scriptMethod(script, ScriptComponent.scriptMethods.update, dt);
      }
    }
  }, _onPostUpdate:function(dt) {
    var script, scripts = this._scripts;
    for (var i = 0, len = scripts.length;i < len;i++) {
      script = scripts[i];
      if (script.postUpdate && script.enabled) {
        this._scriptMethod(script, ScriptComponent.scriptMethods.postUpdate, dt);
      }
    }
  }, has:function(name) {
    var scriptType = name;
    if (typeof scriptType === "string") {
      scriptType = this.system.app.scripts.get(scriptType);
    }
    return !!this._scriptsIndex[scriptType.__name];
  }, create:function(name, args) {
    var self = this;
    args = args || {};
    var scriptType = name;
    var scriptName = name;
    if (typeof scriptType === "string") {
      scriptType = this.system.app.scripts.get(scriptType);
    } else {
      if (scriptType) {
        scriptName = scriptType.__name;
      }
    }
    if (scriptType) {
      if (!this._scriptsIndex[scriptType.__name] || !this._scriptsIndex[scriptType.__name].instance) {
        var scriptInstance = new scriptType({app:this.system.app, entity:this.entity, enabled:args.hasOwnProperty("enabled") ? args.enabled : true, attributes:args.attributes || null});
        var ind = -1;
        if (typeof args.ind === "number" && args.ind !== -1 && this._scripts.length > args.ind) {
          ind = args.ind;
        }
        if (ind === -1) {
          this._scripts.push(scriptInstance);
        } else {
          this._scripts.splice(ind, 0, scriptInstance);
        }
        this._scriptsIndex[scriptType.__name] = {instance:scriptInstance, onSwap:function() {
          self.swap(scriptType.__name);
        }};
        this[scriptType.__name] = scriptInstance;
        if (!args.preloading) {
          scriptInstance.__initializeAttributes();
        }
        this.fire("create", scriptType.__name, scriptInstance);
        this.fire("create:" + scriptType.__name, scriptInstance);
        this.system.app.scripts.on("swap:" + scriptType.__name, this._scriptsIndex[scriptType.__name].onSwap);
        if (!args.preloading && this.enabled && scriptInstance.enabled && !scriptInstance._initialized) {
          scriptInstance._initialized = true;
          scriptInstance._postInitialized = true;
          if (scriptInstance.initialize) {
            this._scriptMethod(scriptInstance, ScriptComponent.scriptMethods.initialize);
          }
          if (scriptInstance.postInitialize) {
            this._scriptMethod(scriptInstance, ScriptComponent.scriptMethods.postInitialize);
          }
        }
        return scriptInstance;
      } else {
        console.warn("script '" + scriptName + "' is already added to entity '" + this.entity.name + "'");
      }
    } else {
      this._scriptsIndex[scriptName] = {awaiting:true, ind:this._scripts.length};
      console.warn("script '" + scriptName + "' is not found, awaiting it to be added to registry");
    }
    return null;
  }, destroy:function(name) {
    var scriptName = name;
    var scriptType = name;
    if (typeof scriptType === "string") {
      scriptType = this.system.app.scripts.get(scriptType);
      if (scriptType) {
        scriptName = scriptType.__name;
      }
    }
    var scriptData = this._scriptsIndex[scriptName];
    delete this._scriptsIndex[scriptName];
    if (!scriptData) {
      return false;
    }
    if (scriptData.instance) {
      var ind = this._scripts.indexOf(scriptData.instance);
      this._scripts.splice(ind, 1);
    }
    this.system.app.scripts.off("swap:" + scriptName, scriptData.onSwap);
    delete this._scriptsIndex[scriptName];
    delete this[scriptName];
    this.fire("destroy", scriptName, scriptData.instance || null);
    this.fire("destroy:" + scriptName, scriptData.instance || null);
    if (scriptData.instance) {
      scriptData.instance.fire("destroy");
    }
    return true;
  }, swap:function(script) {
    var scriptType = script;
    if (typeof scriptType === "string") {
      scriptType = this.system.app.scripts.get(scriptType);
    }
    var old = this._scriptsIndex[scriptType.__name];
    if (!old || !old.instance) {
      return false;
    }
    var scriptInstanceOld = old.instance;
    var ind = this._scripts.indexOf(scriptInstanceOld);
    var scriptInstance = new scriptType({app:this.system.app, entity:this.entity, enabled:scriptInstanceOld.enabled, attributes:scriptInstanceOld.__attributes});
    if (!scriptInstance.swap) {
      return false;
    }
    scriptInstance.__initializeAttributes();
    this._scripts[ind] = scriptInstance;
    this._scriptsIndex[scriptType.__name].instance = scriptInstance;
    this[scriptType.__name] = scriptInstance;
    this._scriptMethod(scriptInstance, ScriptComponent.scriptMethods.swap, scriptInstanceOld);
    this.fire("swap", scriptType.__name, scriptInstance);
    this.fire("swap:" + scriptType.__name, scriptInstance);
    return true;
  }, move:function(name, ind) {
    if (ind >= this._scripts.length) {
      return false;
    }
    var scriptName = name;
    if (typeof scriptName !== "string") {
      scriptName = name.__name;
    }
    var scriptData = this._scriptsIndex[scriptName];
    if (!scriptData || !scriptData.instance) {
      return false;
    }
    var indOld = this._scripts.indexOf(scriptData.instance);
    if (indOld === -1 || indOld === ind) {
      return false;
    }
    this._scripts.splice(ind, 0, this._scripts.splice(indOld, 1)[0]);
    this.fire("move", scriptName, scriptData.instance, ind, indOld);
    this.fire("move:" + scriptName, scriptData.instance, ind, indOld);
    return true;
  }});
  Object.defineProperty(ScriptComponent.prototype, "scripts", {get:function() {
    return this._scripts;
  }, set:function(value) {
    this._scriptsData = value;
    for (var key in value) {
      if (!value.hasOwnProperty(key)) {
        continue;
      }
      var script = this._scriptsIndex[key];
      if (script) {
        if (typeof value[key].enabled === "boolean") {
          script.enabled = !!value[key].enabled;
        }
        if (typeof value[key].attributes === "object") {
          for (var attr in value[key].attributes) {
            if (pc.createScript.reservedAttributes[attr]) {
              continue;
            }
            if (!script.__attributes.hasOwnProperty(attr)) {
              var scriptType = this.system.app.scripts.get(key);
              if (scriptType) {
                scriptType.attributes.add(attr, {});
              }
            }
            script[attr] = value[key].attributes[attr];
          }
        }
      } else {
        console.log(this.order);
      }
    }
  }});
  return {ScriptComponent:ScriptComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled"];
  var ScriptComponentSystem = function ScriptComponentSystem(app) {
    this.id = "script";
    this.app = app;
    app.systems.add(this.id, this);
    this.ComponentType = pc.ScriptComponent;
    this.DataType = pc.ScriptComponentData;
    this.schema = _schema;
    this._components = [];
    this.on("beforeremove", this._onBeforeRemove, this);
    pc.ComponentSystem.on("initialize", this._onInitialize, this);
    pc.ComponentSystem.on("postInitialize", this._onPostInitialize, this);
    pc.ComponentSystem.on("update", this._onUpdate, this);
    pc.ComponentSystem.on("postUpdate", this._onPostUpdate, this);
  };
  ScriptComponentSystem = pc.inherits(ScriptComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ScriptComponent.prototype, _schema);
  pc.extend(ScriptComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    this._components.push(component);
    component.enabled = data.hasOwnProperty("enabled") ? !!data.enabled : true;
    if (data.hasOwnProperty("order") && data.hasOwnProperty("scripts")) {
      component._scriptsData = data.scripts;
      for (var i = 0;i < data.order.length;i++) {
        component.create(data.order[i], {enabled:data.scripts[data.order[i]].enabled, attributes:data.scripts[data.order[i]].attributes, preloading:true});
      }
    }
  }, cloneComponent:function(entity, clone) {
    var i, key;
    var order = [];
    var scripts = {};
    for (i = 0;i < entity.script._scripts.length;i++) {
      var scriptInstance = entity.script._scripts[i];
      var scriptName = scriptInstance.__scriptType.__name;
      order.push(scriptName);
      var attributes = {};
      for (key in scriptInstance.__attributes) {
        attributes[key] = scriptInstance.__attributes[key];
      }
      scripts[scriptName] = {enabled:scriptInstance._enabled, attributes:attributes};
    }
    for (key in entity.script._scriptsIndex) {
      var scriptData = entity.script._scriptsIndex[key];
      if (key.awayting) {
        order.splice(key.ind, 0, key);
      }
    }
    var data = {enabled:entity.script.enabled, order:order, scripts:scripts};
    return this.addComponent(clone, data);
  }, _callComponentMethod:function(name, dt) {
    for (var i = 0;i < this._components.length;i++) {
      if (!this._components[i].entity.enabled || !this._components[i].enabled) {
        continue;
      }
      this._components[i][name](dt);
    }
  }, _onInitialize:function() {
    for (var i = 0;i < this._components.length;i++) {
      this._components[i]._onInitializeAttributes();
    }
    this._callComponentMethod("_onInitialize");
  }, _onPostInitialize:function() {
    this._callComponentMethod("_onPostInitialize");
  }, _onUpdate:function(dt) {
    this._callComponentMethod("_onUpdate", dt);
  }, _onPostUpdate:function(dt) {
    this._callComponentMethod("_onPostUpdate", dt);
  }, _onBeforeRemove:function(entity, component) {
    var ind = this._components.indexOf(component);
    if (ind === -1) {
      return;
    }
    component._onBeforeRemove();
    this._components.splice(ind, 1);
  }});
  return {ScriptComponentSystem:ScriptComponentSystem};
}());
pc.extend(pc, function() {
  var ScriptComponentData = function() {
    this.enabled = true;
  };
  ScriptComponentData = pc.inherits(ScriptComponentData, pc.ComponentData);
  return {ScriptComponentData:ScriptComponentData};
}());
pc.extend(pc, function() {
  var ScriptLegacyComponent = function ScriptLegacyComponent(system, entity) {
    this.on("set_scripts", this.onSetScripts, this);
  };
  ScriptLegacyComponent = pc.inherits(ScriptLegacyComponent, pc.Component);
  pc.extend(ScriptLegacyComponent.prototype, {send:function(name, functionName) {
    console.warn("DEPRECATED: ScriptLegacyComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");
    var args = pc.makeArray(arguments).slice(2);
    var instances = this.entity.script.instances;
    var fn;
    if (instances && instances[name]) {
      fn = instances[name].instance[functionName];
      if (fn) {
        return fn.apply(instances[name].instance, args);
      }
    }
  }, onEnable:function() {
    ScriptLegacyComponent._super.onEnable.call(this);
    if (this.data.areScriptsLoaded && !this.system.preloading) {
      if (!this.data.initialized) {
        this.system._initializeScriptComponent(this);
      } else {
        this.system._enableScriptComponent(this);
      }
      if (!this.data.postInitialized) {
        this.system._postInitializeScriptComponent(this);
      }
    }
  }, onDisable:function() {
    ScriptLegacyComponent._super.onDisable.call(this);
    this.system._disableScriptComponent(this);
  }, onSetScripts:function(name, oldValue, newValue) {
    if (!this.system._inTools || this.runInTools) {
      if (this._updateScriptAttributes(oldValue, newValue)) {
        return;
      }
      if (this.enabled) {
        this.system._disableScriptComponent(this);
      }
      this.system._destroyScriptComponent(this);
      this.data.areScriptsLoaded = false;
      var scripts = newValue;
      var urls = scripts.map(function(s) {
        return s.url;
      });
      if (this._loadFromCache(urls)) {
        return;
      }
      this._loadScripts(urls);
    }
  }, _updateScriptAttributes:function(oldValue, newValue) {
    var onlyUpdateAttributes = true;
    if (oldValue.length !== newValue.length) {
      onlyUpdateAttributes = false;
    } else {
      var i, len = newValue.length;
      for (i = 0;i < len;i++) {
        if (oldValue[i].url !== newValue[i].url) {
          onlyUpdateAttributes = false;
          break;
        }
      }
    }
    if (onlyUpdateAttributes) {
      for (var key in this.instances) {
        if (this.instances.hasOwnProperty(key)) {
          this.system._updateAccessors(this.entity, this.instances[key]);
        }
      }
    }
    return onlyUpdateAttributes;
  }, _loadFromCache:function(urls) {
    var i, len;
    var cached = [];
    var prefix = this.system.app._scriptPrefix || "";
    var regex = /^http(s)?:\/\//i;
    for (i = 0, len = urls.length;i < len;i++) {
      var url = urls[i];
      if (!regex.test(url)) {
        url = pc.path.join(prefix, url);
      }
      var type = this.system.app.loader.getFromCache(url, "script");
      if (!type) {
        return false;
      } else {
        cached.push(type);
      }
    }
    for (i = 0, len = cached.length;i < len;i++) {
      var ScriptType = cached[i];
      if (ScriptType === true) {
        continue;
      }
      if (ScriptType && this.entity.script) {
        if (!this.entity.script.instances[ScriptType._pcScriptName]) {
          var instance = new ScriptType(this.entity);
          this.system._preRegisterInstance(this.entity, urls[i], ScriptType._pcScriptName, instance);
        }
      }
    }
    if (this.data) {
      this.data.areScriptsLoaded = true;
    }
    if (!this.system.preloading) {
      this.system.onInitialize(this.entity);
      this.system.onPostInitialize(this.entity);
    }
    return true;
  }, _loadScripts:function(urls) {
    var count = urls.length;
    var prefix = this.system.app._scriptPrefix || "";
    urls.forEach(function(url) {
      var _url = null;
      var _unprefixed = null;
      if (url.toLowerCase().startsWith("http://") || url.toLowerCase().startsWith("https://")) {
        _unprefixed = url;
        _url = url;
      } else {
        _unprefixed = url;
        _url = pc.path.join(prefix, url);
      }
      this.system.app.loader.load(_url, "script", function(err, ScriptType) {
        count--;
        if (!err) {
          if (ScriptType && this.entity.script) {
            if (!this.entity.script.instances[ScriptType._pcScriptName]) {
              var instance = new ScriptType(this.entity);
              this.system._preRegisterInstance(this.entity, _unprefixed, ScriptType._pcScriptName, instance);
            }
          }
        } else {
          console.error(err);
        }
        if (count === 0) {
          this.data.areScriptsLoaded = true;
          if (!this.system.preloading) {
            this.system.onInitialize(this.entity);
            this.system.onPostInitialize(this.entity);
          }
        }
      }.bind(this));
    }.bind(this));
  }});
  return {ScriptLegacyComponent:ScriptLegacyComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "scripts", "instances", "runInTools"];
  var INITIALIZE = "initialize";
  var POST_INITIALIZE = "postInitialize";
  var UPDATE = "update";
  var POST_UPDATE = "postUpdate";
  var FIXED_UPDATE = "fixedUpdate";
  var TOOLS_UPDATE = "toolsUpdate";
  var ON_ENABLE = "onEnable";
  var ON_DISABLE = "onDisable";
  var ScriptLegacyComponentSystem = function ScriptLegacyComponentSystem(app) {
    this.id = "script";
    this.description = "Allows the Entity to run JavaScript fragments to implement custom behavior.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.ScriptLegacyComponent;
    this.DataType = pc.ScriptLegacyComponentData;
    this.schema = _schema;
    this.preloading = false;
    this.instancesWithUpdate = [];
    this.instancesWithFixedUpdate = [];
    this.instancesWithPostUpdate = [];
    this.instancesWithToolsUpdate = [];
    this.on("beforeremove", this.onBeforeRemove, this);
    pc.ComponentSystem.on(INITIALIZE, this.onInitialize, this);
    pc.ComponentSystem.on(POST_INITIALIZE, this.onPostInitialize, this);
    pc.ComponentSystem.on(UPDATE, this.onUpdate, this);
    pc.ComponentSystem.on(FIXED_UPDATE, this.onFixedUpdate, this);
    pc.ComponentSystem.on(POST_UPDATE, this.onPostUpdate, this);
    pc.ComponentSystem.on(TOOLS_UPDATE, this.onToolsUpdate, this);
  };
  ScriptLegacyComponentSystem = pc.inherits(ScriptLegacyComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ScriptLegacyComponent.prototype, _schema);
  pc.extend(ScriptLegacyComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    properties = ["runInTools", "enabled", "scripts"];
    if (data.scripts && data.scripts.length) {
      data.scripts.forEach(function(script) {
        if (script.attributes && pc.type(script.attributes) === "array") {
          var dict = {};
          for (var i = 0;i < script.attributes.length;i++) {
            dict[script.attributes[i].name] = script.attributes[i];
          }
          script.attributes = dict;
        }
      });
    }
    ScriptLegacyComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, cloneComponent:function(entity, clone) {
    var src = this.dataStore[entity._guid];
    var data = {runInTools:src.data.runInTools, scripts:[], enabled:src.data.enabled};
    var scripts = src.data.scripts;
    for (var i = 0, len = scripts.length;i < len;i++) {
      var attributes = scripts[i].attributes;
      if (attributes) {
        delete scripts[i].attributes;
      }
      data.scripts.push(pc.extend({}, scripts[i]));
      if (attributes) {
        data.scripts[i].attributes = this._cloneAttributes(attributes);
        scripts[i].attributes = attributes;
      }
    }
    return this.addComponent(clone, data);
  }, onBeforeRemove:function(entity, component) {
    if (component.enabled) {
      this._disableScriptComponent(component);
    }
    this._destroyScriptComponent(component);
  }, onInitialize:function(root) {
    this._registerInstances(root);
    if (root.enabled) {
      if (root.script && root.script.enabled) {
        this._initializeScriptComponent(root.script);
      }
      var children = root._children;
      var i, len = children.length;
      for (i = 0;i < len;i++) {
        if (children[i] instanceof pc.Entity) {
          this.onInitialize(children[i]);
        }
      }
    }
  }, onPostInitialize:function(root) {
    if (root.enabled) {
      if (root.script && root.script.enabled) {
        this._postInitializeScriptComponent(root.script);
      }
      var children = root._children;
      var i, len = children.length;
      for (i = 0;i < len;i++) {
        if (children[i] instanceof pc.Entity) {
          this.onPostInitialize(children[i]);
        }
      }
    }
  }, _callInstancesMethod:function(script, method) {
    var instances = script.data.instances;
    for (var name in instances) {
      if (instances.hasOwnProperty(name)) {
        var instance = instances[name].instance;
        if (instance[method]) {
          instance[method].call(instance);
        }
      }
    }
  }, _initializeScriptComponent:function(script) {
    this._callInstancesMethod(script, INITIALIZE);
    script.data.initialized = true;
    if (script.enabled && script.entity.enabled) {
      this._enableScriptComponent(script);
    }
  }, _enableScriptComponent:function(script) {
    this._callInstancesMethod(script, ON_ENABLE);
  }, _disableScriptComponent:function(script) {
    this._callInstancesMethod(script, ON_DISABLE);
  }, _destroyScriptComponent:function(script) {
    var index;
    var instances = script.data.instances;
    for (var name in instances) {
      if (instances.hasOwnProperty(name)) {
        var instance = instances[name].instance;
        if (instance.destroy) {
          instance.destroy();
        }
        if (instance.update) {
          index = this.instancesWithUpdate.indexOf(instance);
          if (index >= 0) {
            this.instancesWithUpdate.splice(index, 1);
          }
        }
        if (instance.fixedUpdate) {
          index = this.instancesWithFixedUpdate.indexOf(instance);
          if (index >= 0) {
            this.instancesWithFixedUpdate.splice(index, 1);
          }
        }
        if (instance.postUpdate) {
          index = this.instancesWithPostUpdate.indexOf(instance);
          if (index >= 0) {
            this.instancesWithPostUpdate.splice(index, 1);
          }
        }
        if (instance.toolsUpdate) {
          index = this.instancesWithToolsUpdate.indexOf(instance);
          if (index >= 0) {
            this.instancesWithToolsUpdate.splice(index, 1);
          }
        }
        if (script.instances[name].instance === script[name]) {
          delete script[name];
        }
        delete script.instances[name];
      }
    }
  }, _postInitializeScriptComponent:function(script) {
    this._callInstancesMethod(script, POST_INITIALIZE);
    script.data.postInitialized = true;
  }, _updateInstances:function(method, updateList, dt) {
    var item;
    for (var i = 0, len = updateList.length;i < len;i++) {
      item = updateList[i];
      if (item && item.entity && item.entity.enabled && item.entity.script.enabled) {
        item[method].call(item, dt);
      }
    }
  }, onUpdate:function(dt) {
    this._updateInstances(UPDATE, this.instancesWithUpdate, dt);
  }, onFixedUpdate:function(dt) {
    this._updateInstances(FIXED_UPDATE, this.instancesWithFixedUpdate, dt);
  }, onPostUpdate:function(dt) {
    this._updateInstances(POST_UPDATE, this.instancesWithPostUpdate, dt);
  }, onToolsUpdate:function(dt) {
    this._updateInstances(TOOLS_UPDATE, this.instancesWithToolsUpdate, dt);
  }, broadcast:function(name, functionName) {
    console.warn("DEPRECATED: ScriptLegacyComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");
    var args = pc.makeArray(arguments).slice(2);
    var id, data, fn;
    var dataStore = this.store;
    for (id in dataStore) {
      if (dataStore.hasOwnProperty(id)) {
        data = dataStore[id].data;
        if (data.instances[name]) {
          fn = data.instances[name].instance[functionName];
          if (fn) {
            fn.apply(data.instances[name].instance, args);
          }
        }
      }
    }
  }, _preRegisterInstance:function(entity, url, name, instance) {
    if (entity.script) {
      entity.script.data._instances = entity.script.data._instances || {};
      if (entity.script.data._instances[name]) {
        throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}", name, url, entity.script.data._instances[name].url, entity._guid));
      }
      entity.script.data._instances[name] = {url:url, name:name, instance:instance};
    }
  }, _registerInstances:function(entity) {
    var preRegistered, instance, instanceName;
    if (entity.script) {
      if (entity.script.data._instances) {
        entity.script.instances = entity.script.data._instances;
        for (instanceName in entity.script.instances) {
          preRegistered = entity.script.instances[instanceName];
          instance = preRegistered.instance;
          pc.events.attach(instance);
          if (instance.update) {
            this.instancesWithUpdate.push(instance);
          }
          if (instance.fixedUpdate) {
            this.instancesWithFixedUpdate.push(instance);
          }
          if (instance.postUpdate) {
            this.instancesWithPostUpdate.push(instance);
          }
          if (instance.toolsUpdate) {
            this.instancesWithToolsUpdate.push(instance);
          }
          if (entity.script.scripts) {
            this._createAccessors(entity, preRegistered);
          }
          if (entity.script[instanceName]) {
            throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component", instanceName));
          } else {
            entity.script[instanceName] = instance;
          }
        }
        delete entity.script.data._instances;
      }
    }
    var children = entity._children;
    var i, len = children.length;
    for (i = 0;i < len;i++) {
      if (children[i] instanceof pc.Entity) {
        this._registerInstances(children[i]);
      }
    }
  }, _cloneAttributes:function(attributes) {
    var result = {};
    for (var key in attributes) {
      if (!attributes.hasOwnProperty(key)) {
        continue;
      }
      if (attributes[key].type !== "entity") {
        result[key] = pc.extend({}, attributes[key]);
      } else {
        var val = attributes[key].value;
        delete attributes[key].value;
        result[key] = pc.extend({}, attributes[key]);
        result[key].value = val;
        attributes[key].value = val;
      }
    }
    return result;
  }, _createAccessors:function(entity, instance) {
    var self = this;
    var i;
    var len = entity.script.scripts.length;
    var url = instance.url;
    for (i = 0;i < len;i++) {
      var script = entity.script.scripts[i];
      if (script.url === url) {
        var attributes = script.attributes;
        if (script.name && attributes) {
          for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
              self._createAccessor(attributes[key], instance);
            }
          }
          entity.script.data.attributes[script.name] = self._cloneAttributes(attributes);
        }
        break;
      }
    }
  }, _createAccessor:function(attribute, instance) {
    var self = this;
    attribute = {name:attribute.name, value:attribute.value, type:attribute.type};
    self._convertAttributeValue(attribute);
    Object.defineProperty(instance.instance, attribute.name, {get:function() {
      return attribute.value;
    }, set:function(value) {
      var oldValue = attribute.value;
      attribute.value = value;
      self._convertAttributeValue(attribute);
      instance.instance.fire("set", attribute.name, oldValue, attribute.value);
    }, configurable:true});
  }, _updateAccessors:function(entity, instance) {
    var self = this;
    var i;
    var len = entity.script.scripts.length;
    var key;
    var url = instance.url;
    var scriptComponent, script, name, attributes;
    var previousAttributes;
    var oldAttribute;
    for (i = 0;i < len;i++) {
      scriptComponent = entity.script;
      script = scriptComponent.scripts[i];
      if (script.url === url) {
        name = script.name;
        attributes = script.attributes;
        if (name) {
          if (attributes) {
            for (key in attributes) {
              if (attributes.hasOwnProperty(key)) {
                self._createAccessor(attributes[key], instance);
              }
            }
          }
          previousAttributes = scriptComponent.data.attributes[name];
          if (previousAttributes) {
            for (key in previousAttributes) {
              oldAttribute = previousAttributes[key];
              if (!(key in attributes)) {
                delete instance.instance[oldAttribute.name];
              } else {
                if (attributes[key].value !== oldAttribute.value) {
                  if (instance.instance.onAttributeChanged) {
                    instance.instance.onAttributeChanged(oldAttribute.name, oldAttribute.value, attributes[key].value);
                  }
                }
              }
            }
          }
          if (attributes) {
            scriptComponent.data.attributes[name] = self._cloneAttributes(attributes);
          } else {
            delete scriptComponent.data.attributes[name];
          }
        }
        break;
      }
    }
  }, _convertAttributeValue:function(attribute) {
    if (attribute.type === "rgb" || attribute.type === "rgba") {
      if (pc.type(attribute.value) === "array") {
        attribute.value = attribute.value.length === 3 ? new pc.Color(attribute.value[0], attribute.value[1], attribute.value[2]) : new pc.Color(attribute.value[0], attribute.value[1], attribute.value[2], attribute.value[3]);
      }
    } else {
      if (attribute.type === "vec2") {
        if (pc.type(attribute.value) === "array") {
          attribute.value = new pc.Vec2(attribute.value[0], attribute.value[1]);
        }
      } else {
        if (attribute.type === "vec3" || attribute.type === "vector") {
          if (pc.type(attribute.value) === "array") {
            attribute.value = new pc.Vec3(attribute.value[0], attribute.value[1], attribute.value[2]);
          }
        } else {
          if (attribute.type === "vec4") {
            if (pc.type(attribute.value) === "array") {
              attribute.value = new pc.Vec4(attribute.value[0], attribute.value[1], attribute.value[2], attribute.value[3]);
            }
          } else {
            if (attribute.type === "entity") {
              if (attribute.value !== null && typeof attribute.value === "string") {
                attribute.value = this.app.root.findByGuid(attribute.value);
              }
            } else {
              if (attribute.type === "curve" || attribute.type === "colorcurve") {
                var curveType = attribute.value.keys[0] instanceof Array ? pc.CurveSet : pc.Curve;
                attribute.value = new curveType(attribute.value.keys);
                attribute.value.type = attribute.value.type;
              }
            }
          }
        }
      }
    }
  }});
  return {ScriptLegacyComponentSystem:ScriptLegacyComponentSystem};
}());
pc.extend(pc, function() {
  var ScriptLegacyComponentData = function() {
    this.scripts = [];
    this.enabled = true;
    this.instances = {};
    this._instances = {};
    this.runInTools = false;
    this.attributes = {};
    this.initialized = false;
    this.postInitialized = false;
    this.areScriptsLoaded = false;
  };
  ScriptLegacyComponentData = pc.inherits(ScriptLegacyComponentData, pc.ComponentData);
  return {ScriptLegacyComponentData:ScriptLegacyComponentData};
}());
pc.extend(pc, {DISTANCE_LINEAR:"linear", DISTANCE_INVERSE:"inverse", DISTANCE_EXPONENTIAL:"exponential"});
pc.extend(pc, function() {
  var instanceOptions = {volume:0, pitch:0, loop:false, startTime:0, duration:0, position:new pc.Vec3, maxDistance:0, refDistance:0, rollOffFactor:0, distanceModel:0, onPlay:null, onPause:null, onResume:null, onStop:null, onEnd:null};
  var SoundSlot = function(component, name, options) {
    options = options || {};
    this._component = component;
    this._assets = component.system.app.assets;
    this._manager = component.system.manager;
    this._name = name || "Untitled";
    this._volume = options.volume !== undefined ? pc.math.clamp(Number(options.volume) || 0, 0, 1) : 1;
    this._pitch = options.pitch !== undefined ? Math.max(0.01, Number(options.pitch) || 0) : 1;
    this._loop = !!(options.loop !== undefined ? options.loop : false);
    this._duration = options.duration > 0 ? options.duration : null;
    this._startTime = Math.max(0, Number(options.startTime) || 0);
    this._overlap = !!options.overlap;
    this._autoPlay = !!options.autoPlay;
    this._firstNode = null;
    this._lastNode = null;
    this._asset = options.asset;
    if (this._asset instanceof pc.Asset) {
      this._asset = this._asset.id;
    }
    this._onInstancePlayHandler = this._onInstancePlay.bind(this);
    this._onInstancePauseHandler = this._onInstancePause.bind(this);
    this._onInstanceResumeHandler = this._onInstanceResume.bind(this);
    this._onInstanceStopHandler = this._onInstanceStop.bind(this);
    this._onInstanceEndHandler = this._onInstanceEnd.bind(this);
    this.instances = [];
    pc.events.attach(this);
  };
  SoundSlot.prototype = {play:function() {
    if (!this.overlap && (this.isPlaying || this.isPaused)) {
      this.stop();
    }
    var instance = this._createInstance();
    this.instances.push(instance);
    if (!this.isLoaded) {
      var onLoad = function(sound) {
        var playWhenLoaded = instance._playWhenLoaded;
        instance.sound = sound;
        if (playWhenLoaded) {
          instance.play();
        }
      };
      this.off("load", onLoad);
      this.once("load", onLoad);
      this.load();
    } else {
      instance.play();
    }
    return instance;
  }, pause:function() {
    var paused = false;
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      if (instances[i].pause()) {
        paused = true;
      }
    }
    return paused;
  }, resume:function() {
    var resumed = false;
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      if (instances[i].resume()) {
        resumed = true;
      }
    }
    return resumed;
  }, stop:function() {
    var stopped = false;
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      if (instances[i].stop()) {
        stopped = true;
      }
    }
    instances.length = 0;
    return stopped;
  }, load:function() {
    if (!this._hasAsset()) {
      return;
    }
    var asset = this._assets.get(this._asset);
    if (!asset) {
      this._assets.off("add:" + this._asset, this._onAssetAdd, this);
      this._assets.once("add:" + this._asset, this._onAssetAdd, this);
      return;
    }
    asset.off("remove", this._onAssetRemoved, this);
    asset.on("remove", this._onAssetRemoved, this);
    if (!asset.resource) {
      asset.off("load", this._onAssetLoad, this);
      asset.once("load", this._onAssetLoad, this);
      this._assets.load(asset);
      return;
    }
    this.fire("load", asset.resource);
  }, setExternalNodes:function(firstNode, lastNode) {
    if (!firstNode) {
      console.error("The firstNode must have a valid AudioNode");
      return;
    }
    if (!lastNode) {
      lastNode = firstNode;
    }
    this._firstNode = firstNode;
    this._lastNode = lastNode;
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].setExternalNodes(firstNode, lastNode);
      }
    }
  }, clearExternalNodes:function() {
    this._firstNode = null;
    this._lastNode = null;
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].clearExternalNodes();
      }
    }
  }, getExternalNodes:function() {
    return [this._firstNode, this._lastNode];
  }, _hasAsset:function() {
    return this._asset != null;
  }, _createInstance:function() {
    var instance = null;
    var component = this._component;
    var sound = null;
    if (this._hasAsset()) {
      var asset = this._assets.get(this._asset);
      if (asset) {
        sound = asset.resource;
      }
    }
    var data = instanceOptions;
    data.volume = this._volume * component.volume;
    data.pitch = this._pitch * component.pitch;
    data.loop = this._loop;
    data.startTime = this._startTime;
    data.duration = this._duration;
    data.onPlay = this._onInstancePlayHandler;
    data.onPause = this._onInstancePauseHandler;
    data.onResume = this._onInstanceResumeHandler;
    data.onStop = this._onInstanceStopHandler;
    data.onEnd = this._onInstanceEndHandler;
    if (component.positional) {
      data.position.copy(component.entity.getPosition());
      data.maxDistance = component.maxDistance;
      data.refDistance = component.refDistance;
      data.rollOffFactor = component.rollOffFactor;
      data.distanceModel = component.distanceModel;
      instance = new pc.SoundInstance3d(this._manager, sound, data);
    } else {
      instance = new pc.SoundInstance(this._manager, sound, data);
    }
    if (this._firstNode) {
      instance.setExternalNodes(this._firstNode, this._lastNode);
    }
    return instance;
  }, _onInstancePlay:function(instance) {
    this.fire("play", instance);
    this._component.fire("play", this, instance);
  }, _onInstancePause:function(instance) {
    this.fire("pause", instance);
    this._component.fire("pause", this, instance);
  }, _onInstanceResume:function(instance) {
    this.fire("resume", instance);
    this._component.fire("resume", this, instance);
  }, _onInstanceStop:function(instance) {
    this.fire("stop", instance);
    this._component.fire("stop", this, instance);
  }, _onInstanceEnd:function(instance) {
    var idx = this.instances.indexOf(instance);
    if (idx !== -1) {
      this.instances.splice(idx, 1);
    }
    this.fire("end", instance);
    this._component.fire("end", this, instance);
  }, _onAssetAdd:function(asset) {
    this.load();
  }, _onAssetLoad:function(asset) {
    this.load();
  }, _onAssetRemoved:function(asset) {
    asset.off("remove", this._onAssetRemoved, this);
    this._assets.off("add:" + asset.id, this._onAssetAdd, this);
    this.stop();
  }, updatePosition:function(position) {
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      instances[i].position = position;
    }
  }};
  Object.defineProperty(SoundSlot.prototype, "name", {get:function() {
    return this._name;
  }, set:function(value) {
    var old = this._name;
    this._name = value;
  }});
  Object.defineProperty(SoundSlot.prototype, "volume", {get:function() {
    return this._volume;
  }, set:function(value) {
    var old = this._volume;
    this._volume = pc.math.clamp(Number(value) || 0, 0, 1);
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].volume = this._volume * this._component.volume;
      }
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "pitch", {get:function() {
    return this._pitch;
  }, set:function(value) {
    var old = this._pitch;
    this._pitch = Math.max(Number(value) || 0, 0.01);
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].pitch = this.pitch * this._component.pitch;
      }
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "loop", {get:function() {
    return this._loop;
  }, set:function(value) {
    var old = this._loop;
    this._loop = !!value;
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      instances[i].loop = this._loop;
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "autoPlay", {get:function() {
    return this._autoPlay;
  }, set:function(value) {
    var old = this._autoPlay;
    this._autoPlay = !!value;
  }});
  Object.defineProperty(SoundSlot.prototype, "overlap", {get:function() {
    return this._overlap;
  }, set:function(value) {
    var old = this._overlap;
    this._overlap = !!value;
  }});
  Object.defineProperty(SoundSlot.prototype, "startTime", {get:function() {
    return this._startTime;
  }, set:function(value) {
    var old = this._startTime;
    this._startTime = Math.max(0, Number(value) || 0);
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].startTime = this._startTime;
      }
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "duration", {get:function() {
    var assetDuration = 0;
    if (this._hasAsset()) {
      var asset = this._assets.get(this._asset);
      assetDuration = asset.resource ? asset.resource.duration : 0;
    }
    if (this._duration != null) {
      return this._duration % (assetDuration || 1);
    } else {
      return assetDuration;
    }
  }, set:function(value) {
    var old = this._duration;
    this._duration = Math.max(0, Number(value) || 0) || null;
    if (!this._overlap) {
      var instances = this.instances;
      for (var i = 0, len = instances.length;i < len;i++) {
        instances[i].duration = this._duration;
      }
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "asset", {get:function() {
    return this._asset;
  }, set:function(value) {
    var old = this._asset;
    if (old) {
      this._assets.off("add:" + old, this._onAssetAdd, this);
      var oldAsset = this._assets.get(old);
      if (oldAsset) {
        oldAsset.off("remove", this._onAssetRemoved, this);
      }
    }
    this._asset = value;
    if (this._asset instanceof pc.Asset) {
      this._asset = this._asset.id;
    }
    if (this._hasAsset() && this._component.enabled && this._component.entity.enabled) {
      this.load();
    }
  }});
  Object.defineProperty(SoundSlot.prototype, "isLoaded", {get:function() {
    if (this._hasAsset()) {
      var asset = this._assets.get(this._asset);
      if (asset) {
        return !!asset.resource;
      }
    }
    return false;
  }});
  Object.defineProperty(SoundSlot.prototype, "isPlaying", {get:function() {
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      if (instances[i].isPlaying) {
        return true;
      }
    }
    return false;
  }});
  Object.defineProperty(SoundSlot.prototype, "isPaused", {get:function() {
    var instances = this.instances;
    var len = instances.length;
    if (len === 0) {
      return false;
    }
    for (var i = 0;i < len;i++) {
      if (!instances[i].isPaused) {
        return false;
      }
    }
    return true;
  }});
  Object.defineProperty(SoundSlot.prototype, "isStopped", {get:function() {
    var instances = this.instances;
    for (var i = 0, len = instances.length;i < len;i++) {
      if (!instances[i].isStopped) {
        return false;
      }
    }
    return true;
  }});
  return {SoundSlot:SoundSlot};
}());
pc.extend(pc, function() {
  var SoundComponent = function(system, entity) {
    this.on("set_slots", this.onSetSlots, this);
    this.on("set_volume", this.onSetVolume, this);
    this.on("set_pitch", this.onSetPitch, this);
    this.on("set_refDistance", this.onSetRefDistance, this);
    this.on("set_maxDistance", this.onSetMaxDistance, this);
    this.on("set_rollOffFactor", this.onSetRollOffFactor, this);
    this.on("set_distanceModel", this.onSetDistanceModel, this);
    this.on("set_positional", this.onSetPositional, this);
  };
  SoundComponent = pc.inherits(SoundComponent, pc.Component);
  pc.extend(SoundComponent.prototype, {onSetSlots:function(name, oldValue, newValue) {
    var key;
    if (oldValue) {
      for (key in oldValue) {
        oldValue[key].stop();
      }
    }
    var slots = {};
    for (key in newValue) {
      if (!(newValue[key] instanceof pc.SoundSlot)) {
        if (newValue[key].name) {
          slots[newValue[key].name] = new pc.SoundSlot(this, newValue[key].name, newValue[key]);
        }
      } else {
        slots[newValue[key].name] = newValue[key];
      }
    }
    this.data.slots = slots;
    if (this.enabled && this.entity.enabled) {
      this.onEnable();
    }
  }, onSetVolume:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].volume = slot.volume * newValue;
        }
      }
    }
  }, onSetPitch:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].pitch = slot.pitch * newValue;
        }
      }
    }
  }, onSetRefDistance:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].refDistance = newValue;
        }
      }
    }
  }, onSetMaxDistance:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].maxDistance = newValue;
        }
      }
    }
  }, onSetRollOffFactor:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].rollOffFactor = newValue;
        }
      }
    }
  }, onSetDistanceModel:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          instances[i].distanceModel = newValue;
        }
      }
    }
  }, onSetPositional:function(name, oldValue, newValue) {
    var slots = this.data.slots;
    for (var key in slots) {
      var slot = slots[key];
      if (!slot.overlap) {
        var instances = slot.instances;
        for (var i = 0, len = instances.length;i < len;i++) {
          var isPlaying = instances[i].isPlaying || instances[i].isSuspended;
          var currentTime = instances[i].currentTime;
          if (isPlaying) {
            instances[i].stop();
          }
          instances[i] = slot._createInstance();
          if (isPlaying) {
            instances[i].play();
            instances[i].currentTime = currentTime;
          }
        }
      }
    }
  }, onEnable:function() {
    SoundComponent._super.onEnable.call(this);
    if (this.system._inTools) {
      return;
    }
    var slots = this.data.slots;
    var playingBeforeDisable = this.data.playingBeforeDisable;
    for (var key in slots) {
      var slot = slots[key];
      if (slot.autoPlay && slot.isStopped) {
        slot.play();
      } else {
        if (playingBeforeDisable[key]) {
          slot.resume();
        } else {
          if (!slot.isLoaded) {
            slot.load();
          }
        }
      }
    }
  }, onDisable:function() {
    SoundComponent._super.onDisable.call(this);
    var slots = this.data.slots;
    var playingBeforeDisable = {};
    for (var key in slots) {
      if (!slots[key].overlap) {
        if (slots[key].isPlaying) {
          slots[key].pause();
          playingBeforeDisable[key] = true;
        }
      }
    }
    this.data.playingBeforeDisable = playingBeforeDisable;
  }, addSlot:function(name, options) {
    var slots = this.data.slots;
    if (slots[name]) {
      logWARNING("A sound slot with name " + name + " already exists on Entity " + this.entity.getPath());
      return null;
    }
    var slot = new pc.SoundSlot(this, name, options);
    slots[name] = slot;
    if (slot.autoPlay && this.enabled && this.entity.enabled) {
      slot.play();
    }
    return slot;
  }, removeSlot:function(name) {
    var slots = this.data.slots;
    if (slots[name]) {
      slots[name].stop();
      delete slots[name];
    }
  }, slot:function(name) {
    return this.data.slots[name];
  }, play:function(name) {
    if (!this.enabled || !this.entity.enabled) {
      return null;
    }
    var slot = this.slots[name];
    if (!slot) {
      logWARNING("Trying to play sound slot with name " + name + " which does not exist");
      return null;
    }
    return slot.play();
  }, pause:function(name) {
    var slot;
    var slots = this.data.slots;
    if (name) {
      slot = slots[name];
      if (!slot) {
        logWARNING("Trying to pause sound slot with name " + name + " which does not exist");
        return;
      }
      slot.pause();
    } else {
      for (var key in slots) {
        slots[key].pause();
      }
    }
  }, resume:function(name) {
    var slot;
    var slots = this.data.slots;
    if (name) {
      slot = slots[name];
      if (!slot) {
        logWARNING("Trying to resume sound slot with name " + name + " which does not exist");
        return;
      }
      if (slot.isPaused) {
        slot.resume();
      }
    } else {
      for (var key in slots) {
        slots[key].resume();
      }
    }
  }, stop:function(name) {
    var slot;
    var slots = this.data.slots;
    if (name) {
      slot = slots[name];
      if (!slot) {
        logWARNING("Trying to stop sound slot with name " + name + " which does not exist");
        return;
      }
      slot.stop();
    } else {
      for (var key in slots) {
        slots[key].stop();
      }
    }
  }});
  return {SoundComponent:SoundComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "volume", "pitch", "positional", "refDistance", "maxDistance", "rollOffFactor", "distanceModel", "slots"];
  var SoundComponentSystem = function(app, manager) {
    this.id = "sound";
    this.description = "Allows an Entity to play sounds";
    app.systems.add(this.id, this);
    this.ComponentType = pc.SoundComponent;
    this.DataType = pc.SoundComponentData;
    this.schema = _schema;
    this.manager = manager;
    pc.ComponentSystem.on("update", this.onUpdate, this);
    this.on("beforeremove", this.onBeforeRemove, this);
  };
  SoundComponentSystem = pc.inherits(SoundComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.SoundComponent.prototype, _schema);
  pc.extend(SoundComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    properties = ["volume", "pitch", "positional", "refDistance", "maxDistance", "rollOffFactor", "distanceModel", "slots", "enabled"];
    SoundComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, cloneComponent:function(entity, clone) {
    var key;
    var oldData = entity.sound.data;
    var newData = {};
    for (key in oldData) {
      if (oldData.hasOwnProperty(key)) {
        newData[key] = oldData[key];
      }
    }
    newData.slots = {};
    for (key in oldData.slots) {
      var oldSlot = oldData.slots[key];
      if (oldSlot instanceof pc.SoundSlot) {
        newData.slots[key] = {name:oldSlot.name, volume:oldSlot.volume, pitch:oldSlot.pitch, loop:oldSlot.loop, duration:oldSlot.duration, startTime:oldSlot.startTime, overlap:oldSlot.overlap, autoPlay:oldSlot.autoPlay, asset:oldSlot.asset};
      } else {
        newData.slots[key] = oldSlot;
      }
    }
    newData.playingBeforeDisable = {};
    return this.addComponent(clone, newData);
  }, onUpdate:function(dt) {
    var store = this.store;
    for (var id in store) {
      if (store.hasOwnProperty(id)) {
        var item = store[id];
        var entity = item.entity;
        var componentData = item.data;
        if (componentData.enabled && entity.enabled && componentData.positional) {
          var position = entity.getPosition();
          var slots = componentData.slots;
          for (var key in slots) {
            slots[key].updatePosition(position);
          }
        }
      }
    }
  }, onBeforeRemove:function(entity, component) {
    var slots = component.slots;
    for (var key in slots) {
      if (!slots[key].overlap) {
        slots[key].stop();
      }
    }
  }});
  Object.defineProperty(SoundComponentSystem.prototype, "volume", {get:function() {
    return this.manager.volume;
  }, set:function(volume) {
    this.manager.volume = volume;
  }});
  Object.defineProperty(SoundComponentSystem.prototype, "context", {get:function() {
    if (!pc.SoundManager.hasAudioContext()) {
      console.warn("WARNING: Audio context is not supported on this browser");
      return null;
    }
    return this.manager.context;
  }});
  return {SoundComponentSystem:SoundComponentSystem};
}());
pc.SoundComponentData = function SoundComponentData() {
  this.enabled = true;
  this.volume = 1;
  this.pitch = 1;
  this.positional = true;
  this.refDistance = 1;
  this.maxDistance = 10000;
  this.rollOffFactor = 1;
  this.distanceModel = pc.DISTANCE_LINEAR;
  this.slots = {};
  this.playingBeforeDisable = {};
};
pc.extend(pc, function() {
  var AudioSourceComponent = function(system, entity) {
    this.on("set_assets", this.onSetAssets, this);
    this.on("set_loop", this.onSetLoop, this);
    this.on("set_volume", this.onSetVolume, this);
    this.on("set_pitch", this.onSetPitch, this);
    this.on("set_minDistance", this.onSetMinDistance, this);
    this.on("set_maxDistance", this.onSetMaxDistance, this);
    this.on("set_rollOffFactor", this.onSetRollOffFactor, this);
    this.on("set_distanceModel", this.onSetDistanceModel, this);
    this.on("set_3d", this.onSet3d, this);
  };
  AudioSourceComponent = pc.inherits(AudioSourceComponent, pc.Component);
  pc.extend(AudioSourceComponent.prototype, {play:function(name) {
    if (!this.enabled || !this.entity.enabled) {
      return;
    }
    if (this.channel) {
      this.stop();
    }
    var channel;
    var componentData = this.data;
    if (componentData.sources[name]) {
      if (!componentData["3d"]) {
        channel = this.system.manager.playSound(componentData.sources[name], componentData);
        componentData.currentSource = name;
        componentData.channel = channel;
      } else {
        var pos = this.entity.getPosition();
        channel = this.system.manager.playSound3d(componentData.sources[name], pos, componentData);
        componentData.currentSource = name;
        componentData.channel = channel;
      }
    }
  }, pause:function() {
    if (this.channel) {
      this.channel.pause();
    }
  }, unpause:function() {
    if (this.channel && this.channel.paused) {
      this.channel.unpause();
    }
  }, stop:function() {
    if (this.channel) {
      this.channel.stop();
      this.channel = null;
    }
  }, onSetAssets:function(name, oldValue, newValue) {
    var componentData = this.data;
    var newAssets = [];
    var i, len = newValue.length;
    if (oldValue && oldValue.length) {
      for (i = 0;i < oldValue.length;i++) {
        if (oldValue[i]) {
          var asset = this.system.app.assets.get(oldValue[i]);
          if (asset) {
            asset.off("change", this.onAssetChanged, this);
            asset.off("remove", this.onAssetRemoved, this);
            if (this.currentSource === asset.name) {
              this.stop();
            }
          }
        }
      }
    }
    if (len) {
      for (i = 0;i < len;i++) {
        if (oldValue.indexOf(newValue[i]) < 0) {
          if (newValue[i] instanceof pc.Asset) {
            newAssets.push(newValue[i].id);
          } else {
            newAssets.push(newValue[i]);
          }
        }
      }
    }
    if (!this.system._inTools && newAssets.length) {
      this.loadAudioSourceAssets(newAssets);
    }
  }, onAssetChanged:function(asset, attribute, newValue, oldValue) {
    if (attribute === "resource") {
      var sources = this.data.sources;
      if (sources) {
        this.data.sources[asset.name] = newValue;
        if (this.data.currentSource === asset.name) {
          if (this.channel) {
            if (this.channel.paused) {
              this.play(asset.name);
              this.pause();
            } else {
              this.play(asset.name);
            }
          }
        }
      }
    }
  }, onAssetRemoved:function(asset) {
    asset.off("remove", this.onAssetRemoved, this);
    if (this.data.sources[asset.name]) {
      delete this.data.sources[asset.name];
      if (this.data.currentSource === asset.name) {
        this.stop();
        this.data.currentSource = null;
      }
    }
  }, onSetLoop:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel) {
        this.channel.setLoop(newValue);
      }
    }
  }, onSetVolume:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel) {
        this.channel.setVolume(newValue);
      }
    }
  }, onSetPitch:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel) {
        this.channel.setPitch(newValue);
      }
    }
  }, onSetMaxDistance:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel instanceof pc.Channel3d) {
        this.channel.setMaxDistance(newValue);
      }
    }
  }, onSetMinDistance:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel instanceof pc.Channel3d) {
        this.channel.setMinDistance(newValue);
      }
    }
  }, onSetRollOffFactor:function(name, oldValue, newValue) {
    if (oldValue != newValue) {
      if (this.channel instanceof pc.Channel3d) {
        this.channel.setRollOffFactor(newValue);
      }
    }
  }, onSetDistanceModel:function(name, oldValue, newValue) {
    if (oldValue !== newValue) {
      if (this.channel instanceof pc.Channel3d) {
        this.channel.setDistanceModel(newValue);
      }
    }
  }, onSet3d:function(name, oldValue, newValue) {
    if (oldValue !== newValue) {
      if (this.system.initialized && this.currentSource) {
        var paused = false;
        var suspended = false;
        if (this.channel) {
          paused = this.channel.paused;
          suspended = this.channel.suspended;
        }
        this.play(this.currentSource);
        if (this.channel) {
          this.channel.paused = paused;
          this.channel.suspended = suspended;
        }
      }
    }
  }, onEnable:function() {
    AudioSourceComponent._super.onEnable.call(this);
    var assets = this.data.assets;
    if (assets) {
      var registry = this.system.app.assets;
      for (var i = 0, len = assets.length;i < len;i++) {
        var asset = assets[i];
        if (!(asset instanceof pc.Asset)) {
          asset = registry.get(asset);
        }
        if (asset && !asset.resource) {
          registry.load(asset);
        }
      }
    }
    if (this.system.initialized) {
      if (this.data.activate && !this.channel) {
        this.play(this.currentSource);
      } else {
        this.unpause();
      }
    }
  }, onDisable:function() {
    AudioSourceComponent._super.onDisable.call(this);
    this.pause();
  }, loadAudioSourceAssets:function(ids) {
    var self = this;
    var assets = ids.map(function(id) {
      return this.system.app.assets.get(id);
    }, this);
    var sources = {};
    var currentSource = null;
    var count = assets.length;
    var _error = function(e) {
      count--;
    };
    var _done = function() {
      this.data.sources = sources;
      this.data.currentSource = currentSource;
      if (this.enabled && this.activate && currentSource) {
        this.onEnable();
      }
    }.bind(this);
    assets.forEach(function(asset, index) {
      if (asset) {
        currentSource = currentSource || asset.name;
        asset.off("change", this.onAssetChanged, this);
        asset.on("change", this.onAssetChanged, this);
        asset.off("remove", this.onAssetRemoved, this);
        asset.on("remove", this.onAssetRemoved, this);
        asset.off("error", _error, this);
        asset.on("error", _error, this);
        asset.ready(function(asset) {
          sources[asset.name] = asset.resource;
          count--;
          if (count === 0) {
            _done();
          }
        });
        if (!asset.resource && self.enabled && self.entity.enabled) {
          this.system.app.assets.load(asset);
        }
      } else {
        count--;
        if (count === 0) {
          _done();
        }
        this.system.app.assets.on("add:" + ids[index], function(asset) {
          asset.ready(function(asset) {
            self.data.sources[asset.name] = asset.resource;
          });
          if (!asset.resource) {
            self.system.app.assets.load(asset);
          }
        });
      }
    }, this);
  }});
  return {AudioSourceComponent:AudioSourceComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "assets", "volume", "pitch", "loop", "activate", "3d", "minDistance", "maxDistance", "rollOffFactor", "distanceModel", "sources", "currentSource", "channel"];
  var AudioSourceComponentSystem = function(app, manager) {
    this.id = "audiosource";
    this.description = "Specifies audio assets that can be played at the position of the Entity.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.AudioSourceComponent;
    this.DataType = pc.AudioSourceComponentData;
    this.schema = _schema;
    this.manager = manager;
    this.initialized = false;
    pc.ComponentSystem.on("initialize", this.onInitialize, this);
    pc.ComponentSystem.on("update", this.onUpdate, this);
    this.on("remove", this.onRemove, this);
  };
  AudioSourceComponentSystem = pc.inherits(AudioSourceComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.AudioSourceComponent.prototype, _schema);
  pc.extend(AudioSourceComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    properties = ["activate", "volume", "pitch", "loop", "3d", "minDistance", "maxDistance", "rollOffFactor", "distanceModel", "enabled", "assets"];
    AudioSourceComponentSystem._super.initializeComponentData.call(this, component, data, properties);
    component.paused = !(component.enabled && component.activate);
  }, onInitialize:function(root) {
    if (root.audiosource && root.enabled && root.audiosource.enabled && root.audiosource.activate) {
      root.audiosource.play(root.audiosource.currentSource);
    }
    var children = root._children;
    var i, len = children.length;
    for (i = 0;i < len;i++) {
      if (children[i] instanceof pc.Entity) {
        this.onInitialize(children[i]);
      }
    }
    this.initialized = true;
  }, onUpdate:function(dt) {
    var components = this.store;
    for (var id in components) {
      if (components.hasOwnProperty(id)) {
        var component = components[id];
        var entity = component.entity;
        var componentData = component.data;
        if (componentData.enabled && entity.enabled && componentData.channel instanceof pc.Channel3d) {
          var pos = entity.getPosition();
          componentData.channel.setPosition(pos);
        }
      }
    }
  }, onRemove:function(entity, data) {
    if (data.channel) {
      data.channel.stop();
      data.channel = null;
    }
  }, setVolume:function(volume) {
    this.manager.setVolume(volume);
  }});
  return {AudioSourceComponentSystem:AudioSourceComponentSystem};
}());
pc.AudioSourceComponentData = function AudioSourceComponentData() {
  this.enabled = true;
  this.assets = [];
  this.activate = true;
  this.volume = 1;
  this.pitch = 1;
  this.loop = false;
  this["3d"] = true;
  this.minDistance = 1;
  this.maxDistance = 10000;
  this.rollOffFactor = 1;
  this.distanceModel = pc.DISTANCE_INVERSE;
  this.paused = true;
  this.sources = {};
  this.currentSource = null;
  this.channel = null;
};
pc.extend(pc, function() {
  var AudioListenerComponent = function(system, entity) {
  };
  AudioListenerComponent = pc.inherits(AudioListenerComponent, pc.Component);
  pc.extend(AudioListenerComponent.prototype, {setCurrentListener:function() {
    if (this.enabled && this.entity.audiolistener && this.entity.enabled) {
      this.system.current = this.entity;
      var position = this.system.current.getPosition();
      this.system.manager.listener.setPosition(position);
    }
  }, onEnable:function() {
    AudioListenerComponent._super.onEnable.call(this);
    this.setCurrentListener();
  }, onDisable:function() {
    AudioListenerComponent._super.onDisable.call(this);
    if (this.system.current === this.entity) {
      this.system.current = null;
    }
  }});
  return {AudioListenerComponent:AudioListenerComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled"];
  var AudioListenerComponentSystem = function(app, manager) {
    this.id = "audiolistener";
    this.description = "Specifies the location of the listener for 3D audio playback.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.AudioListenerComponent;
    this.DataType = pc.AudioListenerComponentData;
    this.schema = _schema;
    this.manager = manager;
    this.current = null;
    pc.ComponentSystem.on("update", this.onUpdate, this);
  };
  AudioListenerComponentSystem = pc.inherits(AudioListenerComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.AudioListenerComponent.prototype, _schema);
  pc.extend(AudioListenerComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    properties = ["enabled"];
    AudioListenerComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, onUpdate:function(dt) {
    if (this.current) {
      var position = this.current.getPosition();
      this.manager.listener.setPosition(position);
      var wtm = this.current.getWorldTransform();
      this.manager.listener.setOrientation(wtm);
    }
  }});
  return {AudioListenerComponentSystem:AudioListenerComponentSystem};
}());
pc.extend(pc, function() {
  var AudioListenerComponentData = function() {
    this.enabled = true;
  };
  AudioListenerComponentData = pc.inherits(AudioListenerComponentData, pc.ComponentData);
  return {AudioListenerComponentData:AudioListenerComponentData};
}());
pc.extend(pc, {BODYTYPE_STATIC:"static", BODYTYPE_DYNAMIC:"dynamic", BODYTYPE_KINEMATIC:"kinematic", BODYFLAG_STATIC_OBJECT:1, BODYFLAG_KINEMATIC_OBJECT:2, BODYFLAG_NORESPONSE_OBJECT:4, BODYSTATE_ACTIVE_TAG:1, BODYSTATE_ISLAND_SLEEPING:2, BODYSTATE_WANTS_DEACTIVATION:3, BODYSTATE_DISABLE_DEACTIVATION:4, BODYSTATE_DISABLE_SIMULATION:5, BODYGROUP_NONE:0, BODYGROUP_DEFAULT:1, BODYGROUP_DYNAMIC:1, BODYGROUP_STATIC:2, BODYGROUP_KINEMATIC:4, BODYGROUP_ENGINE_1:8, BODYGROUP_TRIGGER:16, BODYGROUP_ENGINE_2:32,
BODYGROUP_ENGINE_3:64, BODYGROUP_USER_1:128, BODYGROUP_USER_2:256, BODYGROUP_USER_3:512, BODYGROUP_USER_4:1024, BODYGROUP_USER_5:2048, BODYGROUP_USER_6:4096, BODYGROUP_USER_7:8192, BODYGROUP_USER_8:16384, BODYMASK_NONE:0, BODYMASK_ALL:65535, BODYMASK_STATIC:2, BODYMASK_NOT_STATIC:65535 ^ 2, BODYMASK_NOT_STATIC_KINEMATIC:65535 ^ (2 | 4)});
pc.extend(pc, function() {
  var ammoTransform;
  var ammoVec1, ammoVec2, ammoQuat, ammoOrigin;
  var RigidBodyComponent = function RigidBodyComponent(system, entity) {
    if (typeof Ammo !== "undefined" && !ammoTransform) {
      ammoTransform = new Ammo.btTransform;
      ammoVec1 = new Ammo.btVector3;
      ammoVec2 = new Ammo.btVector3;
      ammoQuat = new Ammo.btQuaternion;
      ammoOrigin = new Ammo.btVector3(0, 0, 0);
    }
    this.on("set_mass", this.onSetMass, this);
    this.on("set_linearDamping", this.onSetLinearDamping, this);
    this.on("set_angularDamping", this.onSetAngularDamping, this);
    this.on("set_linearFactor", this.onSetLinearFactor, this);
    this.on("set_angularFactor", this.onSetAngularFactor, this);
    this.on("set_friction", this.onSetFriction, this);
    this.on("set_restitution", this.onSetRestitution, this);
    this.on("set_type", this.onSetType, this);
    this.on("set_group", this.onSetGroupOrMask, this);
    this.on("set_mask", this.onSetGroupOrMask, this);
    this.on("set_body", this.onSetBody, this);
    this._displacement = new pc.Vec3(0, 0, 0);
    this._linearVelocity = new pc.Vec3(0, 0, 0);
    this._angularVelocity = new pc.Vec3(0, 0, 0);
  };
  RigidBodyComponent = pc.inherits(RigidBodyComponent, pc.Component);
  Object.defineProperty(RigidBodyComponent.prototype, "bodyType", {get:function() {
    console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");
    return this.type;
  }, set:function(type) {
    console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");
    this.type = type;
  }});
  Object.defineProperty(RigidBodyComponent.prototype, "linearVelocity", {get:function() {
    if (!this.isKinematic()) {
      if (this.body) {
        var vel = this.body.getLinearVelocity();
        this._linearVelocity.set(vel.x(), vel.y(), vel.z());
        return this._linearVelocity;
      }
    } else {
      return this._linearVelocity;
    }
  }, set:function(lv) {
    this.activate();
    if (!this.isKinematic()) {
      var body = this.body;
      if (body) {
        ammoVec1.setValue(lv.x, lv.y, lv.z);
        body.setLinearVelocity(ammoVec1);
      }
    } else {
      this._linearVelocity.copy(lv);
    }
  }});
  Object.defineProperty(RigidBodyComponent.prototype, "angularVelocity", {get:function() {
    if (!this.isKinematic()) {
      if (this.body) {
        var vel = this.body.getAngularVelocity();
        this._angularVelocity.set(vel.x(), vel.y(), vel.z());
        return this._angularVelocity;
      }
    } else {
      return this._angularVelocity;
    }
  }, set:function(av) {
    this.activate();
    if (!this.isKinematic()) {
      var body = this.body;
      if (body) {
        ammoVec1.setValue(av.x, av.y, av.z);
        body.setAngularVelocity(ammoVec1);
      }
    } else {
      this._angularVelocity.copy(av);
    }
  }});
  pc.extend(RigidBodyComponent.prototype, {createBody:function() {
    var entity = this.entity;
    var shape;
    if (entity.collision) {
      shape = entity.collision.shape;
      if (entity.trigger) {
        entity.trigger.destroy();
        delete entity.trigger;
      }
    }
    if (shape) {
      if (this.body) {
        this.system.removeBody(this.body);
        Ammo.destroy(this.body);
      }
      var isStaticOrKinematic = this.isStaticOrKinematic();
      var mass = isStaticOrKinematic ? 0 : this.mass;
      var localInertia = new Ammo.btVector3(0, 0, 0);
      if (!isStaticOrKinematic) {
        shape.calculateLocalInertia(mass, localInertia);
      }
      var pos = entity.getPosition();
      var rot = entity.getRotation();
      ammoQuat.setValue(rot.x, rot.y, rot.z, rot.w);
      var startTransform = new Ammo.btTransform;
      startTransform.setIdentity();
      startTransform.getOrigin().setValue(pos.x, pos.y, pos.z);
      startTransform.setRotation(ammoQuat);
      var motionState = new Ammo.btDefaultMotionState(startTransform);
      var bodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
      var body = new Ammo.btRigidBody(bodyInfo);
      body.setRestitution(this.restitution);
      body.setFriction(this.friction);
      body.setDamping(this.linearDamping, this.angularDamping);
      var v;
      v = this.linearFactor;
      ammoVec1.setValue(v.x, v.y, v.z);
      body.setLinearFactor(ammoVec1);
      v = this.angularFactor;
      ammoVec1.setValue(v.x, v.y, v.z);
      body.setAngularFactor(ammoVec1);
      body.entity = entity;
      if (this.isKinematic()) {
        body.setCollisionFlags(body.getCollisionFlags() | pc.BODYFLAG_KINEMATIC_OBJECT);
        body.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION);
      }
      entity.rigidbody.body = body;
      if (this.enabled && this.entity.enabled) {
        this.enableSimulation();
      }
    }
  }, isActive:function() {
    if (this.body) {
      return this.body.isActive();
    }
    return false;
  }, activate:function() {
    if (this.body) {
      this.body.activate();
    }
  }, enableSimulation:function() {
    if (this.entity.collision && this.entity.collision.enabled && !this.data.simulationEnabled) {
      var body = this.body;
      if (body) {
        this.system.addBody(body, this.group, this.mask);
        if (this.isKinematic()) {
          body.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION);
          body.activate();
        } else {
          body.forceActivationState(pc.BODYFLAG_ACTIVE_TAG);
          this.syncEntityToBody();
        }
        this.data.simulationEnabled = true;
      }
    }
  }, disableSimulation:function() {
    var body = this.body;
    if (body && this.data.simulationEnabled) {
      this.system.removeBody(body);
      body.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION);
      this.data.simulationEnabled = false;
    }
  }, applyForce:function() {
    var x, y, z;
    var px, py, pz;
    switch(arguments.length) {
      case 1:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        break;
      case 2:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        px = arguments[1].x;
        py = arguments[1].y;
        pz = arguments[1].z;
        break;
      case 3:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        break;
      case 6:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        px = arguments[3];
        py = arguments[4];
        pz = arguments[5];
        break;
    }
    var body = this.body;
    if (body) {
      body.activate();
      ammoVec1.setValue(x, y, z);
      if (px !== undefined) {
        ammoVec2.setValue(px, py, pz);
        body.applyForce(ammoVec1, ammoVec2);
      } else {
        body.applyForce(ammoVec1, ammoOrigin);
      }
    }
  }, applyTorque:function() {
    var x, y, z;
    switch(arguments.length) {
      case 1:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        break;
      case 3:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        break;
      default:
        console.error("ERROR: applyTorque: function takes 1 or 3 arguments");
        return;
    }
    var body = this.body;
    if (body) {
      body.activate();
      ammoVec1.setValue(x, y, z);
      body.applyTorque(ammoVec1);
    }
  }, applyImpulse:function() {
    var x, y, z;
    var px, py, pz;
    switch(arguments.length) {
      case 1:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        break;
      case 2:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        px = arguments[1].x;
        py = arguments[1].y;
        pz = arguments[1].z;
        break;
      case 3:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        break;
      case 6:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        px = arguments[0];
        py = arguments[1];
        pz = arguments[2];
        break;
    }
    var body = this.body;
    if (body) {
      body.activate();
      ammoVec1.setValue(x, y, z);
      if (px !== undefined) {
        ammoVec2.setValue(px, py, pz);
        body.applyImpulse(ammoVec1, ammoVec2);
      } else {
        body.applyImpulse(ammoVec1, ammoOrigin);
      }
    }
  }, applyTorqueImpulse:function() {
    var x, y, z;
    switch(arguments.length) {
      case 1:
        x = arguments[0].x;
        y = arguments[0].y;
        z = arguments[0].z;
        break;
      case 3:
        x = arguments[0];
        y = arguments[1];
        z = arguments[2];
        break;
      default:
        console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");
        return;
    }
    var body = this.body;
    if (body) {
      body.activate();
      ammoVec1.setValue(x, y, z);
      body.applyTorqueImpulse(ammoVec1);
    }
  }, isStatic:function() {
    return this.type === pc.BODYTYPE_STATIC;
  }, isStaticOrKinematic:function() {
    return this.type === pc.BODYTYPE_STATIC || this.type === pc.BODYTYPE_KINEMATIC;
  }, isKinematic:function() {
    return this.type === pc.BODYTYPE_KINEMATIC;
  }, syncEntityToBody:function() {
    var body = this.body;
    if (body) {
      var pos = this.entity.getPosition();
      var rot = this.entity.getRotation();
      var transform = body.getWorldTransform();
      transform.getOrigin().setValue(pos.x, pos.y, pos.z);
      ammoQuat.setValue(rot.x, rot.y, rot.z, rot.w);
      transform.setRotation(ammoQuat);
      if (this.isKinematic()) {
        var motionState = this.body.getMotionState();
        if (motionState) {
          motionState.setWorldTransform(transform);
        }
      }
      body.activate();
    }
  }, syncBodyToEntity:function() {
    var body = this.body;
    if (body.isActive()) {
      var motionState = body.getMotionState();
      if (motionState) {
        motionState.getWorldTransform(ammoTransform);
        var p = ammoTransform.getOrigin();
        var q = ammoTransform.getRotation();
        this.entity.setPosition(p.x(), p.y(), p.z());
        this.entity.setRotation(q.x(), q.y(), q.z(), q.w());
      }
    }
  }, teleport:function() {
    if (arguments.length < 3) {
      if (arguments[0]) {
        this.entity.setPosition(arguments[0]);
      }
      if (arguments[1]) {
        if (arguments[1] instanceof pc.Quat) {
          this.entity.setRotation(arguments[1]);
        } else {
          this.entity.setEulerAngles(arguments[1]);
        }
      }
    } else {
      if (arguments.length === 6) {
        this.entity.setEulerAngles(arguments[3], arguments[4], arguments[5]);
      }
      this.entity.setPosition(arguments[0], arguments[1], arguments[2]);
    }
    this.syncEntityToBody();
  }, _updateKinematic:function(dt) {
    this._displacement.copy(this._linearVelocity).scale(dt);
    this.entity.translate(this._displacement);
    this._displacement.copy(this._angularVelocity).scale(dt);
    this.entity.rotate(this._displacement.x, this._displacement.y, this._displacement.z);
    if (this.body.getMotionState()) {
      var pos = this.entity.getPosition();
      var rot = this.entity.getRotation();
      ammoTransform.getOrigin().setValue(pos.x, pos.y, pos.z);
      ammoQuat.setValue(rot.x, rot.y, rot.z, rot.w);
      ammoTransform.setRotation(ammoQuat);
      this.body.getMotionState().setWorldTransform(ammoTransform);
    }
  }, onEnable:function() {
    RigidBodyComponent._super.onEnable.call(this);
    if (!this.body) {
      this.createBody();
    }
    this.enableSimulation();
  }, onDisable:function() {
    RigidBodyComponent._super.onDisable.call(this);
    this.disableSimulation();
  }, onSetMass:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      var isEnabled = this.enabled && this.entity.enabled;
      if (isEnabled) {
        this.disableSimulation();
      }
      var mass = newValue;
      var localInertia = new Ammo.btVector3(0, 0, 0);
      body.getCollisionShape().calculateLocalInertia(mass, localInertia);
      body.setMassProps(mass, localInertia);
      body.updateInertiaTensor();
      if (isEnabled) {
        this.enableSimulation();
      }
    }
  }, onSetLinearDamping:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      body.setDamping(newValue, this.data.angularDamping);
    }
  }, onSetAngularDamping:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      body.setDamping(this.data.linearDamping, newValue);
    }
  }, onSetLinearFactor:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      ammoVec1.setValue(newValue.x, newValue.y, newValue.z);
      body.setLinearFactor(ammoVec1);
    }
  }, onSetAngularFactor:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      ammoVec1.setValue(newValue.x, newValue.y, newValue.z);
      body.setAngularFactor(ammoVec1);
    }
  }, onSetFriction:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      body.setFriction(newValue);
    }
  }, onSetRestitution:function(name, oldValue, newValue) {
    var body = this.data.body;
    if (body) {
      body.setRestitution(newValue);
    }
  }, onSetType:function(name, oldValue, newValue) {
    if (newValue !== oldValue) {
      this.disableSimulation();
      if (newValue === pc.BODYTYPE_DYNAMIC) {
        this.data.group = pc.BODYGROUP_DYNAMIC;
        this.data.mask = pc.BODYMASK_ALL;
      } else {
        if (newValue === pc.BODYTYPE_KINEMATIC) {
          this.data.group = pc.BODYGROUP_KINEMATIC;
          this.data.mask = pc.BODYMASK_ALL;
        } else {
          this.data.group = pc.BODYGROUP_STATIC;
          this.data.mask = pc.BODYMASK_NOT_STATIC;
        }
      }
      this.createBody();
    }
  }, onSetGroupOrMask:function(name, oldValue, newValue) {
    if (newValue !== oldValue) {
      var isEnabled = this.enabled && this.entity.enabled;
      if (isEnabled) {
        this.disableSimulation();
        this.enableSimulation();
      }
    }
  }, onSetBody:function(name, oldValue, newValue) {
    if (this.body && this.data.simulationEnabled) {
      this.body.activate();
    }
  }});
  return {RigidBodyComponent:RigidBodyComponent};
}());
pc.extend(pc, function() {
  var transform = new pc.Mat4;
  var newWtm = new pc.Mat4;
  var position = new pc.Vec3;
  var rotation = new pc.Vec3;
  var scale = new pc.Vec3;
  var ammoRayStart, ammoRayEnd;
  var collisions = {};
  var frameCollisions = {};
  var WARNED_RAYCAST_CALLBACK = false;
  var RaycastResult = function RaycastResult(entity, point, normal) {
    this.entity = entity;
    this.point = point;
    this.normal = normal;
  };
  var SingleContactResult = function SingleContactResult(a, b, contactPoint) {
    if (arguments.length === 0) {
      this.a = null;
      this.b = null;
      this.localPointA = new pc.Vec3;
      this.localPointB = new pc.Vec3;
      this.pointA = new pc.Vec3;
      this.pointB = new pc.Vec3;
      this.normal = new pc.Vec3;
    } else {
      this.a = a;
      this.b = b;
      this.localPointA = contactPoint.localPoint;
      this.localPointB = contactPoint.localPointOther;
      this.pointA = contactPoint.point;
      this.pointB = contactPoint.pointOther;
      this.normal = contactPoint.normal;
    }
  };
  var ContactPoint = function ContactPoint(localPoint, localPointOther, point, pointOther, normal) {
    if (arguments.length === 0) {
      this.localPoint = new pc.Vec3;
      this.localPointOther = new pc.Vec3;
      this.point = new pc.Vec3;
      this.pointOther = new pc.Vec3;
      this.normal = new pc.Vec3;
    } else {
      this.localPoint = localPoint;
      this.localPointOther = localPointOther;
      this.point = point;
      this.pointOther = pointOther;
      this.normal = normal;
    }
  };
  var ContactResult = function ContactResult(other, contacts) {
    this.other = other;
    this.contacts = contacts;
  };
  var _schema = ["enabled", "type", "mass", "linearDamping", "angularDamping", "linearFactor", "angularFactor", "friction", "restitution", "group", "mask", "body"];
  var RigidBodyComponentSystem = function RigidBodyComponentSystem(app) {
    this.id = "rigidbody";
    this.description = "Adds the entity to the scene's physical simulation.";
    app.systems.add(this.id, this);
    this._stats = app.stats.frame;
    this.ComponentType = pc.RigidBodyComponent;
    this.DataType = pc.RigidBodyComponentData;
    this.contactPointPool = new pc.AllocatePool(ContactPoint, 1);
    this.contactResultPool = new pc.AllocatePool(ContactResult, 1);
    this.singleContactResultPool = new pc.AllocatePool(SingleContactResult, 1);
    this.schema = _schema;
    this.maxSubSteps = 10;
    this.fixedTimeStep = 1 / 60;
    this.on("remove", this.onRemove, this);
  };
  RigidBodyComponentSystem = pc.inherits(RigidBodyComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.RigidBodyComponent.prototype, _schema);
  pc.extend(RigidBodyComponentSystem.prototype, {onLibraryLoaded:function() {
    if (typeof Ammo !== "undefined") {
      var collisionConfiguration = new Ammo.btDefaultCollisionConfiguration;
      var dispatcher = new Ammo.btCollisionDispatcher(collisionConfiguration);
      var overlappingPairCache = new Ammo.btDbvtBroadphase;
      var solver = new Ammo.btSequentialImpulseConstraintSolver;
      this.dynamicsWorld = new Ammo.btDiscreteDynamicsWorld(dispatcher, overlappingPairCache, solver, collisionConfiguration);
      this._ammoGravity = new Ammo.btVector3(0, -9.82, 0);
      this.dynamicsWorld.setGravity(this._ammoGravity);
      ammoRayStart = new Ammo.btVector3;
      ammoRayEnd = new Ammo.btVector3;
      pc.ComponentSystem.on("update", this.onUpdate, this);
    } else {
      pc.ComponentSystem.off("update", this.onUpdate, this);
    }
  }, initializeComponentData:function(component, _data, properties) {
    properties = ["enabled", "mass", "linearDamping", "angularDamping", "linearFactor", "angularFactor", "friction", "restitution", "type", "group", "mask"];
    var data = {};
    properties.forEach(function(prop) {
      data[prop] = _data[prop];
    });
    if (_data.bodyType) {
      data.type = _data.bodyType;
      console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead.");
    }
    if (data.linearFactor && pc.type(data.linearFactor) === "array") {
      data.linearFactor = new pc.Vec3(data.linearFactor[0], data.linearFactor[1], data.linearFactor[2]);
    }
    if (data.angularFactor && pc.type(data.angularFactor) === "array") {
      data.angularFactor = new pc.Vec3(data.angularFactor[0], data.angularFactor[1], data.angularFactor[2]);
    }
    RigidBodyComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, cloneComponent:function(entity, clone) {
    var data = {enabled:entity.rigidbody.enabled, mass:entity.rigidbody.mass, linearDamping:entity.rigidbody.linearDamping, angularDamping:entity.rigidbody.angularDamping, linearFactor:[entity.rigidbody.linearFactor.x, entity.rigidbody.linearFactor.y, entity.rigidbody.linearFactor.z], angularFactor:[entity.rigidbody.angularFactor.x, entity.rigidbody.angularFactor.y, entity.rigidbody.angularFactor.z], friction:entity.rigidbody.friction, restitution:entity.rigidbody.restitution, type:entity.rigidbody.type,
    group:entity.rigidbody.group, mask:entity.rigidbody.mask};
    this.addComponent(clone, data);
  }, onRemove:function(entity, data) {
    if (data.body) {
      this.removeBody(data.body);
      Ammo.destroy(data.body);
    }
    data.body = null;
  }, addBody:function(body, group, mask) {
    if (group !== undefined && mask !== undefined) {
      this.dynamicsWorld.addRigidBody(body, group, mask);
    } else {
      this.dynamicsWorld.addRigidBody(body);
    }
    return body;
  }, removeBody:function(body) {
    this.dynamicsWorld.removeRigidBody(body);
  }, addConstraint:function(constraint) {
    this.dynamicsWorld.addConstraint(constraint);
    return constraint;
  }, removeConstraint:function(constraint) {
    this.dynamicsWorld.removeConstraint(constraint);
  }, setGravity:function() {
    var x, y, z;
    if (arguments.length === 1) {
      x = arguments[0].x;
      y = arguments[0].y;
      z = arguments[0].z;
    } else {
      x = arguments[0];
      y = arguments[1];
      z = arguments[2];
    }
    this._ammoGravity.setValue(x, y, z);
    this.dynamicsWorld.setGravity(this._ammoGravity);
  }, raycastFirst:function(start, end, callback) {
    var result = null;
    ammoRayStart.setValue(start.x, start.y, start.z);
    ammoRayEnd.setValue(end.x, end.y, end.z);
    var rayCallback = new Ammo.ClosestRayResultCallback(ammoRayStart, ammoRayEnd);
    this.dynamicsWorld.rayTest(ammoRayStart, ammoRayEnd, rayCallback);
    if (rayCallback.hasHit()) {
      var collisionObj = rayCallback.get_m_collisionObject();
      var body = Ammo.castObject(collisionObj, Ammo.btRigidBody);
      if (body) {
        var point = rayCallback.get_m_hitPointWorld();
        var normal = rayCallback.get_m_hitNormalWorld();
        result = new RaycastResult(body.entity, new pc.Vec3(point.x(), point.y(), point.z()), new pc.Vec3(normal.x(), normal.y(), normal.z()));
        if (callback) {
          callback(result);
          if (!WARNED_RAYCAST_CALLBACK) {
            console.warn("[DEPRECATED]: pc.RigidBodyComponentSystem#rayCastFirst no longer requires a callback. The result of the raycast is returned by the function instead.");
            WARNED_RAYCAST_CALLBACK = true;
          }
        }
      }
    }
    Ammo.destroy(rayCallback);
    return result;
  }, _storeCollision:function(entity, other) {
    var isNewCollision = false;
    var guid = entity._guid;
    collisions[guid] = collisions[guid] || {others:[], entity:entity};
    if (collisions[guid].others.indexOf(other) < 0) {
      collisions[guid].others.push(other);
      isNewCollision = true;
    }
    frameCollisions[guid] = frameCollisions[guid] || {others:[], entity:entity};
    frameCollisions[guid].others.push(other);
    return isNewCollision;
  }, _createContactPointFromAmmo:function(contactPoint) {
    var contact = this.contactPointPool.allocate();
    contact.localPoint.set(contactPoint.get_m_localPointA().x(), contactPoint.get_m_localPointA().y(), contactPoint.get_m_localPointA().z());
    contact.localPointOther.set(contactPoint.get_m_localPointB().x(), contactPoint.get_m_localPointB().y(), contactPoint.get_m_localPointB().z());
    contact.point.set(contactPoint.getPositionWorldOnA().x(), contactPoint.getPositionWorldOnA().y(), contactPoint.getPositionWorldOnA().z());
    contact.pointOther.set(contactPoint.getPositionWorldOnB().x(), contactPoint.getPositionWorldOnB().y(), contactPoint.getPositionWorldOnB().z());
    contact.normal.set(contactPoint.get_m_normalWorldOnB().x(), contactPoint.get_m_normalWorldOnB().y(), contactPoint.get_m_normalWorldOnB().z());
    return contact;
  }, _createReverseContactPointFromAmmo:function(contactPoint) {
    var contact = this.contactPointPool.allocate();
    contact.localPointOther.set(contactPoint.get_m_localPointA().x(), contactPoint.get_m_localPointA().y(), contactPoint.get_m_localPointA().z());
    contact.localPoint.set(contactPoint.get_m_localPointB().x(), contactPoint.get_m_localPointB().y(), contactPoint.get_m_localPointB().z());
    contact.pointOther.set(contactPoint.getPositionWorldOnA().x(), contactPoint.getPositionWorldOnA().y(), contactPoint.getPositionWorldOnA().z());
    contact.point.set(contactPoint.getPositionWorldOnB().x(), contactPoint.getPositionWorldOnB().y(), contactPoint.getPositionWorldOnB().z());
    contact.normal.set(contactPoint.get_m_normalWorldOnB().x(), contactPoint.get_m_normalWorldOnB().y(), contactPoint.get_m_normalWorldOnB().z());
    return contact;
  }, _createSingleContactResult:function(a, b, contactPoint) {
    var result = this.singleContactResultPool.allocate();
    result.a = a;
    result.b = b;
    result.localPointA = contactPoint.localPoint;
    result.localPointB = contactPoint.localPointOther;
    result.pointA = contactPoint.point;
    result.pointB = contactPoint.pointOther;
    result.normal = contactPoint.normal;
    return result;
  }, _createContactResult:function(other, contacts) {
    var result = this.contactResultPool.allocate();
    result.other = other;
    result.contacts = contacts;
    return result;
  }, _cleanOldCollisions:function() {
    for (var guid in collisions) {
      if (collisions.hasOwnProperty(guid)) {
        var entity = collisions[guid].entity;
        var entityCollision = entity.collision;
        var others = collisions[guid].others;
        var length = others.length;
        var i = length;
        while (i--) {
          var other = others[i];
          if (!frameCollisions[guid] || frameCollisions[guid].others.indexOf(other) < 0) {
            others.splice(i, 1);
            if (entityCollision && other.collision) {
              if (entity.rigidbody && other.rigidbody) {
                entityCollision.fire("collisionend", other);
              } else {
                if (entity.trigger) {
                  entityCollision.fire("triggerleave", other);
                }
              }
            }
          }
        }
        if (others.length === 0) {
          delete collisions[guid];
        }
      }
    }
  }, onUpdate:function(dt) {
    var frameContacts = 0;
    this.dynamicsWorld.stepSimulation(dt, this.maxSubSteps, this.fixedTimeStep);
    var components = this.store;
    for (var id in components) {
      if (components.hasOwnProperty(id)) {
        var entity = components[id].entity;
        var componentData = components[id].data;
        if (componentData.body && componentData.body.isActive() && componentData.enabled && entity.enabled) {
          if (componentData.type === pc.BODYTYPE_DYNAMIC) {
            entity.rigidbody.syncBodyToEntity();
          } else {
            if (componentData.type === pc.BODYTYPE_KINEMATIC) {
              entity.rigidbody._updateKinematic(dt);
            }
          }
        }
      }
    }
    var dispatcher = this.dynamicsWorld.getDispatcher();
    var numManifolds = dispatcher.getNumManifolds();
    var i, j;
    frameCollisions = {};
    for (i = 0;i < numManifolds;i++) {
      var manifold = dispatcher.getManifoldByIndexInternal(i);
      var body0 = manifold.getBody0();
      var body1 = manifold.getBody1();
      var wb0 = Ammo.castObject(body0, Ammo.btRigidBody);
      var wb1 = Ammo.castObject(body1, Ammo.btRigidBody);
      var e0 = wb0.entity;
      var e1 = wb1.entity;
      if (!e0 || !e1) {
        continue;
      }
      var flags0 = body0.getCollisionFlags();
      var flags1 = body1.getCollisionFlags();
      var numContacts = manifold.getNumContacts();
      var forwardContacts = [];
      var reverseContacts = [];
      var newCollision, e0Events, e1Events;
      if (numContacts > 0) {
        if (flags0 & pc.BODYFLAG_NORESPONSE_OBJECT || flags1 & pc.BODYFLAG_NORESPONSE_OBJECT) {
          e0Events = e0.collision ? e0.collision.hasEvent("triggerenter") || e0.collision.hasEvent("triggerleave") : false;
          e1Events = e1.collision ? e1.collision.hasEvent("triggerenter") || e1.collision.hasEvent("triggerleave") : false;
          if (e0Events) {
            newCollision = this._storeCollision(e0, e1);
            if (newCollision) {
              if (e0.collision && !(flags1 & pc.BODYFLAG_NORESPONSE_OBJECT)) {
                e0.collision.fire("triggerenter", e1);
              }
            }
          }
          if (e1Events) {
            newCollision = this._storeCollision(e1, e0);
            if (newCollision) {
              if (e1.collision && !(flags0 & pc.BODYFLAG_NORESPONSE_OBJECT)) {
                e1.collision.fire("triggerenter", e0);
              }
            }
          }
        } else {
          e0Events = e0.collision ? e0.collision.hasEvent("collisionstart") || e0.collision.hasEvent("collisionend") || e0.collision.hasEvent("contact") : false;
          e1Events = e1.collision ? e1.collision.hasEvent("collisionstart") || e1.collision.hasEvent("collisionend") || e1.collision.hasEvent("contact") : false;
          var globalEvents = this.hasEvent("contact");
          if (globalEvents || e0Events || e1Events) {
            for (j = 0;j < numContacts;j++) {
              var btContactPoint = manifold.getContactPoint(j);
              var contactPoint = this._createContactPointFromAmmo(btContactPoint);
              var reverseContactPoint = null;
              if (e0Events || e1Events) {
                reverseContactPoint = this._createReverseContactPointFromAmmo(btContactPoint);
                forwardContacts.push(contactPoint);
                reverseContacts.push(reverseContactPoint);
              }
              if (globalEvents) {
                var result = this._createSingleContactResult(e0, e1, contactPoint);
                this.fire("contact", result);
              }
            }
            if (e0Events) {
              var forwardResult = this._createContactResult(e1, forwardContacts);
              if (e0.collision) {
                e0.collision.fire("contact", forwardResult);
              }
              newCollision = this._storeCollision(e0, e1);
              if (newCollision && e0.collision) {
                e0.collision.fire("collisionstart", forwardResult);
              }
            }
            if (e1Events) {
              var reverseResult = this._createContactResult(e0, reverseContacts);
              if (e1.collision) {
                e1.collision.fire("contact", reverseResult);
              }
              newCollision = this._storeCollision(e1, e0);
              if (newCollision && e1.collision) {
                e1.collision.fire("collisionstart", reverseResult);
              }
            }
          }
        }
      }
    }
    this._cleanOldCollisions();
    this.contactPointPool.freeAll();
    this.contactResultPool.freeAll();
    this.singleContactResultPool.freeAll();
  }});
  return {RIGIDBODY_TYPE_STATIC:"static", RIGIDBODY_TYPE_DYNAMIC:"dynamic", RIGIDBODY_TYPE_KINEMATIC:"kinematic", RIGIDBODY_CF_STATIC_OBJECT:1, RIGIDBODY_CF_KINEMATIC_OBJECT:2, RIGIDBODY_CF_NORESPONSE_OBJECT:4, RIGIDBODY_ACTIVE_TAG:1, RIGIDBODY_ISLAND_SLEEPING:2, RIGIDBODY_WANTS_DEACTIVATION:3, RIGIDBODY_DISABLE_DEACTIVATION:4, RIGIDBODY_DISABLE_SIMULATION:5, RigidBodyComponentSystem:RigidBodyComponentSystem};
}());
pc.extend(pc, function() {
  var RigidBodyComponentData = function() {
    this.enabled = true;
    this.mass = 1;
    this.linearDamping = 0;
    this.angularDamping = 0;
    this.linearFactor = new pc.Vec3(1, 1, 1);
    this.angularFactor = new pc.Vec3(1, 1, 1);
    this.friction = 0.5;
    this.restitution = 0;
    this.type = pc.BODYTYPE_STATIC;
    this.group = pc.BODYGROUP_STATIC;
    this.mask = pc.BODYMASK_NOT_STATIC;
    this.body = null;
    this.simulationEnabled = false;
  };
  RigidBodyComponentData = pc.inherits(RigidBodyComponentData, pc.ComponentData);
  return {RigidBodyComponentData:RigidBodyComponentData};
}());
pc.extend(pc, function() {
  var ammoVec1, ammoQuat;
  var Trigger = function Trigger(app, component, data) {
    this.entity = component.entity;
    this.component = component;
    this.app = app;
    if (typeof Ammo !== "undefined") {
      ammoVec1 = new Ammo.btVector3;
      ammoQuat = new Ammo.btQuaternion;
    }
    this.initialize(data);
  };
  Trigger.prototype = {initialize:function(data) {
    var entity = this.entity;
    var shape = data.shape;
    if (shape && typeof Ammo !== "undefined") {
      if (entity.trigger) {
        entity.trigger.destroy();
      }
      var mass = 1;
      var localInertia = new Ammo.btVector3(0, 0, 0);
      shape.calculateLocalInertia(mass, localInertia);
      var pos = entity.getPosition();
      var rot = entity.getRotation();
      ammoQuat.setValue(rot.x, rot.y, rot.z, rot.w);
      var startTransform = new Ammo.btTransform;
      startTransform.setIdentity();
      startTransform.getOrigin().setValue(pos.x, pos.y, pos.z);
      startTransform.setRotation(ammoQuat);
      var motionState = new Ammo.btDefaultMotionState(startTransform);
      var bodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
      var body = new Ammo.btRigidBody(bodyInfo);
      this.body = body;
      body.setRestitution(0);
      body.setFriction(0);
      body.setDamping(0, 0);
      ammoVec1.setValue(0, 0, 0);
      body.setLinearFactor(ammoVec1);
      body.setAngularFactor(ammoVec1);
      body.setCollisionFlags(body.getCollisionFlags() | pc.BODYFLAG_NORESPONSE_OBJECT);
      body.entity = entity;
      if (this.component.enabled && entity.enabled) {
        this.enable();
      }
    }
  }, destroy:function() {
    if (this.body) {
      this.app.systems.rigidbody.removeBody(this.body);
    }
  }, syncEntityToBody:function() {
    var body = this.body;
    if (body) {
      var position = this.entity.getPosition();
      var rotation = this.entity.getRotation();
      var transform = body.getWorldTransform();
      transform.getOrigin().setValue(position.x, position.y, position.z);
      ammoQuat.setValue(rotation.x, rotation.y, rotation.z, rotation.w);
      transform.setRotation(ammoQuat);
      body.activate();
    }
  }, enable:function() {
    var body = this.body;
    if (!body) {
      return;
    }
    this.app.systems.rigidbody.addBody(body, pc.BODYGROUP_TRIGGER, pc.BODYMASK_NOT_STATIC ^ pc.BODYGROUP_TRIGGER);
    body.forceActivationState(pc.BODYSTATE_ACTIVE_TAG);
    body.activate();
    this.syncEntityToBody();
  }, disable:function() {
    var body = this.body;
    if (!body) {
      return;
    }
    this.app.systems.rigidbody.removeBody(body);
    body.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION);
  }};
  return {Trigger:Trigger};
}());
pc.extend(pc, function() {
  var CollisionComponent = function CollisionComponent(system, entity) {
    this.on("set_type", this.onSetType, this);
    this.on("set_halfExtents", this.onSetHalfExtents, this);
    this.on("set_radius", this.onSetRadius, this);
    this.on("set_height", this.onSetHeight, this);
    this.on("set_axis", this.onSetAxis, this);
    this.on("set_asset", this.onSetAsset, this);
    this.on("set_model", this.onSetModel, this);
  };
  CollisionComponent = pc.inherits(CollisionComponent, pc.Component);
  pc.extend(CollisionComponent.prototype, {onSetType:function(name, oldValue, newValue) {
    if (oldValue !== newValue) {
      this.system.changeType(this, oldValue, newValue);
    }
  }, onSetHalfExtents:function(name, oldValue, newValue) {
    if (this.data.initialized && this.data.type === "box") {
      this.system.recreatePhysicalShapes(this);
    }
  }, onSetRadius:function(name, oldValue, newValue) {
    if (this.data.initialized && (this.data.type === "sphere" || this.data.type === "capsule" || this.data.type === "cylinder")) {
      this.system.recreatePhysicalShapes(this);
    }
  }, onSetHeight:function(name, oldValue, newValue) {
    if (this.data.initialized && (this.data.type === "capsule" || this.data.type === "cylinder")) {
      this.system.recreatePhysicalShapes(this);
    }
  }, onSetAxis:function(name, oldValue, newValue) {
    if (this.data.initialized && (this.data.type === "capsule" || this.data.type === "cylinder")) {
      this.system.recreatePhysicalShapes(this);
    }
  }, onSetAsset:function(name, oldValue, newValue) {
    var self = this;
    var asset;
    var assets = this.system.app.assets;
    if (oldValue) {
      asset = assets.get(oldValue);
      if (asset) {
        asset.off("remove", this.onAssetRemoved, this);
      }
    }
    if (newValue) {
      if (newValue instanceof pc.Asset) {
        this.data.asset = newValue.id;
      }
      asset = assets.get(this.data.asset);
      if (asset) {
        asset.off("remove", this.onAssetRemoved, this);
        asset.on("remove", this.onAssetRemoved, this);
      }
    }
    if (this.data.initialized && this.data.type === "mesh") {
      if (!newValue) {
        this.data.model = null;
      }
      this.system.recreatePhysicalShapes(this);
    }
  }, onSetModel:function(name, oldValue, newValue) {
    if (this.data.initialized && this.data.type === "mesh") {
      this.system.implementations.mesh.doRecreatePhysicalShape(this);
    }
  }, onAssetRemoved:function(asset) {
    asset.off("remove", this.onAssetRemoved, this);
    if (this.data.asset === asset.id) {
      this.asset = null;
    }
  }, onEnable:function() {
    CollisionComponent._super.onEnable.call(this);
    if (this.data.type === "mesh" && this.data.asset && this.data.initialized) {
      var asset = this.system.app.assets.get(this.data.asset);
      if (asset && (!asset.resource || !this.data.shape)) {
        this.system.recreatePhysicalShapes(this);
        return;
      }
    }
    if (this.entity.trigger) {
      this.entity.trigger.enable();
    } else {
      if (this.entity.rigidbody) {
        if (this.entity.rigidbody.enabled) {
          this.entity.rigidbody.enableSimulation();
        }
      }
    }
  }, onDisable:function() {
    CollisionComponent._super.onDisable.call(this);
    if (this.entity.trigger) {
      this.entity.trigger.disable();
    } else {
      if (this.entity.rigidbody) {
        this.entity.rigidbody.disableSimulation();
      }
    }
  }});
  return {CollisionComponent:CollisionComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "type", "halfExtents", "radius", "axis", "height", "asset", "shape", "model"];
  var CollisionComponentSystem = function CollisionComponentSystem(app) {
    this.id = "collision";
    this.description = "Specifies a collision volume.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.CollisionComponent;
    this.DataType = pc.CollisionComponentData;
    this.schema = _schema;
    this.implementations = {};
    this.on("remove", this.onRemove, this);
    pc.ComponentSystem.on("update", this.onUpdate, this);
  };
  CollisionComponentSystem = pc.inherits(CollisionComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.CollisionComponent.prototype, _schema);
  CollisionComponentSystem.prototype = pc.extend(CollisionComponentSystem.prototype, {onLibraryLoaded:function() {
    if (typeof Ammo !== "undefined") {
    } else {
      pc.ComponentSystem.off("update", this.onUpdate, this);
    }
  }, initializeComponentData:function(component, _data, properties) {
    var idx;
    var data = {};
    properties = ["type", "halfExtents", "radius", "axis", "height", "shape", "model", "asset", "enabled"];
    properties.forEach(function(prop) {
      data[prop] = _data[prop];
    });
    if (_data.hasOwnProperty("asset")) {
      idx = properties.indexOf("model");
      if (idx !== -1) {
        properties.splice(idx, 1);
      }
    } else {
      if (_data.hasOwnProperty("model")) {
        idx = properties.indexOf("asset");
        if (idx !== -1) {
          properties.splice(idx, 1);
        }
      }
    }
    if (!data.type) {
      data.type = component.data.type;
    }
    component.data.type = data.type;
    if (data.halfExtents && pc.type(data.halfExtents) === "array") {
      data.halfExtents = new pc.Vec3(data.halfExtents[0], data.halfExtents[1], data.halfExtents[2]);
    }
    var impl = this._createImplementation(data.type);
    impl.beforeInitialize(component, data);
    CollisionComponentSystem._super.initializeComponentData.call(this.system, component, data, properties);
    impl.afterInitialize(component, data);
  }, _createImplementation:function(type) {
    if (this.implementations[type] === undefined) {
      var impl;
      switch(type) {
        case "box":
          impl = new CollisionBoxSystemImpl(this);
          break;
        case "sphere":
          impl = new CollisionSphereSystemImpl(this);
          break;
        case "capsule":
          impl = new CollisionCapsuleSystemImpl(this);
          break;
        case "cylinder":
          impl = new CollisionCylinderSystemImpl(this);
          break;
        case "mesh":
          impl = new CollisionMeshSystemImpl(this);
          break;
        default:
          throw "Invalid collision system type: " + type;
      }
      this.implementations[type] = impl;
    }
    return this.implementations[type];
  }, _getImplementation:function(entity) {
    return this.implementations[entity.collision.data.type];
  }, cloneComponent:function(entity, clone) {
    return this._getImplementation(entity).clone(entity, clone);
  }, onRemove:function(entity, data) {
    this.implementations[data.type].remove(entity, data);
  }, onUpdate:function(dt) {
    var id, entity, data;
    var components = this.store;
    for (id in components) {
      entity = components[id].entity;
      data = components[id].data;
      if (data.enabled && entity.enabled) {
        if (!entity.rigidbody && entity.trigger) {
          entity.trigger.syncEntityToBody();
        }
      }
    }
  }, onTransformChanged:function(component, position, rotation, scale) {
    this.implementations[component.data.type].updateTransform(component, position, rotation, scale);
  }, changeType:function(component, previousType, newType) {
    this.implementations[previousType].remove(component.entity, component.data);
    this._createImplementation(newType).reset(component, component.data);
  }, recreatePhysicalShapes:function(component) {
    this.implementations[component.data.type].recreatePhysicalShapes(component);
  }});
  var CollisionSystemImpl = function(system) {
    this.system = system;
  };
  CollisionSystemImpl.prototype = {beforeInitialize:function(component, data) {
    data.shape = this.createPhysicalShape(component.entity, data);
    data.model = new pc.Model;
    data.model.graph = new pc.GraphNode;
  }, afterInitialize:function(component, data) {
    this.recreatePhysicalShapes(component);
    component.data.initialized = true;
  }, reset:function(component, data) {
    this.beforeInitialize(component, data);
    this.afterInitialize(component, data);
  }, recreatePhysicalShapes:function(component) {
    var entity = component.entity;
    var data = component.data;
    if (typeof Ammo !== "undefined") {
      data.shape = this.createPhysicalShape(component.entity, data);
      if (entity.rigidbody) {
        entity.rigidbody.disableSimulation();
        entity.rigidbody.createBody();
      } else {
        if (!entity.trigger) {
          entity.trigger = new pc.Trigger(this.system.app, component, data);
        } else {
          entity.trigger.initialize(data);
        }
      }
    }
  }, createPhysicalShape:function(entity, data) {
    return undefined;
  }, updateTransform:function(component, position, rotation, scale) {
    if (component.entity.trigger) {
      component.entity.trigger.syncEntityToBody();
    }
  }, remove:function(entity, data) {
    var app = this.system.app;
    if (entity.rigidbody && entity.rigidbody.body) {
      app.systems.rigidbody.removeBody(entity.rigidbody.body);
      entity.rigidbody.disableSimulation();
    }
    if (entity.trigger) {
      entity.trigger.destroy();
      delete entity.trigger;
    }
    if (app.scene.containsModel(data.model)) {
      app.root.removeChild(data.model.graph);
      app.scene.removeModel(data.model);
    }
  }, clone:function(entity, clone) {
    var src = this.system.dataStore[entity._guid];
    var data = {enabled:src.data.enabled, type:src.data.type, halfExtents:[src.data.halfExtents.x, src.data.halfExtents.y, src.data.halfExtents.z], radius:src.data.radius, axis:src.data.axis, height:src.data.height, asset:src.data.asset, model:src.data.model};
    return this.system.addComponent(clone, data);
  }};
  var CollisionBoxSystemImpl = function(system) {
  };
  CollisionBoxSystemImpl = pc.inherits(CollisionBoxSystemImpl, CollisionSystemImpl);
  CollisionBoxSystemImpl.prototype = pc.extend(CollisionBoxSystemImpl.prototype, {createPhysicalShape:function(entity, data) {
    if (typeof Ammo !== "undefined") {
      var he = data.halfExtents;
      var ammoHe = new Ammo.btVector3(he ? he.x : 0.5, he ? he.y : 0.5, he ? he.z : 0.5);
      return new Ammo.btBoxShape(ammoHe);
    } else {
      return undefined;
    }
  }});
  var CollisionSphereSystemImpl = function(system) {
  };
  CollisionSphereSystemImpl = pc.inherits(CollisionSphereSystemImpl, CollisionSystemImpl);
  CollisionSphereSystemImpl.prototype = pc.extend(CollisionSphereSystemImpl.prototype, {createPhysicalShape:function(entity, data) {
    if (typeof Ammo !== "undefined") {
      return new Ammo.btSphereShape(data.radius);
    } else {
      return undefined;
    }
  }});
  var CollisionCapsuleSystemImpl = function(system) {
  };
  CollisionCapsuleSystemImpl = pc.inherits(CollisionCapsuleSystemImpl, CollisionSystemImpl);
  CollisionCapsuleSystemImpl.prototype = pc.extend(CollisionCapsuleSystemImpl.prototype, {createPhysicalShape:function(entity, data) {
    var shape = null;
    var axis = data.axis !== undefined ? data.axis : 1;
    var radius = data.radius || 0.5;
    var height = Math.max((data.height || 2) - 2 * radius, 0);
    if (typeof Ammo !== "undefined") {
      switch(axis) {
        case 0:
          shape = new Ammo.btCapsuleShapeX(radius, height);
          break;
        case 1:
          shape = new Ammo.btCapsuleShape(radius, height);
          break;
        case 2:
          shape = new Ammo.btCapsuleShapeZ(radius, height);
          break;
      }
    }
    return shape;
  }});
  var CollisionCylinderSystemImpl = function(system) {
  };
  CollisionCylinderSystemImpl = pc.inherits(CollisionCylinderSystemImpl, CollisionSystemImpl);
  CollisionCylinderSystemImpl.prototype = pc.extend(CollisionCylinderSystemImpl.prototype, {createPhysicalShape:function(entity, data) {
    var halfExtents = null;
    var shape = null;
    var axis = data.axis !== undefined ? data.axis : 1;
    var radius = data.radius !== undefined ? data.radius : 0.5;
    var height = data.height !== undefined ? data.height : 1;
    if (typeof Ammo !== "undefined") {
      switch(axis) {
        case 0:
          halfExtents = new Ammo.btVector3(height * 0.5, radius, radius);
          shape = new Ammo.btCylinderShapeX(halfExtents);
          break;
        case 1:
          halfExtents = new Ammo.btVector3(radius, height * 0.5, radius);
          shape = new Ammo.btCylinderShape(halfExtents);
          break;
        case 2:
          halfExtents = new Ammo.btVector3(radius, radius, height * 0.5);
          shape = new Ammo.btCylinderShapeZ(halfExtents);
          break;
      }
    }
    return shape;
  }});
  var CollisionMeshSystemImpl = function(system) {
  };
  CollisionMeshSystemImpl = pc.inherits(CollisionMeshSystemImpl, CollisionSystemImpl);
  CollisionMeshSystemImpl.prototype = pc.extend(CollisionMeshSystemImpl.prototype, {beforeInitialize:function(component, data) {
  }, createPhysicalShape:function(entity, data) {
    if (typeof Ammo !== "undefined" && data.model) {
      var model = data.model;
      var shape = new Ammo.btCompoundShape;
      var i, j;
      for (i = 0;i < model.meshInstances.length;i++) {
        var meshInstance = model.meshInstances[i];
        var mesh = meshInstance.mesh;
        var ib = mesh.indexBuffer[pc.RENDERSTYLE_SOLID];
        var vb = mesh.vertexBuffer;
        var format = vb.getFormat();
        var stride = format.size / 4;
        var positions;
        for (j = 0;j < format.elements.length;j++) {
          var element = format.elements[j];
          if (element.name === pc.SEMANTIC_POSITION) {
            positions = new Float32Array(vb.lock(), element.offset);
          }
        }
        var indices = new Uint16Array(ib.lock());
        var numTriangles = mesh.primitive[0].count / 3;
        var v1 = new Ammo.btVector3;
        var v2 = new Ammo.btVector3;
        var v3 = new Ammo.btVector3;
        var i1, i2, i3;
        var base = mesh.primitive[0].base;
        var triMesh = new Ammo.btTriangleMesh;
        for (j = 0;j < numTriangles;j++) {
          i1 = indices[base + j * 3] * stride;
          i2 = indices[base + j * 3 + 1] * stride;
          i3 = indices[base + j * 3 + 2] * stride;
          v1.setValue(positions[i1], positions[i1 + 1], positions[i1 + 2]);
          v2.setValue(positions[i2], positions[i2 + 1], positions[i2 + 2]);
          v3.setValue(positions[i3], positions[i3 + 1], positions[i3 + 2]);
          triMesh.addTriangle(v1, v2, v3, true);
        }
        var useQuantizedAabbCompression = true;
        var triMeshShape = new Ammo.btBvhTriangleMeshShape(triMesh, useQuantizedAabbCompression);
        var wtm = meshInstance.node.getWorldTransform();
        var scl = wtm.getScale();
        triMeshShape.setLocalScaling(new Ammo.btVector3(scl.x, scl.y, scl.z));
        var pos = meshInstance.node.getPosition();
        var rot = meshInstance.node.getRotation();
        var transform = new Ammo.btTransform;
        transform.setIdentity();
        transform.getOrigin().setValue(pos.x, pos.y, pos.z);
        var ammoQuat = new Ammo.btQuaternion;
        ammoQuat.setValue(rot.x, rot.y, rot.z, rot.w);
        transform.setRotation(ammoQuat);
        shape.addChildShape(transform, triMeshShape);
      }
      var entityTransform = entity.getWorldTransform();
      var scale = entityTransform.getScale();
      var vec = new Ammo.btVector3;
      vec.setValue(scale.x, scale.y, scale.z);
      shape.setLocalScaling(vec);
      return shape;
    } else {
      return undefined;
    }
  }, recreatePhysicalShapes:function(component) {
    var data = component.data;
    if (data.asset !== null && component.enabled && component.entity.enabled) {
      this.loadModelAsset(component);
    } else {
      this.doRecreatePhysicalShape(component);
    }
  }, loadModelAsset:function(component) {
    var self = this;
    var id = component.data.asset;
    var data = component.data;
    var assets = this.system.app.assets;
    var asset = assets.get(id);
    if (asset) {
      asset.ready(function(asset) {
        data.model = asset.resource;
        self.doRecreatePhysicalShape(component);
      });
      assets.load(asset);
    } else {
      assets.once("add:" + id, function(asset) {
        asset.ready(function(asset) {
          data.model = asset.resource;
          self.doRecreatePhysicalShape(component);
        });
        assets.load(asset);
      });
    }
  }, doRecreatePhysicalShape:function(component) {
    var entity = component.entity;
    var data = component.data;
    if (data.model) {
      if (data.shape) {
        Ammo.destroy(data.shape);
      }
      data.shape = this.createPhysicalShape(entity, data);
      if (entity.rigidbody) {
        entity.rigidbody.createBody();
      } else {
        if (!entity.trigger) {
          entity.trigger = new pc.Trigger(this.system.app, component, data);
        } else {
          entity.trigger.initialize(data);
        }
      }
    } else {
      this.remove(entity, data);
    }
  }, updateTransform:function(component, position, rotation, scale) {
    if (component.shape) {
      var entityTransform = component.entity.getWorldTransform();
      var worldScale = entityTransform.getScale();
      var previousScale = component.shape.getLocalScaling();
      if (worldScale.x !== previousScale.x() || worldScale.y !== previousScale.y() || worldScale.z !== previousScale.z()) {
        this.doRecreatePhysicalShape(component);
      }
    }
    CollisionMeshSystemImpl._super.updateTransform.call(this, component, position, rotation, scale);
  }});
  return {CollisionComponentSystem:CollisionComponentSystem};
}());
pc.extend(pc, function() {
  var CollisionComponentData = function() {
    this.enabled = true;
    this.type = "box";
    this.halfExtents = new pc.Vec3(0.5, 0.5, 0.5);
    this.radius = 0.5;
    this.axis = 1;
    this.height = 2;
    this.asset = null;
    this.shape = null;
    this.model = null;
    this.initialized = false;
  };
  CollisionComponentData = pc.inherits(CollisionComponentData, pc.ComponentData);
  return {CollisionComponentData:CollisionComponentData};
}());
pc.extend(pc, function() {
  var SIMPLE_PROPERTIES = ["emitterExtents", "emitterRadius", "loop", "initialVelocity", "animSpeed", "normalMap"];
  var COMPLEX_PROPERTIES = ["numParticles", "lifetime", "rate", "rate2", "startAngle", "startAngle2", "lighting", "halfLambert", "intensity", "wrap", "wrapBounds", "depthWrite", "noFog", "sort", "stretch", "alignToMotion", "preWarm", "emitterShape", "animTilesX", "animTilesY", "animFrames", "animLoop", "colorMap", "localSpace"];
  var GRAPH_PROPERTIES = ["scaleGraph", "scaleGraph2", "colorGraph", "colorGraph2", "alphaGraph", "alphaGraph2", "velocityGraph", "velocityGraph2", "localVelocityGraph", "localVelocityGraph2", "rotationSpeedGraph", "rotationSpeedGraph2"];
  var ASSET_PROPERTIES = ["colorMapAsset", "normalMapAsset", "mesh"];
  var ParticleSystemComponent = function ParticleSystemComponent(system, entity) {
    this.on("set_colorMapAsset", this.onSetColorMapAsset, this);
    this.on("set_normalMapAsset", this.onSetNormalMapAsset, this);
    this.on("set_mesh", this.onSetMesh, this);
    this.on("set_loop", this.onSetLoop, this);
    this.on("set_blendType", this.onSetBlendType, this);
    this.on("set_depthSoftening", this.onSetDepthSoftening, this);
    SIMPLE_PROPERTIES.forEach(function(prop) {
      this.on("set_" + prop, this.onSetSimpleProperty, this);
    }.bind(this));
    COMPLEX_PROPERTIES.forEach(function(prop) {
      this.on("set_" + prop, this.onSetComplexProperty, this);
    }.bind(this));
    GRAPH_PROPERTIES.forEach(function(prop) {
      this.on("set_" + prop, this.onSetGraphProperty, this);
    }.bind(this));
  };
  ParticleSystemComponent = pc.inherits(ParticleSystemComponent, pc.Component);
  pc.extend(ParticleSystemComponent.prototype, {onSetColorMapAsset:function(name, oldValue, newValue) {
    var self = this;
    var asset;
    var assets = this.system.app.assets;
    if (oldValue) {
      asset = assets.get(oldValue);
      if (asset) {
        asset.off("remove", this.onColorMapRemoved, this);
      }
    }
    if (newValue) {
      if (newValue instanceof pc.Asset) {
        this.data.colorMapAsset = newValue.id;
        newValue = newValue.id;
      }
      asset = assets.get(newValue);
      if (asset) {
        asset.on("remove", this.onColorMapRemoved, this);
        asset.ready(function(asset) {
          self.colorMap = asset.resource;
        });
        if (self.enabled && self.entity.enabled) {
          assets.load(asset);
        }
      } else {
        assets.once("add:" + newValue, function(asset) {
          asset.on("remove", this.onColorMapRemoved, this);
          asset.ready(function(asset) {
            self.colorMap = asset.resource;
          });
          if (self.enabled && self.entity.enabled) {
            assets.load(asset);
          }
        });
      }
    } else {
      this.colorMap = null;
    }
  }, onColorMapRemoved:function(asset) {
    asset.off("remove", this.onColorMapRemoved, this);
    this.colorMapAsset = null;
  }, onSetNormalMapAsset:function(name, oldValue, newValue) {
    var self = this;
    var asset;
    var assets = this.system.app.assets;
    if (oldValue) {
      asset = assets.get(oldValue);
      if (asset) {
        asset.off("remove", this.onNormalMapRemoved, this);
      }
    }
    if (newValue) {
      if (newValue instanceof pc.Asset) {
        this.data.normalMapAsset = newValue.id;
        newValue = newValue.id;
      }
      asset = assets.get(newValue);
      if (asset) {
        asset.on("remove", this.onNormalMapRemoved, this);
        asset.ready(function(asset) {
          self.normalMap = asset.resource;
        });
        if (self.enabled && self.entity.enabled) {
          assets.load(asset);
        }
      } else {
        assets.once("add:" + newValue, function(asset) {
          asset.on("remove", this.onNormalMapRemoved, this);
          asset.ready(function(asset) {
            self.normalMap = asset.resource;
          });
          if (self.enabled && self.entity.enabled) {
            assets.load(asset);
          }
        });
      }
    } else {
      this.normalMap = null;
    }
  }, onNormalMapRemoved:function(asset) {
    asset.off("remove", this.onNormalMapRemoved, this);
    this.normalMapAsset = null;
  }, onSetMesh:function(name, oldValue, newValue) {
    var self = this;
    var asset;
    var assets = this.system.app.assets;
    if (oldValue && typeof oldValue === "number") {
      asset = assets.get(oldValue);
      if (asset) {
        asset.off("remove", this.onMeshRemoved, this);
      }
    }
    if (newValue) {
      if (newValue instanceof pc.Asset) {
        this.data.mesh = newValue.id;
        newValue = newValue.id;
      }
      if (typeof newValue === "number") {
        asset = assets.get(newValue);
        if (asset) {
          asset.on("remove", this.onMeshRemoved, this);
          asset.ready(function(asset) {
            self._onMeshChanged(asset.resource);
          });
          if (self.enabled && self.entity.enabled) {
            assets.load(asset);
          }
        } else {
          assets.once("add:" + newValue, function(asset) {
            asset.on("remove", this.onMeshRemoved, this);
            asset.ready(function(asset) {
              self._onMeshChanged(asset.resource);
            });
            if (self.enabled && self.entity.enabled) {
              assets.load(asset);
            }
          });
        }
      } else {
        this._onMeshChanged(newValue);
      }
    } else {
      this._onMeshChanged(null);
    }
  }, _onMeshChanged:function(mesh) {
    if (mesh && !(mesh instanceof pc.Mesh)) {
      if (mesh.meshInstances[0]) {
        mesh = mesh.meshInstances[0].mesh;
      } else {
        mesh = null;
      }
    }
    this.data.mesh = mesh;
    if (this.emitter) {
      this.emitter.mesh = mesh;
      this.emitter.resetMaterial();
      this.rebuild();
    }
  }, onMeshRemoved:function(asset) {
    asset.off("remove", this.onMeshRemoved, this);
    this.mesh = null;
  }, onSetLoop:function(name, oldValue, newValue) {
    if (this.emitter) {
      this.emitter[name] = newValue;
      this.emitter.resetTime();
    }
  }, onSetBlendType:function(name, oldValue, newValue) {
    if (this.emitter) {
      this.emitter[name] = newValue;
      this.emitter.material.blendType = newValue;
      this.emitter.resetMaterial();
      this.rebuild();
    }
  }, onSetDepthSoftening:function(name, oldValue, newValue) {
    if (this.emitter) {
      if (oldValue !== newValue) {
        if (newValue) {
          this.emitter[name] = newValue;
          if (this.enabled) {
            this.emitter.onEnableDepth();
          }
        } else {
          if (this.enabled) {
            this.emitter.onDisableDepth();
          }
          this.emitter[name] = newValue;
        }
        this.reset();
        this.emitter.resetMaterial();
        this.rebuild();
      }
    }
  }, onSetSimpleProperty:function(name, oldValue, newValue) {
    if (this.emitter) {
      this.emitter[name] = newValue;
      this.emitter.resetMaterial();
    }
  }, onSetComplexProperty:function(name, oldValue, newValue) {
    if (this.emitter) {
      this.emitter[name] = newValue;
      this.reset();
      this.emitter.resetMaterial();
      this.rebuild();
    }
  }, onSetGraphProperty:function(name, oldValue, newValue) {
    if (this.emitter) {
      this.emitter[name] = newValue;
      this.emitter.rebuildGraphs();
      this.emitter.resetMaterial();
    }
  }, onEnable:function() {
    for (var i = 0, len = ASSET_PROPERTIES.length;i < len;i++) {
      var asset = this.data[ASSET_PROPERTIES[i]];
      if (asset) {
        if (!(asset instanceof pc.Asset)) {
          var id = parseInt(asset, 10);
          if (id >= 0) {
            asset = this.system.app.assets.get(asset);
          } else {
            continue;
          }
        }
        if (asset && !asset.resource) {
          this.system.app.assets.load(asset);
        }
      }
    }
    var firstRun = false;
    if (!this.emitter) {
      var mesh = this.data.mesh;
      if (!(mesh instanceof pc.Mesh)) {
        mesh = null;
      }
      firstRun = true;
      this.emitter = new pc.ParticleEmitter(this.system.app.graphicsDevice, {numParticles:this.data.numParticles, emitterExtents:this.data.emitterExtents, emitterRadius:this.data.emitterRadius, emitterShape:this.data.emitterShape, initialVelocity:this.data.initialVelocity, wrap:this.data.wrap, localSpace:this.data.localSpace, wrapBounds:this.data.wrapBounds, lifetime:this.data.lifetime, rate:this.data.rate, rate2:this.data.rate2, animTilesX:this.data.animTilesX, animTilesY:this.data.animTilesY, animNumFrames:this.data.animNumFrames,
      animSpeed:this.data.animSpeed, animLoop:this.data.animLoop, startAngle:this.data.startAngle, startAngle2:this.data.startAngle2, scaleGraph:this.data.scaleGraph, scaleGraph2:this.data.scaleGraph2, colorGraph:this.data.colorGraph, colorGraph2:this.data.colorGraph2, alphaGraph:this.data.alphaGraph, alphaGraph2:this.data.alphaGraph2, localVelocityGraph:this.data.localVelocityGraph, localVelocityGraph2:this.data.localVelocityGraph2, velocityGraph:this.data.velocityGraph, velocityGraph2:this.data.velocityGraph2,
      rotationSpeedGraph:this.data.rotationSpeedGraph, rotationSpeedGraph2:this.data.rotationSpeedGraph2, colorMap:this.data.colorMap, normalMap:this.data.normalMap, loop:this.data.loop, preWarm:this.data.preWarm, sort:this.data.sort, stretch:this.data.stretch, alignToMotion:this.data.alignToMotion, lighting:this.data.lighting, halfLambert:this.data.halfLambert, intensity:this.data.intensity, depthSoftening:this.data.depthSoftening, scene:this.system.app.scene, mesh:mesh, depthWrite:this.data.depthWrite,
      noFog:this.data.noFog, node:this.entity, blendType:this.data.blendType});
      this.emitter.meshInstance.node = this.entity;
      this.psys = new pc.Model;
      this.psys.graph = this.entity;
      this.psys.emitter = this.emitter;
      this.psys.meshInstances = [this.emitter.meshInstance];
      this.data.model = this.psys;
      this.emitter.psys = this.psys;
      if (!this.data.autoPlay) {
        this.pause();
        this.emitter.meshInstance.visible = false;
      }
    }
    if (this.data.model) {
      if (!this.system.app.scene.containsModel(this.data.model)) {
        if (this.emitter.colorMap) {
          this.system.app.scene.addModel(this.data.model);
          if (!firstRun) {
            this.emitter.onEnableDepth();
          }
        }
      }
    }
    ParticleSystemComponent._super.onEnable.call(this);
  }, onDisable:function() {
    ParticleSystemComponent._super.onDisable.call(this);
    if (this.data.model) {
      if (this.system.app.scene.containsModel(this.data.model)) {
        this.system.app.scene.removeModel(this.data.model);
        this.emitter.onDisableDepth();
      }
    }
  }, reset:function() {
    if (this.emitter) {
      this.emitter.reset();
    }
  }, stop:function() {
    if (this.emitter) {
      this.emitter.loop = false;
      this.emitter.resetTime();
      this.emitter.addTime(0, true);
    }
  }, pause:function() {
    this.data.paused = true;
  }, unpause:function() {
    this.data.paused = false;
  }, play:function() {
    this.data.paused = false;
    if (this.emitter) {
      this.emitter.meshInstance.visible = true;
      this.emitter.loop = this.data.loop;
      this.emitter.resetTime();
    }
  }, isPlaying:function() {
    if (this.data.paused) {
      return false;
    } else {
      if (this.emitter && this.emitter.loop) {
        return true;
      } else {
        return Date.now() <= this.emitter.endTime;
      }
    }
  }, rebuild:function() {
    var enabled = this.enabled;
    this.enabled = false;
    if (this.emitter) {
      this.emitter.rebuild();
      this.emitter.meshInstance.node = this.entity;
      this.data.model.meshInstances = [this.emitter.meshInstance];
    }
    this.enabled = enabled;
  }});
  return {ParticleSystemComponent:ParticleSystemComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled", "autoPlay", "numParticles", "lifetime", "rate", "rate2", "startAngle", "startAngle2", "loop", "preWarm", "lighting", "halfLambert", "intensity", "depthWrite", "noFog", "depthSoftening", "sort", "blendType", "stretch", "alignToMotion", "emitterShape", "emitterExtents", "emitterRadius", "initialVelocity", "wrap", "wrapBounds", "localSpace", "colorMapAsset", "normalMapAsset", "mesh", "localVelocityGraph", "localVelocityGraph2", "velocityGraph", "velocityGraph2", "rotationSpeedGraph",
  "rotationSpeedGraph2", "scaleGraph", "scaleGraph2", "colorGraph", "colorGraph2", "alphaGraph", "alphaGraph2", "colorMap", "normalMap", "animTilesX", "animTilesY", "animNumFrames", "animSpeed", "animLoop"];
  var ParticleSystemComponentSystem = function ParticleSystemComponentSystem(app) {
    this.id = "particlesystem";
    this.description = "Updates and renders particle system in the scene.";
    app.systems.add(this.id, this);
    this.ComponentType = pc.ParticleSystemComponent;
    this.DataType = pc.ParticleSystemComponentData;
    this.schema = _schema;
    this.propertyTypes = {emitterExtents:"vec3", wrapBounds:"vec3", localVelocityGraph:"curveset", localVelocityGraph2:"curveset", velocityGraph:"curveset", velocityGraph2:"curveset", colorGraph:"curveset", colorGraph2:"curveset", alphaGraph:"curve", alphaGraph2:"curve", rotationSpeedGraph:"curve", rotationSpeedGraph2:"curve", scaleGraph:"curve", scaleGraph2:"curve"};
    this.on("beforeremove", this.onRemove, this);
    pc.ComponentSystem.on("update", this.onUpdate, this);
  };
  ParticleSystemComponentSystem = pc.inherits(ParticleSystemComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ParticleSystemComponent.prototype, _schema);
  pc.extend(ParticleSystemComponentSystem.prototype, {initializeComponentData:function(component, _data, properties) {
    var data = {};
    properties = [];
    var types = this.propertyTypes;
    var type;
    for (var prop in _data) {
      if (_data.hasOwnProperty(prop)) {
        properties.push(prop);
        data[prop] = _data[prop];
      }
      if (types[prop] === "vec3") {
        if (pc.type(data[prop]) === "array") {
          data[prop] = new pc.Vec3(data[prop][0], data[prop][1], data[prop][2]);
        }
      } else {
        if (types[prop] === "curve") {
          if (!(data[prop] instanceof pc.Curve)) {
            type = data[prop].type;
            data[prop] = new pc.Curve(data[prop].keys);
            data[prop].type = type;
          }
        } else {
          if (types[prop] === "curveset") {
            if (!(data[prop] instanceof pc.CurveSet)) {
              type = data[prop].type;
              data[prop] = new pc.CurveSet(data[prop].keys);
              data[prop].type = type;
            }
          }
        }
      }
    }
    ParticleSystemComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, cloneComponent:function(entity, clone) {
    var source = entity.particlesystem.data;
    var schema = this.schema;
    var data = {};
    for (var i = 0, len = schema.length;i < len;i++) {
      var prop = schema[i];
      var sourceProp = source[prop];
      if (sourceProp instanceof pc.Vec3 || sourceProp instanceof pc.Curve || sourceProp instanceof pc.CurveSet) {
        sourceProp = sourceProp.clone();
        data[prop] = sourceProp;
      } else {
        if (sourceProp !== null && sourceProp !== undefined) {
          data[prop] = sourceProp;
        }
      }
    }
    return this.addComponent(clone, data);
  }, onUpdate:function(dt) {
    var components = this.store;
    var currentCamera;
    var numSteps, i;
    var stats = this.app.stats.particles;
    for (var id in components) {
      if (components.hasOwnProperty(id)) {
        var c = components[id];
        var entity = c.entity;
        var data = c.data;
        if (data.enabled && entity.enabled) {
          var emitter = data.model.emitter;
          if (!emitter.meshInstance.visible) {
            continue;
          }
          if (!data.paused) {
            emitter.simTime += dt;
            numSteps = 0;
            if (emitter.simTime > emitter.fixedTimeStep) {
              numSteps = Math.floor(emitter.simTime / emitter.fixedTimeStep);
              emitter.simTime -= numSteps * emitter.fixedTimeStep;
            }
            if (numSteps) {
              numSteps = Math.min(numSteps, emitter.maxSubSteps);
              for (i = 0;i < numSteps;i++) {
                emitter.addTime(emitter.fixedTimeStep);
              }
              stats._updatesPerFrame += numSteps;
              stats._frameTime += emitter._addTimeTime;
              emitter._addTimeTime = 0;
            }
            emitter.finishFrame();
          }
        }
      }
    }
  }, onRemove:function(entity, component) {
    var data = component.data;
    if (data.model) {
      this.app.scene.removeModel(data.model);
      entity.removeChild(data.model.getGraph());
      data.model = null;
    }
    if (component.emitter) {
      component.emitter.destroy();
      component.emitter = null;
    }
  }});
  return {ParticleSystemComponentSystem:ParticleSystemComponentSystem};
}());
pc.extend(pc, function() {
  var ParticleSystemComponentData = function() {
    this.numParticles = 1;
    this.rate = 1;
    this.rate2 = null;
    this.startAngle = 0;
    this.startAngle2 = null;
    this.lifetime = 50;
    this.emitterExtents = new pc.Vec3;
    this.emitterRadius = 0;
    this.emitterShape = pc.EMITTERSHAPE_BOX;
    this.initialVelocity = 0;
    this.wrapBounds = new pc.Vec3;
    this.localSpace = false;
    this.colorMap = null;
    this.colorMapAsset = null;
    this.normalMap = null;
    this.normalMapAsset = null;
    this.loop = true;
    this.preWarm = false;
    this.sort = 0;
    this.mode = pc.PARTICLEMODE_GPU;
    this.scene = null;
    this.lighting = false;
    this.halfLambert = false;
    this.intensity = 1;
    this.stretch = 0.0;
    this.alignToMotion = false;
    this.depthSoftening = 0;
    this.mesh = null;
    this.depthWrite = false;
    this.noFog = false;
    this.animTilesX = 1;
    this.animTilesY = 1;
    this.animNumFrames = 1;
    this.animSpeed = 1;
    this.animLoop = true;
    this.scaleGraph = null;
    this.scaleGraph2 = null;
    this.colorGraph = null;
    this.colorGraph2 = null;
    this.alphaGraph = null;
    this.alphaGraph2 = null;
    this.localVelocityGraph = null;
    this.localVelocityGraph2 = null;
    this.velocityGraph = null;
    this.velocityGraph2 = null;
    this.rotationSpeedGraph = null;
    this.rotationSpeedGraph2 = null;
    this.blendType = pc.BLEND_NORMAL;
    this.model = null;
    this.enabled = true;
    this.paused = false;
    this.autoPlay = true;
  };
  ParticleSystemComponentData = pc.inherits(ParticleSystemComponentData, pc.ComponentData);
  return {ParticleSystemComponentData:ParticleSystemComponentData};
}());
pc.extend(pc, function() {
  pc.SCALEMODE_NONE = "none";
  pc.SCALEMODE_BLEND = "blend";
  var ScreenComponent = function ScreenComponent(system, entity) {
    this._resolution = new pc.Vec2(640, 320);
    this._referenceResolution = new pc.Vec2(640, 320);
    this._scaleMode = pc.SCALEMODE_NONE;
    this.scale = 1;
    this._scaleBlend = 0.5;
    this._screenSpace = false;
    this._screenMatrix = new pc.Mat4;
    system.app.graphicsDevice.on("resizecanvas", this._onResize, this);
  };
  ScreenComponent = pc.inherits(ScreenComponent, pc.Component);
  var _transform = new pc.Mat4;
  pc.extend(ScreenComponent.prototype, {syncDrawOrder:function() {
    var i = 1;
    var recurse = function(e) {
      if (e.element) {
        e.element.drawOrder = i++;
      }
      var children = e.getChildren();
      for (var j = 0;j < children.length;j++) {
        recurse(children[j]);
      }
    };
    recurse(this.entity);
  }, _calcProjectionMatrix:function() {
    var left;
    var right;
    var bottom;
    var top;
    var near = 1;
    var far = -1;
    var w = this._resolution.x / this.scale;
    var h = this._resolution.y / this.scale;
    left = 0;
    right = w;
    bottom = -h;
    top = 0;
    this._screenMatrix.setOrtho(left, right, bottom, top, near, far);
    if (!this._screenSpace) {
      _transform.setScale(0.5 * w, 0.5 * h, 1);
      this._screenMatrix.mul2(_transform, this._screenMatrix);
    }
  }, _updateScale:function() {
    this.scale = this._calcScale(this._resolution, this.referenceResolution);
  }, _calcScale:function(resolution, referenceResolution) {
    var lx = Math.log2(resolution.x / referenceResolution.x);
    var ly = Math.log2(resolution.y / referenceResolution.y);
    return Math.pow(2, lx * (1 - this._scaleBlend) + ly * this._scaleBlend);
  }, _onResize:function(width, height) {
    if (this._screenSpace) {
      this._resolution.set(width, height);
      this.resolution = this._resolution;
    }
  }, onRemove:function() {
    this.system.app.graphicsDevice.off("resizecanvas", this._onResize, this);
  }});
  Object.defineProperty(ScreenComponent.prototype, "resolution", {set:function(value) {
    if (!this._screenSpace) {
      this._resolution.set(value.x, value.y);
    } else {
      this._resolution.set(this.system.app.graphicsDevice.width, this.system.app.graphicsDevice.height);
    }
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) {
      this.entity._dirtify(true);
    }
    this.fire("set:resolution", this._resolution);
  }, get:function() {
    return this._resolution;
  }});
  Object.defineProperty(ScreenComponent.prototype, "referenceResolution", {set:function(value) {
    this._referenceResolution.set(value.x, value.y);
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) {
      this.entity._dirtify(true);
    }
    this.fire("set:referenceresolution", this._resolution);
  }, get:function() {
    if (this._scaleMode === pc.SCALEMODE_NONE) {
      return this._resolution;
    } else {
      return this._referenceResolution;
    }
  }});
  Object.defineProperty(ScreenComponent.prototype, "screenSpace", {set:function(value) {
    this._screenSpace = value;
    if (this._screenSpace) {
      this._resolution.set(this.system.app.graphicsDevice.width, this.system.app.graphicsDevice.height);
    }
    this.resolution = this._resolution;
    if (!this.entity._dirtyLocal) {
      this.entity._dirtify(true);
    }
    this.fire("set:screenspace", this._screenSpace);
  }, get:function() {
    return this._screenSpace;
  }});
  Object.defineProperty(ScreenComponent.prototype, "scaleMode", {set:function(value) {
    if (value !== pc.SCALEMODE_NONE && value !== pc.SCALEMODE_BLEND) {
      value = pc.SCALEMODE_NONE;
    }
    if (!this._screenSpace && value !== pc.SCALEMODE_NONE) {
      value = pc.SCALEMODE_NONE;
    }
    this._scaleMode = value;
    this.resolution = this._resolution;
    this.fire("set:scalemode", this._scaleMode);
  }, get:function() {
    return this._scaleMode;
  }});
  Object.defineProperty(ScreenComponent.prototype, "scaleBlend", {set:function(value) {
    this._scaleBlend = value;
    this._updateScale();
    this._calcProjectionMatrix();
    if (!this.entity._dirtyLocal) {
      this.entity._dirtify(true);
    }
    this.fire("set:scaleblend", this._scaleBlend);
  }, get:function() {
    return this._scaleBlend;
  }});
  return {ScreenComponent:ScreenComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled"];
  var ScreenComponentSystem = function ScreenComponentSystem(app) {
    this.id = "screen";
    this.app = app;
    app.systems.add(this.id, this);
    this.ComponentType = pc.ScreenComponent;
    this.DataType = pc.ScreenComponentData;
    this.schema = _schema;
    this.windowResolution = new pc.Vec2;
    this.app.graphicsDevice.on("resizecanvas", this._onResize, this);
    pc.ComponentSystem.on("update", this._onUpdate, this);
    this.on("beforeremove", this.onRemoveComponent, this);
  };
  ScreenComponentSystem = pc.inherits(ScreenComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ScreenComponent.prototype, _schema);
  pc.extend(ScreenComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    if (data.screenSpace !== undefined) {
      component.screenSpace = data.screenSpace;
    }
    if (data.scaleMode !== undefined) {
      component.scaleMode = data.scaleMode;
    }
    if (data.scaleBlend !== undefined) {
      component.scaleBlend = data.scaleBlend;
    }
    if (data.resolution !== undefined) {
      if (data.resolution instanceof pc.Vec2) {
        component._resolution.copy(data.resolution);
      } else {
        component._resolution.set(data.resolution[0], data.resolution[1]);
      }
      component.resolution = component._resolution;
    }
    if (data.referenceResolution !== undefined) {
      if (data.referenceResolution instanceof pc.Vec2) {
        component._referenceResolution.copy(data.referenceResolution);
      } else {
        component._referenceResolution.set(data.referenceResolution[0], data.referenceResolution[1]);
      }
      component.referenceResolution = component._referenceResolution;
    }
    ScreenComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, _onUpdate:function(dt) {
    var components = this.store;
    for (var id in components) {
      if (components[id].entity.screen.update) {
        components[id].entity.screen.update(dt);
      }
    }
  }, _onResize:function(width, height) {
    this.windowResolution.x = width;
    this.windowResolution.y = height;
  }, cloneComponent:function(entity, clone) {
    var screen = entity.screen;
    return this.addComponent(clone, {enabled:screen.enabled, screenSpace:screen.screenSpace, scaleMode:screen.scaleMode, resolution:screen.resolution.clone(), referenceResolution:screen.referenceResolution.clone()});
  }, onRemoveComponent:function(entity, component) {
    component.onRemove();
  }});
  return {ScreenComponentSystem:ScreenComponentSystem};
}());
pc.extend(pc, function() {
  var ScreenComponentData = function() {
    this.enabled = true;
  };
  ScreenComponentData = pc.inherits(ScreenComponentData, pc.ComponentData);
  return {ScreenComponentData:ScreenComponentData};
}());
pc.extend(pc, function() {
  pc.ELEMENTTYPE_GROUP = "group";
  pc.ELEMENTTYPE_IMAGE = "image";
  pc.ELEMENTTYPE_TEXT = "text";
  var vecA = new pc.Vec3;
  var vecB = new pc.Vec3;
  var matA = new pc.Mat4;
  var matB = new pc.Mat4;
  var matC = new pc.Mat4;
  var matD = new pc.Mat4;
  var ElementComponent = function ElementComponent(system, entity) {
    this._anchor = new pc.Vec4;
    this._localAnchor = new pc.Vec4;
    this._pivot = new pc.Vec2;
    this._width = 32;
    this._height = 32;
    this._margin = new pc.Vec4(0, 0, -32, -32);
    this._modelTransform = new pc.Mat4;
    this._screenToWorld = new pc.Mat4;
    this._anchorTransform = new pc.Mat4;
    this._anchorDirty = true;
    this._parentWorldTransform = new pc.Mat4;
    this._screenTransform = new pc.Mat4;
    this._screenCorners = [new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3];
    this._canvasCorners = [new pc.Vec2, new pc.Vec2, new pc.Vec2, new pc.Vec2];
    this._worldCorners = [new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3];
    this._cornersDirty = true;
    this._canvasCornersDirty = true;
    this._worldCornersDirty = true;
    this.entity.on("insert", this._onInsert, this);
    this._patch();
    this.screen = null;
    this._type = pc.ELEMENTTYPE_GROUP;
    this._image = null;
    this._text = null;
    this._group = null;
    this._useInput = false;
    this._batchGroupId = -1;
  };
  ElementComponent = pc.inherits(ElementComponent, pc.Component);
  pc.extend(ElementComponent.prototype, {_patch:function() {
    this.entity._sync = this._sync;
    this.entity.setPosition = this._setPosition;
    this.entity.setLocalPosition = this._setLocalPosition;
  }, _unpatch:function() {
    this.entity._sync = pc.Entity.prototype._sync;
    this.entity.setPosition = pc.Entity.prototype.setPosition;
    this.entity.setLocalPosition = pc.Entity.prototype.setLocalPosition;
  }, _setPosition:function() {
    var position = new pc.Vec3;
    var invParentWtm = new pc.Mat4;
    return function(x, y, z) {
      if (!this.element.screen) {
        return pc.Entity.prototype.setPosition.call(this, x, y, z);
      }
      if (x instanceof pc.Vec3) {
        position.copy(x);
      } else {
        position.set(x, y, z);
      }
      this.getWorldTransform();
      invParentWtm.copy(this.element._screenToWorld).invert();
      invParentWtm.transformPoint(position, this.localPosition);
      if (!this._dirtyLocal) {
        this._dirtify(true);
      }
    };
  }(), _setLocalPosition:function(x, y, z) {
    if (x instanceof pc.Vec3) {
      this.localPosition.copy(x);
    } else {
      this.localPosition.set(x, y, z);
    }
    var element = this.element;
    var p = this.localPosition.data;
    var pvt = element._pivot.data;
    element._margin.data[0] = p[0] - element._width * pvt[0];
    element._margin.data[2] = element._localAnchor.data[2] - element._localAnchor.data[0] - element._width - element._margin.data[0];
    element._margin.data[1] = p[1] - element._height * pvt[1];
    element._margin.data[3] = element._localAnchor.data[3] - element._localAnchor.data[1] - element._height - element._margin.data[1];
    if (!this._dirtyLocal) {
      this._dirtify(true);
    }
  }, _sync:function() {
    var element = this.element;
    var screen = element.screen;
    if (screen) {
      if (element._anchorDirty) {
        var resx = 0;
        var resy = 0;
        var px = 0;
        var py = 1;
        if (this._parent && this._parent.element) {
          resx = this._parent.element.width;
          resy = this._parent.element.height;
          px = this._parent.element.pivot.x;
          py = this._parent.element.pivot.y;
        } else {
          if (screen) {
            var resolution = screen.screen.resolution;
            resx = resolution.x / screen.screen.scale;
            resy = resolution.y / screen.screen.scale;
          }
        }
        element._anchorTransform.setTranslate(resx * (element.anchor.x - px), -(resy * (py - element.anchor.y)), 0);
        element._anchorDirty = false;
        element._calculateLocalAnchors();
      }
      if (element._sizeDirty) {
        element._calculateSize();
      }
    }
    if (this._dirtyLocal) {
      this.localTransform.setTRS(this.localPosition, this.localRotation, this.localScale);
      var p = this.localPosition.data;
      var pvt = element._pivot.data;
      element._margin.data[0] = p[0] - element._width * pvt[0];
      element._margin.data[2] = element._localAnchor.data[2] - element._localAnchor.data[0] - element._width - element._margin.data[0];
      element._margin.data[1] = p[1] - element._height * pvt[1];
      element._margin.data[3] = element._localAnchor.data[3] - element._localAnchor.data[1] - element._height - element._margin.data[1];
      this._dirtyLocal = false;
    }
    if (!screen) {
      if (this._dirtyWorld) {
        element._cornersDirty = true;
        element._canvasCornersDirty = true;
        element._worldCornersDirty = true;
      }
      return pc.Entity.prototype._sync.call(this);
    }
    if (this._dirtyWorld) {
      if (this._parent === null) {
        this.worldTransform.copy(this.localTransform);
      } else {
        if (this._parent.element) {
          element._screenToWorld.mul2(this._parent.element._modelTransform, element._anchorTransform);
        } else {
          element._screenToWorld.copy(element._anchorTransform);
        }
        element._modelTransform.mul2(element._screenToWorld, this.localTransform);
        if (screen) {
          element._screenToWorld.mul2(screen.screen._screenMatrix, element._screenToWorld);
          if (!screen.screen.screenSpace) {
            element._screenToWorld.mul2(screen.worldTransform, element._screenToWorld);
          }
          this.worldTransform.mul2(element._screenToWorld, this.localTransform);
          var parentWorldTransform = element._parentWorldTransform;
          parentWorldTransform.setIdentity();
          var parent = this._parent;
          if (parent && parent.element && parent !== screen) {
            matA.setTRS(pc.Vec3.ZERO, parent.getLocalRotation(), parent.getLocalScale());
            parentWorldTransform.mul2(parent.element._parentWorldTransform, matA);
          }
          var depthOffset = vecA;
          depthOffset.set(0, 0, this.localPosition.z);
          var pivotOffset = vecB;
          pivotOffset.set(element._absLeft + element._pivot.x * element.width, element._absBottom + element._pivot.y * element.height, 0);
          matA.setTranslate(-pivotOffset.x, -pivotOffset.y, -pivotOffset.z);
          matB.setTRS(depthOffset, this.getLocalRotation(), this.getLocalScale());
          matC.setTranslate(pivotOffset.x, pivotOffset.y, pivotOffset.z);
          element._screenTransform.mul2(element._parentWorldTransform, matC).mul(matB).mul(matA);
          element._cornersDirty = true;
          element._canvasCornersDirty = true;
          element._worldCornersDirty = true;
        } else {
          this.worldTransform.copy(element._modelTransform);
        }
      }
      this._dirtyWorld = false;
    }
  }, _onInsert:function(parent) {
    var screen = this._findScreen();
    this.entity._dirtify();
    this._updateScreen(screen);
  }, _updateScreen:function(screen) {
    if (this.screen && this.screen !== screen) {
      this.screen.screen.off("set:resolution", this._onScreenResize, this);
      this.screen.screen.off("set:referenceresolution", this._onScreenResize, this);
      this.screen.screen.off("set:scaleblend", this._onScreenResize, this);
      this.screen.screen.off("set:screenspace", this._onScreenSpaceChange, this);
    }
    this.screen = screen;
    if (this.screen) {
      this.screen.screen.on("set:resolution", this._onScreenResize, this);
      this.screen.screen.on("set:referenceresolution", this._onScreenResize, this);
      this.screen.screen.on("set:scaleblend", this._onScreenResize, this);
      this.screen.screen.on("set:screenspace", this._onScreenSpaceChange, this);
    }
    this._calculateSize();
    this.fire("set:screen", this.screen);
    this._anchorDirty = true;
    var children = this.entity.getChildren();
    for (var i = 0, l = children.length;i < l;i++) {
      if (children[i].element) {
        children[i].element._updateScreen(screen);
      }
    }
    if (this.screen) {
      this.screen.screen.syncDrawOrder();
    }
  }, _findScreen:function() {
    var screen = this.entity._parent;
    while (screen && !screen.screen) {
      screen = screen._parent;
    }
    return screen;
  }, _onScreenResize:function(res) {
    this._anchorDirty = true;
    this._cornersDirty = true;
    this._worldCornersDirty = true;
    this._calculateSize();
    this.fire("screen:set:resolution", res);
  }, _onScreenSpaceChange:function() {
    this.fire("screen:set:screenspace", this.screen.screen.screenSpace);
  }, _calculateLocalAnchors:function() {
    var resx = 1000;
    var resy = 1000;
    var parent = this.entity._parent;
    if (parent && parent.element) {
      resx = parent.element.width;
      resy = parent.element.height;
    } else {
      if (this.screen) {
        var res = this.screen.screen.resolution;
        var scale = this.screen.screen.scale;
        resx = res.x / scale;
        resy = res.y / scale;
      }
    }
    this._localAnchor.set(this._anchor.x * resx, this._anchor.y * resy, this._anchor.z * resx, this._anchor.w * resy);
  }, getOffsetPosition:function(x, y) {
    var p = this.entity.getLocalPosition().clone();
    p.x += x;
    p.y += y;
    this._screenToWorld.transformPoint(p, p);
    return p;
  }, onEnable:function() {
    ElementComponent._super.onEnable.call(this);
    if (this._image) {
      this._image.onEnable();
    }
    if (this._text) {
      this._text.onEnable();
    }
    if (this._group) {
      this._group.onEnable();
    }
    if (this.useInput && this.system.app.elementInput) {
      this.system.app.elementInput.addElement(this);
    }
  }, onDisable:function() {
    ElementComponent._super.onDisable.call(this);
    if (this._image) {
      this._image.onDisable();
    }
    if (this._text) {
      this._text.onDisable();
    }
    if (this._group) {
      this._group.onDisable();
    }
    if (this.system.app.elementInput && this.useInput) {
      this.system.app.elementInput.removeElement(this);
    }
  }, onRemove:function() {
    this.entity.off("insert", this._onInsert, this);
    this._unpatch();
    if (this._image) {
      this._image.destroy();
    }
    if (this._text) {
      this._text.destroy();
    }
    if (this.system.app.elementInput && this.useInput) {
      this.system.app.elementInput.removeElement(this);
    }
  }, _calculateSize:function() {
    if (!this.entity._parent && !this.screen) {
      return;
    }
    this._calculateLocalAnchors();
    var p = this.entity.getLocalPosition();
    this._setWidth(this._absRight - this._absLeft);
    this._setHeight(this._absTop - this._absBottom);
    p.x = this._margin.data[0] + this._width * this._pivot.data[0];
    p.y = this._margin.data[1] + this._height * this._pivot.data[1];
    this.entity.setLocalPosition(p);
    this._sizeDirty = false;
  }, _setWidth:function(w) {
    this._width = w;
    var i, l;
    var c = this.entity._children;
    for (i = 0, l = c.length;i < l;i++) {
      if (c[i].element) {
        c[i].element._anchorDirty = true;
        c[i].element._sizeDirty = true;
      }
    }
    this.fire("set:width", this._width);
    this.fire("resize", this._width, this._height);
  }, _setHeight:function(h) {
    this._height = h;
    var i, l;
    var c = this.entity._children;
    for (i = 0, l = c.length;i < l;i++) {
      if (c[i].element) {
        c[i].element._anchorDirty = true;
        c[i].element._sizeDirty = true;
      }
    }
    this.fire("set:height", this._height);
    this.fire("resize", this._width, this._height);
  }});
  Object.defineProperty(ElementComponent.prototype, "type", {get:function() {
    return this._type;
  }, set:function(value) {
    if (value !== this._type) {
      this._type = value;
      if (this._image) {
        this._image.destroy();
        this._image = null;
      }
      if (this._text) {
        this._text.destroy();
        this._text = null;
      }
      if (value === pc.ELEMENTTYPE_IMAGE) {
        this._image = new pc.ImageElement(this);
      } else {
        if (value === pc.ELEMENTTYPE_TEXT) {
          this._text = new pc.TextElement(this);
        }
      }
    }
  }});
  Object.defineProperty(ElementComponent.prototype, "drawOrder", {get:function() {
    return this._drawOrder;
  }, set:function(value) {
    this._drawOrder = value;
    this.fire("set:draworder", this._drawOrder);
  }});
  Object.defineProperty(ElementComponent.prototype, "_absLeft", {get:function() {
    return this._localAnchor.data[0] + this._margin.data[0];
  }});
  Object.defineProperty(ElementComponent.prototype, "_absRight", {get:function() {
    return this._localAnchor.data[2] - this._margin.data[2];
  }});
  Object.defineProperty(ElementComponent.prototype, "_absTop", {get:function() {
    return this._localAnchor.data[3] - this._margin.data[3];
  }});
  Object.defineProperty(ElementComponent.prototype, "_absBottom", {get:function() {
    return this._localAnchor.data[1] + this._margin.data[1];
  }});
  Object.defineProperty(ElementComponent.prototype, "margin", {get:function() {
    return this._margin;
  }, set:function(value) {
    this._margin.copy(value);
    this._calculateSize();
  }});
  Object.defineProperty(ElementComponent.prototype, "left", {get:function() {
    return this._margin.data[0];
  }, set:function(value) {
    this._margin.data[0] = value;
    var p = this.entity.getLocalPosition();
    var wr = this._absRight;
    var wl = this._localAnchor.data[0] + value;
    this._setWidth(wr - wl);
    p.x = value + this._width * this._pivot.data[0];
    this.entity.setLocalPosition(p);
  }});
  Object.defineProperty(ElementComponent.prototype, "right", {get:function() {
    return this._margin.data[2];
  }, set:function(value) {
    this._margin.data[2] = value;
    var p = this.entity.getLocalPosition();
    var wl = this._absLeft;
    var wr = this._localAnchor.data[2] - value;
    this._setWidth(wr - wl);
    p.x = this._localAnchor.data[2] - this._localAnchor.data[0] - value - this._width * (1 - this._pivot.data[0]);
    this.entity.setLocalPosition(p);
  }});
  Object.defineProperty(ElementComponent.prototype, "top", {get:function() {
    return this._margin.data[3];
  }, set:function(value) {
    this._margin.data[3] = value;
    var p = this.entity.getLocalPosition();
    var wb = this._absBottom;
    var wt = this._localAnchor.data[3] - value;
    this._setHeight(wt - wb);
    p.y = this._localAnchor.data[3] - this._localAnchor.data[1] - value - this._height * (1 - this._pivot.data[1]);
    this.entity.setLocalPosition(p);
  }});
  Object.defineProperty(ElementComponent.prototype, "bottom", {get:function() {
    return this._margin.data[1];
  }, set:function(value) {
    this._margin.data[1] = value;
    var p = this.entity.getLocalPosition();
    var wt = this._absTop;
    var wb = this._localAnchor.data[1] + value;
    this._setHeight(wt - wb);
    p.y = value + this._height * this._pivot.data[1];
    this.entity.setLocalPosition(p);
  }});
  Object.defineProperty(ElementComponent.prototype, "width", {get:function() {
    return this._width;
  }, set:function(value) {
    this._width = value;
    var p = this.entity.getLocalPosition().data;
    var pvt = this._pivot.data;
    this._margin.data[0] = p[0] - this._width * pvt[0];
    this._margin.data[2] = this._localAnchor.data[2] - this._localAnchor.data[0] - this._width - this._margin.data[0];
    var i, l;
    var c = this.entity._children;
    for (i = 0, l = c.length;i < l;i++) {
      if (c[i].element) {
        c[i].element._anchorDirty = true;
        c[i].element._sizeDirty = true;
      }
    }
    this.fire("set:width", this._width);
    this.fire("resize", this._width, this._height);
  }});
  Object.defineProperty(ElementComponent.prototype, "height", {get:function() {
    return this._height;
  }, set:function(value) {
    this._height = value;
    var p = this.entity.getLocalPosition().data;
    var pvt = this._pivot.data;
    this._margin.data[1] = p[1] - this._height * pvt[1];
    this._margin.data[3] = this._localAnchor.data[3] - this._localAnchor.data[1] - this._height - this._margin.data[1];
    var i, l;
    var c = this.entity._children;
    for (i = 0, l = c.length;i < l;i++) {
      if (c[i].element) {
        c[i].element._anchorDirty = true;
        c[i].element._sizeDirty = true;
      }
    }
    this.fire("set:height", this._height);
    this.fire("resize", this._width, this._height);
  }});
  Object.defineProperty(ElementComponent.prototype, "pivot", {get:function() {
    return this._pivot;
  }, set:function(value) {
    var prevX = this._pivot.x;
    var prevY = this._pivot.y;
    if (value instanceof pc.Vec2) {
      this._pivot.set(value.x, value.y);
    } else {
      this._pivot.set(value[0], value[1]);
    }
    var mx = this._margin.data[0] + this._margin.data[2];
    var dx = this._pivot.x - prevX;
    this._margin.data[0] += mx * dx;
    this._margin.data[2] -= mx * dx;
    var my = this._margin.data[1] + this._margin.data[3];
    var dy = this._pivot.y - prevY;
    this._margin.data[1] += my * dy;
    this._margin.data[3] -= my * dy;
    this._onScreenResize();
    this.fire("set:pivot", this._pivot);
  }});
  Object.defineProperty(ElementComponent.prototype, "anchor", {get:function() {
    return this._anchor;
  }, set:function(value) {
    if (value instanceof pc.Vec4) {
      this._anchor.set(value.x, value.y, value.z, value.w);
    } else {
      this._anchor.set(value[0], value[1], value[2], value[3]);
    }
    if (!this.entity._parent && !this.screen) {
      this._calculateLocalAnchors();
    } else {
      this._calculateSize();
    }
    this._anchorDirty = true;
    if (!this.entity._dirtyLocal) {
      this.entity._dirtify(true);
    }
    this.fire("set:anchor", this._anchor);
  }});
  Object.defineProperty(ElementComponent.prototype, "screenCorners", {get:function() {
    if (!this._cornersDirty || !this.screen) {
      return this._screenCorners;
    }
    var parentBottomLeft = this.entity.parent && this.entity.parent.element && this.entity.parent.element.screenCorners[0];
    this._screenCorners[0].set(this._absLeft, this._absBottom, 0);
    this._screenCorners[1].set(this._absRight, this._absBottom, 0);
    this._screenCorners[2].set(this._absRight, this._absTop, 0);
    this._screenCorners[3].set(this._absLeft, this._absTop, 0);
    var screenSpace = this.screen.screen.screenSpace;
    for (var i = 0;i < 4;i++) {
      this._screenTransform.transformPoint(this._screenCorners[i], this._screenCorners[i]);
      if (screenSpace) {
        this._screenCorners[i].scale(this.screen.screen.scale);
      }
      if (parentBottomLeft) {
        this._screenCorners[i].add(parentBottomLeft);
      }
    }
    this._cornersDirty = false;
    this._canvasCornersDirty = true;
    this._worldCornersDirty = true;
    return this._screenCorners;
  }});
  Object.defineProperty(ElementComponent.prototype, "canvasCorners", {get:function() {
    if (!this._canvasCornersDirty || !this.screen || !this.screen.screen.screenSpace) {
      return this._canvasCorners;
    }
    var device = this.system.app.graphicsDevice;
    var screenCorners = this.screenCorners;
    var sx = device.canvas.clientWidth / device.width;
    var sy = device.canvas.clientHeight / device.height;
    for (var i = 0;i < 4;i++) {
      this._canvasCorners[i].set(screenCorners[i].x * sx, (device.height - screenCorners[i].y) * sy);
    }
    this._canvasCornersDirty = false;
    return this._canvasCorners;
  }});
  Object.defineProperty(ElementComponent.prototype, "worldCorners", {get:function() {
    if (!this._worldCornersDirty) {
      return this._worldCorners;
    }
    if (this.screen) {
      var screenCorners = this.screenCorners;
      if (!this.screen.screen.screenSpace) {
        matA.copy(this.screen.screen._screenMatrix);
        matA.data[13] = -matA.data[13];
        matA.mul2(this.screen.getWorldTransform(), matA);
        for (var i = 0;i < 4;i++) {
          matA.transformPoint(screenCorners[i], this._worldCorners[i]);
        }
      }
    } else {
      var localPos = this.entity.getLocalPosition();
      matA.setTranslate(-localPos.x, -localPos.y, -localPos.z);
      matB.setTRS(pc.Vec3.ZERO, this.entity.getLocalRotation(), this.entity.getLocalScale());
      matC.setTranslate(localPos.x, localPos.y, localPos.z);
      matD.copy(this.entity.parent.getWorldTransform());
      matD.mul(matC).mul(matB).mul(matA);
      vecA.set(localPos.x - this.pivot.x * this.width, localPos.y - this.pivot.y * this.height, localPos.z);
      matD.transformPoint(vecA, this._worldCorners[0]);
      vecA.set(localPos.x + (1 - this.pivot.x) * this.width, localPos.y - this.pivot.y * this.height, localPos.z);
      matD.transformPoint(vecA, this._worldCorners[1]);
      vecA.set(localPos.x + (1 - this.pivot.x) * this.width, localPos.y + (1 - this.pivot.y) * this.height, localPos.z);
      matD.transformPoint(vecA, this._worldCorners[2]);
      vecA.set(localPos.x - this.pivot.x * this.width, localPos.y + (1 - this.pivot.y) * this.height, localPos.z);
      matD.transformPoint(vecA, this._worldCorners[3]);
    }
    this._worldCornersDirty = false;
    return this._worldCorners;
  }});
  Object.defineProperty(ElementComponent.prototype, "textWidth", {get:function() {
    return this._text ? this._text.width : 0;
  }});
  Object.defineProperty(ElementComponent.prototype, "textHeight", {get:function() {
    return this._text ? this._text.height : 0;
  }});
  Object.defineProperty(ElementComponent.prototype, "useInput", {get:function() {
    return this._useInput;
  }, set:function(value) {
    if (this._useInput === value) {
      return;
    }
    this._useInput = value;
    if (this.system.app.elementInput) {
      if (value) {
        if (this.enabled && this.entity.enabled) {
          this.system.app.elementInput.addElement(this);
        }
      } else {
        this.system.app.elementInput.removeElement(this);
      }
    }
    this.fire("set:useInput", value);
  }});
  Object.defineProperty(ElementComponent.prototype, "batchGroupId", {get:function() {
    return this._batchGroupId;
  }, set:function(value) {
    if (this._batchGroupId === value) {
      return;
    }
    if (this._batchGroupId >= 0) {
      this.system.app.batcher._markGroupDirty(this._batchGroupId);
    }
    if (value >= 0) {
      this.system.app.batcher._markGroupDirty(value);
    }
    if (value < 0 && this._batchGroupId >= 0 && this.enabled && this.entity.enabled) {
      if (this._image._model) {
        this.system.app.scene.addModel(this._image._model);
      } else {
        if (this._text._model) {
          this.system.app.scene.addModel(this._text._model);
        }
      }
    }
    this._batchGroupId = value;
  }});
  var _define = function(name) {
    Object.defineProperty(ElementComponent.prototype, name, {get:function() {
      if (this._text) {
        return this._text[name];
      } else {
        if (this._image) {
          return this._image[name];
        } else {
          return null;
        }
      }
    }, set:function(value) {
      if (this._text) {
        this._text[name] = value;
      } else {
        if (this._image) {
          this._image[name] = value;
        }
      }
    }});
  };
  _define("fontSize");
  _define("color");
  _define("font");
  _define("fontAsset");
  _define("spacing");
  _define("lineHeight");
  _define("alignment");
  _define("autoWidth");
  _define("autoHeight");
  _define("text");
  _define("texture");
  _define("textureAsset");
  _define("material");
  _define("materialAsset");
  _define("opacity");
  _define("rect");
  return {ElementComponent:ElementComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled"];
  var ElementComponentSystem = function ElementComponentSystem(app) {
    this.id = "element";
    this.app = app;
    app.systems.add(this.id, this);
    this.ComponentType = pc.ElementComponent;
    this.DataType = pc.ElementComponentData;
    this.schema = _schema;
    this._defaultTexture = new pc.Texture(app.graphicsDevice, {width:1, height:1, format:pc.PIXELFORMAT_R8_G8_B8_A8});
    var pixels = this._defaultTexture.lock();
    var pixelData = new Uint8Array(4);
    pixelData[0] = 255.0;
    pixelData[1] = 255.0;
    pixelData[2] = 255.0;
    pixelData[3] = 255.0;
    pixels.set(pixelData);
    this._defaultTexture.unlock();
    this.defaultImageMaterial = new pc.StandardMaterial;
    this.defaultImageMaterial.diffuse = new pc.Color(0, 0, 0, 1);
    this.defaultImageMaterial.emissive = new pc.Color(0.5, 0.5, 0.5, 1);
    this.defaultImageMaterial.emissiveMap = this._defaultTexture;
    this.defaultImageMaterial.emissiveMapTint = true;
    this.defaultImageMaterial.opacityMap = this._defaultTexture;
    this.defaultImageMaterial.opacityMapChannel = "a";
    this.defaultImageMaterial.opacityTint = true;
    this.defaultImageMaterial.opacity = 0;
    this.defaultImageMaterial.useLighting = false;
    this.defaultImageMaterial.useGammaTonemap = false;
    this.defaultImageMaterial.useFog = false;
    this.defaultImageMaterial.useSkybox = false;
    this.defaultImageMaterial.blendType = pc.BLEND_PREMULTIPLIED;
    this.defaultImageMaterial.depthWrite = false;
    this.defaultImageMaterial.update();
    this.defaultScreenSpaceImageMaterial = new pc.StandardMaterial;
    this.defaultScreenSpaceImageMaterial.diffuse = new pc.Color(0, 0, 0, 1);
    this.defaultScreenSpaceImageMaterial.emissive = new pc.Color(0.5, 0.5, 0.5, 1);
    this.defaultScreenSpaceImageMaterial.emissiveMap = this._defaultTexture;
    this.defaultScreenSpaceImageMaterial.emissiveMapTint = true;
    this.defaultScreenSpaceImageMaterial.opacityMap = this._defaultTexture;
    this.defaultScreenSpaceImageMaterial.opacityMapChannel = "a";
    this.defaultScreenSpaceImageMaterial.opacityTint = true;
    this.defaultScreenSpaceImageMaterial.opacity = 0;
    this.defaultScreenSpaceImageMaterial.useLighting = false;
    this.defaultScreenSpaceImageMaterial.useGammaTonemap = false;
    this.defaultScreenSpaceImageMaterial.useFog = false;
    this.defaultScreenSpaceImageMaterial.useSkybox = false;
    this.defaultScreenSpaceImageMaterial.blendType = pc.BLEND_PREMULTIPLIED;
    this.defaultScreenSpaceImageMaterial.depthTest = false;
    this.defaultScreenSpaceImageMaterial.depthWrite = false;
    this.defaultScreenSpaceImageMaterial.update();
    this.defaultTextMaterial = new pc.StandardMaterial;
    this.defaultTextMaterial.msdfMap = this._defaultTexture;
    this.defaultTextMaterial.useLighting = false;
    this.defaultTextMaterial.useGammaTonemap = false;
    this.defaultTextMaterial.useFog = false;
    this.defaultTextMaterial.useSkybox = false;
    this.defaultTextMaterial.diffuse = new pc.Color(0, 0, 0, 1);
    this.defaultTextMaterial.emissive = new pc.Color(1, 1, 1, 1);
    this.defaultTextMaterial.opacity = 0.5;
    this.defaultTextMaterial.blendType = pc.BLEND_PREMULTIPLIED;
    this.defaultTextMaterial.depthWrite = false;
    this.defaultTextMaterial.update();
    this.defaultScreenSpaceTextMaterial = new pc.StandardMaterial;
    this.defaultScreenSpaceTextMaterial.msdfMap = this._defaultTexture;
    this.defaultScreenSpaceTextMaterial.useLighting = false;
    this.defaultScreenSpaceTextMaterial.useGammaTonemap = false;
    this.defaultScreenSpaceTextMaterial.useFog = false;
    this.defaultScreenSpaceTextMaterial.useSkybox = false;
    this.defaultScreenSpaceTextMaterial.diffuse = new pc.Color(0, 0, 0, 1);
    this.defaultScreenSpaceTextMaterial.emissive = new pc.Color(1, 1, 1, 1);
    this.defaultScreenSpaceTextMaterial.opacity = 0.5;
    this.defaultScreenSpaceTextMaterial.blendType = pc.BLEND_PREMULTIPLIED;
    this.defaultScreenSpaceTextMaterial.depthWrite = false;
    this.defaultScreenSpaceTextMaterial.depthTest = false;
    this.defaultScreenSpaceTextMaterial.update();
    this.on("beforeremove", this.onRemoveComponent, this);
  };
  ElementComponentSystem = pc.inherits(ElementComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ElementComponent.prototype, _schema);
  pc.extend(ElementComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    if (data.anchor !== undefined) {
      if (data.anchor instanceof pc.Vec4) {
        component.anchor.copy(data.anchor);
      } else {
        component.anchor.set(data.anchor[0], data.anchor[1], data.anchor[2], data.anchor[3]);
      }
    }
    if (data.pivot !== undefined) {
      if (data.pivot instanceof pc.Vec2) {
        component.pivot.copy(data.pivot);
      } else {
        component.pivot.set(data.pivot[0], data.pivot[1]);
      }
    }
    var splitHorAnchors = Math.abs(component.anchor.x - component.anchor.z) > 0.001;
    var splitVerAnchors = Math.abs(component.anchor.y - component.anchor.w) > 0.001;
    var _marginChange = false;
    if (data.margin !== undefined) {
      if (data.margin instanceof pc.Vec4) {
        component.margin.copy(data.margin);
      } else {
        component._margin.set(data.margin[0], data.margin[1], data.margin[2], data.margin[3]);
      }
      _marginChange = true;
    }
    if (data.left !== undefined) {
      component._margin.x = data.left;
      _marginChange = true;
    }
    if (data.bottom !== undefined) {
      component._margin.y = data.bottom;
      _marginChange = true;
    }
    if (data.right !== undefined) {
      component._margin.z = data.right;
      _marginChange = true;
    }
    if (data.top !== undefined) {
      component._margin.w = data.top;
      _marginChange = true;
    }
    if (_marginChange) {
      component.margin = component._margin;
    }
    if (data.width !== undefined && !splitHorAnchors) {
      component.width = data.width;
    }
    if (data.height !== undefined && !splitVerAnchors) {
      component.height = data.height;
    }
    if (data.enabled !== undefined) {
      component.enabled = data.enabled;
    }
    if (data.useInput !== undefined) {
      component.useInput = data.useInput;
    }
    component.batchGroupId = data.batchGroupId === undefined || data.batchGroupId === null ? -1 : data.batchGroupId;
    component.type = data.type;
    if (component.type === pc.ELEMENTTYPE_IMAGE) {
      if (data.rect !== undefined) {
        if (data.rect instanceof pc.Vec4) {
          component.rect.copy(data.rect);
        } else {
          component.rect.set(data.rect[0], data.rect[1], data.rect[2], data.rect[3]);
        }
      }
      if (data.color !== undefined) {
        if (data.color instanceof pc.Color) {
          component.color.set(data.color.data[0], data.color.data[1], data.color.data[2], data.opacity !== undefined ? data.opacity : 1);
        } else {
          component.color.set(data.color[0], data.color[1], data.color[2], data.opacity !== undefined ? data.opacity : 1);
        }
        component.color = component.color;
      }
      if (data.opacity !== undefined) {
        component.opacity = data.opacity;
      }
      if (data.textureAsset !== undefined) {
        component.textureAsset = data.textureAsset;
      }
      if (data.texture) {
        component.texture = data.texture;
      }
      if (data.materialAsset !== undefined) {
        component.materialAsset = data.materialAsset;
      }
      if (data.material) {
        component.material = data.material;
      }
    } else {
      if (component.type === pc.ELEMENTTYPE_TEXT) {
        if (data.autoWidth !== undefined) {
          component.autoWidth = data.autoWidth;
        }
        if (data.autoHeight !== undefined) {
          component.autoHeight = data.autoHeight;
        }
        if (data.text !== undefined) {
          component.text = data.text;
        }
        if (data.color !== undefined) {
          if (data.color instanceof pc.Color) {
            component.color.set(data.color.data[0], data.color.data[1], data.color.data[2], data.opacity !== undefined ? data.opacity : 1);
          } else {
            component.color.set(data.color[0], data.color[1], data.color[2], data.opacity !== undefined ? data.opacity : 1);
          }
          component.color = component.color;
        }
        if (data.opacity !== undefined) {
          component.opacity = data.opacity;
        }
        if (data.spacing !== undefined) {
          component.spacing = data.spacing;
        }
        if (data.fontSize !== undefined) {
          component.fontSize = data.fontSize;
          if (!data.lineHeight) {
            component.lineHeight = data.fontSize;
          }
        }
        if (data.lineHeight !== undefined) {
          component.lineHeight = data.lineHeight;
        }
        if (data.fontAsset !== undefined) {
          component.fontAsset = data.fontAsset;
        }
        if (data.font !== undefined) {
          component.font = data.font;
        }
        if (data.alignment !== undefined) {
          component.alignment = data.alignment;
        }
      } else {
      }
    }
    var screen = component._findScreen();
    if (screen) {
      component._updateScreen(screen);
    }
    ElementComponentSystem._super.initializeComponentData.call(this, component, data, properties);
  }, onRemoveComponent:function(entity, component) {
    component.onRemove();
  }, cloneComponent:function(entity, clone) {
    var source = entity.element;
    return this.addComponent(clone, {enabled:source.enabled, width:source.width, height:source.height, anchor:source.anchor.clone(), pivot:source.pivot.clone(), margin:source.margin.clone(), alignment:source.alignment && source.alignment.clone() || source.alignment, autoWidth:source.autoWidth, autoHeight:source.autoHeight, type:source.type, rect:source.rect && source.rect.clone() || source.rect, materialAsset:source.materialAsset, material:source.material, color:source.color && source.color.clone() ||
    source.color, opacity:source.opacity, textureAsset:source.textureAsset, texture:source.texture, text:source.text, spacing:source.spacing, lineHeight:source.lineHeight, fontSize:source.fontSize, fontAsset:source.fontAsset, font:source.font, useInput:source.useInput, batchGroupId:source.batchGroupId});
  }});
  return {ElementComponentSystem:ElementComponentSystem};
}());
pc.extend(pc, function() {
  var ElementComponentData = function() {
    this.enabled = true;
  };
  ElementComponentData = pc.inherits(ElementComponentData, pc.ComponentData);
  return {ElementComponentData:ElementComponentData};
}());
pc.extend(pc, function() {
  var ImageElement = function ImageElement(element) {
    this._element = element;
    this._entity = element.entity;
    this._system = element.system;
    this._textureAsset = null;
    this._texture = null;
    this._materialAsset = null;
    this._material = null;
    this._rect = new pc.Vec4(0, 0, 1, 1);
    this._color = new pc.Color(1, 1, 1, 1);
    this._positions = [];
    this._normals = [];
    this._uvs = [];
    this._indices = [];
    this._mesh = this._createMesh();
    this._node = new pc.GraphNode;
    this._model = new pc.Model;
    this._model.graph = this._node;
    this._meshInstance = new pc.MeshInstance(this._node, this._mesh, this._material);
    this._meshInstance.castShadow = false;
    this._meshInstance.receiveShadow = false;
    this._model.meshInstances.push(this._meshInstance);
    this._drawOrder = 0;
    this._entity.addChild(this._model.graph);
    this._model._entity = this._entity;
    this._onScreenChange(this._element.screen);
    this._element.on("resize", this._onParentResize, this);
    this._element.on("screen:set:screenspace", this._onScreenSpaceChange, this);
    this._element.on("set:screen", this._onScreenChange, this);
    this._element.on("set:draworder", this._onDrawOrderChange, this);
    this._element.on("screen:set:resolution", this._onResolutionChange, this);
  };
  pc.extend(ImageElement.prototype, {destroy:function() {
    if (this._model) {
      this._system.app.scene.removeModel(this._model);
      this._model.destroy();
      this._model = null;
    }
    this._element.off("resize", this._onParentResize, this);
    this._element.off("screen:set:screenspace", this._onScreenSpaceChange, this);
    this._element.off("set:screen", this._onScreenChange, this);
    this._element.off("set:draworder", this._onDrawOrderChange, this);
    this._element.off("screen:set:resolution", this._onResolutionChange, this);
  }, _onResolutionChange:function(res) {
  }, _onParentResize:function() {
    if (this._mesh) {
      this._updateMesh(this._mesh);
    }
  }, _onScreenSpaceChange:function(value) {
    this._updateMaterial(value);
  }, _onScreenChange:function(screen) {
    if (screen) {
      this._updateMaterial(screen.screen.screenSpace);
    } else {
      this._updateMaterial(false);
    }
  }, _onDrawOrderChange:function(order) {
    this._drawOrder = order;
    if (this._meshInstance) {
      this._meshInstance.drawOrder = order;
    }
  }, _hasUserMaterial:function() {
    return !!this._materialAsset || !!this._material && this._material !== this._system.defaultScreenSpaceImageMaterial && this._material !== this._system.defaultImageMaterial;
  }, _updateMaterial:function(screenSpace) {
    if (screenSpace) {
      if (!this._hasUserMaterial()) {
        this._material = this._system.defaultScreenSpaceImageMaterial;
      }
      if (this._meshInstance) {
        this._meshInstance.layer = pc.scene.LAYER_HUD;
      }
    } else {
      if (!this._hasUserMaterial()) {
        this._material = this._system.defaultImageMaterial;
      }
      if (this._meshInstance) {
        this._meshInstance.layer = pc.scene.LAYER_WORLD;
      }
    }
    if (this._meshInstance) {
      this._meshInstance.material = this._material;
      this._meshInstance.screenSpace = screenSpace;
    }
  }, _createMesh:function() {
    var w = this._element.width;
    var h = this._element.height;
    this._positions[0] = 0;
    this._positions[1] = 0;
    this._positions[2] = 0;
    this._positions[3] = w;
    this._positions[4] = 0;
    this._positions[5] = 0;
    this._positions[6] = w;
    this._positions[7] = h;
    this._positions[8] = 0;
    this._positions[9] = 0;
    this._positions[10] = h;
    this._positions[11] = 0;
    for (var i = 0;i < 12;i += 3) {
      this._normals[i] = 0;
      this._normals[i + 1] = 0;
      this._normals[i + 2] = 1;
    }
    this._uvs[0] = this._rect.data[0];
    this._uvs[1] = this._rect.data[1];
    this._uvs[2] = this._rect.data[0] + this._rect.data[2];
    this._uvs[3] = this._rect.data[1];
    this._uvs[4] = this._rect.data[0] + this._rect.data[2];
    this._uvs[5] = this._rect.data[1] + this._rect.data[3];
    this._uvs[6] = this._rect.data[0];
    this._uvs[7] = this._rect.data[1] + this._rect.data[3];
    this._indices[0] = 0;
    this._indices[1] = 1;
    this._indices[2] = 3;
    this._indices[3] = 2;
    this._indices[4] = 3;
    this._indices[5] = 1;
    var mesh = pc.createMesh(this._system.app.graphicsDevice, this._positions, {uvs:this._uvs, normals:this._normals, indices:this._indices});
    this._updateMesh(mesh);
    return mesh;
  }, _updateMesh:function(mesh) {
    var i;
    var w = this._element.width;
    var h = this._element.height;
    if (this._element.screen) {
      this._updateMaterial(this._element.screen.screen.screenSpace);
    } else {
      this._updateMaterial();
    }
    this._positions[0] = 0;
    this._positions[1] = 0;
    this._positions[2] = 0;
    this._positions[3] = w;
    this._positions[4] = 0;
    this._positions[5] = 0;
    this._positions[6] = w;
    this._positions[7] = h;
    this._positions[8] = 0;
    this._positions[9] = 0;
    this._positions[10] = h;
    this._positions[11] = 0;
    var hp = this._element.pivot.data[0];
    var vp = this._element.pivot.data[1];
    for (i = 0;i < this._positions.length;i += 3) {
      this._positions[i] -= hp * w;
      this._positions[i + 1] -= vp * h;
    }
    this._uvs[0] = this._rect.data[0];
    this._uvs[1] = this._rect.data[1];
    this._uvs[2] = this._rect.data[0] + this._rect.data[2];
    this._uvs[3] = this._rect.data[1];
    this._uvs[4] = this._rect.data[0] + this._rect.data[2];
    this._uvs[5] = this._rect.data[1] + this._rect.data[3];
    this._uvs[6] = this._rect.data[0];
    this._uvs[7] = this._rect.data[1] + this._rect.data[3];
    var vb = mesh.vertexBuffer;
    var it = new pc.VertexIterator(vb);
    var numVertices = 4;
    for (i = 0;i < numVertices;i++) {
      it.element[pc.SEMANTIC_POSITION].set(this._positions[i * 3 + 0], this._positions[i * 3 + 1], this._positions[i * 3 + 2]);
      it.element[pc.SEMANTIC_NORMAL].set(this._normals[i * 3 + 0], this._normals[i * 3 + 1], this._normals[i * 3 + 2]);
      it.element[pc.SEMANTIC_TEXCOORD0].set(this._uvs[i * 2 + 0], this._uvs[i * 2 + 1]);
      it.next();
    }
    it.end();
    mesh.aabb.compute(this._positions);
    if (this._meshInstance) {
      this._meshInstance._aabbVer = -1;
    }
  }, _onMaterialLoad:function(asset) {
    this.material = asset.resource;
  }, _onMaterialAdded:function(asset) {
    this._system.app.assets.off("add:" + asset.id, this._onMaterialAdded, this);
    if (this._materialAsset === asset.id) {
      this._bindMaterialAsset(asset);
    }
  }, _bindMaterialAsset:function(asset) {
    asset.on("load", this._onMaterialLoad, this);
    asset.on("change", this._onMaterialChange, this);
    asset.on("remove", this._onMaterialRemove, this);
    if (asset.resource) {
      this._onMaterialLoad(asset);
    } else {
      this._system.app.assets.load(asset);
    }
  }, _onMaterialChange:function() {
  }, _onMaterialRemove:function() {
  }, _onTextureAdded:function(asset) {
    this._system.app.assets.off("add:" + asset.id, this._onTextureAdded, this);
    if (this._textureAsset === asset.id) {
      this._bindTextureAsset(asset);
    }
  }, _bindTextureAsset:function(asset) {
    asset.on("load", this._onTextureLoad, this);
    asset.on("change", this._onTextureChange, this);
    asset.on("remove", this._onTextureRemove, this);
    if (asset.resource) {
      this._onTextureLoad(asset);
    } else {
      this._system.app.assets.load(asset);
    }
  }, _onTextureLoad:function(asset) {
    this.texture = asset.resource;
  }, _onTextureChange:function(asset) {
  }, _onTextureRemove:function(asset) {
  }, onEnable:function() {
    if (this._model && !this._system.app.scene.containsModel(this._model)) {
      this._system.app.scene.addModel(this._model);
    }
  }, onDisable:function() {
    if (this._model && this._system.app.scene.containsModel(this._model)) {
      this._system.app.scene.removeModel(this._model);
    }
  }});
  Object.defineProperty(ImageElement.prototype, "color", {get:function() {
    return this._color;
  }, set:function(value) {
    this._color.data[0] = value.data[0];
    this._color.data[1] = value.data[1];
    this._color.data[2] = value.data[2];
    if (this._meshInstance) {
      this._meshInstance.setParameter("material_emissive", this._color.data3);
    }
  }});
  Object.defineProperty(ImageElement.prototype, "opacity", {get:function() {
    return this._color.data[3];
  }, set:function(value) {
    this._color.data[3] = value;
    this._meshInstance.setParameter("material_opacity", value);
  }});
  Object.defineProperty(ImageElement.prototype, "rect", {get:function() {
    return this._rect;
  }, set:function(value) {
    if (value instanceof pc.Vec4) {
      this._rect.set(value.x, value.y, value.z, value.w);
    } else {
      this._rect.set(value[0], value[1], value[2], value[3]);
    }
    if (this._mesh) {
      this._updateMesh(this._mesh);
    }
  }});
  Object.defineProperty(ImageElement.prototype, "material", {get:function() {
    return this._material;
  }, set:function(value) {
    if (!value) {
      var screenSpace = this._element.screen ? this._element.screen.screen.screenSpace : false;
      value = screenSpace ? this._system.defaultScreenSpaceImageMaterial : this._system.defaultImageMaterial;
    }
    this._material = value;
    if (value) {
      this._meshInstance.material = value;
      if (value !== this._system.defaultScreenSpaceImageMaterial && value !== this._system.defaultImageMaterial) {
        this._meshInstance.deleteParameter("material_opacity");
        this._meshInstance.deleteParameter("material_emissive");
      } else {
        this._meshInstance.setParameter("material_emissive", this._color.data3);
        this._meshInstance.setParameter("material_opacity", this._color.data[3]);
      }
    }
  }});
  Object.defineProperty(ImageElement.prototype, "materialAsset", {get:function() {
    return this._materialAsset;
  }, set:function(value) {
    var assets = this._system.app.assets;
    var _id = value;
    if (value instanceof pc.Asset) {
      _id = value.id;
    }
    if (this._materialAsset !== _id) {
      if (this._materialAsset) {
        var _prev = assets.get(this._materialAsset);
        if (_prev) {
          _prev.off("load", this._onMaterialLoad, this);
          _prev.off("change", this._onMaterialChange, this);
          _prev.off("remove", this._onMaterialRemove, this);
        }
      }
      this._materialAsset = _id;
      if (this._materialAsset) {
        var asset = assets.get(this._materialAsset);
        if (!asset) {
          this.material = null;
          assets.on("add:" + this._materialAsset, this._onMaterialAdded, this);
        } else {
          this._bindMaterialAsset(asset);
        }
      } else {
        this.material = null;
      }
    }
  }});
  Object.defineProperty(ImageElement.prototype, "texture", {get:function() {
    return this._texture;
  }, set:function(value) {
    this._texture = value;
    if (value) {
      this._meshInstance.setParameter("texture_emissiveMap", this._texture);
      this._meshInstance.setParameter("texture_opacityMap", this._texture);
      this._meshInstance.setParameter("material_emissive", this._color.data3);
      this._meshInstance.setParameter("material_opacity", this._color.data[3]);
    } else {
      this._meshInstance.deleteParameter("texture_emissiveMap");
      this._meshInstance.deleteParameter("texture_opacityMap");
    }
  }});
  Object.defineProperty(ImageElement.prototype, "textureAsset", {get:function() {
    return this._textureAsset;
  }, set:function(value) {
    var assets = this._system.app.assets;
    var _id = value;
    if (value instanceof pc.Asset) {
      _id = value.id;
    }
    if (this._textureAsset !== _id) {
      if (this._textureAsset) {
        var _prev = assets.get(this._textureAsset);
        if (_prev) {
          _prev.off("load", this._onTextureLoad, this);
          _prev.off("change", this._onTextureChange, this);
          _prev.off("remove", this._onTextureRemove, this);
        }
      }
      this._textureAsset = _id;
      if (this._textureAsset) {
        var asset = assets.get(this._textureAsset);
        if (!asset) {
          this.texture = null;
          assets.on("add:" + this._textureAsset, this._onTextureAdded, this);
        } else {
          this._bindTextureAsset(asset);
        }
      } else {
        this.texture = null;
      }
    }
  }});
  return {ImageElement:ImageElement};
}());
pc.extend(pc, function() {
  var TextElement = function TextElement(element) {
    this._element = element;
    this._system = element.system;
    this._entity = element.entity;
    this._text = "";
    this._fontAsset = null;
    this._font = null;
    this._color = new pc.Color(1, 1, 1, 1);
    this._spacing = 1;
    this._fontSize = 32;
    this._lineHeight = 32;
    this._alignment = new pc.Vec2(0.5, 0.5);
    this._autoWidth = true;
    this._autoHeight = true;
    this.width = 0;
    this.height = 0;
    this._node = new pc.GraphNode;
    this._model = new pc.Model;
    this._model.graph = this._node;
    this._entity.addChild(this._node);
    this._meshInfo = [];
    this._material = null;
    this._noResize = false;
    this._onScreenChange(this._element.screen);
    element.on("resize", this._onParentResize, this);
    this._element.on("set:screen", this._onScreenChange, this);
    element.on("screen:set:screenspace", this._onScreenSpaceChange, this);
    element.on("set:draworder", this._onDrawOrderChange, this);
    element.on("set:pivot", this._onPivotChange, this);
  };
  pc.extend(TextElement.prototype, {destroy:function() {
    if (this._model) {
      this._system.app.scene.removeModel(this._model);
      this._model.destroy();
      this._model = null;
    }
    this._element.off("resize", this._onParentResize, this);
    this._element.off("set:screen", this._onScreenChange, this);
    this._element.off("screen:set:screenspace", this._onScreenSpaceChange, this);
    this._element.off("set:draworder", this._onDrawOrderChange, this);
    this._element.off("set:pivot", this._onPivotChange, this);
  }, _onParentResize:function(width, height) {
    if (this._noResize) {
      return;
    }
    if (this._font) {
      this._updateText(this._text);
    }
  }, _onScreenChange:function(screen) {
    if (screen) {
      this._updateMaterial(screen.screen.screenSpace);
    } else {
      this._updateMaterial(false);
    }
  }, _onScreenSpaceChange:function(value) {
    this._updateMaterial(value);
  }, _onDrawOrderChange:function(order) {
    this._drawOrder = order;
    if (this._model) {
      for (var i = 0, len = this._model.meshInstances.length;i < len;i++) {
        this._model.meshInstances[i].drawOrder = order;
      }
    }
  }, _onPivotChange:function(pivot) {
    if (this._font) {
      this._updateText();
    }
  }, _updateText:function(text) {
    if (text === undefined) {
      text = this._text;
    }
    var textLength = text.length;
    if (textLength === 0) {
      textLength = 1;
      text = " ";
    }
    var charactersPerTexture = {};
    for (var i = 0;i < textLength;i++) {
      var code = text.charCodeAt(i);
      var info = this._font.data.chars[code];
      if (!info) {
        continue;
      }
      var map = info.map;
      if (!charactersPerTexture[map]) {
        charactersPerTexture[map] = 0;
      }
      charactersPerTexture[map]++;
    }
    var removedModel = !this._system.app.scene.containsModel(this._model);
    var screenSpace = this._element.screen && this._element.screen.screen.screenSpace;
    for (var i = 0, len = this._meshInfo.length;i < len;i++) {
      var l = charactersPerTexture[i] || 0;
      var meshInfo = this._meshInfo[i];
      if (meshInfo.count !== l) {
        if (!removedModel) {
          this._system.app.scene.removeModel(this._model);
          removedModel = true;
        }
        meshInfo.count = l;
        meshInfo.positions.length = meshInfo.normals.length = l * 3 * 4;
        meshInfo.indices.length = l * 3 * 2;
        meshInfo.uvs.length = l * 2 * 4;
        if (meshInfo.meshInstance) {
          this._removeMeshInstance(meshInfo.meshInstance);
        }
        if (l === 0) {
          meshInfo.meshInstance = null;
          continue;
        }
        for (var v = 0;v < l;v++) {
          meshInfo.indices[v * 3 * 2 + 0] = v * 4;
          meshInfo.indices[v * 3 * 2 + 1] = v * 4 + 1;
          meshInfo.indices[v * 3 * 2 + 2] = v * 4 + 3;
          meshInfo.indices[v * 3 * 2 + 3] = v * 4 + 2;
          meshInfo.indices[v * 3 * 2 + 4] = v * 4 + 3;
          meshInfo.indices[v * 3 * 2 + 5] = v * 4 + 1;
          meshInfo.normals[v * 4 * 3 + 0] = 0;
          meshInfo.normals[v * 4 * 3 + 1] = 0;
          meshInfo.normals[v * 4 * 3 + 2] = -1;
          meshInfo.normals[v * 4 * 3 + 3] = 0;
          meshInfo.normals[v * 4 * 3 + 4] = 0;
          meshInfo.normals[v * 4 * 3 + 5] = -1;
          meshInfo.normals[v * 4 * 3 + 6] = 0;
          meshInfo.normals[v * 4 * 3 + 7] = 0;
          meshInfo.normals[v * 4 * 3 + 8] = -1;
          meshInfo.normals[v * 4 * 3 + 9] = 0;
          meshInfo.normals[v * 4 * 3 + 10] = 0;
          meshInfo.normals[v * 4 * 3 + 11] = -1;
        }
        var mesh = pc.createMesh(this._system.app.graphicsDevice, meshInfo.positions, {uvs:meshInfo.uvs, normals:meshInfo.normals, indices:meshInfo.indices});
        var mi = new pc.MeshInstance(this._node, mesh, this._material);
        mi.castShadow = false;
        mi.receiveShadow = false;
        mi.drawOrder = this._drawOrder;
        if (screenSpace) {
          mi.layer = pc.scene.LAYER_HUD;
        }
        mi.screenSpace = screenSpace;
        mi.setParameter("texture_msdfMap", this._font.textures[i]);
        mi.setParameter("material_emissive", this._color.data3);
        mi.setParameter("material_opacity", this._color.data[3]);
        mi.setParameter("font_sdfIntensity", this._font.intensity);
        mi.setParameter("font_pxrange", this._getPxRange(this._font));
        mi.setParameter("font_textureWidth", this._font.data.info.maps[i].width);
        meshInfo.meshInstance = mi;
        this._model.meshInstances.push(mi);
      }
    }
    if (removedModel && this._element.enabled && this._entity.enabled) {
      this._system.app.scene.addModel(this._model);
    }
    this._updateMeshes(text);
  }, _removeMeshInstance:function(meshInstance) {
    var oldMesh = meshInstance.mesh;
    if (oldMesh) {
      if (oldMesh.vertexBuffer) {
        oldMesh.vertexBuffer.destroy();
      }
      if (oldMesh.indexBuffer) {
        for (var ib = 0, iblen = oldMesh.indexBuffer.length;ib < iblen;ib++) {
          oldMesh.indexBuffer[ib].destroy();
        }
      }
    }
    var idx = this._model.meshInstances.indexOf(meshInstance);
    if (idx !== -1) {
      this._model.meshInstances.splice(idx, 1);
    }
  }, _updateMaterial:function(screenSpace) {
    var layer;
    if (screenSpace) {
      this._material = this._system.defaultScreenSpaceTextMaterial;
      layer = pc.scene.LAYER_HUD;
    } else {
      this._material = this._system.defaultTextMaterial;
      layer = pc.scene.LAYER_WORLD;
    }
    if (this._model) {
      for (var i = 0, len = this._model.meshInstances.length;i < len;i++) {
        var mi = this._model.meshInstances[i];
        mi.layer = layer;
        mi.material = this._material;
        mi.screenSpace = screenSpace;
      }
    }
  }, _updateMeshes:function(text) {
    var json = this._font.data;
    this.width = 0;
    this.height = 0;
    var lineWidths = [];
    var l = text.length;
    var _x = 0;
    var _y = 0;
    var _z = 0;
    var lines = 1;
    var lastLine = 0;
    var fontMinY = 0;
    var fontMaxY = 0;
    var scale = 1;
    var MAGIC = 32;
    var char, data, i;
    for (char in json.chars) {
      data = json.chars[char];
      scale = data.height / MAGIC * this._fontSize / data.height;
      if (data.bounds) {
        fontMinY = Math.min(fontMinY, data.bounds[1] * scale);
        fontMaxY = Math.max(fontMaxY, data.bounds[3] * scale);
      }
    }
    for (i = 0;i < this._meshInfo.length;i++) {
      this._meshInfo[i].quad = 0;
      this._meshInfo[i].lines = {};
    }
    for (i = 0;i < l;i++) {
      char = text.charCodeAt(i);
      if (char === 10 || char === 13) {
        _y -= this._lineHeight;
        _x = 0;
        lines++;
        lastLine = lines;
        lineWidths.push(0);
        continue;
      }
      lineWidths[lines - 1] = 0;
      var x = 0;
      var y = 0;
      var advance = 0;
      var quadsize = 1;
      var glyphMinX = 0;
      var glyphWidth = 0;
      data = json.chars[char];
      if (data && data.scale) {
        var size = (data.width + data.height) / 2;
        scale = size / MAGIC * this._fontSize / size;
        quadsize = size / MAGIC * this._fontSize / data.scale;
        advance = data.xadvance * scale;
        x = data.xoffset * scale;
        y = data.yoffset * scale;
        if (data.bounds) {
          glyphWidth = (data.bounds[2] - data.bounds[0]) * scale;
          glyphMinX = data.bounds[0] * scale;
        } else {
          glyphWidth = x;
          glyphMinX = 0;
        }
      } else {
        advance = 1;
        x = 0;
        y = 0;
        quadsize = this._fontSize;
      }
      var meshInfo = this._meshInfo[data && data.map || 0];
      var quad = meshInfo.quad;
      meshInfo.lines[lines - 1] = quad;
      meshInfo.positions[quad * 4 * 3 + 0] = _x - x;
      meshInfo.positions[quad * 4 * 3 + 1] = _y - y;
      meshInfo.positions[quad * 4 * 3 + 2] = _z;
      meshInfo.positions[quad * 4 * 3 + 3] = _x - x + quadsize;
      meshInfo.positions[quad * 4 * 3 + 4] = _y - y;
      meshInfo.positions[quad * 4 * 3 + 5] = _z;
      meshInfo.positions[quad * 4 * 3 + 6] = _x - x + quadsize;
      meshInfo.positions[quad * 4 * 3 + 7] = _y - y + quadsize;
      meshInfo.positions[quad * 4 * 3 + 8] = _z;
      meshInfo.positions[quad * 4 * 3 + 9] = _x - x;
      meshInfo.positions[quad * 4 * 3 + 10] = _y - y + quadsize;
      meshInfo.positions[quad * 4 * 3 + 11] = _z;
      this.width = Math.max(this.width, _x + glyphWidth + glyphMinX);
      lineWidths[lines - 1] = Math.max(lineWidths[lines - 1], _x + glyphWidth + glyphMinX);
      this.height = Math.max(this.height, fontMaxY - (_y + fontMinY));
      _x = _x + this._spacing * advance;
      var uv = this._getUv(char);
      meshInfo.uvs[quad * 4 * 2 + 0] = uv[0];
      meshInfo.uvs[quad * 4 * 2 + 1] = uv[1];
      meshInfo.uvs[quad * 4 * 2 + 2] = uv[2];
      meshInfo.uvs[quad * 4 * 2 + 3] = uv[1];
      meshInfo.uvs[quad * 4 * 2 + 4] = uv[2];
      meshInfo.uvs[quad * 4 * 2 + 5] = uv[3];
      meshInfo.uvs[quad * 4 * 2 + 6] = uv[0];
      meshInfo.uvs[quad * 4 * 2 + 7] = uv[3];
      meshInfo.quad++;
    }
    this._noResize = true;
    this.autoWidth = this._autoWidth;
    this.autoHeight = this._autoHeight;
    this._noResize = false;
    var hp = this._element.pivot.data[0];
    var vp = this._element.pivot.data[1];
    var ha = this._alignment.x;
    var va = this._alignment.y;
    for (i = 0;i < this._meshInfo.length;i++) {
      if (this._meshInfo[i].count === 0) {
        continue;
      }
      var prevQuad = 0;
      for (var line in this._meshInfo[i].lines) {
        var index = this._meshInfo[i].lines[line];
        var hoffset = -hp * this._element.width + ha * (this._element.width - lineWidths[parseInt(line, 10)]);
        var voffset = (1 - vp) * this._element.height - fontMaxY - (1 - va) * (this._element.height - this.height);
        for (var quad = prevQuad;quad <= index;quad++) {
          this._meshInfo[i].positions[quad * 4 * 3] += hoffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 3] += hoffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 6] += hoffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 9] += hoffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 1] += voffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 4] += voffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 7] += voffset;
          this._meshInfo[i].positions[quad * 4 * 3 + 10] += voffset;
        }
        prevQuad = index + 1;
      }
      var numVertices = this._meshInfo[i].quad * 4;
      var it = new pc.VertexIterator(this._meshInfo[i].meshInstance.mesh.vertexBuffer);
      for (var v = 0;v < numVertices;v++) {
        it.element[pc.SEMANTIC_POSITION].set(this._meshInfo[i].positions[v * 3 + 0], this._meshInfo[i].positions[v * 3 + 1], this._meshInfo[i].positions[v * 3 + 2]);
        it.element[pc.SEMANTIC_TEXCOORD0].set(this._meshInfo[i].uvs[v * 2 + 0], this._meshInfo[i].uvs[v * 2 + 1]);
        it.next();
      }
      it.end();
      this._meshInfo[i].meshInstance.mesh.aabb.compute(this._meshInfo[i].positions);
      this._meshInfo[i].meshInstance._aabbVer = -1;
    }
  }, _onFontAdded:function(asset) {
    this._system.app.assets.off("add:" + asset.id, this._onFontAdded, this);
    if (asset.id === this._fontAsset) {
      this._bindFont(asset);
    }
  }, _bindFont:function(asset) {
    asset.on("load", this._onFontLoad, this);
    asset.on("change", this._onFontChange, this);
    asset.on("remove", this._onFontRemove, this);
    if (asset.resource) {
      this._onFontLoad(asset);
    } else {
      this._system.app.assets.load(asset);
    }
  }, _onFontLoad:function(asset) {
    if (this.font !== asset.resource) {
      this.font = asset.resource;
    }
  }, _onFontChange:function(asset, name, _new, _old) {
    if (name === "data") {
      this._font.data = _new;
      var maps = this._font.data.info.maps.length;
      for (var i = 0;i < maps;i++) {
        if (!this._meshInfo[i]) {
          continue;
        }
        var mi = this._meshInfo[i].meshInstance;
        if (mi) {
          mi.setParameter("font_sdfIntensity", this._font.intensity);
          mi.setParameter("font_pxrange", this._getPxRange(this._font));
          mi.setParameter("font_textureWidth", this._font.data.info.maps[i].width);
        }
      }
    }
  }, _onFontRemove:function(asset) {
  }, _getPxRange:function(font) {
    var keys = Object.keys(this._font.data.chars);
    for (var i = 0;i < keys.length;i++) {
      var char = this._font.data.chars[keys[i]];
      if (char.scale && char.range) {
        return char.scale * char.range;
      }
    }
    return 2;
  }, _getUv:function(char) {
    var data = this._font.data;
    if (!data.chars[char]) {
      if (data.chars[32]) {
        return this._getUv(32);
      }
      return [0, 0, 1, 1];
    }
    var map = data.chars[char].map;
    var width = data.info.maps[map].width;
    var height = data.info.maps[map].height;
    var x = data.chars[char].x;
    var y = data.chars[char].y;
    var x1 = x;
    var y1 = y;
    var x2 = x + data.chars[char].width;
    var y2 = y - data.chars[char].height;
    var edge = 1 - data.chars[char].height / height;
    return [x1 / width, edge - y1 / height, x2 / width, edge - y2 / height];
  }, onEnable:function() {
    if (this._model && !this._system.app.scene.containsModel(this._model)) {
      this._system.app.scene.addModel(this._model);
    }
  }, onDisable:function() {
    if (this._model && this._system.app.scene.containsModel(this._model)) {
      this._system.app.scene.removeModel(this._model);
    }
  }});
  Object.defineProperty(TextElement.prototype, "text", {get:function() {
    return this._text;
  }, set:function(value) {
    var str = value.toString();
    if (this._font) {
      this._updateText(str);
    }
    this._text = str;
  }});
  Object.defineProperty(TextElement.prototype, "color", {get:function() {
    return this._color;
  }, set:function(value) {
    this._color.data[0] = value.data[0];
    this._color.data[1] = value.data[1];
    this._color.data[2] = value.data[2];
    if (this._model) {
      for (var i = 0, len = this._model.meshInstances.length;i < len;i++) {
        var mi = this._model.meshInstances[i];
        mi.setParameter("material_emissive", this._color.data3);
      }
    }
  }});
  Object.defineProperty(TextElement.prototype, "opacity", {get:function() {
    return this._color.data[3];
  }, set:function(value) {
    this._color.data[3] = value;
    if (this._model) {
      for (var i = 0, len = this._model.meshInstances.length;i < len;i++) {
        var mi = this._model.meshInstances[i];
        mi.setParameter("material_opacity", value);
      }
    }
  }});
  Object.defineProperty(TextElement.prototype, "lineHeight", {get:function() {
    return this._lineHeight;
  }, set:function(value) {
    var _prev = this._lineHeight;
    this._lineHeight = value;
    if (_prev !== value && this._font) {
      this._updateText();
    }
  }});
  Object.defineProperty(TextElement.prototype, "spacing", {get:function() {
    return this._spacing;
  }, set:function(value) {
    var _prev = this._spacing;
    this._spacing = value;
    if (_prev !== value && this._font) {
      this._updateText();
    }
  }});
  Object.defineProperty(TextElement.prototype, "fontSize", {get:function() {
    return this._fontSize;
  }, set:function(value) {
    var _prev = this._fontSize;
    this._fontSize = value;
    if (_prev !== value && this._font) {
      this._updateText();
    }
  }});
  Object.defineProperty(TextElement.prototype, "fontAsset", {get function() {
    return this._fontAsset;
  }, set:function(value) {
    var assets = this._system.app.assets;
    var _id = value;
    if (value instanceof pc.Asset) {
      _id = value.id;
    }
    if (this._fontAsset !== _id) {
      if (this._fontAsset) {
        var _prev = assets.get(this._fontAsset);
        if (_prev) {
          _prev.off("load", this._onFontLoad, this);
          _prev.off("change", this._onFontChange, this);
          _prev.off("remove", this._onFontRemove, this);
        }
      }
      this._fontAsset = _id;
      if (this._fontAsset) {
        var asset = assets.get(this._fontAsset);
        if (!asset) {
          assets.on("add:" + this._fontAsset, this._onFontAdded, this);
        } else {
          this._bindFont(asset);
        }
      }
    }
  }});
  Object.defineProperty(TextElement.prototype, "font", {get:function() {
    return this._font;
  }, set:function(value) {
    this._font = value;
    if (!value) {
      return;
    }
    for (var i = 0, len = this._font.textures.length;i < len;i++) {
      if (!this._meshInfo[i]) {
        this._meshInfo[i] = {count:0, quad:0, lines:{}, positions:[], normals:[], uvs:[], indices:[], meshInstance:null};
      } else {
        var mi = this._meshInfo[i].meshInstance;
        if (mi) {
          mi.setParameter("font_sdfIntensity", this._font.intensity);
          mi.setParameter("font_pxrange", this._getPxRange(this._font));
          mi.setParameter("font_textureWidth", this._font.data.info.maps[i].width);
          mi.setParameter("texture_msdfMap", this._font.textures[i]);
        }
      }
    }
    var removedModel = false;
    for (var i = this._font.textures.length;i < this._meshInfo.length;i++) {
      if (this._meshInfo[i].meshInstance) {
        if (!removedModel) {
          this._system.app.scene.removeModel(this._model);
          removedModel = true;
        }
        this._removeMeshInstance(this._meshInfo[i].meshInstance);
      }
    }
    if (this._meshInfo.length > this._font.textures.length) {
      this._meshInfo.length = this._font.textures.length;
    }
    this._updateText();
  }});
  Object.defineProperty(TextElement.prototype, "alignment", {get:function() {
    return this._alignment;
  }, set:function(value) {
    if (value instanceof pc.Vec2) {
      this._alignment.set(value.x, value.y);
    } else {
      this._alignment.set(value[0], value[1]);
    }
    if (this._font) {
      this._updateText();
    }
  }});
  Object.defineProperty(TextElement.prototype, "autoWidth", {get:function() {
    return this._autoWidth;
  }, set:function(value) {
    this._autoWidth = value;
    if (value) {
      this._element.width = this.width;
    }
  }});
  Object.defineProperty(TextElement.prototype, "autoHeight", {get:function() {
    return this._autoHeight;
  }, set:function(value) {
    this._autoHeight = value;
    if (value) {
      this._element.height = this.height;
    }
  }});
  return {TextElement:TextElement};
}());
pc.extend(pc, function() {
  pc.FONT_MSDF = "msdf";
  var Font = function(textures, data) {
    this.type = pc.FONT_MSDF;
    this.em = 1;
    this.textures = textures;
    this.intensity = 0.0;
    this._data = null;
    this.data = data;
  };
  Font.prototype = {};
  Object.defineProperty(Font.prototype, "data", {get:function() {
    return this._data;
  }, set:function(value) {
    this._data = value;
    if (!value) {
      return;
    }
    if (this._data.intensity !== undefined) {
      this.intensity = this._data.intensity;
    }
    if (!this._data.info) {
      this._data.info = {};
    }
    if (!this._data.version || this._data.version < 2) {
      this._data.info.maps = [{width:this._data.info.width, height:this._data.info.height}];
      if (this._data.chars) {
        for (var key in this._data.chars) {
          this._data.chars[key].map = 0;
        }
      }
    }
  }});
  return {FONT_MSDF:pc.FONT_MSDF, Font:Font};
}());
pc.extend(pc, function() {
  var ZoneComponent = function ZoneComponent(system, entity) {
    this._oldState = true;
    this._size = new pc.Vec3;
    this.on("set_enabled", this._onSetEnabled, this);
  };
  ZoneComponent = pc.inherits(ZoneComponent, pc.Component);
  pc.extend(ZoneComponent.prototype, {onEnable:function() {
    ZoneComponent._super.onEnable.call(this);
    this._checkState();
  }, onDisable:function() {
    ZoneComponent._super.onDisable.call(this);
    this._checkState();
  }, _onSetEnabled:function(prop, old, value) {
    this._checkState();
  }, _checkState:function() {
    var state = this.enabled && this.entity.enabled;
    if (state === this._oldState) {
      return;
    }
    this._oldState = state;
    this.fire("enable");
    this.fire("state", this.enabled);
  }, _onBeforeRemove:function() {
    this.fire("remove");
  }});
  Object.defineProperty(ZoneComponent.prototype, "size", {set:function(data) {
    if (data instanceof pc.Vec3) {
      this._size.copy(data);
    } else {
      if (data instanceof Array && data.length >= 3) {
        this.size.set(data[0], data[1], data[2]);
      }
    }
  }, get:function() {
    return this._size;
  }});
  return {ZoneComponent:ZoneComponent};
}());
pc.extend(pc, function() {
  var _schema = ["enabled"];
  var ZoneComponentSystem = function ZoneComponentSystem(app) {
    this.id = "zone";
    this.app = app;
    app.systems.add(this.id, this);
    this.ComponentType = pc.ZoneComponent;
    this.DataType = pc.ZoneComponentData;
    this.schema = _schema;
    this.on("beforeremove", this._onBeforeRemove, this);
  };
  ZoneComponentSystem = pc.inherits(ZoneComponentSystem, pc.ComponentSystem);
  pc.Component._buildAccessors(pc.ZoneComponent.prototype, _schema);
  pc.extend(ZoneComponentSystem.prototype, {initializeComponentData:function(component, data, properties) {
    component.enabled = data.hasOwnProperty("enabled") ? !!data.enabled : true;
    if (data.size) {
      if (data.size instanceof pc.Vec3) {
        component.size.copy(data.size);
      } else {
        if (data.size instanceof Array && data.size.length >= 3) {
          component.size.set(data.size[0], data.size[1], data.size[2]);
        }
      }
    }
  }, cloneComponent:function(entity, clone) {
    var data = {size:entity.zone.size};
    return this.addComponent(clone, data);
  }, _onBeforeRemove:function(entity, component) {
    component._onBeforeRemove();
  }});
  return {ZoneComponentSystem:ZoneComponentSystem};
}());
pc.extend(pc, function() {
  var ZoneComponentData = function() {
    this.enabled = true;
  };
  ZoneComponentData = pc.inherits(ZoneComponentData, pc.ComponentData);
  return {ZoneComponentData:ZoneComponentData};
}());
pc.extend(pc, function() {
  var Entity = function(name, app) {
    if (name instanceof pc.Application) {
      app = name;
    }
    this._guid = pc.guid.create();
    this._batchHandle = null;
    this.c = {};
    this._app = app;
    if (!app) {
      this._app = pc.Application.getApplication();
      if (!this._app) {
        console.error("Couldn't find current application");
      }
    }
    pc.events.attach(this);
  };
  Entity = pc.inherits(Entity, pc.GraphNode);
  Entity.prototype.addComponent = function(type, data) {
    var system = this._app.systems[type];
    if (system) {
      if (!this.c[type]) {
        return system.addComponent(this, data);
      } else {
        logERROR(pc.string.format("Entity already has {0} Component", type));
      }
    } else {
      logERROR(pc.string.format("System: '{0}' doesn't exist", type));
      return null;
    }
  };
  Entity.prototype.removeComponent = function(type) {
    var system = this._app.systems[type];
    if (system) {
      if (this.c[type]) {
        system.removeComponent(this);
      } else {
        logERROR(pc.string.format("Entity doesn't have {0} Component", type));
      }
    } else {
      logERROR(pc.string.format("System: '{0}' doesn't exist", type));
    }
  };
  Entity.prototype.getGuid = function() {
    return this._guid;
  };
  Entity.prototype.setGuid = function(guid) {
    this._guid = guid;
  };
  Entity.prototype._notifyHierarchyStateChanged = function(node, enabled) {
    var enableFirst = false;
    if (node === this && this._app._enableList.length === 0) {
      enableFirst = true;
    }
    node._onHierarchyStateChanged(enabled);
    if (node._onHierarchyStatePostChanged) {
      this._app._enableList.push(node);
    }
    var i, len;
    var c = node._children;
    for (i = 0, len = c.length;i < len;i++) {
      if (c[i]._enabled) {
        this._notifyHierarchyStateChanged(c[i], enabled);
      }
    }
    if (enableFirst) {
      for (i = 0, len = this._app._enableList.length;i < len;i++) {
        this._app._enableList[i]._onHierarchyStatePostChanged();
      }
      this._app._enableList.length = 0;
    }
  };
  Entity.prototype._onHierarchyStateChanged = function(enabled) {
    pc.Entity._super._onHierarchyStateChanged.call(this, enabled);
    var component;
    var components = this.c;
    for (var type in components) {
      if (components.hasOwnProperty(type)) {
        component = components[type];
        if (component.enabled) {
          if (enabled) {
            component.onEnable();
          } else {
            component.onDisable();
          }
        }
      }
    }
  };
  Entity.prototype._onHierarchyStatePostChanged = function() {
    var components = this.c;
    for (var type in components) {
      if (components.hasOwnProperty(type)) {
        components[type].onPostStateChange();
      }
    }
  };
  Entity.prototype.setRequest = function(request) {
    this._request = request;
  };
  Entity.prototype.getRequest = function() {
    return this._request;
  };
  Entity.prototype.findByGuid = function(guid) {
    if (this._guid === guid) {
      return this;
    }
    for (var i = 0;i < this._children.length;i++) {
      if (this._children[i].findByGuid) {
        var found = this._children[i].findByGuid(guid);
        if (found !== null) {
          return found;
        }
      }
    }
    return null;
  };
  Entity.prototype.destroy = function() {
    var childGuids;
    var name;
    for (name in this.c) {
      this.c[name].enabled = false;
    }
    for (name in this.c) {
      this.c[name].system.removeComponent(this);
    }
    if (this._parent) {
      this._parent.removeChild(this);
    }
    var children = this._children;
    var length = children.length;
    var child = children.shift();
    while (child) {
      if (child instanceof pc.Entity) {
        child.destroy();
      }
      child._parent = null;
      child = children.shift();
    }
    this.fire("destroy", this);
    if (this._callbacks) {
      this._callbacks = null;
    }
    if (this._callbackActive) {
      this._callbackActive = null;
    }
  };
  Entity.prototype.clone = function() {
    var type;
    var c = new pc.Entity(this._app);
    pc.Entity._super._cloneInternal.call(this, c);
    for (type in this.c) {
      var component = this.c[type];
      component.system.cloneComponent(this, c);
    }
    var i;
    for (i = 0;i < this._children.length;i++) {
      var child = this._children[i];
      if (child instanceof pc.Entity) {
        c.addChild(child.clone());
      }
    }
    return c;
  };
  return {Entity:Entity};
}());
pc.extend(pc, function() {
  var ResourceLoader = function() {
    this._handlers = {};
    this._requests = {};
    this._cache = {};
  };
  ResourceLoader.prototype = {addHandler:function(type, handler) {
    this._handlers[type] = handler;
    handler._loader = this;
  }, removeHandler:function(type) {
    delete this._handlers[type];
  }, getHandler:function(type) {
    return this._handlers[type];
  }, load:function(url, type, callback, asset) {
    var handler = this._handlers[type];
    if (!handler) {
      var err = "No handler for asset type: " + type;
      callback(err);
      return;
    }
    var key = url + type;
    if (this._cache[key] !== undefined) {
      callback(null, this._cache[key]);
    } else {
      if (this._requests[key]) {
        this._requests[key].push(callback);
      } else {
        this._requests[key] = [callback];
        handler.load(url, function(err, data, extra) {
          if (!this._requests[key]) {
            return;
          }
          var i, len = this._requests[key].length;
          if (!err) {
            var resource = handler.open(url, data, asset);
            this._cache[key] = resource;
            for (i = 0;i < len;i++) {
              this._requests[key][i](null, resource, extra);
            }
          } else {
            for (i = 0;i < len;i++) {
              this._requests[key][i](err);
            }
          }
          delete this._requests[key];
        }.bind(this), asset);
      }
    }
  }, open:function(type, data) {
    var handler = this._handlers[type];
    if (!handler) {
      console.warn("No resource handler found for: " + type);
      return data;
    }
    return handler.open(null, data);
  }, patch:function(asset, assets) {
    var handler = this._handlers[asset.type];
    if (!handler) {
      console.warn("No resource handler found for: " + asset.type);
      return;
    }
    if (handler.patch) {
      handler.patch(asset, assets);
    }
  }, clearCache:function(url, type) {
    delete this._cache[url + type];
  }, getFromCache:function(url, type) {
    if (this._cache[url + type]) {
      return this._cache[url + type];
    }
  }, destroy:function() {
    this._handlers = {};
    this._requests = {};
    this._cache = {};
  }};
  return {ResourceLoader:ResourceLoader};
}());
pc.extend(pc, function() {
  var AnimationHandler = function() {
  };
  AnimationHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (err) {
        callback(pc.string.format("Error loading animation resource: {0} [{1}]", url, err));
      } else {
        callback(null, response);
      }
    }.bind(this));
  }, open:function(url, data) {
    return this["_parseAnimationV" + data.animation.version](data);
  }, _parseAnimationV3:function(data) {
    var animData = data.animation;
    var anim = new pc.Animation;
    anim.setName(animData.name);
    anim.duration = animData.duration;
    for (var i = 0;i < animData.nodes.length;i++) {
      var node = new pc.Node;
      var n = animData.nodes[i];
      node._name = n.name;
      for (var j = 0;j < n.keys.length;j++) {
        var k = n.keys[j];
        var t = k.time;
        var p = k.pos;
        var r = k.rot;
        var s = k.scale;
        var pos = new pc.Vec3(p[0], p[1], p[2]);
        var rot = (new pc.Quat).setFromEulerAngles(r[0], r[1], r[2]);
        var scl = new pc.Vec3(s[0], s[1], s[2]);
        var key = new pc.Key(t, pos, rot, scl);
        node._keys.push(key);
      }
      anim.addNode(node);
    }
    return anim;
  }, _parseAnimationV4:function(data) {
    var animData = data.animation;
    var anim = new pc.Animation;
    anim.setName(animData.name);
    anim.duration = animData.duration;
    for (var i = 0;i < animData.nodes.length;i++) {
      var node = new pc.Node;
      var n = animData.nodes[i];
      node._name = n.name;
      var defPos = n.defaults.p;
      var defRot = n.defaults.r;
      var defScl = n.defaults.s;
      for (var j = 0;j < n.keys.length;j++) {
        var k = n.keys[j];
        var t = k.t;
        var p = defPos ? defPos : k.p;
        var r = defRot ? defRot : k.r;
        var s = defScl ? defScl : k.s;
        var pos = new pc.Vec3(p[0], p[1], p[2]);
        var rot = (new pc.Quat).setFromEulerAngles(r[0], r[1], r[2]);
        var scl = new pc.Vec3(s[0], s[1], s[2]);
        var key = new pc.Key(t, pos, rot, scl);
        node._keys.push(key);
      }
      anim.addNode(node);
    }
    return anim;
  }};
  return {AnimationHandler:AnimationHandler};
}());
pc.extend(pc, function() {
  var ie = function() {
    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE ");
    if (msie > 0) {
      return parseInt(ua.substring(msie + 5, ua.indexOf(".", msie)), 10);
    }
    var trident = ua.indexOf("Trident/");
    if (trident > 0) {
      var rv = ua.indexOf("rv:");
      return parseInt(ua.substring(rv + 3, ua.indexOf(".", rv)), 10);
    }
    return false;
  }();
  var AudioHandler = function(manager) {
    this.manager = manager;
  };
  AudioHandler.prototype = {_isSupported:function(url) {
    var toMIME = {".ogg":"audio/ogg", ".mp3":"audio/mpeg", ".wav":"audio/x-wav", ".mp4a":"audio/mp4", ".m4a":"audio/mp4", ".mp4":"audio/mp4", ".aac":"audio/aac"};
    var ext = pc.path.getExtension(url);
    if (toMIME[ext]) {
      return true;
    } else {
      return false;
    }
  }, load:function(url, callback) {
    var success = function(resource) {
      callback(null, new pc.Sound(resource));
    };
    var error = function(msg) {
      msg = msg || "Error loading audio url: " + url;
      console.warn(msg);
      callback(msg);
    };
    if (this._createSound) {
      if (!this._isSupported(url)) {
        error(pc.string.format("Audio format for {0} not supported", url));
        return;
      }
      this._createSound(url, success, error);
    } else {
      error(null);
    }
  }, open:function(url, data) {
    return data;
  }};
  if (pc.SoundManager.hasAudioContext()) {
    AudioHandler.prototype._createSound = function(url, success, error) {
      var manager = this.manager;
      if (!manager.context) {
        error("Audio manager has no audio context");
        return;
      }
      pc.http.get(url, function(err, response) {
        if (err) {
          error(err);
          return;
        }
        manager.context.decodeAudioData(response, success, error);
      });
    };
  } else {
    if (pc.SoundManager.hasAudio()) {
      AudioHandler.prototype._createSound = function(url, success, error) {
        var audio = null;
        try {
          audio = new Audio;
        } catch (e) {
          error("No support for Audio element");
          return;
        }
        if (ie) {
          document.body.appendChild(audio);
        }
        var onReady = function() {
          audio.removeEventListener("canplaythrough", onReady);
          if (ie) {
            document.body.removeChild(audio);
          }
          success(audio);
        };
        audio.onerror = function() {
          audio.onerror = null;
          if (ie) {
            document.body.removeChild(audio);
          }
          error();
        };
        audio.addEventListener("canplaythrough", onReady);
        audio.src = url;
      };
    }
  }
  return {AudioHandler:AudioHandler};
}());
pc.extend(pc, function() {
  var CubemapHandler = function(device, assets, loader) {
    this._device = device;
    this._assets = assets;
    this._loader = loader;
  };
  CubemapHandler.prototype = {load:function(url, callback) {
  }, open:function(url, data) {
  }, patch:function(assetCubeMap, assets) {
    var self = this;
    var loaded = false;
    if (!assetCubeMap.resources[0]) {
      assetCubeMap.resources[0] = new pc.Texture(this._device, {format:pc.PIXELFORMAT_R8_G8_B8_A8, cubemap:true, mipmaps:true, fixCubemapSeams:!!assetCubeMap._dds});
      loaded = true;
    }
    if (!assetCubeMap.file) {
      delete assetCubeMap._dds;
    } else {
      if (assetCubeMap.file && !assetCubeMap._dds) {
        var url = assetCubeMap.getFileUrl();
        assets._loader.load(url + "?t=" + assetCubeMap.file.hash, "texture", function(err, texture) {
          if (!err) {
            assets._loader.patch({resource:texture, type:"texture", data:assetCubeMap.data}, assets);
            assetCubeMap._dds = texture;
            self.patch(assetCubeMap, assets);
          } else {
            assets.fire("error", err, assetCubeMap);
            assets.fire("error:" + assetCubeMap.id, err, assetCubeMap);
            assetCubeMap.fire("error", err, assetCubeMap);
            return;
          }
        });
      }
    }
    if ((!assetCubeMap.file || !assetCubeMap._dds) && assetCubeMap.resources[1]) {
      assetCubeMap.resources = [assetCubeMap.resources[0]];
      loaded = true;
    } else {
      if (assetCubeMap._dds && !assetCubeMap.resources[1]) {
        assetCubeMap.resources = [assetCubeMap.resources[0]];
        assetCubeMap._dds.fixCubemapSeams = true;
        assetCubeMap._dds.addressU = pc.ADDRESS_CLAMP_TO_EDGE;
        assetCubeMap._dds.addressV = pc.ADDRESS_CLAMP_TO_EDGE;
        var startIndex = 0;
        if (this._device.useTexCubeLod) {
          assetCubeMap.resources.push(assetCubeMap._dds);
          startIndex = 1;
        }
        for (var i = startIndex;i < 6;i++) {
          var mip = new pc.Texture(this._device, {cubemap:true, fixCubemapSeams:true, mipmaps:true, format:assetCubeMap._dds.format, rgbm:assetCubeMap._dds.rgbm, width:Math.pow(2, 7 - i), height:Math.pow(2, 7 - i)});
          mip._levels[0] = assetCubeMap._dds._levels[i];
          mip.upload();
          assetCubeMap.resources.push(mip);
        }
        loaded = true;
      }
    }
    var cubemap = assetCubeMap.resource;
    if (cubemap.name !== assetCubeMap.name) {
      cubemap.name = assetCubeMap.name;
    }
    var rgbm = !!assetCubeMap.data.rgbm;
    if (assetCubeMap.data.hasOwnProperty("rgbm") && cubemap.rgbm !== rgbm) {
      cubemap.rgbm = rgbm;
    }
    cubemap.fixCubemapSeams = !!assetCubeMap._dds;
    if (assetCubeMap.data.hasOwnProperty("minFilter") && cubemap.minFilter !== assetCubeMap.data.minFilter) {
      cubemap.minFilter = assetCubeMap.data.minFilter;
    }
    if (assetCubeMap.data.hasOwnProperty("magFilter") && cubemap.magFilter !== assetCubeMap.data.magFilter) {
      cubemap.magFilter = assetCubeMap.data.magFilter;
    }
    if (assetCubeMap.data.hasOwnProperty("anisotropy") && cubemap.anisotropy !== assetCubeMap.data.anisotropy) {
      cubemap.anisotropy = assetCubeMap.data.anisotropy;
    }
    if (cubemap.addressU !== pc.ADDRESS_CLAMP_TO_EDGE) {
      cubemap.addressU = pc.ADDRESS_CLAMP_TO_EDGE;
    }
    if (cubemap.addressV !== pc.ADDRESS_CLAMP_TO_EDGE) {
      cubemap.addressV = pc.ADDRESS_CLAMP_TO_EDGE;
    }
    this._patchTextureFaces(assetCubeMap, assets);
    if (loaded) {
      assets.fire("load", assetCubeMap);
      assets.fire("load:" + assetCubeMap.id, assetCubeMap);
      assetCubeMap.fire("load", assetCubeMap);
    }
  }, _patchTexture:function() {
    this.registry._loader._handlers.cubemap._patchTextureFaces(this, this.registry);
  }, _patchTextureFaces:function(assetCubeMap, assets) {
    if (!assetCubeMap.loadFaces && assetCubeMap.file) {
      return;
    }
    var cubemap = assetCubeMap.resource;
    var sources = [];
    var count = 0;
    var levelsUpdated = false;
    var self = this;
    if (!assetCubeMap._levelsEvents) {
      assetCubeMap._levelsEvents = [null, null, null, null, null, null];
    }
    assetCubeMap.data.textures.forEach(function(id, index) {
      var assetAdded = function(asset) {
        asset.ready(assetReady);
        assets.load(asset);
      };
      var assetReady = function(asset) {
        count++;
        sources[index] = asset && asset.resource.getSource() || null;
        var evtAsset = assetCubeMap._levelsEvents[index];
        if (evtAsset !== asset) {
          if (evtAsset) {
            evtAsset.off("load", self._patchTexture, assetCubeMap);
          }
          if (asset) {
            asset.on("load", self._patchTexture, assetCubeMap);
          }
          assetCubeMap._levelsEvents[index] = asset || null;
        }
        if (sources[index] !== cubemap._levels[0][index]) {
          levelsUpdated = true;
        }
        if (count === 6 && levelsUpdated) {
          cubemap.setSource(sources);
          assets.fire("load", assetCubeMap);
          assets.fire("load:" + assetCubeMap.id, assetCubeMap);
          assetCubeMap.fire("load", assetCubeMap);
        }
      };
      var asset = assets.get(id);
      if (asset) {
        asset.ready(assetReady);
        assets.load(asset);
      } else {
        if (id) {
          assets.once("load:" + id, assetReady);
          assets.once("add:" + id, assetAdded);
        } else {
          assetReady(null);
        }
      }
    });
  }};
  return {CubemapHandler:CubemapHandler};
}());
pc.extend(pc, function() {
  var JsonHandler = function() {
  };
  JsonHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading JSON resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  return {JsonHandler:JsonHandler};
}());
pc.extend(pc, function() {
  var PARAMETER_TYPES = {ambient:"vec3", ambientTnumber:"boolean", aoMap:"texture", aoMapVertexColor:"boolean", aoMapChannel:"string", aoMapUv:"number", aoMapTiling:"vec2", aoMapOffset:"vec2", occludeSpecular:"boolean", diffuse:"vec3", diffuseMap:"texture", diffuseMapVertexColor:"boolean", diffuseMapChannel:"string", diffuseMapUv:"number", diffuseMapTiling:"vec2", diffuseMapOffset:"vec2", diffuseMapTnumber:"boolean", specular:"vec3", specularMapVertexColor:"boolean", specularMapChannel:"string",
  specularMapUv:"number", specularMap:"texture", specularMapTiling:"vec2", specularMapOffset:"vec2", specularMapTnumber:"boolean", specularAntialias:"boolean", useMetalness:"boolean", metalnessMap:"texture", metalnessMapVertexColor:"boolean", metalnessMapChannel:"string", metalnessMapUv:"number", metalnessMapTiling:"vec2", metalnessMapOffset:"vec2", metalnessMapTnumber:"boolean", metalness:"number", conserveEnergy:"boolean", shininess:"number", glossMap:"texture", glossMapVertexColor:"boolean", glossMapChannel:"string",
  glossMapUv:"number", glossMapTiling:"vec2", glossMapOffset:"vec2", fresnelModel:"number", fresnelFactor:"float", emissive:"vec3", emissiveMap:"texture", emissiveMapVertexColor:"boolean", emissiveMapChannel:"string", emissiveMapUv:"number", emissiveMapTiling:"vec2", emissiveMapOffset:"vec2", emissiveMapTint:"boolean", emissiveIntensity:"number", normalMap:"texture", normalMapTiling:"vec2", normalMapOffset:"vec2", normalMapUv:"number", bumpMapFactor:"number", heightMap:"texture", heightMapChannel:"string",
  heightMapUv:"number", heightMapTiling:"vec2", heightMapOffset:"vec2", heightMapFactor:"number", alphaTest:"number", opacity:"number", opacityMap:"texture", opacityMapVertexColor:"boolean", opacityMapChannel:"string", opacityMapUv:"number", opacityMapTiling:"vec2", opacityMapOffset:"vec2", reflectivity:"number", refraction:"number", refractionIndex:"number", sphereMap:"texture", cubeMap:"cubemap", cubeMapProjection:"number", cubeMapProjectionBox:"boundingbox", lightMap:"texture", lightMapVertexColor:"boolean",
  lightMapChannel:"string", lightMapUv:"number", lightMapTiling:"vec2", lightMapOffset:"vec2", depthTest:"boolean", depthWrite:"boolean", cull:"number", blendType:"number", shadingModel:"number"};
  var placeholders = {};
  var placeholdersMapping = {aoMap:"white", diffuseMap:"gray", specularMap:"gray", metalnessMap:"black", glossMap:"gray", emissiveMap:"gray", normalMap:"normal", heightMap:"gray", opacityMap:"gray", sphereMap:"gray", lightMap:"white"};
  var onCubemapAssetLoad = function(asset, attribute, newValue, oldValue) {
    var props = ["cubeMap", "prefilteredCubeMap128", "prefilteredCubeMap64", "prefilteredCubeMap32", "prefilteredCubeMap16", "prefilteredCubeMap8", "prefilteredCubeMap4"];
    for (var i = 0;i < props.length;i++) {
      if (this[props[i]] !== asset.resources[i]) {
        this[props[i]] = asset.resources[i];
      }
    }
    this.update();
  };
  var MaterialHandler = function(app) {
    this._assets = app.assets;
    this._device = app.graphicsDevice;
    this._createPlaceholders();
  };
  MaterialHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        if (callback) {
          callback(null, response);
        }
      } else {
        if (callback) {
          callback(pc.string.format("Error loading material: {0} [{1}]", url, err));
        }
      }
    });
  }, open:function(url, data) {
    var material = new pc.StandardMaterial;
    if (!data.parameters) {
      this._createParameters(data);
    }
    material.init(data);
    material._data = data;
    return material;
  }, _createPlaceholders:function() {
    var textures = {white:[255, 255, 255, 255], gray:[128, 128, 128, 255], black:[0, 0, 0, 255], normal:[128, 128, 255, 255]};
    for (var key in textures) {
      if (!textures.hasOwnProperty(key)) {
        continue;
      }
      var texture = placeholders[key] = new pc.Texture(this._device, {width:2, height:2, format:pc.PIXELFORMAT_R8_G8_B8_A8});
      var pixels = texture.lock();
      for (var i = 0;i < 4;i++) {
        for (var c = 0;c < 4;c++) {
          pixels[i * 4 + c] = textures[key][c];
        }
      }
      texture.unlock();
    }
  }, _createParameters:function(data) {
    var parameters = [];
    if (!data.shadingModel) {
      data.shadingModel = data.shader === "blinn" ? pc.SPECULAR_BLINN : pc.SPECULAR_PHONG;
    }
    var shader = data.shader;
    delete data.shader;
    for (var key in data) {
      if (!data.hasOwnProperty(key)) {
        continue;
      }
      parameters.push({name:key, type:PARAMETER_TYPES[key], data:data[key]});
    }
    data.shader = shader;
    data.parameters = parameters;
  }, patch:function(asset, assets) {
    if (asset.data.shader === undefined) {
      asset.data = asset.resource._data;
      delete asset.resource._data;
    }
    this._updateStandardMaterial(asset, asset.data, assets);
    asset.off("change", this._onAssetChange, this);
    asset.on("change", this._onAssetChange, this);
    asset.on("unload", this._onAssetUnload, this);
  }, _onAssetChange:function(asset, attribute, value) {
    if (attribute === "data") {
      this._updateStandardMaterial(asset, value, this._assets);
    }
  }, _onAssetUnload:function(asset) {
    delete asset.data.parameters;
    delete asset.data.chunks;
    delete asset.data.name;
  }, _updateStandardMaterial:function(asset, data, assets) {
    var material = asset.resource;
    var dir;
    if (asset.file) {
      dir = pc.path.getDirectory(asset.getFileUrl());
    }
    data.name = asset.name;
    if (!data.parameters) {
      this._createParameters(data);
    }
    var pathMapping = data.mapping_format === "path";
    data.chunks = asset.resource.chunks;
    data.parameters.forEach(function(param, i) {
      var id;
      if (param.type === "texture") {
        if (!material._assetHandlers) {
          material._assetHandlers = {};
        }
        var handler = material._assetHandlers[param.name];
        if (param.data && !(param.data instanceof pc.Texture)) {
          if (pathMapping) {
            asset = assets.getByUrl(pc.path.join(dir, param.data));
          } else {
            id = param.data;
            asset = assets.get(param.data);
          }
          if (handler) {
            assets.off("load:" + handler.id, handler.bind);
            assets.off("add:" + handler.id, handler.add);
            assets.off("remove:" + handler.id, handler.remove);
            if (handler.url) {
              assets.off("add:url:" + handler.url, handler.add);
              assets.off("remove:url:" + handler.url, handler.remove);
            }
            material._assetHandlers[param.name] = null;
          }
          handler = material._assetHandlers[param.name] = {id:id, url:pathMapping ? pc.path.join(dir, param.data) : "", bind:function(asset) {
            data.parameters[i].data = asset.resource;
            material[data.parameters[i].name] = asset.resource;
            material.update();
          }, add:function(asset) {
            assets.load(asset);
          }, remove:function(asset) {
            if (material[data.parameters[i].name] === asset.resource) {
              data.parameters[i].data = null;
              material[data.parameters[i].name] = null;
              material.update();
            }
          }};
          if (id) {
            assets.on("load:" + id, handler.bind);
            assets.on("remove:" + id, handler.remove);
          } else {
            if (pathMapping) {
              assets.on("load:url:" + pc.path.join(dir, param.data), handler.bind);
              assets.on("remove:url:" + pc.path.join(dir, param.data), handler.remove);
            }
          }
          if (asset) {
            if (asset.resource) {
              handler.bind(asset);
            } else {
              if (placeholdersMapping[data.parameters[i].name]) {
                var texture = placeholders[placeholdersMapping[data.parameters[i].name]];
                if (texture) {
                  data.parameters[i].data = texture;
                  material[data.parameters[i].name] = texture;
                }
              }
            }
            assets.load(asset);
          } else {
            if (id) {
              assets.once("add:" + id, handler.add);
            } else {
              if (pathMapping) {
                assets.once("add:url:" + handler.url, handler.add);
              }
            }
          }
        } else {
          if (handler && !param.data) {
            assets.off("load:" + handler.id, handler.bind);
            assets.off("add:" + handler.id, handler.add);
            assets.off("remove:" + handler.id, handler.remove);
            if (handler.url) {
              assets.off("add:url:" + handler.url, handler.add);
              assets.off("remove:url:" + handler.url, handler.remove);
            }
            material._assetHandlers[param.name] = null;
          }
        }
      } else {
        if (param.type === "cubemap" && param.data && !(param.data instanceof pc.Texture)) {
          if (pathMapping) {
            asset = assets.getByUrl(pc.path.join(dir, param.data));
          } else {
            id = param.data;
            asset = assets.get(param.data);
          }
          var onAdd = function(asset) {
            if (data.shadingModel === pc.SPECULAR_PHONG) {
              asset.loadFaces = true;
            }
            asset.ready(onReady);
            assets.load(asset);
          };
          var onReady = function(asset) {
            param.data = asset.resource;
            if (asset.resources.length > 1) {
              data.parameters.push({name:"prefilteredCubeMap128", data:asset.resources[1]});
              data.parameters.push({name:"prefilteredCubeMap64", data:asset.resources[2]});
              data.parameters.push({name:"prefilteredCubeMap32", data:asset.resources[3]});
              data.parameters.push({name:"prefilteredCubeMap16", data:asset.resources[4]});
              data.parameters.push({name:"prefilteredCubeMap8", data:asset.resources[5]});
              data.parameters.push({name:"prefilteredCubeMap4", data:asset.resources[6]});
            }
            material.init(data);
            asset.off("load", onCubemapAssetLoad, material);
            asset.on("load", onCubemapAssetLoad, material);
          };
          if (asset) {
            onAdd(asset);
          } else {
            if (id) {
              assets.once("add:" + id, onAdd);
            } else {
              if (pathMapping) {
                assets.once("add:url:" + pc.path.join(dir, param.data), function(asset) {
                  asset.ready(function(asset) {
                    data.parameters[i].data = asset.resource;
                    material.init(data);
                    asset.off("load", onCubemapAssetLoad, material);
                    asset.on("load", onCubemapAssetLoad, material);
                  });
                  assets.load(asset);
                });
              }
            }
          }
        }
      }
    });
    material.init(data);
  }};
  return {MaterialHandler:MaterialHandler, getMaterialParamType:function(name) {
    return PARAMETER_TYPES[name];
  }};
}());
pc.extend(pc, function() {
  var ModelHandler = function(device) {
    this._device = device;
    this._parsers = [];
    this.addParser(new pc.JsonModelParser(this._device), function(url, data) {
      return pc.path.getExtension(url) === ".json";
    });
  };
  ModelHandler.DEFAULT_MATERIAL = pc.Scene.defaultMaterial;
  ModelHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!callback) {
        return;
      }
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading model: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    for (var i = 0;i < this._parsers.length;i++) {
      var p = this._parsers[i];
      if (p.decider(url, data)) {
        return p.parser.parse(data);
      }
    }
    logWARNING(pc.string.format("No model parser found for: {0}", url));
    return null;
  }, patch:function(asset, assets) {
    if (!asset.resource) {
      return;
    }
    var data = asset.data;
    asset.resource.meshInstances.forEach(function(meshInstance, i) {
      if (data.mapping) {
        var handleMaterial = function(asset) {
          if (asset.resource) {
            meshInstance.material = asset.resource;
          } else {
            asset.once("load", handleMaterial);
            assets.load(asset);
          }
          asset.once("remove", function(asset) {
            if (meshInstance.material === asset.resource) {
              meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
            }
          });
        };
        if (!data.mapping[i]) {
          meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
          return;
        }
        var id = data.mapping[i].material;
        var url = data.mapping[i].path;
        var material;
        if (id !== undefined) {
          if (!id) {
            meshInstance.material = pc.ModelHandler.DEFAULT_MATERIAL;
          } else {
            material = assets.get(id);
            if (material) {
              handleMaterial(material);
            } else {
              assets.once("add:" + id, handleMaterial);
            }
          }
        } else {
          if (url) {
            var fileUrl = asset.getFileUrl();
            var dirUrl = pc.path.getDirectory(fileUrl);
            var path = pc.path.join(dirUrl, data.mapping[i].path);
            material = assets.getByUrl(path);
            if (material) {
              handleMaterial(material);
            } else {
              assets.once("add:url:" + path, handleMaterial);
            }
          }
        }
      }
    });
  }, addParser:function(parser, decider) {
    this._parsers.push({parser:parser, decider:decider});
  }};
  return {ModelHandler:ModelHandler};
}());
pc.extend(pc, function() {
  var ScriptHandler = function(app) {
    this._app = app;
    this._scripts = {};
    this._cache = {};
  };
  ScriptHandler._types = [];
  ScriptHandler._push = function(Type) {
    if (pc.script.legacy && ScriptHandler._types.length > 0) {
      console.assert("Script Ordering Error. Contact support@playcanvas.com");
    } else {
      ScriptHandler._types.push(Type);
    }
  };
  ScriptHandler.prototype = {load:function(url, callback) {
    var self = this;
    pc.script.app = this._app;
    this._loadScript(url, function(err, url, extra) {
      if (!err) {
        if (pc.script.legacy) {
          var Type = null;
          if (ScriptHandler._types.length) {
            Type = ScriptHandler._types.pop();
          }
          if (Type) {
            this._scripts[url] = Type;
          } else {
            Type = null;
          }
          callback(null, Type, extra);
        } else {
          var obj = {};
          for (var i = 0;i < ScriptHandler._types.length;i++) {
            obj[ScriptHandler._types[i].name] = ScriptHandler._types[i];
          }
          ScriptHandler._types.length = 0;
          callback(null, obj, extra);
          delete self._loader._cache[url + "script"];
        }
      } else {
        callback(err);
      }
    }.bind(this));
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }, _loadScript:function(url, callback) {
    var head = document.head;
    var element = document.createElement("script");
    this._cache[url] = element;
    element.async = false;
    element.addEventListener("error", function(e) {
      callback(pc.string.format("Script: {0} failed to load", e.target.src));
    }, false);
    var done = false;
    element.onload = element.onreadystatechange = function() {
      if (!done && (!this.readyState || (this.readyState == "loaded" || this.readyState == "complete"))) {
        done = true;
        callback(null, url, element);
      }
    };
    element.src = url;
    head.appendChild(element);
  }};
  return {ScriptHandler:ScriptHandler};
}());
pc.extend(pc, function() {
  var TextHandler = function() {
  };
  TextHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading text resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  return {TextHandler:TextHandler};
}());
pc.extend(pc, function() {
  var BinaryHandler = function() {
  };
  BinaryHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, {responseType:pc.Http.ResponseType.ARRAY_BUFFER}, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading binary resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  return {BinaryHandler:BinaryHandler};
}());
pc.extend(pc, function() {
  var JSON_ADDRESS_MODE = {"repeat":pc.ADDRESS_REPEAT, "clamp":pc.ADDRESS_CLAMP_TO_EDGE, "mirror":pc.ADDRESS_MIRRORED_REPEAT};
  var JSON_FILTER_MODE = {"nearest":pc.FILTER_NEAREST, "linear":pc.FILTER_LINEAR, "nearest_mip_nearest":pc.FILTER_NEAREST_MIPMAP_NEAREST, "linear_mip_nearest":pc.FILTER_LINEAR_MIPMAP_NEAREST, "nearest_mip_linear":pc.FILTER_NEAREST_MIPMAP_LINEAR, "linear_mip_linear":pc.FILTER_LINEAR_MIPMAP_LINEAR};
  function arrayBufferCopy(src, dst, dstByteOffset, numBytes) {
    var i;
    var dst32Offset = dstByteOffset / 4;
    var tail = numBytes % 4;
    var src32 = new Uint32Array(src.buffer, 0, (numBytes - tail) / 4);
    var dst32 = new Uint32Array(dst.buffer);
    for (i = 0;i < src32.length;i++) {
      dst32[dst32Offset + i] = src32[i];
    }
    for (i = numBytes - tail;i < numBytes;i++) {
      dst[dstByteOffset + i] = src[i];
    }
  }
  var TextureHandler = function(device, assets, loader) {
    this._device = device;
    this._assets = assets;
    this._loader = loader;
    this.crossOrigin = undefined;
    if (assets.prefix) {
      this.crossOrigin = "anonymous";
    }
  };
  TextureHandler.prototype = {load:function(url, callback) {
    var self = this;
    var image;
    var urlWithoutParams = url.indexOf("?") >= 0 ? url.split("?")[0] : url;
    var ext = pc.path.getExtension(urlWithoutParams).toLowerCase();
    if (ext === ".dds" || ext === ".crn") {
      var options = {cache:true, responseType:"arraybuffer"};
      pc.http.get(url, options, function(err, response) {
        if (!err) {
          callback(null, response);
        } else {
          callback(err);
        }
      });
    } else {
      if (ext === ".jpg" || ext === ".jpeg" || ext === ".gif" || ext === ".png") {
        image = new Image;
        if (self.crossOrigin !== undefined && pc.ABSOLUTE_URL.test(url)) {
          image.crossOrigin = self.crossOrigin;
        }
        image.onload = function() {
          callback(null, image);
        };
        image.onerror = function(event) {
          callback(pc.string.format("Error loading Texture from: '{0}'", url));
        };
        image.src = url;
      } else {
        var blobStart = urlWithoutParams.indexOf("blob:");
        if (blobStart >= 0) {
          urlWithoutParams = urlWithoutParams.substr(blobStart);
          url = urlWithoutParams;
          image = new Image;
          image.onload = function() {
            callback(null, image);
          };
          image.onerror = function(event) {
            callback(pc.string.format("Error loading Texture from: '{0}'", url));
          };
          image.src = url;
        } else {
          setTimeout(function() {
            callback(pc.string.format("Error loading Texture: format not supported: '{0}'", ext));
          }, 0);
        }
      }
    }
  }, open:function(url, data) {
    if (!url) {
      return;
    }
    var self = this;
    var texture;
    var ext = pc.path.getExtension(url).toLowerCase();
    var format = null;
    if (data instanceof Image || data instanceof HTMLImageElement) {
      var img = data;
      format = ext === ".jpg" || ext === ".jpeg" ? pc.PIXELFORMAT_R8_G8_B8 : pc.PIXELFORMAT_R8_G8_B8_A8;
      texture = new pc.Texture(this._device, {width:img.width, height:img.height, format:format});
      texture.setSource(img);
    } else {
      if (data instanceof ArrayBuffer) {
        if (ext === ".crn") {
          var srcSize = data.byteLength;
          var bytes = new Uint8Array(data);
          var src = Module._malloc(srcSize);
          arrayBufferCopy(bytes, Module.HEAPU8, src, srcSize);
          var dst = Module._crn_decompress_get_data(src, srcSize);
          var dstSize = Module._crn_decompress_get_size(src, srcSize);
          data = Module.HEAPU8.buffer.slice(dst, dst + dstSize);
        }
        var header = new Uint32Array(data, 0, 128 / 4);
        var width = header[4];
        var height = header[3];
        var mips = Math.max(header[7], 1);
        var isFourCc = header[20] === 4;
        var fcc = header[21];
        var bpp = header[22];
        var isCubemap = header[28] === 65024;
        var FCC_DXT1 = 827611204;
        var FCC_DXT5 = 894720068;
        var FCC_FP32 = 116;
        var FCC_ETC1 = 826496069;
        var FCC_PVRTC_2BPP_RGB_1 = 825438800;
        var FCC_PVRTC_2BPP_RGBA_1 = 825504336;
        var FCC_PVRTC_4BPP_RGB_1 = 825439312;
        var FCC_PVRTC_4BPP_RGBA_1 = 825504848;
        var compressed = false;
        var floating = false;
        var etc1 = false;
        var pvrtc2 = false;
        var pvrtc4 = false;
        if (isFourCc) {
          if (fcc === FCC_DXT1) {
            format = pc.PIXELFORMAT_DXT1;
            compressed = true;
          } else {
            if (fcc === FCC_DXT5) {
              format = pc.PIXELFORMAT_DXT5;
              compressed = true;
            } else {
              if (fcc === FCC_FP32) {
                format = pc.PIXELFORMAT_RGBA32F;
                floating = true;
              } else {
                if (fcc === FCC_ETC1) {
                  format = pc.PIXELFORMAT_ETC1;
                  compressed = true;
                  etc1 = true;
                } else {
                  if (fcc === FCC_PVRTC_2BPP_RGB_1 || fcc === FCC_PVRTC_2BPP_RGBA_1) {
                    format = fcc === FCC_PVRTC_2BPP_RGB_1 ? pc.PIXELFORMAT_PVRTC_2BPP_RGB_1 : pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1;
                    compressed = true;
                    pvrtc2 = true;
                  } else {
                    if (fcc === FCC_PVRTC_4BPP_RGB_1 || fcc === FCC_PVRTC_4BPP_RGBA_1) {
                      format = fcc === FCC_PVRTC_4BPP_RGB_1 ? pc.PIXELFORMAT_PVRTC_4BPP_RGB_1 : pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1;
                      compressed = true;
                      pvrtc4 = true;
                    }
                  }
                }
              }
            }
          }
        } else {
          if (bpp === 32) {
            format = pc.PIXELFORMAT_R8_G8_B8_A8;
          }
        }
        if (!format) {
          texture = new pc.Texture(this._device, {width:4, height:4, format:pc.PIXELFORMAT_R8_G8_B8});
          return texture;
        }
        var texOptions = {width:width, height:height, format:format, cubemap:isCubemap};
        texture = new pc.Texture(this._device, texOptions);
        if (isCubemap) {
          texture.addressU = pc.ADDRESS_CLAMP_TO_EDGE;
          texture.addressV = pc.ADDRESS_CLAMP_TO_EDGE;
        }
        var offset = 128;
        var faces = isCubemap ? 6 : 1;
        var mipSize;
        var DXT_BLOCK_WIDTH = 4;
        var DXT_BLOCK_HEIGHT = 4;
        var blockSize = fcc === FCC_DXT1 ? 8 : 16;
        var numBlocksAcross, numBlocksDown, numBlocks;
        for (var face = 0;face < faces;face++) {
          var mipWidth = width;
          var mipHeight = height;
          for (var i = 0;i < mips;i++) {
            if (compressed) {
              if (etc1) {
                mipSize = Math.floor((mipWidth + 3) / 4) * Math.floor((mipHeight + 3) / 4) * 8;
              } else {
                if (pvrtc2) {
                  mipSize = Math.max(mipWidth, 16) * Math.max(mipHeight, 8) / 4;
                } else {
                  if (pvrtc4) {
                    mipSize = Math.max(mipWidth, 8) * Math.max(mipHeight, 8) / 2;
                  } else {
                    numBlocksAcross = Math.floor((mipWidth + DXT_BLOCK_WIDTH - 1) / DXT_BLOCK_WIDTH);
                    numBlocksDown = Math.floor((mipHeight + DXT_BLOCK_HEIGHT - 1) / DXT_BLOCK_HEIGHT);
                    numBlocks = numBlocksAcross * numBlocksDown;
                    mipSize = numBlocks * blockSize;
                  }
                }
              }
            } else {
              mipSize = mipWidth * mipHeight * 4;
            }
            var mipBuff = floating ? new Float32Array(data, offset, mipSize) : new Uint8Array(data, offset, mipSize);
            if (!isCubemap) {
              texture._levels[i] = mipBuff;
            } else {
              if (!texture._levels[i]) {
                texture._levels[i] = [];
              }
              texture._levels[i][face] = mipBuff;
            }
            offset += floating ? mipSize * 4 : mipSize;
            mipWidth = Math.max(mipWidth * 0.5, 1);
            mipHeight = Math.max(mipHeight * 0.5, 1);
          }
        }
        texture.upload();
      }
    }
    return texture;
  }, patch:function(asset, assets) {
    var texture = asset.resource;
    if (!texture) {
      return;
    }
    if (texture.name !== asset.name) {
      texture.name = asset.name;
    }
    if (asset.data.hasOwnProperty("minfilter") && texture.minFilter !== JSON_FILTER_MODE[asset.data.minfilter]) {
      texture.minFilter = JSON_FILTER_MODE[asset.data.minfilter];
    }
    if (asset.data.hasOwnProperty("magfilter") && texture.magFilter !== JSON_FILTER_MODE[asset.data.magfilter]) {
      texture.magFilter = JSON_FILTER_MODE[asset.data.magfilter];
    }
    if (asset.data.hasOwnProperty("addressu") && texture.addressU !== JSON_ADDRESS_MODE[asset.data.addressu]) {
      texture.addressU = JSON_ADDRESS_MODE[asset.data.addressu];
    }
    if (asset.data.hasOwnProperty("addressv") && texture.addressV !== JSON_ADDRESS_MODE[asset.data.addressv]) {
      texture.addressV = JSON_ADDRESS_MODE[asset.data.addressv];
    }
    if (asset.data.hasOwnProperty("mipmaps") && texture.mipmaps !== asset.data.mipmaps) {
      texture.mipmaps = asset.data.mipmaps;
    }
    if (asset.data.hasOwnProperty("anisotropy") && texture.anisotropy !== asset.data.anisotropy) {
      texture.anisotropy = asset.data.anisotropy;
    }
    var rgbm = !!asset.data.rgbm;
    if (asset.data.hasOwnProperty("rgbm") && texture.rgbm !== rgbm) {
      texture.rgbm = rgbm;
    }
  }};
  return {TextureHandler:TextureHandler};
}());
pc.extend(pc, function() {
  var HtmlHandler = function() {
  };
  HtmlHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading html resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  return {HtmlHandler:HtmlHandler};
}());
pc.extend(pc, function() {
  var CssHandler = function() {
  };
  CssHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading css resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  var createStyle = function(cssString) {
    var result = document.createElement("style");
    result.type = "text/css";
    if (result.styleSheet) {
      result.styleSheet.cssText = cssString;
    } else {
      result.appendChild(document.createTextNode(cssString));
    }
    return result;
  };
  return {CssHandler:CssHandler, createStyle:createStyle};
}());
pc.extend(pc, function() {
  var ShaderHandler = function() {
  };
  ShaderHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback(pc.string.format("Error loading shader resource: {0} [{1}]", url, err));
      }
    });
  }, open:function(url, data) {
    return data;
  }, patch:function(asset, assets) {
  }};
  return {ShaderHandler:ShaderHandler};
}());
pc.extend(pc, function() {
  var SceneHandler = function(app) {
    this._app = app;
  };
  SceneHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback("Error requesting scene: " + url);
      }
    });
  }, open:function(url, data) {
    this._app.systems.script.preloading = true;
    var parser = new pc.SceneParser(this._app);
    var parent = parser.parse(data);
    var scene = this._app.scene;
    scene.root = parent;
    this._app.applySceneSettings(data.settings);
    this._app.systems.script.preloading = false;
    return scene;
  }, patch:function(asset, assets) {
  }};
  return {SceneHandler:SceneHandler};
}());
pc.extend(pc, function() {
  var HierarchyHandler = function(app) {
    this._app = app;
  };
  HierarchyHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback("Error requesting scene: " + url);
      }
    });
  }, open:function(url, data) {
    this._app.systems.script.preloading = true;
    var parser = new pc.SceneParser(this._app);
    var parent = parser.parse(data);
    this._app.systems.script.preloading = false;
    return parent;
  }};
  return {HierarchyHandler:HierarchyHandler};
}());
pc.extend(pc, function() {
  var SceneSettingsHandler = function(app) {
    this._app = app;
  };
  SceneSettingsHandler.prototype = {load:function(url, callback) {
    pc.http.get(url, function(err, response) {
      if (!err) {
        callback(null, response);
      } else {
        callback("Error requesting scene: " + url);
      }
    });
  }, open:function(url, data) {
    return data.settings;
  }};
  return {SceneSettingsHandler:SceneSettingsHandler};
}());
pc.extend(pc, function() {
  var FolderHandler = function() {
  };
  FolderHandler.prototype = {load:function(url, callback) {
    callback(null, null);
  }, open:function(url, data) {
    return data;
  }};
  return {FolderHandler:FolderHandler};
}());
pc.extend(pc, function() {
  var FontHandler = function(loader) {
    this._loader = loader;
  };
  FontHandler.prototype = {load:function(url, callback, asset) {
    var self = this;
    if (pc.path.getExtension(url) === ".json") {
      pc.http.get(url, function(err, response) {
        if (!err) {
          self._loadTextures(url.replace(".json", ".png"), response, function(err, textures) {
            if (err) {
              return callback(err);
            }
            callback(null, {data:response, textures:textures});
          });
        } else {
          callback(pc.string.format("Error loading font resource: {0} [{1}]", url, err));
        }
      });
    } else {
      this._loadTextures(url, asset && asset.data, callback);
    }
  }, _loadTextures:function(url, data, callback) {
    var numTextures = 1;
    var numLoaded = 0;
    var error = null;
    if (data && data.version >= 2) {
      numTextures = data.info.maps.length;
    }
    var textures = new Array(numTextures);
    var loader = this._loader;
    var loadTexture = function(index) {
      var onLoaded = function(err, texture) {
        if (error) {
          return;
        }
        if (err) {
          error = err;
          return callback(err);
        }
        texture.upload();
        textures[index] = texture;
        numLoaded++;
        if (numLoaded === numTextures) {
          callback(null, textures);
        }
      };
      if (index === 0) {
        loader.load(url, "texture", onLoaded);
      } else {
        loader.load(url.replace(".png", index + ".png"), "texture", onLoaded);
      }
    };
    for (var i = 0;i < numTextures;i++) {
      loadTexture(i);
    }
  }, open:function(url, data, asset) {
    var font;
    if (data.textures) {
      font = new pc.Font(data.textures, data.data);
    } else {
      font = new pc.Font(data, null);
    }
    return font;
  }, patch:function(asset, assets) {
    var font = asset.resource;
    if (!font.data && asset.data) {
      font.data = asset.data;
    } else {
      if (!asset.data && font.data) {
        asset.data = font.data;
      }
    }
  }};
  return {FontHandler:FontHandler};
}());
pc.extend(pc, function() {
  var JSON_PRIMITIVE_TYPE = {"points":pc.PRIMITIVE_POINTS, "lines":pc.PRIMITIVE_LINES, "lineloop":pc.PRIMITIVE_LINELOOP, "linestrip":pc.PRIMITIVE_LINESTRIP, "triangles":pc.PRIMITIVE_TRIANGLES, "trianglestrip":pc.PRIMITIVE_TRISTRIP, "trianglefan":pc.PRIMITIVE_TRIFAN};
  var JSON_VERTEX_ELEMENT_TYPE = {"int8":pc.TYPE_INT8, "uint8":pc.TYPE_UINT8, "int16":pc.TYPE_INT16, "uint16":pc.TYPE_UINT16, "int32":pc.TYPE_INT32, "uint32":pc.TYPE_UINT32, "float32":pc.TYPE_FLOAT32};
  var JsonModelParser = function(device) {
    this._device = device;
  };
  JsonModelParser.prototype = {parse:function(data) {
    var modelData = data.model;
    if (!modelData) {
      return null;
    }
    if (modelData.version <= 1) {
      logERROR(pc.string.format("Trying to parse unsupported model format."));
      return null;
    }
    var nodes = this._parseNodes(data);
    var skins = this._parseSkins(data, nodes);
    var morphs = this._parseMorphs(data, nodes);
    var vertexBuffers = this._parseVertexBuffers(data);
    var indices = this._parseIndexBuffers(data, vertexBuffers);
    var meshes = this._parseMeshes(data, skins.skins, morphs.morphs, vertexBuffers, indices.buffer, indices.data);
    this._initMorphs(data, morphs.morphs, vertexBuffers, meshes);
    var meshInstances = this._parseMeshInstances(data, nodes, meshes, skins.skins, skins.instances, morphs.morphs, morphs.instances);
    var model = new pc.Model;
    model.graph = nodes[0];
    model.meshInstances = meshInstances;
    model.skinInstances = skins.instances;
    model.morphInstances = morphs.instances;
    model.getGraph().syncHierarchy();
    return model;
  }, _parseNodes:function(data) {
    var modelData = data.model;
    var nodes = [];
    var i;
    for (i = 0;i < modelData.nodes.length;i++) {
      var nodeData = modelData.nodes[i];
      var node = new pc.GraphNode;
      node.setName(nodeData.name);
      node.setLocalPosition(nodeData.position[0], nodeData.position[1], nodeData.position[2]);
      node.setLocalEulerAngles(nodeData.rotation[0], nodeData.rotation[1], nodeData.rotation[2]);
      node.setLocalScale(nodeData.scale[0], nodeData.scale[1], nodeData.scale[2]);
      node.scaleCompensation = !!nodeData.scaleCompensation;
      nodes.push(node);
    }
    for (i = 1;i < modelData.parents.length;i++) {
      nodes[modelData.parents[i]].addChild(nodes[i]);
    }
    return nodes;
  }, _parseSkins:function(data, nodes) {
    var modelData = data.model;
    var skins = [];
    var skinInstances = [];
    var i, j;
    if (!this._device.supportsBoneTextures && modelData.skins.length > 0) {
      var boneLimit = this._device.getBoneLimit();
      pc.partitionSkin(modelData, null, boneLimit);
    }
    for (i = 0;i < modelData.skins.length;i++) {
      var skinData = modelData.skins[i];
      var inverseBindMatrices = [];
      for (j = 0;j < skinData.inverseBindMatrices.length;j++) {
        var ibm = skinData.inverseBindMatrices[j];
        inverseBindMatrices[j] = new pc.Mat4(ibm[0], ibm[1], ibm[2], ibm[3], ibm[4], ibm[5], ibm[6], ibm[7], ibm[8], ibm[9], ibm[10], ibm[11], ibm[12], ibm[13], ibm[14], ibm[15]);
      }
      var skin = new pc.Skin(this._device, inverseBindMatrices, skinData.boneNames);
      skins.push(skin);
      var skinInstance = new pc.SkinInstance(skin, nodes[0]);
      var bones = [];
      for (j = 0;j < skin.boneNames.length;j++) {
        var boneName = skin.boneNames[j];
        var bone = nodes[0].findByName(boneName);
        bones.push(bone);
      }
      skinInstance.bones = bones;
      skinInstances.push(skinInstance);
    }
    return {skins:skins, instances:skinInstances};
  }, _parseMorphs:function(data, nodes) {
    var modelData = data.model;
    var morphs = [];
    var morphInstances = [];
    var i, j, k;
    var targets, morphTarget, morphTargetArray;
    if (modelData.morphs) {
      for (i = 0;i < modelData.morphs.length;i++) {
        targets = modelData.morphs[i].targets;
        morphTargetArray = [];
        for (j = 0;j < targets.length;j++) {
          var targetAabb = targets[j].aabb;
          var min = targetAabb.min;
          var max = targetAabb.max;
          var aabb = new pc.BoundingBox(new pc.Vec3((max[0] + min[0]) * 0.5, (max[1] + min[1]) * 0.5, (max[2] + min[2]) * 0.5), new pc.Vec3((max[0] - min[0]) * 0.5, (max[1] - min[1]) * 0.5, (max[2] - min[2]) * 0.5));
          morphTarget = new pc.MorphTarget({indices:targets[j].indices, deltaPositions:targets[j].deltaPositions, deltaNormals:targets[j].deltaNormals, name:targets[j].name, aabb:aabb});
          morphTargetArray.push(morphTarget);
        }
        var morph = new pc.Morph(morphTargetArray);
        morphs.push(morph);
        var morphInstance = new pc.MorphInstance(morph);
        morphInstances.push(morphInstance);
      }
    }
    return {morphs:morphs, instances:morphInstances};
  }, _calculateTangentsMorphTarget:function(positions, normals, uvs, indices, tan1, tan2, mtIndices, tangents) {
    var sdirx, sdiry, sdirz;
    var tdirx, tdiry, tdirz;
    var v1x, v1y, v1z;
    var v2x, v2y, v2z;
    var v3x, v3y, v3z;
    var w1x, w1y;
    var w2x, w2y;
    var w3x, w3y;
    var t1x, t1y, t1z;
    var t2x, t2y, t2z;
    var nx, ny, nz;
    var triangleCount;
    var vertexCount;
    var i1, i2, i3;
    var x1, x2, y1, y2, z1, z2, s1, s2, t1, t2, r;
    var i, j;
    var area, ndott, mtIndexCount, len;
    triangleCount = indices.length / 3;
    vertexCount = positions.length / 3;
    area = 0.0;
    for (i = 0;i < triangleCount;i++) {
      i1 = indices[i * 3];
      i2 = indices[i * 3 + 1];
      i3 = indices[i * 3 + 2];
      v1x = positions[i1 * 3];
      v1y = positions[i1 * 3 + 1];
      v1z = positions[i1 * 3 + 2];
      v2x = positions[i2 * 3];
      v2y = positions[i2 * 3 + 1];
      v2z = positions[i2 * 3 + 2];
      v3x = positions[i3 * 3];
      v3y = positions[i3 * 3 + 1];
      v3z = positions[i3 * 3 + 2];
      w1x = uvs[i1 * 2];
      w1y = uvs[i1 * 2 + 1];
      w2x = uvs[i2 * 2];
      w2y = uvs[i2 * 2 + 1];
      w3x = uvs[i3 * 2];
      w3y = uvs[i3 * 2 + 1];
      x1 = v2x - v1x;
      x2 = v3x - v1x;
      y1 = v2y - v1y;
      y2 = v3y - v1y;
      z1 = v2z - v1z;
      z2 = v3z - v1z;
      s1 = w2x - w1x;
      s2 = w3x - w1x;
      t1 = w2y - w1y;
      t2 = w3y - w1y;
      area = s1 * t2 - s2 * t1;
      if (area == 0.0) {
        sdirx = 0;
        sdiry = 1;
        sdirz = 0;
        tdirx = 1;
        tdiry = 0;
        tdirz = 0;
      } else {
        r = 1.0 / area;
        sdirx = (t2 * x1 - t1 * x2) * r;
        sdiry = (t2 * y1 - t1 * y2) * r;
        sdirz = (t2 * z1 - t1 * z2) * r;
        tdirx = (s1 * x2 - s2 * x1) * r;
        tdiry = (s1 * y2 - s2 * y1) * r;
        tdirz = (s1 * z2 - s2 * z1) * r;
      }
      tan1[i1 * 3 + 0] += sdirx;
      tan1[i1 * 3 + 1] += sdiry;
      tan1[i1 * 3 + 2] += sdirz;
      tan1[i2 * 3 + 0] += sdirx;
      tan1[i2 * 3 + 1] += sdiry;
      tan1[i2 * 3 + 2] += sdirz;
      tan1[i3 * 3 + 0] += sdirx;
      tan1[i3 * 3 + 1] += sdiry;
      tan1[i3 * 3 + 2] += sdirz;
      tan2[i1 * 3 + 0] += tdirx;
      tan2[i1 * 3 + 1] += tdiry;
      tan2[i1 * 3 + 2] += tdirz;
      tan2[i2 * 3 + 0] += tdirx;
      tan2[i2 * 3 + 1] += tdiry;
      tan2[i2 * 3 + 2] += tdirz;
      tan2[i3 * 3 + 0] += tdirx;
      tan2[i3 * 3 + 1] += tdiry;
      tan2[i3 * 3 + 2] += tdirz;
    }
    mtIndexCount = mtIndices.length;
    for (j = 0;j < mtIndexCount;j++) {
      i = mtIndices[j];
      nx = normals[i * 3];
      ny = normals[i * 3 + 1];
      nz = normals[i * 3 + 2];
      t1x = tan1[i * 3];
      t1y = tan1[i * 3 + 1];
      t1z = tan1[i * 3 + 2];
      t2x = tan2[i * 3];
      t2y = tan2[i * 3 + 1];
      t2z = tan2[i * 3 + 2];
      ndott = nx * t1x + ny * t1y + nz * t1z;
      v1x = nx * ndott;
      v1y = ny * ndott;
      v1z = nz * ndott;
      v2x = ny * t1z - t1y * nz;
      v2y = nz * t1x - t1z * nx;
      v2z = nx * t1y - t1x * ny;
      t1x -= v1x;
      t1y -= v1y;
      t1z -= v1z;
      len = 1.0 / Math.sqrt(t1x * t1x + t1y * t1y + t1z * t1z);
      t1x *= len;
      t1y *= len;
      t1z *= len;
      tangents[i * 4] = t1x;
      tangents[i * 4 + 1] = t1y;
      tangents[i * 4 + 2] = t1z;
      tangents[i * 4 + 3] = v2x * t2x + v2y * t2y + v2z * t2z < 0.0 ? -1.0 : 1.0;
    }
    return tangents;
  }, _initMorphs:function(data, morphs, vertexBuffers, meshes) {
    var modelData = data.model;
    var i, j;
    var target, k, l, index;
    var triA, triB, triC;
    var flagged;
    var basePos;
    var baseNorm;
    var baseUv;
    var numVerts;
    var numIndices;
    var tpos, tnorm;
    var vertexData;
    var mtTriIndices = [];
    var processed = [];
    var vid;
    for (i = 0;i < meshes.length;i++) {
      vid = modelData.meshes[i].vertices;
      if (processed[vid]) {
        continue;
      }
      vertexData = modelData.vertices[vid];
      if (!vertexData.tangent) {
        continue;
      }
      var tangents = new Float32Array(vertexData.tangent.data);
      processed[vid] = true;
      if (vertexData.position && vertexData.normal && vertexData.texCoord0) {
        var indices = [];
        for (j = 0;j < modelData.meshes.length;j++) {
          if (modelData.meshes[j].vertices === vid) {
            indices = indices.concat(modelData.meshes[j].indices);
          }
        }
        basePos = vertexData.position.data;
        baseNorm = vertexData.normal.data;
        baseUv = vertexData.texCoord0.data;
        numVerts = basePos.length / 3;
        numIndices = indices.length;
        var targetTangents = new Float32Array(numVerts * 4);
        var tan1 = new Float32Array(numVerts * 3);
        var tan2 = new Float32Array(numVerts * 3);
        tpos = new Float32Array(numVerts * 3);
        tpos.set(basePos);
        tnorm = new Float32Array(numVerts * 3);
        tnorm.set(baseNorm);
        for (j = 0;j < morphs.length;j++) {
          if (modelData.meshes[i].morph !== j) {
            continue;
          }
          for (k = 0;k < morphs[j]._targets.length;k++) {
            target = morphs[j]._targets[k];
            var mtIndices = target.indices;
            var numMtIndices = mtIndices.length;
            if (numMtIndices === 0) {
              continue;
            }
            target.deltaTangents = new Float32Array(numMtIndices * 4);
            if (!flagged || flagged.length < numVerts) {
              flagged = new Uint8Array(numVerts);
            } else {
              for (l = 0;l > numVerts;l++) {
                flagged[l] = 0;
              }
            }
            for (l = 0;l < numMtIndices;l++) {
              index = mtIndices[l];
              flagged[index] = 1;
            }
            var numMtTriIndices = 0;
            for (l = 0;l < numIndices;l += 3) {
              triA = indices[l];
              triB = indices[l + 1];
              triC = indices[l + 2];
              if (flagged[triA] || flagged[triB] || flagged[triC]) {
                mtTriIndices[numMtTriIndices] = triA;
                mtTriIndices[numMtTriIndices + 1] = triB;
                mtTriIndices[numMtTriIndices + 2] = triC;
                numMtTriIndices += 3;
              }
            }
            mtTriIndices.length = numMtTriIndices;
            var deltaPos = target.deltaPositions;
            var deltaNorm = target.deltaNormals;
            for (l = 0;l < numMtIndices;l++) {
              index = mtIndices[l];
              tpos[index * 3] += deltaPos[l * 3];
              tpos[index * 3 + 1] += deltaPos[l * 3 + 1];
              tpos[index * 3 + 2] += deltaPos[l * 3 + 2];
              tnorm[index * 3] += deltaNorm[l * 3];
              tnorm[index * 3 + 1] += deltaNorm[l * 3 + 1];
              tnorm[index * 3 + 2] += deltaNorm[l * 3 + 2];
            }
            this._calculateTangentsMorphTarget(tpos, tnorm, baseUv, mtTriIndices, tan1, tan2, mtIndices, targetTangents);
            var deltaTangents = target.deltaTangents;
            for (l = 0;l < numMtIndices;l++) {
              index = mtIndices[l];
              deltaTangents[l * 4] = targetTangents[l * 4] - tangents[index * 4];
              deltaTangents[l * 4 + 1] = targetTangents[l * 4 + 1] - tangents[index * 4 + 1];
              deltaTangents[l * 4 + 2] = targetTangents[l * 4 + 2] - tangents[index * 4 + 2];
              deltaTangents[l * 4 + 3] = targetTangents[l * 4 + 3] - tangents[index * 4 + 3];
            }
            if (k === morphs[j]._targets.length - 1) {
              continue;
            }
            for (l = 0;l < numIndices;l += 3) {
              triA = indices[l];
              triB = indices[l + 1];
              triC = indices[l + 2];
              tan1[triA * 3 + 0] = 0;
              tan1[triA * 3 + 1] = 0;
              tan1[triA * 3 + 2] = 0;
              tan1[triB * 3 + 0] = 0;
              tan1[triB * 3 + 1] = 0;
              tan1[triB * 3 + 2] = 0;
              tan1[triC * 3 + 0] = 0;
              tan1[triC * 3 + 1] = 0;
              tan1[triC * 3 + 2] = 0;
              tan2[triA * 3 + 0] = 0;
              tan2[triA * 3 + 1] = 0;
              tan2[triA * 3 + 2] = 0;
              tan2[triB * 3 + 0] = 0;
              tan2[triB * 3 + 1] = 0;
              tan2[triB * 3 + 2] = 0;
              tan2[triC * 3 + 0] = 0;
              tan2[triC * 3 + 1] = 0;
              tan2[triC * 3 + 2] = 0;
            }
            for (l = 0;l < numMtIndices;l++) {
              index = target.indices[l];
              tpos[index * 3] = basePos[index * 3];
              tpos[index * 3 + 1] = basePos[index * 3 + 1];
              tpos[index * 3 + 2] = basePos[index * 3 + 2];
              tnorm[index * 3] = baseNorm[index * 3];
              tnorm[index * 3 + 1] = baseNorm[index * 3 + 1];
              tnorm[index * 3 + 2] = baseNorm[index * 3 + 2];
            }
          }
        }
      }
    }
  }, _parseVertexBuffers:function(data) {
    var modelData = data.model;
    var vertexBuffers = [];
    var attribute, attributeName;
    var attributeMap = {position:pc.SEMANTIC_POSITION, normal:pc.SEMANTIC_NORMAL, tangent:pc.SEMANTIC_TANGENT, blendWeight:pc.SEMANTIC_BLENDWEIGHT, blendIndices:pc.SEMANTIC_BLENDINDICES, color:pc.SEMANTIC_COLOR, texCoord0:pc.SEMANTIC_TEXCOORD0, texCoord1:pc.SEMANTIC_TEXCOORD1, texCoord2:pc.SEMANTIC_TEXCOORD2, texCoord3:pc.SEMANTIC_TEXCOORD3, texCoord4:pc.SEMANTIC_TEXCOORD4, texCoord5:pc.SEMANTIC_TEXCOORD5, texCoord6:pc.SEMANTIC_TEXCOORD6, texCoord7:pc.SEMANTIC_TEXCOORD7};
    var i, j;
    for (i = 0;i < modelData.vertices.length;i++) {
      var vertexData = modelData.vertices[i];
      if (vertexData.position && vertexData.normal && vertexData.texCoord0) {
        var indices = [];
        for (j = 0;j < modelData.meshes.length;j++) {
          if (modelData.meshes[j].vertices === i) {
            indices = indices.concat(modelData.meshes[j].indices);
          }
        }
        var tangents = pc.calculateTangents(vertexData.position.data, vertexData.normal.data, vertexData.texCoord0.data, indices);
        vertexData.tangent = {type:"float32", components:4, data:tangents};
      }
      var formatDesc = [];
      for (attributeName in vertexData) {
        attribute = vertexData[attributeName];
        var attribType = attribute.type;
        if (!this._device.supportsUnsignedByte) {
          if (attribType === "uint8") {
            attribType = "float32";
          }
          if (attribType === "int8") {
            attribType = "float32";
          }
        }
        formatDesc.push({semantic:attributeMap[attributeName], components:attribute.components, type:JSON_VERTEX_ELEMENT_TYPE[attribType], normalize:attributeMap[attributeName] === pc.SEMANTIC_COLOR});
      }
      var vertexFormat = new pc.VertexFormat(this._device, formatDesc);
      var numVertices = vertexData.position.data.length / vertexData.position.components;
      var vertexBuffer = new pc.VertexBuffer(this._device, vertexFormat, numVertices);
      var iterator = new pc.VertexIterator(vertexBuffer);
      for (j = 0;j < numVertices;j++) {
        for (attributeName in vertexData) {
          attribute = vertexData[attributeName];
          switch(attribute.components) {
            case 1:
              iterator.element[attributeMap[attributeName]].set(attribute.data[j]);
              break;
            case 2:
              iterator.element[attributeMap[attributeName]].set(attribute.data[j * 2], attribute.data[j * 2 + 1]);
              break;
            case 3:
              iterator.element[attributeMap[attributeName]].set(attribute.data[j * 3], attribute.data[j * 3 + 1], attribute.data[j * 3 + 2]);
              break;
            case 4:
              iterator.element[attributeMap[attributeName]].set(attribute.data[j * 4], attribute.data[j * 4 + 1], attribute.data[j * 4 + 2], attribute.data[j * 4 + 3]);
              break;
          }
        }
        iterator.next();
      }
      iterator.end();
      vertexBuffers.push(vertexBuffer);
    }
    return vertexBuffers;
  }, _parseIndexBuffers:function(data, vertexBuffers) {
    var modelData = data.model;
    var indexBuffer = null;
    var indexData = null;
    var i;
    var numIndices = 0;
    for (i = 0;i < modelData.meshes.length;i++) {
      var meshData = modelData.meshes[i];
      if (meshData.indices !== undefined) {
        numIndices += meshData.indices.length;
      }
    }
    var maxVerts = 0;
    for (i = 0;i < vertexBuffers.length;i++) {
      maxVerts = Math.max(maxVerts, vertexBuffers[i].numVertices);
    }
    if (numIndices > 0) {
      if (maxVerts > 65535 && this._device.extUintElement) {
        indexBuffer = new pc.IndexBuffer(this._device, pc.INDEXFORMAT_UINT32, numIndices);
        indexData = new Uint32Array(indexBuffer.lock());
      } else {
        indexBuffer = new pc.IndexBuffer(this._device, pc.INDEXFORMAT_UINT16, numIndices);
        indexData = new Uint16Array(indexBuffer.lock());
      }
    }
    return {buffer:indexBuffer, data:indexData};
  }, _parseMeshes:function(data, skins, morphs, vertexBuffers, indexBuffer, indexData) {
    var modelData = data.model;
    var meshes = [];
    var indexBase = 0;
    var i;
    for (i = 0;i < modelData.meshes.length;i++) {
      var meshData = modelData.meshes[i];
      var meshAabb = meshData.aabb;
      var min = meshAabb.min;
      var max = meshAabb.max;
      var aabb = new pc.BoundingBox(new pc.Vec3((max[0] + min[0]) * 0.5, (max[1] + min[1]) * 0.5, (max[2] + min[2]) * 0.5), new pc.Vec3((max[0] - min[0]) * 0.5, (max[1] - min[1]) * 0.5, (max[2] - min[2]) * 0.5));
      var indexed = meshData.indices !== undefined;
      var mesh = new pc.Mesh;
      mesh.vertexBuffer = vertexBuffers[meshData.vertices];
      mesh.indexBuffer[0] = indexed ? indexBuffer : null;
      mesh.primitive[0].type = JSON_PRIMITIVE_TYPE[meshData.type];
      mesh.primitive[0].base = indexed ? meshData.base + indexBase : meshData.base;
      mesh.primitive[0].count = meshData.count;
      mesh.primitive[0].indexed = indexed;
      mesh.skin = meshData.skin !== undefined ? skins[meshData.skin] : null;
      mesh.morph = meshData.morph !== undefined ? morphs[meshData.morph] : null;
      mesh.aabb = aabb;
      if (indexed) {
        indexData.set(meshData.indices, indexBase);
        indexBase += meshData.indices.length;
      }
      meshes.push(mesh);
    }
    if (indexBuffer !== null) {
      indexBuffer.unlock();
    }
    return meshes;
  }, _parseMeshInstances:function(data, nodes, meshes, skins, skinInstances, morphs, morphInstances) {
    var modelData = data.model;
    var meshInstances = [];
    var i;
    for (i = 0;i < modelData.meshInstances.length;i++) {
      var meshInstanceData = modelData.meshInstances[i];
      var node = nodes[meshInstanceData.node];
      var mesh = meshes[meshInstanceData.mesh];
      var meshInstance = new pc.MeshInstance(node, mesh, pc.ModelHandler.DEFAULT_MATERIAL);
      if (mesh.skin) {
        var skinIndex = skins.indexOf(mesh.skin);
        meshInstance.skinInstance = skinInstances[skinIndex];
      }
      if (mesh.morph) {
        var morphIndex = morphs.indexOf(mesh.morph);
        meshInstance.morphInstance = morphInstances[morphIndex];
      }
      meshInstances.push(meshInstance);
    }
    return meshInstances;
  }};
  return {JsonModelParser:JsonModelParser};
}());
pc.extend(pc, function() {
  var SceneParser = function(app) {
    this._app = app;
  };
  SceneParser.prototype = {parse:function(data) {
    var entities = {};
    var id, i;
    var parent = null;
    for (id in data.entities) {
      entities[id] = this._createEntity(data.entities[id]);
      if (data.entities[id].parent === null) {
        parent = entities[id];
      }
    }
    for (id in data.entities) {
      var entity = entities[id];
      var l = data.entities[id].children.length;
      for (i = 0;i < l;i++) {
        var resource_id = data.entities[id].children[i];
        if (entities[resource_id]) {
          entities[id].addChild(entities[resource_id]);
        }
      }
    }
    this._openComponentData(parent, data.entities);
    return parent;
  }, _createEntity:function(data) {
    var entity = new pc.Entity;
    var p = data.position;
    var r = data.rotation;
    var s = data.scale;
    entity.name = data.name;
    entity._guid = data.resource_id;
    entity.setLocalPosition(p[0], p[1], p[2]);
    entity.setLocalEulerAngles(r[0], r[1], r[2]);
    entity.setLocalScale(s[0], s[1], s[2]);
    entity._enabled = data.enabled !== undefined ? data.enabled : true;
    entity._enabledInHierarchy = entity._enabled;
    entity.template = data.template;
    if (data.tags) {
      for (var i = 0;i < data.tags.length;i++) {
        entity.tags.add(data.tags[i]);
      }
    }
    if (data.labels) {
      data.labels.forEach(function(label) {
        entity.addLabel(label);
      });
    }
    return entity;
  }, _openComponentData:function(entity, entities) {
    var systems = this._app.systems.list();
    var i, len = systems.length;
    var edata = entities[entity._guid];
    for (i = 0;i < len;i++) {
      var componentData = edata.components[systems[i].id];
      if (componentData) {
        this._app.systems[systems[i].id].addComponent(entity, componentData);
      }
    }
    var child, length = edata.children.length;
    var children = entity._children;
    for (i = 0;i < length;i++) {
      children[i] = this._openComponentData(children[i], entities);
    }
    return entity;
  }};
  return {SceneParser:SceneParser};
}());
pc.extend(pc, function() {
  var assetIdCounter = 0;
  var ABSOLUTE_URL = new RegExp("^" + "\\s*" + "(?:" + "[a-z]+[a-z0-9\\-\\+\\.]*" + ":" + ")?" + "//", "i");
  var Asset = function(name, type, file, data) {
    this._id = ++assetIdCounter;
    this.name = name || "";
    this.type = type;
    this.tags = new pc.Tags(this);
    this._preload = false;
    this.variants = new pc.AssetVariants(this);
    this._file = null;
    this._data = data || {};
    this._resources = [];
    this.loaded = false;
    this.loading = false;
    this.registry = null;
    pc.events.attach(this);
    if (file) {
      this.file = file;
    }
  };
  Asset.prototype = {getFileUrl:function() {
    var file = this.getPreferredFile();
    if (!file || !file.url) {
      return null;
    }
    var url = file.url;
    if (this.registry && this.registry.prefix && !ABSOLUTE_URL.test(url)) {
      url = this.registry.prefix + url;
    }
    if (this.type !== "script" && file.hash) {
      var separator = url.indexOf("?") !== -1 ? "&" : "?";
      url += separator + "t=" + file.hash;
    }
    return url;
  }, getPreferredFile:function() {
    if (!this.file) {
      return null;
    }
    if (this.type === "texture") {
      var device = this.registry._loader.getHandler("texture")._device;
      if (this.variants.pvr && device.extCompressedTexturePVRTC) {
        return this.variants.pvr;
      } else {
        if (this.variants.dxt && device.extCompressedTextureS3TC) {
          return this.variants.dxt;
        } else {
          if (this.variants.etc1 && device.extCompressedTextureETC1) {
            return this.variants.etc1;
          }
        }
      }
    }
    return this.file;
  }, ready:function(callback, scope) {
    scope = scope || this;
    if (this.resource) {
      callback.call(scope, this);
    } else {
      this.once("load", function(asset) {
        callback.call(scope, asset);
      });
    }
  }, reload:function() {
    if (!this.loaded) {
      return;
    }
    if (this.type === "cubemap") {
      this.registry._loader.patch(this, this.registry);
    } else {
      this.loaded = false;
      this.registry.load(this);
    }
  }, unload:function() {
    if (!this.loaded && !this.resource) {
      return;
    }
    this.fire("unload", this);
    this.registry.fire("unload:" + this.id, this);
    if (this.resource && this.resource.destroy) {
      this.resource.destroy();
    }
    this.resource = null;
    this.loaded = false;
    if (this.file) {
      this.registry._loader.clearCache(this.getFileUrl(), this.type);
    }
  }};
  Object.defineProperty(Asset.prototype, "id", {get:function() {
    return this._id;
  }, set:function(value) {
    this._id = value;
    if (value > assetIdCounter) {
      assetIdCounter = value;
    }
  }});
  Object.defineProperty(Asset.prototype, "file", {get:function() {
    return this._file;
  }, set:function(value) {
    var key;
    var valueAsBool = !!value;
    var fileAsBool = !!this._file;
    if (valueAsBool !== fileAsBool || value && this._file && value.hash !== this._file) {
      if (value) {
        if (!this._file) {
          this._file = {};
        }
        this._file.url = value.url;
        this._file.filename = value.filename;
        this._file.hash = value.hash;
        this._file.size = value.size;
        this._file.variants = this.variants;
        if (value.hasOwnProperty("variants")) {
          this.variants.clear();
          if (value.variants) {
            for (key in value.variants) {
              if (!value.variants[key]) {
                continue;
              }
              this.variants[key] = value.variants[key];
            }
          }
        }
        this.fire("change", this, "file", this._file, this._file);
        this.reload();
      } else {
        this._file = null;
        this.variants.clear();
      }
    } else {
      if (value && this._file && value.hasOwnProperty("variants")) {
        this.variants.clear();
        if (value.variants) {
          for (key in value.variants) {
            if (!value.variants[key]) {
              continue;
            }
            this.variants[key] = value.variants[key];
          }
        }
      }
    }
  }});
  Object.defineProperty(Asset.prototype, "data", {get:function() {
    return this._data;
  }, set:function(value) {
    var old = this._data;
    this._data = value;
    if (value !== old) {
      this.fire("change", this, "data", value, old);
      if (this.loaded) {
        this.registry._loader.patch(this, this.registry);
      }
    }
  }});
  Object.defineProperty(Asset.prototype, "resource", {get:function() {
    return this._resources[0];
  }, set:function(value) {
    var _old = this._resources[0];
    this._resources[0] = value;
    this.fire("change", this, "resource", value, _old);
  }});
  Object.defineProperty(Asset.prototype, "resources", {get:function() {
    return this._resources;
  }, set:function(value) {
    var _old = this._resources;
    this._resources = value;
    this.fire("change", this, "resources", value, _old);
  }});
  Object.defineProperty(Asset.prototype, "preload", {get:function() {
    return this._preload;
  }, set:function(value) {
    value = !!value;
    if (this._preload === value) {
      return;
    }
    this._preload = value;
    if (this._preload && !this.loaded && !this.loading && this.registry) {
      this.registry.load(this);
    }
  }});
  return {Asset:Asset, ASSET_ANIMATION:"animation", ASSET_AUDIO:"audio", ASSET_IMAGE:"image", ASSET_JSON:"json", ASSET_MODEL:"model", ASSET_MATERIAL:"material", ASSET_TEXT:"text", ASSET_TEXTURE:"texture", ASSET_CUBEMAP:"cubemap", ASSET_SHADER:"shader", ASSET_CSS:"css", ASSET_HTML:"html", ASSET_SCRIPT:"script", ABSOLUTE_URL:ABSOLUTE_URL};
}());
pc.extend(pc, function() {
  var properties = [];
  var AssetVariants = function(asset) {
    this.asset = asset;
  };
  var defineVariantProperty = function(name) {
    var field = "_" + name;
    properties.push(field);
    Object.defineProperty(AssetVariants.prototype, name, {get:function() {
      return this[field] || null;
    }, set:function(value) {
      var fieldAsBool = !!this[field];
      var valueAsBool = !!value;
      if (fieldAsBool !== valueAsBool || this[field] && value && this[field].hash !== value.hash) {
        var old = this[field];
        if (value) {
          this[field] = {url:value.url, filename:value.filename, size:value.size, hash:value.hash, opt:value.opt || 0};
        } else {
          this[field] = null;
        }
        if (this.asset.file) {
          this.asset.fire("change", this.asset, "file", this.asset._file, this.asset._file);
          this.asset.reload();
        }
      }
    }});
  };
  defineVariantProperty("dxt");
  defineVariantProperty("pvr");
  defineVariantProperty("etc1");
  AssetVariants.prototype.clear = function() {
    for (var i = 0;i < properties.length;i++) {
      this[properties[i]] = null;
    }
  };
  return {AssetVariants:AssetVariants};
}());
pc.extend(pc, function() {
  var AssetRegistry = function(loader) {
    this._loader = loader;
    this._assets = [];
    this._cache = {};
    this._names = {};
    this._tags = new pc.TagsCache("_id");
    this._urls = {};
    this.prefix = null;
    pc.extend(this, pc.events);
  };
  AssetRegistry.prototype = {list:function(filters) {
    filters = filters || {};
    return this._assets.filter(function(asset) {
      var include = true;
      if (filters.preload !== undefined) {
        include = asset.preload === filters.preload;
      }
      return include;
    });
  }, add:function(asset) {
    var index = this._assets.push(asset) - 1;
    var url;
    this._cache[asset.id] = index;
    if (!this._names[asset.name]) {
      this._names[asset.name] = [];
    }
    this._names[asset.name].push(index);
    if (asset.file) {
      url = asset.file.url;
      this._urls[url] = index;
    }
    asset.registry = this;
    this._tags.addItem(asset);
    asset.tags.on("add", this._onTagAdd, this);
    asset.tags.on("remove", this._onTagRemove, this);
    this.fire("add", asset);
    this.fire("add:" + asset.id, asset);
    if (url) {
      this.fire("add:url:" + url, asset);
    }
    if (asset.preload) {
      this.load(asset);
    }
  }, remove:function(asset) {
    delete this._cache[asset.id];
    delete this._names[asset.name];
    var url = asset.file ? asset.file.url : null;
    if (url) {
      delete this._urls[url];
    }
    this._tags.removeItem(asset);
    asset.tags.off("add", this._onTagAdd, this);
    asset.tags.off("remove", this._onTagRemove, this);
    asset.fire("remove", asset);
    this.fire("remove", asset);
    this.fire("remove:" + asset.id, asset);
    if (url) {
      this.fire("remove:url:" + url, asset);
    }
  }, get:function(id) {
    var idx = this._cache[id];
    return this._assets[idx];
  }, getByUrl:function(url) {
    var idx = this._urls[url];
    return this._assets[idx];
  }, load:function(asset) {
    if (asset.loading) {
      return;
    }
    var self = this;
    if (asset.loaded) {
      if (asset.type === "cubemap") {
        self._loader.patch(asset, this);
      }
      return;
    }
    var load = !!asset.file;
    var file = asset.getPreferredFile();
    var _load = function() {
      var url = asset.getFileUrl();
      asset.loading = true;
      self._loader.load(url, asset.type, function(err, resource, extra) {
        asset.loaded = true;
        asset.loading = false;
        if (err) {
          self.fire("error", err, asset);
          self.fire("error:" + asset.id, err, asset);
          asset.fire("error", err, asset);
          return;
        }
        if (resource instanceof Array) {
          asset.resources = resource;
        } else {
          asset.resource = resource;
        }
        if (!pc.script.legacy && asset.type === "script") {
          var loader = self._loader.getHandler("script");
          if (loader._cache[asset.id] && loader._cache[asset.id].parentNode === document.head) {
            document.head.removeChild(loader._cache[asset.id]);
          }
          loader._cache[asset.id] = extra;
        }
        self._loader.patch(asset, self);
        self.fire("load", asset);
        self.fire("load:" + asset.id, asset);
        if (file && file.url) {
          self.fire("load:url:" + file.url, asset);
        }
        asset.fire("load", asset);
      }, asset);
    };
    var _open = function() {
      var resource = self._loader.open(asset.type, asset.data);
      if (resource instanceof Array) {
        asset.resources = resource;
      } else {
        asset.resource = resource;
      }
      asset.loaded = true;
      self._loader.patch(asset, self);
      self.fire("load", asset);
      self.fire("load:" + asset.id, asset);
      if (file && file.url) {
        self.fire("load:url:" + file.url, asset);
      }
      asset.fire("load", asset);
    };
    if (file && asset.type === "cubemap") {
      load = false;
      var url = asset.getFileUrl();
      this._loader.load(url, "texture", function(err, texture) {
        if (!err) {
          self._loader.patch({resource:texture, type:"texture", data:asset.data}, self);
          asset._dds = texture;
          _open();
        } else {
          self.fire("error", err, asset);
          self.fire("error:" + asset.id, err, asset);
          asset.fire("error", err, asset);
          return;
        }
      });
    }
    if (!file) {
      _open();
    } else {
      if (load) {
        this.fire("load:start", asset);
        this.fire("load:" + asset.id + ":start", asset);
        _load();
      }
    }
  }, loadFromUrl:function(url, type, callback) {
    var self = this;
    var name = pc.path.getBasename(url);
    var file = {url:url};
    var data = {};
    var asset = self.getByUrl(url);
    if (!asset) {
      asset = new pc.Asset(name, type, file, data);
      self.add(asset);
    }
    if (type === "model") {
      self._loadModel(asset, callback);
      return;
    }
    asset.once("load", function(asset) {
      callback(null, asset);
    });
    asset.once("error", function(err) {
      callback(err);
    });
    self.load(asset);
  }, _loadModel:function(asset, callback) {
    var self = this;
    var url = asset.getFileUrl();
    var dir = pc.path.getDirectory(url);
    var basename = pc.path.getBasename(url);
    var name = basename.replace(".json", "");
    var ext = pc.path.getExtension(url);
    var _loadAsset = function(asset) {
      asset.once("load", function(asset) {
        callback(null, asset);
      });
      asset.once("error", function(err) {
        callback(err);
      });
      self.load(asset);
    };
    if (ext === ".json") {
      var mappingUrl = pc.path.join(dir, basename.replace(".json", ".mapping.json"));
      this._loader.load(mappingUrl, "json", function(err, data) {
        if (err) {
          asset.data = {mapping:[]};
          _loadAsset(asset);
          return;
        }
        self._loadMaterials(dir, data, function(err, materials) {
          asset.data = data;
          _loadAsset(asset);
        });
      });
    } else {
      _loadAsset(asset);
    }
  }, _loadMaterials:function(dir, mapping, callback) {
    var self = this;
    var i;
    var count = mapping.mapping.length;
    var materials = [];
    var done = function(err, materials) {
      self._loadTextures(materials, function(err, textures) {
        callback(null, materials);
      });
    };
    if (count === 0) {
      callback(null, materials);
    }
    var onLoadAsset = function(err, asset) {
      materials.push(asset);
      count--;
      if (count === 0) {
        done(null, materials);
      }
    };
    for (i = 0;i < mapping.mapping.length;i++) {
      var path = mapping.mapping[i].path;
      if (path) {
        self.loadFromUrl(pc.path.join(dir, path), "material", onLoadAsset);
      } else {
        count--;
      }
    }
  }, _loadTextures:function(materials, callback) {
    var self = this;
    var i, j;
    var used = {};
    var urls = [];
    var textures = [];
    var count = 0;
    for (i = 0;i < materials.length;i++) {
      if (materials[i].data.parameters) {
        var params = materials[i].data.parameters;
        for (j = 0;j < params.length;j++) {
          if (params[j].type === "texture") {
            var url = materials[i].getFileUrl();
            var dir = pc.path.getDirectory(url);
            url = pc.path.join(dir, params[j].data);
            if (!used[url]) {
              used[url] = true;
              urls.push(url);
              count++;
            }
          }
        }
      } else {
        console.warn("Update material asset loader to support new material format");
      }
    }
    if (!count) {
      callback(null, textures);
      return;
    }
    var onLoadAsset = function(err, texture) {
      textures.push(texture);
      count--;
      if (err) {
        console.error(err);
      }
      if (count === 0) {
        callback(null, textures);
      }
    };
    for (i = 0;i < urls.length;i++) {
      self.loadFromUrl(urls[i], "texture", onLoadAsset);
    }
  }, findAll:function(name, type) {
    var self = this;
    var idxs = this._names[name];
    var assets;
    if (idxs) {
      assets = idxs.map(function(idx) {
        return self._assets[idx];
      });
      if (type) {
        return assets.filter(function(asset) {
          return asset.type === type;
        });
      } else {
        return assets;
      }
    } else {
      return [];
    }
  }, _onTagAdd:function(tag, asset) {
    this._tags.add(tag, asset);
  }, _onTagRemove:function(tag, asset) {
    this._tags.remove(tag, asset);
  }, findByTag:function() {
    return this._tags.find(arguments);
  }, filter:function(callback) {
    var items = [];
    for (var i = 0, len = this._assets.length;i < len;i++) {
      if (callback(this._assets[i])) {
        items.push(this._assets[i]);
      }
    }
    return items;
  }, find:function(name, type) {
    var asset = this.findAll(name, type);
    return asset ? asset[0] : null;
  }, getAssetById:function(id) {
    console.warn("DEPRECATED: getAssetById() use get() instead");
    return this.get(id);
  }};
  return {AssetRegistry:AssetRegistry};
}());
pc.anim = {Animation:pc.Animation, Key:pc.Key, Node:pc.Node, Skeleton:pc.Skeleton};
pc.asset = {ASSET_ANIMATION:"animation", ASSET_AUDIO:"audio", ASSET_IMAGE:"image", ASSET_JSON:"json", ASSET_MODEL:"model", ASSET_MATERIAL:"material", ASSET_TEXT:"text", ASSET_TEXTURE:"texture", ASSET_CUBEMAP:"cubemap", ASSET_SCRIPT:"script"};
pc.audio = {AudioManager:pc.SoundManager, Channel:pc.Channel, Channel3d:pc.Channel3d, Listener:pc.Listener, Sound:pc.Sound};
pc.fw = {Application:pc.Application, Component:pc.Component, ComponentData:pc.ComponentData, ComponentSystem:pc.ComponentSystem, Entity:pc.Entity, FillMode:{NONE:pc.FILLMODE_NONE, FILL_WINDOW:pc.FILLMODE_FILL_WINDOW, KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT}, ResolutionMode:{AUTO:pc.RESOLUTION_AUTO, FIXED:pc.RESOLUTION_FIXED}};
pc.extend(pc.gfx, {drawQuadWithShader:pc.drawQuadWithShader, precalculatedTangents:pc.precalculatedTangents, programlib:pc.programlib, shaderChunks:pc.shaderChunks, ContextCreationError:pc.ContextCreationError, Device:pc.GraphicsDevice, IndexBuffer:pc.IndexBuffer, ProgramLibrary:pc.ProgramLibrary, RenderTarget:pc.RenderTarget, ScopeId:pc.ScopeId, Shader:pc.Shader, ShaderInput:pc.ShaderInput, Texture:pc.Texture, UnsupportedBrowserError:pc.UnsupportedBrowserError, VertexBuffer:pc.VertexBuffer, VertexFormat:pc.VertexFormat,
VertexIterator:pc.VertexIterator});
pc.extend(pc.input, {getTouchTargetCoords:pc.getTouchTargetCoords, Controller:pc.Controller, GamePads:pc.GamePads, Keyboard:pc.Keyboard, KeyboardEvent:pc.KeyboardEvent, Mouse:pc.Mouse, MouseEvent:pc.MouseEvent, Touch:pc.Touch, TouchDevice:pc.TouchDevice, TouchEvent:pc.TouchEvent});
pc.posteffect = {createFullscreenQuad:pc.createFullscreenQuad, drawFullscreenQuad:pc.drawFullscreenQuad, PostEffect:pc.PostEffect, PostEffectQueue:pc.PostEffectQueue};
pc.extend(pc.scene, {partitionSkin:pc.partitionSkin, procedural:{calculateTangents:pc.calculateTangents, createMesh:pc.createMesh, createTorus:pc.createTorus, createCylinder:pc.createCylinder, createCapsule:pc.createCapsule, createCone:pc.createCone, createSphere:pc.createSphere, createPlane:pc.createPlane, createBox:pc.createBox}, BasicMaterial:pc.BasicMaterial, DepthMaterial:pc.DepthMaterial, ForwardRenderer:pc.ForwardRenderer, GraphNode:pc.GraphNode, Material:pc.Material, Command:pc.Command, Mesh:pc.Mesh,
MeshInstance:pc.MeshInstance, Model:pc.Model, ParticleEmitter:pc.ParticleEmitter, PhongMaterial:pc.StandardMaterial, Picker:pc.Picker, PickMaterial:pc.PickMaterial, Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC, PERSPECTIVE:pc.PROJECTION_PERSPECTIVE}, Scene:pc.Scene, Skin:pc.Skin, SkinInstance:pc.SkinInstance});
pc.shape = {Aabb:pc.BoundingBox, Sphere:pc.BoundingSphere, Plane:pc.Plane};
pc.time = {now:pc.now, Timer:pc.Timer};
pc.PhongMaterial = pc.StandardMaterial;
pc.BoundingSphere.prototype.intersectRay = pc.BoundingSphere.prototype.intersectsRay;
pc.ELEMENTTYPE_INT8 = pc.TYPE_INT8;
pc.ELEMENTTYPE_UINT8 = pc.TYPE_UINT8;
pc.ELEMENTTYPE_INT16 = pc.TYPE_INT16;
pc.ELEMENTTYPE_UINT16 = pc.TYPE_UINT16;
pc.ELEMENTTYPE_INT32 = pc.TYPE_INT32;
pc.ELEMENTTYPE_UINT32 = pc.TYPE_UINT32;
pc.ELEMENTTYPE_FLOAT32 = pc.TYPE_FLOAT32;
pc.extend(pc.Application.prototype, function() {
  var lineVertexFormat = null;
  var lineBatches = [];
  var quadMesh = null;
  var cubeLocalPos = null;
  var cubeWorldPos = null;
  var tempGraphNode = new pc.GraphNode;
  var identityGraphNode = new pc.GraphNode;
  var lineBatch = function() {
    this.numLinesAllocated = 128;
    this.vb = null;
    this.vbRam = null;
    this.mesh = null;
    this.linesUsed = 0;
    this.material = null;
    this.meshInstance = null;
  };
  lineBatch.prototype = {init:function(device, linesToAdd) {
    if (!this.mesh) {
      this.mesh = new pc.Mesh;
      this.mesh.primitive[0].type = pc.PRIMITIVE_LINES;
      this.mesh.primitive[0].base = 0;
      this.mesh.primitive[0].indexed = false;
      this.material = new pc.BasicMaterial;
      this.material.vertexColors = true;
      this.material.blend = true;
      this.material.blendType = pc.BLEND_NORMAL;
      this.material.update();
    }
    while (this.linesUsed + linesToAdd > this.numLinesAllocated) {
      this.vb = null;
      this.numLinesAllocated *= 2;
    }
    if (!this.vb) {
      this.vb = new pc.VertexBuffer(device, lineVertexFormat, this.numLinesAllocated * 2, pc.BUFFER_DYNAMIC);
      this.mesh.vertexBuffer = this.vb;
      this.vbRam = new DataView(this.vb.lock());
      if (!this.meshInstance) {
        identityGraphNode.worldTransform = pc.Mat4.IDENTITY;
        identityGraphNode._dirtyWorld = identityGraphNode._dirtyNormal = false;
        this.meshInstance = new pc.MeshInstance(identityGraphNode, this.mesh, this.material);
      }
    }
  }, addLines:function(position, color) {
    var multiColor = !!color.length;
    var offset = this.linesUsed * 2 * lineVertexFormat.size;
    var clr;
    for (var i = 0;i < position.length;i++) {
      this.vbRam.setFloat32(offset, position[i].x, true);
      offset += 4;
      this.vbRam.setFloat32(offset, position[i].y, true);
      offset += 4;
      this.vbRam.setFloat32(offset, position[i].z, true);
      offset += 4;
      clr = multiColor ? color[i] : color;
      this.vbRam.setUint8(offset, clr.r * 255);
      offset += 1;
      this.vbRam.setUint8(offset, clr.g * 255);
      offset += 1;
      this.vbRam.setUint8(offset, clr.b * 255);
      offset += 1;
      this.vbRam.setUint8(offset, clr.a * 255);
      offset += 1;
    }
    this.linesUsed += position.length / 2;
  }, finalize:function(drawCalls) {
    if (this.linesUsed > 0) {
      this.vb.setData(this.vbRam.buffer);
      this.mesh.primitive[0].count = this.linesUsed * 2;
      drawCalls.push(this.meshInstance);
      this.linesUsed = 0;
    }
  }};
  function _addLines(batchId, position, color) {
    if (!lineVertexFormat) {
      lineVertexFormat = new pc.VertexFormat(this.graphicsDevice, [{semantic:pc.SEMANTIC_POSITION, components:3, type:pc.TYPE_FLOAT32}, {semantic:pc.SEMANTIC_COLOR, components:4, type:pc.TYPE_UINT8, normalize:true}]);
      this.on("prerender", this._preRenderImmediate, this);
    }
    if (!lineBatches[batchId]) {
      lineBatches[batchId] = new lineBatch;
      lineBatches[batchId].init(this.graphicsDevice, position.length / 2);
      if (batchId === pc.LINEBATCH_OVERLAY) {
        lineBatches[batchId].material.depthTest = false;
        lineBatches[batchId].meshInstance.layer = pc.LAYER_GIZMO;
      } else {
        if (batchId === pc.LINEBATCH_GIZMO) {
          lineBatches[batchId].meshInstance.layer = pc.LAYER_GIZMO;
        }
      }
    } else {
      lineBatches[batchId].init(this.graphicsDevice, position.length / 2);
    }
    lineBatches[batchId].addLines(position, color);
  }
  function renderLine(start, end, color, arg3, arg4) {
    var endColor = color;
    var lineType = pc.LINEBATCH_WORLD;
    if (arg3) {
      if (typeof arg3 === "number") {
        lineType = arg3;
      } else {
        endColor = arg3;
        if (arg4) {
          lineType = arg4;
        }
      }
    }
    this._addLines(lineType, [start, end], [color, endColor]);
  }
  function renderLines(position, color, lineType) {
    if (lineType === undefined) {
      lineType = pc.LINEBATCH_WORLD;
    }
    var multiColor = !!color.length;
    if (multiColor) {
      if (position.length !== color.length) {
        pc.log.error("renderLines: position/color arrays have different lengths");
        return;
      }
    }
    if (position.length % 2 !== 0) {
      pc.log.error("renderLines: array length is not divisible by 2");
      return;
    }
    this._addLines(lineType, position, color);
  }
  function renderWireCube(matrix, color, lineType) {
    if (lineType === undefined) {
      lineType = pc.LINEBATCH_WORLD;
    }
    var i;
    if (!cubeLocalPos) {
      var x = 0.5;
      cubeLocalPos = [new pc.Vec3(-x, -x, -x), new pc.Vec3(-x, x, -x), new pc.Vec3(x, x, -x), new pc.Vec3(x, -x, -x), new pc.Vec3(-x, -x, x), new pc.Vec3(-x, x, x), new pc.Vec3(x, x, x), new pc.Vec3(x, -x, x)];
      cubeWorldPos = [new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3, new pc.Vec3];
    }
    for (i = 0;i < 8;i++) {
      matrix.transformPoint(cubeLocalPos[i], cubeWorldPos[i]);
    }
    this.renderLines([cubeWorldPos[0], cubeWorldPos[1], cubeWorldPos[1], cubeWorldPos[2], cubeWorldPos[2], cubeWorldPos[3], cubeWorldPos[3], cubeWorldPos[0], cubeWorldPos[4], cubeWorldPos[5], cubeWorldPos[5], cubeWorldPos[6], cubeWorldPos[6], cubeWorldPos[7], cubeWorldPos[7], cubeWorldPos[4], cubeWorldPos[0], cubeWorldPos[4], cubeWorldPos[1], cubeWorldPos[5], cubeWorldPos[2], cubeWorldPos[6], cubeWorldPos[3], cubeWorldPos[7]], color, lineType);
  }
  function _preRenderImmediate() {
    for (var i = 0;i < 3;i++) {
      if (lineBatches[i]) {
        lineBatches[i].finalize(this.scene.immediateDrawCalls);
      }
    }
  }
  function renderMeshInstance(meshInstance) {
    this.scene.immediateDrawCalls.push(meshInstance);
  }
  function renderMesh(mesh, material, matrix) {
    tempGraphNode.worldTransform = matrix;
    tempGraphNode._dirtyWorld = tempGraphNode._dirtyNormal = false;
    var instance = new pc.MeshInstance(tempGraphNode, mesh, material);
    this.scene.immediateDrawCalls.push(instance);
  }
  function renderQuad(matrix, material, layer) {
    if (!quadMesh) {
      var format = new pc.VertexFormat(this.graphicsDevice, [{semantic:pc.SEMANTIC_POSITION, components:3, type:pc.TYPE_FLOAT32}]);
      var quadVb = new pc.VertexBuffer(this.graphicsDevice, format, 4);
      var iterator = new pc.VertexIterator(quadVb);
      iterator.element[pc.SEMANTIC_POSITION].set(-0.5, -0.5, 0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(0.5, -0.5, 0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(-0.5, 0.5, 0);
      iterator.next();
      iterator.element[pc.SEMANTIC_POSITION].set(0.5, 0.5, 0);
      iterator.end();
      quadMesh = new pc.Mesh;
      quadMesh.vertexBuffer = quadVb;
      quadMesh.primitive[0].type = pc.PRIMITIVE_TRISTRIP;
      quadMesh.primitive[0].base = 0;
      quadMesh.primitive[0].count = 4;
      quadMesh.primitive[0].indexed = false;
    }
    tempGraphNode.worldTransform = matrix;
    tempGraphNode._dirtyWorld = tempGraphNode._dirtyNormal = false;
    var quad = new pc.MeshInstance(tempGraphNode, quadMesh, material);
    if (layer) {
      quad.layer = layer;
    }
    this.scene.immediateDrawCalls.push(quad);
  }
  return {renderMeshInstance:renderMeshInstance, renderMesh:renderMesh, renderLine:renderLine, renderLines:renderLines, renderQuad:renderQuad, renderWireCube:renderWireCube, _addLines:_addLines, _preRenderImmediate:_preRenderImmediate};
}());
pc.extend(pc, function() {
  var maxSize = 2048;
  var maskDynamic = 1;
  var maskBaked = 2;
  var maskLightmap = 4;
  var sceneLightmaps = [];
  var sceneLightmapsNode = [];
  var lmCamera;
  var tempVec = new pc.Vec3;
  var bounds = new pc.BoundingBox;
  var lightBounds = new pc.BoundingBox;
  var tempSphere = {};
  var PASS_COLOR = 0;
  var PASS_DIR = 1;
  var passTexName = ["texture_lightMap", "texture_dirLightMap"];
  var passMaterial = [];
  function collectModels(node, nodes, nodesMeshInstances, allNodes) {
    if (!node.enabled) {
      return;
    }
    var i;
    if (node.model && node.model.model && node.model.enabled) {
      if (allNodes) {
        allNodes.push(node);
      }
      if (node.model.data.lightmapped) {
        if (nodes) {
          var hasUv1 = true;
          var meshInstances = node.model.model.meshInstances;
          for (i = 0;i < meshInstances.length;i++) {
            if (!meshInstances[i].mesh.vertexBuffer.format.hasUv1) {
              hasUv1 = false;
              break;
            }
          }
          if (hasUv1) {
            var j;
            var isInstance;
            var notInstancedMeshInstances = [];
            for (i = 0;i < meshInstances.length;i++) {
              isInstance = false;
              for (j = 0;j < meshInstances.length;j++) {
                if (i !== j) {
                  if (meshInstances[i].mesh === meshInstances[j].mesh) {
                    isInstance = true;
                  }
                }
              }
              if (isInstance) {
                nodes.push(node);
                nodesMeshInstances.push([meshInstances[i]]);
              } else {
                notInstancedMeshInstances.push(meshInstances[i]);
              }
            }
            if (notInstancedMeshInstances.length > 0) {
              nodes.push(node);
              nodesMeshInstances.push(notInstancedMeshInstances);
            }
          }
        }
      }
    }
    for (i = 0;i < node._children.length;i++) {
      collectModels(node._children[i], nodes, nodesMeshInstances, allNodes);
    }
  }
  var Lightmapper = function(device, root, scene, renderer, assets) {
    this.device = device;
    this.root = root;
    this.scene = scene;
    this.renderer = renderer;
    this.assets = assets;
  };
  Lightmapper.prototype = {calculateLightmapSize:function(node) {
    var data, parent;
    var sizeMult = this.scene.lightmapSizeMultiplier || 16;
    var scale = tempVec;
    var area = {x:1, y:1, z:1, uv:1};
    if (node.model.asset) {
      data = this.assets.get(node.model.asset).data;
      if (data.area) {
        area.x = data.area.x;
        area.y = data.area.y;
        area.z = data.area.z;
        area.uv = data.area.uv;
      }
    } else {
      if (node.model._area) {
        data = node.model;
        if (data._area) {
          area.x = data._area.x;
          area.y = data._area.y;
          area.z = data._area.z;
          area.uv = data._area.uv;
        }
      }
    }
    var areaMult = node.model.lightmapSizeMultiplier || 1;
    area.x *= areaMult;
    area.y *= areaMult;
    area.z *= areaMult;
    scale.copy(node.localScale);
    parent = node._parent;
    while (parent) {
      scale.mul(parent.localScale);
      parent = parent._parent;
    }
    scale.x = Math.abs(scale.x);
    scale.y = Math.abs(scale.y);
    scale.z = Math.abs(scale.z);
    var totalArea = area.x * scale.y * scale.z + area.y * scale.x * scale.z + area.z * scale.x * scale.y;
    totalArea /= area.uv;
    totalArea = Math.sqrt(totalArea);
    return Math.min(pc.math.nextPowerOfTwo(totalArea * sizeMult), this.scene.lightmapMaxResolution || maxSize);
  }, bake:function(nodes, mode) {
    var i, j;
    var device = this.device;
    var scene = this.scene;
    var passCount = 1;
    if (mode === undefined) {
      mode = pc.BAKE_COLORDIR;
    }
    if (mode === pc.BAKE_COLORDIR) {
      passCount = 2;
    }
    var pass;
    var allNodes = [];
    var nodesMeshInstances = [];
    if (!nodes) {
      for (i = 0;i < sceneLightmaps.length;i++) {
        for (j = 0;j < sceneLightmaps[i].length;j++) {
          sceneLightmaps[i][j].destroy();
        }
      }
      sceneLightmaps = [];
      sceneLightmapsNode = [];
      nodes = [];
      collectModels(this.root, nodes, nodesMeshInstances, allNodes);
    } else {
      var k;
      for (i = sceneLightmapsNode.length - 1;i >= 0;i--) {
        for (j = 0;j < nodes.length;j++) {
          if (sceneLightmapsNode[i] === nodes[j]) {
            for (k = 0;k < sceneLightmaps[i].length;k++) {
              sceneLightmaps[i][k].destroy();
            }
            sceneLightmaps.splice(i, 1);
            sceneLightmapsNode.splice(i, 1);
          }
        }
      }
      var _nodes = [];
      for (i = 0;i < nodes.length;i++) {
        collectModels(nodes[i], _nodes, nodesMeshInstances);
      }
      nodes = _nodes;
      collectModels(this.root, null, null, allNodes);
    }
    if (nodes.length === 0) {
      device.fire("lightmapper:end", {timestamp:pc.now(), target:this});
      return;
    }
    var revertStatic = false;
    if (scene._needsStaticPrepare) {
      scene._needsStaticPrepare = false;
      revertStatic = true;
    }
    var texSize = [];
    var lmaps = [[], []];
    var texPool = {};
    var size;
    var tex;
    var instances;
    var blackTex = new pc.Texture(this.device, {width:4, height:4, format:pc.PIXELFORMAT_R8_G8_B8_A8, rgbm:true});
    for (i = 0;i < nodes.length;i++) {
      size = this.calculateLightmapSize(nodes[i]);
      texSize.push(size);
      for (pass = 0;pass < passCount;pass++) {
        tex = new pc.Texture(device, {width:size, height:size, format:pc.PIXELFORMAT_R8_G8_B8_A8, mipmaps:false, rgbm:pass === PASS_COLOR, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
        lmaps[pass].push(tex);
      }
      if (!texPool[size]) {
        var tex2 = new pc.Texture(device, {width:size, height:size, format:pc.PIXELFORMAT_R8_G8_B8_A8, mipmaps:false, rgbm:true, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
        var targ2 = new pc.RenderTarget(device, tex2, {depth:false});
        texPool[size] = targ2;
      }
    }
    var lights = [];
    var origMask = [];
    var origShadowMode = [];
    var origEnabled = [];
    var sceneLights = scene._lights;
    var mask;
    for (i = 0;i < sceneLights.length;i++) {
      if (sceneLights[i]._enabled) {
        mask = sceneLights[i]._mask;
        if ((mask & maskLightmap) !== 0) {
          origMask.push(mask);
          origShadowMode.push(sceneLights[i].shadowUpdateMode);
          sceneLights[i]._mask = 4294967295;
          sceneLights[i].shadowUpdateMode = sceneLights[i]._type === pc.LIGHTTYPE_DIRECTIONAL ? pc.SHADOWUPDATE_REALTIME : pc.SHADOWUPDATE_THISFRAME;
          lights.push(sceneLights[i]);
          sceneLights[i].isStatic = false;
        }
      }
      origEnabled.push(sceneLights[i]._enabled);
      sceneLights[i].enabled = false;
    }
    var chunks = pc.shaderChunks;
    var xformUv1 = chunks.transformUv1VS;
    var bakeLmEnd = chunks.bakeLmEndPS;
    var dilate = chunks.dilatePS;
    var dilateShader = chunks.createShaderFromCode(device, chunks.fullscreenQuadVS, dilate, "lmDilate");
    var constantTexSource = device.scope.resolve("source");
    var constantPixelOffset = device.scope.resolve("pixelOffset");
    var constantBakeDir = device.scope.resolve("bakeDir");
    var pixelOffset = new pc.Vec2;
    var lms = {};
    var drawCalls = scene.drawCalls;
    for (i = 0;i < drawCalls.length;i++) {
      if (drawCalls[i].node) {
        drawCalls[i].node.getWorldTransform();
      }
    }
    var origFog = scene.fog;
    var origAmbientR = scene.ambientLight.data[0];
    var origAmbientG = scene.ambientLight.data[1];
    var origAmbientB = scene.ambientLight.data[2];
    var origDrawCalls = scene.drawCalls;
    scene.fog = pc.FOG_NONE;
    scene.ambientLight.data[0] = 0;
    scene.ambientLight.data[1] = 0;
    scene.ambientLight.data[2] = 0;
    if (!lmCamera) {
      lmCamera = new pc.Camera;
      lmCamera._node = new pc.GraphNode;
      lmCamera.clearColor[0] = 0;
      lmCamera.clearColor[1] = 0;
      lmCamera.clearColor[2] = 0;
      lmCamera.clearColor[3] = 0;
      lmCamera.clearDepth = 1;
      lmCamera.clearFlags = pc.CLEARFLAG_COLOR;
      lmCamera.clearStencil = null;
      lmCamera.frustumCulling = false;
    }
    var node;
    var lm, rcv, mat, m;
    var origShaderDefs = [];
    origShaderDefs.length = sceneLightmapsNode.length;
    var shaderDefs;
    for (node = 0;node < allNodes.length;node++) {
      rcv = allNodes[node].model.model.meshInstances;
      shaderDefs = [];
      for (i = 0;i < rcv.length;i++) {
        shaderDefs.push(rcv[i]._shaderDefs);
        rcv[i]._shaderDefs &= ~(pc.SHADERDEF_LM | pc.SHADERDEF_DIRLM);
      }
      for (i = 0;i < sceneLightmapsNode.length;i++) {
        if (sceneLightmapsNode[i] === allNodes[node]) {
          origShaderDefs[i] = shaderDefs;
          break;
        }
      }
    }
    var origCastShadows = [];
    var origCasters2 = scene.shadowCasters.slice();
    for (node = 0;node < allNodes.length;node++) {
      origCastShadows[node] = allNodes[node].model.castShadows;
      allNodes[node].model.castShadows = allNodes[node].model.data.castShadowsLightmap;
    }
    var origCasters = scene.shadowCasters;
    var casters = [];
    var instanceClone, prop;
    for (i = 0;i < origCasters.length;i++) {
      m = origCasters[i];
      instanceClone = new pc.MeshInstance(m.node, m.mesh, m.material);
      for (prop in m) {
        if (m.hasOwnProperty(prop)) {
          instanceClone[prop] = m[prop];
        }
      }
      casters.push(instanceClone);
    }
    scene.shadowCasters = casters;
    var origMat = [];
    var nodeBounds = [];
    var nodeTarg = [[], []];
    var targ, targTmp, texTmp;
    var light, shadowCam;
    var nodeLightCount = [];
    nodeLightCount.length = nodes.length;
    scene.updateShadersFunc(device);
    for (node = 0;node < nodes.length;node++) {
      rcv = nodesMeshInstances[node];
      for (i = 0;i < rcv.length;i++) {
        mat = rcv[i].material;
        origMat.push(mat);
      }
    }
    var lmMaterial;
    for (pass = 0;pass < passCount;pass++) {
      if (!passMaterial[pass]) {
        lmMaterial = new pc.StandardMaterial;
        lmMaterial.chunks.transformVS = xformUv1;
        if (pass === PASS_COLOR) {
          lmMaterial.chunks.endPS = bakeLmEnd;
          lmMaterial.ambient = new pc.Color(0, 0, 0);
          lmMaterial.ambientTint = true;
          lmMaterial.lightMap = blackTex;
        } else {
          lmMaterial.chunks.basePS = chunks.basePS + "\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n";
          lmMaterial.chunks.endPS = chunks.bakeDirLmEndPS;
        }
        lmMaterial.chunks.outputAlphaPS = "\n";
        lmMaterial.chunks.outputAlphaOpaquePS = "\n";
        lmMaterial.chunks.outputAlphaPremulPS = "\n";
        lmMaterial.cull = pc.CULLFACE_NONE;
        lmMaterial.forceUv1 = true;
        lmMaterial.update();
        lmMaterial.updateShader(device, scene);
        lmMaterial.name = "lmMaterial" + pass;
        passMaterial[pass] = lmMaterial;
      }
    }
    var cntr = 0;
    for (node = 0;node < nodes.length;node++) {
      rcv = nodesMeshInstances[node];
      nodeLightCount[node] = 0;
      if (rcv.length > 0) {
        bounds.copy(rcv[0].aabb);
        for (i = 0;i < rcv.length;i++) {
          rcv[i].node.getWorldTransform();
          bounds.add(rcv[i].aabb);
        }
      }
      var nbounds = new pc.BoundingBox;
      nbounds.copy(bounds);
      nodeBounds.push(nbounds);
      for (i = 0;i < rcv.length;i++) {
        m = rcv[i];
        m._shaderDefs &= ~(pc.SHADERDEF_LM | pc.SHADERDEF_DIRLM);
        m.mask = maskLightmap;
        m.deleteParameter("texture_lightMap");
        m.deleteParameter("texture_dirLightMap");
        m.setParameter("texture_lightMap", origMat[cntr].lightMap ? origMat[cntr].lightMap : blackTex);
        m.setParameter("texture_dirLightMap", blackTex);
        cntr++;
      }
      for (pass = 0;pass < passCount;pass++) {
        lm = lmaps[pass][node];
        targ = new pc.RenderTarget(device, lm, {depth:false});
        nodeTarg[pass].push(targ);
      }
    }
    for (j = 0;j < lights.length;j++) {
      lights[j].enabled = false;
    }
    var shadersUpdatedOn1stPass = false;
    for (i = 0;i < lights.length;i++) {
      lights[i].enabled = true;
      lights[i]._cacheShadowMap = true;
      if (lights[i]._type !== pc.LIGHTTYPE_DIRECTIONAL) {
        lights[i]._node.getWorldTransform();
        lights[i].getBoundingSphere(tempSphere);
        lightBounds.center = tempSphere.center;
        lightBounds.halfExtents.x = tempSphere.radius;
        lightBounds.halfExtents.y = tempSphere.radius;
        lightBounds.halfExtents.z = tempSphere.radius;
      }
      if (lights[i]._type === pc.LIGHTTYPE_SPOT) {
        light = lights[i];
        shadowCam = this.renderer.getShadowCamera(device, light);
        shadowCam._node.setPosition(light._node.getPosition());
        shadowCam._node.setRotation(light._node.getRotation());
        shadowCam._node.rotateLocal(-90, 0, 0);
        shadowCam.projection = pc.PROJECTION_PERSPECTIVE;
        shadowCam.nearClip = light.attenuationEnd / 1000;
        shadowCam.farClip = light.attenuationEnd;
        shadowCam.aspectRatio = 1;
        shadowCam.fov = light._outerConeAngle * 2;
        this.renderer.updateCameraFrustum(shadowCam);
      }
      for (node = 0;node < nodes.length;node++) {
        rcv = nodesMeshInstances[node];
        bounds = nodeBounds[node];
        scene.drawCalls = [];
        for (j = 0;j < rcv.length;j++) {
          scene.drawCalls.push(rcv[j]);
        }
        scene.updateShaders = true;
        if (lights[i]._type === pc.LIGHTTYPE_DIRECTIONAL) {
          tempVec.copy(bounds.center);
          tempVec.y += bounds.halfExtents.y;
          lmCamera._node.setPosition(tempVec);
          lmCamera._node.setEulerAngles(-90, 0, 0);
          var frustumSize = Math.max(bounds.halfExtents.x, bounds.halfExtents.z);
          lmCamera.projection = pc.PROJECTION_ORTHOGRAPHIC;
          lmCamera.nearClip = 0;
          lmCamera.farClip = bounds.halfExtents.y * 2;
          lmCamera.aspectRatio = 1;
          lmCamera.orthoHeight = frustumSize;
        } else {
          if (!lightBounds.intersects(bounds)) {
            continue;
          }
        }
        if (lights[i]._type === pc.LIGHTTYPE_SPOT) {
          var nodeVisible = false;
          for (j = 0;j < rcv.length;j++) {
            if (this.renderer._isVisible(shadowCam, rcv[j])) {
              nodeVisible = true;
              break;
            }
          }
          if (!nodeVisible) {
            continue;
          }
        }
        for (pass = 0;pass < passCount;pass++) {
          lm = lmaps[pass][node];
          targ = nodeTarg[pass][node];
          targTmp = texPool[lm.width];
          texTmp = targTmp.colorBuffer;
          if (pass === 0) {
            shadersUpdatedOn1stPass = scene.updateShaders;
          } else {
            if (shadersUpdatedOn1stPass) {
              scene.updateShaders = true;
            }
          }
          for (j = 0;j < rcv.length;j++) {
            rcv[j].material = passMaterial[pass];
          }
          lmCamera.renderTarget = targTmp;
          if (pass === PASS_DIR) {
            constantBakeDir.setValue(lights[i].bakeDir ? 1 : 0);
          }
          this.renderer._forwardTime = 0;
          this.renderer._shadowMapTime = 0;
          this.renderer.render(scene, lmCamera);
          lmaps[pass][node] = texTmp;
          nodeTarg[pass][node] = targTmp;
          texPool[lm.width] = targ;
          for (j = 0;j < rcv.length;j++) {
            m = rcv[j];
            m.setParameter(passTexName[pass], texTmp);
            m._shaderDefs |= pc.SHADERDEF_LM;
          }
        }
        nodeLightCount[node]++;
      }
      lights[i].enabled = false;
      lights[i]._cacheShadowMap = false;
      if (lights[i]._isCachedShadowMap) {
        lights[i]._destroyShadowMap();
      }
    }
    var id = 0;
    var sceneLmaps;
    for (node = 0;node < nodes.length;node++) {
      rcv = nodesMeshInstances[node];
      sceneLmaps = [];
      for (pass = 0;pass < passCount;pass++) {
        lm = lmaps[pass][node];
        targ = nodeTarg[pass][node];
        targTmp = texPool[lm.width];
        texTmp = targTmp.colorBuffer;
        var numDilates2x = 4;
        pixelOffset.set(1 / lm.width, 1 / lm.height);
        constantPixelOffset.setValue(pixelOffset.data);
        for (i = 0;i < numDilates2x;i++) {
          constantTexSource.setValue(lm);
          pc.drawQuadWithShader(device, targTmp, dilateShader);
          constantTexSource.setValue(texTmp);
          pc.drawQuadWithShader(device, targ, dilateShader);
        }
        for (i = 0;i < rcv.length;i++) {
          m = rcv[i];
          if (pass === 0) {
            m.mask = maskBaked;
            rcv[i].material = origMat[id];
            id++;
          }
          rcv[i].setParameter(passTexName[pass], lm);
          if (pass === PASS_DIR) {
            rcv[i]._shaderDefs |= pc.SHADERDEF_DIRLM;
          }
        }
        sceneLmaps[pass] = lm;
        if (pass === passCount - 1) {
          targ.destroy();
        }
      }
      sceneLightmaps.push(sceneLmaps);
      sceneLightmapsNode.push(nodes[node]);
    }
    for (var key in texPool) {
      if (texPool.hasOwnProperty(key)) {
        texPool[key].colorBuffer.destroy();
        texPool[key].destroy();
      }
    }
    for (i = 0;i < sceneLightmaps.length;i++) {
      for (j = 0;j < sceneLightmaps[i].length;j++) {
        tex = sceneLightmaps[i][j];
        tex.minFilter = pc.FILTER_LINEAR;
        tex.magFilter = pc.FILTER_LINEAR;
      }
    }
    for (node = 0;node < allNodes.length;node++) {
      allNodes[node].model.castShadows = origCastShadows[node];
    }
    scene.shadowCasters = origCasters2;
    for (i = 0;i < origShaderDefs.length;i++) {
      if (origShaderDefs[i]) {
        rcv = sceneLightmapsNode[i].model.model.meshInstances;
        for (j = 0;j < rcv.length;j++) {
          rcv[j]._shaderDefs |= origShaderDefs[i][j] & (pc.SHADERDEF_LM | pc.SHADERDEF_DIRLM);
        }
      }
    }
    for (i = 0;i < lights.length;i++) {
      lights[i]._mask = origMask[i];
      lights[i].shadowUpdateMode = origShadowMode[i];
    }
    for (i = 0;i < sceneLights.length;i++) {
      sceneLights[i].enabled = origEnabled[i];
    }
    scene.drawCalls = origDrawCalls;
    scene.fog = origFog;
    scene.ambientLight.data[0] = origAmbientR;
    scene.ambientLight.data[1] = origAmbientG;
    scene.ambientLight.data[2] = origAmbientB;
    if (revertStatic) {
      scene._needsStaticPrepare = true;
    }
  }};
  return {Lightmapper:Lightmapper, MASK_DYNAMIC:maskDynamic, MASK_BAKED:maskBaked, MASK_LIGHTMAP:maskLightmap};
}());
pc.extend(pc, function() {
  var Batch = function(meshInstances, dynamic, batchGroupId) {
    this.origMeshInstances = meshInstances;
    this._aabb = new pc.BoundingBox;
    this.meshInstance = null;
    this.model = null;
    this.dynamic = dynamic;
    this.batchGroupId = batchGroupId;
  };
  var BatchGroup = function(id, name, dynamic, maxAabbSize) {
    this.dynamic = dynamic;
    this.maxAabbSize = maxAabbSize;
    this.id = id;
    this.name = name;
  };
  var SkinBatchInstance = function(device, nodes, rootNode) {
    this.device = device;
    this.rootNode = rootNode;
    this._dirty = true;
    this.bones = nodes;
    var numBones = nodes.length;
    if (device.supportsBoneTextures) {
      var size;
      if (numBones > 256) {
        size = 64;
      } else {
        if (numBones > 64) {
          size = 32;
        } else {
          if (numBones > 16) {
            size = 16;
          } else {
            size = 8;
          }
        }
      }
      this.boneTexture = new pc.Texture(device, {width:size, height:size, format:pc.PIXELFORMAT_RGBA32F, mipmaps:false, minFilter:pc.FILTER_NEAREST, magFilter:pc.FILTER_NEAREST});
      this.matrixPalette = this.boneTexture.lock();
    } else {
      this.matrixPalette = new Float32Array(numBones * 16);
    }
  };
  SkinBatchInstance.prototype = {updateMatrices:function() {
  }, updateMatrixPalette:function() {
    var pe;
    var mp = this.matrixPalette;
    var base;
    for (var i = this.bones.length - 1;i >= 0;i--) {
      pe = this.bones[i].getWorldTransform().data;
      base = i * 16;
      mp[base] = pe[0];
      mp[base + 1] = pe[1];
      mp[base + 2] = pe[2];
      mp[base + 3] = pe[3];
      mp[base + 4] = pe[4];
      mp[base + 5] = pe[5];
      mp[base + 6] = pe[6];
      mp[base + 7] = pe[7];
      mp[base + 8] = pe[8];
      mp[base + 9] = pe[9];
      mp[base + 10] = pe[10];
      mp[base + 11] = pe[11];
      mp[base + 12] = pe[12];
      mp[base + 13] = pe[13];
      mp[base + 14] = pe[14];
      mp[base + 15] = pe[15];
    }
    if (this.device.supportsBoneTextures) {
      this.boneTexture.lock();
      this.boneTexture.unlock();
    }
  }};
  var BatchManager = function(device, root, scene) {
    this.device = device;
    this.rootNode = root;
    this.scene = scene;
    this._init = false;
    this._batchGroups = {};
    this._batchGroupCounter = 0;
    this._batchList = [];
    this._dirtyGroups = [];
  };
  BatchManager.prototype.addGroup = function(name, dynamic, maxAabbSize, id) {
    if (id === undefined) {
      id = this._batchGroupCounter;
      this._batchGroupCounter++;
    }
    if (this._batchGroups[id]) {
      return;
    }
    var group;
    this._batchGroups[id] = group = new pc.BatchGroup(id, name, dynamic, maxAabbSize);
    return group;
  };
  BatchManager.prototype.removeGroup = function(id) {
    if (!this._batchGroups[id]) {
      return;
    }
    var newBatchList = [];
    for (var i = 0;i < this._batchList.length;i++) {
      if (this._batchList[i].batchGroupId !== id) {
        newBatchList.push(this._batchList[i]);
        continue;
      }
      this._batchList[i].refCounter = 1;
      this.destroy(this._batchList[i]);
    }
    this._batchList = newBatchList;
    this._removeModelsFromBatchGroup(this.rootNode, id);
    delete this._batchGroups[id];
  };
  BatchManager.prototype._removeModelsFromBatchGroup = function(node, id) {
    if (!node.enabled) {
      return;
    }
    if (node.model && node.model.batchGroupId === id) {
      node.model.batchGroupId = -1;
    }
    if (node.element && node.element.batchGroupId === id) {
      node.element.batchGroupId = -1;
    }
    for (var i = 0;i < node._children.length;i++) {
      this._removeModelsFromBatchGroup(node._children[i], id);
    }
  };
  BatchManager.prototype._collectAndRemoveModels = function(node, groupMeshInstances, groupIds) {
    if (!node.enabled) {
      return;
    }
    var i;
    if (node.model && node.model.batchGroupId >= 0 && node.model.model && node.model.enabled) {
      if (!groupIds || groupIds && groupIds.indexOf(node.model.batchGroupId) >= 0) {
        var arr = groupMeshInstances[node.model.batchGroupId];
        if (!arr) {
          arr = groupMeshInstances[node.model.batchGroupId] = [];
        }
        if (node.model.isStatic) {
          var drawCalls = this.scene.drawCalls;
          var nodeMeshInstances = node.model.meshInstances;
          for (i = 0;i < drawCalls.length;i++) {
            if (!drawCalls[i]._staticSource) {
              continue;
            }
            if (nodeMeshInstances.indexOf(drawCalls[i]._staticSource) < 0) {
              continue;
            }
            groupMeshInstances[node.model.batchGroupId].push(drawCalls[i]);
          }
          for (i = 0;i < nodeMeshInstances.length;i++) {
            if (drawCalls.indexOf(nodeMeshInstances[i]) >= 0) {
              groupMeshInstances[node.model.batchGroupId].push(nodeMeshInstances[i]);
            }
          }
        } else {
          groupMeshInstances[node.model.batchGroupId] = arr.concat(node.model.meshInstances);
        }
        this.scene.removeModel(node.model.model);
      }
    }
    if (node.element && node.element.batchGroupId >= 0 && node.element.enabled) {
      if (!groupIds || groupIds && groupIds.indexOf(node.element.batchGroupId) >= 0) {
        var arr = groupMeshInstances[node.element.batchGroupId];
        if (!arr) {
          arr = groupMeshInstances[node.element.batchGroupId] = [];
        }
        var valid = false;
        if (node.element._text) {
          groupMeshInstances[node.element.batchGroupId].push(node.element._text._model.meshInstances[0]);
          this.scene.removeModel(node.element._text._model);
          valid = true;
        } else {
          if (node.element._image) {
            groupMeshInstances[node.element.batchGroupId].push(node.element._image._model.meshInstances[0]);
            this.scene.removeModel(node.element._image._model);
            valid = true;
          }
        }
      }
    }
    for (i = 0;i < node._children.length;i++) {
      this._collectAndRemoveModels(node._children[i], groupMeshInstances, groupIds);
    }
  };
  BatchManager.prototype._markGroupDirty = function(id) {
    if (this._dirtyGroups.indexOf(id) < 0) {
      this._dirtyGroups.push(id);
    }
  };
  BatchManager.prototype._registerEntities = function(batch, meshInstances) {
    var node;
    var ents = [];
    for (var i = 0;i < meshInstances.length;i++) {
      node = meshInstances[i].node;
      while (!node._app && node._parent) {
        node = node._parent;
      }
      if (!node._app) {
        continue;
      }
      ents.push(node);
    }
    this.register(batch, ents);
  };
  BatchManager.prototype.generate = function(groupIds) {
    var i;
    var groupMeshInstances = {};
    if (!groupIds) {
      for (i = 0;i < this._batchList.length;i++) {
        this._batchList[i].refCounter = 1;
        this.destroy(this._batchList[i]);
      }
      this._batchList.length = 0;
      this._collectAndRemoveModels(this.rootNode, groupMeshInstances);
    } else {
      var newBatchList = [];
      for (i = 0;i < this._batchList.length;i++) {
        if (groupIds.indexOf(this._batchList[i].batchGroupId) < 0) {
          newBatchList.push(this._batchList[i]);
          continue;
        }
        this._batchList[i].refCounter = 1;
        this.destroy(this._batchList[i]);
      }
      this._batchList = newBatchList;
      this._collectAndRemoveModels(this.rootNode, groupMeshInstances, groupIds);
    }
    var group, lists, groupData, batch;
    for (var groupId in groupMeshInstances) {
      if (!groupMeshInstances.hasOwnProperty(groupId)) {
        continue;
      }
      group = groupMeshInstances[groupId];
      groupData = this._batchGroups[groupId];
      if (!groupData) {
        continue;
      }
      lists = this.prepare(group, groupData.dynamic, groupData.maxAabbSize);
      for (i = 0;i < lists.length;i++) {
        batch = this.create(lists[i], groupData.dynamic, parseInt(groupId));
        this.scene.addModel(batch.model);
        this._registerEntities(batch, lists[i]);
      }
    }
  };
  BatchManager.prototype.getGroupByName = function(name) {
    var groups = this._batchGroups;
    for (var group in groups) {
      if (!groups.hasOwnProperty(group)) {
        continue;
      }
      if (groups[group].name === name) {
        return groups[group];
      }
    }
    return null;
  };
  function paramsIdentical(a, b) {
    if (a && !b) {
      return false;
    }
    if (!a && b) {
      return false;
    }
    a = a.data;
    b = b.data;
    if (a === b) {
      return true;
    }
    if (a instanceof Float32Array && b instanceof Float32Array) {
      if (a.length !== b.length) {
        return false;
      }
      for (var i = 0;i < a.length;i++) {
        if (a[i] !== b[i]) {
          return false;
        }
      }
      return true;
    }
    return false;
  }
  BatchManager.prototype.prepare = function(meshInstances, dynamic, maxAabbSize) {
    if (meshInstances.length === 0) {
      return [];
    }
    if (maxAabbSize === undefined) {
      maxAabbSize = Number.POSITIVE_INFINITY;
    }
    var halfMaxAabbSize = maxAabbSize * 0.5;
    var maxInstanceCount = this.device.supportsBoneTextures ? 1024 : this.device.boneLimit;
    var i;
    var material, layer, vertCount, params, params2, param, paramFailed, lightList, defs;
    var aabb = new pc.BoundingBox;
    var testAabb = new pc.BoundingBox;
    var lists = [];
    var j = 0;
    var meshInstancesLeftA = meshInstances;
    var meshInstancesLeftB;
    var k;
    while (meshInstancesLeftA.length > 0) {
      lists[j] = [];
      meshInstancesLeftB = [];
      material = meshInstancesLeftA[0].material;
      layer = meshInstancesLeftA[0].layer;
      defs = meshInstancesLeftA[0]._shaderDefs;
      params = meshInstancesLeftA[0].parameters;
      lightList = meshInstancesLeftA[0]._staticLightList;
      vertCount = meshInstancesLeftA[0].mesh.vertexBuffer.getNumVertices();
      aabb.copy(meshInstancesLeftA[0].aabb);
      for (i = 0;i < meshInstancesLeftA.length;i++) {
        if (i > 0) {
          if (material !== meshInstancesLeftA[i].material) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          if (layer !== meshInstancesLeftA[i].layer) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          if (defs !== meshInstancesLeftA[i]._shaderDefs) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          if (vertCount + meshInstancesLeftA[i].mesh.vertexBuffer.getNumVertices() > 65535) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          testAabb.copy(aabb);
          testAabb.add(meshInstancesLeftA[i].aabb);
          if (testAabb.halfExtents.x > halfMaxAabbSize || testAabb.halfExtents.y > halfMaxAabbSize || testAabb.halfExtents.z > halfMaxAabbSize) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          params2 = meshInstancesLeftA[i].parameters;
          paramFailed = false;
          for (param in params) {
            if (!params.hasOwnProperty(param)) {
              continue;
            }
            if (!paramsIdentical(params[param], params2[param])) {
              paramFailed = true;
              break;
            }
          }
          if (!paramFailed) {
            for (param in params2) {
              if (!params2.hasOwnProperty(param)) {
                continue;
              }
              if (!paramsIdentical(params2[param], params[param])) {
                paramFailed = true;
                break;
              }
            }
          }
          if (paramFailed) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          params2 = meshInstancesLeftA[i]._staticLightList;
          if (lightList && !params2 || !lightList && params2) {
            meshInstancesLeftB.push(meshInstancesLeftA[i]);
            continue;
          }
          if (lightList && params2) {
            paramFailed = false;
            for (k = 0;k < lightList.length;k++) {
              if (params2.indexOf(lightList[k]) < 0) {
                paramFailed = true;
                break;
              }
            }
            for (k = 0;k < params2.length;k++) {
              if (lightList.indexOf(params2[k]) < 0) {
                paramFailed = true;
                break;
              }
            }
            if (paramFailed) {
              meshInstancesLeftB.push(meshInstancesLeftA[i]);
              continue;
            }
          }
        }
        aabb.add(meshInstancesLeftA[i].aabb);
        vertCount += meshInstancesLeftA[i].mesh.vertexBuffer.getNumVertices();
        lists[j].push(meshInstancesLeftA[i]);
        if (dynamic && lists[j].length === maxInstanceCount) {
          if (i === meshInstancesLeftA.length) {
            meshInstancesLeftB = [];
          } else {
            meshInstancesLeftB = meshInstancesLeftA.slice(i + 1);
          }
          break;
        }
      }
      j++;
      meshInstancesLeftA = meshInstancesLeftB;
    }
    return lists;
  };
  BatchManager.prototype.create = function(meshInstances, dynamic, batchGroupId) {
    if (!this._init) {
      var boneLimit = "#define BONE_LIMIT " + this.device.getBoneLimit() + "\n";
      this.transformVS = boneLimit + pc.shaderChunks.transformBatchSkinnedVS;
      this.transformElementVS = boneLimit + pc.shaderChunks.transformScreenSpaceBatchSkinnedVS;
      this.skinTexVS = pc.shaderChunks.skinBatchTexVS;
      this.skinConstVS = pc.shaderChunks.skinBatchConstVS;
      this.vertexFormats = {};
      this._init = true;
    }
    var i, j;
    var batch = new pc.Batch(meshInstances, dynamic, batchGroupId);
    this._batchList.push(batch);
    var material = null;
    var mesh, elems, numVerts, vertSize, index;
    var hasPos, hasNormal, hasUv, hasUv2, hasTangent;
    var batchNumVerts = 0;
    var batchNumIndices = 0;
    for (i = 0;i < meshInstances.length;i++) {
      if (!material) {
        material = meshInstances[i].material;
      } else {
        if (material !== meshInstances[i].material) {
          return;
        }
      }
      mesh = meshInstances[i].mesh;
      elems = mesh.vertexBuffer.format.elements;
      numVerts = mesh.vertexBuffer.numVertices;
      batchNumVerts += numVerts;
      for (j = 0;j < elems.length;j++) {
        if (elems[j].name === pc.SEMANTIC_POSITION) {
          hasPos = true;
        } else {
          if (elems[j].name === pc.SEMANTIC_NORMAL) {
            hasNormal = true;
          } else {
            if (elems[j].name === pc.SEMANTIC_TEXCOORD0) {
              hasUv = true;
            } else {
              if (elems[j].name === pc.SEMANTIC_TEXCOORD1) {
                hasUv2 = true;
              } else {
                if (elems[j].name === pc.SEMANTIC_TANGENT) {
                  hasTangent = true;
                }
              }
            }
          }
        }
      }
      batchNumIndices += mesh.primitive[0].count;
    }
    if (!hasPos) {
      return;
    }
    var entityIndexSizeF = dynamic ? 1 : 0;
    var batchVertSizeF = 3 + (hasNormal ? 3 : 0) + (hasUv ? 2 : 0) + (hasUv2 ? 2 : 0) + (hasTangent ? 4 : 0) + entityIndexSizeF;
    var batchOffsetNF = 3;
    var batchOffsetUF = hasNormal ? 3 * 2 : 3;
    var batchOffsetU2F = (hasNormal ? 3 * 2 : 3) + (hasUv ? 2 : 0);
    var batchOffsetTF = (hasNormal ? 3 * 2 : 3) + (hasUv ? 2 : 0) + (hasUv2 ? 2 : 0);
    var batchOffsetEF = (hasNormal ? 3 * 2 : 3) + (hasUv ? 2 : 0) + (hasUv2 ? 2 : 0) + (hasTangent ? 4 : 0);
    var batchData = new Float32Array(new ArrayBuffer(batchNumVerts * batchVertSizeF * 4));
    var indexBuffer = new pc.IndexBuffer(this.device, pc.INDEXFORMAT_UINT16, batchNumIndices, pc.BUFFER_STATIC);
    var batchIndexData = new Uint16Array(indexBuffer.lock());
    var matrices = new Float32Array(meshInstances.length * 16);
    var vertSizeF;
    var data, indexBase, numIndices, indexData, mtx;
    var verticesOffset = 0;
    var indexOffset = 0;
    var vbOffset = 0;
    var offsetPF, offsetNF, offsetUF, offsetU2F, offsetTF;
    var transform, vec, vecData;
    if (!dynamic) {
      vec = new pc.Vec3;
      vecData = vec.data;
    }
    for (i = 0;i < meshInstances.length;i++) {
      mesh = meshInstances[i].mesh;
      elems = mesh.vertexBuffer.format.elements;
      numVerts = mesh.vertexBuffer.numVertices;
      vertSize = mesh.vertexBuffer.format.size;
      vertSizeF = vertSize / 4;
      for (j = 0;j < elems.length;j++) {
        if (elems[j].name === pc.SEMANTIC_POSITION) {
          offsetPF = elems[j].offset / 4;
        } else {
          if (elems[j].name === pc.SEMANTIC_NORMAL) {
            offsetNF = elems[j].offset / 4;
          } else {
            if (elems[j].name === pc.SEMANTIC_TEXCOORD0) {
              offsetUF = elems[j].offset / 4;
            } else {
              if (elems[j].name === pc.SEMANTIC_TEXCOORD1) {
                offsetU2F = elems[j].offset / 4;
              } else {
                if (elems[j].name === pc.SEMANTIC_TANGENT) {
                  offsetTF = elems[j].offset / 4;
                }
              }
            }
          }
        }
      }
      data = new Float32Array(mesh.vertexBuffer.storage);
      if (dynamic) {
        for (j = 0;j < numVerts;j++) {
          batchData[j * batchVertSizeF + vbOffset] = data[j * vertSizeF + offsetPF];
          batchData[j * batchVertSizeF + vbOffset + 1] = data[j * vertSizeF + offsetPF + 1];
          batchData[j * batchVertSizeF + vbOffset + 2] = data[j * vertSizeF + offsetPF + 2];
          if (hasNormal) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF] = data[j * vertSizeF + offsetNF];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF + 1] = data[j * vertSizeF + offsetNF + 1];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF + 2] = data[j * vertSizeF + offsetNF + 2];
          }
          if (hasUv) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetUF] = data[j * vertSizeF + offsetUF];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetUF + 1] = data[j * vertSizeF + offsetUF + 1];
          }
          if (hasUv2) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetU2F] = data[j * vertSizeF + offsetU2F];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetU2F + 1] = data[j * vertSizeF + offsetU2F + 1];
          }
          if (hasTangent) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF] = data[j * vertSizeF + offsetTF];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 1] = data[j * vertSizeF + offsetTF + 1];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 2] = data[j * vertSizeF + offsetTF + 2];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 3] = data[j * vertSizeF + offsetTF + 3];
          }
          batchData[j * batchVertSizeF + batchOffsetEF + vbOffset] = i;
        }
      } else {
        transform = meshInstances[i].node.getWorldTransform();
        for (j = 0;j < numVerts;j++) {
          vec.set(data[j * vertSizeF + offsetPF], data[j * vertSizeF + offsetPF + 1], data[j * vertSizeF + offsetPF + 2]);
          transform.transformPoint(vec, vec);
          batchData[j * batchVertSizeF + vbOffset] = vecData[0];
          batchData[j * batchVertSizeF + vbOffset + 1] = vecData[1];
          batchData[j * batchVertSizeF + vbOffset + 2] = vecData[2];
          if (hasNormal) {
            vec.set(data[j * vertSizeF + offsetNF], data[j * vertSizeF + offsetNF + 1], data[j * vertSizeF + offsetNF + 2]);
            transform.transformVector(vec, vec);
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF] = vecData[0];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF + 1] = vecData[1];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetNF + 2] = vecData[2];
          }
          if (hasUv) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetUF] = data[j * vertSizeF + offsetUF];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetUF + 1] = data[j * vertSizeF + offsetUF + 1];
          }
          if (hasUv2) {
            batchData[j * batchVertSizeF + vbOffset + batchOffsetU2F] = data[j * vertSizeF + offsetU2F];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetU2F + 1] = data[j * vertSizeF + offsetU2F + 1];
          }
          if (hasTangent) {
            vec.set(data[j * vertSizeF + offsetTF], data[j * vertSizeF + offsetTF + 1], data[j * vertSizeF + offsetTF + 2]);
            transform.transformVector(vec, vec);
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF] = vecData[0];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 1] = vecData[1];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 2] = vecData[2];
            batchData[j * batchVertSizeF + vbOffset + batchOffsetTF + 3] = data[j * vertSizeF + offsetTF + 3];
          }
        }
      }
      indexBase = mesh.primitive[0].base;
      numIndices = mesh.primitive[0].count;
      indexData = new Uint16Array(mesh.indexBuffer[0].storage);
      for (j = 0;j < numIndices;j++) {
        batchIndexData[j + indexOffset] = indexData[indexBase + j] + verticesOffset;
      }
      indexOffset += numIndices;
      verticesOffset += numVerts;
      vbOffset = verticesOffset * batchVertSizeF;
    }
    var vertexFormatId = 0;
    if (hasNormal) {
      vertexFormatId |= 1 << 1;
    }
    if (hasUv) {
      vertexFormatId |= 1 << 2;
    }
    if (hasUv2) {
      vertexFormatId |= 1 << 3;
    }
    if (hasTangent) {
      vertexFormatId |= 1 << 4;
    }
    if (dynamic) {
      vertexFormatId |= 1 << 5;
    }
    var vertexFormat = this.vertexFormats[vertexFormatId];
    if (!vertexFormat) {
      var formatDesc = [];
      formatDesc.push({semantic:pc.SEMANTIC_POSITION, components:3, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      if (hasNormal) {
        formatDesc.push({semantic:pc.SEMANTIC_NORMAL, components:3, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      }
      if (hasUv) {
        formatDesc.push({semantic:pc.SEMANTIC_TEXCOORD0, components:2, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      }
      if (hasUv2) {
        formatDesc.push({semantic:pc.SEMANTIC_TEXCOORD1, components:2, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      }
      if (hasTangent) {
        formatDesc.push({semantic:pc.SEMANTIC_TANGENT, components:4, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      }
      if (dynamic) {
        formatDesc.push({semantic:pc.SEMANTIC_BLENDINDICES, components:1, type:pc.ELEMENTTYPE_FLOAT32, normalize:false});
      }
      vertexFormat = this.vertexFormats[vertexFormatId] = new pc.VertexFormat(this.device, formatDesc);
    }
    var vertexBuffer = new pc.VertexBuffer(this.device, vertexFormat, batchNumVerts, pc.BUFFER_STATIC, batchData.buffer);
    indexBuffer.unlock();
    mesh = new pc.Mesh;
    mesh.vertexBuffer = vertexBuffer;
    mesh.indexBuffer[0] = indexBuffer;
    mesh.primitive[0].type = batch.origMeshInstances[0].mesh.primitive[0].type;
    mesh.primitive[0].base = 0;
    mesh.primitive[0].count = batchNumIndices;
    mesh.primitive[0].indexed = true;
    mesh.cull = false;
    if (dynamic) {
      material = material.clone();
      material.chunks.transformSkinnedVS = batch.origMeshInstances[0]._shaderDefs & pc.SHADERDEF_SCREENSPACE ? this.transformElementVS : this.transformVS;
      material.chunks.skinTexVS = this.skinTexVS;
      material.chunks.skinConstVS = this.skinConstVS;
      material.update();
    }
    var meshInstance = new pc.MeshInstance(this.rootNode, mesh, material);
    meshInstance.castShadow = batch.origMeshInstances[0].castShadow;
    meshInstance.parameters = batch.origMeshInstances[0].parameters;
    meshInstance.isStatic = batch.origMeshInstances[0].isStatic;
    meshInstance._staticLightList = batch.origMeshInstances[0]._staticLightList;
    if (dynamic) {
      var nodes = [];
      for (i = 0;i < batch.origMeshInstances.length;i++) {
        nodes.push(batch.origMeshInstances[i].node);
      }
      meshInstance.skinInstance = new SkinBatchInstance(this.device, nodes, this.rootNode);
    }
    meshInstance._updateAabb = false;
    batch.meshInstance = meshInstance;
    this.update(batch);
    var newModel = new pc.Model;
    newModel.meshInstances = [batch.meshInstance];
    newModel.castShadows = batch.origMeshInstances[0].castShadows;
    batch.model = newModel;
    return batch;
  };
  BatchManager.prototype.update = function(batch) {
    batch._aabb.copy(batch.origMeshInstances[0].aabb);
    for (var i = 0;i < batch.origMeshInstances.length;i++) {
      if (i > 0) {
        batch._aabb.add(batch.origMeshInstances[i].aabb);
      }
    }
    batch.meshInstance.aabb = batch._aabb;
    batch._aabb._radiusVer = -1;
    batch.meshInstance._aabbVer = 0;
  };
  BatchManager.prototype.updateAll = function() {
    if (this._dirtyGroups.length > 0) {
      this.generate(this._dirtyGroups);
      this._dirtyGroups.length = 0;
    }
    for (var i = 0;i < this._batchList.length;i++) {
      if (!this._batchList[i].dynamic) {
        continue;
      }
      this.update(this._batchList[i]);
    }
  };
  BatchManager.prototype.clone = function(batch, clonedMeshInstances) {
    var batch2 = new pc.Batch(clonedMeshInstances, batch.dynamic, batch.batchGroupId);
    this._batchList.push(batch2);
    var nodes = [];
    for (var i = 0;i < clonedMeshInstances.length;i++) {
      nodes.push(clonedMeshInstances[i].node);
    }
    batch2.meshInstance = new pc.MeshInstance(batch.meshInstance.node, batch.meshInstance.mesh, batch.meshInstance.material);
    batch2.meshInstance._updateAabb = false;
    batch2.meshInstance.parameters = clonedMeshInstances[0].parameters;
    batch2.meshInstance.isStatic = clonedMeshInstances[0].isStatic;
    batch2.meshInstance._staticLightList = clonedMeshInstances[0]._staticLightList;
    if (batch.dynamic) {
      batch2.meshInstance.skinInstance = new SkinBatchInstance(this.device, nodes, this.rootNode);
    }
    batch2.meshInstance.castShadow = batch.meshInstance.castShadow;
    batch2.meshInstance._shader = batch.meshInstance._shader;
    var newModel = new pc.Model;
    newModel.meshInstances = [batch2.meshInstance];
    newModel.castShadows = batch.origMeshInstances[0].castShadows;
    batch2.model = newModel;
    return batch2;
  };
  BatchManager.prototype.destroy = function(batch) {
    batch.refCounter--;
    if (batch.refCounter === 0) {
      this.scene.removeModel(batch.model);
      batch.model.destroy();
    }
  };
  BatchManager.prototype.register = function(batch, entities) {
    batch.refCounter = entities.length;
    var self = this;
    var callback = function() {
      self.destroy(batch);
    };
    for (var i = 0;i < entities.length;i++) {
      entities[i].once("destroy", callback);
    }
  };
  return {Batch:Batch, BatchGroup:BatchGroup, BatchManager:BatchManager};
}());


/***/ })
/******/ ]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAgMzgxYjkxMThmYjE3ODRmMzFjNmYiLCJ3ZWJwYWNrOi8vLy4vanMvYXBwLmpzIiwid2VicGFjazovLy8uL2pzL2V4dGVybmFsL3BsYXljYW52YXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOzs7QUFHQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFLO0FBQ0w7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxtQ0FBMkIsMEJBQTBCLEVBQUU7QUFDdkQseUNBQWlDLGVBQWU7QUFDaEQ7QUFDQTtBQUNBOztBQUVBO0FBQ0EsOERBQXNELCtEQUErRDs7QUFFckg7QUFDQTs7QUFFQTtBQUNBOzs7Ozs7OztBQzdEQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLHVDQUF1QyxFQUFFO0FBQ3pDOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxDQUFDOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQzs7Ozs7OztBQ3hCRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxnREFBZ0QsV0FBVyxTQUFTLFNBQVM7QUFDdkY7QUFDQSxDQUFDO0FBQ0Q7QUFDQSxhQUFhLFdBQVc7QUFDeEI7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakMsS0FBSztBQUNMO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsaUJBQWlCO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBLGlCQUFpQixvREFBb0Q7QUFDckU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBLHlEQUF5RDtBQUN6RDtBQUNBLHNDQUFzQyxTQUFTO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBLHVEQUF1RDtBQUN2RDtBQUNBLHNDQUFzQyxTQUFTO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMERBQTBEO0FBQzFEO0FBQ0EsTUFBTTtBQUNOO0FBQ0E7QUFDQSwwREFBMEQ7QUFDMUQ7QUFDQSxNQUFNO0FBQ047QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQztBQUMvQztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSiwrQ0FBK0M7QUFDL0M7QUFDQSxHQUFHO0FBQ0g7QUFDQSxJQUFJO0FBQ0osK0NBQStDO0FBQy9DO0FBQ0EsR0FBRztBQUNIO0FBQ0EsSUFBSTtBQUNKLCtDQUErQztBQUMvQztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQSxhQUFhO0FBQ2I7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixnQkFBZ0I7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIscUJBQXFCO0FBQ3RDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBLGVBQWUsZ0JBQWdCO0FBQy9CLDhCQUE4QixZQUFZO0FBQzFDO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsdUJBQXVCLGVBQWU7QUFDckY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRCxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIsdUNBQXVDO0FBQ3JFO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixrR0FBa0c7QUFDbkg7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0EsbUJBQW1CLGdCQUFnQjtBQUNuQztBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsbUJBQW1CLGdCQUFnQjtBQUNuQztBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMEJBQTBCO0FBQzFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsZ0JBQWdCO0FBQy9CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EscUJBQXFCLGVBQWU7QUFDcEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUIscUNBQXFDO0FBQzFEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixpQ0FBaUM7QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9CQUFvQjtBQUNwQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLGdCQUFnQjtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixnQkFBZ0I7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixnQkFBZ0I7QUFDbkM7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixnQkFBZ0I7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQSx1QkFBdUIsbUJBQW1CO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLGdCQUFnQjtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBLHVCQUF1QixtQkFBbUI7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaURBQWlEO0FBQ2pEO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0QkFBNEI7QUFDNUI7QUFDQSxxQ0FBcUMsU0FBUztBQUM5QztBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQSxrQkFBa0I7QUFDbEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1YsQ0FBQztBQUNELFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CO0FBQ3BCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsOENBQThDO0FBQzlDO0FBQ0EsR0FBRztBQUNIO0FBQ0EsSUFBSTtBQUNKLDhDQUE4QztBQUM5QztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSixzQ0FBc0M7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTix3Q0FBd0M7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTixxQ0FBcUM7QUFDckM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTix1Q0FBdUM7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsOENBQThDO0FBQzlDO0FBQ0EsR0FBRztBQUNIO0FBQ0EsSUFBSTtBQUNKLDhDQUE4QztBQUM5QztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSiw4Q0FBOEM7QUFDOUM7QUFDQSxHQUFHO0FBQ0g7QUFDQSxJQUFJO0FBQ0osdUNBQXVDO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sdUNBQXVDO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sMENBQTBDO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sdUNBQXVDO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sc0NBQXNDO0FBQ3RDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sd0NBQXdDO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04scUNBQXFDO0FBQ3JDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sdUNBQXVDO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLDhDQUE4QztBQUM5QztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSiw4Q0FBOEM7QUFDOUM7QUFDQSxHQUFHO0FBQ0g7QUFDQSxJQUFJO0FBQ0osOENBQThDO0FBQzlDO0FBQ0EsR0FBRztBQUNIO0FBQ0EsSUFBSTtBQUNKLDhDQUE4QztBQUM5QztBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSixzQ0FBc0M7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTix1Q0FBdUM7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxtQkFBbUIsTUFBTTtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDO0FBQzNDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sdUNBQXVDO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRyxHQUFHO0FBQ04sVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLGVBQWUsT0FBTztBQUN0QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkM7QUFDM0M7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTix1Q0FBdUM7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHLEdBQUc7QUFDTixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9CQUFvQjtBQUNwQjtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLDJDQUEyQztBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUcsR0FBRztBQUNOLHVDQUF1QztBQUN2QztBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUcsR0FBRztBQUNOLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFB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QUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsTUFBTTtBQUN6QjtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxlQUFlLE1BQU07QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsYUFBYTtBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLE1BQU07QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSw0QkFBNEI7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkJBQTJCO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FB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O0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxRQUFRO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzQkFBc0I7QUFDdEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixTQUFTO0FBQzVCO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixpQkFBaUI7QUFDdEM7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQztBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixtQkFBbUI7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUNBQW1DLHlCQUF5QjtBQUM1RDtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEIsMkJBQTJCO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRDQUE0QyxnSUFBZ0k7QUFDNUssdURBQXVELFlBQVk7QUFDbkU7QUFDQSw2Q0FBNkMsb0lBQW9JO0FBQ2pMLHlEQUF5RCxZQUFZO0FBQ3JFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsOEJBQThCO0FBQzlCO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZTtBQUNmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLG1CQUFtQixPQUFPO0FBQzFCO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLFNBQVM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0Esd0JBQXdCLFNBQVM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsTUFBTTtBQUM3QjtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxRQUFRO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNDQUFzQyxRQUFRO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxtQkFBbUIsZ0JBQWdCO0FBQ25DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzQ0FBc0MsUUFBUTtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtB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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7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O0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsTUFBTTtBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlLFlBQVk7QUFDM0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlLFlBQVk7QUFDM0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsWUFBWTtBQUMzQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLG1CQUFtQjtBQUNwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxtQkFBbUI7QUFDbEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxlQUFlLG1CQUFtQjtBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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O0FBQ0EsZUFBZSxtQkFBbUI7QUFDbEM7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsZUFBZTtBQUNmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWU7QUFDZjtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxrQkFBa0I7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFD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QUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxlQUFlLFdBQVc7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlLFdBQVc7QUFDMUI7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLDBCQUEwQjtBQUM3QztBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsTUFBTTtBQUN6QjtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsY0FBYztBQUNyQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFD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MkI7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxtQkFBbUIsaUJBQWlCO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsdUJBQXVCO0FBQ3RDO0FBQ0E7QUFDQSxpQkFBaUIsTUFBTTtBQUN2QjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0Es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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixRQUFRO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixjQUFjO0FBQ2pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixjQUFjO0FBQ2pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsZUFBZTtBQUNoQyxtQkFBbUIsZUFBZTtBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxjQUFjO0FBQzdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLHNCQUFzQjtBQUN2QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGVBQWU7QUFDZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVCQUF1QiwwQkFBMEI7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzQkFBc0I7QUFDekM7QUFDQTtBQUNBLG1CQUFtQixzQkFBc0I7QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCxtQkFBbUIsc0JBQXNCO0FBQ3pDO0FBQ0EsOEJBQThCLCtCQUErQjtBQUM3RCx1QkFBdUIsTUFBTTtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsbUJBQW1CO0FBQ3RDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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TDtBQUNBO0FBQ0E7QUFDQSxzREFBc0Q7QUFDdEQ7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0osVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0I7QUFDeEI7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQjtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4REFBOEQ7QUFDOUQ7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTiw2REFBNkQ7QUFDN0Q7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ04sNERBQTREO0FBQzVEO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOLDZEQUE2RDtBQUM3RDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLE1BQU07QUFDTixtRUFBbUU7QUFDbkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ04sR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUCxPQUFPO0FBQ1AsT0FBTztBQUNQO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0VBQWdFO0FBQ2hFO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1IsK0RBQStEO0FBQy9EO0FBQ0Es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QUNBLFFBQVE7QUFDUixLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkJBQTJCO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQ0FBZ0M7QUFDaEM7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0osVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMERBQTBEO0FBQzFEO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ04sR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxlQUFlO0FBQ2Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNERBQTREO0FBQzVEO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxPQUFPO0FBQ1A7QUFDQSxRQUFRO0FBQ1IsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBLGVBQWU7QUFDZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0Esa0JBQWtCO0FBQ2xCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLG1CQUFtQjtBQUN0QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWMsU0FBUyxnV0FBZ1csT0FBTztBQUM5WDtBQUNBLHVCQUF1QjtBQUN2Qix3QkFBd0I7QUFDeEI7QUFDQTtBQUNBLHdDQUF3QyxNQUFNO0FBQzlDO0FBQ0E7QUFDQSxpQkFBaUIsZUFBZTtBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQyxNQUFNO0FBQ3RDO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsUUFBUTtBQUN6QjtBQUNBLHFCQUFxQixrREFBa0Q7QUFDdkU7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLE1BQU07QUFDdkI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLE1BQU07QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQSwwQkFBMEI7QUFDMUI7QUFDQSxlQUFlLE1BQU07QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkI7QUFDM0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsWUFBWTtBQUNaLEdBQUc7QUFDSCxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsRUFBRTtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLG1DQUFtQztBQUNyRSxLQUFLO0FBQ0wsZ0NBQWdDLG1DQUFtQztBQUNuRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQyxvQ0FBb0M7QUFDdEUsS0FBSztBQUNMLGdDQUFnQyxxQ0FBcUM7QUFDckU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQ0FBa0MsK0NBQStDO0FBQ2pGLEtBQUs7QUFDTCxnQ0FBZ0MsK0NBQStDO0FBQy9FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLGVBQWU7QUFDbEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVCQUF1QixRQUFRO0FBQy9CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsZUFBZTtBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLFFBQVE7QUFDL0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFFBQVE7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRCQUE0QjtBQUM1QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5REFBeUQsYUFBYTtBQUN0RSw2REFBNkQsYUFBYTtBQUMxRSw2REFBNkQsYUFBYTtBQUMxRSwrREFBK0QsYUFBYTtBQUM1RSxtRUFBbUUsYUFBYTtBQUNoRjtBQUNBLDRFQUE0RSxhQUFhO0FBQ3pGLHdFQUF3RSxhQUFhO0FBQ3JGO0FBQ0EsOEVBQThFLGFBQWE7QUFDM0Y7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxvQ0FBb0MsT0FBTztBQUMzQztBQUNBO0FBQ0Esd0RBQXdELFFBQVE7QUFDaEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsUUFBUTtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsT0FBTztBQUMvQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLHNEQUFzRCxRQUFRO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQ0FBb0MsT0FBTztBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxZQUFZO0FBQ1osR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxnREFBZ0QsUUFBUTtBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdEQUF3RDtBQUN4RDtBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQLHVCQUF1QixvQkFBb0I7QUFDM0M7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixNQUFNO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUCxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQywyQkFBMkI7QUFDN0Q7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FB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Q1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0I7QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDO0FBQzNDO0FBQ0EsR0FBRztBQUNIO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJCQUEyQjtBQUMzQjtBQUNBO0FBQ0E7QUFD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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLFFBQVE7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLGlCQUFpQjtBQUNwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FB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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsMEJBQTBCO0FBQzFCO0FBQ0E7QUFDQTtBQUNBLDBCQUEwQjtBQUMxQjtBQUNBO0FBQ0E7QUFDQSwwQkFBMEI7QUFDMUI7QUFDQTtBQUNBO0FBQ0EsMEJBQTBCO0FBQzFCO0FBQ0E7QUFDQTtBQUNBLDBCQUEwQjtBQUMxQjtBQUNBO0FBQ0E7QUFDQSwwQkFBMEI7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQix5QkFBeUI7QUFDOUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNILEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFt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O0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1QsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxJQUFJO0FBQ0osVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhDQUE4QztBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsS0FBSztBQUNMLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsMkNBQTJDLFFBQVE7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsMkNBQTJDLFFBQVE7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsMkNBQTJDLFFBQVE7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLFFBQVE7QUFDckQ7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLFFBQVE7QUFDckQ7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FB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QTtBQUNBO0FBQ0EsK0NBQStDLFFBQVE7QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxRQUFRO0FBQ3ZEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QztBQUM3QztBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhCQUE4QjtBQUM5QixPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLG1FQUFtRTtBQUNuRTtBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSixvRUFBb0U7QUFDcEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDO0FBQzdDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLG9CQUFvQjtBQUNyQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixRQUFRO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxRQUFRO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsS0FBSztBQUNMLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQ7QUFDbkQ7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlLFFBQVE7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxJQUFJO0FBQ0osVUFBVTtBQUNWLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0M7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscURBQXFEO0FBQ3JEO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0QsZUFBZTtBQUNmLGtWQUFrVjtBQUNsVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtRUFBbUU7QUFDbkU7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsSUFBSTtBQUNKLHlFQUF5RTtBQUN6RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsSUFBSTtBQUNKLDBFQUEwRTtBQUMxRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsSUFBSTtBQUNKLDJDQUEyQztBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQ7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLDRDQUE0QztBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRDtBQUN0RDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZTtBQUNmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxpQkFBaUI7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLGdCQUFnQjtBQUN2QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkM7QUFDM0M7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSixVQUFVO0FBQ1YsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNGQUFzRjtBQUN0RjtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQSxtQ0FBbUM7QUFDbkM7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLGdCQUFnQjtBQUNoQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0ZBQWtGO0FBQ2xGO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0Esd0ZBQXdGO0FBQ3hGO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQSwwRkFBMEY7QUFDMUY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBLDRGQUE0RjtBQUM1RjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQSxvRkFBb0Y7QUFDcEYsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLCtCQUErQjtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQiwyQkFBMkI7QUFDOUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsaUJBQWlCO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxPQUFPO0FBQ1A7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLGdEQUFnRDtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsa0RBQWtELFFBQVE7QUFDMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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QUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QztBQUN6QztBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxNQUFNO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsTUFBTTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsTUFBTTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSiw2REFBNkQ7QUFDN0Q7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QTtBQUNBLElBQUk7QUFDSjtBQUNBLDZEQUE2RDtBQUM3RDtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0RBQStELHFEQUFxRDtBQUNwSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQztBQUMvQztBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBLEdBQUc7QUFDSDtBQUNBLHFDQUFxQztBQUNyQywrU0FBK1M7QUFDL1MsSUFBSTtBQUNKLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDO0FBQ3JDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNILEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixPQUFPO0FBQzFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdGQUFnRiw0REFBNEQ7QUFDNUk7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSwyQkFBMkI7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsZ0JBQWdCO0FBQy9CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEdBQUc7QUFDSCxHQUFHO0FBQ0gsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNB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QUNBO0FBQ0E7QUFDQSx1Q0FBdUMsT0FBTztBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsMkJBQTJCO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQiwwQkFBMEI7QUFDN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixxQkFBcUI7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQiw2QkFBNkI7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsMEJBQTBCO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIseUJBQXlCO0FBQzVDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQiwyQkFBMkI7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLGlCQUFpQiwyQkFBMkI7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLGlCQUFpQjtBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixhQUFhO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQiw4QkFBOEI7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVC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Q0EsbUJBQW1CLDJCQUEyQjtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQiwrQkFBK0I7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsb0JBQW9CO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixDQUFDIiwiZmlsZSI6Ii4vYnVpbGQvYXJjLWVuZ2luZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIiBcdC8vIFRoZSBtb2R1bGUgY2FjaGVcbiBcdHZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307XG5cbiBcdC8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG4gXHRmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cbiBcdFx0Ly8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlXG4gXHRcdGlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKSB7XG4gXHRcdFx0cmV0dXJuIGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdLmV4cG9ydHM7XG4gXHRcdH1cbiBcdFx0Ly8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSlcbiBcdFx0dmFyIG1vZHVsZSA9IGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdID0ge1xuIFx0XHRcdGk6IG1vZHVsZUlkLFxuIFx0XHRcdGw6IGZhbHNlLFxuIFx0XHRcdGV4cG9ydHM6IHt9XG4gXHRcdH07XG5cbiBcdFx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG4gXHRcdG1vZHVsZXNbbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG4gXHRcdC8vIEZsYWcgdGhlIG1vZHVsZSBhcyBsb2FkZWRcbiBcdFx0bW9kdWxlLmwgPSB0cnVlO1xuXG4gXHRcdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG4gXHRcdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbiBcdH1cblxuXG4gXHQvLyBleHBvc2UgdGhlIG1vZHVsZXMgb2JqZWN0IChfX3dlYnBhY2tfbW9kdWxlc19fKVxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5tID0gbW9kdWxlcztcblxuIFx0Ly8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGVcbiBcdF9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7XG5cbiBcdC8vIGRlZmluZSBnZXR0ZXIgZnVuY3Rpb24gZm9yIGhhcm1vbnkgZXhwb3J0c1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5kID0gZnVuY3Rpb24oZXhwb3J0cywgbmFtZSwgZ2V0dGVyKSB7XG4gXHRcdGlmKCFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywgbmFtZSkpIHtcbiBcdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgbmFtZSwge1xuIFx0XHRcdFx0Y29uZmlndXJhYmxlOiBmYWxzZSxcbiBcdFx0XHRcdGVudW1lcmFibGU6IHRydWUsXG4gXHRcdFx0XHRnZXQ6IGdldHRlclxuIFx0XHRcdH0pO1xuIFx0XHR9XG4gXHR9O1xuXG4gXHQvLyBnZXREZWZhdWx0RXhwb3J0IGZ1bmN0aW9uIGZvciBjb21wYXRpYmlsaXR5IHdpdGggbm9uLWhhcm1vbnkgbW9kdWxlc1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5uID0gZnVuY3Rpb24obW9kdWxlKSB7XG4gXHRcdHZhciBnZXR0ZXIgPSBtb2R1bGUgJiYgbW9kdWxlLl9fZXNNb2R1bGUgP1xuIFx0XHRcdGZ1bmN0aW9uIGdldERlZmF1bHQoKSB7IHJldHVybiBtb2R1bGVbJ2RlZmF1bHQnXTsgfSA6XG4gXHRcdFx0ZnVuY3Rpb24gZ2V0TW9kdWxlRXhwb3J0cygpIHsgcmV0dXJuIG1vZHVsZTsgfTtcbiBcdFx0X193ZWJwYWNrX3JlcXVpcmVfXy5kKGdldHRlciwgJ2EnLCBnZXR0ZXIpO1xuIFx0XHRyZXR1cm4gZ2V0dGVyO1xuIFx0fTtcblxuIFx0Ly8gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLm8gPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7IHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSk7IH07XG5cbiBcdC8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSBcIlwiO1xuXG4gXHQvLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbiBcdHJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKF9fd2VicGFja19yZXF1aXJlX18ucyA9IDApO1xuXG5cblxuLy8gV0VCUEFDSyBGT09URVIgLy9cbi8vIHdlYnBhY2svYm9vdHN0cmFwIDM4MWI5MTE4ZmIxNzg0ZjMxYzZmIiwiJ3VzZSBzdHJpY3QnO1xuXG4vLyBFeHRlcm5hbCBMaWJyYXJpZXMgLS0gQmVnaW5cbmNvbnN0IFBDID0gcmVxdWlyZSggJy4vZXh0ZXJuYWwvcGxheWNhbnZhcy5qcycgKTtcbi8vIEV4dGVybmFsIExpYnJhcmllcyAtLSBFbmRcblxuLy8gQ3JlYXRlIEFwcGxpY2F0aW9uXG5sZXQgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoICdhcHAnICk7XG5sZXQgYXBwID0gbmV3IFBDLkFwcGxpY2F0aW9uKCBjYW52YXMsIHsgfSk7XG5hcHAuc3RhcnQoICk7XG5cbi8vIGZpbGwgdGhlIGF2YWlsYWJsZSBzcGFjZSBhdCBmdWxsIHJlc29sdXRpb25cbmFwcC5zZXRDYW52YXNGaWxsTW9kZSggUEMuRklMTE1PREVfRklMTF9XSU5ET1cgKTtcbmFwcC5zZXRDYW52YXNSZXNvbHV0aW9uKCBQQy5SRVNPTFVUSU9OX0FVVE8gKTtcblxuLy8gZW5zdXJlIGNhbnZhcyBpcyByZXNpemVkIHdoZW4gd2luZG93IGNoYW5nZXMgc2l6ZVxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdyZXNpemUnLCAoICkgPT4ge1xuICAgIGFwcC5yZXNpemVDYW52YXMoICk7XG59ICk7XG5cbi8vIGNyZWF0ZSBib3ggZW50aXR5XG52YXIgY3ViZSA9IG5ldyBQQy5FbnRpdHkoICdjdWJlJyApO1xuY3ViZS5hZGRDb21wb25lbnQoICdtb2RlbCcsIHtcbiAgICB0eXBlOiAnYm94J1xufSApO1xuXG5cblxuLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBXRUJQQUNLIEZPT1RFUlxuLy8gLi9qcy9hcHAuanNcbi8vIG1vZHVsZSBpZCA9IDBcbi8vIG1vZHVsZSBjaHVua3MgPSAwIiwiLypcbiBQbGF5Q2FudmFzIEVuZ2luZSB2MC4yMjAuMSByZXZpc2lvbiAxZmNlYTg0XG4gaHR0cDovL3BsYXljYW52YXMuY29tXG4gQ29weXJpZ2h0IDIwMTEtMjAxNyBQbGF5Q2FudmFzIEx0ZC4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiovXG52YXIgcGMgPSB7dmVyc2lvbjpcIjAuMjIwLjFcIiwgcmV2aXNpb246XCIxZmNlYTg0XCIsIGNvbmZpZzp7fSwgY29tbW9uOnt9LCBhcHBzOnt9LCBkYXRhOnt9LCB1bnBhY2s6ZnVuY3Rpb24oKSB7XG4gIGNvbnNvbGUud2FybihcInBjLnVucGFjayBoYXMgYmVlbiBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgc2hvcnRseS4gUGxlYXNlIHVwZGF0ZSB5b3VyIGNvZGUuXCIpO1xufSwgbWFrZUFycmF5OmZ1bmN0aW9uKGFycikge1xuICB2YXIgaSwgcmV0ID0gW10sIGxlbmd0aCA9IGFyci5sZW5ndGg7XG4gIGZvciAoaSA9IDA7aSA8IGxlbmd0aDsrK2kpIHtcbiAgICByZXQucHVzaChhcnJbaV0pO1xuICB9XG4gIHJldHVybiByZXQ7XG59LCB0eXBlOmZ1bmN0aW9uKG9iaikge1xuICBpZiAob2JqID09PSBudWxsKSB7XG4gICAgcmV0dXJuIFwibnVsbFwiO1xuICB9XG4gIHZhciB0eXBlID0gdHlwZW9mIG9iajtcbiAgaWYgKHR5cGUgPT0gXCJ1bmRlZmluZWRcIiB8fCB0eXBlID09IFwibnVtYmVyXCIgfHwgdHlwZSA9PSBcInN0cmluZ1wiIHx8IHR5cGUgPT0gXCJib29sZWFuXCIpIHtcbiAgICByZXR1cm4gdHlwZTtcbiAgfVxuICByZXR1cm4gX3R5cGVMb29rdXBbT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaildO1xufSwgZXh0ZW5kOmZ1bmN0aW9uKHRhcmdldCwgZXgpIHtcbiAgdmFyIHByb3AsIGNvcHk7XG4gIGZvciAocHJvcCBpbiBleCkge1xuICAgIGNvcHkgPSBleFtwcm9wXTtcbiAgICBpZiAocGMudHlwZShjb3B5KSA9PSBcIm9iamVjdFwiKSB7XG4gICAgICB0YXJnZXRbcHJvcF0gPSBwYy5leHRlbmQoe30sIGNvcHkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocGMudHlwZShjb3B5KSA9PSBcImFycmF5XCIpIHtcbiAgICAgICAgdGFyZ2V0W3Byb3BdID0gcGMuZXh0ZW5kKFtdLCBjb3B5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRhcmdldFtwcm9wXSA9IGNvcHk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB0YXJnZXQ7XG59LCBpc0RlZmluZWQ6ZnVuY3Rpb24obykge1xuICB2YXIgYTtcbiAgcmV0dXJuIG8gIT09IGE7XG59fTtcbnZhciBfdHlwZUxvb2t1cCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgcmVzdWx0ID0ge307XG4gIHZhciBuYW1lcyA9IFtcIkFycmF5XCIsIFwiT2JqZWN0XCIsIFwiRnVuY3Rpb25cIiwgXCJEYXRlXCIsIFwiUmVnRXhwXCIsIFwiRmxvYXQzMkFycmF5XCJdO1xuICBmb3IgKHZhciBpID0gMDtpIDwgbmFtZXMubGVuZ3RoO2krKykge1xuICAgIHJlc3VsdFtcIltvYmplY3QgXCIgKyBuYW1lc1tpXSArIFwiXVwiXSA9IG5hbWVzW2ldLnRvTG93ZXJDYXNlKCk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn0oKTtcbmlmICh0eXBlb2YgZXhwb3J0cyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICBleHBvcnRzLnBjID0gcGM7XG59XG47KGZ1bmN0aW9uKCkge1xuICB2YXIgbGFzdFRpbWUgPSAwO1xuICB2YXIgdmVuZG9ycyA9IFtcIm1zXCIsIFwibW96XCIsIFwid2Via2l0XCIsIFwib1wiXTtcbiAgZm9yICh2YXIgeCA9IDA7eCA8IHZlbmRvcnMubGVuZ3RoICYmICF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lOysreCkge1xuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB3aW5kb3dbdmVuZG9yc1t4XSArIFwiUmVxdWVzdEFuaW1hdGlvbkZyYW1lXCJdO1xuICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgXCJDYW5jZWxBbmltYXRpb25GcmFtZVwiXSB8fCB3aW5kb3dbdmVuZG9yc1t4XSArIFwiQ2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lXCJdO1xuICB9XG4gIGlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkge1xuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihjYWxsYmFjaywgZWxlbWVudCkge1xuICAgICAgdmFyIGN1cnJUaW1lID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7XG4gICAgICB2YXIgdGltZVRvQ2FsbCA9IE1hdGgubWF4KDAsIDE2IC0gKGN1cnJUaW1lIC0gbGFzdFRpbWUpKTtcbiAgICAgIHZhciBpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpO1xuICAgICAgfSwgdGltZVRvQ2FsbCk7XG4gICAgICBsYXN0VGltZSA9IGN1cnJUaW1lICsgdGltZVRvQ2FsbDtcbiAgICAgIHJldHVybiBpZDtcbiAgICB9O1xuICB9XG4gIGlmICghd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKSB7XG4gICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oaWQpIHtcbiAgICAgIGNsZWFyVGltZW91dChpZCk7XG4gICAgfTtcbiAgfVxufSkoKTtcbmlmICghU3RyaW5nLnByb3RvdHlwZS5zdGFydHNXaXRoKSB7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTdHJpbmcucHJvdG90eXBlLCBcInN0YXJ0c1dpdGhcIiwge2VudW1lcmFibGU6ZmFsc2UsIGNvbmZpZ3VyYWJsZTp0cnVlLCB3cml0YWJsZTp0cnVlLCB2YWx1ZTpmdW5jdGlvbihzdHIpIHtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGNlaWwgPSBzdHIubGVuZ3RoO2kgPCBjZWlsO2krKykge1xuICAgICAgaWYgKHRoYXRbaV0gIT09IHN0cltpXSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9fSk7XG59XG5pZiAoIVN0cmluZy5wcm90b3R5cGUuZW5kc1dpdGgpIHtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0cmluZy5wcm90b3R5cGUsIFwiZW5kc1dpdGhcIiwge2VudW1lcmFibGU6ZmFsc2UsIGNvbmZpZ3VyYWJsZTp0cnVlLCB3cml0YWJsZTp0cnVlLCB2YWx1ZTpmdW5jdGlvbihzdHIpIHtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGNlaWwgPSBzdHIubGVuZ3RoO2kgPCBjZWlsO2krKykge1xuICAgICAgaWYgKHRoYXRbaSArIHRoYXQubGVuZ3RoIC0gY2VpbF0gIT09IHN0cltpXSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9fSk7XG59XG5pZiAoIVN0cmluZy5wcm90b3R5cGUuaW5jbHVkZXMpIHtcbiAgU3RyaW5nLnByb3RvdHlwZS5pbmNsdWRlcyA9IGZ1bmN0aW9uKHNlYXJjaCwgc3RhcnQpIHtcbiAgICBpZiAodHlwZW9mIHN0YXJ0ICE9PSBcIm51bWJlclwiKSB7XG4gICAgICBzdGFydCA9IDA7XG4gICAgfVxuICAgIGlmIChzdGFydCArIHNlYXJjaC5sZW5ndGggPiB0aGlzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5pbmRleE9mKHNlYXJjaCwgc3RhcnQpICE9PSAtMTtcbiAgICB9XG4gIH07XG59XG47KGZ1bmN0aW9uKCkge1xuICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHZhciBmdWxsc2NyZWVuY2hhbmdlID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KFwiQ3VzdG9tRXZlbnRcIik7XG4gICAgZS5pbml0Q3VzdG9tRXZlbnQoXCJmdWxsc2NyZWVuY2hhbmdlXCIsIHRydWUsIGZhbHNlLCBudWxsKTtcbiAgICBldmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChlKTtcbiAgfTtcbiAgdmFyIGZ1bGxzY3JlZW5lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudChcIkN1c3RvbUV2ZW50XCIpO1xuICAgIGUuaW5pdEN1c3RvbUV2ZW50KFwiZnVsbHNjcmVlbmVycm9yXCIsIHRydWUsIGZhbHNlLCBudWxsKTtcbiAgICBldmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChlKTtcbiAgfTtcbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIndlYmtpdGZ1bGxzY3JlZW5jaGFuZ2VcIiwgZnVsbHNjcmVlbmNoYW5nZSwgZmFsc2UpO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW96ZnVsbHNjcmVlbmNoYW5nZVwiLCBmdWxsc2NyZWVuY2hhbmdlLCBmYWxzZSk7XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJNU0Z1bGxzY3JlZW5DaGFuZ2VcIiwgZnVsbHNjcmVlbmNoYW5nZSwgZmFsc2UpO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwid2Via2l0ZnVsbHNjcmVlbmVycm9yXCIsIGZ1bGxzY3JlZW5lcnJvciwgZmFsc2UpO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW96ZnVsbHNjcmVlbmVycm9yXCIsIGZ1bGxzY3JlZW5lcnJvciwgZmFsc2UpO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiTVNGdWxsc2NyZWVuRXJyb3JcIiwgZnVsbHNjcmVlbmVycm9yLCBmYWxzZSk7XG4gIGlmIChFbGVtZW50LnByb3RvdHlwZS5tb3pSZXF1ZXN0RnVsbFNjcmVlbikge1xuICAgIEVsZW1lbnQucHJvdG90eXBlLnJlcXVlc3RGdWxsc2NyZWVuID0gZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLm1velJlcXVlc3RGdWxsU2NyZWVuKCk7XG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBFbGVtZW50LnByb3RvdHlwZS5yZXF1ZXN0RnVsbHNjcmVlbiA9IEVsZW1lbnQucHJvdG90eXBlLnJlcXVlc3RGdWxsc2NyZWVuIHx8IEVsZW1lbnQucHJvdG90eXBlLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuIHx8IEVsZW1lbnQucHJvdG90eXBlLm1zUmVxdWVzdEZ1bGxzY3JlZW47XG4gIH1cbiAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4gPSBkb2N1bWVudC5leGl0RnVsbHNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbiB8fCBkb2N1bWVudC5tb3pDYW5jZWxGdWxsU2NyZWVuIHx8IGRvY3VtZW50Lm1zRXhpdEZ1bGxzY3JlZW47XG4gIGlmICghZG9jdW1lbnQuaGFzT3duUHJvcGVydHkoXCJmdWxsc2NyZWVuRWxlbWVudFwiKSkge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShkb2N1bWVudCwgXCJmdWxsc2NyZWVuRWxlbWVudFwiLCB7ZW51bWVyYWJsZTp0cnVlLCBjb25maWd1cmFibGU6ZmFsc2UsIGdldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBkb2N1bWVudC53ZWJraXRDdXJyZW50RnVsbFNjcmVlbkVsZW1lbnQgfHwgZG9jdW1lbnQud2Via2l0RnVsbHNjcmVlbkVsZW1lbnQgfHwgZG9jdW1lbnQubW96RnVsbFNjcmVlbkVsZW1lbnQgfHwgZG9jdW1lbnQubXNGdWxsc2NyZWVuRWxlbWVudDtcbiAgICB9fSk7XG4gIH1cbiAgaWYgKCFkb2N1bWVudC5oYXNPd25Qcm9wZXJ0eShcImZ1bGxzY3JlZW5FbmFibGVkXCIpKSB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRvY3VtZW50LCBcImZ1bGxzY3JlZW5FbmFibGVkXCIsIHtlbnVtZXJhYmxlOnRydWUsIGNvbmZpZ3VyYWJsZTpmYWxzZSwgZ2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50Lm1vekZ1bGxTY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50Lm1zRnVsbHNjcmVlbkVuYWJsZWQ7XG4gICAgfX0pO1xuICB9XG59KSgpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIENvbG9yID0gZnVuY3Rpb24ociwgZywgYiwgYSkge1xuICAgIHRoaXMuYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDQgKiA0KTtcbiAgICB0aGlzLmRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuYnVmZmVyLCAwLCA0KTtcbiAgICB0aGlzLmRhdGEzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmJ1ZmZlciwgMCwgMyk7XG4gICAgdmFyIGxlbmd0aCA9IHIgJiYgci5sZW5ndGg7XG4gICAgaWYgKGxlbmd0aCA9PT0gMyB8fCBsZW5ndGggPT09IDQpIHtcbiAgICAgIHRoaXMuZGF0YVswXSA9IHJbMF07XG4gICAgICB0aGlzLmRhdGFbMV0gPSByWzFdO1xuICAgICAgdGhpcy5kYXRhWzJdID0gclsyXTtcbiAgICAgIHRoaXMuZGF0YVszXSA9IHJbM10gIT09IHVuZGVmaW5lZCA/IHJbM10gOiAxLjA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGF0YVswXSA9IHIgfHwgMDtcbiAgICAgIHRoaXMuZGF0YVsxXSA9IGcgfHwgMDtcbiAgICAgIHRoaXMuZGF0YVsyXSA9IGIgfHwgMDtcbiAgICAgIHRoaXMuZGF0YVszXSA9IGEgIT09IHVuZGVmaW5lZCA/IGEgOiAxLjA7XG4gICAgfVxuICB9O1xuICBDb2xvci5wcm90b3R5cGUgPSB7Y2xvbmU6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBwYy5Db2xvcih0aGlzLmRhdGFbMF0sIHRoaXMuZGF0YVsxXSwgdGhpcy5kYXRhWzJdLCB0aGlzLmRhdGFbM10pO1xuICB9LCBjb3B5OmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgYVswXSA9IGJbMF07XG4gICAgYVsxXSA9IGJbMV07XG4gICAgYVsyXSA9IGJbMl07XG4gICAgYVszXSA9IGJbM107XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNldDpmdW5jdGlvbihyLCBnLCBiLCBhKSB7XG4gICAgdmFyIGMgPSB0aGlzLmRhdGE7XG4gICAgY1swXSA9IHI7XG4gICAgY1sxXSA9IGc7XG4gICAgY1syXSA9IGI7XG4gICAgY1szXSA9IGEgPT09IHVuZGVmaW5lZCA/IDEgOiBhO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBmcm9tU3RyaW5nOmZ1bmN0aW9uKGhleCkge1xuICAgIHZhciBpID0gcGFyc2VJbnQoaGV4LnJlcGxhY2UoXCIjXCIsIFwiMHhcIikpO1xuICAgIHZhciBieXRlcztcbiAgICBpZiAoaGV4Lmxlbmd0aCA+IDcpIHtcbiAgICAgIGJ5dGVzID0gcGMubWF0aC5pbnRUb0J5dGVzMzIoaSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGJ5dGVzID0gcGMubWF0aC5pbnRUb0J5dGVzMjQoaSk7XG4gICAgICBieXRlc1szXSA9IDI1NTtcbiAgICB9XG4gICAgdGhpcy5zZXQoYnl0ZXNbMF0gLyAyNTUsIGJ5dGVzWzFdIC8gMjU1LCBieXRlc1syXSAvIDI1NSwgYnl0ZXNbM10gLyAyNTUpO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCB0b1N0cmluZzpmdW5jdGlvbihhbHBoYSkge1xuICAgIHZhciBzID0gXCIjXCIgKyAoKDEgPDwgMjQpICsgKHBhcnNlSW50KHRoaXMuciAqIDI1NSkgPDwgMTYpICsgKHBhcnNlSW50KHRoaXMuZyAqIDI1NSkgPDwgOCkgKyBwYXJzZUludCh0aGlzLmIgKiAyNTUpKS50b1N0cmluZygxNikuc2xpY2UoMSk7XG4gICAgaWYgKGFscGhhID09PSB0cnVlKSB7XG4gICAgICB2YXIgYSA9IHBhcnNlSW50KHRoaXMuYSAqIDI1NSkudG9TdHJpbmcoMTYpO1xuICAgICAgaWYgKHRoaXMuYSA8IDE2IC8gMjU1KSB7XG4gICAgICAgIHMgKz0gXCIwXCIgKyBhO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcyArPSBhO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb2xvci5wcm90b3R5cGUsIFwiclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMF07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVswXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb2xvci5wcm90b3R5cGUsIFwiZ1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMV07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVsxXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb2xvci5wcm90b3R5cGUsIFwiYlwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMl07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVsyXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb2xvci5wcm90b3R5cGUsIFwiYVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbM107XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVszXSA9IHZhbHVlO1xuICB9fSk7XG4gIHJldHVybiB7Q29sb3I6Q29sb3J9O1xufSgpKTtcbnBjLmd1aWQgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtjcmVhdGU6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFwieHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4XCIucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7XG4gICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkgKiAxNiB8IDAsIHYgPSBjID09IFwieFwiID8gciA6IHIgJiAzIHwgODtcbiAgICAgIHJldHVybiB2LnRvU3RyaW5nKDE2KTtcbiAgICB9KTtcbiAgfX07XG59KCk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgVGltZXIgPSBmdW5jdGlvbiBUaW1lcigpIHtcbiAgICB0aGlzLl9pc1J1bm5pbmcgPSBmYWxzZTtcbiAgICB0aGlzLl9hID0gMDtcbiAgICB0aGlzLl9iID0gMDtcbiAgfTtcbiAgVGltZXIucHJvdG90eXBlID0ge3N0YXJ0OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX2lzUnVubmluZyA9IHRydWU7XG4gICAgdGhpcy5fYSA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpO1xuICB9LCBzdG9wOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX2lzUnVubmluZyA9IGZhbHNlO1xuICAgIHRoaXMuX2IgPSAobmV3IERhdGUpLmdldFRpbWUoKTtcbiAgfSwgZ2V0TWlsbGlzZWNvbmRzOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9iIC0gdGhpcy5fYTtcbiAgfX07XG4gIHJldHVybiB7VGltZXI6VGltZXIsIG5vdzohd2luZG93LnBlcmZvcm1hbmNlIHx8ICF3aW5kb3cucGVyZm9ybWFuY2Uubm93IHx8ICF3aW5kb3cucGVyZm9ybWFuY2UudGltaW5nID8gRGF0ZS5ub3cgOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gd2luZG93LnBlcmZvcm1hbmNlLm5vdygpO1xuICB9fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge2NyZWF0ZVVSSTpmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgdmFyIHMgPSBcIlwiO1xuICAgIGlmICgob3B0aW9ucy5hdXRob3JpdHkgfHwgb3B0aW9ucy5zY2hlbWUpICYmIChvcHRpb25zLmhvc3QgfHwgb3B0aW9ucy5ob3N0cGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbid0IGhhdmUgJ3NjaGVtZScgb3IgJ2F1dGhvcml0eScgYW5kICdob3N0JyBvciAnaG9zdHBhdGgnIG9wdGlvblwiKTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuaG9zdCAmJiBvcHRpb25zLmhvc3RwYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4ndCBoYXZlICdob3N0JyBhbmQgJ2hvc3RwYXRoJyBvcHRpb25cIik7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnBhdGggJiYgb3B0aW9ucy5ob3N0cGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3QgaGF2ZSAncGF0aCcgYW5kICdob3N0cGF0aCcgb3B0aW9uXCIpO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5zY2hlbWUpIHtcbiAgICAgIHMgKz0gb3B0aW9ucy5zY2hlbWUgKyBcIjpcIjtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuYXV0aG9yaXR5KSB7XG4gICAgICBzICs9IFwiLy9cIiArIG9wdGlvbnMuYXV0aG9yaXR5O1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5ob3N0KSB7XG4gICAgICBzICs9IG9wdGlvbnMuaG9zdDtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMucGF0aCkge1xuICAgICAgcyArPSBvcHRpb25zLnBhdGg7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmhvc3RwYXRoKSB7XG4gICAgICBzICs9IG9wdGlvbnMuaG9zdHBhdGg7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnF1ZXJ5KSB7XG4gICAgICBzICs9IFwiP1wiICsgb3B0aW9ucy5xdWVyeTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuZnJhZ21lbnQpIHtcbiAgICAgIHMgKz0gXCIjXCIgKyBvcHRpb25zLmZyYWdtZW50O1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfSwgVVJJOmZ1bmN0aW9uKHVyaSkge1xuICAgIHZhciByZSA9IC9eKChbXjpcXC8/I10rKTopPyhcXC9cXC8oW15cXC8/I10qKSk/KFtePyNdKikoXFw/KFteI10qKSk/KCMoLiopKT8vLCByZXN1bHQgPSB1cmkubWF0Y2gocmUpO1xuICAgIHRoaXMuc2NoZW1lID0gcmVzdWx0WzJdO1xuICAgIHRoaXMuYXV0aG9yaXR5ID0gcmVzdWx0WzRdO1xuICAgIHRoaXMucGF0aCA9IHJlc3VsdFs1XTtcbiAgICB0aGlzLnF1ZXJ5ID0gcmVzdWx0WzddO1xuICAgIHRoaXMuZnJhZ21lbnQgPSByZXN1bHRbOV07XG4gICAgdGhpcy50b1N0cmluZyA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHMgPSBcIlwiO1xuICAgICAgaWYgKHRoaXMuc2NoZW1lKSB7XG4gICAgICAgIHMgKz0gdGhpcy5zY2hlbWUgKyBcIjpcIjtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmF1dGhvcml0eSkge1xuICAgICAgICBzICs9IFwiLy9cIiArIHRoaXMuYXV0aG9yaXR5O1xuICAgICAgfVxuICAgICAgcyArPSB0aGlzLnBhdGg7XG4gICAgICBpZiAodGhpcy5xdWVyeSkge1xuICAgICAgICBzICs9IFwiP1wiICsgdGhpcy5xdWVyeTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmZyYWdtZW50KSB7XG4gICAgICAgIHMgKz0gXCIjXCIgKyB0aGlzLmZyYWdtZW50O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHM7XG4gICAgfTtcbiAgICB0aGlzLmdldFF1ZXJ5ID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgdmFycztcbiAgICAgIHZhciBwYWlyO1xuICAgICAgdmFyIHJlc3VsdCA9IHt9O1xuICAgICAgaWYgKHRoaXMucXVlcnkpIHtcbiAgICAgICAgdmFycyA9IGRlY29kZVVSSUNvbXBvbmVudCh0aGlzLnF1ZXJ5KS5zcGxpdChcIiZcIik7XG4gICAgICAgIHZhcnMuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCwgYXJyKSB7XG4gICAgICAgICAgcGFpciA9IGl0ZW0uc3BsaXQoXCI9XCIpO1xuICAgICAgICAgIHJlc3VsdFtwYWlyWzBdXSA9IHBhaXJbMV07XG4gICAgICAgIH0sIHRoaXMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9O1xuICAgIHRoaXMuc2V0UXVlcnkgPSBmdW5jdGlvbihwYXJhbXMpIHtcbiAgICAgIHZhciBxID0gXCJcIjtcbiAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbXMpIHtcbiAgICAgICAgaWYgKHBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgaWYgKHEgIT09IFwiXCIpIHtcbiAgICAgICAgICAgIHEgKz0gXCImXCI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHEgKz0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyBcIj1cIiArIGVuY29kZVVSSUNvbXBvbmVudChwYXJhbXNba2V5XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMucXVlcnkgPSBxO1xuICAgIH07XG4gIH19O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBsb2cgPSB7d3JpdGU6ZnVuY3Rpb24odGV4dCkge1xuICAgIGNvbnNvbGUubG9nKHRleHQpO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHRleHQpIHtcbiAgICBwYy5sb2cud3JpdGUoXCJQb3dlcmVkIGJ5IFBsYXlDYW52YXMgXCIgKyBwYy52ZXJzaW9uICsgXCIgXCIgKyBwYy5yZXZpc2lvbik7XG4gIH0sIGluZm86ZnVuY3Rpb24odGV4dCkge1xuICAgIGNvbnNvbGUuaW5mbyhcIklORk86ICAgIFwiICsgdGV4dCk7XG4gIH0sIGRlYnVnOmZ1bmN0aW9uKHRleHQpIHtcbiAgICBjb25zb2xlLmRlYnVnKFwiREVCVUc6ICAgXCIgKyB0ZXh0KTtcbiAgfSwgZXJyb3I6ZnVuY3Rpb24odGV4dCkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogICBcIiArIHRleHQpO1xuICB9LCB3YXJuaW5nOmZ1bmN0aW9uKHRleHQpIHtcbiAgICBjb25zb2xlLndhcm4oXCJXQVJOSU5HOiBcIiArIHRleHQpO1xuICB9LCBhbGVydDpmdW5jdGlvbih0ZXh0KSB7XG4gICAgcGMubG9nLndyaXRlKFwiQUxFUlQ6ICAgXCIgKyB0ZXh0KTtcbiAgICBhbGVydCh0ZXh0KTtcbiAgfSwgYXNzZXJ0OmZ1bmN0aW9uKGNvbmRpdGlvbiwgdGV4dCkge1xuICAgIGlmIChjb25kaXRpb24gPT09IGZhbHNlKSB7XG4gICAgICBwYy5sb2cud3JpdGUoXCJBU1NFUlQ6ICBcIiArIHRleHQpO1xuICAgICAgYWxlcnQoXCJBU1NFUlQgZmFpbGVkOiBcIiArIHRleHQpO1xuICAgIH1cbiAgfX07XG4gIHJldHVybiB7bG9nOmxvZ307XG59KCkpO1xudmFyIGxvZ0lORk8gPSBwYy5sb2cuaW5mbztcbnZhciBsb2dERUJVRyA9IHBjLmxvZy5kZWJ1ZztcbnZhciBsb2dXQVJOSU5HID0gcGMubG9nLndhcm5pbmc7XG52YXIgbG9nRVJST1IgPSBwYy5sb2cuZXJyb3I7XG52YXIgbG9nQUxFUlQgPSBwYy5sb2cuYWxlcnQ7XG52YXIgbG9nQVNTRVJUID0gcGMubG9nLmFzc2VydDtcbkZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmRzRnJvbSA9IGZ1bmN0aW9uKFN1cGVyKSB7XG4gIHZhciBTZWxmLCBGdW5jO1xuICB2YXIgVGVtcCA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBTZWxmID0gdGhpcztcbiAgRnVuYyA9IGZ1bmN0aW9uKCkge1xuICAgIFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgU2VsZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIHRoaXMuY29uc3RydWN0b3IgPSBTZWxmO1xuICB9O1xuICBGdW5jLl9zdXBlciA9IFN1cGVyLnByb3RvdHlwZTtcbiAgVGVtcC5wcm90b3R5cGUgPSBTdXBlci5wcm90b3R5cGU7XG4gIEZ1bmMucHJvdG90eXBlID0gbmV3IFRlbXA7XG4gIHJldHVybiBGdW5jO1xufTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiB7aW5oZXJpdHM6ZnVuY3Rpb24oU2VsZiwgU3VwZXIpIHtcbiAgICB2YXIgVGVtcCA9IGZ1bmN0aW9uKCkge1xuICAgIH07XG4gICAgdmFyIEZ1bmMgPSBmdW5jdGlvbihhcmcxLCBhcmcyLCBhcmczLCBhcmc0LCBhcmc1LCBhcmc2LCBhcmc3LCBhcmc4KSB7XG4gICAgICBTdXBlci5jYWxsKHRoaXMsIGFyZzEsIGFyZzIsIGFyZzMsIGFyZzQsIGFyZzUsIGFyZzYsIGFyZzcsIGFyZzgpO1xuICAgICAgU2VsZi5jYWxsKHRoaXMsIGFyZzEsIGFyZzIsIGFyZzMsIGFyZzQsIGFyZzUsIGFyZzYsIGFyZzcsIGFyZzgpO1xuICAgIH07XG4gICAgRnVuYy5fc3VwZXIgPSBTdXBlci5wcm90b3R5cGU7XG4gICAgVGVtcC5wcm90b3R5cGUgPSBTdXBlci5wcm90b3R5cGU7XG4gICAgRnVuYy5wcm90b3R5cGUgPSBuZXcgVGVtcDtcbiAgICByZXR1cm4gRnVuYztcbiAgfX07XG59KCkpO1xucGMucGF0aCA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge2RlbGltaXRlcjpcIi9cIiwgam9pbjpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5kZXg7XG4gICAgdmFyIG51bSA9IGFyZ3VtZW50cy5sZW5ndGg7XG4gICAgdmFyIHJlc3VsdCA9IGFyZ3VtZW50c1swXTtcbiAgICBmb3IgKGluZGV4ID0gMDtpbmRleCA8IG51bSAtIDE7KytpbmRleCkge1xuICAgICAgdmFyIG9uZSA9IGFyZ3VtZW50c1tpbmRleF07XG4gICAgICB2YXIgdHdvID0gYXJndW1lbnRzW2luZGV4ICsgMV07XG4gICAgICBpZiAoIXBjLmlzRGVmaW5lZChvbmUpIHx8ICFwYy5pc0RlZmluZWQodHdvKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ1bmRlZmluZWQgYXJndW1lbnQgdG8gcGMucGF0aC5qb2luXCIpO1xuICAgICAgfVxuICAgICAgaWYgKHR3b1swXSA9PT0gcGMucGF0aC5kZWxpbWl0ZXIpIHtcbiAgICAgICAgcmVzdWx0ID0gdHdvO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvbmUgJiYgdHdvICYmIG9uZVtvbmUubGVuZ3RoIC0gMV0gIT09IHBjLnBhdGguZGVsaW1pdGVyICYmIHR3b1swXSAhPT0gcGMucGF0aC5kZWxpbWl0ZXIpIHtcbiAgICAgICAgcmVzdWx0ICs9IHBjLnBhdGguZGVsaW1pdGVyICsgdHdvO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0ICs9IHR3bztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSwgc3BsaXQ6ZnVuY3Rpb24ocGF0aCkge1xuICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQocGMucGF0aC5kZWxpbWl0ZXIpO1xuICAgIHZhciB0YWlsID0gcGFydHMuc2xpY2UocGFydHMubGVuZ3RoIC0gMSlbMF07XG4gICAgdmFyIGhlYWQgPSBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAxKS5qb2luKHBjLnBhdGguZGVsaW1pdGVyKTtcbiAgICByZXR1cm4gW2hlYWQsIHRhaWxdO1xuICB9LCBnZXRCYXNlbmFtZTpmdW5jdGlvbihwYXRoKSB7XG4gICAgcmV0dXJuIHBjLnBhdGguc3BsaXQocGF0aClbMV07XG4gIH0sIGdldERpcmVjdG9yeTpmdW5jdGlvbihwYXRoKSB7XG4gICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdChwYy5wYXRoLmRlbGltaXRlcik7XG4gICAgcmV0dXJuIHBhcnRzLnNsaWNlKDAsIHBhcnRzLmxlbmd0aCAtIDEpLmpvaW4ocGMucGF0aC5kZWxpbWl0ZXIpO1xuICB9LCBnZXRFeHRlbnNpb246ZnVuY3Rpb24ocGF0aCkge1xuICAgIHZhciBleHQgPSBwYXRoLnNwbGl0KFwiP1wiKVswXS5zcGxpdChcIi5cIikucG9wKCk7XG4gICAgaWYgKGV4dCAhPT0gcGF0aCkge1xuICAgICAgcmV0dXJuIFwiLlwiICsgZXh0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gIH0sIGlzUmVsYXRpdmVQYXRoOmZ1bmN0aW9uKHMpIHtcbiAgICByZXR1cm4gcy5jaGFyQXQoMCkgIT09IFwiL1wiICYmIHMubWF0Y2goLzpcXC9cXC8vKSA9PT0gbnVsbDtcbiAgfSwgZXh0cmFjdFBhdGg6ZnVuY3Rpb24ocykge1xuICAgIHZhciBwYXRoID0gXCIuXCIsIHBhcnRzID0gcy5zcGxpdChcIi9cIiksIGkgPSAwO1xuICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7XG4gICAgICBpZiAocGMucGF0aC5pc1JlbGF0aXZlUGF0aChzKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgcGF0aCA9IFwiXCI7XG4gICAgICB9XG4gICAgICBmb3IgKGkgPSAwO2kgPCBwYXJ0cy5sZW5ndGggLSAxOysraSkge1xuICAgICAgICBwYXRoICs9IFwiL1wiICsgcGFydHNbaV07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwYXRoO1xuICB9fTtcbn0oKTtcbnBjLnN0cmluZyA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge0FTQ0lJX0xPV0VSQ0FTRTpcImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6XCIsIEFTQ0lJX1VQUEVSQ0FTRTpcIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaXCIsIEFTQ0lJX0xFVFRFUlM6dGhpcy5BU0NJSV9MT1dFUkNBU0UgKyB0aGlzLkFTQ0lJX1VQUEVSQ0FTRSwgZm9ybWF0OmZ1bmN0aW9uKHMpIHtcbiAgICB2YXIgaSA9IDAsIHJlZ2V4cCwgYXJncyA9IHBjLm1ha2VBcnJheShhcmd1bWVudHMpO1xuICAgIGFyZ3Muc2hpZnQoKTtcbiAgICBmb3IgKGkgPSAwO2kgPCBhcmdzLmxlbmd0aDtpKyspIHtcbiAgICAgIHJlZ2V4cCA9IG5ldyBSZWdFeHAoXCJcXFxce1wiICsgaSArIFwiXFxcXH1cIiwgXCJnaVwiKTtcbiAgICAgIHMgPSBzLnJlcGxhY2UocmVnZXhwLCBhcmdzW2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIHM7XG4gIH0sIHN0YXJ0c1dpdGg6ZnVuY3Rpb24ocywgc3Vicykge1xuICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IHN0YXJ0c1dpdGg6IEZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQuIFVzZSBTdHJpbmcuc3RhcnRzV2l0aCBpbnN0ZWFkLlwiKTtcbiAgICByZXR1cm4gcy5zdGFydHNXaXRoKHN1YnMpO1xuICB9LCBlbmRzV2l0aDpmdW5jdGlvbihzLCBzdWJzKSB7XG4gICAgY29uc29sZS53YXJuKFwiV0FSTklORzogZW5kc1dpdGg6IEZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQuIFVzZSBTdHJpbmcuZW5kc1dpdGggaW5zdGVhZC5cIik7XG4gICAgcmV0dXJuIHMuZW5kc1dpdGgoc3Vicyk7XG4gIH0sIHRvQm9vbDpmdW5jdGlvbihzLCBzdHJpY3QpIHtcbiAgICBpZiAocyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoc3RyaWN0KSB7XG4gICAgICBpZiAocyA9PT0gXCJmYWxzZVwiKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vdCBhIGJvb2xlYW4gc3RyaW5nXCIpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH19O1xufSgpO1xucGMuZGVidWcgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHRhYmxlID0gbnVsbDtcbiAgdmFyIHJvdyA9IG51bGw7XG4gIHZhciB0aXRsZSA9IG51bGw7XG4gIHZhciBmaWVsZCA9IG51bGw7XG4gIHJldHVybiB7ZGlzcGxheTpmdW5jdGlvbihkYXRhKSB7XG4gICAgZnVuY3Rpb24gaW5pdCgpIHtcbiAgICAgIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRhYmxlXCIpO1xuICAgICAgcm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRyXCIpO1xuICAgICAgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGRcIik7XG4gICAgICBmaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZFwiKTtcbiAgICAgIHRhYmxlLnN0eWxlLmNzc1RleHQgPSBcInBvc2l0aW9uOmFic29sdXRlO2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWY7Zm9udC1zaXplOjEycHg7Y29sb3I6I2NjY2NjY1wiO1xuICAgICAgdGFibGUuc3R5bGUudG9wID0gXCIwcHhcIjtcbiAgICAgIHRhYmxlLnN0eWxlLmxlZnQgPSBcIjBweFwiO1xuICAgICAgdGFibGUuc3R5bGUuYm9yZGVyID0gXCJ0aGluIHNvbGlkICNjY2NjY2NcIjtcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGFibGUpO1xuICAgIH1cbiAgICBpZiAoIXRhYmxlKSB7XG4gICAgICBpbml0KCk7XG4gICAgfVxuICAgIHRhYmxlLmlubmVySFRNTCA9IFwiXCI7XG4gICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHtcbiAgICAgIHZhciByID0gcm93LmNsb25lTm9kZSgpO1xuICAgICAgdmFyIHQgPSB0aXRsZS5jbG9uZU5vZGUoKTtcbiAgICAgIHZhciBmID0gZmllbGQuY2xvbmVOb2RlKCk7XG4gICAgICB0LnRleHRDb250ZW50ID0ga2V5O1xuICAgICAgZi50ZXh0Q29udGVudCA9IGRhdGFba2V5XTtcbiAgICAgIHIuYXBwZW5kQ2hpbGQodCk7XG4gICAgICByLmFwcGVuZENoaWxkKGYpO1xuICAgICAgdGFibGUuYXBwZW5kQ2hpbGQocik7XG4gICAgfVxuICB9fTtcbn0oKTtcbnBjLmV2ZW50cyA9IHthdHRhY2g6ZnVuY3Rpb24odGFyZ2V0KSB7XG4gIHZhciBldiA9IHBjLmV2ZW50cztcbiAgdGFyZ2V0Lm9uID0gZXYub247XG4gIHRhcmdldC5vZmYgPSBldi5vZmY7XG4gIHRhcmdldC5maXJlID0gZXYuZmlyZTtcbiAgdGFyZ2V0Lm9uY2UgPSBldi5vbmNlO1xuICB0YXJnZXQuaGFzRXZlbnQgPSBldi5oYXNFdmVudDtcbiAgdGFyZ2V0Ll9jYWxsYmFja0FjdGl2ZSA9IHt9O1xuICByZXR1cm4gdGFyZ2V0O1xufSwgb246ZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIHNjb3BlKSB7XG4gIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIiB8fCAhY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBpZiAoIXRoaXMuX2NhbGxiYWNrcykge1xuICAgIHRoaXMuX2NhbGxiYWNrcyA9IHt9O1xuICB9XG4gIGlmICghdGhpcy5fY2FsbGJhY2tzW25hbWVdKSB7XG4gICAgdGhpcy5fY2FsbGJhY2tzW25hbWVdID0gW107XG4gIH1cbiAgaWYgKCF0aGlzLl9jYWxsYmFja0FjdGl2ZSkge1xuICAgIHRoaXMuX2NhbGxiYWNrQWN0aXZlID0ge307XG4gIH1cbiAgaWYgKHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdICYmIHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdID09PSB0aGlzLl9jYWxsYmFja3NbbmFtZV0pIHtcbiAgICB0aGlzLl9jYWxsYmFja0FjdGl2ZVtuYW1lXSA9IHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdLnNsaWNlKCk7XG4gIH1cbiAgdGhpcy5fY2FsbGJhY2tzW25hbWVdLnB1c2goe2NhbGxiYWNrOmNhbGxiYWNrLCBzY29wZTpzY29wZSB8fCB0aGlzfSk7XG4gIHJldHVybiB0aGlzO1xufSwgb2ZmOmZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBzY29wZSkge1xuICBpZiAoIXRoaXMuX2NhbGxiYWNrcykge1xuICAgIHJldHVybiB0aGlzO1xuICB9XG4gIGlmICh0aGlzLl9jYWxsYmFja0FjdGl2ZSkge1xuICAgIGlmIChuYW1lKSB7XG4gICAgICBpZiAodGhpcy5fY2FsbGJhY2tBY3RpdmVbbmFtZV0gJiYgdGhpcy5fY2FsbGJhY2tBY3RpdmVbbmFtZV0gPT09IHRoaXMuX2NhbGxiYWNrc1tuYW1lXSkge1xuICAgICAgICB0aGlzLl9jYWxsYmFja0FjdGl2ZVtuYW1lXSA9IHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdLnNsaWNlKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9jYWxsYmFja0FjdGl2ZSkge1xuICAgICAgICBpZiAoIXRoaXMuX2NhbGxiYWNrc1trZXldKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX2NhbGxiYWNrc1trZXldICE9PSB0aGlzLl9jYWxsYmFja0FjdGl2ZVtrZXldKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY2FsbGJhY2tBY3RpdmVba2V5XSA9IHRoaXMuX2NhbGxiYWNrQWN0aXZlW2tleV0uc2xpY2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKCFuYW1lKSB7XG4gICAgdGhpcy5fY2FsbGJhY2tzID0gbnVsbDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICBpZiAodGhpcy5fY2FsbGJhY2tzW25hbWVdKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9jYWxsYmFja3NbbmFtZV07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9jYWxsYmFja3NbbmFtZV07XG4gICAgICBpZiAoIWV2ZW50cykge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH1cbiAgICAgIHZhciBpID0gZXZlbnRzLmxlbmd0aDtcbiAgICAgIHdoaWxlIChpLS0pIHtcbiAgICAgICAgaWYgKGV2ZW50c1tpXS5jYWxsYmFjayAhPT0gY2FsbGJhY2spIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2NvcGUgJiYgZXZlbnRzW2ldLnNjb3BlICE9PSBzY29wZSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGV2ZW50cy5zcGxpY2UoaSwgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB0aGlzO1xufSwgZmlyZTpmdW5jdGlvbihuYW1lLCBhcmcxLCBhcmcyLCBhcmczLCBhcmc0LCBhcmc1LCBhcmc2LCBhcmc3LCBhcmc4KSB7XG4gIGlmICghbmFtZSB8fCAhdGhpcy5fY2FsbGJhY2tzIHx8ICF0aGlzLl9jYWxsYmFja3NbbmFtZV0pIHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICB2YXIgY2FsbGJhY2tzO1xuICBpZiAoIXRoaXMuX2NhbGxiYWNrQWN0aXZlKSB7XG4gICAgdGhpcy5fY2FsbGJhY2tBY3RpdmUgPSB7fTtcbiAgfVxuICBpZiAoIXRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdKSB7XG4gICAgdGhpcy5fY2FsbGJhY2tBY3RpdmVbbmFtZV0gPSB0aGlzLl9jYWxsYmFja3NbbmFtZV07XG4gIH0gZWxzZSB7XG4gICAgaWYgKHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdID09PSB0aGlzLl9jYWxsYmFja3NbbmFtZV0pIHtcbiAgICAgIHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdID0gdGhpcy5fY2FsbGJhY2tBY3RpdmVbbmFtZV0uc2xpY2UoKTtcbiAgICB9XG4gICAgY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzW25hbWVdLnNsaWNlKCk7XG4gIH1cbiAgZm9yICh2YXIgaSA9IDA7KGNhbGxiYWNrcyB8fCB0aGlzLl9jYWxsYmFja0FjdGl2ZVtuYW1lXSkgJiYgaSA8IChjYWxsYmFja3MgfHwgdGhpcy5fY2FsbGJhY2tBY3RpdmVbbmFtZV0pLmxlbmd0aDtpKyspIHtcbiAgICB2YXIgZXZ0ID0gKGNhbGxiYWNrcyB8fCB0aGlzLl9jYWxsYmFja0FjdGl2ZVtuYW1lXSlbaV07XG4gICAgZXZ0LmNhbGxiYWNrLmNhbGwoZXZ0LnNjb3BlLCBhcmcxLCBhcmcyLCBhcmczLCBhcmc0LCBhcmc1LCBhcmc2LCBhcmc3LCBhcmc4KTtcbiAgICBpZiAoZXZ0LmNhbGxiYWNrLm9uY2UpIHtcbiAgICAgIHZhciBpbmQgPSB0aGlzLl9jYWxsYmFja3NbbmFtZV0uaW5kZXhPZihldnQpO1xuICAgICAgaWYgKGluZCAhPT0gLTEpIHtcbiAgICAgICAgaWYgKHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdID09PSB0aGlzLl9jYWxsYmFja3NbbmFtZV0pIHtcbiAgICAgICAgICB0aGlzLl9jYWxsYmFja0FjdGl2ZVtuYW1lXSA9IHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdLnNsaWNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY2FsbGJhY2tzW25hbWVdLnNwbGljZShpbmQsIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAoIWNhbGxiYWNrcykge1xuICAgIHRoaXMuX2NhbGxiYWNrQWN0aXZlW25hbWVdID0gbnVsbDtcbiAgfVxuICByZXR1cm4gdGhpcztcbn0sIG9uY2U6ZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIHNjb3BlKSB7XG4gIGNhbGxiYWNrLm9uY2UgPSB0cnVlO1xuICB0aGlzLm9uKG5hbWUsIGNhbGxiYWNrLCBzY29wZSk7XG4gIHJldHVybiB0aGlzO1xufSwgaGFzRXZlbnQ6ZnVuY3Rpb24obmFtZSkge1xuICByZXR1cm4gdGhpcy5fY2FsbGJhY2tzICYmIHRoaXMuX2NhbGxiYWNrc1tuYW1lXSAmJiB0aGlzLl9jYWxsYmFja3NbbmFtZV0ubGVuZ3RoICE9PSAwO1xufX07XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgVGFnc0NhY2hlID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgdGhpcy5faW5kZXggPSB7fTtcbiAgICB0aGlzLl9rZXkgPSBrZXkgfHwgbnVsbDtcbiAgfTtcbiAgVGFnc0NhY2hlLnByb3RvdHlwZSA9IHthZGRJdGVtOmZ1bmN0aW9uKGl0ZW0pIHtcbiAgICB2YXIgdGFncyA9IGl0ZW0udGFncy5fbGlzdDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGFncy5sZW5ndGg7aSsrKSB7XG4gICAgICB0aGlzLmFkZCh0YWdzW2ldLCBpdGVtKTtcbiAgICB9XG4gIH0sIHJlbW92ZUl0ZW06ZnVuY3Rpb24oaXRlbSkge1xuICAgIHZhciB0YWdzID0gaXRlbS50YWdzLl9saXN0O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0YWdzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMucmVtb3ZlKHRhZ3NbaV0sIGl0ZW0pO1xuICAgIH1cbiAgfSwgYWRkOmZ1bmN0aW9uKHRhZywgaXRlbSkge1xuICAgIGlmICh0aGlzLl9pbmRleFt0YWddICYmIHRoaXMuX2luZGV4W3RhZ10ubGlzdC5pbmRleE9mKGl0ZW0pICE9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuX2luZGV4W3RhZ10pIHtcbiAgICAgIHRoaXMuX2luZGV4W3RhZ10gPSB7bGlzdDpbXX07XG4gICAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICAgIHRoaXMuX2luZGV4W3RhZ10ua2V5cyA9IHt9O1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9pbmRleFt0YWddLmxpc3QucHVzaChpdGVtKTtcbiAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICB0aGlzLl9pbmRleFt0YWddLmtleXNbaXRlbVt0aGlzLl9rZXldXSA9IGl0ZW07XG4gICAgfVxuICB9LCByZW1vdmU6ZnVuY3Rpb24odGFnLCBpdGVtKSB7XG4gICAgaWYgKCF0aGlzLl9pbmRleFt0YWddKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLl9rZXkpIHtcbiAgICAgIGlmICghdGhpcy5faW5kZXhbdGFnXS5rZXlzW2l0ZW1bdGhpcy5fa2V5XV0pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgaW5kID0gdGhpcy5faW5kZXhbdGFnXS5pbmRleE9mKGl0ZW0pO1xuICAgIGlmIChpbmQgPT09IC0xKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2luZGV4W3RhZ10ubGlzdC5zcGxpY2UoaW5kLCAxKTtcbiAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICBkZWxldGUgdGhpcy5faW5kZXhbdGFnXS5rZXlzW2l0ZW1bdGhpcy5fa2V5XV07XG4gICAgfVxuICAgIGlmICh0aGlzLl9pbmRleFt0YWddLmxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICBkZWxldGUgdGhpcy5faW5kZXhbdGFnXTtcbiAgICB9XG4gIH0sIGZpbmQ6ZnVuY3Rpb24oYXJncykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgaW5kZXggPSB7fTtcbiAgICB2YXIgaXRlbXMgPSBbXTtcbiAgICB2YXIgaSwgbiwgdDtcbiAgICB2YXIgaXRlbSwgdGFnLCB0YWdzLCB0YWdzUmVzdCwgbGlzdCwgbWlzc2luZ0luZGV4O1xuICAgIHZhciBzb3J0ID0gZnVuY3Rpb24oYSwgYikge1xuICAgICAgcmV0dXJuIHNlbGYuX2luZGV4W2FdLmxpc3QubGVuZ3RoIC0gc2VsZi5faW5kZXhbYl0ubGlzdC5sZW5ndGg7XG4gICAgfTtcbiAgICBmb3IgKGkgPSAwO2kgPCBhcmdzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRhZyA9IGFyZ3NbaV07XG4gICAgICBpZiAodGFnIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgaWYgKHRhZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGFnLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgIHRhZyA9IHRhZ1swXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtaXNzaW5nSW5kZXggPSBmYWxzZTtcbiAgICAgICAgICBmb3IgKHQgPSAwO3QgPCB0YWcubGVuZ3RoO3QrKykge1xuICAgICAgICAgICAgaWYgKCF0aGlzLl9pbmRleFt0YWdbdF1dKSB7XG4gICAgICAgICAgICAgIG1pc3NpbmdJbmRleCA9IHRydWU7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAobWlzc2luZ0luZGV4KSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGFncyA9IHRhZy5zbGljZSgwKS5zb3J0KHNvcnQpO1xuICAgICAgICAgIHRhZ3NSZXN0ID0gdGFncy5zbGljZSgxKTtcbiAgICAgICAgICBpZiAodGFnc1Jlc3QubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICB0YWdzUmVzdCA9IHRhZ3NSZXN0WzBdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb3IgKG4gPSAwO24gPCB0aGlzLl9pbmRleFt0YWdzWzBdXS5saXN0Lmxlbmd0aDtuKyspIHtcbiAgICAgICAgICAgIGl0ZW0gPSB0aGlzLl9pbmRleFt0YWdzWzBdXS5saXN0W25dO1xuICAgICAgICAgICAgaWYgKCh0aGlzLl9rZXkgPyAhaW5kZXhbaXRlbVt0aGlzLl9rZXldXSA6IGl0ZW1zLmluZGV4T2YoaXRlbSkgPT09IC0xKSAmJiBpdGVtLnRhZ3MuaGFzKHRhZ3NSZXN0KSkge1xuICAgICAgICAgICAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICAgICAgICAgICAgaW5kZXhbaXRlbVt0aGlzLl9rZXldXSA9IHRydWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0YWcgJiYgdHlwZW9mIHRhZyA9PT0gXCJzdHJpbmdcIiAmJiB0aGlzLl9pbmRleFt0YWddKSB7XG4gICAgICAgIGZvciAobiA9IDA7biA8IHRoaXMuX2luZGV4W3RhZ10ubGlzdC5sZW5ndGg7bisrKSB7XG4gICAgICAgICAgaXRlbSA9IHRoaXMuX2luZGV4W3RhZ10ubGlzdFtuXTtcbiAgICAgICAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICAgICAgICBpZiAoIWluZGV4W2l0ZW1bdGhpcy5fa2V5XV0pIHtcbiAgICAgICAgICAgICAgaW5kZXhbaXRlbVt0aGlzLl9rZXldXSA9IHRydWU7XG4gICAgICAgICAgICAgIGl0ZW1zLnB1c2goaXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpdGVtcy5pbmRleE9mKGl0ZW0pID09PSAtMSkge1xuICAgICAgICAgICAgICBpdGVtcy5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaXRlbXM7XG4gIH19O1xuICB2YXIgVGFncyA9IGZ1bmN0aW9uKHBhcmVudCkge1xuICAgIHRoaXMuX2luZGV4ID0ge307XG4gICAgdGhpcy5fbGlzdCA9IFtdO1xuICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDtcbiAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICB9O1xuICBUYWdzLnByb3RvdHlwZSA9IHthZGQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNoYW5nZWQgPSBmYWxzZTtcbiAgICB2YXIgdGFncyA9IHRoaXMuX3Byb2Nlc3NBcmd1bWVudHMoYXJndW1lbnRzLCB0cnVlKTtcbiAgICBpZiAoIXRhZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gY2hhbmdlZDtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRhZ3MubGVuZ3RoO2krKykge1xuICAgICAgaWYgKHRoaXMuX2luZGV4W3RhZ3NbaV1dKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICB0aGlzLl9pbmRleFt0YWdzW2ldXSA9IHRydWU7XG4gICAgICB0aGlzLl9saXN0LnB1c2godGFnc1tpXSk7XG4gICAgICB0aGlzLmZpcmUoXCJhZGRcIiwgdGFnc1tpXSwgdGhpcy5fcGFyZW50KTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgIHRoaXMuZmlyZShcImNoYW5nZVwiLCB0aGlzLl9wYXJlbnQpO1xuICAgIH1cbiAgICByZXR1cm4gY2hhbmdlZDtcbiAgfSwgcmVtb3ZlOmZ1bmN0aW9uKCkge1xuICAgIHZhciBjaGFuZ2VkID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLl9saXN0Lmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGNoYW5nZWQ7XG4gICAgfVxuICAgIHZhciB0YWdzID0gdGhpcy5fcHJvY2Vzc0FyZ3VtZW50cyhhcmd1bWVudHMsIHRydWUpO1xuICAgIGlmICghdGFncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGFncy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAoIXRoaXMuX2luZGV4W3RhZ3NbaV1dKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICBkZWxldGUgdGhpcy5faW5kZXhbdGFnc1tpXV07XG4gICAgICB0aGlzLl9saXN0LnNwbGljZSh0aGlzLl9saXN0LmluZGV4T2YodGFnc1tpXSksIDEpO1xuICAgICAgdGhpcy5maXJlKFwicmVtb3ZlXCIsIHRhZ3NbaV0sIHRoaXMuX3BhcmVudCk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICB0aGlzLmZpcmUoXCJjaGFuZ2VcIiwgdGhpcy5fcGFyZW50KTtcbiAgICB9XG4gICAgcmV0dXJuIGNoYW5nZWQ7XG4gIH0sIGNsZWFyOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fbGlzdC5sZW5ndGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHRhZ3MgPSB0aGlzLl9saXN0LnNsaWNlKDApO1xuICAgIHRoaXMuX2xpc3QgPSBbXTtcbiAgICB0aGlzLl9pbmRleCA9IHt9O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0YWdzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMuZmlyZShcInJlbW92ZVwiLCB0YWdzW2ldLCB0aGlzLl9wYXJlbnQpO1xuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJjaGFuZ2VcIiwgdGhpcy5fcGFyZW50KTtcbiAgfSwgaGFzOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fbGlzdC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2hhcyh0aGlzLl9wcm9jZXNzQXJndW1lbnRzKGFyZ3VtZW50cykpO1xuICB9LCBfaGFzOmZ1bmN0aW9uKHRhZ3MpIHtcbiAgICBpZiAoIXRoaXMuX2xpc3QubGVuZ3RoIHx8ICF0YWdzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGFncy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAodGFnc1tpXS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgaWYgKHRoaXMuX2luZGV4W3RhZ3NbaV1bMF1dKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBtdWx0aXBsZSA9IHRydWU7XG4gICAgICAgIGZvciAodmFyIHQgPSAwO3QgPCB0YWdzW2ldLmxlbmd0aDt0KyspIHtcbiAgICAgICAgICBpZiAodGhpcy5faW5kZXhbdGFnc1tpXVt0XV0pIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBtdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSwgbGlzdDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbGlzdC5zbGljZSgwKTtcbiAgfSwgX3Byb2Nlc3NBcmd1bWVudHM6ZnVuY3Rpb24oYXJncywgZmxhdCkge1xuICAgIHZhciB0YWdzID0gW107XG4gICAgdmFyIHRtcCA9IFtdO1xuICAgIGlmICghYXJncyB8fCAhYXJncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB0YWdzO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgYXJncy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAoYXJnc1tpXSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgIGlmICghZmxhdCkge1xuICAgICAgICAgIHRtcCA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIHQgPSAwO3QgPCBhcmdzW2ldLmxlbmd0aDt0KyspIHtcbiAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbaV1bdF0gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZmxhdCkge1xuICAgICAgICAgICAgdGFncy5wdXNoKGFyZ3NbaV1bdF0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0bXAucHVzaChhcmdzW2ldW3RdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFmbGF0ICYmIHRtcC5sZW5ndGgpIHtcbiAgICAgICAgICB0YWdzLnB1c2godG1wKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmdzW2ldID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgaWYgKGZsYXQpIHtcbiAgICAgICAgICAgIHRhZ3MucHVzaChhcmdzW2ldKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFncy5wdXNoKFthcmdzW2ldXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0YWdzO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRhZ3MucHJvdG90eXBlLCBcInNpemVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbGlzdC5sZW5ndGg7XG4gIH19KTtcbiAgcmV0dXJuIHtUYWdzQ2FjaGU6VGFnc0NhY2hlLCBUYWdzOlRhZ3N9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBBbGxvY2F0ZVBvb2wgPSBmdW5jdGlvbihjb25zdHJ1Y3Rvciwgc2l6ZSkge1xuICAgIHRoaXMuX2NvbnN0cnVjdG9yID0gY29uc3RydWN0b3I7XG4gICAgdGhpcy5fcG9vbCA9IFtdO1xuICAgIHRoaXMuX2NvdW50ID0gMDtcbiAgICB0aGlzLl9yZXNpemUoc2l6ZSk7XG4gIH07XG4gIEFsbG9jYXRlUG9vbC5wcm90b3R5cGUgPSB7X3Jlc2l6ZTpmdW5jdGlvbihzaXplKSB7XG4gICAgaWYgKHNpemUgPiB0aGlzLl9wb29sLmxlbmd0aCkge1xuICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3Bvb2wubGVuZ3RoO2kgPCBzaXplO2krKykge1xuICAgICAgICB0aGlzLl9wb29sW2ldID0gbmV3IHRoaXMuX2NvbnN0cnVjdG9yO1xuICAgICAgfVxuICAgIH1cbiAgfSwgYWxsb2NhdGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2NvdW50ID49IHRoaXMuX3Bvb2wubGVuZ3RoKSB7XG4gICAgICB0aGlzLl9yZXNpemUodGhpcy5fcG9vbC5sZW5ndGggKiAyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3Bvb2xbdGhpcy5fY291bnQrK107XG4gIH0sIGZyZWVBbGw6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fY291bnQgPSAwO1xuICB9fTtcbiAgcmV0dXJuIHtBbGxvY2F0ZVBvb2w6QWxsb2NhdGVQb29sfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgcGxhdGZvcm0gPSB7ZGVza3RvcDpmYWxzZSwgbW9iaWxlOmZhbHNlLCBpb3M6ZmFsc2UsIGFuZHJvaWQ6ZmFsc2UsIHdpbmRvd3M6ZmFsc2UsIGNvY29vbmpzOmZhbHNlLCB4Ym94OmZhbHNlLCBnYW1lcGFkczpmYWxzZSwgdG91Y2g6ZmFsc2V9O1xuICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50O1xuICBpZiAoLyh3aW5kb3dzfG1hYyBvc3xsaW51eHxjcm9zKS9pLnRlc3QodWEpKSB7XG4gICAgcGxhdGZvcm0uZGVza3RvcCA9IHRydWU7XG4gIH1cbiAgaWYgKC94Ym94L2kudGVzdCh1YSkpIHtcbiAgICBwbGF0Zm9ybS54Ym94ID0gdHJ1ZTtcbiAgfVxuICBpZiAoLyh3aW5kb3dzIHBob25lfGllbW9iaWxlfHdwZGVza3RvcCkvaS50ZXN0KHVhKSkge1xuICAgIHBsYXRmb3JtLmRlc2t0b3AgPSBmYWxzZTtcbiAgICBwbGF0Zm9ybS5tb2JpbGUgPSB0cnVlO1xuICAgIHBsYXRmb3JtLndpbmRvd3MgPSB0cnVlO1xuICB9IGVsc2Uge1xuICAgIGlmICgvYW5kcm9pZC9pLnRlc3QodWEpKSB7XG4gICAgICBwbGF0Zm9ybS5kZXNrdG9wID0gZmFsc2U7XG4gICAgICBwbGF0Zm9ybS5tb2JpbGUgPSB0cnVlO1xuICAgICAgcGxhdGZvcm0uYW5kcm9pZCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICgvaXAoW2FvXWR8aG9uZSkvaS50ZXN0KHVhKSkge1xuICAgICAgICBwbGF0Zm9ybS5kZXNrdG9wID0gZmFsc2U7XG4gICAgICAgIHBsYXRmb3JtLm1vYmlsZSA9IHRydWU7XG4gICAgICAgIHBsYXRmb3JtLmlvcyA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChuYXZpZ2F0b3IuaXNDb2Nvb25KUykge1xuICAgIHBsYXRmb3JtLmNvY29vbmpzID0gdHJ1ZTtcbiAgfVxuICBwbGF0Zm9ybS50b3VjaCA9IFwib250b3VjaHN0YXJ0XCIgaW4gd2luZG93O1xuICBwbGF0Zm9ybS5nYW1lcGFkcyA9IFwiZ2V0R2FtZXBhZHNcIiBpbiBuYXZpZ2F0b3I7XG4gIHJldHVybiB7cGxhdGZvcm06cGxhdGZvcm19O1xufSgpKTtcbnBjLm1hdGggPSB7REVHX1RPX1JBRDpNYXRoLlBJIC8gMTgwLCBSQURfVE9fREVHOjE4MCAvIE1hdGguUEksIElOVl9MT0cyOjEgLyBNYXRoLmxvZygyKSwgY2xhbXA6ZnVuY3Rpb24odmFsdWUsIG1pbiwgbWF4KSB7XG4gIGlmICh2YWx1ZSA+PSBtYXgpIHtcbiAgICByZXR1cm4gbWF4O1xuICB9XG4gIGlmICh2YWx1ZSA8PSBtaW4pIHtcbiAgICByZXR1cm4gbWluO1xuICB9XG4gIHJldHVybiB2YWx1ZTtcbn0sIGludFRvQnl0ZXMyNDpmdW5jdGlvbihpKSB7XG4gIHZhciByLCBnLCBiO1xuICByID0gaSA+PiAxNiAmIDI1NTtcbiAgZyA9IGkgPj4gOCAmIDI1NTtcbiAgYiA9IGkgJiAyNTU7XG4gIHJldHVybiBbciwgZywgYl07XG59LCBpbnRUb0J5dGVzMzI6ZnVuY3Rpb24oaSkge1xuICB2YXIgciwgZywgYiwgYTtcbiAgciA9IGkgPj4gMjQgJiAyNTU7XG4gIGcgPSBpID4+IDE2ICYgMjU1O1xuICBiID0gaSA+PiA4ICYgMjU1O1xuICBhID0gaSAmIDI1NTtcbiAgcmV0dXJuIFtyLCBnLCBiLCBhXTtcbn0sIGJ5dGVzVG9JbnQyNDpmdW5jdGlvbihyLCBnLCBiKSB7XG4gIGlmIChyLmxlbmd0aCkge1xuICAgIGIgPSByWzJdO1xuICAgIGcgPSByWzFdO1xuICAgIHIgPSByWzBdO1xuICB9XG4gIHJldHVybiByIDw8IDE2IHwgZyA8PCA4IHwgYjtcbn0sIGJ5dGVzVG9JbnQzMjpmdW5jdGlvbihyLCBnLCBiLCBhKSB7XG4gIGlmIChyLmxlbmd0aCkge1xuICAgIGEgPSByWzNdO1xuICAgIGIgPSByWzJdO1xuICAgIGcgPSByWzFdO1xuICAgIHIgPSByWzBdO1xuICB9XG4gIHJldHVybiAociA8PCAyNCB8IGcgPDwgMTYgfCBiIDw8IDggfCBhKSA+Pj4gMzI7XG59LCBsZXJwOmZ1bmN0aW9uKGEsIGIsIGFscGhhKSB7XG4gIHJldHVybiBhICsgKGIgLSBhKSAqIHBjLm1hdGguY2xhbXAoYWxwaGEsIDAsIDEpO1xufSwgbGVycEFuZ2xlOmZ1bmN0aW9uKGEsIGIsIGFscGhhKSB7XG4gIGlmIChiIC0gYSA+IDE4MCkge1xuICAgIGIgLT0gMzYwO1xuICB9XG4gIGlmIChiIC0gYSA8IC0xODApIHtcbiAgICBiICs9IDM2MDtcbiAgfVxuICByZXR1cm4gcGMubWF0aC5sZXJwKGEsIGIsIHBjLm1hdGguY2xhbXAoYWxwaGEsIDAsIDEpKTtcbn0sIHBvd2VyT2ZUd286ZnVuY3Rpb24oeCkge1xuICByZXR1cm4geCAhPT0gMCAmJiAhKHggJiB4IC0gMSk7XG59LCBuZXh0UG93ZXJPZlR3bzpmdW5jdGlvbih2YWwpIHtcbiAgdmFsLS07XG4gIHZhbCA9IHZhbCA+PiAxIHwgdmFsO1xuICB2YWwgPSB2YWwgPj4gMiB8IHZhbDtcbiAgdmFsID0gdmFsID4+IDQgfCB2YWw7XG4gIHZhbCA9IHZhbCA+PiA4IHwgdmFsO1xuICB2YWwgPSB2YWwgPj4gMTYgfCB2YWw7XG4gIHZhbCsrO1xuICByZXR1cm4gdmFsO1xufSwgcmFuZG9tOmZ1bmN0aW9uKG1pbiwgbWF4KSB7XG4gIHZhciBkaWZmID0gbWF4IC0gbWluO1xuICByZXR1cm4gTWF0aC5yYW5kb20oKSAqIGRpZmYgKyBtaW47XG59LCBzbW9vdGhzdGVwOmZ1bmN0aW9uKG1pbiwgbWF4LCB4KSB7XG4gIGlmICh4IDw9IG1pbikge1xuICAgIHJldHVybiAwO1xuICB9XG4gIGlmICh4ID49IG1heCkge1xuICAgIHJldHVybiAxO1xuICB9XG4gIHggPSAoeCAtIG1pbikgLyAobWF4IC0gbWluKTtcbiAgcmV0dXJuIHggKiB4ICogKDMgLSAyICogeCk7XG59LCBzbW9vdGhlcnN0ZXA6ZnVuY3Rpb24obWluLCBtYXgsIHgpIHtcbiAgaWYgKHggPD0gbWluKSB7XG4gICAgcmV0dXJuIDA7XG4gIH1cbiAgaWYgKHggPj0gbWF4KSB7XG4gICAgcmV0dXJuIDE7XG4gIH1cbiAgeCA9ICh4IC0gbWluKSAvIChtYXggLSBtaW4pO1xuICByZXR1cm4geCAqIHggKiB4ICogKHggKiAoeCAqIDYgLSAxNSkgKyAxMCk7XG59fTtcbnBjLm1hdGguaW50VG9CeXRlcyA9IHBjLm1hdGguaW50VG9CeXRlczMyO1xucGMubWF0aC5ieXRlc1RvSW50ID0gcGMubWF0aC5ieXRlc1RvSW50MzI7XG5pZiAoIU1hdGgubG9nMikge1xuICBNYXRoLmxvZzIgPSBmdW5jdGlvbih4KSB7XG4gICAgcmV0dXJuIE1hdGgubG9nKHgpICogcGMubWF0aC5JTlZfTE9HMjtcbiAgfTtcbn1cbjtwYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgVmVjMiA9IGZ1bmN0aW9uKHgsIHkpIHtcbiAgICBpZiAoeCAmJiB4Lmxlbmd0aCA9PT0gMikge1xuICAgICAgdGhpcy5kYXRhID0gbmV3IEZsb2F0MzJBcnJheSh4KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5kYXRhID0gbmV3IEZsb2F0MzJBcnJheSgyKTtcbiAgICB0aGlzLmRhdGFbMF0gPSB4IHx8IDA7XG4gICAgdGhpcy5kYXRhWzFdID0geSB8fCAwO1xuICB9O1xuICBWZWMyLnByb3RvdHlwZSA9IHthZGQ6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdICs9IGJbMF07XG4gICAgYVsxXSArPSBiWzFdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBhZGQyOmZ1bmN0aW9uKGxocywgcmhzKSB7XG4gICAgdmFyIGEgPSBsaHMuZGF0YSwgYiA9IHJocy5kYXRhLCByID0gdGhpcy5kYXRhO1xuICAgIHJbMF0gPSBhWzBdICsgYlswXTtcbiAgICByWzFdID0gYVsxXSArIGJbMV07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAobmV3IFZlYzIpLmNvcHkodGhpcyk7XG4gIH0sIGNvcHk6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdID0gYlswXTtcbiAgICBhWzFdID0gYlsxXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgZG90OmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgcmV0dXJuIGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV07XG4gIH0sIGVxdWFsczpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YSwgYiA9IHJocy5kYXRhO1xuICAgIHJldHVybiBhWzBdID09PSBiWzBdICYmIGFbMV0gPT09IGJbMV07XG4gIH0sIGxlbmd0aDpmdW5jdGlvbigpIHtcbiAgICB2YXIgdiA9IHRoaXMuZGF0YTtcbiAgICByZXR1cm4gTWF0aC5zcXJ0KHZbMF0gKiB2WzBdICsgdlsxXSAqIHZbMV0pO1xuICB9LCBsZW5ndGhTcTpmdW5jdGlvbigpIHtcbiAgICB2YXIgdiA9IHRoaXMuZGF0YTtcbiAgICByZXR1cm4gdlswXSAqIHZbMF0gKyB2WzFdICogdlsxXTtcbiAgfSwgbGVycDpmdW5jdGlvbihsaHMsIHJocywgYWxwaGEpIHtcbiAgICB2YXIgYSA9IGxocy5kYXRhLCBiID0gcmhzLmRhdGEsIHIgPSB0aGlzLmRhdGE7XG4gICAgclswXSA9IGFbMF0gKyBhbHBoYSAqIChiWzBdIC0gYVswXSk7XG4gICAgclsxXSA9IGFbMV0gKyBhbHBoYSAqIChiWzFdIC0gYVsxXSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIG11bDpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YSwgYiA9IHJocy5kYXRhO1xuICAgIGFbMF0gKj0gYlswXTtcbiAgICBhWzFdICo9IGJbMV07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIG11bDI6ZnVuY3Rpb24obGhzLCByaHMpIHtcbiAgICB2YXIgYSA9IGxocy5kYXRhLCBiID0gcmhzLmRhdGEsIHIgPSB0aGlzLmRhdGE7XG4gICAgclswXSA9IGFbMF0gKiBiWzBdO1xuICAgIHJbMV0gPSBhWzFdICogYlsxXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgbm9ybWFsaXplOmZ1bmN0aW9uKCkge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZhciBsZW5ndGhTcSA9IHZbMF0gKiB2WzBdICsgdlsxXSAqIHZbMV07XG4gICAgaWYgKGxlbmd0aFNxID4gMCkge1xuICAgICAgdmFyIGludkxlbmd0aCA9IDEgLyBNYXRoLnNxcnQobGVuZ3RoU3EpO1xuICAgICAgdlswXSAqPSBpbnZMZW5ndGg7XG4gICAgICB2WzFdICo9IGludkxlbmd0aDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNjYWxlOmZ1bmN0aW9uKHNjYWxhcikge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZbMF0gKj0gc2NhbGFyO1xuICAgIHZbMV0gKj0gc2NhbGFyO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXQ6ZnVuY3Rpb24oeCwgeSkge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZbMF0gPSB4O1xuICAgIHZbMV0gPSB5O1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzdWI6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdIC09IGJbMF07XG4gICAgYVsxXSAtPSBiWzFdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzdWIyOmZ1bmN0aW9uKGxocywgcmhzKSB7XG4gICAgdmFyIGEgPSBsaHMuZGF0YSwgYiA9IHJocy5kYXRhLCByID0gdGhpcy5kYXRhO1xuICAgIHJbMF0gPSBhWzBdIC0gYlswXTtcbiAgICByWzFdID0gYVsxXSAtIGJbMV07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHRvU3RyaW5nOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBcIltcIiArIHRoaXMuZGF0YVswXSArIFwiLCBcIiArIHRoaXMuZGF0YVsxXSArIFwiXVwiO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzIucHJvdG90eXBlLCBcInhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhWzBdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLmRhdGFbMF0gPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMi5wcm90b3R5cGUsIFwieVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMV07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVsxXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWMyLCBcIk9ORVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBvbmUgPSBuZXcgVmVjMigxLCAxKTtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gb25lO1xuICAgIH07XG4gIH0oKX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMiwgXCJSSUdIVFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciByaWdodCA9IG5ldyBWZWMyKDEsIDApO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiByaWdodDtcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzIsIFwiVVBcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgZG93biA9IG5ldyBWZWMyKDAsIDEpO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBkb3duO1xuICAgIH07XG4gIH0oKX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMiwgXCJaRVJPXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHplcm8gPSBuZXcgVmVjMigwLCAwKTtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gemVybztcbiAgICB9O1xuICB9KCl9KTtcbiAgcmV0dXJuIHtWZWMyOlZlYzJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBWZWMzID0gZnVuY3Rpb24oeCwgeSwgeikge1xuICAgIGlmICh4ICYmIHgubGVuZ3RoID09PSAzKSB7XG4gICAgICB0aGlzLmRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KDMpO1xuICAgIHRoaXMuZGF0YVswXSA9IHggfHwgMDtcbiAgICB0aGlzLmRhdGFbMV0gPSB5IHx8IDA7XG4gICAgdGhpcy5kYXRhWzJdID0geiB8fCAwO1xuICB9O1xuICBWZWMzLnByb3RvdHlwZSA9IHthZGQ6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdICs9IGJbMF07XG4gICAgYVsxXSArPSBiWzFdO1xuICAgIGFbMl0gKz0gYlsyXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgYWRkMjpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSArIGJbMF07XG4gICAgclsxXSA9IGFbMV0gKyBiWzFdO1xuICAgIHJbMl0gPSBhWzJdICsgYlsyXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgY2xvbmU6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIChuZXcgVmVjMykuY29weSh0aGlzKTtcbiAgfSwgY29weTpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YSwgYiA9IHJocy5kYXRhO1xuICAgIGFbMF0gPSBiWzBdO1xuICAgIGFbMV0gPSBiWzFdO1xuICAgIGFbMl0gPSBiWzJdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBjcm9zczpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhLCBiLCByLCBheCwgYXksIGF6LCBieCwgYnksIGJ6O1xuICAgIGEgPSBsaHMuZGF0YTtcbiAgICBiID0gcmhzLmRhdGE7XG4gICAgciA9IHRoaXMuZGF0YTtcbiAgICBheCA9IGFbMF07XG4gICAgYXkgPSBhWzFdO1xuICAgIGF6ID0gYVsyXTtcbiAgICBieCA9IGJbMF07XG4gICAgYnkgPSBiWzFdO1xuICAgIGJ6ID0gYlsyXTtcbiAgICByWzBdID0gYXkgKiBieiAtIGJ5ICogYXo7XG4gICAgclsxXSA9IGF6ICogYnggLSBieiAqIGF4O1xuICAgIHJbMl0gPSBheCAqIGJ5IC0gYnggKiBheTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgZG90OmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgcmV0dXJuIGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV0gKyBhWzJdICogYlsyXTtcbiAgfSwgZXF1YWxzOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgcmV0dXJuIGFbMF0gPT09IGJbMF0gJiYgYVsxXSA9PT0gYlsxXSAmJiBhWzJdID09PSBiWzJdO1xuICB9LCBsZW5ndGg6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHYgPSB0aGlzLmRhdGE7XG4gICAgcmV0dXJuIE1hdGguc3FydCh2WzBdICogdlswXSArIHZbMV0gKiB2WzFdICsgdlsyXSAqIHZbMl0pO1xuICB9LCBsZW5ndGhTcTpmdW5jdGlvbigpIHtcbiAgICB2YXIgdiA9IHRoaXMuZGF0YTtcbiAgICByZXR1cm4gdlswXSAqIHZbMF0gKyB2WzFdICogdlsxXSArIHZbMl0gKiB2WzJdO1xuICB9LCBsZXJwOmZ1bmN0aW9uKGxocywgcmhzLCBhbHBoYSkge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSArIGFscGhhICogKGJbMF0gLSBhWzBdKTtcbiAgICByWzFdID0gYVsxXSArIGFscGhhICogKGJbMV0gLSBhWzFdKTtcbiAgICByWzJdID0gYVsyXSArIGFscGhhICogKGJbMl0gLSBhWzJdKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgbXVsOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgYVswXSAqPSBiWzBdO1xuICAgIGFbMV0gKj0gYlsxXTtcbiAgICBhWzJdICo9IGJbMl07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIG11bDI6ZnVuY3Rpb24obGhzLCByaHMpIHtcbiAgICB2YXIgYSA9IGxocy5kYXRhLCBiID0gcmhzLmRhdGEsIHIgPSB0aGlzLmRhdGE7XG4gICAgclswXSA9IGFbMF0gKiBiWzBdO1xuICAgIHJbMV0gPSBhWzFdICogYlsxXTtcbiAgICByWzJdID0gYVsyXSAqIGJbMl07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIG5vcm1hbGl6ZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgdiA9IHRoaXMuZGF0YTtcbiAgICB2YXIgbGVuZ3RoU3EgPSB2WzBdICogdlswXSArIHZbMV0gKiB2WzFdICsgdlsyXSAqIHZbMl07XG4gICAgaWYgKGxlbmd0aFNxID4gMCkge1xuICAgICAgdmFyIGludkxlbmd0aCA9IDEgLyBNYXRoLnNxcnQobGVuZ3RoU3EpO1xuICAgICAgdlswXSAqPSBpbnZMZW5ndGg7XG4gICAgICB2WzFdICo9IGludkxlbmd0aDtcbiAgICAgIHZbMl0gKj0gaW52TGVuZ3RoO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfSwgcHJvamVjdDpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YTtcbiAgICB2YXIgYiA9IHJocy5kYXRhO1xuICAgIHZhciBhX2RvdF9iID0gYVswXSAqIGJbMF0gKyBhWzFdICogYlsxXSArIGFbMl0gKiBiWzJdO1xuICAgIHZhciBiX2RvdF9iID0gYlswXSAqIGJbMF0gKyBiWzFdICogYlsxXSArIGJbMl0gKiBiWzJdO1xuICAgIHZhciBzID0gYV9kb3RfYiAvIGJfZG90X2I7XG4gICAgYVswXSA9IGJbMF0gKiBzO1xuICAgIGFbMV0gPSBiWzFdICogcztcbiAgICBhWzJdID0gYlsyXSAqIHM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNjYWxlOmZ1bmN0aW9uKHNjYWxhcikge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZbMF0gKj0gc2NhbGFyO1xuICAgIHZbMV0gKj0gc2NhbGFyO1xuICAgIHZbMl0gKj0gc2NhbGFyO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXQ6ZnVuY3Rpb24oeCwgeSwgeikge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZbMF0gPSB4O1xuICAgIHZbMV0gPSB5O1xuICAgIHZbMl0gPSB6O1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzdWI6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdIC09IGJbMF07XG4gICAgYVsxXSAtPSBiWzFdO1xuICAgIGFbMl0gLT0gYlsyXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc3ViMjpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSAtIGJbMF07XG4gICAgclsxXSA9IGFbMV0gLSBiWzFdO1xuICAgIHJbMl0gPSBhWzJdIC0gYlsyXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgdG9TdHJpbmc6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFwiW1wiICsgdGhpcy5kYXRhWzBdICsgXCIsIFwiICsgdGhpcy5kYXRhWzFdICsgXCIsIFwiICsgdGhpcy5kYXRhWzJdICsgXCJdXCI7XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMy5wcm90b3R5cGUsIFwieFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMF07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVswXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWMzLnByb3RvdHlwZSwgXCJ5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVsxXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5kYXRhWzFdID0gdmFsdWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzMucHJvdG90eXBlLCBcInpcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhWzJdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLmRhdGFbMl0gPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMywgXCJCQUNLXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGJhY2sgPSBuZXcgVmVjMygwLCAwLCAxKTtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gYmFjaztcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzMsIFwiRE9XTlwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBkb3duID0gbmV3IFZlYzMoMCwgLTEsIDApO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBkb3duO1xuICAgIH07XG4gIH0oKX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMywgXCJGT1JXQVJEXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGZvcndhcmQgPSBuZXcgVmVjMygwLCAwLCAtMSk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGZvcndhcmQ7XG4gICAgfTtcbiAgfSgpfSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWMzLCBcIkxFRlRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgbGVmdCA9IG5ldyBWZWMzKC0xLCAwLCAwKTtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gbGVmdDtcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzMsIFwiT05FXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG9uZSA9IG5ldyBWZWMzKDEsIDEsIDEpO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBvbmU7XG4gICAgfTtcbiAgfSgpfSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWMzLCBcIlJJR0hUXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHJpZ2h0ID0gbmV3IFZlYzMoMSwgMCwgMCk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHJpZ2h0O1xuICAgIH07XG4gIH0oKX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjMywgXCJVUFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBkb3duID0gbmV3IFZlYzMoMCwgMSwgMCk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGRvd247XG4gICAgfTtcbiAgfSgpfSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWMzLCBcIlpFUk9cIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgemVybyA9IG5ldyBWZWMzKDAsIDAsIDApO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB6ZXJvO1xuICAgIH07XG4gIH0oKX0pO1xuICByZXR1cm4ge1ZlYzM6VmVjM307XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFZlYzQgPSBmdW5jdGlvbih4LCB5LCB6LCB3KSB7XG4gICAgaWYgKHggJiYgeC5sZW5ndGggPT09IDQpIHtcbiAgICAgIHRoaXMuZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoeCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoNCk7XG4gICAgdGhpcy5kYXRhWzBdID0geCB8fCAwO1xuICAgIHRoaXMuZGF0YVsxXSA9IHkgfHwgMDtcbiAgICB0aGlzLmRhdGFbMl0gPSB6IHx8IDA7XG4gICAgdGhpcy5kYXRhWzNdID0gdyB8fCAwO1xuICB9O1xuICBWZWM0LnByb3RvdHlwZSA9IHthZGQ6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGEgPSB0aGlzLmRhdGEsIGIgPSByaHMuZGF0YTtcbiAgICBhWzBdICs9IGJbMF07XG4gICAgYVsxXSArPSBiWzFdO1xuICAgIGFbMl0gKz0gYlsyXTtcbiAgICBhWzNdICs9IGJbM107XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGFkZDI6ZnVuY3Rpb24obGhzLCByaHMpIHtcbiAgICB2YXIgYSA9IGxocy5kYXRhLCBiID0gcmhzLmRhdGEsIHIgPSB0aGlzLmRhdGE7XG4gICAgclswXSA9IGFbMF0gKyBiWzBdO1xuICAgIHJbMV0gPSBhWzFdICsgYlsxXTtcbiAgICByWzJdID0gYVsyXSArIGJbMl07XG4gICAgclszXSA9IGFbM10gKyBiWzNdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBjbG9uZTpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gKG5ldyBWZWM0KS5jb3B5KHRoaXMpO1xuICB9LCBjb3B5OmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgYVswXSA9IGJbMF07XG4gICAgYVsxXSA9IGJbMV07XG4gICAgYVsyXSA9IGJbMl07XG4gICAgYVszXSA9IGJbM107XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGRvdDpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YSwgYiA9IHJocy5kYXRhO1xuICAgIHJldHVybiBhWzBdICogYlswXSArIGFbMV0gKiBiWzFdICsgYVsyXSAqIGJbMl0gKyBhWzNdICogYlszXTtcbiAgfSwgZXF1YWxzOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgcmV0dXJuIGFbMF0gPT09IGJbMF0gJiYgYVsxXSA9PT0gYlsxXSAmJiBhWzJdID09PSBiWzJdICYmIGFbM10gPT09IGJbM107XG4gIH0sIGxlbmd0aDpmdW5jdGlvbigpIHtcbiAgICB2YXIgdiA9IHRoaXMuZGF0YTtcbiAgICByZXR1cm4gTWF0aC5zcXJ0KHZbMF0gKiB2WzBdICsgdlsxXSAqIHZbMV0gKyB2WzJdICogdlsyXSArIHZbM10gKiB2WzNdKTtcbiAgfSwgbGVuZ3RoU3E6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHYgPSB0aGlzLmRhdGE7XG4gICAgcmV0dXJuIHZbMF0gKiB2WzBdICsgdlsxXSAqIHZbMV0gKyB2WzJdICogdlsyXSArIHZbM10gKiB2WzNdO1xuICB9LCBsZXJwOmZ1bmN0aW9uKGxocywgcmhzLCBhbHBoYSkge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSArIGFscGhhICogKGJbMF0gLSBhWzBdKTtcbiAgICByWzFdID0gYVsxXSArIGFscGhhICogKGJbMV0gLSBhWzFdKTtcbiAgICByWzJdID0gYVsyXSArIGFscGhhICogKGJbMl0gLSBhWzJdKTtcbiAgICByWzNdID0gYVszXSArIGFscGhhICogKGJbM10gLSBhWzNdKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgbXVsOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBhID0gdGhpcy5kYXRhLCBiID0gcmhzLmRhdGE7XG4gICAgYVswXSAqPSBiWzBdO1xuICAgIGFbMV0gKj0gYlsxXTtcbiAgICBhWzJdICo9IGJbMl07XG4gICAgYVszXSAqPSBiWzNdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBtdWwyOmZ1bmN0aW9uKGxocywgcmhzKSB7XG4gICAgdmFyIGEgPSBsaHMuZGF0YSwgYiA9IHJocy5kYXRhLCByID0gdGhpcy5kYXRhO1xuICAgIHJbMF0gPSBhWzBdICogYlswXTtcbiAgICByWzFdID0gYVsxXSAqIGJbMV07XG4gICAgclsyXSA9IGFbMl0gKiBiWzJdO1xuICAgIHJbM10gPSBhWzNdICogYlszXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgbm9ybWFsaXplOmZ1bmN0aW9uKCkge1xuICAgIHZhciB2ID0gdGhpcy5kYXRhO1xuICAgIHZhciBsZW5ndGhTcSA9IHZbMF0gKiB2WzBdICsgdlsxXSAqIHZbMV0gKyB2WzJdICogdlsyXSArIHZbM10gKiB2WzNdO1xuICAgIGlmIChsZW5ndGhTcSA+IDApIHtcbiAgICAgIHZhciBpbnZMZW5ndGggPSAxIC8gTWF0aC5zcXJ0KGxlbmd0aFNxKTtcbiAgICAgIHZbMF0gKj0gaW52TGVuZ3RoO1xuICAgICAgdlsxXSAqPSBpbnZMZW5ndGg7XG4gICAgICB2WzJdICo9IGludkxlbmd0aDtcbiAgICAgIHZbM10gKj0gaW52TGVuZ3RoO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2NhbGU6ZnVuY3Rpb24oc2NhbGFyKSB7XG4gICAgdmFyIHYgPSB0aGlzLmRhdGE7XG4gICAgdlswXSAqPSBzY2FsYXI7XG4gICAgdlsxXSAqPSBzY2FsYXI7XG4gICAgdlsyXSAqPSBzY2FsYXI7XG4gICAgdlszXSAqPSBzY2FsYXI7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNldDpmdW5jdGlvbih4LCB5LCB6LCB3KSB7XG4gICAgdmFyIHYgPSB0aGlzLmRhdGE7XG4gICAgdlswXSA9IHg7XG4gICAgdlsxXSA9IHk7XG4gICAgdlsyXSA9IHo7XG4gICAgdlszXSA9IHc7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHN1YjpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgYSA9IHRoaXMuZGF0YSwgYiA9IHJocy5kYXRhO1xuICAgIGFbMF0gLT0gYlswXTtcbiAgICBhWzFdIC09IGJbMV07XG4gICAgYVsyXSAtPSBiWzJdO1xuICAgIGFbM10gLT0gYlszXTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc3ViMjpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSAtIGJbMF07XG4gICAgclsxXSA9IGFbMV0gLSBiWzFdO1xuICAgIHJbMl0gPSBhWzJdIC0gYlsyXTtcbiAgICByWzNdID0gYVszXSAtIGJbM107XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHRvU3RyaW5nOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBcIltcIiArIHRoaXMuZGF0YVswXSArIFwiLCBcIiArIHRoaXMuZGF0YVsxXSArIFwiLCBcIiArIHRoaXMuZGF0YVsyXSArIFwiLCBcIiArIHRoaXMuZGF0YVszXSArIFwiXVwiO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzQucHJvdG90eXBlLCBcInhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhWzBdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLmRhdGFbMF0gPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjNC5wcm90b3R5cGUsIFwieVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFbMV07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuZGF0YVsxXSA9IHZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWZWM0LnByb3RvdHlwZSwgXCJ6XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVsyXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5kYXRhWzJdID0gdmFsdWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzQucHJvdG90eXBlLCBcIndcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhWzNdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLmRhdGFbM10gPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVmVjNCwgXCJPTkVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgb25lID0gbmV3IFZlYzQoMSwgMSwgMSwgMSk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIG9uZTtcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZlYzQsIFwiWkVST1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciB6ZXJvID0gbmV3IFZlYzQoMCwgMCwgMCwgMCk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHplcm87XG4gICAgfTtcbiAgfSgpfSk7XG4gIHJldHVybiB7VmVjNDpWZWM0fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgdHlwZU51bWJlciA9IFwibnVtYmVyXCI7XG4gIHZhciBNYXQzID0gZnVuY3Rpb24odjAsIHYxLCB2MiwgdjMsIHY0LCB2NSwgdjYsIHY3LCB2OCkge1xuICAgIGlmICh2MCAmJiB2MC5sZW5ndGggPT09IDkpIHtcbiAgICAgIHRoaXMuZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodjApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KDkpO1xuICAgIGlmICh0eXBlb2YgdjAgPT09IHR5cGVOdW1iZXIpIHtcbiAgICAgIHRoaXMuZGF0YVswXSA9IHYwO1xuICAgICAgdGhpcy5kYXRhWzFdID0gdjE7XG4gICAgICB0aGlzLmRhdGFbMl0gPSB2MjtcbiAgICAgIHRoaXMuZGF0YVszXSA9IHYzO1xuICAgICAgdGhpcy5kYXRhWzRdID0gdjQ7XG4gICAgICB0aGlzLmRhdGFbNV0gPSB2NTtcbiAgICAgIHRoaXMuZGF0YVs2XSA9IHY2O1xuICAgICAgdGhpcy5kYXRhWzddID0gdjc7XG4gICAgICB0aGlzLmRhdGFbOF0gPSB2ODtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRJZGVudGl0eSgpO1xuICAgIH1cbiAgfTtcbiAgTWF0My5wcm90b3R5cGUgPSB7Y2xvbmU6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIChuZXcgcGMuTWF0MykuY29weSh0aGlzKTtcbiAgfSwgY29weTpmdW5jdGlvbihyaHMpIHtcbiAgICB2YXIgc3JjID0gcmhzLmRhdGE7XG4gICAgdmFyIGRzdCA9IHRoaXMuZGF0YTtcbiAgICBkc3RbMF0gPSBzcmNbMF07XG4gICAgZHN0WzFdID0gc3JjWzFdO1xuICAgIGRzdFsyXSA9IHNyY1syXTtcbiAgICBkc3RbM10gPSBzcmNbM107XG4gICAgZHN0WzRdID0gc3JjWzRdO1xuICAgIGRzdFs1XSA9IHNyY1s1XTtcbiAgICBkc3RbNl0gPSBzcmNbNl07XG4gICAgZHN0WzddID0gc3JjWzddO1xuICAgIGRzdFs4XSA9IHNyY1s4XTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgZXF1YWxzOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBsID0gdGhpcy5kYXRhO1xuICAgIHZhciByID0gcmhzLmRhdGE7XG4gICAgcmV0dXJuIGxbMF0gPT09IHJbMF0gJiYgbFsxXSA9PT0gclsxXSAmJiBsWzJdID09PSByWzJdICYmIGxbM10gPT09IHJbM10gJiYgbFs0XSA9PT0gcls0XSAmJiBsWzVdID09PSByWzVdICYmIGxbNl0gPT09IHJbNl0gJiYgbFs3XSA9PT0gcls3XSAmJiBsWzhdID09PSByWzhdO1xuICB9LCBpc0lkZW50aXR5OmZ1bmN0aW9uKCkge1xuICAgIHZhciBtID0gdGhpcy5kYXRhO1xuICAgIHJldHVybiBtWzBdID09PSAxICYmIG1bMV0gPT09IDAgJiYgbVsyXSA9PT0gMCAmJiBtWzNdID09PSAwICYmIG1bNF0gPT09IDEgJiYgbVs1XSA9PT0gMCAmJiBtWzZdID09PSAwICYmIG1bN10gPT09IDAgJiYgbVs4XSA9PT0gMTtcbiAgfSwgc2V0SWRlbnRpdHk6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG0gPSB0aGlzLmRhdGE7XG4gICAgbVswXSA9IDE7XG4gICAgbVsxXSA9IDA7XG4gICAgbVsyXSA9IDA7XG4gICAgbVszXSA9IDA7XG4gICAgbVs0XSA9IDE7XG4gICAgbVs1XSA9IDA7XG4gICAgbVs2XSA9IDA7XG4gICAgbVs3XSA9IDA7XG4gICAgbVs4XSA9IDE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHRvU3RyaW5nOmZ1bmN0aW9uKCkge1xuICAgIHZhciB0ID0gXCJbXCI7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDk7aSsrKSB7XG4gICAgICB0ICs9IHRoaXMuZGF0YVtpXTtcbiAgICAgIHQgKz0gaSAhPT0gOSA/IFwiLCBcIiA6IFwiXCI7XG4gICAgfVxuICAgIHQgKz0gXCJdXCI7XG4gICAgcmV0dXJuIHQ7XG4gIH0sIHRyYW5zcG9zZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgbSA9IHRoaXMuZGF0YTtcbiAgICB2YXIgdG1wO1xuICAgIHRtcCA9IG1bMV07XG4gICAgbVsxXSA9IG1bM107XG4gICAgbVszXSA9IHRtcDtcbiAgICB0bXAgPSBtWzJdO1xuICAgIG1bMl0gPSBtWzZdO1xuICAgIG1bNl0gPSB0bXA7XG4gICAgdG1wID0gbVs1XTtcbiAgICBtWzVdID0gbVs3XTtcbiAgICBtWzddID0gdG1wO1xuICAgIHJldHVybiB0aGlzO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1hdDMsIFwiSURFTlRJVFlcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaWRlbnRpdHkgPSBuZXcgTWF0MztcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gaWRlbnRpdHk7XG4gICAgfTtcbiAgfSgpfSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNYXQzLCBcIlpFUk9cIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgemVybyA9IG5ldyBNYXQzKDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDApO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB6ZXJvO1xuICAgIH07XG4gIH0oKX0pO1xuICByZXR1cm4ge01hdDM6TWF0M307XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIHR5cGVOdW1iZXIgPSBcIm51bWJlclwiO1xuICB2YXIgTWF0NCA9IGZ1bmN0aW9uKHYwLCB2MSwgdjIsIHYzLCB2NCwgdjUsIHY2LCB2NywgdjgsIHY5LCB2MTAsIHYxMSwgdjEyLCB2MTMsIHYxNCwgdjE1KSB7XG4gICAgaWYgKHYwICYmIHYwLmxlbmd0aCA9PT0gMTYpIHtcbiAgICAgIHRoaXMuZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodjApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KDE2KTtcbiAgICBpZiAodHlwZW9mIHYwID09PSB0eXBlTnVtYmVyKSB7XG4gICAgICB0aGlzLmRhdGFbMF0gPSB2MDtcbiAgICAgIHRoaXMuZGF0YVsxXSA9IHYxO1xuICAgICAgdGhpcy5kYXRhWzJdID0gdjI7XG4gICAgICB0aGlzLmRhdGFbM10gPSB2MztcbiAgICAgIHRoaXMuZGF0YVs0XSA9IHY0O1xuICAgICAgdGhpcy5kYXRhWzVdID0gdjU7XG4gICAgICB0aGlzLmRhdGFbNl0gPSB2NjtcbiAgICAgIHRoaXMuZGF0YVs3XSA9IHY3O1xuICAgICAgdGhpcy5kYXRhWzhdID0gdjg7XG4gICAgICB0aGlzLmRhdGFbOV0gPSB2OTtcbiAgICAgIHRoaXMuZGF0YVsxMF0gPSB2MTA7XG4gICAgICB0aGlzLmRhdGFbMTFdID0gdjExO1xuICAgICAgdGhpcy5kYXRhWzEyXSA9IHYxMjtcbiAgICAgIHRoaXMuZGF0YVsxM10gPSB2MTM7XG4gICAgICB0aGlzLmRhdGFbMTRdID0gdjE0O1xuICAgICAgdGhpcy5kYXRhWzE1XSA9IHYxNTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRJZGVudGl0eSgpO1xuICAgIH1cbiAgfTtcbiAgTWF0NC5wcm90b3R5cGUgPSB7YWRkMjpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gYVswXSArIGJbMF07XG4gICAgclsxXSA9IGFbMV0gKyBiWzFdO1xuICAgIHJbMl0gPSBhWzJdICsgYlsyXTtcbiAgICByWzNdID0gYVszXSArIGJbM107XG4gICAgcls0XSA9IGFbNF0gKyBiWzRdO1xuICAgIHJbNV0gPSBhWzVdICsgYls1XTtcbiAgICByWzZdID0gYVs2XSArIGJbNl07XG4gICAgcls3XSA9IGFbN10gKyBiWzddO1xuICAgIHJbOF0gPSBhWzhdICsgYls4XTtcbiAgICByWzldID0gYVs5XSArIGJbOV07XG4gICAgclsxMF0gPSBhWzEwXSArIGJbMTBdO1xuICAgIHJbMTFdID0gYVsxMV0gKyBiWzExXTtcbiAgICByWzEyXSA9IGFbMTJdICsgYlsxMl07XG4gICAgclsxM10gPSBhWzEzXSArIGJbMTNdO1xuICAgIHJbMTRdID0gYVsxNF0gKyBiWzE0XTtcbiAgICByWzE1XSA9IGFbMTVdICsgYlsxNV07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGFkZDpmdW5jdGlvbihyaHMpIHtcbiAgICByZXR1cm4gdGhpcy5hZGQyKHRoaXMsIHJocyk7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAobmV3IHBjLk1hdDQpLmNvcHkodGhpcyk7XG4gIH0sIGNvcHk6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIHNyYyA9IHJocy5kYXRhLCBkc3QgPSB0aGlzLmRhdGE7XG4gICAgZHN0WzBdID0gc3JjWzBdO1xuICAgIGRzdFsxXSA9IHNyY1sxXTtcbiAgICBkc3RbMl0gPSBzcmNbMl07XG4gICAgZHN0WzNdID0gc3JjWzNdO1xuICAgIGRzdFs0XSA9IHNyY1s0XTtcbiAgICBkc3RbNV0gPSBzcmNbNV07XG4gICAgZHN0WzZdID0gc3JjWzZdO1xuICAgIGRzdFs3XSA9IHNyY1s3XTtcbiAgICBkc3RbOF0gPSBzcmNbOF07XG4gICAgZHN0WzldID0gc3JjWzldO1xuICAgIGRzdFsxMF0gPSBzcmNbMTBdO1xuICAgIGRzdFsxMV0gPSBzcmNbMTFdO1xuICAgIGRzdFsxMl0gPSBzcmNbMTJdO1xuICAgIGRzdFsxM10gPSBzcmNbMTNdO1xuICAgIGRzdFsxNF0gPSBzcmNbMTRdO1xuICAgIGRzdFsxNV0gPSBzcmNbMTVdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBlcXVhbHM6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdmFyIGwgPSB0aGlzLmRhdGEsIHIgPSByaHMuZGF0YTtcbiAgICByZXR1cm4gbFswXSA9PT0gclswXSAmJiBsWzFdID09PSByWzFdICYmIGxbMl0gPT09IHJbMl0gJiYgbFszXSA9PT0gclszXSAmJiBsWzRdID09PSByWzRdICYmIGxbNV0gPT09IHJbNV0gJiYgbFs2XSA9PT0gcls2XSAmJiBsWzddID09PSByWzddICYmIGxbOF0gPT09IHJbOF0gJiYgbFs5XSA9PT0gcls5XSAmJiBsWzEwXSA9PT0gclsxMF0gJiYgbFsxMV0gPT09IHJbMTFdICYmIGxbMTJdID09PSByWzEyXSAmJiBsWzEzXSA9PT0gclsxM10gJiYgbFsxNF0gPT09IHJbMTRdICYmIGxbMTVdID09PSByWzE1XTtcbiAgfSwgaXNJZGVudGl0eTpmdW5jdGlvbigpIHtcbiAgICB2YXIgbSA9IHRoaXMuZGF0YTtcbiAgICByZXR1cm4gbVswXSA9PT0gMSAmJiBtWzFdID09PSAwICYmIG1bMl0gPT09IDAgJiYgbVszXSA9PT0gMCAmJiBtWzRdID09PSAwICYmIG1bNV0gPT09IDEgJiYgbVs2XSA9PT0gMCAmJiBtWzddID09PSAwICYmIG1bOF0gPT09IDAgJiYgbVs5XSA9PT0gMCAmJiBtWzEwXSA9PT0gMSAmJiBtWzExXSA9PT0gMCAmJiBtWzEyXSA9PT0gMCAmJiBtWzEzXSA9PT0gMCAmJiBtWzE0XSA9PT0gMCAmJiBtWzE1XSA9PT0gMTtcbiAgfSwgbXVsMjpmdW5jdGlvbihsaHMsIHJocykge1xuICAgIHZhciBhMDAsIGEwMSwgYTAyLCBhMDMsIGExMCwgYTExLCBhMTIsIGExMywgYTIwLCBhMjEsIGEyMiwgYTIzLCBhMzAsIGEzMSwgYTMyLCBhMzMsIGIwLCBiMSwgYjIsIGIzLCBhID0gbGhzLmRhdGEsIGIgPSByaHMuZGF0YSwgciA9IHRoaXMuZGF0YTtcbiAgICBhMDAgPSBhWzBdO1xuICAgIGEwMSA9IGFbMV07XG4gICAgYTAyID0gYVsyXTtcbiAgICBhMDMgPSBhWzNdO1xuICAgIGExMCA9IGFbNF07XG4gICAgYTExID0gYVs1XTtcbiAgICBhMTIgPSBhWzZdO1xuICAgIGExMyA9IGFbN107XG4gICAgYTIwID0gYVs4XTtcbiAgICBhMjEgPSBhWzldO1xuICAgIGEyMiA9IGFbMTBdO1xuICAgIGEyMyA9IGFbMTFdO1xuICAgIGEzMCA9IGFbMTJdO1xuICAgIGEzMSA9IGFbMTNdO1xuICAgIGEzMiA9IGFbMTRdO1xuICAgIGEzMyA9IGFbMTVdO1xuICAgIGIwID0gYlswXTtcbiAgICBiMSA9IGJbMV07XG4gICAgYjIgPSBiWzJdO1xuICAgIGIzID0gYlszXTtcbiAgICByWzBdID0gYTAwICogYjAgKyBhMTAgKiBiMSArIGEyMCAqIGIyICsgYTMwICogYjM7XG4gICAgclsxXSA9IGEwMSAqIGIwICsgYTExICogYjEgKyBhMjEgKiBiMiArIGEzMSAqIGIzO1xuICAgIHJbMl0gPSBhMDIgKiBiMCArIGExMiAqIGIxICsgYTIyICogYjIgKyBhMzIgKiBiMztcbiAgICByWzNdID0gYTAzICogYjAgKyBhMTMgKiBiMSArIGEyMyAqIGIyICsgYTMzICogYjM7XG4gICAgYjAgPSBiWzRdO1xuICAgIGIxID0gYls1XTtcbiAgICBiMiA9IGJbNl07XG4gICAgYjMgPSBiWzddO1xuICAgIHJbNF0gPSBhMDAgKiBiMCArIGExMCAqIGIxICsgYTIwICogYjIgKyBhMzAgKiBiMztcbiAgICByWzVdID0gYTAxICogYjAgKyBhMTEgKiBiMSArIGEyMSAqIGIyICsgYTMxICogYjM7XG4gICAgcls2XSA9IGEwMiAqIGIwICsgYTEyICogYjEgKyBhMjIgKiBiMiArIGEzMiAqIGIzO1xuICAgIHJbN10gPSBhMDMgKiBiMCArIGExMyAqIGIxICsgYTIzICogYjIgKyBhMzMgKiBiMztcbiAgICBiMCA9IGJbOF07XG4gICAgYjEgPSBiWzldO1xuICAgIGIyID0gYlsxMF07XG4gICAgYjMgPSBiWzExXTtcbiAgICByWzhdID0gYTAwICogYjAgKyBhMTAgKiBiMSArIGEyMCAqIGIyICsgYTMwICogYjM7XG4gICAgcls5XSA9IGEwMSAqIGIwICsgYTExICogYjEgKyBhMjEgKiBiMiArIGEzMSAqIGIzO1xuICAgIHJbMTBdID0gYTAyICogYjAgKyBhMTIgKiBiMSArIGEyMiAqIGIyICsgYTMyICogYjM7XG4gICAgclsxMV0gPSBhMDMgKiBiMCArIGExMyAqIGIxICsgYTIzICogYjIgKyBhMzMgKiBiMztcbiAgICBiMCA9IGJbMTJdO1xuICAgIGIxID0gYlsxM107XG4gICAgYjIgPSBiWzE0XTtcbiAgICBiMyA9IGJbMTVdO1xuICAgIHJbMTJdID0gYTAwICogYjAgKyBhMTAgKiBiMSArIGEyMCAqIGIyICsgYTMwICogYjM7XG4gICAgclsxM10gPSBhMDEgKiBiMCArIGExMSAqIGIxICsgYTIxICogYjIgKyBhMzEgKiBiMztcbiAgICByWzE0XSA9IGEwMiAqIGIwICsgYTEyICogYjEgKyBhMjIgKiBiMiArIGEzMiAqIGIzO1xuICAgIHJbMTVdID0gYTAzICogYjAgKyBhMTMgKiBiMSArIGEyMyAqIGIyICsgYTMzICogYjM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIG11bDpmdW5jdGlvbihyaHMpIHtcbiAgICByZXR1cm4gdGhpcy5tdWwyKHRoaXMsIHJocyk7XG4gIH0sIHRyYW5zZm9ybVBvaW50OmZ1bmN0aW9uKHZlYywgcmVzKSB7XG4gICAgdmFyIHgsIHksIHosIG0gPSB0aGlzLmRhdGEsIHYgPSB2ZWMuZGF0YTtcbiAgICByZXMgPSByZXMgPT09IHVuZGVmaW5lZCA/IG5ldyBwYy5WZWMzIDogcmVzO1xuICAgIHggPSB2WzBdICogbVswXSArIHZbMV0gKiBtWzRdICsgdlsyXSAqIG1bOF0gKyBtWzEyXTtcbiAgICB5ID0gdlswXSAqIG1bMV0gKyB2WzFdICogbVs1XSArIHZbMl0gKiBtWzldICsgbVsxM107XG4gICAgeiA9IHZbMF0gKiBtWzJdICsgdlsxXSAqIG1bNl0gKyB2WzJdICogbVsxMF0gKyBtWzE0XTtcbiAgICByZXR1cm4gcmVzLnNldCh4LCB5LCB6KTtcbiAgfSwgdHJhbnNmb3JtVmVjdG9yOmZ1bmN0aW9uKHZlYywgcmVzKSB7XG4gICAgdmFyIHgsIHksIHosIG0gPSB0aGlzLmRhdGEsIHYgPSB2ZWMuZGF0YTtcbiAgICByZXMgPSByZXMgPT09IHVuZGVmaW5lZCA/IG5ldyBwYy5WZWMzIDogcmVzO1xuICAgIHggPSB2WzBdICogbVswXSArIHZbMV0gKiBtWzRdICsgdlsyXSAqIG1bOF07XG4gICAgeSA9IHZbMF0gKiBtWzFdICsgdlsxXSAqIG1bNV0gKyB2WzJdICogbVs5XTtcbiAgICB6ID0gdlswXSAqIG1bMl0gKyB2WzFdICogbVs2XSArIHZbMl0gKiBtWzEwXTtcbiAgICByZXR1cm4gcmVzLnNldCh4LCB5LCB6KTtcbiAgfSwgdHJhbnNmb3JtVmVjNDpmdW5jdGlvbih2ZWMsIHJlcykge1xuICAgIHZhciB4LCB5LCB6LCB3LCBtID0gdGhpcy5kYXRhLCB2ID0gdmVjLmRhdGE7XG4gICAgcmVzID0gcmVzID09PSB1bmRlZmluZWQgPyBuZXcgcGMuVmVjNCA6IHJlcztcbiAgICB4ID0gdlswXSAqIG1bMF0gKyB2WzFdICogbVs0XSArIHZbMl0gKiBtWzhdICsgdlszXSAqIG1bMTJdO1xuICAgIHkgPSB2WzBdICogbVsxXSArIHZbMV0gKiBtWzVdICsgdlsyXSAqIG1bOV0gKyB2WzNdICogbVsxM107XG4gICAgeiA9IHZbMF0gKiBtWzJdICsgdlsxXSAqIG1bNl0gKyB2WzJdICogbVsxMF0gKyB2WzNdICogbVsxNF07XG4gICAgdyA9IHZbMF0gKiBtWzNdICsgdlsxXSAqIG1bN10gKyB2WzJdICogbVsxMV0gKyB2WzNdICogbVsxNV07XG4gICAgcmV0dXJuIHJlcy5zZXQoeCwgeSwgeiwgdyk7XG4gIH0sIHNldExvb2tBdDpmdW5jdGlvbigpIHtcbiAgICB2YXIgeCwgeSwgejtcbiAgICB4ID0gbmV3IHBjLlZlYzM7XG4gICAgeSA9IG5ldyBwYy5WZWMzO1xuICAgIHogPSBuZXcgcGMuVmVjMztcbiAgICByZXR1cm4gZnVuY3Rpb24ocG9zaXRpb24sIHRhcmdldCwgdXApIHtcbiAgICAgIHouc3ViMihwb3NpdGlvbiwgdGFyZ2V0KS5ub3JtYWxpemUoKTtcbiAgICAgIHkuY29weSh1cCkubm9ybWFsaXplKCk7XG4gICAgICB4LmNyb3NzKHksIHopLm5vcm1hbGl6ZSgpO1xuICAgICAgeS5jcm9zcyh6LCB4KTtcbiAgICAgIHZhciByID0gdGhpcy5kYXRhO1xuICAgICAgclswXSA9IHgueDtcbiAgICAgIHJbMV0gPSB4Lnk7XG4gICAgICByWzJdID0geC56O1xuICAgICAgclszXSA9IDA7XG4gICAgICByWzRdID0geS54O1xuICAgICAgcls1XSA9IHkueTtcbiAgICAgIHJbNl0gPSB5Lno7XG4gICAgICByWzddID0gMDtcbiAgICAgIHJbOF0gPSB6Lng7XG4gICAgICByWzldID0gei55O1xuICAgICAgclsxMF0gPSB6Lno7XG4gICAgICByWzExXSA9IDA7XG4gICAgICByWzEyXSA9IHBvc2l0aW9uLng7XG4gICAgICByWzEzXSA9IHBvc2l0aW9uLnk7XG4gICAgICByWzE0XSA9IHBvc2l0aW9uLno7XG4gICAgICByWzE1XSA9IDE7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuICB9KCksIHNldEZydXN0dW06ZnVuY3Rpb24obGVmdCwgcmlnaHQsIGJvdHRvbSwgdG9wLCB6bmVhciwgemZhcikge1xuICAgIHZhciB0ZW1wMSwgdGVtcDIsIHRlbXAzLCB0ZW1wNCwgcjtcbiAgICB0ZW1wMSA9IDIgKiB6bmVhcjtcbiAgICB0ZW1wMiA9IHJpZ2h0IC0gbGVmdDtcbiAgICB0ZW1wMyA9IHRvcCAtIGJvdHRvbTtcbiAgICB0ZW1wNCA9IHpmYXIgLSB6bmVhcjtcbiAgICByID0gdGhpcy5kYXRhO1xuICAgIHJbMF0gPSB0ZW1wMSAvIHRlbXAyO1xuICAgIHJbMV0gPSAwO1xuICAgIHJbMl0gPSAwO1xuICAgIHJbM10gPSAwO1xuICAgIHJbNF0gPSAwO1xuICAgIHJbNV0gPSB0ZW1wMSAvIHRlbXAzO1xuICAgIHJbNl0gPSAwO1xuICAgIHJbN10gPSAwO1xuICAgIHJbOF0gPSAocmlnaHQgKyBsZWZ0KSAvIHRlbXAyO1xuICAgIHJbOV0gPSAodG9wICsgYm90dG9tKSAvIHRlbXAzO1xuICAgIHJbMTBdID0gKC16ZmFyIC0gem5lYXIpIC8gdGVtcDQ7XG4gICAgclsxMV0gPSAtMTtcbiAgICByWzEyXSA9IDA7XG4gICAgclsxM10gPSAwO1xuICAgIHJbMTRdID0gLXRlbXAxICogemZhciAvIHRlbXA0O1xuICAgIHJbMTVdID0gMDtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2V0UGVyc3BlY3RpdmU6ZnVuY3Rpb24oZm92eSwgYXNwZWN0LCB6bmVhciwgemZhciwgZm92SXNIb3Jpem9udGFsKSB7XG4gICAgdmFyIHhtYXgsIHltYXg7XG4gICAgaWYgKCFmb3ZJc0hvcml6b250YWwpIHtcbiAgICAgIHltYXggPSB6bmVhciAqIE1hdGgudGFuKGZvdnkgKiBNYXRoLlBJIC8gMzYwKTtcbiAgICAgIHhtYXggPSB5bWF4ICogYXNwZWN0O1xuICAgIH0gZWxzZSB7XG4gICAgICB4bWF4ID0gem5lYXIgKiBNYXRoLnRhbihmb3Z5ICogTWF0aC5QSSAvIDM2MCk7XG4gICAgICB5bWF4ID0geG1heCAvIGFzcGVjdDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc2V0RnJ1c3R1bSgteG1heCwgeG1heCwgLXltYXgsIHltYXgsIHpuZWFyLCB6ZmFyKTtcbiAgfSwgc2V0T3J0aG86ZnVuY3Rpb24obGVmdCwgcmlnaHQsIGJvdHRvbSwgdG9wLCBuZWFyLCBmYXIpIHtcbiAgICB2YXIgciA9IHRoaXMuZGF0YTtcbiAgICByWzBdID0gMiAvIChyaWdodCAtIGxlZnQpO1xuICAgIHJbMV0gPSAwO1xuICAgIHJbMl0gPSAwO1xuICAgIHJbM10gPSAwO1xuICAgIHJbNF0gPSAwO1xuICAgIHJbNV0gPSAyIC8gKHRvcCAtIGJvdHRvbSk7XG4gICAgcls2XSA9IDA7XG4gICAgcls3XSA9IDA7XG4gICAgcls4XSA9IDA7XG4gICAgcls5XSA9IDA7XG4gICAgclsxMF0gPSAtMiAvIChmYXIgLSBuZWFyKTtcbiAgICByWzExXSA9IDA7XG4gICAgclsxMl0gPSAtKHJpZ2h0ICsgbGVmdCkgLyAocmlnaHQgLSBsZWZ0KTtcbiAgICByWzEzXSA9IC0odG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pO1xuICAgIHJbMTRdID0gLShmYXIgKyBuZWFyKSAvIChmYXIgLSBuZWFyKTtcbiAgICByWzE1XSA9IDE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNldEZyb21BeGlzQW5nbGU6ZnVuY3Rpb24oYXhpcywgYW5nbGUpIHtcbiAgICB2YXIgeCwgeSwgeiwgYywgcywgdCwgdHgsIHR5LCBtO1xuICAgIGFuZ2xlICo9IHBjLm1hdGguREVHX1RPX1JBRDtcbiAgICB4ID0gYXhpcy54O1xuICAgIHkgPSBheGlzLnk7XG4gICAgeiA9IGF4aXMuejtcbiAgICBjID0gTWF0aC5jb3MoYW5nbGUpO1xuICAgIHMgPSBNYXRoLnNpbihhbmdsZSk7XG4gICAgdCA9IDEgLSBjO1xuICAgIHR4ID0gdCAqIHg7XG4gICAgdHkgPSB0ICogeTtcbiAgICBtID0gdGhpcy5kYXRhO1xuICAgIG1bMF0gPSB0eCAqIHggKyBjO1xuICAgIG1bMV0gPSB0eCAqIHkgKyBzICogejtcbiAgICBtWzJdID0gdHggKiB6IC0gcyAqIHk7XG4gICAgbVszXSA9IDA7XG4gICAgbVs0XSA9IHR4ICogeSAtIHMgKiB6O1xuICAgIG1bNV0gPSB0eSAqIHkgKyBjO1xuICAgIG1bNl0gPSB0eSAqIHogKyBzICogeDtcbiAgICBtWzddID0gMDtcbiAgICBtWzhdID0gdHggKiB6ICsgcyAqIHk7XG4gICAgbVs5XSA9IHR5ICogeiAtIHggKiBzO1xuICAgIG1bMTBdID0gdCAqIHogKiB6ICsgYztcbiAgICBtWzExXSA9IDA7XG4gICAgbVsxMl0gPSAwO1xuICAgIG1bMTNdID0gMDtcbiAgICBtWzE0XSA9IDA7XG4gICAgbVsxNV0gPSAxO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXRUcmFuc2xhdGU6ZnVuY3Rpb24odHgsIHR5LCB0eikge1xuICAgIHZhciBtID0gdGhpcy5kYXRhO1xuICAgIG1bMF0gPSAxO1xuICAgIG1bMV0gPSAwO1xuICAgIG1bMl0gPSAwO1xuICAgIG1bM10gPSAwO1xuICAgIG1bNF0gPSAwO1xuICAgIG1bNV0gPSAxO1xuICAgIG1bNl0gPSAwO1xuICAgIG1bN10gPSAwO1xuICAgIG1bOF0gPSAwO1xuICAgIG1bOV0gPSAwO1xuICAgIG1bMTBdID0gMTtcbiAgICBtWzExXSA9IDA7XG4gICAgbVsxMl0gPSB0eDtcbiAgICBtWzEzXSA9IHR5O1xuICAgIG1bMTRdID0gdHo7XG4gICAgbVsxNV0gPSAxO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXRTY2FsZTpmdW5jdGlvbihzeCwgc3ksIHN6KSB7XG4gICAgdmFyIG0gPSB0aGlzLmRhdGE7XG4gICAgbVswXSA9IHN4O1xuICAgIG1bMV0gPSAwO1xuICAgIG1bMl0gPSAwO1xuICAgIG1bM10gPSAwO1xuICAgIG1bNF0gPSAwO1xuICAgIG1bNV0gPSBzeTtcbiAgICBtWzZdID0gMDtcbiAgICBtWzddID0gMDtcbiAgICBtWzhdID0gMDtcbiAgICBtWzldID0gMDtcbiAgICBtWzEwXSA9IHN6O1xuICAgIG1bMTFdID0gMDtcbiAgICBtWzEyXSA9IDA7XG4gICAgbVsxM10gPSAwO1xuICAgIG1bMTRdID0gMDtcbiAgICBtWzE1XSA9IDE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGludmVydDpmdW5jdGlvbigpIHtcbiAgICB2YXIgYTAwLCBhMDEsIGEwMiwgYTAzLCBhMTAsIGExMSwgYTEyLCBhMTMsIGEyMCwgYTIxLCBhMjIsIGEyMywgYTMwLCBhMzEsIGEzMiwgYTMzLCBiMDAsIGIwMSwgYjAyLCBiMDMsIGIwNCwgYjA1LCBiMDYsIGIwNywgYjA4LCBiMDksIGIxMCwgYjExLCBkZXQsIGludkRldCwgbTtcbiAgICBtID0gdGhpcy5kYXRhO1xuICAgIGEwMCA9IG1bMF07XG4gICAgYTAxID0gbVsxXTtcbiAgICBhMDIgPSBtWzJdO1xuICAgIGEwMyA9IG1bM107XG4gICAgYTEwID0gbVs0XTtcbiAgICBhMTEgPSBtWzVdO1xuICAgIGExMiA9IG1bNl07XG4gICAgYTEzID0gbVs3XTtcbiAgICBhMjAgPSBtWzhdO1xuICAgIGEyMSA9IG1bOV07XG4gICAgYTIyID0gbVsxMF07XG4gICAgYTIzID0gbVsxMV07XG4gICAgYTMwID0gbVsxMl07XG4gICAgYTMxID0gbVsxM107XG4gICAgYTMyID0gbVsxNF07XG4gICAgYTMzID0gbVsxNV07XG4gICAgYjAwID0gYTAwICogYTExIC0gYTAxICogYTEwO1xuICAgIGIwMSA9IGEwMCAqIGExMiAtIGEwMiAqIGExMDtcbiAgICBiMDIgPSBhMDAgKiBhMTMgLSBhMDMgKiBhMTA7XG4gICAgYjAzID0gYTAxICogYTEyIC0gYTAyICogYTExO1xuICAgIGIwNCA9IGEwMSAqIGExMyAtIGEwMyAqIGExMTtcbiAgICBiMDUgPSBhMDIgKiBhMTMgLSBhMDMgKiBhMTI7XG4gICAgYjA2ID0gYTIwICogYTMxIC0gYTIxICogYTMwO1xuICAgIGIwNyA9IGEyMCAqIGEzMiAtIGEyMiAqIGEzMDtcbiAgICBiMDggPSBhMjAgKiBhMzMgLSBhMjMgKiBhMzA7XG4gICAgYjA5ID0gYTIxICogYTMyIC0gYTIyICogYTMxO1xuICAgIGIxMCA9IGEyMSAqIGEzMyAtIGEyMyAqIGEzMTtcbiAgICBiMTEgPSBhMjIgKiBhMzMgLSBhMjMgKiBhMzI7XG4gICAgZGV0ID0gYjAwICogYjExIC0gYjAxICogYjEwICsgYjAyICogYjA5ICsgYjAzICogYjA4IC0gYjA0ICogYjA3ICsgYjA1ICogYjA2O1xuICAgIGlmIChkZXQgPT09IDApIHtcbiAgICAgIHRoaXMuc2V0SWRlbnRpdHkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW52RGV0ID0gMSAvIGRldDtcbiAgICAgIG1bMF0gPSAoYTExICogYjExIC0gYTEyICogYjEwICsgYTEzICogYjA5KSAqIGludkRldDtcbiAgICAgIG1bMV0gPSAoLWEwMSAqIGIxMSArIGEwMiAqIGIxMCAtIGEwMyAqIGIwOSkgKiBpbnZEZXQ7XG4gICAgICBtWzJdID0gKGEzMSAqIGIwNSAtIGEzMiAqIGIwNCArIGEzMyAqIGIwMykgKiBpbnZEZXQ7XG4gICAgICBtWzNdID0gKC1hMjEgKiBiMDUgKyBhMjIgKiBiMDQgLSBhMjMgKiBiMDMpICogaW52RGV0O1xuICAgICAgbVs0XSA9ICgtYTEwICogYjExICsgYTEyICogYjA4IC0gYTEzICogYjA3KSAqIGludkRldDtcbiAgICAgIG1bNV0gPSAoYTAwICogYjExIC0gYTAyICogYjA4ICsgYTAzICogYjA3KSAqIGludkRldDtcbiAgICAgIG1bNl0gPSAoLWEzMCAqIGIwNSArIGEzMiAqIGIwMiAtIGEzMyAqIGIwMSkgKiBpbnZEZXQ7XG4gICAgICBtWzddID0gKGEyMCAqIGIwNSAtIGEyMiAqIGIwMiArIGEyMyAqIGIwMSkgKiBpbnZEZXQ7XG4gICAgICBtWzhdID0gKGExMCAqIGIxMCAtIGExMSAqIGIwOCArIGExMyAqIGIwNikgKiBpbnZEZXQ7XG4gICAgICBtWzldID0gKC1hMDAgKiBiMTAgKyBhMDEgKiBiMDggLSBhMDMgKiBiMDYpICogaW52RGV0O1xuICAgICAgbVsxMF0gPSAoYTMwICogYjA0IC0gYTMxICogYjAyICsgYTMzICogYjAwKSAqIGludkRldDtcbiAgICAgIG1bMTFdID0gKC1hMjAgKiBiMDQgKyBhMjEgKiBiMDIgLSBhMjMgKiBiMDApICogaW52RGV0O1xuICAgICAgbVsxMl0gPSAoLWExMCAqIGIwOSArIGExMSAqIGIwNyAtIGExMiAqIGIwNikgKiBpbnZEZXQ7XG4gICAgICBtWzEzXSA9IChhMDAgKiBiMDkgLSBhMDEgKiBiMDcgKyBhMDIgKiBiMDYpICogaW52RGV0O1xuICAgICAgbVsxNF0gPSAoLWEzMCAqIGIwMyArIGEzMSAqIGIwMSAtIGEzMiAqIGIwMCkgKiBpbnZEZXQ7XG4gICAgICBtWzE1XSA9IChhMjAgKiBiMDMgLSBhMjEgKiBiMDEgKyBhMjIgKiBiMDApICogaW52RGV0O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2V0OmZ1bmN0aW9uKHNyYykge1xuICAgIHZhciBkc3QgPSB0aGlzLmRhdGE7XG4gICAgZHN0WzBdID0gc3JjWzBdO1xuICAgIGRzdFsxXSA9IHNyY1sxXTtcbiAgICBkc3RbMl0gPSBzcmNbMl07XG4gICAgZHN0WzNdID0gc3JjWzNdO1xuICAgIGRzdFs0XSA9IHNyY1s0XTtcbiAgICBkc3RbNV0gPSBzcmNbNV07XG4gICAgZHN0WzZdID0gc3JjWzZdO1xuICAgIGRzdFs3XSA9IHNyY1s3XTtcbiAgICBkc3RbOF0gPSBzcmNbOF07XG4gICAgZHN0WzldID0gc3JjWzldO1xuICAgIGRzdFsxMF0gPSBzcmNbMTBdO1xuICAgIGRzdFsxMV0gPSBzcmNbMTFdO1xuICAgIGRzdFsxMl0gPSBzcmNbMTJdO1xuICAgIGRzdFsxM10gPSBzcmNbMTNdO1xuICAgIGRzdFsxNF0gPSBzcmNbMTRdO1xuICAgIGRzdFsxNV0gPSBzcmNbMTVdO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXRJZGVudGl0eTpmdW5jdGlvbigpIHtcbiAgICB2YXIgbSA9IHRoaXMuZGF0YTtcbiAgICBtWzBdID0gMTtcbiAgICBtWzFdID0gMDtcbiAgICBtWzJdID0gMDtcbiAgICBtWzNdID0gMDtcbiAgICBtWzRdID0gMDtcbiAgICBtWzVdID0gMTtcbiAgICBtWzZdID0gMDtcbiAgICBtWzddID0gMDtcbiAgICBtWzhdID0gMDtcbiAgICBtWzldID0gMDtcbiAgICBtWzEwXSA9IDE7XG4gICAgbVsxMV0gPSAwO1xuICAgIG1bMTJdID0gMDtcbiAgICBtWzEzXSA9IDA7XG4gICAgbVsxNF0gPSAwO1xuICAgIG1bMTVdID0gMTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2V0VFJTOmZ1bmN0aW9uKHQsIHIsIHMpIHtcbiAgICB2YXIgdHgsIHR5LCB0eiwgcXgsIHF5LCBxeiwgcXcsIHN4LCBzeSwgc3osIHgyLCB5MiwgejIsIHh4LCB4eSwgeHosIHl5LCB5eiwgenosIHd4LCB3eSwgd3osIG07XG4gICAgdHggPSB0Lng7XG4gICAgdHkgPSB0Lnk7XG4gICAgdHogPSB0Lno7XG4gICAgcXggPSByLng7XG4gICAgcXkgPSByLnk7XG4gICAgcXogPSByLno7XG4gICAgcXcgPSByLnc7XG4gICAgc3ggPSBzLng7XG4gICAgc3kgPSBzLnk7XG4gICAgc3ogPSBzLno7XG4gICAgeDIgPSBxeCArIHF4O1xuICAgIHkyID0gcXkgKyBxeTtcbiAgICB6MiA9IHF6ICsgcXo7XG4gICAgeHggPSBxeCAqIHgyO1xuICAgIHh5ID0gcXggKiB5MjtcbiAgICB4eiA9IHF4ICogejI7XG4gICAgeXkgPSBxeSAqIHkyO1xuICAgIHl6ID0gcXkgKiB6MjtcbiAgICB6eiA9IHF6ICogejI7XG4gICAgd3ggPSBxdyAqIHgyO1xuICAgIHd5ID0gcXcgKiB5MjtcbiAgICB3eiA9IHF3ICogejI7XG4gICAgbSA9IHRoaXMuZGF0YTtcbiAgICBtWzBdID0gKDEgLSAoeXkgKyB6eikpICogc3g7XG4gICAgbVsxXSA9ICh4eSArIHd6KSAqIHN4O1xuICAgIG1bMl0gPSAoeHogLSB3eSkgKiBzeDtcbiAgICBtWzNdID0gMDtcbiAgICBtWzRdID0gKHh5IC0gd3opICogc3k7XG4gICAgbVs1XSA9ICgxIC0gKHh4ICsgenopKSAqIHN5O1xuICAgIG1bNl0gPSAoeXogKyB3eCkgKiBzeTtcbiAgICBtWzddID0gMDtcbiAgICBtWzhdID0gKHh6ICsgd3kpICogc3o7XG4gICAgbVs5XSA9ICh5eiAtIHd4KSAqIHN6O1xuICAgIG1bMTBdID0gKDEgLSAoeHggKyB5eSkpICogc3o7XG4gICAgbVsxMV0gPSAwO1xuICAgIG1bMTJdID0gdHg7XG4gICAgbVsxM10gPSB0eTtcbiAgICBtWzE0XSA9IHR6O1xuICAgIG1bMTVdID0gMTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgdHJhbnNwb3NlOmZ1bmN0aW9uKCkge1xuICAgIHZhciB0bXAsIG0gPSB0aGlzLmRhdGE7XG4gICAgdG1wID0gbVsxXTtcbiAgICBtWzFdID0gbVs0XTtcbiAgICBtWzRdID0gdG1wO1xuICAgIHRtcCA9IG1bMl07XG4gICAgbVsyXSA9IG1bOF07XG4gICAgbVs4XSA9IHRtcDtcbiAgICB0bXAgPSBtWzNdO1xuICAgIG1bM10gPSBtWzEyXTtcbiAgICBtWzEyXSA9IHRtcDtcbiAgICB0bXAgPSBtWzZdO1xuICAgIG1bNl0gPSBtWzldO1xuICAgIG1bOV0gPSB0bXA7XG4gICAgdG1wID0gbVs3XTtcbiAgICBtWzddID0gbVsxM107XG4gICAgbVsxM10gPSB0bXA7XG4gICAgdG1wID0gbVsxMV07XG4gICAgbVsxMV0gPSBtWzE0XTtcbiAgICBtWzE0XSA9IHRtcDtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgaW52ZXJ0VG8zeDM6ZnVuY3Rpb24ocmVzKSB7XG4gICAgdmFyIGExMSwgYTIxLCBhMzEsIGExMiwgYTIyLCBhMzIsIGExMywgYTIzLCBhMzMsIG0sIHIsIGRldCwgaWRldDtcbiAgICBtID0gdGhpcy5kYXRhO1xuICAgIHIgPSByZXMuZGF0YTtcbiAgICB2YXIgbTAgPSBtWzBdO1xuICAgIHZhciBtMSA9IG1bMV07XG4gICAgdmFyIG0yID0gbVsyXTtcbiAgICB2YXIgbTMgPSBtWzNdO1xuICAgIHZhciBtNCA9IG1bNF07XG4gICAgdmFyIG01ID0gbVs1XTtcbiAgICB2YXIgbTYgPSBtWzZdO1xuICAgIHZhciBtNyA9IG1bN107XG4gICAgdmFyIG04ID0gbVs4XTtcbiAgICB2YXIgbTkgPSBtWzldO1xuICAgIHZhciBtMTAgPSBtWzEwXTtcbiAgICBhMTEgPSBtMTAgKiBtNSAtIG02ICogbTk7XG4gICAgYTIxID0gLW0xMCAqIG0xICsgbTIgKiBtOTtcbiAgICBhMzEgPSBtNiAqIG0xIC0gbTIgKiBtNTtcbiAgICBhMTIgPSAtbTEwICogbTQgKyBtNiAqIG04O1xuICAgIGEyMiA9IG0xMCAqIG0wIC0gbTIgKiBtODtcbiAgICBhMzIgPSAtbTYgKiBtMCArIG0yICogbTQ7XG4gICAgYTEzID0gbTkgKiBtNCAtIG01ICogbTg7XG4gICAgYTIzID0gLW05ICogbTAgKyBtMSAqIG04O1xuICAgIGEzMyA9IG01ICogbTAgLSBtMSAqIG00O1xuICAgIGRldCA9IG0wICogYTExICsgbTEgKiBhMTIgKyBtMiAqIGExMztcbiAgICBpZiAoZGV0ID09PSAwKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJwYy5NYXQ0I2ludmVydFRvM3gzOiBNYXRyaXggbm90IGludmVydGlibGVcIik7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgaWRldCA9IDEgLyBkZXQ7XG4gICAgclswXSA9IGlkZXQgKiBhMTE7XG4gICAgclsxXSA9IGlkZXQgKiBhMjE7XG4gICAgclsyXSA9IGlkZXQgKiBhMzE7XG4gICAgclszXSA9IGlkZXQgKiBhMTI7XG4gICAgcls0XSA9IGlkZXQgKiBhMjI7XG4gICAgcls1XSA9IGlkZXQgKiBhMzI7XG4gICAgcls2XSA9IGlkZXQgKiBhMTM7XG4gICAgcls3XSA9IGlkZXQgKiBhMjM7XG4gICAgcls4XSA9IGlkZXQgKiBhMzM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGdldFRyYW5zbGF0aW9uOmZ1bmN0aW9uKHQpIHtcbiAgICB0ID0gdCA9PT0gdW5kZWZpbmVkID8gbmV3IHBjLlZlYzMgOiB0O1xuICAgIHJldHVybiB0LnNldCh0aGlzLmRhdGFbMTJdLCB0aGlzLmRhdGFbMTNdLCB0aGlzLmRhdGFbMTRdKTtcbiAgfSwgZ2V0WDpmdW5jdGlvbih4KSB7XG4gICAgeCA9IHggPT09IHVuZGVmaW5lZCA/IG5ldyBwYy5WZWMzIDogeDtcbiAgICByZXR1cm4geC5zZXQodGhpcy5kYXRhWzBdLCB0aGlzLmRhdGFbMV0sIHRoaXMuZGF0YVsyXSk7XG4gIH0sIGdldFk6ZnVuY3Rpb24oeSkge1xuICAgIHkgPSB5ID09PSB1bmRlZmluZWQgPyBuZXcgcGMuVmVjMyA6IHk7XG4gICAgcmV0dXJuIHkuc2V0KHRoaXMuZGF0YVs0XSwgdGhpcy5kYXRhWzVdLCB0aGlzLmRhdGFbNl0pO1xuICB9LCBnZXRaOmZ1bmN0aW9uKHopIHtcbiAgICB6ID0geiA9PT0gdW5kZWZpbmVkID8gbmV3IHBjLlZlYzMgOiB6O1xuICAgIHJldHVybiB6LnNldCh0aGlzLmRhdGFbOF0sIHRoaXMuZGF0YVs5XSwgdGhpcy5kYXRhWzEwXSk7XG4gIH0sIGdldFNjYWxlOmZ1bmN0aW9uKCkge1xuICAgIHZhciB4LCB5LCB6O1xuICAgIHggPSBuZXcgcGMuVmVjMztcbiAgICB5ID0gbmV3IHBjLlZlYzM7XG4gICAgeiA9IG5ldyBwYy5WZWMzO1xuICAgIHJldHVybiBmdW5jdGlvbihzY2FsZSkge1xuICAgICAgc2NhbGUgPSBzY2FsZSA9PT0gdW5kZWZpbmVkID8gbmV3IHBjLlZlYzMgOiBzY2FsZTtcbiAgICAgIHRoaXMuZ2V0WCh4KTtcbiAgICAgIHRoaXMuZ2V0WSh5KTtcbiAgICAgIHRoaXMuZ2V0Wih6KTtcbiAgICAgIHNjYWxlLnNldCh4Lmxlbmd0aCgpLCB5Lmxlbmd0aCgpLCB6Lmxlbmd0aCgpKTtcbiAgICAgIHJldHVybiBzY2FsZTtcbiAgICB9O1xuICB9KCksIHNldEZyb21FdWxlckFuZ2xlczpmdW5jdGlvbihleCwgZXksIGV6KSB7XG4gICAgdmFyIHMxLCBjMSwgczIsIGMyLCBzMywgYzMsIG07XG4gICAgZXggKj0gcGMubWF0aC5ERUdfVE9fUkFEO1xuICAgIGV5ICo9IHBjLm1hdGguREVHX1RPX1JBRDtcbiAgICBleiAqPSBwYy5tYXRoLkRFR19UT19SQUQ7XG4gICAgczEgPSBNYXRoLnNpbigtZXgpO1xuICAgIGMxID0gTWF0aC5jb3MoLWV4KTtcbiAgICBzMiA9IE1hdGguc2luKC1leSk7XG4gICAgYzIgPSBNYXRoLmNvcygtZXkpO1xuICAgIHMzID0gTWF0aC5zaW4oLWV6KTtcbiAgICBjMyA9IE1hdGguY29zKC1leik7XG4gICAgbSA9IHRoaXMuZGF0YTtcbiAgICBtWzBdID0gYzIgKiBjMztcbiAgICBtWzFdID0gLWMyICogczM7XG4gICAgbVsyXSA9IHMyO1xuICAgIG1bM10gPSAwO1xuICAgIG1bNF0gPSBjMSAqIHMzICsgYzMgKiBzMSAqIHMyO1xuICAgIG1bNV0gPSBjMSAqIGMzIC0gczEgKiBzMiAqIHMzO1xuICAgIG1bNl0gPSAtYzIgKiBzMTtcbiAgICBtWzddID0gMDtcbiAgICBtWzhdID0gczEgKiBzMyAtIGMxICogYzMgKiBzMjtcbiAgICBtWzldID0gYzMgKiBzMSArIGMxICogczIgKiBzMztcbiAgICBtWzEwXSA9IGMxICogYzI7XG4gICAgbVsxMV0gPSAwO1xuICAgIG1bMTJdID0gMDtcbiAgICBtWzEzXSA9IDA7XG4gICAgbVsxNF0gPSAwO1xuICAgIG1bMTVdID0gMTtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgZ2V0RXVsZXJBbmdsZXM6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHNjYWxlID0gbmV3IHBjLlZlYzM7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKGV1bGVycykge1xuICAgICAgdmFyIHgsIHksIHosIHN4LCBzeSwgc3osIG0sIGhhbGZQaTtcbiAgICAgIGV1bGVycyA9IGV1bGVycyA9PT0gdW5kZWZpbmVkID8gbmV3IHBjLlZlYzMgOiBldWxlcnM7XG4gICAgICB0aGlzLmdldFNjYWxlKHNjYWxlKTtcbiAgICAgIHN4ID0gc2NhbGUueDtcbiAgICAgIHN5ID0gc2NhbGUueTtcbiAgICAgIHN6ID0gc2NhbGUuejtcbiAgICAgIG0gPSB0aGlzLmRhdGE7XG4gICAgICB5ID0gTWF0aC5hc2luKC1tWzJdIC8gc3gpO1xuICAgICAgaGFsZlBpID0gTWF0aC5QSSAqIDAuNTtcbiAgICAgIGlmICh5IDwgaGFsZlBpKSB7XG4gICAgICAgIGlmICh5ID4gLWhhbGZQaSkge1xuICAgICAgICAgIHggPSBNYXRoLmF0YW4yKG1bNl0gLyBzeSwgbVsxMF0gLyBzeik7XG4gICAgICAgICAgeiA9IE1hdGguYXRhbjIobVsxXSAvIHN4LCBtWzBdIC8gc3gpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHogPSAwO1xuICAgICAgICAgIHggPSAtTWF0aC5hdGFuMihtWzRdIC8gc3ksIG1bNV0gLyBzeSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHogPSAwO1xuICAgICAgICB4ID0gTWF0aC5hdGFuMihtWzRdIC8gc3ksIG1bNV0gLyBzeSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXVsZXJzLnNldCh4LCB5LCB6KS5zY2FsZShwYy5tYXRoLlJBRF9UT19ERUcpO1xuICAgIH07XG4gIH0oKSwgdG9TdHJpbmc6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGksIHQ7XG4gICAgdCA9IFwiW1wiO1xuICAgIGZvciAoaSA9IDA7aSA8IDE2O2kgKz0gMSkge1xuICAgICAgdCArPSB0aGlzLmRhdGFbaV07XG4gICAgICB0ICs9IGkgIT09IDE1ID8gXCIsIFwiIDogXCJcIjtcbiAgICB9XG4gICAgdCArPSBcIl1cIjtcbiAgICByZXR1cm4gdDtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNYXQ0LCBcIklERU5USVRZXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGlkZW50aXR5ID0gbmV3IE1hdDQ7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGlkZW50aXR5O1xuICAgIH07XG4gIH0oKX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWF0NCwgXCJaRVJPXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHplcm8gPSBuZXcgTWF0NCgwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKTtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gemVybztcbiAgICB9O1xuICB9KCl9KTtcbiAgcmV0dXJuIHtNYXQ0Ok1hdDR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBRdWF0ID0gZnVuY3Rpb24oeCwgeSwgeiwgdykge1xuICAgIGlmICh4ICYmIHgubGVuZ3RoID09PSA0KSB7XG4gICAgICB0aGlzLnggPSB4WzBdO1xuICAgICAgdGhpcy55ID0geFsxXTtcbiAgICAgIHRoaXMueiA9IHhbMl07XG4gICAgICB0aGlzLncgPSB4WzNdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnggPSB4ID09PSB1bmRlZmluZWQgPyAwIDogeDtcbiAgICAgIHRoaXMueSA9IHkgPT09IHVuZGVmaW5lZCA/IDAgOiB5O1xuICAgICAgdGhpcy56ID0geiA9PT0gdW5kZWZpbmVkID8gMCA6IHo7XG4gICAgICB0aGlzLncgPSB3ID09PSB1bmRlZmluZWQgPyAxIDogdztcbiAgICB9XG4gIH07XG4gIFF1YXQucHJvdG90eXBlID0ge2Nsb25lOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBuZXcgcGMuUXVhdCh0aGlzLngsIHRoaXMueSwgdGhpcy56LCB0aGlzLncpO1xuICB9LCBjb25qdWdhdGU6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy54ICo9IC0xO1xuICAgIHRoaXMueSAqPSAtMTtcbiAgICB0aGlzLnogKj0gLTE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGNvcHk6ZnVuY3Rpb24ocmhzKSB7XG4gICAgdGhpcy54ID0gcmhzLng7XG4gICAgdGhpcy55ID0gcmhzLnk7XG4gICAgdGhpcy56ID0gcmhzLno7XG4gICAgdGhpcy53ID0gcmhzLnc7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIGVxdWFsczpmdW5jdGlvbih0aGF0KSB7XG4gICAgcmV0dXJuIHRoaXMueCA9PT0gdGhhdC54ICYmIHRoaXMueSA9PT0gdGhhdC55ICYmIHRoaXMueiA9PT0gdGhhdC56ICYmIHRoaXMudyA9PT0gdGhhdC53O1xuICB9LCBnZXRFdWxlckFuZ2xlczpmdW5jdGlvbihldWxlcnMpIHtcbiAgICB2YXIgeCwgeSwgeiwgcXgsIHF5LCBxeiwgcXcsIGEyO1xuICAgIGV1bGVycyA9IGV1bGVycyA9PT0gdW5kZWZpbmVkID8gbmV3IHBjLlZlYzMgOiBldWxlcnM7XG4gICAgcXggPSB0aGlzLng7XG4gICAgcXkgPSB0aGlzLnk7XG4gICAgcXogPSB0aGlzLno7XG4gICAgcXcgPSB0aGlzLnc7XG4gICAgYTIgPSAyICogKHF3ICogcXkgLSBxeCAqIHF6KTtcbiAgICBpZiAoYTIgPD0gLTAuOTk5OTkpIHtcbiAgICAgIHggPSAyICogTWF0aC5hdGFuMihxeCwgcXcpO1xuICAgICAgeSA9IC1NYXRoLlBJIC8gMjtcbiAgICAgIHogPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoYTIgPj0gMC45OTk5OSkge1xuICAgICAgICB4ID0gMiAqIE1hdGguYXRhbjIocXgsIHF3KTtcbiAgICAgICAgeSA9IE1hdGguUEkgLyAyO1xuICAgICAgICB6ID0gMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHggPSBNYXRoLmF0YW4yKDIgKiAocXcgKiBxeCArIHF5ICogcXopLCAxIC0gMiAqIChxeCAqIHF4ICsgcXkgKiBxeSkpO1xuICAgICAgICB5ID0gTWF0aC5hc2luKGEyKTtcbiAgICAgICAgeiA9IE1hdGguYXRhbjIoMiAqIChxdyAqIHF6ICsgcXggKiBxeSksIDEgLSAyICogKHF5ICogcXkgKyBxeiAqIHF6KSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBldWxlcnMuc2V0KHgsIHksIHopLnNjYWxlKHBjLm1hdGguUkFEX1RPX0RFRyk7XG4gIH0sIGludmVydDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5jb25qdWdhdGUoKS5ub3JtYWxpemUoKTtcbiAgfSwgbGVuZ3RoOmZ1bmN0aW9uKCkge1xuICAgIHZhciB4LCB5LCB6LCB3O1xuICAgIHggPSB0aGlzLng7XG4gICAgeSA9IHRoaXMueTtcbiAgICB6ID0gdGhpcy56O1xuICAgIHcgPSB0aGlzLnc7XG4gICAgcmV0dXJuIE1hdGguc3FydCh4ICogeCArIHkgKiB5ICsgeiAqIHogKyB3ICogdyk7XG4gIH0sIGxlbmd0aFNxOmZ1bmN0aW9uKCkge1xuICAgIHZhciB4LCB5LCB6LCB3O1xuICAgIHJldHVybiB4ICogeCArIHkgKiB5ICsgeiAqIHogKyB3ICogdztcbiAgfSwgbXVsOmZ1bmN0aW9uKHJocykge1xuICAgIHZhciBxMXgsIHExeSwgcTF6LCBxMXcsIHEyeCwgcTJ5LCBxMnosIHEydztcbiAgICBxMXggPSB0aGlzLng7XG4gICAgcTF5ID0gdGhpcy55O1xuICAgIHExeiA9IHRoaXMuejtcbiAgICBxMXcgPSB0aGlzLnc7XG4gICAgcTJ4ID0gcmhzLng7XG4gICAgcTJ5ID0gcmhzLnk7XG4gICAgcTJ6ID0gcmhzLno7XG4gICAgcTJ3ID0gcmhzLnc7XG4gICAgdGhpcy54ID0gcTF3ICogcTJ4ICsgcTF4ICogcTJ3ICsgcTF5ICogcTJ6IC0gcTF6ICogcTJ5O1xuICAgIHRoaXMueSA9IHExdyAqIHEyeSArIHExeSAqIHEydyArIHExeiAqIHEyeCAtIHExeCAqIHEyejtcbiAgICB0aGlzLnogPSBxMXcgKiBxMnogKyBxMXogKiBxMncgKyBxMXggKiBxMnkgLSBxMXkgKiBxMng7XG4gICAgdGhpcy53ID0gcTF3ICogcTJ3IC0gcTF4ICogcTJ4IC0gcTF5ICogcTJ5IC0gcTF6ICogcTJ6O1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBtdWwyOmZ1bmN0aW9uKGxocywgcmhzKSB7XG4gICAgdmFyIHExeCwgcTF5LCBxMXosIHExdywgcTJ4LCBxMnksIHEyeiwgcTJ3O1xuICAgIHExeCA9IGxocy54O1xuICAgIHExeSA9IGxocy55O1xuICAgIHExeiA9IGxocy56O1xuICAgIHExdyA9IGxocy53O1xuICAgIHEyeCA9IHJocy54O1xuICAgIHEyeSA9IHJocy55O1xuICAgIHEyeiA9IHJocy56O1xuICAgIHEydyA9IHJocy53O1xuICAgIHRoaXMueCA9IHExdyAqIHEyeCArIHExeCAqIHEydyArIHExeSAqIHEyeiAtIHExeiAqIHEyeTtcbiAgICB0aGlzLnkgPSBxMXcgKiBxMnkgKyBxMXkgKiBxMncgKyBxMXogKiBxMnggLSBxMXggKiBxMno7XG4gICAgdGhpcy56ID0gcTF3ICogcTJ6ICsgcTF6ICogcTJ3ICsgcTF4ICogcTJ5IC0gcTF5ICogcTJ4O1xuICAgIHRoaXMudyA9IHExdyAqIHEydyAtIHExeCAqIHEyeCAtIHExeSAqIHEyeSAtIHExeiAqIHEyejtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgbm9ybWFsaXplOmZ1bmN0aW9uKCkge1xuICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aCgpO1xuICAgIGlmIChsZW4gPT09IDApIHtcbiAgICAgIHRoaXMueCA9IHRoaXMueSA9IHRoaXMueiA9IDA7XG4gICAgICB0aGlzLncgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZW4gPSAxIC8gbGVuO1xuICAgICAgdGhpcy54ICo9IGxlbjtcbiAgICAgIHRoaXMueSAqPSBsZW47XG4gICAgICB0aGlzLnogKj0gbGVuO1xuICAgICAgdGhpcy53ICo9IGxlbjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sIHNldDpmdW5jdGlvbih4LCB5LCB6LCB3KSB7XG4gICAgdGhpcy54ID0geDtcbiAgICB0aGlzLnkgPSB5O1xuICAgIHRoaXMueiA9IHo7XG4gICAgdGhpcy53ID0gdztcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2V0RnJvbUF4aXNBbmdsZTpmdW5jdGlvbihheGlzLCBhbmdsZSkge1xuICAgIHZhciBzYSwgY2E7XG4gICAgYW5nbGUgKj0gMC41ICogcGMubWF0aC5ERUdfVE9fUkFEO1xuICAgIHNhID0gTWF0aC5zaW4oYW5nbGUpO1xuICAgIGNhID0gTWF0aC5jb3MoYW5nbGUpO1xuICAgIHRoaXMueCA9IHNhICogYXhpcy54O1xuICAgIHRoaXMueSA9IHNhICogYXhpcy55O1xuICAgIHRoaXMueiA9IHNhICogYXhpcy56O1xuICAgIHRoaXMudyA9IGNhO1xuICAgIHJldHVybiB0aGlzO1xuICB9LCBzZXRGcm9tRXVsZXJBbmdsZXM6ZnVuY3Rpb24oZXgsIGV5LCBleikge1xuICAgIHZhciBzeCwgY3gsIHN5LCBjeSwgc3osIGN6LCBoYWxmVG9SYWQ7XG4gICAgaGFsZlRvUmFkID0gMC41ICogcGMubWF0aC5ERUdfVE9fUkFEO1xuICAgIGV4ICo9IGhhbGZUb1JhZDtcbiAgICBleSAqPSBoYWxmVG9SYWQ7XG4gICAgZXogKj0gaGFsZlRvUmFkO1xuICAgIHN4ID0gTWF0aC5zaW4oZXgpO1xuICAgIGN4ID0gTWF0aC5jb3MoZXgpO1xuICAgIHN5ID0gTWF0aC5zaW4oZXkpO1xuICAgIGN5ID0gTWF0aC5jb3MoZXkpO1xuICAgIHN6ID0gTWF0aC5zaW4oZXopO1xuICAgIGN6ID0gTWF0aC5jb3MoZXopO1xuICAgIHRoaXMueCA9IHN4ICogY3kgKiBjeiAtIGN4ICogc3kgKiBzejtcbiAgICB0aGlzLnkgPSBjeCAqIHN5ICogY3ogKyBzeCAqIGN5ICogc3o7XG4gICAgdGhpcy56ID0gY3ggKiBjeSAqIHN6IC0gc3ggKiBzeSAqIGN6O1xuICAgIHRoaXMudyA9IGN4ICogY3kgKiBjeiArIHN4ICogc3kgKiBzejtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2V0RnJvbU1hdDQ6ZnVuY3Rpb24obSkge1xuICAgIHZhciBtMDAsIG0wMSwgbTAyLCBtMTAsIG0xMSwgbTEyLCBtMjAsIG0yMSwgbTIyLCB0ciwgcywgcnMsIGx4LCBseSwgbHo7XG4gICAgbSA9IG0uZGF0YTtcbiAgICBtMDAgPSBtWzBdO1xuICAgIG0wMSA9IG1bMV07XG4gICAgbTAyID0gbVsyXTtcbiAgICBtMTAgPSBtWzRdO1xuICAgIG0xMSA9IG1bNV07XG4gICAgbTEyID0gbVs2XTtcbiAgICBtMjAgPSBtWzhdO1xuICAgIG0yMSA9IG1bOV07XG4gICAgbTIyID0gbVsxMF07XG4gICAgbHggPSAxIC8gTWF0aC5zcXJ0KG0wMCAqIG0wMCArIG0wMSAqIG0wMSArIG0wMiAqIG0wMik7XG4gICAgbHkgPSAxIC8gTWF0aC5zcXJ0KG0xMCAqIG0xMCArIG0xMSAqIG0xMSArIG0xMiAqIG0xMik7XG4gICAgbHogPSAxIC8gTWF0aC5zcXJ0KG0yMCAqIG0yMCArIG0yMSAqIG0yMSArIG0yMiAqIG0yMik7XG4gICAgbTAwICo9IGx4O1xuICAgIG0wMSAqPSBseDtcbiAgICBtMDIgKj0gbHg7XG4gICAgbTEwICo9IGx5O1xuICAgIG0xMSAqPSBseTtcbiAgICBtMTIgKj0gbHk7XG4gICAgbTIwICo9IGx6O1xuICAgIG0yMSAqPSBsejtcbiAgICBtMjIgKj0gbHo7XG4gICAgdHIgPSBtMDAgKyBtMTEgKyBtMjI7XG4gICAgaWYgKHRyID49IDApIHtcbiAgICAgIHMgPSBNYXRoLnNxcnQodHIgKyAxKTtcbiAgICAgIHRoaXMudyA9IHMgKiAwLjU7XG4gICAgICBzID0gMC41IC8gcztcbiAgICAgIHRoaXMueCA9IChtMTIgLSBtMjEpICogcztcbiAgICAgIHRoaXMueSA9IChtMjAgLSBtMDIpICogcztcbiAgICAgIHRoaXMueiA9IChtMDEgLSBtMTApICogcztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG0wMCA+IG0xMSkge1xuICAgICAgICBpZiAobTAwID4gbTIyKSB7XG4gICAgICAgICAgcnMgPSBtMDAgLSAobTExICsgbTIyKSArIDE7XG4gICAgICAgICAgcnMgPSBNYXRoLnNxcnQocnMpO1xuICAgICAgICAgIHRoaXMueCA9IHJzICogMC41O1xuICAgICAgICAgIHJzID0gMC41IC8gcnM7XG4gICAgICAgICAgdGhpcy53ID0gKG0xMiAtIG0yMSkgKiBycztcbiAgICAgICAgICB0aGlzLnkgPSAobTAxICsgbTEwKSAqIHJzO1xuICAgICAgICAgIHRoaXMueiA9IChtMDIgKyBtMjApICogcnM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcnMgPSBtMjIgLSAobTAwICsgbTExKSArIDE7XG4gICAgICAgICAgcnMgPSBNYXRoLnNxcnQocnMpO1xuICAgICAgICAgIHRoaXMueiA9IHJzICogMC41O1xuICAgICAgICAgIHJzID0gMC41IC8gcnM7XG4gICAgICAgICAgdGhpcy53ID0gKG0wMSAtIG0xMCkgKiBycztcbiAgICAgICAgICB0aGlzLnggPSAobTIwICsgbTAyKSAqIHJzO1xuICAgICAgICAgIHRoaXMueSA9IChtMjEgKyBtMTIpICogcnM7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChtMTEgPiBtMjIpIHtcbiAgICAgICAgICBycyA9IG0xMSAtIChtMjIgKyBtMDApICsgMTtcbiAgICAgICAgICBycyA9IE1hdGguc3FydChycyk7XG4gICAgICAgICAgdGhpcy55ID0gcnMgKiAwLjU7XG4gICAgICAgICAgcnMgPSAwLjUgLyBycztcbiAgICAgICAgICB0aGlzLncgPSAobTIwIC0gbTAyKSAqIHJzO1xuICAgICAgICAgIHRoaXMueiA9IChtMTIgKyBtMjEpICogcnM7XG4gICAgICAgICAgdGhpcy54ID0gKG0xMCArIG0wMSkgKiBycztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBycyA9IG0yMiAtIChtMDAgKyBtMTEpICsgMTtcbiAgICAgICAgICBycyA9IE1hdGguc3FydChycyk7XG4gICAgICAgICAgdGhpcy56ID0gcnMgKiAwLjU7XG4gICAgICAgICAgcnMgPSAwLjUgLyBycztcbiAgICAgICAgICB0aGlzLncgPSAobTAxIC0gbTEwKSAqIHJzO1xuICAgICAgICAgIHRoaXMueCA9IChtMjAgKyBtMDIpICogcnM7XG4gICAgICAgICAgdGhpcy55ID0gKG0yMSArIG0xMikgKiBycztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfSwgc2xlcnA6ZnVuY3Rpb24obGhzLCByaHMsIGFscGhhKSB7XG4gICAgdmFyIGx4LCBseSwgbHosIGx3LCByeCwgcnksIHJ6LCBydztcbiAgICBseCA9IGxocy54O1xuICAgIGx5ID0gbGhzLnk7XG4gICAgbHogPSBsaHMuejtcbiAgICBsdyA9IGxocy53O1xuICAgIHJ4ID0gcmhzLng7XG4gICAgcnkgPSByaHMueTtcbiAgICByeiA9IHJocy56O1xuICAgIHJ3ID0gcmhzLnc7XG4gICAgdmFyIGNvc0hhbGZUaGV0YSA9IGx3ICogcncgKyBseCAqIHJ4ICsgbHkgKiByeSArIGx6ICogcno7XG4gICAgaWYgKGNvc0hhbGZUaGV0YSA8IDApIHtcbiAgICAgIHJ3ID0gLXJ3O1xuICAgICAgcnggPSAtcng7XG4gICAgICByeSA9IC1yeTtcbiAgICAgIHJ6ID0gLXJ6O1xuICAgICAgY29zSGFsZlRoZXRhID0gLWNvc0hhbGZUaGV0YTtcbiAgICB9XG4gICAgaWYgKE1hdGguYWJzKGNvc0hhbGZUaGV0YSkgPj0gMSkge1xuICAgICAgdGhpcy53ID0gbHc7XG4gICAgICB0aGlzLnggPSBseDtcbiAgICAgIHRoaXMueSA9IGx5O1xuICAgICAgdGhpcy56ID0gbHo7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgdmFyIGhhbGZUaGV0YSA9IE1hdGguYWNvcyhjb3NIYWxmVGhldGEpO1xuICAgIHZhciBzaW5IYWxmVGhldGEgPSBNYXRoLnNxcnQoMSAtIGNvc0hhbGZUaGV0YSAqIGNvc0hhbGZUaGV0YSk7XG4gICAgaWYgKE1hdGguYWJzKHNpbkhhbGZUaGV0YSkgPCAwLjAwMSkge1xuICAgICAgdGhpcy53ID0gbHcgKiAwLjUgKyBydyAqIDAuNTtcbiAgICAgIHRoaXMueCA9IGx4ICogMC41ICsgcnggKiAwLjU7XG4gICAgICB0aGlzLnkgPSBseSAqIDAuNSArIHJ5ICogMC41O1xuICAgICAgdGhpcy56ID0gbHogKiAwLjUgKyByeiAqIDAuNTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB2YXIgcmF0aW9BID0gTWF0aC5zaW4oKDEgLSBhbHBoYSkgKiBoYWxmVGhldGEpIC8gc2luSGFsZlRoZXRhO1xuICAgIHZhciByYXRpb0IgPSBNYXRoLnNpbihhbHBoYSAqIGhhbGZUaGV0YSkgLyBzaW5IYWxmVGhldGE7XG4gICAgdGhpcy53ID0gbHcgKiByYXRpb0EgKyBydyAqIHJhdGlvQjtcbiAgICB0aGlzLnggPSBseCAqIHJhdGlvQSArIHJ4ICogcmF0aW9CO1xuICAgIHRoaXMueSA9IGx5ICogcmF0aW9BICsgcnkgKiByYXRpb0I7XG4gICAgdGhpcy56ID0gbHogKiByYXRpb0EgKyByeiAqIHJhdGlvQjtcbiAgICByZXR1cm4gdGhpcztcbiAgfSwgdHJhbnNmb3JtVmVjdG9yOmZ1bmN0aW9uKHZlYywgcmVzKSB7XG4gICAgaWYgKHJlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXMgPSBuZXcgcGMuVmVjMztcbiAgICB9XG4gICAgdmFyIHggPSB2ZWMueCwgeSA9IHZlYy55LCB6ID0gdmVjLno7XG4gICAgdmFyIHF4ID0gdGhpcy54LCBxeSA9IHRoaXMueSwgcXogPSB0aGlzLnosIHF3ID0gdGhpcy53O1xuICAgIHZhciBpeCA9IHF3ICogeCArIHF5ICogeiAtIHF6ICogeTtcbiAgICB2YXIgaXkgPSBxdyAqIHkgKyBxeiAqIHggLSBxeCAqIHo7XG4gICAgdmFyIGl6ID0gcXcgKiB6ICsgcXggKiB5IC0gcXkgKiB4O1xuICAgIHZhciBpdyA9IC1xeCAqIHggLSBxeSAqIHkgLSBxeiAqIHo7XG4gICAgcmVzLnggPSBpeCAqIHF3ICsgaXcgKiAtcXggKyBpeSAqIC1xeiAtIGl6ICogLXF5O1xuICAgIHJlcy55ID0gaXkgKiBxdyArIGl3ICogLXF5ICsgaXogKiAtcXggLSBpeCAqIC1xejtcbiAgICByZXMueiA9IGl6ICogcXcgKyBpdyAqIC1xeiArIGl4ICogLXF5IC0gaXkgKiAtcXg7XG4gICAgcmV0dXJuIHJlcztcbiAgfSwgdG9TdHJpbmc6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFwiW1wiICsgdGhpcy54ICsgXCIsIFwiICsgdGhpcy55ICsgXCIsIFwiICsgdGhpcy56ICsgXCIsIFwiICsgdGhpcy53ICsgXCJdXCI7XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUXVhdCwgXCJJREVOVElUWVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBpZGVudGl0eSA9IG5ldyBRdWF0O1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBpZGVudGl0eTtcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFF1YXQsIFwiWkVST1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciB6ZXJvID0gbmV3IFF1YXQoMCwgMCwgMCwgMCk7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHplcm87XG4gICAgfTtcbiAgfSgpfSk7XG4gIHJldHVybiB7UXVhdDpRdWF0fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQ1VSVkVfTElORUFSID0gMDtcbiAgdmFyIENVUlZFX1NNT09USFNURVAgPSAxO1xuICB2YXIgQ1VSVkVfQ0FUTVVMTCA9IDI7XG4gIHZhciBDVVJWRV9DQVJESU5BTCA9IDM7XG4gIHZhciBDdXJ2ZSA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB0aGlzLmtleXMgPSBbXTtcbiAgICB0aGlzLnR5cGUgPSBDVVJWRV9TTU9PVEhTVEVQO1xuICAgIHRoaXMudGVuc2lvbiA9IDAuNTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IGRhdGEubGVuZ3RoIC0gMTtpICs9IDIpIHtcbiAgICAgICAgdGhpcy5rZXlzLnB1c2goW2RhdGFbaV0sIGRhdGFbaSArIDFdXSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc29ydCgpO1xuICB9O1xuICBDdXJ2ZS5wcm90b3R5cGUgPSB7YWRkOmZ1bmN0aW9uKHRpbWUsIHZhbHVlKSB7XG4gICAgdmFyIGtleXMgPSB0aGlzLmtleXM7XG4gICAgdmFyIGxlbiA9IGtleXMubGVuZ3RoO1xuICAgIHZhciBpID0gMDtcbiAgICBmb3IgKDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKGtleXNbaV1bMF0gPiB0aW1lKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIga2V5ID0gW3RpbWUsIHZhbHVlXTtcbiAgICB0aGlzLmtleXMuc3BsaWNlKGksIDAsIGtleSk7XG4gICAgcmV0dXJuIGtleTtcbiAgfSwgZ2V0OmZ1bmN0aW9uKGluZGV4KSB7XG4gICAgcmV0dXJuIHRoaXMua2V5c1tpbmRleF07XG4gIH0sIHNvcnQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5rZXlzLnNvcnQoZnVuY3Rpb24oYSwgYikge1xuICAgICAgcmV0dXJuIGFbMF0gLSBiWzBdO1xuICAgIH0pO1xuICB9LCB2YWx1ZTpmdW5jdGlvbih0aW1lKSB7XG4gICAgdmFyIGtleXMgPSB0aGlzLmtleXM7XG4gICAgaWYgKCFrZXlzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGlmICh0aW1lIDwga2V5c1swXVswXSkge1xuICAgICAgcmV0dXJuIGtleXNbMF1bMV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aW1lID4ga2V5c1trZXlzLmxlbmd0aCAtIDFdWzBdKSB7XG4gICAgICAgIHJldHVybiBrZXlzW2tleXMubGVuZ3RoIC0gMV1bMV07XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBsZWZ0VGltZSA9IDA7XG4gICAgdmFyIGxlZnRWYWx1ZSA9IGtleXMubGVuZ3RoID8ga2V5c1swXVsxXSA6IDA7XG4gICAgdmFyIHJpZ2h0VGltZSA9IDE7XG4gICAgdmFyIHJpZ2h0VmFsdWUgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBrZXlzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKGtleXNbaV1bMF0gPT09IHRpbWUpIHtcbiAgICAgICAgcmV0dXJuIGtleXNbaV1bMV07XG4gICAgICB9XG4gICAgICByaWdodFZhbHVlID0ga2V5c1tpXVsxXTtcbiAgICAgIGlmICh0aW1lIDwga2V5c1tpXVswXSkge1xuICAgICAgICByaWdodFRpbWUgPSBrZXlzW2ldWzBdO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGxlZnRUaW1lID0ga2V5c1tpXVswXTtcbiAgICAgIGxlZnRWYWx1ZSA9IGtleXNbaV1bMV07XG4gICAgfVxuICAgIHZhciBkaXYgPSByaWdodFRpbWUgLSBsZWZ0VGltZTtcbiAgICB2YXIgaW50ZXJwb2xhdGlvbiA9IGRpdiA9PT0gMCA/IDAgOiAodGltZSAtIGxlZnRUaW1lKSAvIGRpdjtcbiAgICBpZiAodGhpcy50eXBlID09PSBDVVJWRV9TTU9PVEhTVEVQKSB7XG4gICAgICBpbnRlcnBvbGF0aW9uICo9IGludGVycG9sYXRpb24gKiAoMyAtIDIgKiBpbnRlcnBvbGF0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMudHlwZSA9PT0gQ1VSVkVfQ0FUTVVMTCB8fCB0aGlzLnR5cGUgPT09IENVUlZFX0NBUkRJTkFMKSB7XG4gICAgICAgIHZhciBwMSA9IGxlZnRWYWx1ZTtcbiAgICAgICAgdmFyIHAyID0gcmlnaHRWYWx1ZTtcbiAgICAgICAgdmFyIHAwID0gcDEgKyAocDEgLSBwMik7XG4gICAgICAgIHZhciBwMyA9IHAyICsgKHAyIC0gcDEpO1xuICAgICAgICB2YXIgZHQxID0gcmlnaHRUaW1lIC0gbGVmdFRpbWU7XG4gICAgICAgIHZhciBkdDAgPSBkdDE7XG4gICAgICAgIHZhciBkdDIgPSBkdDE7XG4gICAgICAgIGlmIChpID4gMCkge1xuICAgICAgICAgIGkgPSBpIC0gMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgICBwMCA9IGtleXNbaSAtIDFdWzFdO1xuICAgICAgICAgIGR0MCA9IGtleXNbaV1bMF0gLSBrZXlzW2kgLSAxXVswXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPiBpICsgMSkge1xuICAgICAgICAgIGR0MSA9IGtleXNbaSArIDFdWzBdIC0ga2V5c1tpXVswXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPiBpICsgMikge1xuICAgICAgICAgIGR0MiA9IGtleXNbaSArIDJdWzBdIC0ga2V5c1tpICsgMV1bMF07XG4gICAgICAgICAgcDMgPSBrZXlzW2kgKyAyXVsxXTtcbiAgICAgICAgfVxuICAgICAgICBwMCA9IHAxICsgKHAwIC0gcDEpICogZHQxIC8gZHQwO1xuICAgICAgICBwMyA9IHAyICsgKHAzIC0gcDIpICogZHQxIC8gZHQyO1xuICAgICAgICBpZiAodGhpcy50eXBlID09PSBDVVJWRV9DQVRNVUxMKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVycG9sYXRlQ2F0bXVsbFJvbShwMCwgcDEsIHAyLCBwMywgaW50ZXJwb2xhdGlvbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVycG9sYXRlQ2FyZGluYWwocDAsIHAxLCBwMiwgcDMsIGludGVycG9sYXRpb24sIHRoaXMudGVuc2lvbik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBjLm1hdGgubGVycChsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUsIGludGVycG9sYXRpb24pO1xuICB9LCBfaW50ZXJwb2xhdGVIZXJtaXRlOmZ1bmN0aW9uKHAwLCBwMSwgdDAsIHQxLCBzKSB7XG4gICAgdmFyIHMyID0gcyAqIHM7XG4gICAgdmFyIHMzID0gcyAqIHMgKiBzO1xuICAgIHZhciBoMCA9IDIgKiBzMyAtIDMgKiBzMiArIDE7XG4gICAgdmFyIGgxID0gLTIgKiBzMyArIDMgKiBzMjtcbiAgICB2YXIgaDIgPSBzMyAtIDIgKiBzMiArIHM7XG4gICAgdmFyIGgzID0gczMgLSBzMjtcbiAgICByZXR1cm4gcDAgKiBoMCArIHAxICogaDEgKyB0MCAqIGgyICsgdDEgKiBoMztcbiAgfSwgX2ludGVycG9sYXRlQ2FyZGluYWw6ZnVuY3Rpb24ocDAsIHAxLCBwMiwgcDMsIHMsIHQpIHtcbiAgICB2YXIgdDAgPSB0ICogKHAyIC0gcDApO1xuICAgIHZhciB0MSA9IHQgKiAocDMgLSBwMSk7XG4gICAgcmV0dXJuIHRoaXMuX2ludGVycG9sYXRlSGVybWl0ZShwMSwgcDIsIHQwLCB0MSwgcyk7XG4gIH0sIF9pbnRlcnBvbGF0ZUNhdG11bGxSb206ZnVuY3Rpb24ocDAsIHAxLCBwMiwgcDMsIHMpIHtcbiAgICByZXR1cm4gdGhpcy5faW50ZXJwb2xhdGVDYXJkaW5hbChwMCwgcDEsIHAyLCBwMywgcywgMC41KTtcbiAgfSwgY2xvc2VzdDpmdW5jdGlvbih0aW1lKSB7XG4gICAgdmFyIGtleXMgPSB0aGlzLmtleXM7XG4gICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoO1xuICAgIHZhciBtaW4gPSAyO1xuICAgIHZhciByZXN1bHQgPSBudWxsO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBsZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgZGlmZiA9IE1hdGguYWJzKHRpbWUgLSBrZXlzW2ldWzBdKTtcbiAgICAgIGlmIChtaW4gPj0gZGlmZikge1xuICAgICAgICBtaW4gPSBkaWZmO1xuICAgICAgICByZXN1bHQgPSBrZXlzW2ldO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHZhciByZXN1bHQgPSBuZXcgcGMuQ3VydmU7XG4gICAgcmVzdWx0LmtleXMgPSBwYy5leHRlbmQocmVzdWx0LmtleXMsIHRoaXMua2V5cyk7XG4gICAgcmVzdWx0LnR5cGUgPSB0aGlzLnR5cGU7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSwgcXVhbnRpemU6ZnVuY3Rpb24ocHJlY2lzaW9uKSB7XG4gICAgcHJlY2lzaW9uID0gTWF0aC5tYXgocHJlY2lzaW9uLCAyKTtcbiAgICB2YXIgdmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShwcmVjaXNpb24pO1xuICAgIHZhciBzdGVwID0gMS4wIC8gKHByZWNpc2lvbiAtIDEpO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBwcmVjaXNpb247aSsrKSB7XG4gICAgICB2YXIgdmFsdWUgPSB0aGlzLnZhbHVlKHN0ZXAgKiBpKTtcbiAgICAgIHZhbHVlc1tpXSA9IHZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWVzO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEN1cnZlLnByb3RvdHlwZSwgXCJsZW5ndGhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5rZXlzLmxlbmd0aDtcbiAgfX0pO1xuICByZXR1cm4ge0N1cnZlOkN1cnZlLCBDVVJWRV9MSU5FQVI6Q1VSVkVfTElORUFSLCBDVVJWRV9TTU9PVEhTVEVQOkNVUlZFX1NNT09USFNURVAsIENVUlZFX0NBVE1VTEw6Q1VSVkVfQ0FUTVVMTCwgQ1VSVkVfQ0FSRElOQUw6Q1VSVkVfQ0FSRElOQUx9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDdXJ2ZVNldCA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBpO1xuICAgIHRoaXMuY3VydmVzID0gW107XG4gICAgdGhpcy5fdHlwZSA9IHBjLkNVUlZFX1NNT09USFNURVA7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBhcmd1bWVudHMubGVuZ3RoO2krKykge1xuICAgICAgICB0aGlzLmN1cnZlcy5wdXNoKG5ldyBwYy5DdXJ2ZShhcmd1bWVudHNbaV0pKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy5jdXJ2ZXMucHVzaChuZXcgcGMuQ3VydmUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgaWYgKHBjLnR5cGUoYXJnKSA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgIGZvciAoaSA9IDA7aSA8IGFyZztpKyspIHtcbiAgICAgICAgICAgIHRoaXMuY3VydmVzLnB1c2gobmV3IHBjLkN1cnZlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZm9yIChpID0gMDtpIDwgYXJnLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgIHRoaXMuY3VydmVzLnB1c2gobmV3IHBjLkN1cnZlKGFyZ1tpXSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgQ3VydmVTZXQucHJvdG90eXBlID0ge2dldDpmdW5jdGlvbihpbmRleCkge1xuICAgIHJldHVybiB0aGlzLmN1cnZlc1tpbmRleF07XG4gIH0sIHZhbHVlOmZ1bmN0aW9uKHRpbWUsIHJlc3VsdCkge1xuICAgIHZhciBsZW5ndGggPSB0aGlzLmN1cnZlcy5sZW5ndGg7XG4gICAgcmVzdWx0ID0gcmVzdWx0IHx8IFtdO1xuICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IGxlbmd0aDtpKyspIHtcbiAgICAgIHJlc3VsdFtpXSA9IHRoaXMuY3VydmVzW2ldLnZhbHVlKHRpbWUpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9LCBjbG9uZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgcmVzdWx0ID0gbmV3IHBjLkN1cnZlU2V0O1xuICAgIHJlc3VsdC5jdXJ2ZXMgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5jdXJ2ZXMubGVuZ3RoO2krKykge1xuICAgICAgcmVzdWx0LmN1cnZlcy5wdXNoKHRoaXMuY3VydmVzW2ldLmNsb25lKCkpO1xuICAgIH1cbiAgICByZXN1bHQuX3R5cGUgPSB0aGlzLl90eXBlO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0sIHF1YW50aXplOmZ1bmN0aW9uKHByZWNpc2lvbikge1xuICAgIHByZWNpc2lvbiA9IE1hdGgubWF4KHByZWNpc2lvbiwgMik7XG4gICAgdmFyIG51bUN1cnZlcyA9IHRoaXMuY3VydmVzLmxlbmd0aDtcbiAgICB2YXIgdmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShwcmVjaXNpb24gKiBudW1DdXJ2ZXMpO1xuICAgIHZhciBzdGVwID0gMS4wIC8gKHByZWNpc2lvbiAtIDEpO1xuICAgIHZhciB0ZW1wID0gW107XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHByZWNpc2lvbjtpKyspIHtcbiAgICAgIHZhciB2YWx1ZSA9IHRoaXMudmFsdWUoc3RlcCAqIGksIHRlbXApO1xuICAgICAgaWYgKG51bUN1cnZlcyA9PSAxKSB7XG4gICAgICAgIHZhbHVlc1tpXSA9IHZhbHVlWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgaiA9IDA7aiA8IG51bUN1cnZlcztqKyspIHtcbiAgICAgICAgICB2YWx1ZXNbaSAqIG51bUN1cnZlcyArIGpdID0gdmFsdWVbal07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlcztcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDdXJ2ZVNldC5wcm90b3R5cGUsIFwibGVuZ3RoXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VydmVzLmxlbmd0aDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ3VydmVTZXQucHJvdG90eXBlLCBcInR5cGVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fdHlwZSA9IHZhbHVlO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLmN1cnZlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB0aGlzLmN1cnZlc1tpXS50eXBlID0gdmFsdWU7XG4gICAgfVxuICB9fSk7XG4gIHJldHVybiB7Q3VydmVTZXQ6Q3VydmVTZXR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciB0bXBWZWNBID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNCID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNDID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNEID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNFID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNGID0gbmV3IHBjLlZlYzM7XG4gIHZhciBCb3VuZGluZ0JveCA9IGZ1bmN0aW9uIEJvdW5kaW5nQm94KGNlbnRlciwgaGFsZkV4dGVudHMpIHtcbiAgICB0aGlzLmNlbnRlciA9IGNlbnRlciB8fCBuZXcgcGMuVmVjMygwLCAwLCAwKTtcbiAgICB0aGlzLmhhbGZFeHRlbnRzID0gaGFsZkV4dGVudHMgfHwgbmV3IHBjLlZlYzMoMC41LCAwLjUsIDAuNSk7XG4gICAgdGhpcy5fbWluID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5fbWF4ID0gbmV3IHBjLlZlYzM7XG4gIH07XG4gIEJvdW5kaW5nQm94LnByb3RvdHlwZSA9IHthZGQ6ZnVuY3Rpb24ob3RoZXIpIHtcbiAgICB2YXIgdGMgPSB0aGlzLmNlbnRlci5kYXRhO1xuICAgIHZhciB0Y3ggPSB0Y1swXTtcbiAgICB2YXIgdGN5ID0gdGNbMV07XG4gICAgdmFyIHRjeiA9IHRjWzJdO1xuICAgIHZhciB0aCA9IHRoaXMuaGFsZkV4dGVudHMuZGF0YTtcbiAgICB2YXIgdGh4ID0gdGhbMF07XG4gICAgdmFyIHRoeSA9IHRoWzFdO1xuICAgIHZhciB0aHogPSB0aFsyXTtcbiAgICB2YXIgdG1pbnggPSB0Y3ggLSB0aHg7XG4gICAgdmFyIHRtYXh4ID0gdGN4ICsgdGh4O1xuICAgIHZhciB0bWlueSA9IHRjeSAtIHRoeTtcbiAgICB2YXIgdG1heHkgPSB0Y3kgKyB0aHk7XG4gICAgdmFyIHRtaW56ID0gdGN6IC0gdGh6O1xuICAgIHZhciB0bWF4eiA9IHRjeiArIHRoejtcbiAgICB2YXIgb2MgPSBvdGhlci5jZW50ZXIuZGF0YTtcbiAgICB2YXIgb2N4ID0gb2NbMF07XG4gICAgdmFyIG9jeSA9IG9jWzFdO1xuICAgIHZhciBvY3ogPSBvY1syXTtcbiAgICB2YXIgb2ggPSBvdGhlci5oYWxmRXh0ZW50cy5kYXRhO1xuICAgIHZhciBvaHggPSBvaFswXTtcbiAgICB2YXIgb2h5ID0gb2hbMV07XG4gICAgdmFyIG9oeiA9IG9oWzJdO1xuICAgIHZhciBvbWlueCA9IG9jeCAtIG9oeDtcbiAgICB2YXIgb21heHggPSBvY3ggKyBvaHg7XG4gICAgdmFyIG9taW55ID0gb2N5IC0gb2h5O1xuICAgIHZhciBvbWF4eSA9IG9jeSArIG9oeTtcbiAgICB2YXIgb21pbnogPSBvY3ogLSBvaHo7XG4gICAgdmFyIG9tYXh6ID0gb2N6ICsgb2h6O1xuICAgIGlmIChvbWlueCA8IHRtaW54KSB7XG4gICAgICB0bWlueCA9IG9taW54O1xuICAgIH1cbiAgICBpZiAob21heHggPiB0bWF4eCkge1xuICAgICAgdG1heHggPSBvbWF4eDtcbiAgICB9XG4gICAgaWYgKG9taW55IDwgdG1pbnkpIHtcbiAgICAgIHRtaW55ID0gb21pbnk7XG4gICAgfVxuICAgIGlmIChvbWF4eSA+IHRtYXh5KSB7XG4gICAgICB0bWF4eSA9IG9tYXh5O1xuICAgIH1cbiAgICBpZiAob21pbnogPCB0bWlueikge1xuICAgICAgdG1pbnogPSBvbWluejtcbiAgICB9XG4gICAgaWYgKG9tYXh6ID4gdG1heHopIHtcbiAgICAgIHRtYXh6ID0gb21heHo7XG4gICAgfVxuICAgIHRjWzBdID0gKHRtaW54ICsgdG1heHgpICogMC41O1xuICAgIHRjWzFdID0gKHRtaW55ICsgdG1heHkpICogMC41O1xuICAgIHRjWzJdID0gKHRtaW56ICsgdG1heHopICogMC41O1xuICAgIHRoWzBdID0gKHRtYXh4IC0gdG1pbngpICogMC41O1xuICAgIHRoWzFdID0gKHRtYXh5IC0gdG1pbnkpICogMC41O1xuICAgIHRoWzJdID0gKHRtYXh6IC0gdG1pbnopICogMC41O1xuICB9LCBjb3B5OmZ1bmN0aW9uKHNyYykge1xuICAgIHRoaXMuY2VudGVyLmNvcHkoc3JjLmNlbnRlcik7XG4gICAgdGhpcy5oYWxmRXh0ZW50cy5jb3B5KHNyYy5oYWxmRXh0ZW50cyk7XG4gICAgdGhpcy50eXBlID0gc3JjLnR5cGU7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBuZXcgcGMuQm91bmRpbmdCb3godGhpcy5jZW50ZXIuY2xvbmUoKSwgdGhpcy5oYWxmRXh0ZW50cy5jbG9uZSgpKTtcbiAgfSwgaW50ZXJzZWN0czpmdW5jdGlvbihvdGhlcikge1xuICAgIHZhciBhTWF4ID0gdGhpcy5nZXRNYXgoKTtcbiAgICB2YXIgYU1pbiA9IHRoaXMuZ2V0TWluKCk7XG4gICAgdmFyIGJNYXggPSBvdGhlci5nZXRNYXgoKTtcbiAgICB2YXIgYk1pbiA9IG90aGVyLmdldE1pbigpO1xuICAgIHJldHVybiBhTWluLnggPD0gYk1heC54ICYmIGFNYXgueCA+PSBiTWluLnggJiYgYU1pbi55IDw9IGJNYXgueSAmJiBhTWF4LnkgPj0gYk1pbi55ICYmIGFNaW4ueiA8PSBiTWF4LnogJiYgYU1heC56ID49IGJNaW4uejtcbiAgfSwgX2ludGVyc2VjdHNSYXk6ZnVuY3Rpb24ocmF5LCBwb2ludCkge1xuICAgIHZhciB0TWluID0gdG1wVmVjQS5jb3B5KHRoaXMuZ2V0TWluKCkpLnN1YihyYXkub3JpZ2luKS5kYXRhO1xuICAgIHZhciB0TWF4ID0gdG1wVmVjQi5jb3B5KHRoaXMuZ2V0TWF4KCkpLnN1YihyYXkub3JpZ2luKS5kYXRhO1xuICAgIHZhciBkaXIgPSByYXkuZGlyZWN0aW9uLmRhdGE7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDM7aSsrKSB7XG4gICAgICBpZiAoZGlyW2ldID09PSAwKSB7XG4gICAgICAgIHRNaW5baV0gPSB0TWluW2ldIDwgMCA/IC1OdW1iZXIuTUFYX1ZBTFVFIDogTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgdE1heFtpXSA9IHRNYXhbaV0gPCAwID8gLU51bWJlci5NQVhfVkFMVUUgOiBOdW1iZXIuTUFYX1ZBTFVFO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdE1pbltpXSAvPSBkaXJbaV07XG4gICAgICAgIHRNYXhbaV0gLz0gZGlyW2ldO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmVhbE1pbiA9IHRtcFZlY0Muc2V0KE1hdGgubWluKHRNaW5bMF0sIHRNYXhbMF0pLCBNYXRoLm1pbih0TWluWzFdLCB0TWF4WzFdKSwgTWF0aC5taW4odE1pblsyXSwgdE1heFsyXSkpLmRhdGE7XG4gICAgdmFyIHJlYWxNYXggPSB0bXBWZWNELnNldChNYXRoLm1heCh0TWluWzBdLCB0TWF4WzBdKSwgTWF0aC5tYXgodE1pblsxXSwgdE1heFsxXSksIE1hdGgubWF4KHRNaW5bMl0sIHRNYXhbMl0pKS5kYXRhO1xuICAgIHZhciBtaW5NYXggPSBNYXRoLm1pbihNYXRoLm1pbihyZWFsTWF4WzBdLCByZWFsTWF4WzFdKSwgcmVhbE1heFsyXSk7XG4gICAgdmFyIG1heE1pbiA9IE1hdGgubWF4KE1hdGgubWF4KHJlYWxNaW5bMF0sIHJlYWxNaW5bMV0pLCByZWFsTWluWzJdKTtcbiAgICB2YXIgaW50ZXJzZWN0cyA9IG1pbk1heCA+PSBtYXhNaW4gJiYgbWF4TWluID49IDA7XG4gICAgaWYgKGludGVyc2VjdHMpIHtcbiAgICAgIHBvaW50LmNvcHkocmF5LmRpcmVjdGlvbikuc2NhbGUobWF4TWluKS5hZGQocmF5Lm9yaWdpbik7XG4gICAgfVxuICAgIHJldHVybiBpbnRlcnNlY3RzO1xuICB9LCBfZmFzdEludGVyc2VjdHNSYXk6ZnVuY3Rpb24ocmF5KSB7XG4gICAgdmFyIGRpZmYgPSB0bXBWZWNBO1xuICAgIHZhciBjcm9zcyA9IHRtcFZlY0I7XG4gICAgdmFyIHByb2QgPSB0bXBWZWNDO1xuICAgIHZhciBhYnNEaWZmID0gdG1wVmVjRDtcbiAgICB2YXIgYWJzRGlyID0gdG1wVmVjRTtcbiAgICB2YXIgcmF5RGlyID0gcmF5LmRpcmVjdGlvbjtcbiAgICB2YXIgaTtcbiAgICBkaWZmLnN1YjIocmF5Lm9yaWdpbiwgdGhpcy5jZW50ZXIpO1xuICAgIGFic0RpZmYuc2V0KE1hdGguYWJzKGRpZmYueCksIE1hdGguYWJzKGRpZmYueSksIE1hdGguYWJzKGRpZmYueikpO1xuICAgIHByb2QubXVsMihkaWZmLCByYXlEaXIpO1xuICAgIGlmIChhYnNEaWZmLnggPiB0aGlzLmhhbGZFeHRlbnRzLnggJiYgcHJvZC54ID49IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGFic0RpZmYueSA+IHRoaXMuaGFsZkV4dGVudHMueSAmJiBwcm9kLnkgPj0gMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoYWJzRGlmZi56ID4gdGhpcy5oYWxmRXh0ZW50cy56ICYmIHByb2QueiA+PSAwKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGFic0Rpci5zZXQoTWF0aC5hYnMocmF5RGlyLngpLCBNYXRoLmFicyhyYXlEaXIueSksIE1hdGguYWJzKHJheURpci56KSk7XG4gICAgY3Jvc3MuY3Jvc3MocmF5RGlyLCBkaWZmKTtcbiAgICBjcm9zcy5zZXQoTWF0aC5hYnMoY3Jvc3MueCksIE1hdGguYWJzKGNyb3NzLnkpLCBNYXRoLmFicyhjcm9zcy56KSk7XG4gICAgaWYgKGNyb3NzLnggPiB0aGlzLmhhbGZFeHRlbnRzLnkgKiBhYnNEaXIueiArIHRoaXMuaGFsZkV4dGVudHMueiAqIGFic0Rpci55KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChjcm9zcy55ID4gdGhpcy5oYWxmRXh0ZW50cy54ICogYWJzRGlyLnogKyB0aGlzLmhhbGZFeHRlbnRzLnogKiBhYnNEaXIueCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoY3Jvc3MueiA+IHRoaXMuaGFsZkV4dGVudHMueCAqIGFic0Rpci55ICsgdGhpcy5oYWxmRXh0ZW50cy55ICogYWJzRGlyLngpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIGludGVyc2VjdHNSYXk6ZnVuY3Rpb24ocmF5LCBwb2ludCkge1xuICAgIGlmIChwb2ludCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdHNSYXkocmF5LCBwb2ludCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLl9mYXN0SW50ZXJzZWN0c1JheShyYXkpO1xuICAgIH1cbiAgfSwgc2V0TWluTWF4OmZ1bmN0aW9uKG1pbiwgbWF4KSB7XG4gICAgdGhpcy5jZW50ZXIuYWRkMihtYXgsIG1pbikuc2NhbGUoMC41KTtcbiAgICB0aGlzLmhhbGZFeHRlbnRzLnN1YjIobWF4LCBtaW4pLnNjYWxlKDAuNSk7XG4gIH0sIGdldE1pbjpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWluLmNvcHkodGhpcy5jZW50ZXIpLnN1Yih0aGlzLmhhbGZFeHRlbnRzKTtcbiAgfSwgZ2V0TWF4OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9tYXguY29weSh0aGlzLmNlbnRlcikuYWRkKHRoaXMuaGFsZkV4dGVudHMpO1xuICB9LCBjb250YWluc1BvaW50OmZ1bmN0aW9uKHBvaW50KSB7XG4gICAgdmFyIG1pbiA9IHRoaXMuZ2V0TWluKCk7XG4gICAgdmFyIG1heCA9IHRoaXMuZ2V0TWF4KCk7XG4gICAgdmFyIGk7XG4gICAgZm9yIChpID0gMDtpIDwgMzsrK2kpIHtcbiAgICAgIGlmIChwb2ludC5kYXRhW2ldIDwgbWluLmRhdGFbaV0gfHwgcG9pbnQuZGF0YVtpXSA+IG1heC5kYXRhW2ldKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIHNldEZyb21UcmFuc2Zvcm1lZEFhYmI6ZnVuY3Rpb24oYWFiYiwgbSkge1xuICAgIHZhciBiYyA9IHRoaXMuY2VudGVyO1xuICAgIHZhciBiciA9IHRoaXMuaGFsZkV4dGVudHM7XG4gICAgdmFyIGFjID0gYWFiYi5jZW50ZXIuZGF0YTtcbiAgICB2YXIgYXIgPSBhYWJiLmhhbGZFeHRlbnRzLmRhdGE7XG4gICAgbSA9IG0uZGF0YTtcbiAgICB2YXIgbXgwID0gbVswXTtcbiAgICB2YXIgbXgxID0gbVs0XTtcbiAgICB2YXIgbXgyID0gbVs4XTtcbiAgICB2YXIgbXkwID0gbVsxXTtcbiAgICB2YXIgbXkxID0gbVs1XTtcbiAgICB2YXIgbXkyID0gbVs5XTtcbiAgICB2YXIgbXowID0gbVsyXTtcbiAgICB2YXIgbXoxID0gbVs2XTtcbiAgICB2YXIgbXoyID0gbVsxMF07XG4gICAgdmFyIG14MGEgPSBNYXRoLmFicyhteDApO1xuICAgIHZhciBteDFhID0gTWF0aC5hYnMobXgxKTtcbiAgICB2YXIgbXgyYSA9IE1hdGguYWJzKG14Mik7XG4gICAgdmFyIG15MGEgPSBNYXRoLmFicyhteTApO1xuICAgIHZhciBteTFhID0gTWF0aC5hYnMobXkxKTtcbiAgICB2YXIgbXkyYSA9IE1hdGguYWJzKG15Mik7XG4gICAgdmFyIG16MGEgPSBNYXRoLmFicyhtejApO1xuICAgIHZhciBtejFhID0gTWF0aC5hYnMobXoxKTtcbiAgICB2YXIgbXoyYSA9IE1hdGguYWJzKG16Mik7XG4gICAgYmMuc2V0KG1bMTJdICsgbXgwICogYWNbMF0gKyBteDEgKiBhY1sxXSArIG14MiAqIGFjWzJdLCBtWzEzXSArIG15MCAqIGFjWzBdICsgbXkxICogYWNbMV0gKyBteTIgKiBhY1syXSwgbVsxNF0gKyBtejAgKiBhY1swXSArIG16MSAqIGFjWzFdICsgbXoyICogYWNbMl0pO1xuICAgIGJyLnNldChteDBhICogYXJbMF0gKyBteDFhICogYXJbMV0gKyBteDJhICogYXJbMl0sIG15MGEgKiBhclswXSArIG15MWEgKiBhclsxXSArIG15MmEgKiBhclsyXSwgbXowYSAqIGFyWzBdICsgbXoxYSAqIGFyWzFdICsgbXoyYSAqIGFyWzJdKTtcbiAgfSwgY29tcHV0ZTpmdW5jdGlvbih2ZXJ0aWNlcykge1xuICAgIHZhciBtaW4gPSB0bXBWZWNBLnNldCh2ZXJ0aWNlc1swXSwgdmVydGljZXNbMV0sIHZlcnRpY2VzWzJdKTtcbiAgICB2YXIgbWF4ID0gdG1wVmVjQi5zZXQodmVydGljZXNbMF0sIHZlcnRpY2VzWzFdLCB2ZXJ0aWNlc1syXSk7XG4gICAgdmFyIG51bVZlcnRzID0gdmVydGljZXMubGVuZ3RoIC8gMztcbiAgICBmb3IgKHZhciBpID0gMTtpIDwgbnVtVmVydHM7aSsrKSB7XG4gICAgICB2YXIgeCA9IHZlcnRpY2VzW2kgKiAzICsgMF07XG4gICAgICB2YXIgeSA9IHZlcnRpY2VzW2kgKiAzICsgMV07XG4gICAgICB2YXIgeiA9IHZlcnRpY2VzW2kgKiAzICsgMl07XG4gICAgICBpZiAoeCA8IG1pbi54KSB7XG4gICAgICAgIG1pbi54ID0geDtcbiAgICAgIH1cbiAgICAgIGlmICh5IDwgbWluLnkpIHtcbiAgICAgICAgbWluLnkgPSB5O1xuICAgICAgfVxuICAgICAgaWYgKHogPCBtaW4ueikge1xuICAgICAgICBtaW4ueiA9IHo7XG4gICAgICB9XG4gICAgICBpZiAoeCA+IG1heC54KSB7XG4gICAgICAgIG1heC54ID0geDtcbiAgICAgIH1cbiAgICAgIGlmICh5ID4gbWF4LnkpIHtcbiAgICAgICAgbWF4LnkgPSB5O1xuICAgICAgfVxuICAgICAgaWYgKHogPiBtYXgueikge1xuICAgICAgICBtYXgueiA9IHo7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2V0TWluTWF4KG1pbiwgbWF4KTtcbiAgfSwgaW50ZXJzZWN0c0JvdW5kaW5nU3BoZXJlOmZ1bmN0aW9uKHNwaGVyZSkge1xuICAgIHZhciBzcSA9IHRoaXMuX2Rpc3RhbmNlVG9Cb3VuZGluZ1NwaGVyZVNxKHNwaGVyZSk7XG4gICAgaWYgKHNxIDw9IHNwaGVyZS5yYWRpdXMgKiBzcGhlcmUucmFkaXVzKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9LCBfZGlzdGFuY2VUb0JvdW5kaW5nU3BoZXJlU3E6ZnVuY3Rpb24oc3BoZXJlKSB7XG4gICAgdmFyIGJveE1pbiA9IHRoaXMuZ2V0TWluKCk7XG4gICAgdmFyIGJveE1heCA9IHRoaXMuZ2V0TWF4KCk7XG4gICAgdmFyIHNxID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgMzsrK2kpIHtcbiAgICAgIHZhciBvdXQgPSAwO1xuICAgICAgdmFyIHBuID0gc3BoZXJlLmNlbnRlci5kYXRhW2ldO1xuICAgICAgdmFyIGJNaW4gPSBib3hNaW4uZGF0YVtpXTtcbiAgICAgIHZhciBiTWF4ID0gYm94TWF4LmRhdGFbaV07XG4gICAgICB2YXIgdmFsID0gMDtcbiAgICAgIGlmIChwbiA8IGJNaW4pIHtcbiAgICAgICAgdmFsID0gYk1pbiAtIHBuO1xuICAgICAgICBvdXQgKz0gdmFsICogdmFsO1xuICAgICAgfVxuICAgICAgaWYgKHBuID4gYk1heCkge1xuICAgICAgICB2YWwgPSBwbiAtIGJNYXg7XG4gICAgICAgIG91dCArPSB2YWwgKiB2YWw7XG4gICAgICB9XG4gICAgICBzcSArPSBvdXQ7XG4gICAgfVxuICAgIHJldHVybiBzcTtcbiAgfX07XG4gIHJldHVybiB7Qm91bmRpbmdCb3g6Qm91bmRpbmdCb3h9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciB0bXBWZWNBID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNCID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNDID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWNEID0gbmV3IHBjLlZlYzM7XG4gIHZhciBkaWZmQmV0d2VlblBvaW50cyA9IG5ldyBwYy5WZWMzO1xuICBmdW5jdGlvbiBCb3VuZGluZ1NwaGVyZShjZW50ZXIsIHJhZGl1cykge1xuICAgIHRoaXMuY2VudGVyID0gY2VudGVyIHx8IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMucmFkaXVzID0gcmFkaXVzID09PSB1bmRlZmluZWQgPyAwLjUgOiByYWRpdXM7XG4gIH1cbiAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlID0ge2NvbnRhaW5zUG9pbnQ6ZnVuY3Rpb24ocG9pbnQpIHtcbiAgICB2YXIgbGVuU3EgPSB0bXBWZWNBLnN1YjIocG9pbnQsIHRoaXMuY2VudGVyKS5sZW5ndGhTcSgpO1xuICAgIHZhciByID0gdGhpcy5yYWRpdXM7XG4gICAgcmV0dXJuIGxlblNxIDwgciAqIHI7XG4gIH0sIGNvbXB1dGU6ZnVuY3Rpb24odmVydGljZXMpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgbnVtVmVydHMgPSB2ZXJ0aWNlcy5sZW5ndGggLyAzO1xuICAgIHZhciB2ZXJ0ZXggPSB0bXBWZWNBO1xuICAgIHZhciBhdmdWZXJ0ZXggPSB0bXBWZWNCO1xuICAgIHZhciBzdW0gPSB0bXBWZWNDO1xuICAgIGZvciAoaSA9IDA7aSA8IG51bVZlcnRzO2krKykge1xuICAgICAgdmVydGV4LnNldCh2ZXJ0aWNlc1tpICogM10sIHZlcnRpY2VzW2kgKiAzICsgMV0sIHZlcnRpY2VzW2kgKiAzICsgMl0pO1xuICAgICAgc3VtLmFkZFNlbGYodmVydGV4KTtcbiAgICAgIGlmIChpICUgMTAwID09PSAwKSB7XG4gICAgICAgIHN1bS5zY2FsZSgxIC8gbnVtVmVydHMpO1xuICAgICAgICBhdmdWZXJ0ZXguYWRkKHN1bSk7XG4gICAgICAgIHN1bS5zZXQoMCwgMCwgMCk7XG4gICAgICB9XG4gICAgfVxuICAgIHN1bS5zY2FsZSgxIC8gbnVtVmVydHMpO1xuICAgIGF2Z1ZlcnRleC5hZGQoc3VtKTtcbiAgICB0aGlzLmNlbnRlci5jb3B5KGF2Z1ZlcnRleCk7XG4gICAgdmFyIG1heERpc3RTcSA9IDA7XG4gICAgdmFyIGNlbnRlclRvVmVydCA9IHRtcFZlY0Q7XG4gICAgZm9yIChpID0gMDtpIDwgbnVtVmVydHM7aSsrKSB7XG4gICAgICB2ZXJ0ZXguc2V0KHZlcnRpY2VzW2kgKiAzXSwgdmVydGljZXNbaSAqIDMgKyAxXSwgdmVydGljZXNbaSAqIDMgKyAyXSk7XG4gICAgICBjZW50ZXJUb1ZlcnQuc3ViMih2ZXJ0ZXgsIHRoaXMuY2VudGVyKTtcbiAgICAgIG1heERpc3RTcSA9IE1hdGgubWF4KGNlbnRlclRvVmVydC5sZW5ndGhTcSgpLCBtYXhEaXN0U3EpO1xuICAgIH1cbiAgICB0aGlzLnJhZGl1cyA9IE1hdGguc3FydChtYXhEaXN0U3EpO1xuICB9LCBpbnRlcnNlY3RzUmF5OmZ1bmN0aW9uKHJheSwgcG9pbnQpIHtcbiAgICB2YXIgbSA9IHRtcFZlY0EuY29weShyYXkub3JpZ2luKS5zdWIodGhpcy5jZW50ZXIpO1xuICAgIHZhciBiID0gbS5kb3QodG1wVmVjQi5jb3B5KHJheS5kaXJlY3Rpb24pLm5vcm1hbGl6ZSgpKTtcbiAgICB2YXIgYyA9IG0uZG90KG0pIC0gdGhpcy5yYWRpdXMgKiB0aGlzLnJhZGl1cztcbiAgICBpZiAoYyA+IDAgJiYgYiA+IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICB2YXIgZGlzY3IgPSBiICogYiAtIGM7XG4gICAgaWYgKGRpc2NyIDwgMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIgdCA9IE1hdGguYWJzKC1iIC0gTWF0aC5zcXJ0KGRpc2NyKSk7XG4gICAgaWYgKHBvaW50KSB7XG4gICAgICBwb2ludC5jb3B5KHJheS5kaXJlY3Rpb24pLnNjYWxlKHQpLmFkZChyYXkub3JpZ2luKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIGludGVyc2VjdHNCb3VuZGluZ1NwaGVyZTpmdW5jdGlvbihzcGhlcmUpIHtcbiAgICB0bXBWZWNBLnN1YjIoc3BoZXJlLmNlbnRlciwgdGhpcy5jZW50ZXIpO1xuICAgIHZhciB0b3RhbFJhZGl1cyA9IHNwaGVyZS5yYWRpdXMgKyB0aGlzLnJhZGl1cztcbiAgICBpZiAodG1wVmVjQS5sZW5ndGhTcSgpIDw9IHRvdGFsUmFkaXVzICogdG90YWxSYWRpdXMpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH19O1xuICByZXR1cm4ge0JvdW5kaW5nU3BoZXJlOkJvdW5kaW5nU3BoZXJlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgdmlld1Byb2ogPSBuZXcgcGMuTWF0NDtcbiAgdmFyIEZydXN0dW0gPSBmdW5jdGlvbiBGcnVzdHVtKHByb2plY3Rpb25NYXRyaXgsIHZpZXdNYXRyaXgpIHtcbiAgICBwcm9qZWN0aW9uTWF0cml4ID0gcHJvamVjdGlvbk1hdHJpeCB8fCAobmV3IHBjLk1hdDQpLnNldFBlcnNwZWN0aXZlKDkwLCAxNiAvIDksIDAuMSwgMTAwMCk7XG4gICAgdmlld01hdHJpeCA9IHZpZXdNYXRyaXggfHwgbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5wbGFuZXMgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgNjtpKyspIHtcbiAgICAgIHRoaXMucGxhbmVzW2ldID0gW107XG4gICAgfVxuICAgIHRoaXMudXBkYXRlKHByb2plY3Rpb25NYXRyaXgsIHZpZXdNYXRyaXgpO1xuICB9O1xuICBGcnVzdHVtLnByb3RvdHlwZSA9IHt1cGRhdGU6ZnVuY3Rpb24ocHJvamVjdGlvbk1hdHJpeCwgdmlld01hdHJpeCkge1xuICAgIHZpZXdQcm9qLm11bDIocHJvamVjdGlvbk1hdHJpeCwgdmlld01hdHJpeCk7XG4gICAgdmFyIHZwbSA9IHZpZXdQcm9qLmRhdGE7XG4gICAgdGhpcy5wbGFuZXNbMF1bMF0gPSB2cG1bM10gLSB2cG1bMF07XG4gICAgdGhpcy5wbGFuZXNbMF1bMV0gPSB2cG1bN10gLSB2cG1bNF07XG4gICAgdGhpcy5wbGFuZXNbMF1bMl0gPSB2cG1bMTFdIC0gdnBtWzhdO1xuICAgIHRoaXMucGxhbmVzWzBdWzNdID0gdnBtWzE1XSAtIHZwbVsxMl07XG4gICAgdmFyIHQgPSBNYXRoLnNxcnQodGhpcy5wbGFuZXNbMF1bMF0gKiB0aGlzLnBsYW5lc1swXVswXSArIHRoaXMucGxhbmVzWzBdWzFdICogdGhpcy5wbGFuZXNbMF1bMV0gKyB0aGlzLnBsYW5lc1swXVsyXSAqIHRoaXMucGxhbmVzWzBdWzJdKTtcbiAgICB0aGlzLnBsYW5lc1swXVswXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzBdWzFdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbMF1bMl0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1swXVszXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzFdWzBdID0gdnBtWzNdICsgdnBtWzBdO1xuICAgIHRoaXMucGxhbmVzWzFdWzFdID0gdnBtWzddICsgdnBtWzRdO1xuICAgIHRoaXMucGxhbmVzWzFdWzJdID0gdnBtWzExXSArIHZwbVs4XTtcbiAgICB0aGlzLnBsYW5lc1sxXVszXSA9IHZwbVsxNV0gKyB2cG1bMTJdO1xuICAgIHQgPSBNYXRoLnNxcnQodGhpcy5wbGFuZXNbMV1bMF0gKiB0aGlzLnBsYW5lc1sxXVswXSArIHRoaXMucGxhbmVzWzFdWzFdICogdGhpcy5wbGFuZXNbMV1bMV0gKyB0aGlzLnBsYW5lc1sxXVsyXSAqIHRoaXMucGxhbmVzWzFdWzJdKTtcbiAgICB0aGlzLnBsYW5lc1sxXVswXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzFdWzFdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbMV1bMl0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1sxXVszXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzJdWzBdID0gdnBtWzNdICsgdnBtWzFdO1xuICAgIHRoaXMucGxhbmVzWzJdWzFdID0gdnBtWzddICsgdnBtWzVdO1xuICAgIHRoaXMucGxhbmVzWzJdWzJdID0gdnBtWzExXSArIHZwbVs5XTtcbiAgICB0aGlzLnBsYW5lc1syXVszXSA9IHZwbVsxNV0gKyB2cG1bMTNdO1xuICAgIHQgPSBNYXRoLnNxcnQodGhpcy5wbGFuZXNbMl1bMF0gKiB0aGlzLnBsYW5lc1syXVswXSArIHRoaXMucGxhbmVzWzJdWzFdICogdGhpcy5wbGFuZXNbMl1bMV0gKyB0aGlzLnBsYW5lc1syXVsyXSAqIHRoaXMucGxhbmVzWzJdWzJdKTtcbiAgICB0aGlzLnBsYW5lc1syXVswXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzJdWzFdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbMl1bMl0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1syXVszXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzNdWzBdID0gdnBtWzNdIC0gdnBtWzFdO1xuICAgIHRoaXMucGxhbmVzWzNdWzFdID0gdnBtWzddIC0gdnBtWzVdO1xuICAgIHRoaXMucGxhbmVzWzNdWzJdID0gdnBtWzExXSAtIHZwbVs5XTtcbiAgICB0aGlzLnBsYW5lc1szXVszXSA9IHZwbVsxNV0gLSB2cG1bMTNdO1xuICAgIHQgPSBNYXRoLnNxcnQodGhpcy5wbGFuZXNbM11bMF0gKiB0aGlzLnBsYW5lc1szXVswXSArIHRoaXMucGxhbmVzWzNdWzFdICogdGhpcy5wbGFuZXNbM11bMV0gKyB0aGlzLnBsYW5lc1szXVsyXSAqIHRoaXMucGxhbmVzWzNdWzJdKTtcbiAgICB0aGlzLnBsYW5lc1szXVswXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzNdWzFdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbM11bMl0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1szXVszXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzRdWzBdID0gdnBtWzNdIC0gdnBtWzJdO1xuICAgIHRoaXMucGxhbmVzWzRdWzFdID0gdnBtWzddIC0gdnBtWzZdO1xuICAgIHRoaXMucGxhbmVzWzRdWzJdID0gdnBtWzExXSAtIHZwbVsxMF07XG4gICAgdGhpcy5wbGFuZXNbNF1bM10gPSB2cG1bMTVdIC0gdnBtWzE0XTtcbiAgICB0ID0gTWF0aC5zcXJ0KHRoaXMucGxhbmVzWzRdWzBdICogdGhpcy5wbGFuZXNbNF1bMF0gKyB0aGlzLnBsYW5lc1s0XVsxXSAqIHRoaXMucGxhbmVzWzRdWzFdICsgdGhpcy5wbGFuZXNbNF1bMl0gKiB0aGlzLnBsYW5lc1s0XVsyXSk7XG4gICAgdGhpcy5wbGFuZXNbNF1bMF0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1s0XVsxXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzRdWzJdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbNF1bM10gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1s1XVswXSA9IHZwbVszXSArIHZwbVsyXTtcbiAgICB0aGlzLnBsYW5lc1s1XVsxXSA9IHZwbVs3XSArIHZwbVs2XTtcbiAgICB0aGlzLnBsYW5lc1s1XVsyXSA9IHZwbVsxMV0gKyB2cG1bMTBdO1xuICAgIHRoaXMucGxhbmVzWzVdWzNdID0gdnBtWzE1XSArIHZwbVsxNF07XG4gICAgdCA9IE1hdGguc3FydCh0aGlzLnBsYW5lc1s1XVswXSAqIHRoaXMucGxhbmVzWzVdWzBdICsgdGhpcy5wbGFuZXNbNV1bMV0gKiB0aGlzLnBsYW5lc1s1XVsxXSArIHRoaXMucGxhbmVzWzVdWzJdICogdGhpcy5wbGFuZXNbNV1bMl0pO1xuICAgIHRoaXMucGxhbmVzWzVdWzBdIC89IHQ7XG4gICAgdGhpcy5wbGFuZXNbNV1bMV0gLz0gdDtcbiAgICB0aGlzLnBsYW5lc1s1XVsyXSAvPSB0O1xuICAgIHRoaXMucGxhbmVzWzVdWzNdIC89IHQ7XG4gIH0sIGNvbnRhaW5zUG9pbnQ6ZnVuY3Rpb24ocG9pbnQpIHtcbiAgICBmb3IgKHZhciBwID0gMDtwIDwgNjtwKyspIHtcbiAgICAgIGlmICh0aGlzLnBsYW5lc1twXVswXSAqIHBvaW50LnggKyB0aGlzLnBsYW5lc1twXVsxXSAqIHBvaW50LnkgKyB0aGlzLnBsYW5lc1twXVsyXSAqIHBvaW50LnogKyB0aGlzLnBsYW5lc1twXVszXSA8PSAwKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIGNvbnRhaW5zU3BoZXJlOmZ1bmN0aW9uKHNwaGVyZSkge1xuICAgIHZhciBjID0gMDtcbiAgICB2YXIgZDtcbiAgICB2YXIgcDtcbiAgICB2YXIgc3IgPSBzcGhlcmUucmFkaXVzO1xuICAgIHZhciBzYyA9IHNwaGVyZS5jZW50ZXIuZGF0YTtcbiAgICB2YXIgc2N4ID0gc2NbMF07XG4gICAgdmFyIHNjeSA9IHNjWzFdO1xuICAgIHZhciBzY3ogPSBzY1syXTtcbiAgICB2YXIgcGxhbmVzID0gdGhpcy5wbGFuZXM7XG4gICAgdmFyIHBsYW5lO1xuICAgIGZvciAocCA9IDA7cCA8IDY7cCsrKSB7XG4gICAgICBwbGFuZSA9IHBsYW5lc1twXTtcbiAgICAgIGQgPSBwbGFuZVswXSAqIHNjeCArIHBsYW5lWzFdICogc2N5ICsgcGxhbmVbMl0gKiBzY3ogKyBwbGFuZVszXTtcbiAgICAgIGlmIChkIDw9IC1zcikge1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cbiAgICAgIGlmIChkID4gc3IpIHtcbiAgICAgICAgYysrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYyA9PT0gNiA/IDIgOiAxO1xuICB9fTtcbiAgcmV0dXJuIHtGcnVzdHVtOkZydXN0dW19O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciB0bXBWZWNBID0gbmV3IHBjLlZlYzM7XG4gIHZhciBQbGFuZSA9IGZ1bmN0aW9uIFBsYW5lKHBvaW50LCBub3JtYWwpIHtcbiAgICB0aGlzLm5vcm1hbCA9IG5vcm1hbCB8fCBuZXcgcGMuVmVjMygwLCAwLCAxKTtcbiAgICB0aGlzLnBvaW50ID0gcG9pbnQgfHwgbmV3IHBjLlZlYzMoMCwgMCwgMCk7XG4gIH07XG4gIFBsYW5lLnByb3RvdHlwZSA9IHtpbnRlcnNlY3RzTGluZTpmdW5jdGlvbihzdGFydCwgZW5kLCBwb2ludCkge1xuICAgIHZhciBkID0gLXRoaXMubm9ybWFsLmRvdCh0aGlzLnBvaW50KTtcbiAgICB2YXIgZDAgPSB0aGlzLm5vcm1hbC5kb3Qoc3RhcnQpICsgZDtcbiAgICB2YXIgZDEgPSB0aGlzLm5vcm1hbC5kb3QoZW5kKSArIGQ7XG4gICAgdmFyIHQgPSBkMCAvIChkMCAtIGQxKTtcbiAgICB2YXIgaW50ZXJzZWN0cyA9IHQgPj0gMCAmJiB0IDw9IDE7XG4gICAgaWYgKGludGVyc2VjdHMgJiYgcG9pbnQpIHtcbiAgICAgIHBvaW50LmxlcnAoc3RhcnQsIGVuZCwgdCk7XG4gICAgfVxuICAgIHJldHVybiBpbnRlcnNlY3RzO1xuICB9LCBpbnRlcnNlY3RzUmF5OmZ1bmN0aW9uKHJheSwgcG9pbnQpIHtcbiAgICB2YXIgcG9pbnRUb09yaWdpbiA9IHRtcFZlY0Euc3ViMih0aGlzLnBvaW50LCByYXkub3JpZ2luKTtcbiAgICB2YXIgdCA9IHRoaXMubm9ybWFsLmRvdChwb2ludFRvT3JpZ2luKSAvIHRoaXMubm9ybWFsLmRvdChyYXkuZGlyZWN0aW9uKTtcbiAgICB2YXIgaW50ZXJzZWN0cyA9IHQgPj0gMDtcbiAgICBpZiAoaW50ZXJzZWN0cyAmJiBwb2ludCkge1xuICAgICAgcG9pbnQuY29weShyYXkuZGlyZWN0aW9uKS5zY2FsZSh0KS5hZGQocmF5Lm9yaWdpbik7XG4gICAgfVxuICAgIHJldHVybiBpbnRlcnNlY3RzO1xuICB9fTtcbiAgcmV0dXJuIHtQbGFuZTpQbGFuZX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFJheSA9IGZ1bmN0aW9uIFJheShvcmlnaW4sIGRpcmVjdGlvbikge1xuICAgIHRoaXMub3JpZ2luID0gb3JpZ2luIHx8IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMuZGlyZWN0aW9uID0gZGlyZWN0aW9uIHx8IG5ldyBwYy5WZWMzKDAsIDAsIC0xKTtcbiAgfTtcbiAgcmV0dXJuIHtSYXk6UmF5fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgdG1wUmF5ID0gbmV3IHBjLlJheTtcbiAgdmFyIHRtcFZlYzMgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHRtcFNwaGVyZSA9IG5ldyBwYy5Cb3VuZGluZ1NwaGVyZTtcbiAgdmFyIHRtcE1hdDQgPSBuZXcgcGMuTWF0NDtcbiAgdmFyIE9yaWVudGVkQm94ID0gZnVuY3Rpb24gT3JpZW50ZWRCb3god29ybGRUcmFuc2Zvcm0sIGhhbGZFeHRlbnRzKSB7XG4gICAgdGhpcy5oYWxmRXh0ZW50cyA9IGhhbGZFeHRlbnRzIHx8IG5ldyBwYy5WZWMzKDAuNSwgMC41LCAwLjUpO1xuICAgIHdvcmxkVHJhbnNmb3JtID0gd29ybGRUcmFuc2Zvcm0gfHwgdG1wTWF0NC5zZXRJZGVudGl0eSgpO1xuICAgIHRoaXMuX21vZGVsVHJhbnNmb3JtID0gd29ybGRUcmFuc2Zvcm0uY2xvbmUoKS5pbnZlcnQoKTtcbiAgICB0aGlzLl9hYWJiID0gbmV3IHBjLkJvdW5kaW5nQm94KG5ldyBwYy5WZWMzLCB0aGlzLmhhbGZFeHRlbnRzKTtcbiAgfTtcbiAgT3JpZW50ZWRCb3gucHJvdG90eXBlID0ge2ludGVyc2VjdHNSYXk6ZnVuY3Rpb24ocmF5LCBwb2ludCkge1xuICAgIHRoaXMuX21vZGVsVHJhbnNmb3JtLnRyYW5zZm9ybVBvaW50KHJheS5vcmlnaW4sIHRtcFJheS5vcmlnaW4pO1xuICAgIHRoaXMuX21vZGVsVHJhbnNmb3JtLnRyYW5zZm9ybVZlY3RvcihyYXkuZGlyZWN0aW9uLCB0bXBSYXkuZGlyZWN0aW9uKTtcbiAgICBpZiAocG9pbnQpIHtcbiAgICAgIHZhciByZXN1bHQgPSB0aGlzLl9hYWJiLl9pbnRlcnNlY3RzUmF5KHRtcFJheSwgcG9pbnQpO1xuICAgICAgdG1wTWF0NC5jb3B5KHRoaXMuX21vZGVsVHJhbnNmb3JtKS5pbnZlcnQoKS50cmFuc2Zvcm1Qb2ludChwb2ludCwgcG9pbnQpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuX2FhYmIuX2Zhc3RJbnRlcnNlY3RzUmF5KHRtcFJheSk7XG4gICAgfVxuICB9LCBjb250YWluc1BvaW50OmZ1bmN0aW9uKHBvaW50KSB7XG4gICAgdGhpcy5fbW9kZWxUcmFuc2Zvcm0udHJhbnNmb3JtUG9pbnQocG9pbnQsIHRtcFZlYzMpO1xuICAgIHJldHVybiB0aGlzLl9hYWJiLmNvbnRhaW5zUG9pbnQodG1wVmVjMyk7XG4gIH0sIGludGVyc2VjdHNCb3VuZGluZ1NwaGVyZTpmdW5jdGlvbihzcGhlcmUpIHtcbiAgICB0aGlzLl9tb2RlbFRyYW5zZm9ybS50cmFuc2Zvcm1Qb2ludChzcGhlcmUuY2VudGVyLCB0bXBTcGhlcmUuY2VudGVyKTtcbiAgICB0bXBTcGhlcmUucmFkaXVzID0gc3BoZXJlLnJhZGl1cztcbiAgICBpZiAodGhpcy5fYWFiYi5pbnRlcnNlY3RzQm91bmRpbmdTcGhlcmUodG1wU3BoZXJlKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPcmllbnRlZEJveC5wcm90b3R5cGUsIFwid29ybGRUcmFuc2Zvcm1cIiwge3NldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX21vZGVsVHJhbnNmb3JtLmNvcHkodmFsdWUpLmludmVydCgpO1xuICB9fSk7XG4gIHJldHVybiB7T3JpZW50ZWRCb3g6T3JpZW50ZWRCb3h9O1xufSgpKTtcbihmdW5jdGlvbigpIHtcbiAgdmFyIGVudW1zID0ge0FERFJFU1NfUkVQRUFUOjAsIEFERFJFU1NfQ0xBTVBfVE9fRURHRToxLCBBRERSRVNTX01JUlJPUkVEX1JFUEVBVDoyLCBCTEVORE1PREVfWkVSTzowLCBCTEVORE1PREVfT05FOjEsIEJMRU5ETU9ERV9TUkNfQ09MT1I6MiwgQkxFTkRNT0RFX09ORV9NSU5VU19TUkNfQ09MT1I6MywgQkxFTkRNT0RFX0RTVF9DT0xPUjo0LCBCTEVORE1PREVfT05FX01JTlVTX0RTVF9DT0xPUjo1LCBCTEVORE1PREVfU1JDX0FMUEhBOjYsIEJMRU5ETU9ERV9TUkNfQUxQSEFfU0FUVVJBVEU6NywgQkxFTkRNT0RFX09ORV9NSU5VU19TUkNfQUxQSEE6OCwgQkxFTkRNT0RFX0RTVF9BTFBIQTo5LCBCTEVORE1PREVfT05FX01JTlVTX0RTVF9BTFBIQToxMCwgQkxFTkRFUVVBVElPTl9BREQ6MCwgQkxFTkRFUVVBVElPTl9TVUJUUkFDVDoxLCBCTEVOREVRVUFUSU9OX1JFVkVSU0VfU1VCVFJBQ1Q6MiwgQkxFTkRFUVVBVElPTl9NSU46MywgQkxFTkRFUVVBVElPTl9NQVg6NCwgQlVGRkVSX1NUQVRJQzowLFxuICBCVUZGRVJfRFlOQU1JQzoxLCBCVUZGRVJfU1RSRUFNOjIsIEJVRkZFUl9HUFVEWU5BTUlDOjMsIENMRUFSRkxBR19DT0xPUjoxLCBDTEVBUkZMQUdfREVQVEg6MiwgQ0xFQVJGTEFHX1NURU5DSUw6NCwgQ1VCRUZBQ0VfUE9TWDowLCBDVUJFRkFDRV9ORUdYOjEsIENVQkVGQUNFX1BPU1k6MiwgQ1VCRUZBQ0VfTkVHWTozLCBDVUJFRkFDRV9QT1NaOjQsIENVQkVGQUNFX05FR1o6NSwgQ1VMTEZBQ0VfTk9ORTowLCBDVUxMRkFDRV9CQUNLOjEsIENVTExGQUNFX0ZST05UOjIsIENVTExGQUNFX0ZST05UQU5EQkFDSzozLCBUWVBFX0lOVDg6MCwgVFlQRV9VSU5UODoxLCBUWVBFX0lOVDE2OjIsIFRZUEVfVUlOVDE2OjMsIFRZUEVfSU5UMzI6NCwgVFlQRV9VSU5UMzI6NSwgVFlQRV9GTE9BVDMyOjYsIEZJTFRFUl9ORUFSRVNUOjAsIEZJTFRFUl9MSU5FQVI6MSwgRklMVEVSX05FQVJFU1RfTUlQTUFQX05FQVJFU1Q6MiwgRklMVEVSX05FQVJFU1RfTUlQTUFQX0xJTkVBUjozLCBGSUxURVJfTElORUFSX01JUE1BUF9ORUFSRVNUOjQsXG4gIEZJTFRFUl9MSU5FQVJfTUlQTUFQX0xJTkVBUjo1LCBGVU5DX05FVkVSOjAsIEZVTkNfTEVTUzoxLCBGVU5DX0VRVUFMOjIsIEZVTkNfTEVTU0VRVUFMOjMsIEZVTkNfR1JFQVRFUjo0LCBGVU5DX05PVEVRVUFMOjUsIEZVTkNfR1JFQVRFUkVRVUFMOjYsIEZVTkNfQUxXQVlTOjcsIElOREVYRk9STUFUX1VJTlQ4OjAsIElOREVYRk9STUFUX1VJTlQxNjoxLCBJTkRFWEZPUk1BVF9VSU5UMzI6MiwgUElYRUxGT1JNQVRfQTg6MCwgUElYRUxGT1JNQVRfTDg6MSwgUElYRUxGT1JNQVRfTDhfQTg6MiwgUElYRUxGT1JNQVRfUjVfRzZfQjU6MywgUElYRUxGT1JNQVRfUjVfRzVfQjVfQTE6NCwgUElYRUxGT1JNQVRfUjRfRzRfQjRfQTQ6NSwgUElYRUxGT1JNQVRfUjhfRzhfQjg6NiwgUElYRUxGT1JNQVRfUjhfRzhfQjhfQTg6NywgUElYRUxGT1JNQVRfRFhUMTo4LCBQSVhFTEZPUk1BVF9EWFQzOjksIFBJWEVMRk9STUFUX0RYVDU6MTAsIFBJWEVMRk9STUFUX1JHQjE2RjoxMSwgUElYRUxGT1JNQVRfUkdCQTE2RjoxMixcbiAgUElYRUxGT1JNQVRfUkdCMzJGOjEzLCBQSVhFTEZPUk1BVF9SR0JBMzJGOjE0LCBQSVhFTEZPUk1BVF9SMzJGOjE1LCBQSVhFTEZPUk1BVF9ERVBUSDoxNiwgUElYRUxGT1JNQVRfREVQVEhTVEVOQ0lMOjE3LCBQSVhFTEZPUk1BVF8xMTExMTBGOjE4LCBQSVhFTEZPUk1BVF9TUkdCOjE5LCBQSVhFTEZPUk1BVF9TUkdCQToyMCwgUElYRUxGT1JNQVRfRVRDMToyMSwgUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JfMToyMiwgUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JBXzE6MjMsIFBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCXzE6MjQsIFBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCQV8xOjI1LCBQUklNSVRJVkVfUE9JTlRTOjAsIFBSSU1JVElWRV9MSU5FUzoxLCBQUklNSVRJVkVfTElORUxPT1A6MiwgUFJJTUlUSVZFX0xJTkVTVFJJUDozLCBQUklNSVRJVkVfVFJJQU5HTEVTOjQsIFBSSU1JVElWRV9UUklTVFJJUDo1LCBQUklNSVRJVkVfVFJJRkFOOjYsIFNFTUFOVElDX1BPU0lUSU9OOlwiUE9TSVRJT05cIixcbiAgU0VNQU5USUNfTk9STUFMOlwiTk9STUFMXCIsIFNFTUFOVElDX1RBTkdFTlQ6XCJUQU5HRU5UXCIsIFNFTUFOVElDX0JMRU5EV0VJR0hUOlwiQkxFTkRXRUlHSFRcIiwgU0VNQU5USUNfQkxFTkRJTkRJQ0VTOlwiQkxFTkRJTkRJQ0VTXCIsIFNFTUFOVElDX0NPTE9SOlwiQ09MT1JcIiwgU0VNQU5USUNfVEVYQ09PUkQwOlwiVEVYQ09PUkQwXCIsIFNFTUFOVElDX1RFWENPT1JEMTpcIlRFWENPT1JEMVwiLCBTRU1BTlRJQ19URVhDT09SRDI6XCJURVhDT09SRDJcIiwgU0VNQU5USUNfVEVYQ09PUkQzOlwiVEVYQ09PUkQzXCIsIFNFTUFOVElDX1RFWENPT1JENDpcIlRFWENPT1JENFwiLCBTRU1BTlRJQ19URVhDT09SRDU6XCJURVhDT09SRDVcIiwgU0VNQU5USUNfVEVYQ09PUkQ2OlwiVEVYQ09PUkQ2XCIsIFNFTUFOVElDX1RFWENPT1JENzpcIlRFWENPT1JEN1wiLCBTRU1BTlRJQ19BVFRSMDpcIkFUVFIwXCIsIFNFTUFOVElDX0FUVFIxOlwiQVRUUjFcIiwgU0VNQU5USUNfQVRUUjI6XCJBVFRSMlwiLCBTRU1BTlRJQ19BVFRSMzpcIkFUVFIzXCIsXG4gIFNFTUFOVElDX0FUVFI0OlwiQVRUUjRcIiwgU0VNQU5USUNfQVRUUjU6XCJBVFRSNVwiLCBTRU1BTlRJQ19BVFRSNjpcIkFUVFI2XCIsIFNFTUFOVElDX0FUVFI3OlwiQVRUUjdcIiwgU0VNQU5USUNfQVRUUjg6XCJBVFRSOFwiLCBTRU1BTlRJQ19BVFRSOTpcIkFUVFI5XCIsIFNFTUFOVElDX0FUVFIxMDpcIkFUVFIxMFwiLCBTRU1BTlRJQ19BVFRSMTE6XCJBVFRSMTFcIiwgU0VNQU5USUNfQVRUUjEyOlwiQVRUUjEyXCIsIFNFTUFOVElDX0FUVFIxMzpcIkFUVFIxM1wiLCBTRU1BTlRJQ19BVFRSMTQ6XCJBVFRSMTRcIiwgU0VNQU5USUNfQVRUUjE1OlwiQVRUUjE1XCIsIFNIQURFUlRBR19NQVRFUklBTDoxLCBTVEVOQ0lMT1BfS0VFUDowLCBTVEVOQ0lMT1BfWkVSTzoxLCBTVEVOQ0lMT1BfUkVQTEFDRToyLCBTVEVOQ0lMT1BfSU5DUkVNRU5UOjMsIFNURU5DSUxPUF9JTkNSRU1FTlRXUkFQOjQsIFNURU5DSUxPUF9ERUNSRU1FTlQ6NSwgU1RFTkNJTE9QX0RFQ1JFTUVOVFdSQVA6NiwgU1RFTkNJTE9QX0lOVkVSVDo3LFxuICBURVhUVVJFTE9DS19SRUFEOjEsIFRFWFRVUkVMT0NLX1dSSVRFOjIsIFRFWEhJTlRfTk9ORTowLCBURVhISU5UX1NIQURPV01BUDoxLCBURVhISU5UX0FTU0VUOjIsIFRFWEhJTlRfTElHSFRNQVA6MywgVU5JRk9STVRZUEVfQk9PTDowLCBVTklGT1JNVFlQRV9JTlQ6MSwgVU5JRk9STVRZUEVfRkxPQVQ6MiwgVU5JRk9STVRZUEVfVkVDMjozLCBVTklGT1JNVFlQRV9WRUMzOjQsIFVOSUZPUk1UWVBFX1ZFQzQ6NSwgVU5JRk9STVRZUEVfSVZFQzI6NiwgVU5JRk9STVRZUEVfSVZFQzM6NywgVU5JRk9STVRZUEVfSVZFQzQ6OCwgVU5JRk9STVRZUEVfQlZFQzI6OSwgVU5JRk9STVRZUEVfQlZFQzM6MTAsIFVOSUZPUk1UWVBFX0JWRUM0OjExLCBVTklGT1JNVFlQRV9NQVQyOjEyLCBVTklGT1JNVFlQRV9NQVQzOjEzLCBVTklGT1JNVFlQRV9NQVQ0OjE0LCBVTklGT1JNVFlQRV9URVhUVVJFMkQ6MTUsIFVOSUZPUk1UWVBFX1RFWFRVUkVDVUJFOjE2LCBVTklGT1JNVFlQRV9GTE9BVEFSUkFZOjE3LFxuICBVTklGT1JNVFlQRV9URVhUVVJFMkRfU0hBRE9XOjE4LCBVTklGT1JNVFlQRV9URVhUVVJFQ1VCRV9TSEFET1c6MTksIFVOSUZPUk1UWVBFX1RFWFRVUkUzRDoyMH07XG4gIHBjLmV4dGVuZChwYywgZW51bXMpO1xuICBwYy5nZnggPSB7fTtcbiAgcGMuZXh0ZW5kKHBjLmdmeCwgZW51bXMpO1xufSkoKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBTY29wZUlkID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy52YWx1ZSA9IG51bGw7XG4gICAgdGhpcy52ZXJzaW9uT2JqZWN0ID0gbmV3IHBjLlZlcnNpb25lZE9iamVjdDtcbiAgfTtcbiAgU2NvcGVJZC5wcm90b3R5cGUgPSB7c2V0VmFsdWU6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgdGhpcy52ZXJzaW9uT2JqZWN0LmluY3JlbWVudCgpO1xuICB9LCBnZXRWYWx1ZTpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHJldHVybiB0aGlzLnZhbHVlO1xuICB9fTtcbiAgcmV0dXJuIHtTY29wZUlkOlNjb3BlSWR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBTY29wZVNwYWNlID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy52YXJpYWJsZXMgPSB7fTtcbiAgICB0aGlzLm5hbWVzcGFjZXMgPSB7fTtcbiAgfTtcbiAgU2NvcGVTcGFjZS5wcm90b3R5cGUgPSB7cmVzb2x2ZTpmdW5jdGlvbihuYW1lKSB7XG4gICAgaWYgKHRoaXMudmFyaWFibGVzLmhhc093blByb3BlcnR5KG5hbWUpID09PSBmYWxzZSkge1xuICAgICAgdGhpcy52YXJpYWJsZXNbbmFtZV0gPSBuZXcgcGMuU2NvcGVJZChuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmFyaWFibGVzW25hbWVdO1xuICB9LCBnZXRTdWJTcGFjZTpmdW5jdGlvbihuYW1lKSB7XG4gICAgaWYgKHRoaXMubmFtZXNwYWNlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMubmFtZXNwYWNlc1tuYW1lXSA9IG5ldyBwYy5TY29wZVNwYWNlKG5hbWUpO1xuICAgICAgbG9nREVCVUcoXCJBZGRlZCBTY29wZVNwYWNlOiBcIiArIG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VzW25hbWVdO1xuICB9fTtcbiAgcmV0dXJuIHtTY29wZVNwYWNlOlNjb3BlU3BhY2V9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBWZXJzaW9uID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5nbG9iYWxJZCA9IDA7XG4gICAgdGhpcy5yZXZpc2lvbiA9IDA7XG4gIH07XG4gIFZlcnNpb24ucHJvdG90eXBlID0ge2VxdWFsczpmdW5jdGlvbihvdGhlcikge1xuICAgIHJldHVybiB0aGlzLmdsb2JhbElkID09PSBvdGhlci5nbG9iYWxJZCAmJiB0aGlzLnJldmlzaW9uID09PSBvdGhlci5yZXZpc2lvbjtcbiAgfSwgbm90ZXF1YWxzOmZ1bmN0aW9uKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2xvYmFsSWQgIT09IG90aGVyLmdsb2JhbElkIHx8IHRoaXMucmV2aXNpb24gIT09IG90aGVyLnJldmlzaW9uO1xuICB9LCBjb3B5OmZ1bmN0aW9uKG90aGVyKSB7XG4gICAgdGhpcy5nbG9iYWxJZCA9IG90aGVyLmdsb2JhbElkO1xuICAgIHRoaXMucmV2aXNpb24gPSBvdGhlci5yZXZpc2lvbjtcbiAgfSwgcmVzZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5nbG9iYWxJZCA9IDA7XG4gICAgdGhpcy5yZXZpc2lvbiA9IDA7XG4gIH19O1xuICByZXR1cm4ge1ZlcnNpb246VmVyc2lvbn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIGlkQ291bnRlciA9IDA7XG4gIHZhciBWZXJzaW9uZWRPYmplY3QgPSBmdW5jdGlvbigpIHtcbiAgICBpZENvdW50ZXIrKztcbiAgICB0aGlzLnZlcnNpb24gPSBuZXcgcGMuVmVyc2lvbjtcbiAgICB0aGlzLnZlcnNpb24uZ2xvYmFsSWQgPSBpZENvdW50ZXI7XG4gIH07XG4gIFZlcnNpb25lZE9iamVjdC5wcm90b3R5cGUgPSB7aW5jcmVtZW50OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMudmVyc2lvbi5yZXZpc2lvbisrO1xuICB9fTtcbiAgcmV0dXJuIHtWZXJzaW9uZWRPYmplY3Q6VmVyc2lvbmVkT2JqZWN0fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICBmdW5jdGlvbiBWZXJ0ZXhJdGVyYXRvclNldHRlcihidWZmZXIsIHZlcnRleEVsZW1lbnQpIHtcbiAgICB0aGlzLmluZGV4ID0gMDtcbiAgICBzd2l0Y2godmVydGV4RWxlbWVudC5kYXRhVHlwZSkge1xuICAgICAgY2FzZSBwYy5UWVBFX0lOVDg6XG4gICAgICAgIHRoaXMuYXJyYXkgPSBuZXcgSW50OEFycmF5KGJ1ZmZlciwgdmVydGV4RWxlbWVudC5vZmZzZXQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuVFlQRV9VSU5UODpcbiAgICAgICAgdGhpcy5hcnJheSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgdmVydGV4RWxlbWVudC5vZmZzZXQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuVFlQRV9JTlQxNjpcbiAgICAgICAgdGhpcy5hcnJheSA9IG5ldyBJbnQxNkFycmF5KGJ1ZmZlciwgdmVydGV4RWxlbWVudC5vZmZzZXQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuVFlQRV9VSU5UMTY6XG4gICAgICAgIHRoaXMuYXJyYXkgPSBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCB2ZXJ0ZXhFbGVtZW50Lm9mZnNldCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5UWVBFX0lOVDMyOlxuICAgICAgICB0aGlzLmFycmF5ID0gbmV3IEludDMyQXJyYXkoYnVmZmVyLCB2ZXJ0ZXhFbGVtZW50Lm9mZnNldCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5UWVBFX1VJTlQzMjpcbiAgICAgICAgdGhpcy5hcnJheSA9IG5ldyBVaW50MzJBcnJheShidWZmZXIsIHZlcnRleEVsZW1lbnQub2Zmc2V0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlRZUEVfRkxPQVQzMjpcbiAgICAgICAgdGhpcy5hcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCB2ZXJ0ZXhFbGVtZW50Lm9mZnNldCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBzd2l0Y2godmVydGV4RWxlbWVudC5udW1Db21wb25lbnRzKSB7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIHRoaXMuc2V0ID0gVmVydGV4SXRlcmF0b3JTZXR0ZXJfc2V0MTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIHRoaXMuc2V0ID0gVmVydGV4SXRlcmF0b3JTZXR0ZXJfc2V0MjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDM6XG4gICAgICAgIHRoaXMuc2V0ID0gVmVydGV4SXRlcmF0b3JTZXR0ZXJfc2V0MztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDQ6XG4gICAgICAgIHRoaXMuc2V0ID0gVmVydGV4SXRlcmF0b3JTZXR0ZXJfc2V0NDtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIFZlcnRleEl0ZXJhdG9yU2V0dGVyX3NldDEoYSkge1xuICAgIHRoaXMuYXJyYXlbdGhpcy5pbmRleF0gPSBhO1xuICB9XG4gIGZ1bmN0aW9uIFZlcnRleEl0ZXJhdG9yU2V0dGVyX3NldDIoYSwgYikge1xuICAgIHRoaXMuYXJyYXlbdGhpcy5pbmRleF0gPSBhO1xuICAgIHRoaXMuYXJyYXlbdGhpcy5pbmRleCArIDFdID0gYjtcbiAgfVxuICBmdW5jdGlvbiBWZXJ0ZXhJdGVyYXRvclNldHRlcl9zZXQzKGEsIGIsIGMpIHtcbiAgICB0aGlzLmFycmF5W3RoaXMuaW5kZXhdID0gYTtcbiAgICB0aGlzLmFycmF5W3RoaXMuaW5kZXggKyAxXSA9IGI7XG4gICAgdGhpcy5hcnJheVt0aGlzLmluZGV4ICsgMl0gPSBjO1xuICB9XG4gIGZ1bmN0aW9uIFZlcnRleEl0ZXJhdG9yU2V0dGVyX3NldDQoYSwgYiwgYywgZCkge1xuICAgIHRoaXMuYXJyYXlbdGhpcy5pbmRleF0gPSBhO1xuICAgIHRoaXMuYXJyYXlbdGhpcy5pbmRleCArIDFdID0gYjtcbiAgICB0aGlzLmFycmF5W3RoaXMuaW5kZXggKyAyXSA9IGM7XG4gICAgdGhpcy5hcnJheVt0aGlzLmluZGV4ICsgM10gPSBkO1xuICB9XG4gIGZ1bmN0aW9uIFZlcnRleEl0ZXJhdG9yKHZlcnRleEJ1ZmZlcikge1xuICAgIHRoaXMudmVydGV4QnVmZmVyID0gdmVydGV4QnVmZmVyO1xuICAgIHRoaXMuYnVmZmVyID0gdGhpcy52ZXJ0ZXhCdWZmZXIubG9jaygpO1xuICAgIHRoaXMuc2V0dGVycyA9IFtdO1xuICAgIHRoaXMuZWxlbWVudCA9IHt9O1xuICAgIHZhciB2ZXJ0ZXhGb3JtYXQgPSB0aGlzLnZlcnRleEJ1ZmZlci5nZXRGb3JtYXQoKTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdmVydGV4Rm9ybWF0LmVsZW1lbnRzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciB2ZXJ0ZXhFbGVtZW50ID0gdmVydGV4Rm9ybWF0LmVsZW1lbnRzW2ldO1xuICAgICAgdGhpcy5zZXR0ZXJzW2ldID0gbmV3IFZlcnRleEl0ZXJhdG9yU2V0dGVyKHRoaXMuYnVmZmVyLCB2ZXJ0ZXhFbGVtZW50KTtcbiAgICAgIHRoaXMuZWxlbWVudFt2ZXJ0ZXhFbGVtZW50Lm5hbWVdID0gdGhpcy5zZXR0ZXJzW2ldO1xuICAgIH1cbiAgfVxuICBWZXJ0ZXhJdGVyYXRvci5wcm90b3R5cGUgPSB7bmV4dDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaSA9IDA7XG4gICAgdmFyIHNldHRlcnMgPSB0aGlzLnNldHRlcnM7XG4gICAgdmFyIG51bVNldHRlcnMgPSB0aGlzLnNldHRlcnMubGVuZ3RoO1xuICAgIHZhciB2ZXJ0ZXhGb3JtYXQgPSB0aGlzLnZlcnRleEJ1ZmZlci5nZXRGb3JtYXQoKTtcbiAgICB3aGlsZSAoaSA8IG51bVNldHRlcnMpIHtcbiAgICAgIHZhciBzZXR0ZXIgPSBzZXR0ZXJzW2krK107XG4gICAgICBzZXR0ZXIuaW5kZXggKz0gdmVydGV4Rm9ybWF0LnNpemUgLyBzZXR0ZXIuYXJyYXkuY29uc3RydWN0b3IuQllURVNfUEVSX0VMRU1FTlQ7XG4gICAgfVxuICB9LCBlbmQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy52ZXJ0ZXhCdWZmZXIudW5sb2NrKCk7XG4gIH19O1xuICByZXR1cm4ge1ZlcnRleEl0ZXJhdG9yOlZlcnRleEl0ZXJhdG9yfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3R5cGVTaXplID0gW107XG4gIF90eXBlU2l6ZVtwYy5UWVBFX0lOVDhdID0gMTtcbiAgX3R5cGVTaXplW3BjLlRZUEVfVUlOVDhdID0gMTtcbiAgX3R5cGVTaXplW3BjLlRZUEVfSU5UMTZdID0gMjtcbiAgX3R5cGVTaXplW3BjLlRZUEVfVUlOVDE2XSA9IDI7XG4gIF90eXBlU2l6ZVtwYy5UWVBFX0lOVDMyXSA9IDQ7XG4gIF90eXBlU2l6ZVtwYy5UWVBFX1VJTlQzMl0gPSA0O1xuICBfdHlwZVNpemVbcGMuVFlQRV9GTE9BVDMyXSA9IDQ7XG4gIHZhciBWZXJ0ZXhGb3JtYXQgPSBmdW5jdGlvbihncmFwaGljc0RldmljZSwgZGVzY3JpcHRpb24pIHtcbiAgICB2YXIgaSwgbGVuLCBlbGVtZW50O1xuICAgIHRoaXMuZWxlbWVudHMgPSBbXTtcbiAgICB0aGlzLmhhc1V2MCA9IGZhbHNlO1xuICAgIHRoaXMuaGFzVXYxID0gZmFsc2U7XG4gICAgdGhpcy5oYXNDb2xvciA9IGZhbHNlO1xuICAgIHRoaXMuc2l6ZSA9IDA7XG4gICAgZm9yIChpID0gMCwgbGVuID0gZGVzY3JpcHRpb24ubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgZWxlbWVudERlc2MgPSBkZXNjcmlwdGlvbltpXTtcbiAgICAgIGVsZW1lbnQgPSB7bmFtZTplbGVtZW50RGVzYy5zZW1hbnRpYywgb2Zmc2V0OjAsIHN0cmlkZTowLCBzdHJlYW06LTEsIHNjb3BlSWQ6Z3JhcGhpY3NEZXZpY2Uuc2NvcGUucmVzb2x2ZShlbGVtZW50RGVzYy5zZW1hbnRpYyksIGRhdGFUeXBlOmVsZW1lbnREZXNjLnR5cGUsIG51bUNvbXBvbmVudHM6ZWxlbWVudERlc2MuY29tcG9uZW50cywgbm9ybWFsaXplOmVsZW1lbnREZXNjLm5vcm1hbGl6ZSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBlbGVtZW50RGVzYy5ub3JtYWxpemUsIHNpemU6ZWxlbWVudERlc2MuY29tcG9uZW50cyAqIF90eXBlU2l6ZVtlbGVtZW50RGVzYy50eXBlXX07XG4gICAgICB0aGlzLmVsZW1lbnRzLnB1c2goZWxlbWVudCk7XG4gICAgICB0aGlzLnNpemUgKz0gTWF0aC5jZWlsKGVsZW1lbnQuc2l6ZSAvIDQpICogNDtcbiAgICAgIGlmIChlbGVtZW50RGVzYy5zZW1hbnRpYyA9PT0gcGMuU0VNQU5USUNfVEVYQ09PUkQwKSB7XG4gICAgICAgIHRoaXMuaGFzVXYwID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChlbGVtZW50RGVzYy5zZW1hbnRpYyA9PT0gcGMuU0VNQU5USUNfVEVYQ09PUkQxKSB7XG4gICAgICAgICAgdGhpcy5oYXNVdjEgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChlbGVtZW50RGVzYy5zZW1hbnRpYyA9PT0gcGMuU0VNQU5USUNfQ09MT1IpIHtcbiAgICAgICAgICAgIHRoaXMuaGFzQ29sb3IgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB2YXIgb2Zmc2V0ID0gMDtcbiAgICBmb3IgKGkgPSAwLCBsZW4gPSB0aGlzLmVsZW1lbnRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgZWxlbWVudCA9IHRoaXMuZWxlbWVudHNbaV07XG4gICAgICBlbGVtZW50Lm9mZnNldCA9IG9mZnNldDtcbiAgICAgIGVsZW1lbnQuc3RyaWRlID0gdGhpcy5zaXplO1xuICAgICAgb2Zmc2V0ICs9IGVsZW1lbnQuc2l6ZTtcbiAgICB9XG4gIH07XG4gIHJldHVybiB7VmVydGV4Rm9ybWF0OlZlcnRleEZvcm1hdH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFZlcnRleEJ1ZmZlciA9IGZ1bmN0aW9uKGdyYXBoaWNzRGV2aWNlLCBmb3JtYXQsIG51bVZlcnRpY2VzLCB1c2FnZSwgaW5pdGlhbERhdGEpIHtcbiAgICB0aGlzLnVzYWdlID0gdXNhZ2UgfHwgcGMuQlVGRkVSX1NUQVRJQztcbiAgICB0aGlzLmZvcm1hdCA9IGZvcm1hdDtcbiAgICB0aGlzLm51bVZlcnRpY2VzID0gbnVtVmVydGljZXM7XG4gICAgdGhpcy5udW1CeXRlcyA9IGZvcm1hdC5zaXplICogbnVtVmVydGljZXM7XG4gICAgZ3JhcGhpY3NEZXZpY2UuX3ZyYW0udmIgKz0gdGhpcy5udW1CeXRlcztcbiAgICB0aGlzLmRldmljZSA9IGdyYXBoaWNzRGV2aWNlO1xuICAgIHZhciBnbCA9IHRoaXMuZGV2aWNlLmdsO1xuICAgIHRoaXMuYnVmZmVySWQgPSBnbC5jcmVhdGVCdWZmZXIoKTtcbiAgICBpZiAoaW5pdGlhbERhdGEgJiYgdGhpcy5zZXREYXRhKGluaXRpYWxEYXRhKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0b3JhZ2UgPSBuZXcgQXJyYXlCdWZmZXIodGhpcy5udW1CeXRlcyk7XG4gICAgfVxuICB9O1xuICBWZXJ0ZXhCdWZmZXIucHJvdG90eXBlID0ge2Rlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmJ1ZmZlcklkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBkZXZpY2UgPSB0aGlzLmRldmljZTtcbiAgICB2YXIgZ2wgPSBkZXZpY2UuZ2w7XG4gICAgZ2wuZGVsZXRlQnVmZmVyKHRoaXMuYnVmZmVySWQpO1xuICAgIGRldmljZS5fdnJhbS52YiAtPSB0aGlzLnN0b3JhZ2UuYnl0ZUxlbmd0aDtcbiAgICB0aGlzLmJ1ZmZlcklkID0gbnVsbDtcbiAgICBkZXZpY2UuYm91bmRCdWZmZXIgPSBudWxsO1xuICAgIGRldmljZS52ZXJ0ZXhCdWZmZXJzLmxlbmd0aCA9IDA7XG4gICAgZGV2aWNlLnZiT2Zmc2V0cy5sZW5ndGggPSAwO1xuICAgIGRldmljZS5hdHRyaWJ1dGVzSW52YWxpZGF0ZWQgPSB0cnVlO1xuICAgIGZvciAodmFyIGxvYyBpbiBkZXZpY2UuZW5hYmxlZEF0dHJpYnV0ZXMpIHtcbiAgICAgIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShsb2MpO1xuICAgIH1cbiAgICBkZXZpY2UuZW5hYmxlZEF0dHJpYnV0ZXMgPSB7fTtcbiAgfSwgZ2V0Rm9ybWF0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm1hdDtcbiAgfSwgZ2V0VXNhZ2U6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMudXNhZ2U7XG4gIH0sIGdldE51bVZlcnRpY2VzOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLm51bVZlcnRpY2VzO1xuICB9LCBsb2NrOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JhZ2U7XG4gIH0sIHVubG9jazpmdW5jdGlvbigpIHtcbiAgICB2YXIgZ2wgPSB0aGlzLmRldmljZS5nbDtcbiAgICB2YXIgZ2xVc2FnZTtcbiAgICBzd2l0Y2godGhpcy51c2FnZSkge1xuICAgICAgY2FzZSBwYy5CVUZGRVJfU1RBVElDOlxuICAgICAgICBnbFVzYWdlID0gZ2wuU1RBVElDX0RSQVc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5CVUZGRVJfRFlOQU1JQzpcbiAgICAgICAgZ2xVc2FnZSA9IGdsLkRZTkFNSUNfRFJBVztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLkJVRkZFUl9TVFJFQU06XG4gICAgICAgIGdsVXNhZ2UgPSBnbC5TVFJFQU1fRFJBVztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLkJVRkZFUl9HUFVEWU5BTUlDOlxuICAgICAgICBpZiAodGhpcy5kZXZpY2Uud2ViZ2wyKSB7XG4gICAgICAgICAgZ2xVc2FnZSA9IGdsLkRZTkFNSUNfQ09QWTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBnbFVzYWdlID0gZ2wuU1RBVElDX0RSQVc7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmJ1ZmZlcklkKTtcbiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy5zdG9yYWdlLCBnbFVzYWdlKTtcbiAgfSwgc2V0RGF0YTpmdW5jdGlvbihkYXRhKSB7XG4gICAgaWYgKGRhdGEuYnl0ZUxlbmd0aCAhPT0gdGhpcy5udW1CeXRlcykge1xuICAgICAgY29uc29sZS5lcnJvcihcIlZlcnRleEJ1ZmZlcjogd3JvbmcgaW5pdGlhbCBkYXRhIHNpemU6IGV4cGVjdGVkIFwiICsgdGhpcy5udW1CeXRlcyArIFwiLCBnb3QgXCIgKyBkYXRhLmJ5dGVMZW5ndGgpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnN0b3JhZ2UgPSBkYXRhO1xuICAgIHRoaXMudW5sb2NrKCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH19O1xuICByZXR1cm4ge1ZlcnRleEJ1ZmZlcjpWZXJ0ZXhCdWZmZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBJbmRleEJ1ZmZlciA9IGZ1bmN0aW9uKGdyYXBoaWNzRGV2aWNlLCBmb3JtYXQsIG51bUluZGljZXMsIHVzYWdlLCBpbml0aWFsRGF0YSkge1xuICAgIHRoaXMudXNhZ2UgPSB1c2FnZSB8fCBwYy5CVUZGRVJfU1RBVElDO1xuICAgIHRoaXMuZm9ybWF0ID0gZm9ybWF0O1xuICAgIHRoaXMubnVtSW5kaWNlcyA9IG51bUluZGljZXM7XG4gICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICB2YXIgZ2wgPSB0aGlzLmRldmljZS5nbDtcbiAgICB0aGlzLmJ1ZmZlcklkID0gZ2wuY3JlYXRlQnVmZmVyKCk7XG4gICAgdmFyIGJ5dGVzUGVySW5kZXg7XG4gICAgaWYgKGZvcm1hdCA9PT0gcGMuSU5ERVhGT1JNQVRfVUlOVDgpIHtcbiAgICAgIGJ5dGVzUGVySW5kZXggPSAxO1xuICAgICAgdGhpcy5nbEZvcm1hdCA9IGdsLlVOU0lHTkVEX0JZVEU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChmb3JtYXQgPT09IHBjLklOREVYRk9STUFUX1VJTlQxNikge1xuICAgICAgICBieXRlc1BlckluZGV4ID0gMjtcbiAgICAgICAgdGhpcy5nbEZvcm1hdCA9IGdsLlVOU0lHTkVEX1NIT1JUO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGZvcm1hdCA9PT0gcGMuSU5ERVhGT1JNQVRfVUlOVDMyKSB7XG4gICAgICAgICAgYnl0ZXNQZXJJbmRleCA9IDQ7XG4gICAgICAgICAgdGhpcy5nbEZvcm1hdCA9IGdsLlVOU0lHTkVEX0lOVDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmJ5dGVzUGVySW5kZXggPSBieXRlc1BlckluZGV4O1xuICAgIHRoaXMubnVtQnl0ZXMgPSB0aGlzLm51bUluZGljZXMgKiBieXRlc1BlckluZGV4O1xuICAgIGlmIChpbml0aWFsRGF0YSAmJiB0aGlzLnNldERhdGEoaW5pdGlhbERhdGEpKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBBcnJheUJ1ZmZlcih0aGlzLm51bUJ5dGVzKTtcbiAgICB9XG4gICAgZ3JhcGhpY3NEZXZpY2UuX3ZyYW0uaWIgKz0gdGhpcy5udW1CeXRlcztcbiAgfTtcbiAgSW5kZXhCdWZmZXIucHJvdG90eXBlID0ge2Rlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmJ1ZmZlcklkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBnbCA9IHRoaXMuZGV2aWNlLmdsO1xuICAgIGdsLmRlbGV0ZUJ1ZmZlcih0aGlzLmJ1ZmZlcklkKTtcbiAgICB0aGlzLmRldmljZS5fdnJhbS5pYiAtPSB0aGlzLnN0b3JhZ2UuYnl0ZUxlbmd0aDtcbiAgICB0aGlzLmJ1ZmZlcklkID0gbnVsbDtcbiAgICBpZiAodGhpcy5kZXZpY2UuaW5kZXhCdWZmZXIgPT09IHRoaXMpIHtcbiAgICAgIHRoaXMuZGV2aWNlLmluZGV4QnVmZmVyID0gbnVsbDtcbiAgICB9XG4gIH0sIGdldEZvcm1hdDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtYXQ7XG4gIH0sIGdldE51bUluZGljZXM6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubnVtSW5kaWNlcztcbiAgfSwgbG9jazpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlO1xuICB9LCB1bmxvY2s6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGdsID0gdGhpcy5kZXZpY2UuZ2w7XG4gICAgdmFyIGdsVXNhZ2U7XG4gICAgc3dpdGNoKHRoaXMudXNhZ2UpIHtcbiAgICAgIGNhc2UgcGMuQlVGRkVSX1NUQVRJQzpcbiAgICAgICAgZ2xVc2FnZSA9IGdsLlNUQVRJQ19EUkFXO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuQlVGRkVSX0RZTkFNSUM6XG4gICAgICAgIGdsVXNhZ2UgPSBnbC5EWU5BTUlDX0RSQVc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5CVUZGRVJfU1RSRUFNOlxuICAgICAgICBnbFVzYWdlID0gZ2wuU1RSRUFNX0RSQVc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5CVUZGRVJfR1BVRFlOQU1JQzpcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlLndlYmdsMikge1xuICAgICAgICAgIGdsVXNhZ2UgPSBnbC5EWU5BTUlDX0NPUFk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ2xVc2FnZSA9IGdsLlNUQVRJQ19EUkFXO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmJ1ZmZlcklkKTtcbiAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLnN0b3JhZ2UsIGdsVXNhZ2UpO1xuICB9LCBzZXREYXRhOmZ1bmN0aW9uKGRhdGEpIHtcbiAgICBpZiAoZGF0YS5ieXRlTGVuZ3RoICE9PSB0aGlzLm51bUJ5dGVzKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiSW5kZXhCdWZmZXI6IHdyb25nIGluaXRpYWwgZGF0YSBzaXplOiBleHBlY3RlZCBcIiArIHRoaXMubnVtQnl0ZXMgKyBcIiwgZ290IFwiICsgZGF0YS5ieXRlTGVuZ3RoKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5zdG9yYWdlID0gZGF0YTtcbiAgICB0aGlzLnVubG9jaygpO1xuICAgIHJldHVybiB0cnVlO1xuICB9fTtcbiAgcmV0dXJuIHtJbmRleEJ1ZmZlcjpJbmRleEJ1ZmZlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFRyYW5zZm9ybUZlZWRiYWNrID0gZnVuY3Rpb24oaW5wdXRCdWZmZXIsIHVzYWdlKSB7XG4gICAgdXNhZ2UgPSB1c2FnZSB8fCBwYy5CVUZGRVJfR1BVRFlOQU1JQztcbiAgICB0aGlzLmRldmljZSA9IGlucHV0QnVmZmVyLmRldmljZTtcbiAgICB2YXIgZ2wgPSB0aGlzLmRldmljZS5nbDtcbiAgICB0aGlzLl9pbnB1dEJ1ZmZlciA9IGlucHV0QnVmZmVyO1xuICAgIGlmICh1c2FnZSA9PT0gcGMuQlVGRkVSX0dQVURZTkFNSUMgJiYgaW5wdXRCdWZmZXIudXNhZ2UgIT09IHVzYWdlKSB7XG4gICAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgaW5wdXRCdWZmZXIuYnVmZmVySWQpO1xuICAgICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIGlucHV0QnVmZmVyLnN0b3JhZ2UsIGdsLkRZTkFNSUNfQ09QWSk7XG4gICAgfVxuICAgIHRoaXMuX291dHB1dEJ1ZmZlciA9IG5ldyBwYy5WZXJ0ZXhCdWZmZXIoaW5wdXRCdWZmZXIuZGV2aWNlLCBpbnB1dEJ1ZmZlci5mb3JtYXQsIGlucHV0QnVmZmVyLm51bVZlcnRpY2VzLCB1c2FnZSwgaW5wdXRCdWZmZXIuc3RvcmFnZSk7XG4gIH07XG4gIFRyYW5zZm9ybUZlZWRiYWNrLmNyZWF0ZVNoYWRlciA9IGZ1bmN0aW9uKGRldmljZSwgdnNDb2RlLCBuYW1lKSB7XG4gICAgcmV0dXJuIHBjLnNoYWRlckNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIHZzQ29kZSwgbnVsbCwgbmFtZSwgdHJ1ZSk7XG4gIH07XG4gIFRyYW5zZm9ybUZlZWRiYWNrLnByb3RvdHlwZSA9IHtkZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX291dHB1dEJ1ZmZlci5kZXN0cm95KCk7XG4gIH0sIHByb2Nlc3M6ZnVuY3Rpb24oc2hhZGVyLCBzd2FwKSB7XG4gICAgaWYgKHN3YXAgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc3dhcCA9IHRydWU7XG4gICAgfVxuICAgIHZhciBkZXZpY2UgPSB0aGlzLmRldmljZTtcbiAgICBkZXZpY2Uuc2V0UmVuZGVyVGFyZ2V0KG51bGwpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICAgIGRldmljZS5zZXRWZXJ0ZXhCdWZmZXIodGhpcy5faW5wdXRCdWZmZXIsIDApO1xuICAgIGRldmljZS5zZXRSYXN0ZXIoZmFsc2UpO1xuICAgIGRldmljZS5zZXRUcmFuc2Zvcm1GZWVkYmFja0J1ZmZlcih0aGlzLl9vdXRwdXRCdWZmZXIpO1xuICAgIGRldmljZS5zZXRTaGFkZXIoc2hhZGVyKTtcbiAgICBkZXZpY2UuZHJhdyh7dHlwZTpwYy5QUklNSVRJVkVfUE9JTlRTLCBiYXNlOjAsIGNvdW50OnRoaXMuX2lucHV0QnVmZmVyLm51bVZlcnRpY2VzLCBpbmRleGVkOmZhbHNlfSk7XG4gICAgZGV2aWNlLnNldFRyYW5zZm9ybUZlZWRiYWNrQnVmZmVyKG51bGwpO1xuICAgIGRldmljZS5zZXRSYXN0ZXIodHJ1ZSk7XG4gICAgZGV2aWNlLnVwZGF0ZUVuZCgpO1xuICAgIGlmIChzd2FwKSB7XG4gICAgICB2YXIgdG1wID0gdGhpcy5faW5wdXRCdWZmZXIuYnVmZmVySWQ7XG4gICAgICB0aGlzLl9pbnB1dEJ1ZmZlci5idWZmZXJJZCA9IHRoaXMuX291dHB1dEJ1ZmZlci5idWZmZXJJZDtcbiAgICAgIHRoaXMuX291dHB1dEJ1ZmZlci5idWZmZXJJZCA9IHRtcDtcbiAgICB9XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVHJhbnNmb3JtRmVlZGJhY2sucHJvdG90eXBlLCBcImlucHV0QnVmZmVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lucHV0QnVmZmVyO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUcmFuc2Zvcm1GZWVkYmFjay5wcm90b3R5cGUsIFwib3V0cHV0QnVmZmVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX291dHB1dEJ1ZmZlcjtcbiAgfX0pO1xuICByZXR1cm4ge1RyYW5zZm9ybUZlZWRiYWNrOlRyYW5zZm9ybUZlZWRiYWNrfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgVGV4dHVyZSA9IGZ1bmN0aW9uKGdyYXBoaWNzRGV2aWNlLCBvcHRpb25zKSB7XG4gICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICB0aGlzLm5hbWUgPSBudWxsO1xuICAgIHRoaXMuX3dpZHRoID0gNDtcbiAgICB0aGlzLl9oZWlnaHQgPSA0O1xuICAgIHRoaXMuX2RlcHRoID0gMTtcbiAgICB0aGlzLl9wb3QgPSB0cnVlO1xuICAgIHRoaXMuX2Zvcm1hdCA9IHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4O1xuICAgIHRoaXMucmdibSA9IGZhbHNlO1xuICAgIHRoaXMuX2N1YmVtYXAgPSBmYWxzZTtcbiAgICB0aGlzLl92b2x1bWUgPSBmYWxzZTtcbiAgICB0aGlzLmZpeEN1YmVtYXBTZWFtcyA9IGZhbHNlO1xuICAgIHRoaXMuX2ZsaXBZID0gdHJ1ZTtcbiAgICB0aGlzLl9taXBtYXBzID0gdHJ1ZTtcbiAgICB0aGlzLl9taW5GaWx0ZXIgPSBwYy5GSUxURVJfTElORUFSX01JUE1BUF9MSU5FQVI7XG4gICAgdGhpcy5fbWFnRmlsdGVyID0gcGMuRklMVEVSX0xJTkVBUjtcbiAgICB0aGlzLl9hbmlzb3Ryb3B5ID0gMTtcbiAgICB0aGlzLl9hZGRyZXNzVSA9IHBjLkFERFJFU1NfUkVQRUFUO1xuICAgIHRoaXMuX2FkZHJlc3NWID0gcGMuQUREUkVTU19SRVBFQVQ7XG4gICAgdGhpcy5fYWRkcmVzc1cgPSBwYy5BRERSRVNTX1JFUEVBVDtcbiAgICB0aGlzLl9jb21wYXJlT25SZWFkID0gZmFsc2U7XG4gICAgdGhpcy5fY29tcGFyZUZ1bmMgPSBwYy5GVU5DX0xFU1M7XG4gICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fd2lkdGggPSBvcHRpb25zLndpZHRoICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLndpZHRoIDogdGhpcy5fd2lkdGg7XG4gICAgICB0aGlzLl9oZWlnaHQgPSBvcHRpb25zLmhlaWdodCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5oZWlnaHQgOiB0aGlzLl9oZWlnaHQ7XG4gICAgICB0aGlzLl9wb3QgPSBwYy5tYXRoLnBvd2VyT2ZUd28odGhpcy5fd2lkdGgpICYmIHBjLm1hdGgucG93ZXJPZlR3byh0aGlzLl9oZWlnaHQpO1xuICAgICAgdGhpcy5fZm9ybWF0ID0gb3B0aW9ucy5mb3JtYXQgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuZm9ybWF0IDogdGhpcy5fZm9ybWF0O1xuICAgICAgdGhpcy5yZ2JtID0gb3B0aW9ucy5yZ2JtICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJnYm0gOiB0aGlzLnJnYm07XG4gICAgICBpZiAob3B0aW9ucy5taXBtYXBzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5fbWlwbWFwcyA9IG9wdGlvbnMubWlwbWFwcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX21pcG1hcHMgPSBvcHRpb25zLmF1dG9NaXBtYXAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuYXV0b01pcG1hcCA6IHRoaXMuX21pcG1hcHM7XG4gICAgICB9XG4gICAgICB0aGlzLl9jdWJlbWFwID0gb3B0aW9ucy5jdWJlbWFwICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmN1YmVtYXAgOiB0aGlzLl9jdWJlbWFwO1xuICAgICAgdGhpcy5maXhDdWJlbWFwU2VhbXMgPSBvcHRpb25zLmZpeEN1YmVtYXBTZWFtcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5maXhDdWJlbWFwU2VhbXMgOiB0aGlzLmZpeEN1YmVtYXBTZWFtcztcbiAgICAgIHRoaXMuX21pbkZpbHRlciA9IG9wdGlvbnMubWluRmlsdGVyICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1pbkZpbHRlciA6IHRoaXMuX21pbkZpbHRlcjtcbiAgICAgIHRoaXMuX21hZ0ZpbHRlciA9IG9wdGlvbnMubWFnRmlsdGVyICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1hZ0ZpbHRlciA6IHRoaXMuX21hZ0ZpbHRlcjtcbiAgICAgIHRoaXMuX2FuaXNvdHJvcHkgPSBvcHRpb25zLmFuaXNvdHJvcHkgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuYW5pc290cm9weSA6IHRoaXMuX2FuaXNvdHJvcHk7XG4gICAgICB0aGlzLl9hZGRyZXNzVSA9IG9wdGlvbnMuYWRkcmVzc1UgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuYWRkcmVzc1UgOiB0aGlzLl9hZGRyZXNzVTtcbiAgICAgIHRoaXMuX2FkZHJlc3NWID0gb3B0aW9ucy5hZGRyZXNzViAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5hZGRyZXNzViA6IHRoaXMuX2FkZHJlc3NWO1xuICAgICAgdGhpcy5fY29tcGFyZU9uUmVhZCA9IG9wdGlvbnMuY29tcGFyZU9uUmVhZCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jb21wYXJlT25SZWFkIDogdGhpcy5fY29tcGFyZU9uUmVhZDtcbiAgICAgIHRoaXMuX2NvbXBhcmVGdW5jID0gb3B0aW9ucy5fY29tcGFyZUZ1bmMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuX2NvbXBhcmVGdW5jIDogdGhpcy5fY29tcGFyZUZ1bmM7XG4gICAgICB0aGlzLl9mbGlwWSA9IG9wdGlvbnMuZmxpcFkgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuZmxpcFkgOiB0aGlzLl9mbGlwWTtcbiAgICAgIGlmIChncmFwaGljc0RldmljZS53ZWJnbDIpIHtcbiAgICAgICAgdGhpcy5fZGVwdGggPSBvcHRpb25zLmRlcHRoICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmRlcHRoIDogdGhpcy5fZGVwdGg7XG4gICAgICAgIHRoaXMuX3ZvbHVtZSA9IG9wdGlvbnMudm9sdW1lICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnZvbHVtZSA6IHRoaXMuX3ZvbHVtZTtcbiAgICAgICAgdGhpcy5fYWRkcmVzc1cgPSBvcHRpb25zLmFkZHJlc3NXICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmFkZHJlc3NXIDogdGhpcy5fYWRkcmVzc1c7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2NvbXByZXNzZWQgPSB0aGlzLl9mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX0RYVDEgfHwgdGhpcy5fZm9ybWF0ID09PSBwYy5QSVhFTEZPUk1BVF9EWFQzIHx8IHRoaXMuX2Zvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfRFhUNSB8fCB0aGlzLl9mb3JtYXQgPj0gcGMuUElYRUxGT1JNQVRfRVRDMTtcbiAgICB0aGlzLl9pbnZhbGlkID0gZmFsc2U7XG4gICAgdGhpcy5fbGV2ZWxzID0gdGhpcy5fY3ViZW1hcCA/IFtbbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbF1dIDogW251bGxdO1xuICAgIHRoaXMuX2xldmVsc1VwZGF0ZWQgPSB0aGlzLl9jdWJlbWFwID8gW1t0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlXV0gOiBbdHJ1ZV07XG4gICAgdGhpcy5fbG9ja2VkTGV2ZWwgPSAtMTtcbiAgICB0aGlzLl9uZWVkc1VwbG9hZCA9IHRydWU7XG4gICAgdGhpcy5fbmVlZHNNaXBtYXBzVXBsb2FkID0gdGhpcy5fbWlwbWFwcztcbiAgICB0aGlzLl9taXBtYXBzVXBsb2FkZWQgPSBmYWxzZTtcbiAgICB0aGlzLl9taW5GaWx0ZXJEaXJ0eSA9IHRydWU7XG4gICAgdGhpcy5fbWFnRmlsdGVyRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2FkZHJlc3NVRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2FkZHJlc3NWRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2FkZHJlc3NXRGlydHkgPSB0aGlzLl92b2x1bWU7XG4gICAgdGhpcy5fYW5pc290cm9weURpcnR5ID0gdHJ1ZTtcbiAgICB0aGlzLl9jb21wYXJlTW9kZURpcnR5ID0gdHJ1ZTtcbiAgICB0aGlzLl9ncHVTaXplID0gMDtcbiAgfTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHR1cmUucHJvdG90eXBlLCBcIm1pbkZpbHRlclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9taW5GaWx0ZXI7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgaWYgKHRoaXMuX21pbkZpbHRlciAhPT0gdikge1xuICAgICAgdGhpcy5fbWluRmlsdGVyID0gdjtcbiAgICAgIHRoaXMuX21pbkZpbHRlckRpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHR1cmUucHJvdG90eXBlLCBcIm1hZ0ZpbHRlclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9tYWdGaWx0ZXI7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgaWYgKHRoaXMuX21hZ0ZpbHRlciAhPT0gdikge1xuICAgICAgdGhpcy5fbWFnRmlsdGVyID0gdjtcbiAgICAgIHRoaXMuX21hZ0ZpbHRlckRpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHR1cmUucHJvdG90eXBlLCBcImFkZHJlc3NVXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FkZHJlc3NVO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9hZGRyZXNzVSAhPT0gdikge1xuICAgICAgdGhpcy5fYWRkcmVzc1UgPSB2O1xuICAgICAgdGhpcy5fYWRkcmVzc1VEaXJ0eSA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJhZGRyZXNzVlwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9hZGRyZXNzVjtcbiAgfSwgc2V0OmZ1bmN0aW9uKHYpIHtcbiAgICBpZiAodGhpcy5fYWRkcmVzc1YgIT09IHYpIHtcbiAgICAgIHRoaXMuX2FkZHJlc3NWID0gdjtcbiAgICAgIHRoaXMuX2FkZHJlc3NWRGlydHkgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwiYWRkcmVzc1dcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fYWRkcmVzc1c7XG4gIH0sIHNldDpmdW5jdGlvbihhZGRyZXNzVykge1xuICAgIGlmICghdGhpcy5kZXZpY2Uud2ViZ2wyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy5fdm9sdW1lKSB7XG4gICAgICBsb2dXQVJOSU5HKFwiQ2FuJ3Qgc2V0IFcgYWRkcmVzc2luZyBtb2RlIGZvciBhIG5vbi0zRCB0ZXh0dXJlLlwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGFkZHJlc3NXICE9PSB0aGlzLl9hZGRyZXNzVykge1xuICAgICAgdGhpcy5fYWRkcmVzc1cgPSBhZGRyZXNzVztcbiAgICAgIHRoaXMuX2FkZHJlc3NXRGlydHkgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwiY29tcGFyZU9uUmVhZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jb21wYXJlT25SZWFkO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9jb21wYXJlT25SZWFkICE9PSB2KSB7XG4gICAgICB0aGlzLl9jb21wYXJlT25SZWFkID0gdjtcbiAgICAgIHRoaXMuX2NvbXBhcmVNb2RlRGlydHkgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwiY29tcGFyZUZ1bmNcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY29tcGFyZUZ1bmM7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgaWYgKHRoaXMuX2NvbXBhcmVGdW5jICE9PSB2KSB7XG4gICAgICB0aGlzLl9jb21wYXJlRnVuYyA9IHY7XG4gICAgICB0aGlzLl9jb21wYXJlTW9kZURpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHR1cmUucHJvdG90eXBlLCBcImF1dG9NaXBtYXBcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWlwbWFwcztcbiAgfSwgc2V0OmZ1bmN0aW9uKHYpIHtcbiAgICB0aGlzLl9taXBtYXBzID0gdjtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwibWlwbWFwc1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9taXBtYXBzO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9taXBtYXBzICE9PSB2KSB7XG4gICAgICB0aGlzLl9taXBtYXBzID0gdjtcbiAgICAgIHRoaXMuX21pbkZpbHRlckRpcnR5ID0gdHJ1ZTtcbiAgICAgIGlmICh2KSB7XG4gICAgICAgIHRoaXMuX25lZWRzTWlwbWFwc1VwbG9hZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJhbmlzb3Ryb3B5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FuaXNvdHJvcHk7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgaWYgKHRoaXMuX2FuaXNvdHJvcHkgIT09IHYpIHtcbiAgICAgIHRoaXMuX2FuaXNvdHJvcHkgPSB2O1xuICAgICAgdGhpcy5fYW5pc290cm9weURpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHR1cmUucHJvdG90eXBlLCBcIndpZHRoXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3dpZHRoO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJoZWlnaHRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faGVpZ2h0O1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJkZXB0aFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9kZXB0aDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwiZm9ybWF0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Zvcm1hdDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dHVyZS5wcm90b3R5cGUsIFwiY3ViZW1hcFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jdWJlbWFwO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJ2b2x1bWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdm9sdW1lO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0dXJlLnByb3RvdHlwZSwgXCJmbGlwWVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9mbGlwWTtcbiAgfSwgc2V0OmZ1bmN0aW9uKGZsaXBZKSB7XG4gICAgaWYgKHRoaXMuX2ZsaXBZICE9PSBmbGlwWSkge1xuICAgICAgdGhpcy5fZmxpcFkgPSBmbGlwWTtcbiAgICAgIHRoaXMuX25lZWRzVXBsb2FkID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgcGMuZXh0ZW5kKFRleHR1cmUucHJvdG90eXBlLCB7YmluZDpmdW5jdGlvbigpIHtcbiAgfSwgZGVzdHJveTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fZ2xUZXh0dXJlSWQpIHtcbiAgICAgIHZhciBnbCA9IHRoaXMuZGV2aWNlLmdsO1xuICAgICAgZ2wuZGVsZXRlVGV4dHVyZSh0aGlzLl9nbFRleHR1cmVJZCk7XG4gICAgICB0aGlzLmRldmljZS5fdnJhbS50ZXggLT0gdGhpcy5fZ3B1U2l6ZTtcbiAgICAgIHRoaXMuX2dsVGV4dHVyZUlkID0gbnVsbDtcbiAgICB9XG4gIH0sIGxvY2s6ZnVuY3Rpb24ob3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHtsZXZlbDowLCBmYWNlOjAsIG1vZGU6cGMuVEVYVFVSRUxPQ0tfV1JJVEV9O1xuICAgIGlmIChvcHRpb25zLmxldmVsID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9wdGlvbnMubGV2ZWwgPSAwO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5mYWNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9wdGlvbnMuZmFjZSA9IDA7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLm1vZGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy5tb2RlID0gcGMuVEVYVFVSRUxPQ0tfV1JJVEU7XG4gICAgfVxuICAgIHRoaXMuX2xvY2tlZExldmVsID0gb3B0aW9ucy5sZXZlbDtcbiAgICBpZiAodGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID09PSBudWxsKSB7XG4gICAgICBzd2l0Y2godGhpcy5fZm9ybWF0KSB7XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfQTg6XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfTDg6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5fd2lkdGggKiB0aGlzLl9oZWlnaHQgKiB0aGlzLl9kZXB0aCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfTDhfQTg6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5fd2lkdGggKiB0aGlzLl9oZWlnaHQgKiB0aGlzLl9kZXB0aCAqIDIpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1I1X0c2X0I1OlxuICAgICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1I1X0c1X0I1X0ExOlxuICAgICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1I0X0c0X0I0X0E0OlxuICAgICAgICAgIHRoaXMuX2xldmVsc1tvcHRpb25zLmxldmVsXSA9IG5ldyBVaW50MTZBcnJheSh0aGlzLl93aWR0aCAqIHRoaXMuX2hlaWdodCAqIHRoaXMuX2RlcHRoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9CODpcbiAgICAgICAgICB0aGlzLl9sZXZlbHNbb3B0aW9ucy5sZXZlbF0gPSBuZXcgVWludDhBcnJheSh0aGlzLl93aWR0aCAqIHRoaXMuX2hlaWdodCAqIHRoaXMuX2RlcHRoICogMyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTg6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5fd2lkdGggKiB0aGlzLl9oZWlnaHQgKiB0aGlzLl9kZXB0aCAqIDQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX0RYVDE6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5mbG9vcigodGhpcy5fd2lkdGggKyAzKSAvIDQpICogTWF0aC5mbG9vcigodGhpcy5faGVpZ2h0ICsgMykgLyA0KSAqIDggKiB0aGlzLl9kZXB0aCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfRFhUMzpcbiAgICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9EWFQ1OlxuICAgICAgICAgIHRoaXMuX2xldmVsc1tvcHRpb25zLmxldmVsXSA9IG5ldyBVaW50OEFycmF5KE1hdGguZmxvb3IoKHRoaXMuX3dpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKHRoaXMuX2hlaWdodCArIDMpIC8gNCkgKiAxNiAqIHRoaXMuX2RlcHRoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SR0IxNkY6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IFVpbnQxNkFycmF5KHRoaXMuX3dpZHRoICogdGhpcy5faGVpZ2h0ICogdGhpcy5fZGVwdGggKiAzKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SR0IzMkY6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLl93aWR0aCAqIHRoaXMuX2hlaWdodCAqIHRoaXMuX2RlcHRoICogMyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUkdCQTE2RjpcbiAgICAgICAgICB0aGlzLl9sZXZlbHNbb3B0aW9ucy5sZXZlbF0gPSBuZXcgVWludDE2QXJyYXkodGhpcy5fd2lkdGggKiB0aGlzLl9oZWlnaHQgKiB0aGlzLl9kZXB0aCAqIDQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1JHQkEzMkY6XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzW29wdGlvbnMubGV2ZWxdID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLl93aWR0aCAqIHRoaXMuX2hlaWdodCAqIHRoaXMuX2RlcHRoICogNCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9sZXZlbHNbb3B0aW9ucy5sZXZlbF07XG4gIH0sIHJlY292ZXI6ZnVuY3Rpb24oKSB7XG4gIH0sIHNldFNvdXJjZTpmdW5jdGlvbihzb3VyY2UpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgaW52YWxpZCA9IGZhbHNlO1xuICAgIHZhciB3aWR0aCwgaGVpZ2h0O1xuICAgIGlmICh0aGlzLl9jdWJlbWFwKSB7XG4gICAgICBpZiAoc291cmNlWzBdKSB7XG4gICAgICAgIHdpZHRoID0gc291cmNlWzBdLndpZHRoIHx8IDA7XG4gICAgICAgIGhlaWdodCA9IHNvdXJjZVswXS5oZWlnaHQgfHwgMDtcbiAgICAgICAgZm9yIChpID0gMDtpIDwgNjtpKyspIHtcbiAgICAgICAgICBpZiAoIXNvdXJjZVtpXSB8fCBzb3VyY2VbaV0ud2lkdGggIT09IHdpZHRoIHx8IHNvdXJjZVtpXS5oZWlnaHQgIT09IGhlaWdodCB8fCAhKHNvdXJjZVtpXSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpICYmICEoc291cmNlW2ldIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpICYmICEoc291cmNlW2ldIGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCkpIHtcbiAgICAgICAgICAgIGludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnZhbGlkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmICghaW52YWxpZCkge1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCA2O2krKykge1xuICAgICAgICAgIGlmICh0aGlzLl9sZXZlbHNbMF1baV0gIT09IHNvdXJjZVtpXSkge1xuICAgICAgICAgICAgdGhpcy5fbGV2ZWxzVXBkYXRlZFswXVtpXSA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghKHNvdXJjZSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpICYmICEoc291cmNlIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpICYmICEoc291cmNlIGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCkpIHtcbiAgICAgICAgaW52YWxpZCA9IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAoIWludmFsaWQpIHtcbiAgICAgICAgaWYgKHNvdXJjZSAhPT0gdGhpcy5fbGV2ZWxzWzBdKSB7XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzVXBkYXRlZFswXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgd2lkdGggPSBzb3VyY2Uud2lkdGg7XG4gICAgICAgIGhlaWdodCA9IHNvdXJjZS5oZWlnaHQ7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbnZhbGlkKSB7XG4gICAgICB0aGlzLl93aWR0aCA9IDQ7XG4gICAgICB0aGlzLl9oZWlnaHQgPSA0O1xuICAgICAgdGhpcy5fcG90ID0gdHJ1ZTtcbiAgICAgIGlmICh0aGlzLl9jdWJlbWFwKSB7XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IDY7aSsrKSB7XG4gICAgICAgICAgdGhpcy5fbGV2ZWxzWzBdW2ldID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9sZXZlbHNVcGRhdGVkWzBdW2ldID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fbGV2ZWxzWzBdID0gbnVsbDtcbiAgICAgICAgdGhpcy5fbGV2ZWxzVXBkYXRlZFswXSA9IHRydWU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7XG4gICAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICB0aGlzLl9wb3QgPSBwYy5tYXRoLnBvd2VyT2ZUd28odGhpcy5fd2lkdGgpICYmIHBjLm1hdGgucG93ZXJPZlR3byh0aGlzLl9oZWlnaHQpO1xuICAgICAgdGhpcy5fbGV2ZWxzWzBdID0gc291cmNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5faW52YWxpZCAhPT0gaW52YWxpZCB8fCAhaW52YWxpZCkge1xuICAgICAgdGhpcy5faW52YWxpZCA9IGludmFsaWQ7XG4gICAgICB0aGlzLnVwbG9hZCgpO1xuICAgIH1cbiAgfSwgZ2V0U291cmNlOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9sZXZlbHNbMF07XG4gIH0sIHVubG9jazpmdW5jdGlvbigpIHtcbiAgICBsb2dBU1NFUlQodGhpcy5fbG9ja2VkTGV2ZWwgIT09IC0xLCBcIkF0dGVtcHRpbmcgdG8gdW5sb2NrIGEgdGV4dHVyZSB0aGF0IGlzIG5vdCBsb2NrZWRcIik7XG4gICAgdGhpcy51cGxvYWQoKTtcbiAgICB0aGlzLl9sb2NrZWRMZXZlbCA9IC0xO1xuICB9LCB1cGxvYWQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fbmVlZHNVcGxvYWQgPSB0cnVlO1xuICAgIHRoaXMuX25lZWRzTWlwbWFwc1VwbG9hZCA9IHRoaXMuX21pcG1hcHM7XG4gIH0sIGdldERkczpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5mb3JtYXQgIT09IHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4KSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiVGhpcyBmb3JtYXQgaXMgbm90IGltcGxlbWVudGVkIHlldFwiKTtcbiAgICB9XG4gICAgdmFyIGZzaXplID0gMTI4O1xuICAgIHZhciBpID0gMDtcbiAgICB2YXIgajtcbiAgICB2YXIgZmFjZTtcbiAgICB3aGlsZSAodGhpcy5fbGV2ZWxzW2ldKSB7XG4gICAgICB2YXIgbWlwU2l6ZTtcbiAgICAgIGlmICghdGhpcy5jdWJlbWFwKSB7XG4gICAgICAgIG1pcFNpemUgPSB0aGlzLl9sZXZlbHNbaV0ubGVuZ3RoO1xuICAgICAgICBpZiAoIW1pcFNpemUpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKFwiTm8gYnl0ZSBhcnJheSBmb3IgbWlwIFwiICsgaSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGZzaXplICs9IG1pcFNpemU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKGZhY2UgPSAwO2ZhY2UgPCA2O2ZhY2UrKykge1xuICAgICAgICAgIGlmICghdGhpcy5fbGV2ZWxzW2ldW2ZhY2VdKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiTm8gbGV2ZWwgZGF0YSBmb3IgbWlwIFwiICsgaSArIFwiLCBmYWNlIFwiICsgZmFjZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIG1pcFNpemUgPSB0aGlzLl9sZXZlbHNbaV1bZmFjZV0ubGVuZ3RoO1xuICAgICAgICAgIGlmICghbWlwU2l6ZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIk5vIGJ5dGUgYXJyYXkgZm9yIG1pcCBcIiArIGkgKyBcIiwgZmFjZSBcIiArIGZhY2UpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmc2l6ZSArPSBtaXBTaXplO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmc2l6ZSArPSB0aGlzLl9sZXZlbHNbaV0ubGVuZ3RoO1xuICAgICAgaSsrO1xuICAgIH1cbiAgICB2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihmc2l6ZSk7XG4gICAgdmFyIGhlYWRlciA9IG5ldyBVaW50MzJBcnJheShidWZmLCAwLCAxMjggLyA0KTtcbiAgICB2YXIgRERTX01BR0lDID0gNTQyMzI3ODc2O1xuICAgIHZhciBERFNfSEVBREVSX1NJWkUgPSAxMjQ7XG4gICAgdmFyIEREU19GTEFHU19SRVFVSVJFRCA9IDEgfCAyIHwgNCB8IDQwOTYgfCA1MjQyODg7XG4gICAgdmFyIEREU19GTEFHU19NSVBNQVAgPSAxMzEwNzI7XG4gICAgdmFyIEREU19QSVhFTEZPUk1BVF9TSVpFID0gMzI7XG4gICAgdmFyIEREU19QSVhFTEZMQUdTX1JHQkE4ID0gMSB8IDY0O1xuICAgIHZhciBERFNfQ0FQU19SRVFVSVJFRCA9IDQwOTY7XG4gICAgdmFyIEREU19DQVBTX01JUE1BUCA9IDQxOTQzMDQ7XG4gICAgdmFyIEREU19DQVBTX0NPTVBMRVggPSA4O1xuICAgIHZhciBERFNfQ0FQUzJfQ1VCRU1BUCA9IDUxMiB8IDEwMjQgfCAyMDQ4IHwgNDA5NiB8IDgxOTIgfCAxNjM4NCB8IDMyNzY4O1xuICAgIHZhciBmbGFncyA9IEREU19GTEFHU19SRVFVSVJFRDtcbiAgICBpZiAodGhpcy5fbGV2ZWxzLmxlbmd0aCA+IDEpIHtcbiAgICAgIGZsYWdzIHw9IEREU19GTEFHU19NSVBNQVA7XG4gICAgfVxuICAgIHZhciBjYXBzID0gRERTX0NBUFNfUkVRVUlSRUQ7XG4gICAgaWYgKHRoaXMuX2xldmVscy5sZW5ndGggPiAxKSB7XG4gICAgICBjYXBzIHw9IEREU19DQVBTX01JUE1BUDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2xldmVscy5sZW5ndGggPiAxIHx8IHRoaXMuY3ViZW1hcCkge1xuICAgICAgY2FwcyB8PSBERFNfQ0FQU19DT01QTEVYO1xuICAgIH1cbiAgICB2YXIgY2FwczIgPSB0aGlzLmN1YmVtYXAgPyBERFNfQ0FQUzJfQ1VCRU1BUCA6IDA7XG4gICAgaGVhZGVyWzBdID0gRERTX01BR0lDO1xuICAgIGhlYWRlclsxXSA9IEREU19IRUFERVJfU0laRTtcbiAgICBoZWFkZXJbMl0gPSBmbGFncztcbiAgICBoZWFkZXJbM10gPSB0aGlzLmhlaWdodDtcbiAgICBoZWFkZXJbNF0gPSB0aGlzLndpZHRoO1xuICAgIGhlYWRlcls1XSA9IHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCAqIDQ7XG4gICAgaGVhZGVyWzZdID0gMDtcbiAgICBoZWFkZXJbN10gPSB0aGlzLl9sZXZlbHMubGVuZ3RoO1xuICAgIGZvciAoaSA9IDA7aSA8IDExO2krKykge1xuICAgICAgaGVhZGVyWzggKyBpXSA9IDA7XG4gICAgfVxuICAgIGhlYWRlclsxOV0gPSBERFNfUElYRUxGT1JNQVRfU0laRTtcbiAgICBoZWFkZXJbMjBdID0gRERTX1BJWEVMRkxBR1NfUkdCQTg7XG4gICAgaGVhZGVyWzIxXSA9IDA7XG4gICAgaGVhZGVyWzIyXSA9IDMyO1xuICAgIGhlYWRlclsyM10gPSAxNjcxMTY4MDtcbiAgICBoZWFkZXJbMjRdID0gNjUyODA7XG4gICAgaGVhZGVyWzI1XSA9IDI1NTtcbiAgICBoZWFkZXJbMjZdID0gNDI3ODE5MDA4MDtcbiAgICBoZWFkZXJbMjddID0gY2FwcztcbiAgICBoZWFkZXJbMjhdID0gY2FwczI7XG4gICAgaGVhZGVyWzI5XSA9IDA7XG4gICAgaGVhZGVyWzMwXSA9IDA7XG4gICAgaGVhZGVyWzMxXSA9IDA7XG4gICAgdmFyIG9mZnNldCA9IDEyODtcbiAgICB2YXIgbGV2ZWwsIG1pcDtcbiAgICBpZiAoIXRoaXMuY3ViZW1hcCkge1xuICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy5fbGV2ZWxzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgbGV2ZWwgPSB0aGlzLl9sZXZlbHNbaV07XG4gICAgICAgIG1pcCA9IG5ldyBVaW50OEFycmF5KGJ1ZmYsIG9mZnNldCwgbGV2ZWwubGVuZ3RoKTtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbGV2ZWwubGVuZ3RoO2orKykge1xuICAgICAgICAgIG1pcFtqXSA9IGxldmVsW2pdO1xuICAgICAgICB9XG4gICAgICAgIG9mZnNldCArPSBsZXZlbC5sZW5ndGg7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAoZmFjZSA9IDA7ZmFjZSA8IDY7ZmFjZSsrKSB7XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IHRoaXMuX2xldmVscy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgbGV2ZWwgPSB0aGlzLl9sZXZlbHNbaV1bZmFjZV07XG4gICAgICAgICAgbWlwID0gbmV3IFVpbnQ4QXJyYXkoYnVmZiwgb2Zmc2V0LCBsZXZlbC5sZW5ndGgpO1xuICAgICAgICAgIGZvciAoaiA9IDA7aiA8IGxldmVsLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICAgIG1pcFtqXSA9IGxldmVsW2pdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBvZmZzZXQgKz0gbGV2ZWwubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBidWZmO1xuICB9fSk7XG4gIHJldHVybiB7VGV4dHVyZTpUZXh0dXJlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgZGVmYXVsdE9wdGlvbnMgPSB7ZGVwdGg6dHJ1ZSwgZmFjZTowfTtcbiAgdmFyIFJlbmRlclRhcmdldCA9IGZ1bmN0aW9uKG9wdGlvbnMsIF9hcmcyLCBfYXJnMykge1xuICAgIGlmIChvcHRpb25zIGluc3RhbmNlb2YgcGMuR3JhcGhpY3NEZXZpY2UpIHtcbiAgICAgIHRoaXMuX2NvbG9yQnVmZmVyID0gX2FyZzI7XG4gICAgICBvcHRpb25zID0gX2FyZzM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NvbG9yQnVmZmVyID0gb3B0aW9ucy5jb2xvckJ1ZmZlcjtcbiAgICB9XG4gICAgdGhpcy5fZ2xGcmFtZUJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5fZ2xEZXB0aEJ1ZmZlciA9IG51bGw7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMgOiBkZWZhdWx0T3B0aW9ucztcbiAgICB0aGlzLl9kZXB0aEJ1ZmZlciA9IG9wdGlvbnMuZGVwdGhCdWZmZXI7XG4gICAgdGhpcy5fZmFjZSA9IG9wdGlvbnMuZmFjZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5mYWNlIDogMDtcbiAgICBpZiAodGhpcy5fZGVwdGhCdWZmZXIpIHtcbiAgICAgIHZhciBmb3JtYXQgPSB0aGlzLl9kZXB0aEJ1ZmZlci5fZm9ybWF0O1xuICAgICAgaWYgKGZvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfREVQVEgpIHtcbiAgICAgICAgdGhpcy5fZGVwdGggPSB0cnVlO1xuICAgICAgICB0aGlzLl9zdGVuY2lsID0gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZm9ybWF0ID09PSBwYy5QSVhFTEZPUk1BVF9ERVBUSFNURU5DSUwpIHtcbiAgICAgICAgICB0aGlzLl9kZXB0aCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5fc3RlbmNpbCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fZGVwdGggPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLl9zdGVuY2lsID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZGVwdGggPSBvcHRpb25zLmRlcHRoICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmRlcHRoIDogdHJ1ZTtcbiAgICAgIHRoaXMuX3N0ZW5jaWwgPSBvcHRpb25zLnN0ZW5jaWwgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc3RlbmNpbCA6IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLl9zYW1wbGVzID0gb3B0aW9ucy5zYW1wbGVzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNhbXBsZXMgOiAxO1xuICAgIHRoaXMuYXV0b1Jlc29sdmUgPSBvcHRpb25zLmF1dG9SZXNvbHZlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmF1dG9SZXNvbHZlIDogdHJ1ZTtcbiAgICB0aGlzLl9nbFJlc29sdmVGcmFtZUJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5fZ2xNc2FhQ29sb3JCdWZmZXIgPSBudWxsO1xuICAgIHRoaXMuX2dsTXNhYURlcHRoQnVmZmVyID0gbnVsbDtcbiAgfTtcbiAgUmVuZGVyVGFyZ2V0LnByb3RvdHlwZSA9IHtkZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fZGV2aWNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBnbCA9IHRoaXMuX2RldmljZS5nbDtcbiAgICBpZiAodGhpcy5fZ2xGcmFtZUJ1ZmZlcikge1xuICAgICAgZ2wuZGVsZXRlRnJhbWVidWZmZXIodGhpcy5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICB0aGlzLl9nbEZyYW1lQnVmZmVyID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2dsRGVwdGhCdWZmZXIpIHtcbiAgICAgIGdsLmRlbGV0ZVJlbmRlcmJ1ZmZlcih0aGlzLl9nbERlcHRoQnVmZmVyKTtcbiAgICAgIHRoaXMuX2dsRGVwdGhCdWZmZXIgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZ2xSZXNvbHZlRnJhbWVCdWZmZXIpIHtcbiAgICAgIGdsLmRlbGV0ZUZyYW1lYnVmZmVyKHRoaXMuX2dsUmVzb2x2ZUZyYW1lQnVmZmVyKTtcbiAgICAgIHRoaXMuX2dsUmVzb2x2ZUZyYW1lQnVmZmVyID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2dsTXNhYUNvbG9yQnVmZmVyKSB7XG4gICAgICBnbC5kZWxldGVSZW5kZXJidWZmZXIodGhpcy5fZ2xNc2FhQ29sb3JCdWZmZXIpO1xuICAgICAgdGhpcy5fZ2xNc2FhQ29sb3JCdWZmZXIgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZ2xNc2FhRGVwdGhCdWZmZXIpIHtcbiAgICAgIGdsLmRlbGV0ZVJlbmRlcmJ1ZmZlcih0aGlzLl9nbE1zYWFEZXB0aEJ1ZmZlcik7XG4gICAgICB0aGlzLl9nbE1zYWFEZXB0aEJ1ZmZlciA9IG51bGw7XG4gICAgfVxuICB9LCByZXNvbHZlOmZ1bmN0aW9uKGNvbG9yLCBkZXB0aCkge1xuICAgIGlmICghdGhpcy5fZGV2aWNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy5fZGV2aWNlLndlYmdsMikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZ2wgPSB0aGlzLl9kZXZpY2UuZ2w7XG4gICAgaWYgKGNvbG9yID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbG9yID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGRlcHRoID09PSB1bmRlZmluZWQgJiYgdGhpcy5fZGVwdGhCdWZmZXIpIHtcbiAgICAgIGRlcHRoID0gdHJ1ZTtcbiAgICB9XG4gICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLlJFQURfRlJBTUVCVUZGRVIsIHRoaXMuX2dsRnJhbWVCdWZmZXIpO1xuICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5EUkFXX0ZSQU1FQlVGRkVSLCB0aGlzLl9nbFJlc29sdmVGcmFtZUJ1ZmZlcik7XG4gICAgZ2wuYmxpdEZyYW1lYnVmZmVyKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCAwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgKGNvbG9yID8gZ2wuQ09MT1JfQlVGRkVSX0JJVCA6IDApIHwgKGRlcHRoID8gZ2wuREVQVEhfQlVGRkVSX0JJVCA6IDApLCBnbC5ORUFSRVNUKTtcbiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuX2dsRnJhbWVCdWZmZXIpO1xuICB9LCBjb3B5OmZ1bmN0aW9uKHNvdXJjZSwgY29sb3IsIGRlcHRoKSB7XG4gICAgaWYgKCF0aGlzLl9kZXZpY2UpIHtcbiAgICAgIGlmIChzb3VyY2UuX2RldmljZSkge1xuICAgICAgICB0aGlzLl9kZXZpY2UgPSBzb3VyY2UuX2RldmljZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2RldmljZS5jb3B5UmVuZGVyVGFyZ2V0KHNvdXJjZSwgdGhpcywgY29sb3IsIGRlcHRoKTtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW5kZXJUYXJnZXQucHJvdG90eXBlLCBcImNvbG9yQnVmZmVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbG9yQnVmZmVyO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW5kZXJUYXJnZXQucHJvdG90eXBlLCBcImRlcHRoQnVmZmVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RlcHRoQnVmZmVyO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW5kZXJUYXJnZXQucHJvdG90eXBlLCBcImZhY2VcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fZmFjZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUmVuZGVyVGFyZ2V0LnByb3RvdHlwZSwgXCJ3aWR0aFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9jb2xvckJ1ZmZlcikge1xuICAgICAgcmV0dXJuIHRoaXMuX2NvbG9yQnVmZmVyLndpZHRoO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5fZGVwdGhCdWZmZXIud2lkdGg7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW5kZXJUYXJnZXQucHJvdG90eXBlLCBcImhlaWdodFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9jb2xvckJ1ZmZlcikge1xuICAgICAgcmV0dXJuIHRoaXMuX2NvbG9yQnVmZmVyLmhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuX2RlcHRoQnVmZmVyLmhlaWdodDtcbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtSZW5kZXJUYXJnZXQ6UmVuZGVyVGFyZ2V0fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgU2hhZGVySW5wdXQgPSBmdW5jdGlvbihncmFwaGljc0RldmljZSwgbmFtZSwgdHlwZSwgbG9jYXRpb25JZCkge1xuICAgIHRoaXMubG9jYXRpb25JZCA9IGxvY2F0aW9uSWQ7XG4gICAgdGhpcy5zY29wZUlkID0gZ3JhcGhpY3NEZXZpY2Uuc2NvcGUucmVzb2x2ZShuYW1lKTtcbiAgICB0aGlzLnZlcnNpb24gPSBuZXcgcGMuVmVyc2lvbjtcbiAgICBpZiAodHlwZSA9PT0gcGMuVU5JRk9STVRZUEVfRkxPQVQpIHtcbiAgICAgIGlmIChuYW1lLnN1YnN0cihuYW1lLmxlbmd0aCAtIDMpID09PSBcIlswXVwiKSB7XG4gICAgICAgIHR5cGUgPSBwYy5VTklGT1JNVFlQRV9GTE9BVEFSUkFZO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRhdGFUeXBlID0gdHlwZTtcbiAgICB0aGlzLnZhbHVlID0gW251bGwsIG51bGwsIG51bGwsIG51bGxdO1xuICAgIHRoaXMuYXJyYXkgPSBbXTtcbiAgfTtcbiAgcmV0dXJuIHtTaGFkZXJJbnB1dDpTaGFkZXJJbnB1dH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgZnVuY3Rpb24gYWRkTGluZU51bWJlcnMoc3JjKSB7XG4gICAgdmFyIGNodW5rcyA9IHNyYy5zcGxpdChcIlxcblwiKTtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY2h1bmtzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgY2h1bmtzW2ldID0gaSArIDEgKyBcIjpcXHRcIiArIGNodW5rc1tpXTtcbiAgICB9XG4gICAgcmV0dXJuIGNodW5rcy5qb2luKFwiXFxuXCIpO1xuICB9XG4gIGZ1bmN0aW9uIGNyZWF0ZVNoYWRlcihnbCwgdHlwZSwgc3JjKSB7XG4gICAgdmFyIHNoYWRlciA9IGdsLmNyZWF0ZVNoYWRlcih0eXBlKTtcbiAgICBnbC5zaGFkZXJTb3VyY2Uoc2hhZGVyLCBzcmMpO1xuICAgIGdsLmNvbXBpbGVTaGFkZXIoc2hhZGVyKTtcbiAgICByZXR1cm4gc2hhZGVyO1xuICB9XG4gIGZ1bmN0aW9uIGNyZWF0ZVByb2dyYW0oZ2wsIHZlcnRleFNoYWRlciwgZnJhZ21lbnRTaGFkZXIpIHtcbiAgICB2YXIgcHJvZ3JhbSA9IGdsLmNyZWF0ZVByb2dyYW0oKTtcbiAgICBnbC5hdHRhY2hTaGFkZXIocHJvZ3JhbSwgdmVydGV4U2hhZGVyKTtcbiAgICBnbC5hdHRhY2hTaGFkZXIocHJvZ3JhbSwgZnJhZ21lbnRTaGFkZXIpO1xuICAgIHJldHVybiBwcm9ncmFtO1xuICB9XG4gIHZhciBTaGFkZXIgPSBmdW5jdGlvbihncmFwaGljc0RldmljZSwgZGVmaW5pdGlvbikge1xuICAgIHRoaXMuX3JlZkNvdW50ID0gMDtcbiAgICB0aGlzLmRldmljZSA9IGdyYXBoaWNzRGV2aWNlO1xuICAgIHRoaXMuZGVmaW5pdGlvbiA9IGRlZmluaXRpb247XG4gICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xuICAgIHZhciBnbCA9IHRoaXMuZGV2aWNlLmdsO1xuICAgIHRoaXMudnNoYWRlciA9IGNyZWF0ZVNoYWRlcihnbCwgZ2wuVkVSVEVYX1NIQURFUiwgZGVmaW5pdGlvbi52c2hhZGVyKTtcbiAgICB0aGlzLmZzaGFkZXIgPSBjcmVhdGVTaGFkZXIoZ2wsIGdsLkZSQUdNRU5UX1NIQURFUiwgZGVmaW5pdGlvbi5mc2hhZGVyKTtcbiAgICB0aGlzLnByb2dyYW0gPSBjcmVhdGVQcm9ncmFtKGdsLCB0aGlzLnZzaGFkZXIsIHRoaXMuZnNoYWRlcik7XG4gICAgZ3JhcGhpY3NEZXZpY2UuX3NoYWRlclN0YXRzLnZzQ29tcGlsZWQrKztcbiAgICBncmFwaGljc0RldmljZS5fc2hhZGVyU3RhdHMuZnNDb21waWxlZCsrO1xuICAgIGdyYXBoaWNzRGV2aWNlLl9zaGFkZXJTdGF0cy5saW5rZWQrKztcbiAgICBpZiAoZGVmaW5pdGlvbi50YWcgPT09IHBjLlNIQURFUlRBR19NQVRFUklBTCkge1xuICAgICAgZ3JhcGhpY3NEZXZpY2UuX3NoYWRlclN0YXRzLm1hdGVyaWFsU2hhZGVycysrO1xuICAgIH1cbiAgfTtcbiAgU2hhZGVyLnByb3RvdHlwZSA9IHtsaW5rOmZ1bmN0aW9uKCkge1xuICAgIHZhciBnbCA9IHRoaXMuZGV2aWNlLmdsO1xuICAgIHZhciByZXRWYWx1ZSA9IHRydWU7XG4gICAgaWYgKHRoaXMuZGV2aWNlLndlYmdsMiAmJiB0aGlzLmRlZmluaXRpb24udXNlVHJhbnNmb3JtRmVlZGJhY2spIHtcbiAgICAgIHZhciBhdHRycyA9IHRoaXMuZGVmaW5pdGlvbi5hdHRyaWJ1dGVzO1xuICAgICAgdmFyIG91dE5hbWVzID0gW107XG4gICAgICBmb3IgKHZhciBhdHRyIGluIGF0dHJzKSB7XG4gICAgICAgIGlmIChhdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKSkge1xuICAgICAgICAgIG91dE5hbWVzLnB1c2goXCJvdXRfXCIgKyBhdHRyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZ2wudHJhbnNmb3JtRmVlZGJhY2tWYXJ5aW5ncyh0aGlzLnByb2dyYW0sIG91dE5hbWVzLCBnbC5JTlRFUkxFQVZFRF9BVFRSSUJTKTtcbiAgICB9XG4gICAgZ2wubGlua1Byb2dyYW0odGhpcy5wcm9ncmFtKTtcbiAgICBpZiAoIWdsLmdldFNoYWRlclBhcmFtZXRlcih0aGlzLnZzaGFkZXIsIGdsLkNPTVBJTEVfU1RBVFVTKSkge1xuICAgICAgbG9nRVJST1IoXCJGYWlsZWQgdG8gY29tcGlsZSB2ZXJ0ZXggc2hhZGVyOlxcblxcblwiICsgYWRkTGluZU51bWJlcnModGhpcy5kZWZpbml0aW9uLnZzaGFkZXIpICsgXCJcXG5cXG5cIiArIGdsLmdldFNoYWRlckluZm9Mb2codGhpcy52c2hhZGVyKSk7XG4gICAgICByZXRWYWx1ZSA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIWdsLmdldFNoYWRlclBhcmFtZXRlcih0aGlzLmZzaGFkZXIsIGdsLkNPTVBJTEVfU1RBVFVTKSkge1xuICAgICAgbG9nRVJST1IoXCJGYWlsZWQgdG8gY29tcGlsZSBmcmFnbWVudCBzaGFkZXI6XFxuXFxuXCIgKyBhZGRMaW5lTnVtYmVycyh0aGlzLmRlZmluaXRpb24uZnNoYWRlcikgKyBcIlxcblxcblwiICsgZ2wuZ2V0U2hhZGVySW5mb0xvZyh0aGlzLmZzaGFkZXIpKTtcbiAgICAgIHJldFZhbHVlID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICghZ2wuZ2V0UHJvZ3JhbVBhcmFtZXRlcih0aGlzLnByb2dyYW0sIGdsLkxJTktfU1RBVFVTKSkge1xuICAgICAgbG9nRVJST1IoXCJGYWlsZWQgdG8gbGluayBzaGFkZXIgcHJvZ3JhbS4gRXJyb3I6IFwiICsgZ2wuZ2V0UHJvZ3JhbUluZm9Mb2codGhpcy5wcm9ncmFtKSk7XG4gICAgICByZXRWYWx1ZSA9IGZhbHNlO1xuICAgIH1cbiAgICBnbC5kZWxldGVTaGFkZXIodGhpcy52c2hhZGVyKTtcbiAgICBnbC5kZWxldGVTaGFkZXIodGhpcy5mc2hhZGVyKTtcbiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBbXTtcbiAgICB0aGlzLnVuaWZvcm1zID0gW107XG4gICAgdGhpcy5zYW1wbGVycyA9IFtdO1xuICAgIHZhciBpID0gMDtcbiAgICB2YXIgaW5mbywgbG9jYXRpb247XG4gICAgdmFyIF90eXBlVG9QYyA9IHt9O1xuICAgIF90eXBlVG9QY1tnbC5CT09MXSA9IHBjLlVOSUZPUk1UWVBFX0JPT0w7XG4gICAgX3R5cGVUb1BjW2dsLklOVF0gPSBwYy5VTklGT1JNVFlQRV9JTlQ7XG4gICAgX3R5cGVUb1BjW2dsLkZMT0FUXSA9IHBjLlVOSUZPUk1UWVBFX0ZMT0FUO1xuICAgIF90eXBlVG9QY1tnbC5GTE9BVF9WRUMyXSA9IHBjLlVOSUZPUk1UWVBFX1ZFQzI7XG4gICAgX3R5cGVUb1BjW2dsLkZMT0FUX1ZFQzNdID0gcGMuVU5JRk9STVRZUEVfVkVDMztcbiAgICBfdHlwZVRvUGNbZ2wuRkxPQVRfVkVDNF0gPSBwYy5VTklGT1JNVFlQRV9WRUM0O1xuICAgIF90eXBlVG9QY1tnbC5JTlRfVkVDMl0gPSBwYy5VTklGT1JNVFlQRV9JVkVDMjtcbiAgICBfdHlwZVRvUGNbZ2wuSU5UX1ZFQzNdID0gcGMuVU5JRk9STVRZUEVfSVZFQzM7XG4gICAgX3R5cGVUb1BjW2dsLklOVF9WRUM0XSA9IHBjLlVOSUZPUk1UWVBFX0lWRUM0O1xuICAgIF90eXBlVG9QY1tnbC5CT09MX1ZFQzJdID0gcGMuVU5JRk9STVRZUEVfQlZFQzI7XG4gICAgX3R5cGVUb1BjW2dsLkJPT0xfVkVDM10gPSBwYy5VTklGT1JNVFlQRV9CVkVDMztcbiAgICBfdHlwZVRvUGNbZ2wuQk9PTF9WRUM0XSA9IHBjLlVOSUZPUk1UWVBFX0JWRUM0O1xuICAgIF90eXBlVG9QY1tnbC5GTE9BVF9NQVQyXSA9IHBjLlVOSUZPUk1UWVBFX01BVDI7XG4gICAgX3R5cGVUb1BjW2dsLkZMT0FUX01BVDNdID0gcGMuVU5JRk9STVRZUEVfTUFUMztcbiAgICBfdHlwZVRvUGNbZ2wuRkxPQVRfTUFUNF0gPSBwYy5VTklGT1JNVFlQRV9NQVQ0O1xuICAgIF90eXBlVG9QY1tnbC5TQU1QTEVSXzJEXSA9IHBjLlVOSUZPUk1UWVBFX1RFWFRVUkUyRDtcbiAgICBfdHlwZVRvUGNbZ2wuU0FNUExFUl9DVUJFXSA9IHBjLlVOSUZPUk1UWVBFX1RFWFRVUkVDVUJFO1xuICAgIGlmICh0aGlzLmRldmljZS53ZWJnbDIpIHtcbiAgICAgIF90eXBlVG9QY1tnbC5TQU1QTEVSXzJEX1NIQURPV10gPSBwYy5VTklGT1JNVFlQRV9URVhUVVJFMkRfU0hBRE9XO1xuICAgICAgX3R5cGVUb1BjW2dsLlNBTVBMRVJfQ1VCRV9TSEFET1ddID0gcGMuVU5JRk9STVRZUEVfVEVYVFVSRUNVQkVfU0hBRE9XO1xuICAgICAgX3R5cGVUb1BjW2dsLlNBTVBMRVJfM0RdID0gcGMuVU5JRk9STVRZUEVfVEVYVFVSRTNEO1xuICAgIH1cbiAgICB2YXIgbnVtQXR0cmlidXRlcyA9IGdsLmdldFByb2dyYW1QYXJhbWV0ZXIodGhpcy5wcm9ncmFtLCBnbC5BQ1RJVkVfQVRUUklCVVRFUyk7XG4gICAgd2hpbGUgKGkgPCBudW1BdHRyaWJ1dGVzKSB7XG4gICAgICBpbmZvID0gZ2wuZ2V0QWN0aXZlQXR0cmliKHRoaXMucHJvZ3JhbSwgaSsrKTtcbiAgICAgIGxvY2F0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24odGhpcy5wcm9ncmFtLCBpbmZvLm5hbWUpO1xuICAgICAgaWYgKHRoaXMuZGVmaW5pdGlvbi5hdHRyaWJ1dGVzW2luZm8ubmFtZV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdWZXJ0ZXggc2hhZGVyIGF0dHJpYnV0ZSBcIicgKyBpbmZvLm5hbWUgKyAnXCIgaXMgbm90IG1hcHBlZCB0byBhIHNlbWFudGljIGluIHNoYWRlciBkZWZpbml0aW9uLicpO1xuICAgICAgfVxuICAgICAgdGhpcy5hdHRyaWJ1dGVzLnB1c2gobmV3IHBjLlNoYWRlcklucHV0KHRoaXMuZGV2aWNlLCB0aGlzLmRlZmluaXRpb24uYXR0cmlidXRlc1tpbmZvLm5hbWVdLCBfdHlwZVRvUGNbaW5mby50eXBlXSwgbG9jYXRpb24pKTtcbiAgICB9XG4gICAgaSA9IDA7XG4gICAgdmFyIG51bVVuaWZvcm1zID0gZ2wuZ2V0UHJvZ3JhbVBhcmFtZXRlcih0aGlzLnByb2dyYW0sIGdsLkFDVElWRV9VTklGT1JNUyk7XG4gICAgd2hpbGUgKGkgPCBudW1Vbmlmb3Jtcykge1xuICAgICAgaW5mbyA9IGdsLmdldEFjdGl2ZVVuaWZvcm0odGhpcy5wcm9ncmFtLCBpKyspO1xuICAgICAgbG9jYXRpb24gPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24odGhpcy5wcm9ncmFtLCBpbmZvLm5hbWUpO1xuICAgICAgaWYgKGluZm8udHlwZSA9PT0gZ2wuU0FNUExFUl8yRCB8fCBpbmZvLnR5cGUgPT09IGdsLlNBTVBMRVJfQ1VCRSB8fCB0aGlzLmRldmljZS53ZWJnbDIgJiYgKGluZm8udHlwZSA9PT0gZ2wuU0FNUExFUl8yRF9TSEFET1cgfHwgaW5mby50eXBlID09PSBnbC5TQU1QTEVSX0NVQkVfU0hBRE9XIHx8IGluZm8udHlwZSA9PT0gZ2wuU0FNUExFUl8zRCkpIHtcbiAgICAgICAgdGhpcy5zYW1wbGVycy5wdXNoKG5ldyBwYy5TaGFkZXJJbnB1dCh0aGlzLmRldmljZSwgaW5mby5uYW1lLCBfdHlwZVRvUGNbaW5mby50eXBlXSwgbG9jYXRpb24pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudW5pZm9ybXMucHVzaChuZXcgcGMuU2hhZGVySW5wdXQodGhpcy5kZXZpY2UsIGluZm8ubmFtZSwgX3R5cGVUb1BjW2luZm8udHlwZV0sIGxvY2F0aW9uKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgIHJldHVybiByZXRWYWx1ZTtcbiAgfSwgZGVzdHJveTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5wcm9ncmFtKSB7XG4gICAgICB2YXIgZ2wgPSB0aGlzLmRldmljZS5nbDtcbiAgICAgIGdsLmRlbGV0ZVByb2dyYW0odGhpcy5wcm9ncmFtKTtcbiAgICAgIHRoaXMucHJvZ3JhbSA9IG51bGw7XG4gICAgICB0aGlzLmRldmljZS5yZW1vdmVTaGFkZXJGcm9tQ2FjaGUodGhpcyk7XG4gICAgfVxuICB9fTtcbiAgcmV0dXJuIHtTaGFkZXI6U2hhZGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgUHJvZ3JhbUxpYnJhcnkgPSBmdW5jdGlvbihkZXZpY2UpIHtcbiAgICB0aGlzLl9kZXZpY2UgPSBkZXZpY2U7XG4gICAgdGhpcy5fY2FjaGUgPSB7fTtcbiAgICB0aGlzLl9nZW5lcmF0b3JzID0ge307XG4gICAgdGhpcy5faXNDbGVhcmluZ0NhY2hlID0gZmFsc2U7XG4gIH07XG4gIFByb2dyYW1MaWJyYXJ5LnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGdlbmVyYXRvcikge1xuICAgIGlmICghdGhpcy5pc1JlZ2lzdGVyZWQobmFtZSkpIHtcbiAgICAgIHRoaXMuX2dlbmVyYXRvcnNbbmFtZV0gPSBnZW5lcmF0b3I7XG4gICAgfVxuICB9O1xuICBQcm9ncmFtTGlicmFyeS5wcm90b3R5cGUudW5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICBpZiAodGhpcy5pc1JlZ2lzdGVyZWQobmFtZSkpIHtcbiAgICAgIGRlbGV0ZSB0aGlzLl9nZW5lcmF0b3JzW25hbWVdO1xuICAgIH1cbiAgfTtcbiAgUHJvZ3JhbUxpYnJhcnkucHJvdG90eXBlLmlzUmVnaXN0ZXJlZCA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgZ2VuZXJhdG9yID0gdGhpcy5fZ2VuZXJhdG9yc1tuYW1lXTtcbiAgICByZXR1cm4gZ2VuZXJhdG9yICE9PSB1bmRlZmluZWQ7XG4gIH07XG4gIFByb2dyYW1MaWJyYXJ5LnByb3RvdHlwZS5nZXRQcm9ncmFtID0gZnVuY3Rpb24obmFtZSwgb3B0aW9ucykge1xuICAgIHZhciBnZW5lcmF0b3IgPSB0aGlzLl9nZW5lcmF0b3JzW25hbWVdO1xuICAgIGlmIChnZW5lcmF0b3IgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbG9nRVJST1IoXCJObyBwcm9ncmFtIGxpYnJhcnkgZnVuY3Rpb25zIHJlZ2lzdGVyZWQgZm9yOiBcIiArIG5hbWUpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHZhciBnZCA9IHRoaXMuX2RldmljZTtcbiAgICB2YXIga2V5ID0gZ2VuZXJhdG9yLmdlbmVyYXRlS2V5KGdkLCBvcHRpb25zKTtcbiAgICB2YXIgc2hhZGVyID0gdGhpcy5fY2FjaGVba2V5XTtcbiAgICBpZiAoIXNoYWRlcikge1xuICAgICAgdmFyIHNoYWRlckRlZmluaXRpb24gPSBnZW5lcmF0b3IuY3JlYXRlU2hhZGVyRGVmaW5pdGlvbihnZCwgb3B0aW9ucyk7XG4gICAgICBzaGFkZXIgPSB0aGlzLl9jYWNoZVtrZXldID0gbmV3IHBjLlNoYWRlcihnZCwgc2hhZGVyRGVmaW5pdGlvbik7XG4gICAgfVxuICAgIHJldHVybiBzaGFkZXI7XG4gIH07XG4gIFByb2dyYW1MaWJyYXJ5LnByb3RvdHlwZS5jbGVhckNhY2hlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNhY2hlID0gdGhpcy5fY2FjaGU7XG4gICAgdGhpcy5faXNDbGVhcmluZ0NhY2hlID0gdHJ1ZTtcbiAgICBmb3IgKHZhciBrZXkgaW4gY2FjaGUpIHtcbiAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGNhY2hlW2tleV0uZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9jYWNoZSA9IHt9O1xuICAgIHRoaXMuX2lzQ2xlYXJpbmdDYWNoZSA9IGZhbHNlO1xuICB9O1xuICBQcm9ncmFtTGlicmFyeS5wcm90b3R5cGUucmVtb3ZlRnJvbUNhY2hlID0gZnVuY3Rpb24oc2hhZGVyKSB7XG4gICAgaWYgKHRoaXMuX2lzQ2xlYXJpbmdDYWNoZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgY2FjaGUgPSB0aGlzLl9jYWNoZTtcbiAgICBmb3IgKHZhciBrZXkgaW4gY2FjaGUpIHtcbiAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGlmIChjYWNoZVtrZXldID09PSBzaGFkZXIpIHtcbiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5XTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHtQcm9ncmFtTGlicmFyeTpQcm9ncmFtTGlicmFyeX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEVWRU5UX1JFU0laRSA9IFwicmVzaXplY2FudmFzXCI7XG4gIHZhciB1bmlmb3JtVmFsdWU7XG4gIHZhciBzY29wZVgsIHNjb3BlWSwgc2NvcGVaLCBzY29wZVc7XG4gIGZ1bmN0aW9uIFVuc3VwcG9ydGVkQnJvd3NlckVycm9yKG1lc3NhZ2UpIHtcbiAgICB0aGlzLm5hbWUgPSBcIlVuc3VwcG9ydGVkQnJvd3NlckVycm9yXCI7XG4gICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZSB8fCBcIlwiO1xuICB9XG4gIFVuc3VwcG9ydGVkQnJvd3NlckVycm9yLnByb3RvdHlwZSA9IEVycm9yLnByb3RvdHlwZTtcbiAgZnVuY3Rpb24gQ29udGV4dENyZWF0aW9uRXJyb3IobWVzc2FnZSkge1xuICAgIHRoaXMubmFtZSA9IFwiQ29udGV4dENyZWF0aW9uRXJyb3JcIjtcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiXCI7XG4gIH1cbiAgQ29udGV4dENyZWF0aW9uRXJyb3IucHJvdG90eXBlID0gRXJyb3IucHJvdG90eXBlO1xuICB2YXIgX2NvbnRleHRMb3N0SGFuZGxlciA9IGZ1bmN0aW9uKCkge1xuICAgIGxvZ1dBUk5JTkcoXCJDb250ZXh0IGxvc3QuXCIpO1xuICB9O1xuICB2YXIgX2NvbnRleHRSZXN0b3JlZEhhbmRsZXIgPSBmdW5jdGlvbigpIHtcbiAgICBsb2dJTkZPKFwiQ29udGV4dCByZXN0b3JlZC5cIik7XG4gIH07XG4gIHZhciBfZG93bnNhbXBsZUltYWdlID0gZnVuY3Rpb24oaW1hZ2UsIHNpemUpIHtcbiAgICB2YXIgc3JjVyA9IGltYWdlLndpZHRoO1xuICAgIHZhciBzcmNIID0gaW1hZ2UuaGVpZ2h0O1xuICAgIGlmIChzcmNXID4gc2l6ZSB8fCBzcmNIID4gc2l6ZSkge1xuICAgICAgdmFyIHNjYWxlID0gc2l6ZSAvIE1hdGgubWF4KHNyY1csIHNyY0gpO1xuICAgICAgdmFyIGRzdFcgPSBNYXRoLmZsb29yKHNyY1cgKiBzY2FsZSk7XG4gICAgICB2YXIgZHN0SCA9IE1hdGguZmxvb3Ioc3JjSCAqIHNjYWxlKTtcbiAgICAgIGNvbnNvbGUud2FybihcIkltYWdlIGRpbWVuc2lvbnMgbGFyZ2VyIHRoYW4gbWF4IHN1cHBvcnRlZCB0ZXh0dXJlIHNpemUgb2YgXCIgKyBzaXplICsgXCIuIFwiICsgXCJSZXNpemluZyBmcm9tIFwiICsgc3JjVyArIFwiLCBcIiArIHNyY0ggKyBcIiB0byBcIiArIGRzdFcgKyBcIiwgXCIgKyBkc3RIICsgXCIuXCIpO1xuICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgICBjYW52YXMud2lkdGggPSBkc3RXO1xuICAgICAgY2FudmFzLmhlaWdodCA9IGRzdEg7XG4gICAgICB2YXIgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICBjb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCwgc3JjVywgc3JjSCwgMCwgMCwgZHN0VywgZHN0SCk7XG4gICAgICByZXR1cm4gY2FudmFzO1xuICAgIH1cbiAgICByZXR1cm4gaW1hZ2U7XG4gIH07XG4gIGZ1bmN0aW9uIF9pc0lFKCkge1xuICAgIHZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50O1xuICAgIHZhciBtc2llID0gdWEuaW5kZXhPZihcIk1TSUUgXCIpO1xuICAgIHZhciB0cmlkZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvVHJpZGVudC4qcnY6MTFcXC4vKTtcbiAgICByZXR1cm4gbXNpZSA+IDAgfHwgISF0cmlkZW50O1xuICB9XG4gIHZhciBfcGl4ZWxGb3JtYXQyU2l6ZSA9IG51bGw7XG4gIGZ1bmN0aW9uIGdwdVRleFNpemUoZ2wsIHRleCkge1xuICAgIGlmICghX3BpeGVsRm9ybWF0MlNpemUpIHtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplID0ge307XG4gICAgICBfcGl4ZWxGb3JtYXQyU2l6ZVtwYy5QSVhFTEZPUk1BVF9BOF0gPSAxO1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfTDhdID0gMTtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX0w4X0E4XSA9IDE7XG4gICAgICBfcGl4ZWxGb3JtYXQyU2l6ZVtwYy5QSVhFTEZPUk1BVF9SNV9HNl9CNV0gPSAyO1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfUjVfRzVfQjVfQTFdID0gMjtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX1I0X0c0X0I0X0E0XSA9IDI7XG4gICAgICBfcGl4ZWxGb3JtYXQyU2l6ZVtwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF0gPSA0O1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQThdID0gNDtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX1JHQjE2Rl0gPSA4O1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfUkdCQTE2Rl0gPSA4O1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfUkdCMzJGXSA9IDE2O1xuICAgICAgX3BpeGVsRm9ybWF0MlNpemVbcGMuUElYRUxGT1JNQVRfUkdCQTMyRl0gPSAxNjtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX1IzMkZdID0gNDtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX0RFUFRIXSA9IDQ7XG4gICAgICBfcGl4ZWxGb3JtYXQyU2l6ZVtwYy5QSVhFTEZPUk1BVF9ERVBUSFNURU5DSUxdID0gNDtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUXzExMTExMEZdID0gNDtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX1NSR0JdID0gNDtcbiAgICAgIF9waXhlbEZvcm1hdDJTaXplW3BjLlBJWEVMRk9STUFUX1NSR0JBXSA9IDQ7XG4gICAgfVxuICAgIHZhciBtaXBzID0gMTtcbiAgICBpZiAodGV4Ll9wb3QgJiYgKHRleC5fbWlwbWFwcyB8fCB0ZXguX21pbkZpbHRlciA9PT0gZ2wuTkVBUkVTVF9NSVBNQVBfTkVBUkVTVCB8fCB0ZXguX21pbkZpbHRlciA9PT0gZ2wuTkVBUkVTVF9NSVBNQVBfTElORUFSIHx8IHRleC5fbWluRmlsdGVyID09PSBnbC5MSU5FQVJfTUlQTUFQX05FQVJFU1QgfHwgdGV4Ll9taW5GaWx0ZXIgPT09IGdsLkxJTkVBUl9NSVBNQVBfTElORUFSKSAmJiAhKHRleC5fY29tcHJlc3NlZCAmJiB0ZXguX2xldmVscy5sZW5ndGggPT09IDEpKSB7XG4gICAgICBtaXBzID0gTWF0aC5yb3VuZChNYXRoLmxvZzIoTWF0aC5tYXgodGV4Ll93aWR0aCwgdGV4Ll9oZWlnaHQpKSArIDEpO1xuICAgIH1cbiAgICB2YXIgbWlwV2lkdGggPSB0ZXguX3dpZHRoO1xuICAgIHZhciBtaXBIZWlnaHQgPSB0ZXguX2hlaWdodDtcbiAgICB2YXIgbWlwRGVwdGggPSB0ZXguX2RlcHRoO1xuICAgIHZhciBzaXplID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgbWlwcztpKyspIHtcbiAgICAgIGlmICghdGV4Ll9jb21wcmVzc2VkKSB7XG4gICAgICAgIHNpemUgKz0gbWlwV2lkdGggKiBtaXBIZWlnaHQgKiBtaXBEZXB0aCAqIF9waXhlbEZvcm1hdDJTaXplW3RleC5fZm9ybWF0XTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0ZXguX2Zvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfRVRDMSkge1xuICAgICAgICAgIHNpemUgKz0gTWF0aC5mbG9vcigobWlwV2lkdGggKyAzKSAvIDQpICogTWF0aC5mbG9vcigobWlwSGVpZ2h0ICsgMykgLyA0KSAqIDggKiBtaXBEZXB0aDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodGV4Ll9mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCXzEgfHwgdGV4Ll9mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCQV8xKSB7XG4gICAgICAgICAgICBzaXplICs9IE1hdGgubWF4KG1pcFdpZHRoLCAxNikgKiBNYXRoLm1heChtaXBIZWlnaHQsIDgpIC8gNCAqIG1pcERlcHRoO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGV4Ll9mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCXzEgfHwgdGV4Ll9mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCQV8xKSB7XG4gICAgICAgICAgICAgIHNpemUgKz0gTWF0aC5tYXgobWlwV2lkdGgsIDgpICogTWF0aC5tYXgobWlwSGVpZ2h0LCA4KSAvIDIgKiBtaXBEZXB0aDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHZhciBEWFRfQkxPQ0tfV0lEVEggPSA0O1xuICAgICAgICAgICAgICB2YXIgRFhUX0JMT0NLX0hFSUdIVCA9IDQ7XG4gICAgICAgICAgICAgIHZhciBibG9ja1NpemUgPSB0ZXguX2Zvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfRFhUMSA/IDggOiAxNjtcbiAgICAgICAgICAgICAgdmFyIG51bUJsb2Nrc0Fjcm9zcyA9IE1hdGguZmxvb3IoKG1pcFdpZHRoICsgRFhUX0JMT0NLX1dJRFRIIC0gMSkgLyBEWFRfQkxPQ0tfV0lEVEgpO1xuICAgICAgICAgICAgICB2YXIgbnVtQmxvY2tzRG93biA9IE1hdGguZmxvb3IoKG1pcEhlaWdodCArIERYVF9CTE9DS19IRUlHSFQgLSAxKSAvIERYVF9CTE9DS19IRUlHSFQpO1xuICAgICAgICAgICAgICB2YXIgbnVtQmxvY2tzID0gbnVtQmxvY2tzQWNyb3NzICogbnVtQmxvY2tzRG93bjtcbiAgICAgICAgICAgICAgc2l6ZSArPSBudW1CbG9ja3MgKiBibG9ja1NpemUgKiBtaXBEZXB0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG1pcFdpZHRoID0gTWF0aC5tYXgobWlwV2lkdGggKiAwLjUsIDEpO1xuICAgICAgbWlwSGVpZ2h0ID0gTWF0aC5tYXgobWlwSGVpZ2h0ICogMC41LCAxKTtcbiAgICAgIG1pcERlcHRoID0gTWF0aC5tYXgobWlwRGVwdGggKiAwLjUsIDEpO1xuICAgIH1cbiAgICBpZiAodGV4Ll9jdWJlbWFwKSB7XG4gICAgICBzaXplICo9IDY7XG4gICAgfVxuICAgIHJldHVybiBzaXplO1xuICB9XG4gIGZ1bmN0aW9uIHRlc3RSZW5kZXJhYmxlKGdsLCBleHQsIHBpeGVsRm9ybWF0KSB7XG4gICAgdmFyIF9fdGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTtcbiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBfX3RleHR1cmUpO1xuICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5ORUFSRVNUKTtcbiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTkVBUkVTVCk7XG4gICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7XG4gICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7XG4gICAgdmFyIF9fd2lkdGggPSAyO1xuICAgIHZhciBfX2hlaWdodCA9IDI7XG4gICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCBfX3dpZHRoLCBfX2hlaWdodCwgMCwgZ2wuUkdCQSwgcGl4ZWxGb3JtYXQsIG51bGwpO1xuICAgIHZhciBfX2ZibyA9IGdsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7XG4gICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBfX2Zibyk7XG4gICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCBfX3RleHR1cmUsIDApO1xuICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIG51bGwpO1xuICAgIGlmIChnbC5jaGVja0ZyYW1lYnVmZmVyU3RhdHVzKGdsLkZSQU1FQlVGRkVSKSAhPSBnbC5GUkFNRUJVRkZFUl9DT01QTEVURSkge1xuICAgICAgZ2wuZGVsZXRlVGV4dHVyZShfX3RleHR1cmUpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBnbC5kZWxldGVUZXh0dXJlKF9fdGV4dHVyZSk7XG4gICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBudWxsKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICB2YXIgR3JhcGhpY3NEZXZpY2UgPSBmdW5jdGlvbihjYW52YXMsIG9wdGlvbnMpIHtcbiAgICB0aGlzLmdsID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xuICAgIHRoaXMuc2hhZGVyID0gbnVsbDtcbiAgICB0aGlzLmluZGV4QnVmZmVyID0gbnVsbDtcbiAgICB0aGlzLnZlcnRleEJ1ZmZlcnMgPSBbXTtcbiAgICB0aGlzLnZiT2Zmc2V0cyA9IFtdO1xuICAgIHRoaXMucHJlY2lzaW9uID0gXCJoaWdocFwiO1xuICAgIHRoaXMuX2VuYWJsZUF1dG9JbnN0YW5jaW5nID0gZmFsc2U7XG4gICAgdGhpcy5hdXRvSW5zdGFuY2luZ01heE9iamVjdHMgPSAxNjM4NDtcbiAgICB0aGlzLmF0dHJpYnV0ZXNJbnZhbGlkYXRlZCA9IHRydWU7XG4gICAgdGhpcy5ib3VuZEJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5pbnN0YW5jZWRBdHRyaWJzID0ge307XG4gICAgdGhpcy5lbmFibGVkQXR0cmlidXRlcyA9IHt9O1xuICAgIHRoaXMudGV4dHVyZVVuaXRzID0gW107XG4gICAgdGhpcy5jb21taXRGdW5jdGlvbiA9IHt9O1xuICAgIHRoaXMuX21heFBpeGVsUmF0aW8gPSAxO1xuICAgIHRoaXMuX3dpZHRoID0gMDtcbiAgICB0aGlzLl9oZWlnaHQgPSAwO1xuICAgIHRoaXMudXBkYXRlQ2xpZW50UmVjdCgpO1xuICAgIGlmICghd2luZG93LldlYkdMUmVuZGVyaW5nQ29udGV4dCkge1xuICAgICAgdGhyb3cgbmV3IHBjLlVuc3VwcG9ydGVkQnJvd3NlckVycm9yO1xuICAgIH1cbiAgICBpZiAoY2FudmFzKSB7XG4gICAgICB2YXIgcHJlZmVyV2ViR2wyID0gb3B0aW9ucyAmJiBvcHRpb25zLnByZWZlcldlYkdsMiAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5wcmVmZXJXZWJHbDIgOiB0cnVlO1xuICAgICAgdmFyIG5hbWVzID0gcHJlZmVyV2ViR2wyID8gW1wid2ViZ2wyXCIsIFwiZXhwZXJpbWVudGFsLXdlYmdsMlwiLCBcIndlYmdsXCIsIFwiZXhwZXJpbWVudGFsLXdlYmdsXCJdIDogW1wid2ViZ2xcIiwgXCJleHBlcmltZW50YWwtd2ViZ2xcIl07XG4gICAgICB2YXIgY29udGV4dCA9IG51bGw7XG4gICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgIG9wdGlvbnMuc3RlbmNpbCA9IHRydWU7XG4gICAgICBmb3IgKHZhciBpID0gMDtpIDwgbmFtZXMubGVuZ3RoO2krKykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dChuYW1lc1tpXSwgb3B0aW9ucyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29udGV4dCkge1xuICAgICAgICAgIHRoaXMud2ViZ2wyID0gcHJlZmVyV2ViR2wyICYmIGkgPCAyO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmdsID0gY29udGV4dDtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmdsKSB7XG4gICAgICB0aHJvdyBuZXcgcGMuQ29udGV4dENyZWF0aW9uRXJyb3I7XG4gICAgfVxuICAgIHZhciBnbCA9IHRoaXMuZ2w7XG4gICAgKGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGk7XG4gICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcIndlYmdsY29udGV4dGxvc3RcIiwgX2NvbnRleHRMb3N0SGFuZGxlciwgZmFsc2UpO1xuICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoXCJ3ZWJnbGNvbnRleHRyZXN0b3JlZFwiLCBfY29udGV4dFJlc3RvcmVkSGFuZGxlciwgZmFsc2UpO1xuICAgICAgdGhpcy5jYW52YXMgPSBjYW52YXM7XG4gICAgICB0aGlzLnNoYWRlciA9IG51bGw7XG4gICAgICB0aGlzLmluZGV4QnVmZmVyID0gbnVsbDtcbiAgICAgIHRoaXMudmVydGV4QnVmZmVycyA9IFtdO1xuICAgICAgdGhpcy52Yk9mZnNldHMgPSBbXTtcbiAgICAgIHRoaXMucHJlY2lzaW9uID0gXCJoaWdocFwiO1xuICAgICAgdGhpcy5tYXhUZXh0dXJlU2l6ZSA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVEVYVFVSRV9TSVpFKTtcbiAgICAgIHRoaXMubWF4Q3ViZU1hcFNpemUgPSBnbC5nZXRQYXJhbWV0ZXIoZ2wuTUFYX0NVQkVfTUFQX1RFWFRVUkVfU0laRSk7XG4gICAgICB0aGlzLm1heFJlbmRlckJ1ZmZlclNpemUgPSBnbC5nZXRQYXJhbWV0ZXIoZ2wuTUFYX1JFTkRFUkJVRkZFUl9TSVpFKTtcbiAgICAgIGlmIChnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQpIHtcbiAgICAgICAgdmFyIHZlcnRleFNoYWRlclByZWNpc2lvbkhpZ2hwRmxvYXQgPSBnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZ2wuVkVSVEVYX1NIQURFUiwgZ2wuSElHSF9GTE9BVCk7XG4gICAgICAgIHZhciB2ZXJ0ZXhTaGFkZXJQcmVjaXNpb25NZWRpdW1wRmxvYXQgPSBnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZ2wuVkVSVEVYX1NIQURFUiwgZ2wuTUVESVVNX0ZMT0FUKTtcbiAgICAgICAgdmFyIHZlcnRleFNoYWRlclByZWNpc2lvbkxvd3BGbG9hdCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5WRVJURVhfU0hBREVSLCBnbC5MT1dfRkxPQVQpO1xuICAgICAgICB2YXIgZnJhZ21lbnRTaGFkZXJQcmVjaXNpb25IaWdocEZsb2F0ID0gZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGdsLkZSQUdNRU5UX1NIQURFUiwgZ2wuSElHSF9GTE9BVCk7XG4gICAgICAgIHZhciBmcmFnbWVudFNoYWRlclByZWNpc2lvbk1lZGl1bXBGbG9hdCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5GUkFHTUVOVF9TSEFERVIsIGdsLk1FRElVTV9GTE9BVCk7XG4gICAgICAgIHZhciBmcmFnbWVudFNoYWRlclByZWNpc2lvbkxvd3BGbG9hdCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5GUkFHTUVOVF9TSEFERVIsIGdsLkxPV19GTE9BVCk7XG4gICAgICAgIHZhciB2ZXJ0ZXhTaGFkZXJQcmVjaXNpb25IaWdocEludCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5WRVJURVhfU0hBREVSLCBnbC5ISUdIX0lOVCk7XG4gICAgICAgIHZhciB2ZXJ0ZXhTaGFkZXJQcmVjaXNpb25NZWRpdW1wSW50ID0gZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGdsLlZFUlRFWF9TSEFERVIsIGdsLk1FRElVTV9JTlQpO1xuICAgICAgICB2YXIgdmVydGV4U2hhZGVyUHJlY2lzaW9uTG93cEludCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5WRVJURVhfU0hBREVSLCBnbC5MT1dfSU5UKTtcbiAgICAgICAgdmFyIGZyYWdtZW50U2hhZGVyUHJlY2lzaW9uSGlnaHBJbnQgPSBnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZ2wuRlJBR01FTlRfU0hBREVSLCBnbC5ISUdIX0lOVCk7XG4gICAgICAgIHZhciBmcmFnbWVudFNoYWRlclByZWNpc2lvbk1lZGl1bXBJbnQgPSBnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZ2wuRlJBR01FTlRfU0hBREVSLCBnbC5NRURJVU1fSU5UKTtcbiAgICAgICAgdmFyIGZyYWdtZW50U2hhZGVyUHJlY2lzaW9uTG93cEludCA9IGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChnbC5GUkFHTUVOVF9TSEFERVIsIGdsLkxPV19JTlQpO1xuICAgICAgICB2YXIgaGlnaHBBdmFpbGFibGUgPSB2ZXJ0ZXhTaGFkZXJQcmVjaXNpb25IaWdocEZsb2F0LnByZWNpc2lvbiA+IDAgJiYgZnJhZ21lbnRTaGFkZXJQcmVjaXNpb25IaWdocEZsb2F0LnByZWNpc2lvbiA+IDA7XG4gICAgICAgIHZhciBtZWRpdW1wQXZhaWxhYmxlID0gdmVydGV4U2hhZGVyUHJlY2lzaW9uTWVkaXVtcEZsb2F0LnByZWNpc2lvbiA+IDAgJiYgZnJhZ21lbnRTaGFkZXJQcmVjaXNpb25NZWRpdW1wRmxvYXQucHJlY2lzaW9uID4gMDtcbiAgICAgICAgaWYgKCFoaWdocEF2YWlsYWJsZSkge1xuICAgICAgICAgIGlmIChtZWRpdW1wQXZhaWxhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLnByZWNpc2lvbiA9IFwibWVkaXVtcFwiO1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiV0FSTklORzogaGlnaHAgbm90IHN1cHBvcnRlZCwgdXNpbmcgbWVkaXVtcFwiKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcmVjaXNpb24gPSBcImxvd3BcIjtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IGhpZ2hwIGFuZCBtZWRpdW1wIG5vdCBzdXBwb3J0ZWQsIHVzaW5nIGxvd3BcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLm1heFByZWNpc2lvbiA9IHRoaXMucHJlY2lzaW9uO1xuICAgICAgdGhpcy5kZWZhdWx0Q2xlYXJPcHRpb25zID0ge2NvbG9yOlswLCAwLCAwLCAxXSwgZGVwdGg6MSwgc3RlbmNpbDowLCBmbGFnczpwYy5DTEVBUkZMQUdfQ09MT1IgfCBwYy5DTEVBUkZMQUdfREVQVEh9O1xuICAgICAgdGhpcy5nbEFkZHJlc3MgPSBbZ2wuUkVQRUFULCBnbC5DTEFNUF9UT19FREdFLCBnbC5NSVJST1JFRF9SRVBFQVRdO1xuICAgICAgdGhpcy5nbEJsZW5kRXF1YXRpb24gPSBbZ2wuRlVOQ19BREQsIGdsLkZVTkNfU1VCVFJBQ1QsIGdsLkZVTkNfUkVWRVJTRV9TVUJUUkFDVF07XG4gICAgICB0aGlzLmdsQmxlbmRGdW5jdGlvbiA9IFtnbC5aRVJPLCBnbC5PTkUsIGdsLlNSQ19DT0xPUiwgZ2wuT05FX01JTlVTX1NSQ19DT0xPUiwgZ2wuRFNUX0NPTE9SLCBnbC5PTkVfTUlOVVNfRFNUX0NPTE9SLCBnbC5TUkNfQUxQSEEsIGdsLlNSQ19BTFBIQV9TQVRVUkFURSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSwgZ2wuRFNUX0FMUEhBLCBnbC5PTkVfTUlOVVNfRFNUX0FMUEhBXTtcbiAgICAgIHRoaXMuZ2xDb21wYXJpc29uID0gW2dsLk5FVkVSLCBnbC5MRVNTLCBnbC5FUVVBTCwgZ2wuTEVRVUFMLCBnbC5HUkVBVEVSLCBnbC5OT1RFUVVBTCwgZ2wuR0VRVUFMLCBnbC5BTFdBWVNdO1xuICAgICAgdGhpcy5nbFN0ZW5jaWxPcCA9IFtnbC5LRUVQLCBnbC5aRVJPLCBnbC5SRVBMQUNFLCBnbC5JTkNSLCBnbC5JTkNSX1dSQVAsIGdsLkRFQ1IsIGdsLkRFQ1JfV1JBUCwgZ2wuSU5WRVJUXTtcbiAgICAgIHRoaXMuZ2xDbGVhckZsYWcgPSBbMCwgZ2wuQ09MT1JfQlVGRkVSX0JJVCwgZ2wuREVQVEhfQlVGRkVSX0JJVCwgZ2wuQ09MT1JfQlVGRkVSX0JJVCB8IGdsLkRFUFRIX0JVRkZFUl9CSVQsIGdsLlNURU5DSUxfQlVGRkVSX0JJVCwgZ2wuU1RFTkNJTF9CVUZGRVJfQklUIHwgZ2wuQ09MT1JfQlVGRkVSX0JJVCwgZ2wuU1RFTkNJTF9CVUZGRVJfQklUIHwgZ2wuREVQVEhfQlVGRkVSX0JJVCwgZ2wuU1RFTkNJTF9CVUZGRVJfQklUIHwgZ2wuQ09MT1JfQlVGRkVSX0JJVCB8IGdsLkRFUFRIX0JVRkZFUl9CSVRdO1xuICAgICAgdGhpcy5nbEN1bGwgPSBbMCwgZ2wuQkFDSywgZ2wuRlJPTlQsIGdsLkZST05UX0FORF9CQUNLXTtcbiAgICAgIHRoaXMuZ2xGaWx0ZXIgPSBbZ2wuTkVBUkVTVCwgZ2wuTElORUFSLCBnbC5ORUFSRVNUX01JUE1BUF9ORUFSRVNULCBnbC5ORUFSRVNUX01JUE1BUF9MSU5FQVIsIGdsLkxJTkVBUl9NSVBNQVBfTkVBUkVTVCwgZ2wuTElORUFSX01JUE1BUF9MSU5FQVJdO1xuICAgICAgdGhpcy5nbFByaW1pdGl2ZSA9IFtnbC5QT0lOVFMsIGdsLkxJTkVTLCBnbC5MSU5FX0xPT1AsIGdsLkxJTkVfU1RSSVAsIGdsLlRSSUFOR0xFUywgZ2wuVFJJQU5HTEVfU1RSSVAsIGdsLlRSSUFOR0xFX0ZBTl07XG4gICAgICB0aGlzLmdsVHlwZSA9IFtnbC5CWVRFLCBnbC5VTlNJR05FRF9CWVRFLCBnbC5TSE9SVCwgZ2wuVU5TSUdORURfU0hPUlQsIGdsLklOVCwgZ2wuVU5TSUdORURfSU5ULCBnbC5GTE9BVF07XG4gICAgICB0aGlzLnVubWFza2VkUmVuZGVyZXIgPSBudWxsO1xuICAgICAgdGhpcy51bm1hc2tlZFZlbmRvciA9IG51bGw7XG4gICAgICB0aGlzLmV4dFJlbmRlcmVySW5mbyA9IGdsLmdldEV4dGVuc2lvbihcIldFQkdMX2RlYnVnX3JlbmRlcmVyX2luZm9cIik7XG4gICAgICBpZiAodGhpcy5leHRSZW5kZXJlckluZm8pIHtcbiAgICAgICAgdGhpcy51bm1hc2tlZFJlbmRlcmVyID0gZ2wuZ2V0UGFyYW1ldGVyKHRoaXMuZXh0UmVuZGVyZXJJbmZvLlVOTUFTS0VEX1JFTkRFUkVSX1dFQkdMKTtcbiAgICAgICAgdGhpcy51bm1hc2tlZFZlbmRvciA9IGdsLmdldFBhcmFtZXRlcih0aGlzLmV4dFJlbmRlcmVySW5mby5VTk1BU0tFRF9WRU5ET1JfV0VCR0wpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgIHRoaXMuZXh0VGV4dHVyZUZsb2F0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5leHRUZXh0dXJlSGFsZkZsb2F0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5leHRUZXh0dXJlSGFsZkZsb2F0TGluZWFyID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5leHRVaW50RWxlbWVudCA9IHRydWU7XG4gICAgICAgIHRoaXMuZXh0VGV4dHVyZUxvZCA9IHRydWU7XG4gICAgICAgIHRoaXMuZXh0U3RhbmRhcmREZXJpdmF0aXZlcyA9IHRydWU7XG4gICAgICAgIGdsLmhpbnQoZ2wuRlJBR01FTlRfU0hBREVSX0RFUklWQVRJVkVfSElOVCwgZ2wuTklDRVNUKTtcbiAgICAgICAgdGhpcy5leHRJbnN0YW5jaW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5leHREcmF3QnVmZmVycyA9IHRydWU7XG4gICAgICAgIHRoaXMubWF4RHJhd0J1ZmZlcnMgPSBnbC5nZXRQYXJhbWV0ZXIoZ2wuTUFYX0RSQVdfQlVGRkVSUyk7XG4gICAgICAgIHRoaXMubWF4Q29sb3JBdHRhY2htZW50cyA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfQ09MT1JfQVRUQUNITUVOVFMpO1xuICAgICAgICB0aGlzLmZlZWRiYWNrID0gZ2wuY3JlYXRlVHJhbnNmb3JtRmVlZGJhY2soKTtcbiAgICAgICAgdGhpcy5tYXhWb2x1bWVTaXplID0gZ2wuZ2V0UGFyYW1ldGVyKGdsLk1BWF8zRF9URVhUVVJFX1NJWkUpO1xuICAgICAgICB0aGlzLmV4dEJsZW5kTWlubWF4ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5nbEJsZW5kRXF1YXRpb24ucHVzaChnbC5NSU4pO1xuICAgICAgICB0aGlzLmdsQmxlbmRFcXVhdGlvbi5wdXNoKGdsLk1BWCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVGbG9hdCA9IGdsLmdldEV4dGVuc2lvbihcIk9FU190ZXh0dXJlX2Zsb2F0XCIpO1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXQgPSBnbC5nZXRFeHRlbnNpb24oXCJPRVNfdGV4dHVyZV9oYWxmX2Zsb2F0XCIpO1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXRMaW5lYXIgPSBnbC5nZXRFeHRlbnNpb24oXCJPRVNfdGV4dHVyZV9oYWxmX2Zsb2F0X2xpbmVhclwiKTtcbiAgICAgICAgdGhpcy5leHRVaW50RWxlbWVudCA9IGdsLmdldEV4dGVuc2lvbihcIk9FU19lbGVtZW50X2luZGV4X3VpbnRcIik7XG4gICAgICAgIHRoaXMuZXh0VGV4dHVyZUxvZCA9IGdsLmdldEV4dGVuc2lvbihcIkVYVF9zaGFkZXJfdGV4dHVyZV9sb2RcIik7XG4gICAgICAgIHRoaXMuZXh0U3RhbmRhcmREZXJpdmF0aXZlcyA9IGdsLmdldEV4dGVuc2lvbihcIk9FU19zdGFuZGFyZF9kZXJpdmF0aXZlc1wiKTtcbiAgICAgICAgaWYgKHRoaXMuZXh0U3RhbmRhcmREZXJpdmF0aXZlcykge1xuICAgICAgICAgIGdsLmhpbnQodGhpcy5leHRTdGFuZGFyZERlcml2YXRpdmVzLkZSQUdNRU5UX1NIQURFUl9ERVJJVkFUSVZFX0hJTlRfT0VTLCBnbC5OSUNFU1QpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXh0SW5zdGFuY2luZyA9IGdsLmdldEV4dGVuc2lvbihcIkFOR0xFX2luc3RhbmNlZF9hcnJheXNcIik7XG4gICAgICAgIHRoaXMuZXh0RHJhd0J1ZmZlcnMgPSBnbC5nZXRFeHRlbnNpb24oXCJFWFRfZHJhd19idWZmZXJzXCIpO1xuICAgICAgICB0aGlzLm1heERyYXdCdWZmZXJzID0gdGhpcy5leHREcmF3QnVmZmVycyA/IGdsLmdldFBhcmFtZXRlcih0aGlzLmV4dERyYXdCdWZmZXJzLk1BWF9EUkFXX0JVRkZFUlNfRVhUKSA6IDE7XG4gICAgICAgIHRoaXMubWF4Q29sb3JBdHRhY2htZW50cyA9IHRoaXMuZXh0RHJhd0J1ZmZlcnMgPyBnbC5nZXRQYXJhbWV0ZXIodGhpcy5leHREcmF3QnVmZmVycy5NQVhfQ09MT1JfQVRUQUNITUVOVFNfRVhUKSA6IDE7XG4gICAgICAgIHRoaXMubWF4Vm9sdW1lU2l6ZSA9IDE7XG4gICAgICAgIHRoaXMuZXh0QmxlbmRNaW5tYXggPSBnbC5nZXRFeHRlbnNpb24oXCJFWFRfYmxlbmRfbWlubWF4XCIpO1xuICAgICAgICBpZiAodGhpcy5leHRCbGVuZE1pbm1heCkge1xuICAgICAgICAgIHRoaXMuZ2xCbGVuZEVxdWF0aW9uLnB1c2godGhpcy5leHRCbGVuZE1pbm1heC5NSU5fRVhUKTtcbiAgICAgICAgICB0aGlzLmdsQmxlbmRFcXVhdGlvbi5wdXNoKHRoaXMuZXh0QmxlbmRNaW5tYXguTUFYX0VYVCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5nbEJsZW5kRXF1YXRpb24ucHVzaChnbC5GVU5DX0FERCk7XG4gICAgICAgICAgdGhpcy5nbEJsZW5kRXF1YXRpb24ucHVzaChnbC5GVU5DX0FERCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuZXh0VGV4dHVyZUZsb2F0TGluZWFyID0gZ2wuZ2V0RXh0ZW5zaW9uKFwiT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyXCIpO1xuICAgICAgdGhpcy5tYXhWZXJ0ZXhUZXh0dXJlcyA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFMpO1xuICAgICAgdGhpcy5zdXBwb3J0c0JvbmVUZXh0dXJlcyA9IHRoaXMuZXh0VGV4dHVyZUZsb2F0ICYmIHRoaXMubWF4VmVydGV4VGV4dHVyZXMgPiAwO1xuICAgICAgdGhpcy5mcmFnbWVudFVuaWZvcm1zQ291bnQgPSBnbC5nZXRQYXJhbWV0ZXIoZ2wuTUFYX0ZSQUdNRU5UX1VOSUZPUk1fVkVDVE9SUyk7XG4gICAgICB0aGlzLnNhbXBsZXJDb3VudCA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVEVYVFVSRV9JTUFHRV9VTklUUyk7XG4gICAgICB0aGlzLnVzZVRleEN1YmVMb2QgPSB0aGlzLmV4dFRleHR1cmVMb2QgJiYgdGhpcy5zYW1wbGVyQ291bnQgPCAxNjtcbiAgICAgIHRoaXMuZXh0VGV4dHVyZUZpbHRlckFuaXNvdHJvcGljID0gZ2wuZ2V0RXh0ZW5zaW9uKFwiRVhUX3RleHR1cmVfZmlsdGVyX2FuaXNvdHJvcGljXCIpO1xuICAgICAgaWYgKCF0aGlzLmV4dFRleHR1cmVGaWx0ZXJBbmlzb3Ryb3BpYykge1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVGaWx0ZXJBbmlzb3Ryb3BpYyA9IGdsLmdldEV4dGVuc2lvbihcIldFQktJVF9FWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWNcIik7XG4gICAgICB9XG4gICAgICB0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQyA9IGdsLmdldEV4dGVuc2lvbihcIldFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9zM3RjXCIpO1xuICAgICAgaWYgKCF0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQykge1xuICAgICAgICB0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQyA9IGdsLmdldEV4dGVuc2lvbihcIldFQktJVF9XRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0Y1wiKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQyAmJiBfaXNJRSgpKSB7XG4gICAgICAgIHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVTM1RDID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVMzVEMpIHtcbiAgICAgICAgdmFyIGZvcm1hdHMgPSBnbC5nZXRQYXJhbWV0ZXIoZ2wuQ09NUFJFU1NFRF9URVhUVVJFX0ZPUk1BVFMpO1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCBmb3JtYXRzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICBzd2l0Y2goZm9ybWF0c1tpXSkge1xuICAgICAgICAgICAgY2FzZSB0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQy5DT01QUkVTU0VEX1JHQl9TM1RDX0RYVDFfRVhUOlxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVMzVEMuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUMV9FWFQ6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSB0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQy5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDpcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVTM1RDLkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDVfRVhUOlxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZUVUQzEgPSBnbC5nZXRFeHRlbnNpb24oXCJXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfZXRjMVwiKTtcbiAgICAgIHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVQVlJUQyA9IGdsLmdldEV4dGVuc2lvbihcIldFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0Y1wiKSB8fCBnbC5nZXRFeHRlbnNpb24oXCJXRUJLSVRfV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3B2cnRjXCIpO1xuICAgICAgdmFyIGNvbnRleHRBdHRyaWJzID0gZ2wuZ2V0Q29udGV4dEF0dHJpYnV0ZXMoKTtcbiAgICAgIHRoaXMuc3VwcG9ydHNNc2FhID0gY29udGV4dEF0dHJpYnMuYW50aWFsaWFzO1xuICAgICAgdGhpcy5zdXBwb3J0c1N0ZW5jaWwgPSBjb250ZXh0QXR0cmlicy5zdGVuY2lsO1xuICAgICAgdGhpcy5yZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgICAgdGhpcy5zY29wZSA9IG5ldyBwYy5TY29wZVNwYWNlKFwiRGV2aWNlXCIpO1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbiA9IHt9O1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9CT09MXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIGlmICh1bmlmb3JtLnZhbHVlICE9PSB2YWx1ZSkge1xuICAgICAgICAgIGdsLnVuaWZvcm0xaSh1bmlmb3JtLmxvY2F0aW9uSWQsIHZhbHVlKTtcbiAgICAgICAgICB1bmlmb3JtLnZhbHVlID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX0lOVF0gPSB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX0JPT0xdO1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9GTE9BVF0gPSBmdW5jdGlvbih1bmlmb3JtLCB2YWx1ZSkge1xuICAgICAgICBpZiAodW5pZm9ybS52YWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICBnbC51bmlmb3JtMWYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICAgICAgdW5pZm9ybS52YWx1ZSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9WRUMyXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIHVuaWZvcm1WYWx1ZSA9IHVuaWZvcm0udmFsdWU7XG4gICAgICAgIHNjb3BlWCA9IHZhbHVlWzBdO1xuICAgICAgICBzY29wZVkgPSB2YWx1ZVsxXTtcbiAgICAgICAgaWYgKHVuaWZvcm1WYWx1ZVswXSAhPT0gc2NvcGVYIHx8IHVuaWZvcm1WYWx1ZVsxXSAhPT0gc2NvcGVZKSB7XG4gICAgICAgICAgZ2wudW5pZm9ybTJmdih1bmlmb3JtLmxvY2F0aW9uSWQsIHZhbHVlKTtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbMF0gPSBzY29wZVg7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzFdID0gc2NvcGVZO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9WRUMzXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIHVuaWZvcm1WYWx1ZSA9IHVuaWZvcm0udmFsdWU7XG4gICAgICAgIHNjb3BlWCA9IHZhbHVlWzBdO1xuICAgICAgICBzY29wZVkgPSB2YWx1ZVsxXTtcbiAgICAgICAgc2NvcGVaID0gdmFsdWVbMl07XG4gICAgICAgIGlmICh1bmlmb3JtVmFsdWVbMF0gIT09IHNjb3BlWCB8fCB1bmlmb3JtVmFsdWVbMV0gIT09IHNjb3BlWSB8fCB1bmlmb3JtVmFsdWVbMl0gIT09IHNjb3BlWikge1xuICAgICAgICAgIGdsLnVuaWZvcm0zZnYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzBdID0gc2NvcGVYO1xuICAgICAgICAgIHVuaWZvcm1WYWx1ZVsxXSA9IHNjb3BlWTtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbMl0gPSBzY29wZVo7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX1ZFQzRdID0gZnVuY3Rpb24odW5pZm9ybSwgdmFsdWUpIHtcbiAgICAgICAgdW5pZm9ybVZhbHVlID0gdW5pZm9ybS52YWx1ZTtcbiAgICAgICAgc2NvcGVYID0gdmFsdWVbMF07XG4gICAgICAgIHNjb3BlWSA9IHZhbHVlWzFdO1xuICAgICAgICBzY29wZVogPSB2YWx1ZVsyXTtcbiAgICAgICAgc2NvcGVXID0gdmFsdWVbM107XG4gICAgICAgIGlmICh1bmlmb3JtVmFsdWVbMF0gIT09IHNjb3BlWCB8fCB1bmlmb3JtVmFsdWVbMV0gIT09IHNjb3BlWSB8fCB1bmlmb3JtVmFsdWVbMl0gIT09IHNjb3BlWiB8fCB1bmlmb3JtVmFsdWVbM10gIT09IHNjb3BlVykge1xuICAgICAgICAgIGdsLnVuaWZvcm00ZnYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzBdID0gc2NvcGVYO1xuICAgICAgICAgIHVuaWZvcm1WYWx1ZVsxXSA9IHNjb3BlWTtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbMl0gPSBzY29wZVo7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzNdID0gc2NvcGVXO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9JVkVDMl0gPSBmdW5jdGlvbih1bmlmb3JtLCB2YWx1ZSkge1xuICAgICAgICB1bmlmb3JtVmFsdWUgPSB1bmlmb3JtLnZhbHVlO1xuICAgICAgICBzY29wZVggPSB2YWx1ZVswXTtcbiAgICAgICAgc2NvcGVZID0gdmFsdWVbMV07XG4gICAgICAgIGlmICh1bmlmb3JtVmFsdWVbMF0gIT09IHNjb3BlWCB8fCB1bmlmb3JtVmFsdWVbMV0gIT09IHNjb3BlWSkge1xuICAgICAgICAgIGdsLnVuaWZvcm0yaXYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzBdID0gc2NvcGVYO1xuICAgICAgICAgIHVuaWZvcm1WYWx1ZVsxXSA9IHNjb3BlWTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHRoaXMuY29tbWl0RnVuY3Rpb25bcGMuVU5JRk9STVRZUEVfQlZFQzJdID0gdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9JVkVDMl07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX0lWRUMzXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIHVuaWZvcm1WYWx1ZSA9IHVuaWZvcm0udmFsdWU7XG4gICAgICAgIHNjb3BlWCA9IHZhbHVlWzBdO1xuICAgICAgICBzY29wZVkgPSB2YWx1ZVsxXTtcbiAgICAgICAgc2NvcGVaID0gdmFsdWVbMl07XG4gICAgICAgIGlmICh1bmlmb3JtVmFsdWVbMF0gIT09IHNjb3BlWCB8fCB1bmlmb3JtVmFsdWVbMV0gIT09IHNjb3BlWSB8fCB1bmlmb3JtVmFsdWVbMl0gIT09IHNjb3BlWikge1xuICAgICAgICAgIGdsLnVuaWZvcm0zaXYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzBdID0gc2NvcGVYO1xuICAgICAgICAgIHVuaWZvcm1WYWx1ZVsxXSA9IHNjb3BlWTtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbMl0gPSBzY29wZVo7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX0JWRUMzXSA9IHRoaXMuY29tbWl0RnVuY3Rpb25bcGMuVU5JRk9STVRZUEVfSVZFQzNdO1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9JVkVDNF0gPSBmdW5jdGlvbih1bmlmb3JtLCB2YWx1ZSkge1xuICAgICAgICB1bmlmb3JtVmFsdWUgPSB1bmlmb3JtLnZhbHVlO1xuICAgICAgICBzY29wZVggPSB2YWx1ZVswXTtcbiAgICAgICAgc2NvcGVZID0gdmFsdWVbMV07XG4gICAgICAgIHNjb3BlWiA9IHZhbHVlWzJdO1xuICAgICAgICBzY29wZVcgPSB2YWx1ZVszXTtcbiAgICAgICAgaWYgKHVuaWZvcm1WYWx1ZVswXSAhPT0gc2NvcGVYIHx8IHVuaWZvcm1WYWx1ZVsxXSAhPT0gc2NvcGVZIHx8IHVuaWZvcm1WYWx1ZVsyXSAhPT0gc2NvcGVaIHx8IHVuaWZvcm1WYWx1ZVszXSAhPT0gc2NvcGVXKSB7XG4gICAgICAgICAgZ2wudW5pZm9ybTRpdih1bmlmb3JtLmxvY2F0aW9uSWQsIHZhbHVlKTtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbMF0gPSBzY29wZVg7XG4gICAgICAgICAgdW5pZm9ybVZhbHVlWzFdID0gc2NvcGVZO1xuICAgICAgICAgIHVuaWZvcm1WYWx1ZVsyXSA9IHNjb3BlWjtcbiAgICAgICAgICB1bmlmb3JtVmFsdWVbM10gPSBzY29wZVc7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX0JWRUM0XSA9IHRoaXMuY29tbWl0RnVuY3Rpb25bcGMuVU5JRk9STVRZUEVfSVZFQzRdO1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9NQVQyXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIGdsLnVuaWZvcm1NYXRyaXgyZnYodW5pZm9ybS5sb2NhdGlvbklkLCBmYWxzZSwgdmFsdWUpO1xuICAgICAgfTtcbiAgICAgIHRoaXMuY29tbWl0RnVuY3Rpb25bcGMuVU5JRk9STVRZUEVfTUFUM10gPSBmdW5jdGlvbih1bmlmb3JtLCB2YWx1ZSkge1xuICAgICAgICBnbC51bmlmb3JtTWF0cml4M2Z2KHVuaWZvcm0ubG9jYXRpb25JZCwgZmFsc2UsIHZhbHVlKTtcbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1pdEZ1bmN0aW9uW3BjLlVOSUZPUk1UWVBFX01BVDRdID0gZnVuY3Rpb24odW5pZm9ybSwgdmFsdWUpIHtcbiAgICAgICAgZ2wudW5pZm9ybU1hdHJpeDRmdih1bmlmb3JtLmxvY2F0aW9uSWQsIGZhbHNlLCB2YWx1ZSk7XG4gICAgICB9O1xuICAgICAgdGhpcy5jb21taXRGdW5jdGlvbltwYy5VTklGT1JNVFlQRV9GTE9BVEFSUkFZXSA9IGZ1bmN0aW9uKHVuaWZvcm0sIHZhbHVlKSB7XG4gICAgICAgIGdsLnVuaWZvcm0xZnYodW5pZm9ybS5sb2NhdGlvbklkLCB2YWx1ZSk7XG4gICAgICB9O1xuICAgICAgdGhpcy5zZXRCbGVuZGluZyhmYWxzZSk7XG4gICAgICB0aGlzLnNldEJsZW5kRnVuY3Rpb24ocGMuQkxFTkRNT0RFX09ORSwgcGMuQkxFTkRNT0RFX1pFUk8pO1xuICAgICAgdGhpcy5zZXRCbGVuZEVxdWF0aW9uKHBjLkJMRU5ERVFVQVRJT05fQUREKTtcbiAgICAgIHRoaXMuc2V0Q29sb3JXcml0ZSh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTtcbiAgICAgIHRoaXMuY3VsbE1vZGUgPSBwYy5DVUxMRkFDRV9OT05FO1xuICAgICAgdGhpcy5zZXRDdWxsTW9kZShwYy5DVUxMRkFDRV9CQUNLKTtcbiAgICAgIHRoaXMuc2V0RGVwdGhUZXN0KHRydWUpO1xuICAgICAgdGhpcy5zZXREZXB0aEZ1bmMocGMuRlVOQ19MRVNTRVFVQUwpO1xuICAgICAgdGhpcy5zZXREZXB0aFdyaXRlKHRydWUpO1xuICAgICAgdGhpcy5zZXRTdGVuY2lsVGVzdChmYWxzZSk7XG4gICAgICB0aGlzLnNldFN0ZW5jaWxGdW5jKHBjLkZVTkNfQUxXQVlTLCAwLCAyNTUpO1xuICAgICAgdGhpcy5zZXRTdGVuY2lsT3BlcmF0aW9uKHBjLlNURU5DSUxPUF9LRUVQLCBwYy5TVEVOQ0lMT1BfS0VFUCwgcGMuU1RFTkNJTE9QX0tFRVAsIDI1NSk7XG4gICAgICB0aGlzLnNldEFscGhhVG9Db3ZlcmFnZShmYWxzZSk7XG4gICAgICB0aGlzLnNldFRyYW5zZm9ybUZlZWRiYWNrQnVmZmVyKG51bGwpO1xuICAgICAgdGhpcy5zZXRSYXN0ZXIodHJ1ZSk7XG4gICAgICB0aGlzLnNldERlcHRoQmlhcyhmYWxzZSk7XG4gICAgICB0aGlzLnNldENsZWFyRGVwdGgoMSk7XG4gICAgICB0aGlzLnNldENsZWFyQ29sb3IoMCwgMCwgMCwgMCk7XG4gICAgICB0aGlzLnNldENsZWFyU3RlbmNpbCgwKTtcbiAgICAgIGdsLmVuYWJsZShnbC5TQ0lTU09SX1RFU1QpO1xuICAgICAgdGhpcy5wcm9ncmFtTGliID0gbmV3IHBjLlByb2dyYW1MaWJyYXJ5KHRoaXMpO1xuICAgICAgZm9yICh2YXIgZ2VuZXJhdG9yIGluIHBjLnByb2dyYW1saWIpIHtcbiAgICAgICAgdGhpcy5wcm9ncmFtTGliLnJlZ2lzdGVyKGdlbmVyYXRvciwgcGMucHJvZ3JhbWxpYltnZW5lcmF0b3JdKTtcbiAgICAgIH1cbiAgICAgIHZhciBudW1Vbmlmb3JtcyA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVkVSVEVYX1VOSUZPUk1fVkVDVE9SUyk7XG4gICAgICBudW1Vbmlmb3JtcyAtPSA0ICogNDtcbiAgICAgIG51bVVuaWZvcm1zIC09IDg7XG4gICAgICBudW1Vbmlmb3JtcyAtPSAxO1xuICAgICAgbnVtVW5pZm9ybXMgLT0gNCAqIDQ7XG4gICAgICB0aGlzLmJvbmVMaW1pdCA9IE1hdGguZmxvb3IobnVtVW5pZm9ybXMgLyA0KTtcbiAgICAgIHRoaXMuYm9uZUxpbWl0ID0gTWF0aC5taW4odGhpcy5ib25lTGltaXQsIDEyOCk7XG4gICAgICBpZiAodGhpcy51bm1hc2tlZFJlbmRlcmVyID09PSBcIk1hbGktNDUwIE1QXCIpIHtcbiAgICAgICAgdGhpcy5ib25lTGltaXQgPSAzNDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLnVubWFza2VkUmVuZGVyZXIgPT09IFwiQXBwbGUgQTggR1BVXCIpIHtcbiAgICAgICAgICB0aGlzLmZvcmNlQ3B1UGFydGljbGVzID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgICAgIHRoaXMudnggPSB0aGlzLnZ5ID0gdGhpcy52dyA9IHRoaXMudmggPSAwO1xuICAgICAgdGhpcy5zeCA9IHRoaXMuc3kgPSB0aGlzLnN3ID0gdGhpcy5zaCA9IDA7XG4gICAgICB0aGlzLmJvdW5kQnVmZmVyID0gbnVsbDtcbiAgICAgIHRoaXMuaW5zdGFuY2VkQXR0cmlicyA9IHt9O1xuICAgICAgdGhpcy5hY3RpdmVGcmFtZWJ1ZmZlciA9IG51bGw7XG4gICAgICB0aGlzLmFjdGl2ZVRleHR1cmUgPSAwO1xuICAgICAgdGhpcy50ZXh0dXJlVW5pdHMgPSBbXTtcbiAgICAgIHRoaXMuYXR0cmlidXRlc0ludmFsaWRhdGVkID0gdHJ1ZTtcbiAgICAgIHRoaXMuZW5hYmxlZEF0dHJpYnV0ZXMgPSB7fTtcbiAgICAgIHRoaXMuX2RyYXdDYWxsc1BlckZyYW1lID0gMDtcbiAgICAgIHRoaXMuX3NoYWRlclN3aXRjaGVzUGVyRnJhbWUgPSAwO1xuICAgICAgdGhpcy5fcHJpbXNQZXJGcmFtZSA9IFtdO1xuICAgICAgZm9yIChpID0gcGMuUFJJTUlUSVZFX1BPSU5UUztpIDw9IHBjLlBSSU1JVElWRV9UUklGQU47aSsrKSB7XG4gICAgICAgIHRoaXMuX3ByaW1zUGVyRnJhbWVbaV0gPSAwO1xuICAgICAgfVxuICAgICAgdGhpcy5fcmVuZGVyVGFyZ2V0Q3JlYXRpb25UaW1lID0gMDtcbiAgICAgIHRoaXMuX3ZyYW0gPSB7dGV4OjAsIHZiOjAsIGliOjB9O1xuICAgICAgdGhpcy5fc2hhZGVyU3RhdHMgPSB7dnNDb21waWxlZDowLCBmc0NvbXBpbGVkOjAsIGxpbmtlZDowLCBtYXRlcmlhbFNoYWRlcnM6MCwgY29tcGlsZVRpbWU6MH07XG4gICAgICB2YXIgYnVmZmVySWQgPSBnbC5jcmVhdGVCdWZmZXIoKTtcbiAgICAgIHZhciBzdG9yYWdlID0gbmV3IEFycmF5QnVmZmVyKDE2KTtcbiAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBidWZmZXJJZCk7XG4gICAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RvcmFnZSwgZ2wuU1RBVElDX0RSQVcpO1xuICAgICAgZ2wuZ2V0RXJyb3IoKTtcbiAgICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoMCwgNCwgZ2wuVU5TSUdORURfQllURSwgZmFsc2UsIDQsIDApO1xuICAgICAgdGhpcy5zdXBwb3J0c1Vuc2lnbmVkQnl0ZSA9IGdsLmdldEVycm9yKCkgPT09IDA7XG4gICAgICBnbC5kZWxldGVCdWZmZXIoYnVmZmVySWQpO1xuICAgICAgdGhpcy5jb25zdGFudFRleFNvdXJjZSA9IHRoaXMuc2NvcGUucmVzb2x2ZShcInNvdXJjZVwiKTtcbiAgICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19DT0xPUlNQQUNFX0NPTlZFUlNJT05fV0VCR0wsIGdsLk5PTkUpO1xuICAgICAgaWYgKCFwYy5fYmVuY2htYXJrZWQpIHtcbiAgICAgICAgaWYgKHRoaXMuZXh0VGV4dHVyZUZsb2F0KSB7XG4gICAgICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgICAgICB0aGlzLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUgPSBnbC5nZXRFeHRlbnNpb24oXCJFWFRfY29sb3JfYnVmZmVyX2Zsb2F0XCIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUgPSB0ZXN0UmVuZGVyYWJsZShnbCwgdGhpcy5leHRUZXh0dXJlRmxvYXQsIGdsLkZMT0FUKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZXh0VGV4dHVyZUhhbGZGbG9hdCkge1xuICAgICAgICAgIGlmICh0aGlzLndlYmdsMikge1xuICAgICAgICAgICAgdGhpcy5leHRUZXh0dXJlSGFsZkZsb2F0UmVuZGVyYWJsZSA9IHRoaXMuZXh0VGV4dHVyZUZsb2F0UmVuZGVyYWJsZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5leHRUZXh0dXJlSGFsZkZsb2F0UmVuZGVyYWJsZSA9IHRlc3RSZW5kZXJhYmxlKGdsLCB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXQsIHRoaXMuZXh0VGV4dHVyZUhhbGZGbG9hdC5IQUxGX0ZMT0FUX09FUyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUpIHtcbiAgICAgICAgICB2YXIgZGV2aWNlID0gdGhpcztcbiAgICAgICAgICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICAgICAgICAgIHZhciB0ZXN0MSA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIGNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCBjaHVua3MucHJlY2lzaW9uVGVzdFBTLCBcInB0ZXN0MVwiKTtcbiAgICAgICAgICB2YXIgdGVzdDIgPSBjaHVua3MuY3JlYXRlU2hhZGVyRnJvbUNvZGUoZGV2aWNlLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgY2h1bmtzLnByZWNpc2lvblRlc3QyUFMsIFwicHRlc3QyXCIpO1xuICAgICAgICAgIHZhciBzaXplID0gMTtcbiAgICAgICAgICB2YXIgdGV4ID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7Zm9ybWF0OnBjLlBJWEVMRk9STUFUX1JHQkEzMkYsIHdpZHRoOnNpemUsIGhlaWdodDpzaXplLCBtaXBtYXBzOmZhbHNlLCBtaW5GaWx0ZXI6cGMuRklMVEVSX05FQVJFU1QsIG1hZ0ZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVH0pO1xuICAgICAgICAgIHZhciB0YXJnID0gbmV3IHBjLlJlbmRlclRhcmdldChkZXZpY2UsIHRleCwge2RlcHRoOmZhbHNlfSk7XG4gICAgICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKGRldmljZSwgdGFyZywgdGVzdDEpO1xuICAgICAgICAgIHZhciB0ZXgyID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7Zm9ybWF0OnBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCB3aWR0aDpzaXplLCBoZWlnaHQ6c2l6ZSwgbWlwbWFwczpmYWxzZSwgbWluRmlsdGVyOnBjLkZJTFRFUl9ORUFSRVNULCBtYWdGaWx0ZXI6cGMuRklMVEVSX05FQVJFU1R9KTtcbiAgICAgICAgICB2YXIgdGFyZzIgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGRldmljZSwgdGV4Miwge2RlcHRoOmZhbHNlfSk7XG4gICAgICAgICAgdGhpcy5jb25zdGFudFRleFNvdXJjZS5zZXRWYWx1ZSh0ZXgpO1xuICAgICAgICAgIHBjLmRyYXdRdWFkV2l0aFNoYWRlcihkZXZpY2UsIHRhcmcyLCB0ZXN0Mik7XG4gICAgICAgICAgdmFyIHBpeGVscyA9IG5ldyBVaW50OEFycmF5KHNpemUgKiBzaXplICogNCk7XG4gICAgICAgICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0YXJnMi5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICAgICAgZ2wucmVhZFBpeGVscygwLCAwLCBzaXplLCBzaXplLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBwaXhlbHMpO1xuICAgICAgICAgIHZhciB4ID0gcGl4ZWxzWzBdIC8gMjU1LjA7XG4gICAgICAgICAgdmFyIHkgPSBwaXhlbHNbMV0gLyAyNTUuMDtcbiAgICAgICAgICB2YXIgeiA9IHBpeGVsc1syXSAvIDI1NS4wO1xuICAgICAgICAgIHZhciB3ID0gcGl4ZWxzWzNdIC8gMjU1LjA7XG4gICAgICAgICAgdmFyIGYgPSB4IC8gKDI1Ni4wICogMjU2LjAgKiAyNTYuMCkgKyB5IC8gKDI1Ni4wICogMjU2LjApICsgeiAvIDI1Ni4wICsgdztcbiAgICAgICAgICB0aGlzLmV4dFRleHR1cmVGbG9hdEhpZ2hQcmVjaXNpb24gPSBmID09PSAwLjA7XG4gICAgICAgICAgdGV4LmRlc3Ryb3koKTtcbiAgICAgICAgICB0YXJnLmRlc3Ryb3koKTtcbiAgICAgICAgICB0ZXgyLmRlc3Ryb3koKTtcbiAgICAgICAgICB0YXJnMi5kZXN0cm95KCk7XG4gICAgICAgICAgcGMuZGVzdHJveVBvc3RFZmZlY3RRdWFkKCk7XG4gICAgICAgICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBudWxsKTtcbiAgICAgICAgfVxuICAgICAgICBwYy5leHRUZXh0dXJlRmxvYXRSZW5kZXJhYmxlID0gdGhpcy5leHRUZXh0dXJlRmxvYXRSZW5kZXJhYmxlO1xuICAgICAgICBwYy5leHRUZXh0dXJlSGFsZkZsb2F0UmVuZGVyYWJsZSA9IHRoaXMuZXh0VGV4dHVyZUhhbGZGbG9hdFJlbmRlcmFibGU7XG4gICAgICAgIHBjLmV4dFRleHR1cmVGbG9hdEhpZ2hQcmVjaXNpb24gPSB0aGlzLmV4dFRleHR1cmVGbG9hdEhpZ2hQcmVjaXNpb247XG4gICAgICAgIHBjLl9iZW5jaG1hcmtlZCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUgPSBwYy5leHRUZXh0dXJlRmxvYXRSZW5kZXJhYmxlO1xuICAgICAgICB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXRSZW5kZXJhYmxlID0gcGMuZXh0VGV4dHVyZUhhbGZGbG9hdFJlbmRlcmFibGU7XG4gICAgICAgIHRoaXMuZXh0VGV4dHVyZUZsb2F0SGlnaFByZWNpc2lvbiA9IHBjLmV4dFRleHR1cmVGbG9hdEhpZ2hQcmVjaXNpb247XG4gICAgICB9XG4gICAgfSkuY2FsbCh0aGlzKTtcbiAgfTtcbiAgR3JhcGhpY3NEZXZpY2UucHJvdG90eXBlID0ge3VwZGF0ZUNsaWVudFJlY3Q6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jbGllbnRSZWN0ID0gdGhpcy5jYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIH0sIHNldFZpZXdwb3J0OmZ1bmN0aW9uKHgsIHksIHcsIGgpIHtcbiAgICBpZiAodGhpcy52eCAhPT0geCB8fCB0aGlzLnZ5ICE9PSB5IHx8IHRoaXMudncgIT09IHcgfHwgdGhpcy52aCAhPT0gaCkge1xuICAgICAgdGhpcy5nbC52aWV3cG9ydCh4LCB5LCB3LCBoKTtcbiAgICAgIHRoaXMudnggPSB4O1xuICAgICAgdGhpcy52eSA9IHk7XG4gICAgICB0aGlzLnZ3ID0gdztcbiAgICAgIHRoaXMudmggPSBoO1xuICAgIH1cbiAgfSwgc2V0U2Npc3NvcjpmdW5jdGlvbih4LCB5LCB3LCBoKSB7XG4gICAgaWYgKHRoaXMuc3ggIT09IHggfHwgdGhpcy5zeSAhPT0geSB8fCB0aGlzLnN3ICE9PSB3IHx8IHRoaXMuc2ggIT09IGgpIHtcbiAgICAgIHRoaXMuZ2wuc2Npc3Nvcih4LCB5LCB3LCBoKTtcbiAgICAgIHRoaXMuc3ggPSB4O1xuICAgICAgdGhpcy5zeSA9IHk7XG4gICAgICB0aGlzLnN3ID0gdztcbiAgICAgIHRoaXMuc2ggPSBoO1xuICAgIH1cbiAgfSwgZ2V0UHJvZ3JhbUxpYnJhcnk6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvZ3JhbUxpYjtcbiAgfSwgc2V0UHJvZ3JhbUxpYnJhcnk6ZnVuY3Rpb24ocHJvZ3JhbUxpYikge1xuICAgIHRoaXMucHJvZ3JhbUxpYiA9IHByb2dyYW1MaWI7XG4gIH0sIHNldEZyYW1lYnVmZmVyOmZ1bmN0aW9uKGZiKSB7XG4gICAgaWYgKHRoaXMuYWN0aXZlRnJhbWVidWZmZXIgIT09IGZiKSB7XG4gICAgICB0aGlzLmdsLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLmdsLkZSQU1FQlVGRkVSLCBmYik7XG4gICAgICB0aGlzLmFjdGl2ZUZyYW1lYnVmZmVyID0gZmI7XG4gICAgfVxuICB9LCBfY2hlY2tGYm86ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICB2YXIgc3RhdHVzID0gZ2wuY2hlY2tGcmFtZWJ1ZmZlclN0YXR1cyhnbC5GUkFNRUJVRkZFUik7XG4gICAgc3dpdGNoKHN0YXR1cykge1xuICAgICAgY2FzZSBnbC5GUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQ6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogRlJBTUVCVUZGRVJfSU5DT01QTEVURV9BVFRBQ0hNRU5UXCIpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgZ2wuRlJBTUVCVUZGRVJfSU5DT01QTEVURV9NSVNTSU5HX0FUVEFDSE1FTlQ6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogRlJBTUVCVUZGRVJfSU5DT01QTEVURV9NSVNTSU5HX0FUVEFDSE1FTlRcIik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBnbC5GUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlM6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogRlJBTUVCVUZGRVJfSU5DT01QTEVURV9ESU1FTlNJT05TXCIpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgZ2wuRlJBTUVCVUZGRVJfVU5TVVBQT1JURUQ6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogRlJBTUVCVUZGRVJfVU5TVVBQT1JURURcIik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBnbC5GUkFNRUJVRkZFUl9DT01QTEVURTpcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH0sIGNvcHlSZW5kZXJUYXJnZXQ6ZnVuY3Rpb24oc291cmNlLCBkZXN0LCBjb2xvciwgZGVwdGgpIHtcbiAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgIHZhciBzaGFkZXJDb3B5ID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLndlYmdsMiAmJiBkZXB0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoY29sb3IpIHtcbiAgICAgIGlmICghc291cmNlLl9jb2xvckJ1ZmZlciB8fCAhZGVzdC5fY29sb3JCdWZmZXIpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHNvdXJjZS5fY29sb3JCdWZmZXIuX2Zvcm1hdCAhPT0gZGVzdC5fY29sb3JCdWZmZXIuX2Zvcm1hdCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChkZXB0aCkge1xuICAgICAgaWYgKCFzb3VyY2UuX2RlcHRoQnVmZmVyIHx8ICFkZXN0Ll9kZXB0aEJ1ZmZlcikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoc291cmNlLl9kZXB0aEJ1ZmZlci5fZm9ybWF0ICE9PSBkZXN0Ll9kZXB0aEJ1ZmZlci5fZm9ybWF0KSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICB2YXIgcHJldlJ0ID0gdGhpcy5yZW5kZXJUYXJnZXQ7XG4gICAgICB0aGlzLnJlbmRlclRhcmdldCA9IGRlc3Q7XG4gICAgICB0aGlzLnVwZGF0ZUJlZ2luKCk7XG4gICAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuUkVBRF9GUkFNRUJVRkZFUiwgc291cmNlID8gc291cmNlLl9nbEZyYW1lQnVmZmVyIDogbnVsbCk7XG4gICAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRFJBV19GUkFNRUJVRkZFUiwgZGVzdC5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICB2YXIgdyA9IHNvdXJjZSA/IHNvdXJjZS53aWR0aCA6IGRlc3Qud2lkdGg7XG4gICAgICB2YXIgaCA9IHNvdXJjZSA/IHNvdXJjZS5oZWlnaHQgOiBkZXN0LmhlaWdodDtcbiAgICAgIGdsLmJsaXRGcmFtZWJ1ZmZlcigwLCAwLCB3LCBoLCAwLCAwLCB3LCBoLCAoY29sb3IgPyBnbC5DT0xPUl9CVUZGRVJfQklUIDogMCkgfCAoZGVwdGggPyBnbC5ERVBUSF9CVUZGRVJfQklUIDogMCksIGdsLk5FQVJFU1QpO1xuICAgICAgdGhpcy5yZW5kZXJUYXJnZXQgPSBwcmV2UnQ7XG4gICAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHByZXZSdCA/IHByZXZSdC5fZ2xGcmFtZUJ1ZmZlciA6IG51bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMuX2NvcHlTaGFkZXIpIHtcbiAgICAgICAgdmFyIGNodW5rcyA9IHBjLnNoYWRlckNodW5rcztcbiAgICAgICAgdGhpcy5fY29weVNoYWRlciA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZSh0aGlzLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgY2h1bmtzLm91dHB1dFRleDJEUFMsIFwib3V0cHV0VGV4MkRcIik7XG4gICAgICB9XG4gICAgICB0aGlzLmNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHNvdXJjZS5fY29sb3JCdWZmZXIpO1xuICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKHRoaXMsIGRlc3QsIHRoaXMuX2NvcHlTaGFkZXIpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSwgdXBkYXRlQmVnaW46ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICB0aGlzLmJvdW5kQnVmZmVyID0gbnVsbDtcbiAgICB0aGlzLmluZGV4QnVmZmVyID0gbnVsbDtcbiAgICB2YXIgdGFyZ2V0ID0gdGhpcy5yZW5kZXJUYXJnZXQ7XG4gICAgaWYgKHRhcmdldCkge1xuICAgICAgaWYgKCF0YXJnZXQuX2dsRnJhbWVCdWZmZXIpIHtcbiAgICAgICAgdGFyZ2V0Ll9kZXZpY2UgPSB0aGlzO1xuICAgICAgICB0YXJnZXQuX2dsRnJhbWVCdWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpO1xuICAgICAgICB0aGlzLnNldEZyYW1lYnVmZmVyKHRhcmdldC5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICAgIHZhciBjb2xvckJ1ZmZlciA9IHRhcmdldC5fY29sb3JCdWZmZXI7XG4gICAgICAgIGlmIChjb2xvckJ1ZmZlcikge1xuICAgICAgICAgIGlmICghY29sb3JCdWZmZXIuX2dsVGV4dHVyZUlkKSB7XG4gICAgICAgICAgICBjb2xvckJ1ZmZlci5fd2lkdGggPSBNYXRoLm1pbihjb2xvckJ1ZmZlci53aWR0aCwgdGhpcy5tYXhSZW5kZXJCdWZmZXJTaXplKTtcbiAgICAgICAgICAgIGNvbG9yQnVmZmVyLl9oZWlnaHQgPSBNYXRoLm1pbihjb2xvckJ1ZmZlci5oZWlnaHQsIHRoaXMubWF4UmVuZGVyQnVmZmVyU2l6ZSk7XG4gICAgICAgICAgICB0aGlzLnNldFRleHR1cmUoY29sb3JCdWZmZXIsIDApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBnbC5mcmFtZWJ1ZmZlclRleHR1cmUyRChnbC5GUkFNRUJVRkZFUiwgZ2wuQ09MT1JfQVRUQUNITUVOVDAsIGNvbG9yQnVmZmVyLl9jdWJlbWFwID8gZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgdGFyZ2V0Ll9mYWNlIDogZ2wuVEVYVFVSRV8yRCwgY29sb3JCdWZmZXIuX2dsVGV4dHVyZUlkLCAwKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgZGVwdGhCdWZmZXIgPSB0YXJnZXQuX2RlcHRoQnVmZmVyO1xuICAgICAgICBpZiAoZGVwdGhCdWZmZXIgJiYgdGhpcy53ZWJnbDIpIHtcbiAgICAgICAgICBpZiAoIWRlcHRoQnVmZmVyLl9nbFRleHR1cmVJZCkge1xuICAgICAgICAgICAgZGVwdGhCdWZmZXIuX3dpZHRoID0gTWF0aC5taW4oZGVwdGhCdWZmZXIud2lkdGgsIHRoaXMubWF4UmVuZGVyQnVmZmVyU2l6ZSk7XG4gICAgICAgICAgICBkZXB0aEJ1ZmZlci5faGVpZ2h0ID0gTWF0aC5taW4oZGVwdGhCdWZmZXIuaGVpZ2h0LCB0aGlzLm1heFJlbmRlckJ1ZmZlclNpemUpO1xuICAgICAgICAgICAgdGhpcy5zZXRUZXh0dXJlKGRlcHRoQnVmZmVyLCAwKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRhcmdldC5fc3RlbmNpbCkge1xuICAgICAgICAgICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCwgZGVwdGhCdWZmZXIuX2N1YmVtYXAgPyBnbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyB0YXJnZXQuX2ZhY2UgOiBnbC5URVhUVVJFXzJELCB0YXJnZXQuX2RlcHRoQnVmZmVyLl9nbFRleHR1cmVJZCwgMCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGdsLkZSQU1FQlVGRkVSLCBnbC5ERVBUSF9BVFRBQ0hNRU5ULCBkZXB0aEJ1ZmZlci5fY3ViZW1hcCA/IGdsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIHRhcmdldC5fZmFjZSA6IGdsLlRFWFRVUkVfMkQsIHRhcmdldC5fZGVwdGhCdWZmZXIuX2dsVGV4dHVyZUlkLCAwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHRhcmdldC5fZGVwdGgpIHtcbiAgICAgICAgICAgIHZhciB3aWxsUmVuZGVyTXNhYSA9IHRhcmdldC5fc2FtcGxlcyA+IDEgJiYgdGhpcy53ZWJnbDI7XG4gICAgICAgICAgICBpZiAoIXdpbGxSZW5kZXJNc2FhKSB7XG4gICAgICAgICAgICAgIGlmICghdGFyZ2V0Ll9nbERlcHRoQnVmZmVyKSB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0Ll9nbERlcHRoQnVmZmVyID0gZ2wuY3JlYXRlUmVuZGVyYnVmZmVyKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZ2wuYmluZFJlbmRlcmJ1ZmZlcihnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fZ2xEZXB0aEJ1ZmZlcik7XG4gICAgICAgICAgICAgIGlmICh0YXJnZXQuX3N0ZW5jaWwpIHtcbiAgICAgICAgICAgICAgICBnbC5yZW5kZXJidWZmZXJTdG9yYWdlKGdsLlJFTkRFUkJVRkZFUiwgZ2wuREVQVEhfU1RFTkNJTCwgdGFyZ2V0LndpZHRoLCB0YXJnZXQuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICBnbC5mcmFtZWJ1ZmZlclJlbmRlcmJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgZ2wuREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5ULCBnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fZ2xEZXB0aEJ1ZmZlcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZ2wucmVuZGVyYnVmZmVyU3RvcmFnZShnbC5SRU5ERVJCVUZGRVIsIGdsLkRFUFRIX0NPTVBPTkVOVDE2LCB0YXJnZXQud2lkdGgsIHRhcmdldC5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBnbC5ERVBUSF9BVFRBQ0hNRU5ULCBnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fZ2xEZXB0aEJ1ZmZlcik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZ2wuYmluZFJlbmRlcmJ1ZmZlcihnbC5SRU5ERVJCVUZGRVIsIG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy53ZWJnbDIgJiYgdGFyZ2V0Ll9zYW1wbGVzID4gMSkge1xuICAgICAgICAgIHRhcmdldC5fZ2xSZXNvbHZlRnJhbWVCdWZmZXIgPSB0YXJnZXQuX2dsRnJhbWVCdWZmZXI7XG4gICAgICAgICAgdGFyZ2V0Ll9nbEZyYW1lQnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTtcbiAgICAgICAgICB0aGlzLnNldEZyYW1lYnVmZmVyKHRhcmdldC5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICAgICAgaWYgKGNvbG9yQnVmZmVyKSB7XG4gICAgICAgICAgICBpZiAoIXRhcmdldC5fZ2xNc2FhQ29sb3JCdWZmZXIpIHtcbiAgICAgICAgICAgICAgdGFyZ2V0Ll9nbE1zYWFDb2xvckJ1ZmZlciA9IGdsLmNyZWF0ZVJlbmRlcmJ1ZmZlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZ2wuYmluZFJlbmRlcmJ1ZmZlcihnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fZ2xNc2FhQ29sb3JCdWZmZXIpO1xuICAgICAgICAgICAgZ2wucmVuZGVyYnVmZmVyU3RvcmFnZU11bHRpc2FtcGxlKGdsLlJFTkRFUkJVRkZFUiwgdGFyZ2V0Ll9zYW1wbGVzLCBjb2xvckJ1ZmZlci5fZ2xJbnRlcm5hbEZvcm1hdCwgdGFyZ2V0LndpZHRoLCB0YXJnZXQuaGVpZ2h0KTtcbiAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBnbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2wuUkVOREVSQlVGRkVSLCB0YXJnZXQuX2dsTXNhYUNvbG9yQnVmZmVyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRhcmdldC5fZGVwdGgpIHtcbiAgICAgICAgICAgIGlmICghdGFyZ2V0Ll9nbE1zYWFEZXB0aEJ1ZmZlcikge1xuICAgICAgICAgICAgICB0YXJnZXQuX2dsTXNhYURlcHRoQnVmZmVyID0gZ2wuY3JlYXRlUmVuZGVyYnVmZmVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBnbC5iaW5kUmVuZGVyYnVmZmVyKGdsLlJFTkRFUkJVRkZFUiwgdGFyZ2V0Ll9nbE1zYWFEZXB0aEJ1ZmZlcik7XG4gICAgICAgICAgICBpZiAodGFyZ2V0Ll9zdGVuY2lsKSB7XG4gICAgICAgICAgICAgIGdsLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZShnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fc2FtcGxlcywgZ2wuREVQVEgyNF9TVEVOQ0lMOCwgdGFyZ2V0LndpZHRoLCB0YXJnZXQuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgZ2wuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIGdsLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCwgZ2wuUkVOREVSQlVGRkVSLCB0YXJnZXQuX2dsTXNhYURlcHRoQnVmZmVyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGdsLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZShnbC5SRU5ERVJCVUZGRVIsIHRhcmdldC5fc2FtcGxlcywgZ2wuREVQVEhfQ09NUE9ORU5UMzJGLCB0YXJnZXQud2lkdGgsIHRhcmdldC5oZWlnaHQpO1xuICAgICAgICAgICAgICBnbC5mcmFtZWJ1ZmZlclJlbmRlcmJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgZ2wuREVQVEhfQVRUQUNITUVOVCwgZ2wuUkVOREVSQlVGRkVSLCB0YXJnZXQuX2dsTXNhYURlcHRoQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2V0RnJhbWVidWZmZXIodGFyZ2V0Ll9nbEZyYW1lQnVmZmVyKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRGcmFtZWJ1ZmZlcihudWxsKTtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDE2O2krKykge1xuICAgICAgdGhpcy50ZXh0dXJlVW5pdHNbaV0gPSBudWxsO1xuICAgIH1cbiAgfSwgdXBkYXRlRW5kOmZ1bmN0aW9uKCkge1xuICAgIHZhciBnbCA9IHRoaXMuZ2w7XG4gICAgdmFyIHRhcmdldCA9IHRoaXMucmVuZGVyVGFyZ2V0O1xuICAgIGlmICh0YXJnZXQpIHtcbiAgICAgIHZhciBjb2xvckJ1ZmZlciA9IHRhcmdldC5fY29sb3JCdWZmZXI7XG4gICAgICBpZiAoY29sb3JCdWZmZXIgJiYgY29sb3JCdWZmZXIuX2dsVGV4dHVyZUlkICYmIGNvbG9yQnVmZmVyLm1pcG1hcHMgJiYgY29sb3JCdWZmZXIuX3BvdCkge1xuICAgICAgICBnbC5iaW5kVGV4dHVyZShjb2xvckJ1ZmZlci5fZ2xUYXJnZXQsIGNvbG9yQnVmZmVyLl9nbFRleHR1cmVJZCk7XG4gICAgICAgIGdsLmdlbmVyYXRlTWlwbWFwKGNvbG9yQnVmZmVyLl9nbFRhcmdldCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy53ZWJnbDIgJiYgdGFyZ2V0Ll9zYW1wbGVzID4gMSAmJiB0YXJnZXQuYXV0b1Jlc29sdmUpIHtcbiAgICAgICAgdGFyZ2V0LnJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGluaXRpYWxpemVUZXh0dXJlOmZ1bmN0aW9uKHRleHR1cmUpIHtcbiAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgIHZhciBleHQ7XG4gICAgdGV4dHVyZS5fZ2xUZXh0dXJlSWQgPSBnbC5jcmVhdGVUZXh0dXJlKCk7XG4gICAgdGV4dHVyZS5fZ2xUYXJnZXQgPSB0ZXh0dXJlLl9jdWJlbWFwID8gZ2wuVEVYVFVSRV9DVUJFX01BUCA6IHRleHR1cmUuX3ZvbHVtZSA/IGdsLlRFWFRVUkVfM0QgOiBnbC5URVhUVVJFXzJEO1xuICAgIHN3aXRjaCh0ZXh0dXJlLl9mb3JtYXQpIHtcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfQTg6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuQUxQSEE7XG4gICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5BTFBIQTtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9CWVRFO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfTDg6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuTFVNSU5BTkNFO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuTFVNSU5BTkNFO1xuICAgICAgICB0ZXh0dXJlLl9nbFBpeGVsVHlwZSA9IGdsLlVOU0lHTkVEX0JZVEU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9MOF9BODpcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5MVU1JTkFOQ0VfQUxQSEE7XG4gICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5MVU1JTkFOQ0VfQUxQSEE7XG4gICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZ2wuVU5TSUdORURfQllURTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1I1X0c2X0I1OlxuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9TSE9SVF81XzZfNTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1I1X0c1X0I1X0ExOlxuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQkE7XG4gICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbFBpeGVsVHlwZSA9IGdsLlVOU0lHTkVEX1NIT1JUXzVfNV81XzE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SNF9HNF9CNF9BNDpcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9TSE9SVF80XzRfNF80O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUjhfRzhfQjg6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICB0ZXh0dXJlLl9nbFBpeGVsVHlwZSA9IGdsLlVOU0lHTkVEX0JZVEU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BODpcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9CWVRFO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfRFhUMTpcbiAgICAgICAgZXh0ID0gdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVMzVEM7XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZXh0LkNPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9EWFQzOlxuICAgICAgICBleHQgPSB0aGlzLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQztcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZXh0LkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDNfRVhUO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfRFhUNTpcbiAgICAgICAgZXh0ID0gdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVMzVEM7XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGV4dC5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQ1X0VYVDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX0VUQzE6XG4gICAgICAgIGV4dCA9IHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVFVEMxO1xuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGV4dC5DT01QUkVTU0VEX1JHQl9FVEMxX1dFQkdMO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JfMTpcbiAgICAgICAgZXh0ID0gdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVBWUlRDO1xuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGV4dC5DT01QUkVTU0VEX1JHQl9QVlJUQ18yQlBQVjFfSU1HO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JBXzE6XG4gICAgICAgIGV4dCA9IHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVQVlJUQztcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZXh0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ18yQlBQVjFfSU1HO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JfMTpcbiAgICAgICAgZXh0ID0gdGhpcy5leHRDb21wcmVzc2VkVGV4dHVyZVBWUlRDO1xuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGV4dC5DT01QUkVTU0VEX1JHQl9QVlJUQ180QlBQVjFfSU1HO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JBXzE6XG4gICAgICAgIGV4dCA9IHRoaXMuZXh0Q29tcHJlc3NlZFRleHR1cmVQVlJUQztcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZXh0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfUkdCMTZGOlxuICAgICAgICBleHQgPSB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXQ7XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICBpZiAodGhpcy53ZWJnbDIpIHtcbiAgICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCMTZGO1xuICAgICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZ2wuSEFMRl9GTE9BVDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZXh0LkhBTEZfRkxPQVRfT0VTO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SR0JBMTZGOlxuICAgICAgICBleHQgPSB0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXQ7XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlJHQkExNkY7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5IQUxGX0ZMT0FUO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5SR0JBO1xuICAgICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZXh0LkhBTEZfRkxPQVRfT0VTO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9SR0IzMkY6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCO1xuICAgICAgICBpZiAodGhpcy53ZWJnbDIpIHtcbiAgICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUkdCMzJGO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5SR0I7XG4gICAgICAgIH1cbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5GTE9BVDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1JHQkEzMkY6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlJHQkEzMkY7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlJHQkE7XG4gICAgICAgIH1cbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5GTE9BVDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX1IzMkY6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkVEO1xuICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuUjMyRjtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5GTE9BVDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLlBJWEVMRk9STUFUX0RFUFRIOlxuICAgICAgICBpZiAodGhpcy53ZWJnbDIpIHtcbiAgICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLkRFUFRIX0NPTVBPTkVOVDtcbiAgICAgICAgICB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0ID0gZ2wuREVQVEhfQ09NUE9ORU5UMzJGO1xuICAgICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZ2wuRkxPQVQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5ERVBUSF9DT01QT05FTlQ7XG4gICAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLkRFUFRIX0NPTVBPTkVOVDtcbiAgICAgICAgICB0ZXh0dXJlLl9nbFBpeGVsVHlwZSA9IGdsLlVOU0lHTkVEX1NIT1JUO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF9ERVBUSFNURU5DSUw6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuREVQVEhfU1RFTkNJTDtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLkRFUFRIMjRfU1RFTkNJTDg7XG4gICAgICAgIHRleHR1cmUuX2dsUGl4ZWxUeXBlID0gZ2wuVU5TSUdORURfSU5UXzI0Xzg7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5QSVhFTEZPUk1BVF8xMTExMTBGOlxuICAgICAgICB0ZXh0dXJlLl9nbEZvcm1hdCA9IGdsLlJHQjtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlIxMUZfRzExRl9CMTBGO1xuICAgICAgICB0ZXh0dXJlLl9nbFBpeGVsVHlwZSA9IGdsLkZMT0FUO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfU1JHQjpcbiAgICAgICAgdGV4dHVyZS5fZ2xGb3JtYXQgPSBnbC5SR0I7XG4gICAgICAgIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQgPSBnbC5TUkdCODtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9CWVRFO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuUElYRUxGT1JNQVRfU1JHQkE6XG4gICAgICAgIHRleHR1cmUuX2dsRm9ybWF0ID0gZ2wuUkdCQTtcbiAgICAgICAgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCA9IGdsLlNSR0I4X0FMUEhBODtcbiAgICAgICAgdGV4dHVyZS5fZ2xQaXhlbFR5cGUgPSBnbC5VTlNJR05FRF9CWVRFO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH0sIHVwbG9hZFRleHR1cmU6ZnVuY3Rpb24odGV4dHVyZSkge1xuICAgIHZhciBnbCA9IHRoaXMuZ2w7XG4gICAgaWYgKCF0ZXh0dXJlLl9uZWVkc1VwbG9hZCAmJiAodGV4dHVyZS5fbmVlZHNNaXBtYXBzVXBsb2FkICYmIHRleHR1cmUuX21pcG1hcHNVcGxvYWRlZCB8fCAhdGV4dHVyZS5fcG90KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbWlwTGV2ZWwgPSAwO1xuICAgIHZhciBtaXBPYmplY3Q7XG4gICAgdmFyIHJlc011bHQ7XG4gICAgd2hpbGUgKHRleHR1cmUuX2xldmVsc1ttaXBMZXZlbF0gfHwgbWlwTGV2ZWwgPT09IDApIHtcbiAgICAgIGlmICghdGV4dHVyZS5fbmVlZHNVcGxvYWQgJiYgbWlwTGV2ZWwgPT09IDApIHtcbiAgICAgICAgbWlwTGV2ZWwrKztcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobWlwTGV2ZWwgJiYgKCF0ZXh0dXJlLl9uZWVkc01pcG1hcHNVcGxvYWQgfHwgIXRleHR1cmUuX21pcG1hcHMpKSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG1pcE9iamVjdCA9IHRleHR1cmUuX2xldmVsc1ttaXBMZXZlbF07XG4gICAgICBpZiAobWlwTGV2ZWwgPT0gMSAmJiAhdGV4dHVyZS5fY29tcHJlc3NlZCkge1xuICAgICAgICBnbC5nZW5lcmF0ZU1pcG1hcCh0ZXh0dXJlLl9nbFRhcmdldCk7XG4gICAgICAgIHRleHR1cmUuX21pcG1hcHNVcGxvYWRlZCA9IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAodGV4dHVyZS5fY3ViZW1hcCkge1xuICAgICAgICB2YXIgZmFjZTtcbiAgICAgICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpO1xuICAgICAgICBnbC5waXhlbFN0b3JlaShnbC5VTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0wsIGZhbHNlKTtcbiAgICAgICAgaWYgKG1pcE9iamVjdFswXSBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50IHx8IG1pcE9iamVjdFswXSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgfHwgbWlwT2JqZWN0WzBdIGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCkge1xuICAgICAgICAgIGZvciAoZmFjZSA9IDA7ZmFjZSA8IDY7ZmFjZSsrKSB7XG4gICAgICAgICAgICBpZiAoIXRleHR1cmUuX2xldmVsc1VwZGF0ZWRbMF1bZmFjZV0pIHtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc3JjID0gbWlwT2JqZWN0W2ZhY2VdO1xuICAgICAgICAgICAgaWYgKHNyYyBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgaWYgKHNyYy53aWR0aCA+IHRoaXMubWF4Q3ViZU1hcFNpemUgfHwgc3JjLmhlaWdodCA+IHRoaXMubWF4Q3ViZU1hcFNpemUpIHtcbiAgICAgICAgICAgICAgICBzcmMgPSBfZG93bnNhbXBsZUltYWdlKHNyYywgdGhpcy5tYXhDdWJlTWFwU2l6ZSk7XG4gICAgICAgICAgICAgICAgaWYgKG1pcExldmVsID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICB0ZXh0dXJlLndpZHRoID0gc3JjLndpZHRoO1xuICAgICAgICAgICAgICAgICAgdGV4dHVyZS5oZWlnaHQgPSBzcmMuaGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBmYWNlLCBtaXBMZXZlbCwgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCwgdGV4dHVyZS5fZ2xGb3JtYXQsIHRleHR1cmUuX2dsUGl4ZWxUeXBlLCBzcmMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNNdWx0ID0gMSAvIE1hdGgucG93KDIsIG1pcExldmVsKTtcbiAgICAgICAgICBmb3IgKGZhY2UgPSAwO2ZhY2UgPCA2O2ZhY2UrKykge1xuICAgICAgICAgICAgaWYgKCF0ZXh0dXJlLl9sZXZlbHNVcGRhdGVkWzBdW2ZhY2VdKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRleERhdGEgPSBtaXBPYmplY3RbZmFjZV07XG4gICAgICAgICAgICBpZiAodGV4dHVyZS5fY29tcHJlc3NlZCkge1xuICAgICAgICAgICAgICBnbC5jb21wcmVzc2VkVGV4SW1hZ2UyRChnbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBmYWNlLCBtaXBMZXZlbCwgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCwgTWF0aC5tYXgodGV4dHVyZS5fd2lkdGggKiByZXNNdWx0LCAxKSwgTWF0aC5tYXgodGV4dHVyZS5faGVpZ2h0ICogcmVzTXVsdCwgMSksIDAsIHRleERhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBmYWNlLCBtaXBMZXZlbCwgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCwgTWF0aC5tYXgodGV4dHVyZS5fd2lkdGggKiByZXNNdWx0LCAxKSwgTWF0aC5tYXgodGV4dHVyZS5faGVpZ2h0ICogcmVzTXVsdCwgMSksIDAsIHRleHR1cmUuX2dsRm9ybWF0LCB0ZXh0dXJlLl9nbFBpeGVsVHlwZSwgdGV4RGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGV4dHVyZS5fdm9sdW1lKSB7XG4gICAgICAgICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpO1xuICAgICAgICAgIHJlc011bHQgPSAxIC8gTWF0aC5wb3coMiwgbWlwTGV2ZWwpO1xuICAgICAgICAgIGlmICh0ZXh0dXJlLl9jb21wcmVzc2VkKSB7XG4gICAgICAgICAgICBnbC5jb21wcmVzc2VkVGV4SW1hZ2UzRChnbC5URVhUVVJFXzNELCBtaXBMZXZlbCwgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCwgTWF0aC5tYXgodGV4dHVyZS5fd2lkdGggKiByZXNNdWx0LCAxKSwgTWF0aC5tYXgodGV4dHVyZS5faGVpZ2h0ICogcmVzTXVsdCwgMSksIE1hdGgubWF4KHRleHR1cmUuX2RlcHRoICogcmVzTXVsdCwgMSksIDAsIG1pcE9iamVjdCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGdsLnRleEltYWdlM0QoZ2wuVEVYVFVSRV8zRCwgbWlwTGV2ZWwsIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQsIE1hdGgubWF4KHRleHR1cmUuX3dpZHRoICogcmVzTXVsdCwgMSksIE1hdGgubWF4KHRleHR1cmUuX2hlaWdodCAqIHJlc011bHQsIDEpLCBNYXRoLm1heCh0ZXh0dXJlLl9kZXB0aCAqIHJlc011bHQsIDEpLCAwLCB0ZXh0dXJlLl9nbEZvcm1hdCwgdGV4dHVyZS5fZ2xQaXhlbFR5cGUsIG1pcE9iamVjdCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChtaXBPYmplY3QgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCB8fCBtaXBPYmplY3QgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50IHx8IG1pcE9iamVjdCBpbnN0YW5jZW9mIEhUTUxWaWRlb0VsZW1lbnQpIHtcbiAgICAgICAgICAgIGlmIChtaXBPYmplY3QgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7XG4gICAgICAgICAgICAgIGlmIChtaXBPYmplY3Qud2lkdGggPiB0aGlzLm1heFRleHR1cmVTaXplIHx8IG1pcE9iamVjdC5oZWlnaHQgPiB0aGlzLm1heFRleHR1cmVTaXplKSB7XG4gICAgICAgICAgICAgICAgbWlwT2JqZWN0ID0gX2Rvd25zYW1wbGVJbWFnZShtaXBPYmplY3QsIHRoaXMubWF4VGV4dHVyZVNpemUpO1xuICAgICAgICAgICAgICAgIGlmIChtaXBMZXZlbCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgdGV4dHVyZS53aWR0aCA9IG1pcE9iamVjdC53aWR0aDtcbiAgICAgICAgICAgICAgICAgIHRleHR1cmUuaGVpZ2h0ID0gbWlwT2JqZWN0LmhlaWdodDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19GTElQX1lfV0VCR0wsIHRleHR1cmUuX2ZsaXBZKTtcbiAgICAgICAgICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgZmFsc2UpO1xuICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCBtaXBMZXZlbCwgdGV4dHVyZS5fZ2xJbnRlcm5hbEZvcm1hdCwgdGV4dHVyZS5fZ2xGb3JtYXQsIHRleHR1cmUuX2dsUGl4ZWxUeXBlLCBtaXBPYmplY3QpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBnbC5waXhlbFN0b3JlaShnbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCBmYWxzZSk7XG4gICAgICAgICAgICByZXNNdWx0ID0gMSAvIE1hdGgucG93KDIsIG1pcExldmVsKTtcbiAgICAgICAgICAgIGlmICh0ZXh0dXJlLl9jb21wcmVzc2VkKSB7XG4gICAgICAgICAgICAgIGdsLmNvbXByZXNzZWRUZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIG1pcExldmVsLCB0ZXh0dXJlLl9nbEludGVybmFsRm9ybWF0LCBNYXRoLm1heCh0ZXh0dXJlLl93aWR0aCAqIHJlc011bHQsIDEpLCBNYXRoLm1heCh0ZXh0dXJlLl9oZWlnaHQgKiByZXNNdWx0LCAxKSwgMCwgbWlwT2JqZWN0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgbWlwTGV2ZWwsIHRleHR1cmUuX2dsSW50ZXJuYWxGb3JtYXQsIE1hdGgubWF4KHRleHR1cmUuX3dpZHRoICogcmVzTXVsdCwgMSksIE1hdGgubWF4KHRleHR1cmUuX2hlaWdodCAqIHJlc011bHQsIDEpLCAwLCB0ZXh0dXJlLl9nbEZvcm1hdCwgdGV4dHVyZS5fZ2xQaXhlbFR5cGUsIG1pcE9iamVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChtaXBMZXZlbCA9PT0gMCkge1xuICAgICAgICAgICAgdGV4dHVyZS5fbWlwbWFwc1VwbG9hZGVkID0gZmFsc2U7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRleHR1cmUuX21pcG1hcHNVcGxvYWRlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBtaXBMZXZlbCsrO1xuICAgIH1cbiAgICBpZiAodGV4dHVyZS5fbmVlZHNVcGxvYWQpIHtcbiAgICAgIGlmICh0ZXh0dXJlLl9jdWJlbWFwKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwO2kgPCA2O2krKykge1xuICAgICAgICAgIHRleHR1cmUuX2xldmVsc1VwZGF0ZWRbMF1baV0gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGV4dHVyZS5fbGV2ZWxzVXBkYXRlZFswXSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRleHR1cmUuX2NvbXByZXNzZWQgJiYgdGV4dHVyZS5fbWlwbWFwcyAmJiB0ZXh0dXJlLl9uZWVkc01pcG1hcHNVcGxvYWQgJiYgdGV4dHVyZS5fcG90ICYmIHRleHR1cmUuX2xldmVscy5sZW5ndGggPT09IDEpIHtcbiAgICAgIGdsLmdlbmVyYXRlTWlwbWFwKHRleHR1cmUuX2dsVGFyZ2V0KTtcbiAgICAgIHRleHR1cmUuX21pcG1hcHNVcGxvYWRlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0ZXh0dXJlLl9ncHVTaXplKSB7XG4gICAgICB0aGlzLl92cmFtLnRleCAtPSB0ZXh0dXJlLl9ncHVTaXplO1xuICAgIH1cbiAgICB0ZXh0dXJlLl9ncHVTaXplID0gZ3B1VGV4U2l6ZShnbCwgdGV4dHVyZSk7XG4gICAgdGhpcy5fdnJhbS50ZXggKz0gdGV4dHVyZS5fZ3B1U2l6ZTtcbiAgfSwgc2V0VGV4dHVyZTpmdW5jdGlvbih0ZXh0dXJlLCB0ZXh0dXJlVW5pdCkge1xuICAgIHZhciBnbCA9IHRoaXMuZ2w7XG4gICAgaWYgKCF0ZXh0dXJlLl9nbFRleHR1cmVJZCkge1xuICAgICAgdGhpcy5pbml0aWFsaXplVGV4dHVyZSh0ZXh0dXJlKTtcbiAgICB9XG4gICAgdmFyIHBhcmFtRGlydHkgPSB0ZXh0dXJlLl9taW5GaWx0ZXJEaXJ0eSB8fCB0ZXh0dXJlLl9tYWdGaWx0ZXJEaXJ0eSB8fCB0ZXh0dXJlLl9hZGRyZXNzVURpcnR5IHx8IHRleHR1cmUuX2FkZHJlc3NWRGlydHkgfHwgdGV4dHVyZS5fYWRkcmVzc1dEaXJ0eSB8fCB0ZXh0dXJlLl9hbmlzb3Ryb3B5RGlydHkgfHwgdGV4dHVyZS5fY29tcGFyZU1vZGVEaXJ0eTtcbiAgICBpZiAodGhpcy50ZXh0dXJlVW5pdHNbdGV4dHVyZVVuaXRdICE9PSB0ZXh0dXJlIHx8IHBhcmFtRGlydHkpIHtcbiAgICAgIGlmICh0aGlzLmFjdGl2ZVRleHR1cmUgIT09IHRleHR1cmVVbml0KSB7XG4gICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTAgKyB0ZXh0dXJlVW5pdCk7XG4gICAgICAgIHRoaXMuYWN0aXZlVGV4dHVyZSA9IHRleHR1cmVVbml0O1xuICAgICAgfVxuICAgICAgZ2wuYmluZFRleHR1cmUodGV4dHVyZS5fZ2xUYXJnZXQsIHRleHR1cmUuX2dsVGV4dHVyZUlkKTtcbiAgICAgIHRoaXMudGV4dHVyZVVuaXRzW3RleHR1cmVVbml0XSA9IHRleHR1cmU7XG4gICAgfVxuICAgIGlmIChwYXJhbURpcnR5KSB7XG4gICAgICBpZiAodGV4dHVyZS5fbWluRmlsdGVyRGlydHkpIHtcbiAgICAgICAgdmFyIGZpbHRlciA9IHRleHR1cmUuX21pbkZpbHRlcjtcbiAgICAgICAgaWYgKCF0ZXh0dXJlLl9wb3QgfHwgIXRleHR1cmUuX21pcG1hcHMgfHwgdGV4dHVyZS5fY29tcHJlc3NlZCAmJiB0ZXh0dXJlLl9sZXZlbHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgaWYgKGZpbHRlciA9PT0gcGMuRklMVEVSX05FQVJFU1RfTUlQTUFQX05FQVJFU1QgfHwgZmlsdGVyID09PSBwYy5GSUxURVJfTkVBUkVTVF9NSVBNQVBfTElORUFSKSB7XG4gICAgICAgICAgICBmaWx0ZXIgPSBwYy5GSUxURVJfTkVBUkVTVDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGZpbHRlciA9PT0gcGMuRklMVEVSX0xJTkVBUl9NSVBNQVBfTkVBUkVTVCB8fCBmaWx0ZXIgPT09IHBjLkZJTFRFUl9MSU5FQVJfTUlQTUFQX0xJTkVBUikge1xuICAgICAgICAgICAgICBmaWx0ZXIgPSBwYy5GSUxURVJfTElORUFSO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBnbC50ZXhQYXJhbWV0ZXJpKHRleHR1cmUuX2dsVGFyZ2V0LCBnbC5URVhUVVJFX01JTl9GSUxURVIsIHRoaXMuZ2xGaWx0ZXJbZmlsdGVyXSk7XG4gICAgICAgIHRleHR1cmUuX21pbkZpbHRlckRpcnR5ID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAodGV4dHVyZS5fbWFnRmlsdGVyRGlydHkpIHtcbiAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCB0aGlzLmdsRmlsdGVyW3RleHR1cmUuX21hZ0ZpbHRlcl0pO1xuICAgICAgICB0ZXh0dXJlLl9tYWdGaWx0ZXJEaXJ0eSA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRleHR1cmUuX2FkZHJlc3NVRGlydHkpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9XUkFQX1MsIHRoaXMuZ2xBZGRyZXNzW3RleHR1cmUuX2FkZHJlc3NVXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9XUkFQX1MsIHRoaXMuZ2xBZGRyZXNzW3RleHR1cmUuX3BvdCA/IHRleHR1cmUuX2FkZHJlc3NVIDogcGMuQUREUkVTU19DTEFNUF9UT19FREdFXSk7XG4gICAgICAgIH1cbiAgICAgICAgdGV4dHVyZS5fYWRkcmVzc1VEaXJ0eSA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRleHR1cmUuX2FkZHJlc3NWRGlydHkpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9XUkFQX1QsIHRoaXMuZ2xBZGRyZXNzW3RleHR1cmUuX2FkZHJlc3NWXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9XUkFQX1QsIHRoaXMuZ2xBZGRyZXNzW3RleHR1cmUuX3BvdCA/IHRleHR1cmUuX2FkZHJlc3NWIDogcGMuQUREUkVTU19DTEFNUF9UT19FREdFXSk7XG4gICAgICAgIH1cbiAgICAgICAgdGV4dHVyZS5fYWRkcmVzc1ZEaXJ0eSA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMud2ViZ2wyKSB7XG4gICAgICAgIGlmICh0ZXh0dXJlLl9hZGRyZXNzV0RpcnR5KSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9XUkFQX1IsIHRoaXMuZ2xBZGRyZXNzW3RleHR1cmUuX2FkZHJlc3NXXSk7XG4gICAgICAgICAgdGV4dHVyZS5fYWRkcmVzc1dEaXJ0eSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0ZXh0dXJlLl9jb21wYXJlTW9kZURpcnR5KSB7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9DT01QQVJFX01PREUsIHRleHR1cmUuX2NvbXBhcmVPblJlYWQgPyBnbC5DT01QQVJFX1JFRl9UT19URVhUVVJFIDogZ2wuTk9ORSk7XG4gICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0ZXh0dXJlLl9nbFRhcmdldCwgZ2wuVEVYVFVSRV9DT01QQVJFX0ZVTkMsIHRoaXMuZ2xDb21wYXJpc29uW3RleHR1cmUuX2NvbXBhcmVGdW5jXSk7XG4gICAgICAgICAgdGV4dHVyZS5fY29tcGFyZU1vZGVEaXJ0eSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodGV4dHVyZS5fYW5pc290cm9weURpcnR5KSB7XG4gICAgICAgIHZhciBleHQgPSB0aGlzLmV4dFRleHR1cmVGaWx0ZXJBbmlzb3Ryb3BpYztcbiAgICAgICAgaWYgKGV4dCkge1xuICAgICAgICAgIGdsLnRleFBhcmFtZXRlcmYodGV4dHVyZS5fZ2xUYXJnZXQsIGV4dC5URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCwgTWF0aC5tYXgoMSwgTWF0aC5taW4oTWF0aC5yb3VuZCh0ZXh0dXJlLl9hbmlzb3Ryb3B5KSwgdGhpcy5tYXhBbmlzb3Ryb3B5KSkpO1xuICAgICAgICB9XG4gICAgICAgIHRleHR1cmUuX2FuaXNvdHJvcHlEaXJ0eSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGV4dHVyZS5fbmVlZHNVcGxvYWQgfHwgdGV4dHVyZS5fbmVlZHNNaXBtYXBzVXBsb2FkKSB7XG4gICAgICB0aGlzLnVwbG9hZFRleHR1cmUodGV4dHVyZSk7XG4gICAgICB0ZXh0dXJlLl9uZWVkc1VwbG9hZCA9IGZhbHNlO1xuICAgICAgdGV4dHVyZS5fbmVlZHNNaXBtYXBzVXBsb2FkID0gZmFsc2U7XG4gICAgfVxuICB9LCBkcmF3OmZ1bmN0aW9uKHByaW1pdGl2ZSwgbnVtSW5zdGFuY2VzKSB7XG4gICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICB2YXIgaSwgaiwgbGVuO1xuICAgIHZhciBzYW1wbGVyLCBzYW1wbGVyVmFsdWUsIHRleHR1cmUsIG51bVRleHR1cmVzO1xuICAgIHZhciB1bmlmb3JtLCBzY29wZUlkLCB1bmlmb3JtVmVyc2lvbiwgcHJvZ3JhbVZlcnNpb24sIGxvY2F0aW9uSWQ7XG4gICAgdmFyIHNoYWRlciA9IHRoaXMuc2hhZGVyO1xuICAgIHZhciBzYW1wbGVycyA9IHNoYWRlci5zYW1wbGVycztcbiAgICB2YXIgdW5pZm9ybXMgPSBzaGFkZXIudW5pZm9ybXM7XG4gICAgaWYgKG51bUluc3RhbmNlcyA+IDEpIHtcbiAgICAgIHRoaXMuYm91bmRCdWZmZXIgPSBudWxsO1xuICAgICAgdGhpcy5hdHRyaWJ1dGVzSW52YWxpZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAodGhpcy5hdHRyaWJ1dGVzSW52YWxpZGF0ZWQpIHtcbiAgICAgIHZhciBhdHRyaWJ1dGUsIGVsZW1lbnQsIHZlcnRleEJ1ZmZlciwgdmJPZmZzZXQsIGJ1ZmZlcklkO1xuICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBzaGFkZXIuYXR0cmlidXRlcztcbiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGF0dHJpYnV0ZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbaV07XG4gICAgICAgIGVsZW1lbnQgPSBhdHRyaWJ1dGUuc2NvcGVJZC52YWx1ZTtcbiAgICAgICAgaWYgKGVsZW1lbnQgIT09IG51bGwpIHtcbiAgICAgICAgICB2ZXJ0ZXhCdWZmZXIgPSB0aGlzLnZlcnRleEJ1ZmZlcnNbZWxlbWVudC5zdHJlYW1dO1xuICAgICAgICAgIHZiT2Zmc2V0ID0gdGhpcy52Yk9mZnNldHNbZWxlbWVudC5zdHJlYW1dIHx8IDA7XG4gICAgICAgICAgYnVmZmVySWQgPSB2ZXJ0ZXhCdWZmZXIuYnVmZmVySWQ7XG4gICAgICAgICAgaWYgKHRoaXMuYm91bmRCdWZmZXIgIT09IGJ1ZmZlcklkKSB7XG4gICAgICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgYnVmZmVySWQpO1xuICAgICAgICAgICAgdGhpcy5ib3VuZEJ1ZmZlciA9IGJ1ZmZlcklkO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2NhdGlvbklkID0gYXR0cmlidXRlLmxvY2F0aW9uSWQ7XG4gICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWRBdHRyaWJ1dGVzW2xvY2F0aW9uSWRdKSB7XG4gICAgICAgICAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShsb2NhdGlvbklkKTtcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlZEF0dHJpYnV0ZXNbbG9jYXRpb25JZF0gPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKGxvY2F0aW9uSWQsIGVsZW1lbnQubnVtQ29tcG9uZW50cywgdGhpcy5nbFR5cGVbZWxlbWVudC5kYXRhVHlwZV0sIGVsZW1lbnQubm9ybWFsaXplLCBlbGVtZW50LnN0cmlkZSwgZWxlbWVudC5vZmZzZXQgKyB2Yk9mZnNldCk7XG4gICAgICAgICAgaWYgKGVsZW1lbnQuc3RyZWFtID09PSAxICYmIG51bUluc3RhbmNlcyA+IDEpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnN0YW5jZWRBdHRyaWJzW2xvY2F0aW9uSWRdKSB7XG4gICAgICAgICAgICAgIHRoaXMuZXh0SW5zdGFuY2luZy52ZXJ0ZXhBdHRyaWJEaXZpc29yQU5HTEUobG9jYXRpb25JZCwgMSk7XG4gICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VkQXR0cmlic1tsb2NhdGlvbklkXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlZEF0dHJpYnNbbG9jYXRpb25JZF0pIHtcbiAgICAgICAgICAgICAgdGhpcy5leHRJbnN0YW5jaW5nLnZlcnRleEF0dHJpYkRpdmlzb3JBTkdMRShsb2NhdGlvbklkLCAwKTtcbiAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZWRBdHRyaWJzW2xvY2F0aW9uSWRdID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmF0dHJpYnV0ZXNJbnZhbGlkYXRlZCA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgdGV4dHVyZVVuaXQgPSAwO1xuICAgIGZvciAoaSA9IDAsIGxlbiA9IHNhbXBsZXJzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgc2FtcGxlciA9IHNhbXBsZXJzW2ldO1xuICAgICAgc2FtcGxlclZhbHVlID0gc2FtcGxlci5zY29wZUlkLnZhbHVlO1xuICAgICAgaWYgKCFzYW1wbGVyVmFsdWUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoc2FtcGxlclZhbHVlIGluc3RhbmNlb2YgcGMuVGV4dHVyZSkge1xuICAgICAgICB0ZXh0dXJlID0gc2FtcGxlclZhbHVlO1xuICAgICAgICB0aGlzLnNldFRleHR1cmUodGV4dHVyZSwgdGV4dHVyZVVuaXQpO1xuICAgICAgICBpZiAoc2FtcGxlci5zbG90ICE9PSB0ZXh0dXJlVW5pdCkge1xuICAgICAgICAgIGdsLnVuaWZvcm0xaShzYW1wbGVyLmxvY2F0aW9uSWQsIHRleHR1cmVVbml0KTtcbiAgICAgICAgICBzYW1wbGVyLnNsb3QgPSB0ZXh0dXJlVW5pdDtcbiAgICAgICAgfVxuICAgICAgICB0ZXh0dXJlVW5pdCsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2FtcGxlci5hcnJheS5sZW5ndGggPSAwO1xuICAgICAgICBudW1UZXh0dXJlcyA9IHNhbXBsZXJWYWx1ZS5sZW5ndGg7XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IG51bVRleHR1cmVzO2orKykge1xuICAgICAgICAgIHRleHR1cmUgPSBzYW1wbGVyVmFsdWVbal07XG4gICAgICAgICAgdGhpcy5zZXRUZXh0dXJlKHRleHR1cmUsIHRleHR1cmVVbml0KTtcbiAgICAgICAgICBzYW1wbGVyLmFycmF5W2pdID0gdGV4dHVyZVVuaXQ7XG4gICAgICAgICAgdGV4dHVyZVVuaXQrKztcbiAgICAgICAgfVxuICAgICAgICBnbC51bmlmb3JtMWl2KHNhbXBsZXIubG9jYXRpb25JZCwgc2FtcGxlci5hcnJheSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDAsIGxlbiA9IHVuaWZvcm1zLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdW5pZm9ybSA9IHVuaWZvcm1zW2ldO1xuICAgICAgc2NvcGVJZCA9IHVuaWZvcm0uc2NvcGVJZDtcbiAgICAgIHVuaWZvcm1WZXJzaW9uID0gdW5pZm9ybS52ZXJzaW9uO1xuICAgICAgcHJvZ3JhbVZlcnNpb24gPSBzY29wZUlkLnZlcnNpb25PYmplY3QudmVyc2lvbjtcbiAgICAgIGlmICh1bmlmb3JtVmVyc2lvbi5nbG9iYWxJZCAhPT0gcHJvZ3JhbVZlcnNpb24uZ2xvYmFsSWQgfHwgdW5pZm9ybVZlcnNpb24ucmV2aXNpb24gIT09IHByb2dyYW1WZXJzaW9uLnJldmlzaW9uKSB7XG4gICAgICAgIHVuaWZvcm1WZXJzaW9uLmdsb2JhbElkID0gcHJvZ3JhbVZlcnNpb24uZ2xvYmFsSWQ7XG4gICAgICAgIHVuaWZvcm1WZXJzaW9uLnJldmlzaW9uID0gcHJvZ3JhbVZlcnNpb24ucmV2aXNpb247XG4gICAgICAgIGlmIChzY29wZUlkLnZhbHVlICE9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5jb21taXRGdW5jdGlvblt1bmlmb3JtLmRhdGFUeXBlXSh1bmlmb3JtLCBzY29wZUlkLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9kcmF3Q2FsbHNQZXJGcmFtZSsrO1xuICAgIHRoaXMuX3ByaW1zUGVyRnJhbWVbcHJpbWl0aXZlLnR5cGVdICs9IHByaW1pdGl2ZS5jb3VudCAqIChudW1JbnN0YW5jZXMgPiAxID8gbnVtSW5zdGFuY2VzIDogMSk7XG4gICAgaWYgKHRoaXMud2ViZ2wyICYmIHRoaXMudHJhbnNmb3JtRmVlZGJhY2tCdWZmZXIpIHtcbiAgICAgIGdsLmJpbmRCdWZmZXJCYXNlKGdsLlRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVIsIDAsIHRoaXMudHJhbnNmb3JtRmVlZGJhY2tCdWZmZXIuYnVmZmVySWQpO1xuICAgICAgZ2wuYmVnaW5UcmFuc2Zvcm1GZWVkYmFjayhnbC5QT0lOVFMpO1xuICAgIH1cbiAgICBpZiAocHJpbWl0aXZlLmluZGV4ZWQpIHtcbiAgICAgIGlmIChudW1JbnN0YW5jZXMgPiAxKSB7XG4gICAgICAgIHRoaXMuZXh0SW5zdGFuY2luZy5kcmF3RWxlbWVudHNJbnN0YW5jZWRBTkdMRSh0aGlzLmdsUHJpbWl0aXZlW3ByaW1pdGl2ZS50eXBlXSwgcHJpbWl0aXZlLmNvdW50LCB0aGlzLmluZGV4QnVmZmVyLmdsRm9ybWF0LCBwcmltaXRpdmUuYmFzZSAqIDIsIG51bUluc3RhbmNlcyk7XG4gICAgICAgIHRoaXMuYm91bmRCdWZmZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXNJbnZhbGlkYXRlZCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBnbC5kcmF3RWxlbWVudHModGhpcy5nbFByaW1pdGl2ZVtwcmltaXRpdmUudHlwZV0sIHByaW1pdGl2ZS5jb3VudCwgdGhpcy5pbmRleEJ1ZmZlci5nbEZvcm1hdCwgcHJpbWl0aXZlLmJhc2UgKiB0aGlzLmluZGV4QnVmZmVyLmJ5dGVzUGVySW5kZXgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobnVtSW5zdGFuY2VzID4gMSkge1xuICAgICAgICB0aGlzLmV4dEluc3RhbmNpbmcuZHJhd0FycmF5c0luc3RhbmNlZEFOR0xFKHRoaXMuZ2xQcmltaXRpdmVbcHJpbWl0aXZlLnR5cGVdLCBwcmltaXRpdmUuYmFzZSwgcHJpbWl0aXZlLmNvdW50LCBudW1JbnN0YW5jZXMpO1xuICAgICAgICB0aGlzLmJvdW5kQnVmZmVyID0gbnVsbDtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzSW52YWxpZGF0ZWQgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZ2wuZHJhd0FycmF5cyh0aGlzLmdsUHJpbWl0aXZlW3ByaW1pdGl2ZS50eXBlXSwgcHJpbWl0aXZlLmJhc2UsIHByaW1pdGl2ZS5jb3VudCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLndlYmdsMiAmJiB0aGlzLnRyYW5zZm9ybUZlZWRiYWNrQnVmZmVyKSB7XG4gICAgICBnbC5lbmRUcmFuc2Zvcm1GZWVkYmFjaygpO1xuICAgICAgZ2wuYmluZEJ1ZmZlckJhc2UoZ2wuVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUiwgMCwgbnVsbCk7XG4gICAgfVxuICB9LCBjbGVhcjpmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgdmFyIGRlZmF1bHRPcHRpb25zID0gdGhpcy5kZWZhdWx0Q2xlYXJPcHRpb25zO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRPcHRpb25zO1xuICAgIHZhciBmbGFncyA9IG9wdGlvbnMuZmxhZ3MgPT0gdW5kZWZpbmVkID8gZGVmYXVsdE9wdGlvbnMuZmxhZ3MgOiBvcHRpb25zLmZsYWdzO1xuICAgIGlmIChmbGFncyAhPT0gMCkge1xuICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgIGlmIChmbGFncyAmIHBjLkNMRUFSRkxBR19DT0xPUikge1xuICAgICAgICB2YXIgY29sb3IgPSBvcHRpb25zLmNvbG9yID09IHVuZGVmaW5lZCA/IGRlZmF1bHRPcHRpb25zLmNvbG9yIDogb3B0aW9ucy5jb2xvcjtcbiAgICAgICAgdGhpcy5zZXRDbGVhckNvbG9yKGNvbG9yWzBdLCBjb2xvclsxXSwgY29sb3JbMl0sIGNvbG9yWzNdKTtcbiAgICAgIH1cbiAgICAgIGlmIChmbGFncyAmIHBjLkNMRUFSRkxBR19ERVBUSCkge1xuICAgICAgICB2YXIgZGVwdGggPSBvcHRpb25zLmRlcHRoID09IHVuZGVmaW5lZCA/IGRlZmF1bHRPcHRpb25zLmRlcHRoIDogb3B0aW9ucy5kZXB0aDtcbiAgICAgICAgdGhpcy5zZXRDbGVhckRlcHRoKGRlcHRoKTtcbiAgICAgICAgaWYgKCF0aGlzLmRlcHRoV3JpdGUpIHtcbiAgICAgICAgICBnbC5kZXB0aE1hc2sodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChmbGFncyAmIHBjLkNMRUFSRkxBR19TVEVOQ0lMKSB7XG4gICAgICAgIHZhciBzdGVuY2lsID0gb3B0aW9ucy5zdGVuY2lsID09IHVuZGVmaW5lZCA/IGRlZmF1bHRPcHRpb25zLnN0ZW5jaWwgOiBvcHRpb25zLnN0ZW5jaWw7XG4gICAgICAgIHRoaXMuc2V0Q2xlYXJTdGVuY2lsKHN0ZW5jaWwpO1xuICAgICAgfVxuICAgICAgZ2wuY2xlYXIodGhpcy5nbENsZWFyRmxhZ1tmbGFnc10pO1xuICAgICAgaWYgKGZsYWdzICYgcGMuQ0xFQVJGTEFHX0RFUFRIKSB7XG4gICAgICAgIGlmICghdGhpcy5kZXB0aFdyaXRlKSB7XG4gICAgICAgICAgZ2wuZGVwdGhNYXNrKGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgcmVhZFBpeGVsczpmdW5jdGlvbih4LCB5LCB3LCBoLCBwaXhlbHMpIHtcbiAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgIGdsLnJlYWRQaXhlbHMoeCwgeSwgdywgaCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgcGl4ZWxzKTtcbiAgfSwgc2V0Q2xlYXJEZXB0aDpmdW5jdGlvbihkZXB0aCkge1xuICAgIGlmIChkZXB0aCAhPT0gdGhpcy5jbGVhckRlcHRoKSB7XG4gICAgICB0aGlzLmdsLmNsZWFyRGVwdGgoZGVwdGgpO1xuICAgICAgdGhpcy5jbGVhckRlcHRoID0gZGVwdGg7XG4gICAgfVxuICB9LCBzZXRDbGVhckNvbG9yOmZ1bmN0aW9uKHIsIGcsIGIsIGEpIHtcbiAgICBpZiAociAhPT0gdGhpcy5jbGVhclJlZCB8fCBnICE9PSB0aGlzLmNsZWFyR3JlZW4gfHwgYiAhPT0gdGhpcy5jbGVhckJsdWUgfHwgYSAhPT0gdGhpcy5jbGVhckFscGhhKSB7XG4gICAgICB0aGlzLmdsLmNsZWFyQ29sb3IociwgZywgYiwgYSk7XG4gICAgICB0aGlzLmNsZWFyUmVkID0gcjtcbiAgICAgIHRoaXMuY2xlYXJHcmVlbiA9IGc7XG4gICAgICB0aGlzLmNsZWFyQmx1ZSA9IGI7XG4gICAgICB0aGlzLmNsZWFyQWxwaGEgPSBhO1xuICAgIH1cbiAgfSwgc2V0Q2xlYXJTdGVuY2lsOmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlICE9PSB0aGlzLmNsZWFyU3RlbmNpbCkge1xuICAgICAgdGhpcy5nbC5jbGVhclN0ZW5jaWwodmFsdWUpO1xuICAgICAgdGhpcy5jbGVhclN0ZW5jaWwgPSB2YWx1ZTtcbiAgICB9XG4gIH0sIHNldFJlbmRlclRhcmdldDpmdW5jdGlvbihyZW5kZXJUYXJnZXQpIHtcbiAgICB0aGlzLnJlbmRlclRhcmdldCA9IHJlbmRlclRhcmdldDtcbiAgfSwgZ2V0UmVuZGVyVGFyZ2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnJlbmRlclRhcmdldDtcbiAgfSwgZ2V0RGVwdGhUZXN0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRlcHRoVGVzdDtcbiAgfSwgc2V0RGVwdGhUZXN0OmZ1bmN0aW9uKGRlcHRoVGVzdCkge1xuICAgIGlmICh0aGlzLmRlcHRoVGVzdCAhPT0gZGVwdGhUZXN0KSB7XG4gICAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgICAgaWYgKGRlcHRoVGVzdCkge1xuICAgICAgICBnbC5lbmFibGUoZ2wuREVQVEhfVEVTVCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBnbC5kaXNhYmxlKGdsLkRFUFRIX1RFU1QpO1xuICAgICAgfVxuICAgICAgdGhpcy5kZXB0aFRlc3QgPSBkZXB0aFRlc3Q7XG4gICAgfVxuICB9LCBzZXREZXB0aEZ1bmM6ZnVuY3Rpb24oZnVuYykge1xuICAgIGlmICh0aGlzLmRlcHRoRnVuYyA9PT0gZnVuYykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmdsLmRlcHRoRnVuYyh0aGlzLmdsQ29tcGFyaXNvbltmdW5jXSk7XG4gICAgdGhpcy5kZXB0aEZ1bmMgPSBmdW5jO1xuICB9LCBnZXREZXB0aFdyaXRlOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRlcHRoV3JpdGU7XG4gIH0sIHNldERlcHRoV3JpdGU6ZnVuY3Rpb24od3JpdGVEZXB0aCkge1xuICAgIGlmICh0aGlzLmRlcHRoV3JpdGUgIT09IHdyaXRlRGVwdGgpIHtcbiAgICAgIHRoaXMuZ2wuZGVwdGhNYXNrKHdyaXRlRGVwdGgpO1xuICAgICAgdGhpcy5kZXB0aFdyaXRlID0gd3JpdGVEZXB0aDtcbiAgICB9XG4gIH0sIHNldENvbG9yV3JpdGU6ZnVuY3Rpb24od3JpdGVSZWQsIHdyaXRlR3JlZW4sIHdyaXRlQmx1ZSwgd3JpdGVBbHBoYSkge1xuICAgIGlmICh0aGlzLndyaXRlUmVkICE9PSB3cml0ZVJlZCB8fCB0aGlzLndyaXRlR3JlZW4gIT09IHdyaXRlR3JlZW4gfHwgdGhpcy53cml0ZUJsdWUgIT09IHdyaXRlQmx1ZSB8fCB0aGlzLndyaXRlQWxwaGEgIT09IHdyaXRlQWxwaGEpIHtcbiAgICAgIHRoaXMuZ2wuY29sb3JNYXNrKHdyaXRlUmVkLCB3cml0ZUdyZWVuLCB3cml0ZUJsdWUsIHdyaXRlQWxwaGEpO1xuICAgICAgdGhpcy53cml0ZVJlZCA9IHdyaXRlUmVkO1xuICAgICAgdGhpcy53cml0ZUdyZWVuID0gd3JpdGVHcmVlbjtcbiAgICAgIHRoaXMud3JpdGVCbHVlID0gd3JpdGVCbHVlO1xuICAgICAgdGhpcy53cml0ZUFscGhhID0gd3JpdGVBbHBoYTtcbiAgICB9XG4gIH0sIHNldEFscGhhVG9Db3ZlcmFnZTpmdW5jdGlvbihzdGF0ZSkge1xuICAgIGlmICghdGhpcy53ZWJnbDIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuYWxwaGFUb0NvdmVyYWdlID09PSBzdGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFscGhhVG9Db3ZlcmFnZSA9IHN0YXRlO1xuICAgIGlmIChzdGF0ZSkge1xuICAgICAgdGhpcy5nbC5lbmFibGUodGhpcy5nbC5TQU1QTEVfQUxQSEFfVE9fQ09WRVJBR0UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmdsLmRpc2FibGUodGhpcy5nbC5TQU1QTEVfQUxQSEFfVE9fQ09WRVJBR0UpO1xuICAgIH1cbiAgfSwgc2V0VHJhbnNmb3JtRmVlZGJhY2tCdWZmZXI6ZnVuY3Rpb24odGYpIHtcbiAgICBpZiAodGhpcy50cmFuc2Zvcm1GZWVkYmFja0J1ZmZlciA9PT0gdGYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy50cmFuc2Zvcm1GZWVkYmFja0J1ZmZlciA9IHRmO1xuICAgIGlmICh0aGlzLndlYmdsMikge1xuICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgIGlmICh0Zikge1xuICAgICAgICBnbC5iaW5kVHJhbnNmb3JtRmVlZGJhY2soZ2wuVFJBTlNGT1JNX0ZFRURCQUNLLCB0aGlzLmZlZWRiYWNrKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGdsLmJpbmRUcmFuc2Zvcm1GZWVkYmFjayhnbC5UUkFOU0ZPUk1fRkVFREJBQ0ssIG51bGwpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgc2V0UmFzdGVyOmZ1bmN0aW9uKG9uKSB7XG4gICAgaWYgKHRoaXMucmFzdGVyID09PSBvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnJhc3RlciA9IG9uO1xuICAgIGlmICh0aGlzLndlYmdsMikge1xuICAgICAgaWYgKG9uKSB7XG4gICAgICAgIHRoaXMuZ2wuZGlzYWJsZSh0aGlzLmdsLlJBU1RFUklaRVJfRElTQ0FSRCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmdsLmVuYWJsZSh0aGlzLmdsLlJBU1RFUklaRVJfRElTQ0FSRCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBzZXREZXB0aEJpYXM6ZnVuY3Rpb24ob24pIHtcbiAgICBpZiAodGhpcy5kZXB0aEJpYXNFbmFibGVkID09PSBvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRlcHRoQmlhc0VuYWJsZWQgPSBvbjtcbiAgICBpZiAob24pIHtcbiAgICAgIHRoaXMuZ2wuZW5hYmxlKHRoaXMuZ2wuUE9MWUdPTl9PRkZTRVRfRklMTCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZ2wuZGlzYWJsZSh0aGlzLmdsLlBPTFlHT05fT0ZGU0VUX0ZJTEwpO1xuICAgIH1cbiAgfSwgc2V0RGVwdGhCaWFzVmFsdWVzOmZ1bmN0aW9uKGNvbnN0Qmlhcywgc2xvcGVCaWFzKSB7XG4gICAgdGhpcy5nbC5wb2x5Z29uT2Zmc2V0KHNsb3BlQmlhcywgY29uc3RCaWFzKTtcbiAgfSwgZ2V0QmxlbmRpbmc6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuYmxlbmRpbmc7XG4gIH0sIHNldEJsZW5kaW5nOmZ1bmN0aW9uKGJsZW5kaW5nKSB7XG4gICAgaWYgKHRoaXMuYmxlbmRpbmcgIT09IGJsZW5kaW5nKSB7XG4gICAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgICAgaWYgKGJsZW5kaW5nKSB7XG4gICAgICAgIGdsLmVuYWJsZShnbC5CTEVORCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBnbC5kaXNhYmxlKGdsLkJMRU5EKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYmxlbmRpbmcgPSBibGVuZGluZztcbiAgICB9XG4gIH0sIHNldFN0ZW5jaWxUZXN0OmZ1bmN0aW9uKGVuYWJsZSkge1xuICAgIGlmICh0aGlzLnN0ZW5jaWwgIT09IGVuYWJsZSkge1xuICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgIGlmIChlbmFibGUpIHtcbiAgICAgICAgZ2wuZW5hYmxlKGdsLlNURU5DSUxfVEVTVCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBnbC5kaXNhYmxlKGdsLlNURU5DSUxfVEVTVCk7XG4gICAgICB9XG4gICAgICB0aGlzLnN0ZW5jaWwgPSBlbmFibGU7XG4gICAgfVxuICB9LCBzZXRTdGVuY2lsRnVuYzpmdW5jdGlvbihmdW5jLCByZWYsIG1hc2spIHtcbiAgICBpZiAodGhpcy5zdGVuY2lsRnVuY0Zyb250ICE9PSBmdW5jIHx8IHRoaXMuc3RlbmNpbFJlZkZyb250ICE9PSByZWYgfHwgdGhpcy5zdGVuY2lsTWFza0Zyb250ICE9PSBtYXNrIHx8IHRoaXMuc3RlbmNpbEZ1bmNCYWNrICE9PSBmdW5jIHx8IHRoaXMuc3RlbmNpbFJlZkJhY2sgIT09IHJlZiB8fCB0aGlzLnN0ZW5jaWxNYXNrQmFjayAhPT0gbWFzaykge1xuICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgIGdsLnN0ZW5jaWxGdW5jKHRoaXMuZ2xDb21wYXJpc29uW2Z1bmNdLCByZWYsIG1hc2spO1xuICAgICAgdGhpcy5zdGVuY2lsRnVuY0Zyb250ID0gdGhpcy5zdGVuY2lsRnVuY0JhY2sgPSBmdW5jO1xuICAgICAgdGhpcy5zdGVuY2lsUmVmRnJvbnQgPSB0aGlzLnN0ZW5jaWxSZWZCYWNrID0gcmVmO1xuICAgICAgdGhpcy5zdGVuY2lsTWFza0Zyb250ID0gdGhpcy5zdGVuY2lsTWFza0JhY2sgPSBtYXNrO1xuICAgIH1cbiAgfSwgc2V0U3RlbmNpbEZ1bmNGcm9udDpmdW5jdGlvbihmdW5jLCByZWYsIG1hc2spIHtcbiAgICBpZiAodGhpcy5zdGVuY2lsRnVuY0Zyb250ICE9PSBmdW5jIHx8IHRoaXMuc3RlbmNpbFJlZkZyb250ICE9PSByZWYgfHwgdGhpcy5zdGVuY2lsTWFza0Zyb250ICE9PSBtYXNrKSB7XG4gICAgICB2YXIgZ2wgPSB0aGlzLmdsO1xuICAgICAgZ2wuc3RlbmNpbEZ1bmNTZXBhcmF0ZShnbC5GUk9OVCwgdGhpcy5nbENvbXBhcmlzb25bZnVuY10sIHJlZiwgbWFzayk7XG4gICAgICB0aGlzLnN0ZW5jaWxGdW5jRnJvbnQgPSBmdW5jO1xuICAgICAgdGhpcy5zdGVuY2lsUmVmRnJvbnQgPSByZWY7XG4gICAgICB0aGlzLnN0ZW5jaWxNYXNrRnJvbnQgPSBtYXNrO1xuICAgIH1cbiAgfSwgc2V0U3RlbmNpbEZ1bmNCYWNrOmZ1bmN0aW9uKGZ1bmMsIHJlZiwgbWFzaykge1xuICAgIGlmICh0aGlzLnN0ZW5jaWxGdW5jQmFjayAhPT0gZnVuYyB8fCB0aGlzLnN0ZW5jaWxSZWZCYWNrICE9PSByZWYgfHwgdGhpcy5zdGVuY2lsTWFza0JhY2sgIT09IG1hc2spIHtcbiAgICAgIHZhciBnbCA9IHRoaXMuZ2w7XG4gICAgICBnbC5zdGVuY2lsRnVuY1NlcGFyYXRlKGdsLkJBQ0ssIHRoaXMuZ2xDb21wYXJpc29uW2Z1bmNdLCByZWYsIG1hc2spO1xuICAgICAgdGhpcy5zdGVuY2lsRnVuY0JhY2sgPSBmdW5jO1xuICAgICAgdGhpcy5zdGVuY2lsUmVmQmFjayA9IHJlZjtcbiAgICAgIHRoaXMuc3RlbmNpbE1hc2tCYWNrID0gbWFzaztcbiAgICB9XG4gIH0sIHNldFN0ZW5jaWxPcGVyYXRpb246ZnVuY3Rpb24oZmFpbCwgemZhaWwsIHpwYXNzLCB3cml0ZU1hc2spIHtcbiAgICBpZiAodGhpcy5zdGVuY2lsRmFpbEZyb250ICE9PSBmYWlsIHx8IHRoaXMuc3RlbmNpbFpmYWlsRnJvbnQgIT09IHpmYWlsIHx8IHRoaXMuc3RlbmNpbFpwYXNzRnJvbnQgIT09IHpwYXNzIHx8IHRoaXMuc3RlbmNpbEZhaWxCYWNrICE9PSBmYWlsIHx8IHRoaXMuc3RlbmNpbFpmYWlsQmFjayAhPT0gemZhaWwgfHwgdGhpcy5zdGVuY2lsWnBhc3NCYWNrICE9PSB6cGFzcykge1xuICAgICAgdGhpcy5nbC5zdGVuY2lsT3AodGhpcy5nbFN0ZW5jaWxPcFtmYWlsXSwgdGhpcy5nbFN0ZW5jaWxPcFt6ZmFpbF0sIHRoaXMuZ2xTdGVuY2lsT3BbenBhc3NdKTtcbiAgICAgIHRoaXMuc3RlbmNpbEZhaWxGcm9udCA9IHRoaXMuc3RlbmNpbEZhaWxCYWNrID0gZmFpbDtcbiAgICAgIHRoaXMuc3RlbmNpbFpmYWlsRnJvbnQgPSB0aGlzLnN0ZW5jaWxaZmFpbEJhY2sgPSB6ZmFpbDtcbiAgICAgIHRoaXMuc3RlbmNpbFpwYXNzRnJvbnQgPSB0aGlzLnN0ZW5jaWxacGFzc0JhY2sgPSB6cGFzcztcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RlbmNpbFdyaXRlTWFza0Zyb250ICE9PSB3cml0ZU1hc2sgfHwgdGhpcy5zdGVuY2lsV3JpdGVNYXNrQmFjayAhPT0gd3JpdGVNYXNrKSB7XG4gICAgICB0aGlzLmdsLnN0ZW5jaWxNYXNrKHdyaXRlTWFzayk7XG4gICAgICB0aGlzLnN0ZW5jaWxXcml0ZU1hc2tGcm9udCA9IHdyaXRlTWFzaztcbiAgICAgIHRoaXMuc3RlbmNpbFdyaXRlTWFza0JhY2sgPSB3cml0ZU1hc2s7XG4gICAgfVxuICB9LCBzZXRTdGVuY2lsT3BlcmF0aW9uRnJvbnQ6ZnVuY3Rpb24oZmFpbCwgemZhaWwsIHpwYXNzLCB3cml0ZU1hc2spIHtcbiAgICBpZiAodGhpcy5zdGVuY2lsRmFpbEZyb250ICE9PSBmYWlsIHx8IHRoaXMuc3RlbmNpbFpmYWlsRnJvbnQgIT09IHpmYWlsIHx8IHRoaXMuc3RlbmNpbFpwYXNzRnJvbnQgIT09IHpwYXNzKSB7XG4gICAgICB0aGlzLmdsLnN0ZW5jaWxPcFNlcGFyYXRlKHRoaXMuZ2wuRlJPTlQsIHRoaXMuZ2xTdGVuY2lsT3BbZmFpbF0sIHRoaXMuZ2xTdGVuY2lsT3BbemZhaWxdLCB0aGlzLmdsU3RlbmNpbE9wW3pwYXNzXSk7XG4gICAgICB0aGlzLnN0ZW5jaWxGYWlsRnJvbnQgPSBmYWlsO1xuICAgICAgdGhpcy5zdGVuY2lsWmZhaWxGcm9udCA9IHpmYWlsO1xuICAgICAgdGhpcy5zdGVuY2lsWnBhc3NGcm9udCA9IHpwYXNzO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGVuY2lsV3JpdGVNYXNrRnJvbnQgIT09IHdyaXRlTWFzaykge1xuICAgICAgdGhpcy5nbC5zdGVuY2lsTWFza1NlcGFyYXRlKHRoaXMuZ2wuRlJPTlQsIHdyaXRlTWFzayk7XG4gICAgICB0aGlzLnN0ZW5jaWxXcml0ZU1hc2tGcm9udCA9IHdyaXRlTWFzaztcbiAgICB9XG4gIH0sIHNldFN0ZW5jaWxPcGVyYXRpb25CYWNrOmZ1bmN0aW9uKGZhaWwsIHpmYWlsLCB6cGFzcywgd3JpdGVNYXNrKSB7XG4gICAgaWYgKHRoaXMuc3RlbmNpbEZhaWxCYWNrICE9PSBmYWlsIHx8IHRoaXMuc3RlbmNpbFpmYWlsQmFjayAhPT0gemZhaWwgfHwgdGhpcy5zdGVuY2lsWnBhc3NCYWNrICE9PSB6cGFzcykge1xuICAgICAgdGhpcy5nbC5zdGVuY2lsT3BTZXBhcmF0ZSh0aGlzLmdsLkJBQ0ssIHRoaXMuZ2xTdGVuY2lsT3BbZmFpbF0sIHRoaXMuZ2xTdGVuY2lsT3BbemZhaWxdLCB0aGlzLmdsU3RlbmNpbE9wW3pwYXNzXSk7XG4gICAgICB0aGlzLnN0ZW5jaWxGYWlsQmFjayA9IGZhaWw7XG4gICAgICB0aGlzLnN0ZW5jaWxaZmFpbEJhY2sgPSB6ZmFpbDtcbiAgICAgIHRoaXMuc3RlbmNpbFpwYXNzQmFjayA9IHpwYXNzO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGVuY2lsV3JpdGVNYXNrQmFjayAhPT0gd3JpdGVNYXNrKSB7XG4gICAgICB0aGlzLmdsLnN0ZW5jaWxNYXNrU2VwYXJhdGUodGhpcy5nbC5CQUNLLCB3cml0ZU1hc2spO1xuICAgICAgdGhpcy5zdGVuY2lsV3JpdGVNYXNrQmFjayA9IHdyaXRlTWFzaztcbiAgICB9XG4gIH0sIHNldEJsZW5kRnVuY3Rpb246ZnVuY3Rpb24oYmxlbmRTcmMsIGJsZW5kRHN0KSB7XG4gICAgaWYgKHRoaXMuYmxlbmRTcmMgIT09IGJsZW5kU3JjIHx8IHRoaXMuYmxlbmREc3QgIT09IGJsZW5kRHN0IHx8IHRoaXMuc2VwYXJhdGVBbHBoYUJsZW5kKSB7XG4gICAgICB0aGlzLmdsLmJsZW5kRnVuYyh0aGlzLmdsQmxlbmRGdW5jdGlvbltibGVuZFNyY10sIHRoaXMuZ2xCbGVuZEZ1bmN0aW9uW2JsZW5kRHN0XSk7XG4gICAgICB0aGlzLmJsZW5kU3JjID0gYmxlbmRTcmM7XG4gICAgICB0aGlzLmJsZW5kRHN0ID0gYmxlbmREc3Q7XG4gICAgICB0aGlzLnNlcGFyYXRlQWxwaGFCbGVuZCA9IGZhbHNlO1xuICAgIH1cbiAgfSwgc2V0QmxlbmRGdW5jdGlvblNlcGFyYXRlOmZ1bmN0aW9uKGJsZW5kU3JjLCBibGVuZERzdCwgYmxlbmRTcmNBbHBoYSwgYmxlbmREc3RBbHBoYSkge1xuICAgIGlmICh0aGlzLmJsZW5kU3JjICE9PSBibGVuZFNyYyB8fCB0aGlzLmJsZW5kRHN0ICE9PSBibGVuZERzdCB8fCB0aGlzLmJsZW5kU3JjQWxwaGEgIT09IGJsZW5kU3JjQWxwaGEgfHwgdGhpcy5ibGVuZERzdEFscGhhICE9PSBibGVuZERzdEFscGhhIHx8ICF0aGlzLnNlcGFyYXRlQWxwaGFCbGVuZCkge1xuICAgICAgdGhpcy5nbC5ibGVuZEZ1bmNTZXBhcmF0ZSh0aGlzLmdsQmxlbmRGdW5jdGlvbltibGVuZFNyY10sIHRoaXMuZ2xCbGVuZEZ1bmN0aW9uW2JsZW5kRHN0XSwgdGhpcy5nbEJsZW5kRnVuY3Rpb25bYmxlbmRTcmNBbHBoYV0sIHRoaXMuZ2xCbGVuZEZ1bmN0aW9uW2JsZW5kRHN0QWxwaGFdKTtcbiAgICAgIHRoaXMuYmxlbmRTcmMgPSBibGVuZFNyYztcbiAgICAgIHRoaXMuYmxlbmREc3QgPSBibGVuZERzdDtcbiAgICAgIHRoaXMuYmxlbmRTcmNBbHBoYSA9IGJsZW5kU3JjQWxwaGE7XG4gICAgICB0aGlzLmJsZW5kRHN0QWxwaGEgPSBibGVuZERzdEFscGhhO1xuICAgICAgdGhpcy5zZXBhcmF0ZUFscGhhQmxlbmQgPSB0cnVlO1xuICAgIH1cbiAgfSwgc2V0QmxlbmRFcXVhdGlvbjpmdW5jdGlvbihibGVuZEVxdWF0aW9uKSB7XG4gICAgaWYgKHRoaXMuYmxlbmRFcXVhdGlvbiAhPT0gYmxlbmRFcXVhdGlvbiB8fCB0aGlzLnNlcGFyYXRlQWxwaGFFcXVhdGlvbikge1xuICAgICAgdGhpcy5nbC5ibGVuZEVxdWF0aW9uKHRoaXMuZ2xCbGVuZEVxdWF0aW9uW2JsZW5kRXF1YXRpb25dKTtcbiAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IGJsZW5kRXF1YXRpb247XG4gICAgICB0aGlzLnNlcGFyYXRlQWxwaGFFcXVhdGlvbiA9IGZhbHNlO1xuICAgIH1cbiAgfSwgc2V0QmxlbmRFcXVhdGlvblNlcGFyYXRlOmZ1bmN0aW9uKGJsZW5kRXF1YXRpb24sIGJsZW5kQWxwaGFFcXVhdGlvbikge1xuICAgIGlmICh0aGlzLmJsZW5kRXF1YXRpb24gIT09IGJsZW5kRXF1YXRpb24gfHwgdGhpcy5ibGVuZEFscGhhRXF1YXRpb24gIT09IGJsZW5kQWxwaGFFcXVhdGlvbiB8fCAhdGhpcy5zZXBhcmF0ZUFscGhhRXF1YXRpb24pIHtcbiAgICAgIHRoaXMuZ2wuYmxlbmRFcXVhdGlvblNlcGFyYXRlKHRoaXMuZ2xCbGVuZEVxdWF0aW9uW2JsZW5kRXF1YXRpb25dLCB0aGlzLmdsQmxlbmRFcXVhdGlvbltibGVuZEFscGhhRXF1YXRpb25dKTtcbiAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IGJsZW5kRXF1YXRpb247XG4gICAgICB0aGlzLmJsZW5kQWxwaGFFcXVhdGlvbiA9IGJsZW5kQWxwaGFFcXVhdGlvbjtcbiAgICAgIHRoaXMuc2VwYXJhdGVBbHBoYUVxdWF0aW9uID0gdHJ1ZTtcbiAgICB9XG4gIH0sIHNldEN1bGxNb2RlOmZ1bmN0aW9uKGN1bGxNb2RlKSB7XG4gICAgaWYgKHRoaXMuY3VsbE1vZGUgIT09IGN1bGxNb2RlKSB7XG4gICAgICBpZiAoY3VsbE1vZGUgPT09IHBjLkNVTExGQUNFX05PTkUpIHtcbiAgICAgICAgdGhpcy5nbC5kaXNhYmxlKHRoaXMuZ2wuQ1VMTF9GQUNFKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLmN1bGxNb2RlID09PSBwYy5DVUxMRkFDRV9OT05FKSB7XG4gICAgICAgICAgdGhpcy5nbC5lbmFibGUodGhpcy5nbC5DVUxMX0ZBQ0UpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBtb2RlID0gdGhpcy5nbEN1bGxbY3VsbE1vZGVdO1xuICAgICAgICBpZiAodGhpcy5jdWxsRmFjZSAhPT0gbW9kZSkge1xuICAgICAgICAgIHRoaXMuZ2wuY3VsbEZhY2UobW9kZSk7XG4gICAgICAgICAgdGhpcy5jdWxsRmFjZSA9IG1vZGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuY3VsbE1vZGUgPSBjdWxsTW9kZTtcbiAgICB9XG4gIH0sIGdldEN1bGxNb2RlOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmN1bGxNb2RlO1xuICB9LCBzZXRJbmRleEJ1ZmZlcjpmdW5jdGlvbihpbmRleEJ1ZmZlcikge1xuICAgIGlmICh0aGlzLmluZGV4QnVmZmVyICE9PSBpbmRleEJ1ZmZlcikge1xuICAgICAgdGhpcy5pbmRleEJ1ZmZlciA9IGluZGV4QnVmZmVyO1xuICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGluZGV4QnVmZmVyID8gaW5kZXhCdWZmZXIuYnVmZmVySWQgOiBudWxsKTtcbiAgICB9XG4gIH0sIHNldFZlcnRleEJ1ZmZlcjpmdW5jdGlvbih2ZXJ0ZXhCdWZmZXIsIHN0cmVhbSwgdmJPZmZzZXQpIHtcbiAgICBpZiAodGhpcy52ZXJ0ZXhCdWZmZXJzW3N0cmVhbV0gIT09IHZlcnRleEJ1ZmZlciB8fCB0aGlzLnZiT2Zmc2V0c1tzdHJlYW1dICE9PSB2Yk9mZnNldCkge1xuICAgICAgdGhpcy52ZXJ0ZXhCdWZmZXJzW3N0cmVhbV0gPSB2ZXJ0ZXhCdWZmZXI7XG4gICAgICB0aGlzLnZiT2Zmc2V0c1tzdHJlYW1dID0gdmJPZmZzZXQ7XG4gICAgICB2YXIgdmVydGV4Rm9ybWF0ID0gdmVydGV4QnVmZmVyLmdldEZvcm1hdCgpO1xuICAgICAgdmFyIGkgPSAwO1xuICAgICAgdmFyIGVsZW1lbnRzID0gdmVydGV4Rm9ybWF0LmVsZW1lbnRzO1xuICAgICAgdmFyIG51bUVsZW1lbnRzID0gZWxlbWVudHMubGVuZ3RoO1xuICAgICAgd2hpbGUgKGkgPCBudW1FbGVtZW50cykge1xuICAgICAgICB2YXIgdmVydGV4RWxlbWVudCA9IGVsZW1lbnRzW2krK107XG4gICAgICAgIHZlcnRleEVsZW1lbnQuc3RyZWFtID0gc3RyZWFtO1xuICAgICAgICB2ZXJ0ZXhFbGVtZW50LnNjb3BlSWQuc2V0VmFsdWUodmVydGV4RWxlbWVudCk7XG4gICAgICB9XG4gICAgICB0aGlzLmF0dHJpYnV0ZXNJbnZhbGlkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9LCBzZXRTaGFkZXI6ZnVuY3Rpb24oc2hhZGVyKSB7XG4gICAgaWYgKHNoYWRlciAhPT0gdGhpcy5zaGFkZXIpIHtcbiAgICAgIHRoaXMuc2hhZGVyID0gc2hhZGVyO1xuICAgICAgaWYgKCFzaGFkZXIucmVhZHkpIHtcbiAgICAgICAgaWYgKCFzaGFkZXIubGluaygpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLl9zaGFkZXJTd2l0Y2hlc1BlckZyYW1lKys7XG4gICAgICB0aGlzLmdsLnVzZVByb2dyYW0oc2hhZGVyLnByb2dyYW0pO1xuICAgICAgdGhpcy5hdHRyaWJ1dGVzSW52YWxpZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSwgZ2V0SGRyRm9ybWF0OmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmV4dFRleHR1cmVIYWxmRmxvYXRSZW5kZXJhYmxlKSB7XG4gICAgICByZXR1cm4gcGMuUElYRUxGT1JNQVRfUkdCMTZGO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5leHRUZXh0dXJlRmxvYXRSZW5kZXJhYmxlKSB7XG4gICAgICAgIHJldHVybiBwYy5QSVhFTEZPUk1BVF9SR0IzMkY7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BODtcbiAgfSwgZ2V0Qm9uZUxpbWl0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmJvbmVMaW1pdDtcbiAgfSwgc2V0Qm9uZUxpbWl0OmZ1bmN0aW9uKG1heEJvbmVzKSB7XG4gICAgdGhpcy5ib25lTGltaXQgPSBtYXhCb25lcztcbiAgfSwgZW5hYmxlVmFsaWRhdGlvbjpmdW5jdGlvbihlbmFibGUpIHtcbiAgICBjb25zb2xlLndhcm4oXCJlbmFibGVWYWxpZGF0aW9uOiBUaGlzIGZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBzaG9ydGx5LlwiKTtcbiAgfSwgdmFsaWRhdGU6ZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS53YXJuKFwidmFsaWRhdGU6IFRoaXMgZnVuY3Rpb24gaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIHNob3J0bHkuXCIpO1xuICB9LCByZXNpemVDYW52YXM6ZnVuY3Rpb24od2lkdGgsIGhlaWdodCkge1xuICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0O1xuICAgIHZhciByYXRpbyA9IE1hdGgubWluKHRoaXMuX21heFBpeGVsUmF0aW8sIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTtcbiAgICB3aWR0aCAqPSByYXRpbztcbiAgICBoZWlnaHQgKj0gcmF0aW87XG4gICAgdGhpcy5jYW52YXMud2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgdGhpcy5maXJlKEVWRU5UX1JFU0laRSwgd2lkdGgsIGhlaWdodCk7XG4gIH0sIHNldFJlc29sdXRpb246ZnVuY3Rpb24od2lkdGgsIGhlaWdodCkge1xuICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0O1xuICAgIHRoaXMuY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgIHRoaXMuZmlyZShFVkVOVF9SRVNJWkUsIHdpZHRoLCBoZWlnaHQpO1xuICB9LCBjbGVhclNoYWRlckNhY2hlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMucHJvZ3JhbUxpYi5jbGVhckNhY2hlKCk7XG4gIH0sIHJlbW92ZVNoYWRlckZyb21DYWNoZTpmdW5jdGlvbihzaGFkZXIpIHtcbiAgICB0aGlzLnByb2dyYW1MaWIucmVtb3ZlRnJvbUNhY2hlKHNoYWRlcik7XG4gIH0sIGRlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMud2ViZ2wyICYmIHRoaXMuZmVlZGJhY2spIHtcbiAgICAgIHRoaXMuZ2wuZGVsZXRlVHJhbnNmb3JtRmVlZGJhY2sodGhpcy5mZWVkYmFjayk7XG4gICAgfVxuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoaWNzRGV2aWNlLnByb3RvdHlwZSwgXCJ3aWR0aFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmdsLmRyYXdpbmdCdWZmZXJXaWR0aCB8fCB0aGlzLmNhbnZhcy53aWR0aDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoR3JhcGhpY3NEZXZpY2UucHJvdG90eXBlLCBcImhlaWdodFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmdsLmRyYXdpbmdCdWZmZXJIZWlnaHQgfHwgdGhpcy5jYW52YXMuaGVpZ2h0O1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShHcmFwaGljc0RldmljZS5wcm90b3R5cGUsIFwiZnVsbHNjcmVlblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAhIWRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50O1xuICB9LCBzZXQ6ZnVuY3Rpb24oZnVsbHNjcmVlbikge1xuICAgIGlmIChmdWxsc2NyZWVuKSB7XG4gICAgICB2YXIgY2FudmFzID0gdGhpcy5nbC5jYW52YXM7XG4gICAgICBjYW52YXMucmVxdWVzdEZ1bGxzY3JlZW4oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4oKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoaWNzRGV2aWNlLnByb3RvdHlwZSwgXCJlbmFibGVBdXRvSW5zdGFuY2luZ1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9lbmFibGVBdXRvSW5zdGFuY2luZztcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fZW5hYmxlQXV0b0luc3RhbmNpbmcgPSB2YWx1ZSAmJiB0aGlzLmV4dEluc3RhbmNpbmc7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoaWNzRGV2aWNlLnByb3RvdHlwZSwgXCJtYXhBbmlzb3Ryb3B5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG1heEFuaXNvO1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChtYXhBbmlzbyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1heEFuaXNvID0gMTtcbiAgICAgICAgdmFyIGdsID0gdGhpcy5nbDtcbiAgICAgICAgdmFyIGdsRXh0ID0gdGhpcy5leHRUZXh0dXJlRmlsdGVyQW5pc290cm9waWM7XG4gICAgICAgIGlmIChnbEV4dCkge1xuICAgICAgICAgIG1heEFuaXNvID0gZ2wuZ2V0UGFyYW1ldGVyKGdsRXh0Lk1BWF9URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBtYXhBbmlzbztcbiAgICB9O1xuICB9KCl9KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoaWNzRGV2aWNlLnByb3RvdHlwZSwgXCJtYXhQaXhlbFJhdGlvXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX21heFBpeGVsUmF0aW87XG4gIH0sIHNldDpmdW5jdGlvbihyYXRpbykge1xuICAgIHRoaXMuX21heFBpeGVsUmF0aW8gPSByYXRpbztcbiAgICB0aGlzLnJlc2l6ZUNhbnZhcyh0aGlzLl93aWR0aCwgdGhpcy5faGVpZ2h0KTtcbiAgfX0pO1xuICByZXR1cm4ge1Vuc3VwcG9ydGVkQnJvd3NlckVycm9yOlVuc3VwcG9ydGVkQnJvd3NlckVycm9yLCBDb250ZXh0Q3JlYXRpb25FcnJvcjpDb250ZXh0Q3JlYXRpb25FcnJvciwgR3JhcGhpY3NEZXZpY2U6R3JhcGhpY3NEZXZpY2UsIHByZWNhbGN1bGF0ZWRUYW5nZW50czp0cnVlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgc2hhZGVyQ2h1bmtzID0ge307XG4gIHZhciBhdHRyaWIyU2VtYW50aWMgPSB7dmVydGV4X3Bvc2l0aW9uOnBjLlNFTUFOVElDX1BPU0lUSU9OLCB2ZXJ0ZXhfbm9ybWFsOnBjLlNFTUFOVElDX05PUk1BTCwgdmVydGV4X3RhbmdlbnQ6cGMuU0VNQU5USUNfVEFOR0VOVCwgdmVydGV4X3RleENvb3JkMDpwYy5TRU1BTlRJQ19URVhDT09SRDAsIHZlcnRleF90ZXhDb29yZDE6cGMuU0VNQU5USUNfVEVYQ09PUkQxLCB2ZXJ0ZXhfdGV4Q29vcmQyOnBjLlNFTUFOVElDX1RFWENPT1JEMiwgdmVydGV4X3RleENvb3JkMzpwYy5TRU1BTlRJQ19URVhDT09SRDMsIHZlcnRleF90ZXhDb29yZDQ6cGMuU0VNQU5USUNfVEVYQ09PUkQ0LCB2ZXJ0ZXhfdGV4Q29vcmQ1OnBjLlNFTUFOVElDX1RFWENPT1JENSwgdmVydGV4X3RleENvb3JkNjpwYy5TRU1BTlRJQ19URVhDT09SRDYsIHZlcnRleF90ZXhDb29yZDc6cGMuU0VNQU5USUNfVEVYQ09PUkQ3LCB2ZXJ0ZXhfY29sb3I6cGMuU0VNQU5USUNfQ09MT1IsIHZlcnRleF9ib25lSW5kaWNlczpwYy5TRU1BTlRJQ19CTEVORElORElDRVMsXG4gIHZlcnRleF9ib25lV2VpZ2h0czpwYy5TRU1BTlRJQ19CTEVORFdFSUdIVH07XG4gIHNoYWRlckNodW5rcy5jb2xsZWN0QXR0cmlicyA9IGZ1bmN0aW9uKHZzQ29kZSkge1xuICAgIHZhciBhdHRyaWJzID0ge307XG4gICAgdmFyIGF0dHJzID0gMDtcbiAgICB2YXIgZm91bmQgPSB2c0NvZGUuaW5kZXhPZihcImF0dHJpYnV0ZVwiKTtcbiAgICB3aGlsZSAoZm91bmQgPj0gMCkge1xuICAgICAgaWYgKGZvdW5kID4gMCAmJiB2c0NvZGVbZm91bmQgLSAxXSA9PT0gXCIvXCIpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB2YXIgZW5kT2ZMaW5lID0gdnNDb2RlLmluZGV4T2YoXCI7XCIsIGZvdW5kKTtcbiAgICAgIHZhciBzdGFydE9mQXR0cmliTmFtZSA9IHZzQ29kZS5sYXN0SW5kZXhPZihcIiBcIiwgZW5kT2ZMaW5lKTtcbiAgICAgIHZhciBhdHRyaWJOYW1lID0gdnNDb2RlLnN1YnN0cihzdGFydE9mQXR0cmliTmFtZSArIDEsIGVuZE9mTGluZSAtIChzdGFydE9mQXR0cmliTmFtZSArIDEpKTtcbiAgICAgIHZhciBzZW1hbnRpYyA9IGF0dHJpYjJTZW1hbnRpY1thdHRyaWJOYW1lXTtcbiAgICAgIGlmIChzZW1hbnRpYyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGF0dHJpYnNbYXR0cmliTmFtZV0gPSBzZW1hbnRpYztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF0dHJpYnNbYXR0cmliTmFtZV0gPSBcIkFUVFJcIiArIGF0dHJzO1xuICAgICAgICBhdHRycysrO1xuICAgICAgfVxuICAgICAgZm91bmQgPSB2c0NvZGUuaW5kZXhPZihcImF0dHJpYnV0ZVwiLCBmb3VuZCArIDEpO1xuICAgIH1cbiAgICByZXR1cm4gYXR0cmlicztcbiAgfTtcbiAgc2hhZGVyQ2h1bmtzLmNyZWF0ZVNoYWRlciA9IGZ1bmN0aW9uKGRldmljZSwgdnNOYW1lLCBwc05hbWUsIHVzZVRyYW5zZm9ybUZlZWRiYWNrKSB7XG4gICAgdmFyIHZzQ29kZSA9IHNoYWRlckNodW5rc1t2c05hbWVdO1xuICAgIHZhciBwc0NvZGUgPSBwYy5wcm9ncmFtbGliLnByZWNpc2lvbkNvZGUoZGV2aWNlKSArIFwiXFxuXCIgKyBzaGFkZXJDaHVua3NbcHNOYW1lXTtcbiAgICB2YXIgYXR0cmlicyA9IHRoaXMuY29sbGVjdEF0dHJpYnModnNDb2RlKTtcbiAgICBpZiAoZGV2aWNlLndlYmdsMikge1xuICAgICAgdnNDb2RlID0gcGMucHJvZ3JhbWxpYi52ZXJzaW9uQ29kZShkZXZpY2UpICsgdGhpcy5nbGVzM1ZTICsgdnNDb2RlO1xuICAgICAgcHNDb2RlID0gcGMucHJvZ3JhbWxpYi52ZXJzaW9uQ29kZShkZXZpY2UpICsgdGhpcy5nbGVzM1BTICsgcHNDb2RlO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IHBjLlNoYWRlcihkZXZpY2UsIHthdHRyaWJ1dGVzOmF0dHJpYnMsIHZzaGFkZXI6dnNDb2RlLCBmc2hhZGVyOnBzQ29kZSwgdXNlVHJhbnNmb3JtRmVlZGJhY2s6dXNlVHJhbnNmb3JtRmVlZGJhY2t9KTtcbiAgfTtcbiAgc2hhZGVyQ2h1bmtzLmNyZWF0ZVNoYWRlckZyb21Db2RlID0gZnVuY3Rpb24oZGV2aWNlLCB2c0NvZGUsIHBzQ29kZSwgdU5hbWUsIHVzZVRyYW5zZm9ybUZlZWRiYWNrKSB7XG4gICAgdmFyIHNoYWRlckNhY2hlID0gZGV2aWNlLnByb2dyYW1MaWIuX2NhY2hlO1xuICAgIHZhciBjYWNoZWQgPSBzaGFkZXJDYWNoZVt1TmFtZV07XG4gICAgaWYgKGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY2FjaGVkO1xuICAgIH1cbiAgICBwc0NvZGUgPSBwYy5wcm9ncmFtbGliLnByZWNpc2lvbkNvZGUoZGV2aWNlKSArIFwiXFxuXCIgKyAocHNDb2RlIHx8IHBjLnByb2dyYW1saWIuZHVtbXlGcmFnbWVudENvZGUoKSk7XG4gICAgdmFyIGF0dHJpYnMgPSB0aGlzLmNvbGxlY3RBdHRyaWJzKHZzQ29kZSk7XG4gICAgaWYgKGRldmljZS53ZWJnbDIpIHtcbiAgICAgIHZzQ29kZSA9IHBjLnByb2dyYW1saWIudmVyc2lvbkNvZGUoZGV2aWNlKSArIHRoaXMuZ2xlczNWUyArIHZzQ29kZTtcbiAgICAgIHBzQ29kZSA9IHBjLnByb2dyYW1saWIudmVyc2lvbkNvZGUoZGV2aWNlKSArIHRoaXMuZ2xlczNQUyArIHBzQ29kZTtcbiAgICB9XG4gICAgc2hhZGVyQ2FjaGVbdU5hbWVdID0gbmV3IHBjLlNoYWRlcihkZXZpY2UsIHthdHRyaWJ1dGVzOmF0dHJpYnMsIHZzaGFkZXI6dnNDb2RlLCBmc2hhZGVyOnBzQ29kZSwgdXNlVHJhbnNmb3JtRmVlZGJhY2s6dXNlVHJhbnNmb3JtRmVlZGJhY2t9KTtcbiAgICByZXR1cm4gc2hhZGVyQ2FjaGVbdU5hbWVdO1xuICB9O1xuICByZXR1cm4ge3NoYWRlckNodW5rczpzaGFkZXJDaHVua3N9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBfcG9zdEVmZmVjdFF1YWRWQiA9IG51bGw7XG4gIHZhciBfcG9zdEVmZmVjdFF1YWREcmF3ID0ge3R5cGU6cGMuUFJJTUlUSVZFX1RSSVNUUklQLCBiYXNlOjAsIGNvdW50OjQsIGluZGV4ZWQ6ZmFsc2V9O1xuICBmdW5jdGlvbiBkcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0YXJnZXQsIHNoYWRlciwgcmVjdCwgc2Npc3NvclJlY3QsIHVzZUJsZW5kKSB7XG4gICAgaWYgKF9wb3N0RWZmZWN0UXVhZFZCID09PSBudWxsKSB7XG4gICAgICB2YXIgdmVydGV4Rm9ybWF0ID0gbmV3IHBjLlZlcnRleEZvcm1hdChkZXZpY2UsIFt7c2VtYW50aWM6cGMuU0VNQU5USUNfUE9TSVRJT04sIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XSk7XG4gICAgICBfcG9zdEVmZmVjdFF1YWRWQiA9IG5ldyBwYy5WZXJ0ZXhCdWZmZXIoZGV2aWNlLCB2ZXJ0ZXhGb3JtYXQsIDQpO1xuICAgICAgdmFyIGl0ZXJhdG9yID0gbmV3IHBjLlZlcnRleEl0ZXJhdG9yKF9wb3N0RWZmZWN0UXVhZFZCKTtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCgtMS4wLCAtMS4wKTtcbiAgICAgIGl0ZXJhdG9yLm5leHQoKTtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCgxLjAsIC0xLjApO1xuICAgICAgaXRlcmF0b3IubmV4dCgpO1xuICAgICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19QT1NJVElPTl0uc2V0KC0xLjAsIDEuMCk7XG4gICAgICBpdGVyYXRvci5uZXh0KCk7XG4gICAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX1BPU0lUSU9OXS5zZXQoMS4wLCAxLjApO1xuICAgICAgaXRlcmF0b3IuZW5kKCk7XG4gICAgfVxuICAgIHZhciBvbGRSdCA9IGRldmljZS5yZW5kZXJUYXJnZXQ7XG4gICAgZGV2aWNlLnNldFJlbmRlclRhcmdldCh0YXJnZXQpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICAgIHZhciB4LCB5LCB3LCBoO1xuICAgIHZhciBzeCwgc3ksIHN3LCBzaDtcbiAgICBpZiAoIXJlY3QpIHtcbiAgICAgIHcgPSB0YXJnZXQgIT09IG51bGwgPyB0YXJnZXQud2lkdGggOiBkZXZpY2Uud2lkdGg7XG4gICAgICBoID0gdGFyZ2V0ICE9PSBudWxsID8gdGFyZ2V0LmhlaWdodCA6IGRldmljZS5oZWlnaHQ7XG4gICAgICB4ID0gMDtcbiAgICAgIHkgPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICB4ID0gcmVjdC54O1xuICAgICAgeSA9IHJlY3QueTtcbiAgICAgIHcgPSByZWN0Lno7XG4gICAgICBoID0gcmVjdC53O1xuICAgIH1cbiAgICBpZiAoIXNjaXNzb3JSZWN0KSB7XG4gICAgICBzeCA9IHg7XG4gICAgICBzeSA9IHk7XG4gICAgICBzdyA9IHc7XG4gICAgICBzaCA9IGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN4ID0gc2Npc3NvclJlY3QueDtcbiAgICAgIHN5ID0gc2Npc3NvclJlY3QueTtcbiAgICAgIHN3ID0gc2Npc3NvclJlY3QuejtcbiAgICAgIHNoID0gc2Npc3NvclJlY3QudztcbiAgICB9XG4gICAgZGV2aWNlLnNldFZpZXdwb3J0KHgsIHksIHcsIGgpO1xuICAgIGRldmljZS5zZXRTY2lzc29yKHN4LCBzeSwgc3csIHNoKTtcbiAgICB2YXIgb2xkRGVwdGhUZXN0ID0gZGV2aWNlLmdldERlcHRoVGVzdCgpO1xuICAgIHZhciBvbGREZXB0aFdyaXRlID0gZGV2aWNlLmdldERlcHRoV3JpdGUoKTtcbiAgICB2YXIgb2xkQ3VsbCA9IGRldmljZS5nZXRDdWxsTW9kZSgpO1xuICAgIGRldmljZS5zZXREZXB0aFRlc3QoZmFsc2UpO1xuICAgIGRldmljZS5zZXREZXB0aFdyaXRlKGZhbHNlKTtcbiAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUocGMuQ1VMTEZBQ0VfTk9ORSk7XG4gICAgaWYgKCF1c2VCbGVuZCkge1xuICAgICAgZGV2aWNlLnNldEJsZW5kaW5nKGZhbHNlKTtcbiAgICB9XG4gICAgZGV2aWNlLnNldFZlcnRleEJ1ZmZlcihfcG9zdEVmZmVjdFF1YWRWQiwgMCk7XG4gICAgZGV2aWNlLnNldFNoYWRlcihzaGFkZXIpO1xuICAgIGRldmljZS5kcmF3KF9wb3N0RWZmZWN0UXVhZERyYXcpO1xuICAgIGRldmljZS5zZXREZXB0aFRlc3Qob2xkRGVwdGhUZXN0KTtcbiAgICBkZXZpY2Uuc2V0RGVwdGhXcml0ZShvbGREZXB0aFdyaXRlKTtcbiAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUob2xkQ3VsbCk7XG4gICAgZGV2aWNlLnVwZGF0ZUVuZCgpO1xuICAgIGRldmljZS5zZXRSZW5kZXJUYXJnZXQob2xkUnQpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICB9XG4gIGZ1bmN0aW9uIGRlc3Ryb3lQb3N0RWZmZWN0UXVhZCgpIHtcbiAgICBfcG9zdEVmZmVjdFF1YWRWQiA9IG51bGw7XG4gIH1cbiAgcmV0dXJuIHtkcmF3UXVhZFdpdGhTaGFkZXI6ZHJhd1F1YWRXaXRoU2hhZGVyLCBkZXN0cm95UG9zdEVmZmVjdFF1YWQ6ZGVzdHJveVBvc3RFZmZlY3RRdWFkfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICBmdW5jdGlvbiBmaXhDaHJvbWUoKSB7XG4gICAgdmFyIGVuZFRpbWUgPSBEYXRlLm5vdygpICsgMTA7XG4gICAgd2hpbGUgKERhdGUubm93KCkgPCBlbmRUaW1lKSB7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHN5bmNUb0NwdShkZXZpY2UsIHRhcmcsIGZhY2UpIHtcbiAgICB2YXIgdGV4ID0gdGFyZy5fY29sb3JCdWZmZXI7XG4gICAgaWYgKHRleC5mb3JtYXQgIT0gcGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHBpeGVscyA9IG5ldyBVaW50OEFycmF5KHRleC53aWR0aCAqIHRleC5oZWlnaHQgKiA0KTtcbiAgICB2YXIgZ2wgPSBkZXZpY2UuZ2w7XG4gICAgZGV2aWNlLnNldEZyYW1lYnVmZmVyKHRhcmcuX2dsRnJhbWVCdWZmZXIpO1xuICAgIGdsLnJlYWRQaXhlbHMoMCwgMCwgdGV4LndpZHRoLCB0ZXguaGVpZ2h0LCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBwaXhlbHMpO1xuICAgIGlmICghdGV4Ll9sZXZlbHMpIHtcbiAgICAgIHRleC5fbGV2ZWxzID0gW107XG4gICAgfVxuICAgIGlmICghdGV4Ll9sZXZlbHNbMF0pIHtcbiAgICAgIHRleC5fbGV2ZWxzWzBdID0gW107XG4gICAgfVxuICAgIHRleC5fbGV2ZWxzWzBdW2ZhY2VdID0gcGl4ZWxzO1xuICB9XG4gIGZ1bmN0aW9uIHByZWZpbHRlckN1YmVtYXAob3B0aW9ucykge1xuICAgIHZhciBkZXZpY2UgPSBvcHRpb25zLmRldmljZTtcbiAgICB2YXIgc291cmNlQ3ViZW1hcCA9IG9wdGlvbnMuc291cmNlQ3ViZW1hcDtcbiAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy5tZXRob2Q7XG4gICAgdmFyIHNhbXBsZXMgPSBvcHRpb25zLnNhbXBsZXM7XG4gICAgdmFyIGNwdVN5bmMgPSBvcHRpb25zLmNwdVN5bmM7XG4gICAgdmFyIGNocm9tZUZpeCA9IG9wdGlvbnMuY2hyb21lRml4O1xuICAgIGlmIChjcHVTeW5jICYmICFzb3VyY2VDdWJlbWFwLl9sZXZlbHNbMF0pIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogcHJlZmlsdGVyOiBjdWJlbWFwIG11c3QgaGF2ZSBfbGV2ZWxzXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICAgIHZhciByZ2JtU291cmNlID0gc291cmNlQ3ViZW1hcC5yZ2JtO1xuICAgIHZhciBzaGFkZXIgPSBjaHVua3MuY3JlYXRlU2hhZGVyRnJvbUNvZGUoZGV2aWNlLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgY2h1bmtzLnJnYm1QUyArIGNodW5rcy5wcmVmaWx0ZXJDdWJlbWFwUFMucmVwbGFjZSgvXFwkTUVUSE9EL2csIG1ldGhvZCA9PT0gMCA/IFwiY29zXCIgOiBcInBob25nXCIpLnJlcGxhY2UoL1xcJE5VTVNBTVBMRVMvZywgc2FtcGxlcykucmVwbGFjZSgvXFwkdGV4dHVyZUN1YmUvZywgcmdibVNvdXJjZSA/IFwidGV4dHVyZUN1YmVSR0JNXCIgOiBcInRleHR1cmVDdWJlXCIpLCBcInByZWZpbHRlclwiICsgbWV0aG9kICsgXCJcIiArIHNhbXBsZXMgKyBcIlwiICsgcmdibVNvdXJjZSk7XG4gICAgdmFyIHNoYWRlcjIgPSBjaHVua3MuY3JlYXRlU2hhZGVyRnJvbUNvZGUoZGV2aWNlLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgY2h1bmtzLm91dHB1dEN1YmVtYXBQUywgXCJvdXRwdXRDdWJlbWFwXCIpO1xuICAgIHZhciBjb25zdGFudFRleFNvdXJjZSA9IGRldmljZS5zY29wZS5yZXNvbHZlKFwic291cmNlXCIpO1xuICAgIHZhciBjb25zdGFudFBhcmFtcyA9IGRldmljZS5zY29wZS5yZXNvbHZlKFwicGFyYW1zXCIpO1xuICAgIHZhciBwYXJhbXMgPSBuZXcgcGMuVmVjNDtcbiAgICB2YXIgc2l6ZSA9IHNvdXJjZUN1YmVtYXAud2lkdGg7XG4gICAgdmFyIGZvcm1hdCA9IHNvdXJjZUN1YmVtYXAuZm9ybWF0O1xuICAgIHZhciBjbWFwc0xpc3QgPSBbW10sIG9wdGlvbnMuZmlsdGVyZWRGaXhlZCwgb3B0aW9ucy5maWx0ZXJlZFJnYm0sIG9wdGlvbnMuZmlsdGVyZWRGaXhlZFJnYm1dO1xuICAgIHZhciBnbG9zcyA9IG1ldGhvZCA9PT0gMCA/IFswLjksIDAuODUsIDAuNywgMC40LCAwLjI1XSA6IFs1MTIsIDEyOCwgMzIsIDgsIDJdO1xuICAgIHZhciBtaXBTaXplID0gWzY0LCAzMiwgMTYsIDgsIDRdO1xuICAgIHZhciBudW1NaXBzID0gNTtcbiAgICB2YXIgdGFyZztcbiAgICB2YXIgaSwgZmFjZSwgcGFzcztcbiAgICB2YXIgcmdiRm9ybWF0ID0gZm9ybWF0ID09PSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9CODtcbiAgICB2YXIgaXNJbWcgPSBmYWxzZTtcbiAgICB2YXIgbmV4dEN1YmVtYXAsIGN1YmVtYXA7XG4gICAgaWYgKGNwdVN5bmMpIHtcbiAgICAgIGlzSW1nID0gc291cmNlQ3ViZW1hcC5fbGV2ZWxzWzBdWzBdIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudDtcbiAgICB9XG4gICAgaWYgKChyZ2JGb3JtYXQgfHwgaXNJbWcpICYmIGNwdVN5bmMpIHtcbiAgICAgIGZvcm1hdCA9IHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4O1xuICAgICAgbmV4dEN1YmVtYXAgPSBuZXcgcGMuZ2Z4LlRleHR1cmUoZGV2aWNlLCB7Y3ViZW1hcDp0cnVlLCByZ2JtOnJnYm1Tb3VyY2UsIGZvcm1hdDpmb3JtYXQsIHdpZHRoOnNpemUsIGhlaWdodDpzaXplLCBtaXBtYXBzOmZhbHNlfSk7XG4gICAgICBmb3IgKGZhY2UgPSAwO2ZhY2UgPCA2O2ZhY2UrKykge1xuICAgICAgICB0YXJnID0gbmV3IHBjLlJlbmRlclRhcmdldChkZXZpY2UsIG5leHRDdWJlbWFwLCB7ZmFjZTpmYWNlLCBkZXB0aDpmYWxzZX0pO1xuICAgICAgICBwYXJhbXMueCA9IGZhY2U7XG4gICAgICAgIHBhcmFtcy55ID0gMDtcbiAgICAgICAgY29uc3RhbnRUZXhTb3VyY2Uuc2V0VmFsdWUoc291cmNlQ3ViZW1hcCk7XG4gICAgICAgIGNvbnN0YW50UGFyYW1zLnNldFZhbHVlKHBhcmFtcy5kYXRhKTtcbiAgICAgICAgaWYgKGNocm9tZUZpeCkge1xuICAgICAgICAgIGZpeENocm9tZSgpO1xuICAgICAgICB9XG4gICAgICAgIHBjLmRyYXdRdWFkV2l0aFNoYWRlcihkZXZpY2UsIHRhcmcsIHNoYWRlcjIpO1xuICAgICAgICBzeW5jVG9DcHUoZGV2aWNlLCB0YXJnLCBmYWNlKTtcbiAgICAgIH1cbiAgICAgIHNvdXJjZUN1YmVtYXAgPSBuZXh0Q3ViZW1hcDtcbiAgICB9XG4gICAgaWYgKHNpemUgPiAxMjgpIHtcbiAgICAgIHZhciBsb2cxMjggPSBNYXRoLnJvdW5kKE1hdGgubG9nMigxMjgpKTtcbiAgICAgIHZhciBsb2dTaXplID0gTWF0aC5yb3VuZChNYXRoLmxvZzIoc2l6ZSkpO1xuICAgICAgdmFyIHN0ZXBzID0gbG9nU2l6ZSAtIGxvZzEyODtcbiAgICAgIGZvciAoaSA9IDA7aSA8IHN0ZXBzO2krKykge1xuICAgICAgICBzaXplID0gc291cmNlQ3ViZW1hcC53aWR0aCAqIDAuNTtcbiAgICAgICAgdmFyIHNhbXBsZUdsb3NzID0gbWV0aG9kID09PSAwID8gMSA6IE1hdGgucG93KDIsIE1hdGgucm91bmQoTWF0aC5sb2cyKGdsb3NzWzBdKSArIChzdGVwcyAtIGkpICogMikpO1xuICAgICAgICBuZXh0Q3ViZW1hcCA9IG5ldyBwYy5nZnguVGV4dHVyZShkZXZpY2UsIHtjdWJlbWFwOnRydWUsIHJnYm06cmdibVNvdXJjZSwgZm9ybWF0OmZvcm1hdCwgd2lkdGg6c2l6ZSwgaGVpZ2h0OnNpemUsIG1pcG1hcHM6ZmFsc2V9KTtcbiAgICAgICAgZm9yIChmYWNlID0gMDtmYWNlIDwgNjtmYWNlKyspIHtcbiAgICAgICAgICB0YXJnID0gbmV3IHBjLlJlbmRlclRhcmdldChkZXZpY2UsIG5leHRDdWJlbWFwLCB7ZmFjZTpmYWNlLCBkZXB0aDpmYWxzZX0pO1xuICAgICAgICAgIHBhcmFtcy54ID0gZmFjZTtcbiAgICAgICAgICBwYXJhbXMueSA9IHNhbXBsZUdsb3NzO1xuICAgICAgICAgIHBhcmFtcy56ID0gc2l6ZTtcbiAgICAgICAgICBwYXJhbXMudyA9IHJnYm1Tb3VyY2UgPyAzIDogMDtcbiAgICAgICAgICBjb25zdGFudFRleFNvdXJjZS5zZXRWYWx1ZShzb3VyY2VDdWJlbWFwKTtcbiAgICAgICAgICBjb25zdGFudFBhcmFtcy5zZXRWYWx1ZShwYXJhbXMuZGF0YSk7XG4gICAgICAgICAgaWYgKGNocm9tZUZpeCkge1xuICAgICAgICAgICAgZml4Q2hyb21lKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHBjLmRyYXdRdWFkV2l0aFNoYWRlcihkZXZpY2UsIHRhcmcsIHNoYWRlcjIpO1xuICAgICAgICAgIGlmIChpID09PSBzdGVwcyAtIDEgJiYgY3B1U3luYykge1xuICAgICAgICAgICAgc3luY1RvQ3B1KGRldmljZSwgdGFyZywgZmFjZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHNvdXJjZUN1YmVtYXAgPSBuZXh0Q3ViZW1hcDtcbiAgICAgIH1cbiAgICB9XG4gICAgb3B0aW9ucy5zb3VyY2VDdWJlbWFwID0gc291cmNlQ3ViZW1hcDtcbiAgICB2YXIgc291cmNlQ3ViZW1hcFJnYm0gPSBudWxsO1xuICAgIGlmICghcmdibVNvdXJjZSAmJiBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtKSB7XG4gICAgICBuZXh0Q3ViZW1hcCA9IG5ldyBwYy5nZnguVGV4dHVyZShkZXZpY2UsIHtjdWJlbWFwOnRydWUsIHJnYm06dHJ1ZSwgZm9ybWF0OnBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCB3aWR0aDpzaXplLCBoZWlnaHQ6c2l6ZSwgbWlwbWFwczpmYWxzZX0pO1xuICAgICAgZm9yIChmYWNlID0gMDtmYWNlIDwgNjtmYWNlKyspIHtcbiAgICAgICAgdGFyZyA9IG5ldyBwYy5SZW5kZXJUYXJnZXQoZGV2aWNlLCBuZXh0Q3ViZW1hcCwge2ZhY2U6ZmFjZSwgZGVwdGg6ZmFsc2V9KTtcbiAgICAgICAgcGFyYW1zLnggPSBmYWNlO1xuICAgICAgICBwYXJhbXMudyA9IDI7XG4gICAgICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHNvdXJjZUN1YmVtYXApO1xuICAgICAgICBjb25zdGFudFBhcmFtcy5zZXRWYWx1ZShwYXJhbXMuZGF0YSk7XG4gICAgICAgIGlmIChjaHJvbWVGaXgpIHtcbiAgICAgICAgICBmaXhDaHJvbWUoKTtcbiAgICAgICAgfVxuICAgICAgICBwYy5kcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0YXJnLCBzaGFkZXIyKTtcbiAgICAgICAgc3luY1RvQ3B1KGRldmljZSwgdGFyZywgZmFjZSk7XG4gICAgICB9XG4gICAgICBzb3VyY2VDdWJlbWFwUmdibSA9IG5leHRDdWJlbWFwO1xuICAgIH1cbiAgICB2YXIgdW5ibHVycmVkR2xvc3MgPSBtZXRob2QgPT09IDAgPyAxIDogMjA0ODtcbiAgICB2YXIgc3RhcnRQYXNzID0gbWV0aG9kID09PSAwID8gMCA6IC0xO1xuICAgIGNtYXBzTGlzdFtzdGFydFBhc3NdID0gW107XG4gICAgZm9yIChpID0gMDtpIDwgbnVtTWlwcztpKyspIHtcbiAgICAgIGZvciAocGFzcyA9IHN0YXJ0UGFzcztwYXNzIDwgY21hcHNMaXN0Lmxlbmd0aDtwYXNzKyspIHtcbiAgICAgICAgaWYgKGNtYXBzTGlzdFtwYXNzXSAhPSBudWxsKSB7XG4gICAgICAgICAgY21hcHNMaXN0W3Bhc3NdW2ldID0gbmV3IHBjLmdmeC5UZXh0dXJlKGRldmljZSwge2N1YmVtYXA6dHJ1ZSwgcmdibTpwYXNzIDwgMiA/IHJnYm1Tb3VyY2UgOiB0cnVlLCBmb3JtYXQ6cGFzcyA8IDIgPyBmb3JtYXQgOiBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgZml4Q3ViZW1hcFNlYW1zOnBhc3MgPT09IDEgfHwgcGFzcyA9PT0gMywgd2lkdGg6bWlwU2l6ZVtpXSwgaGVpZ2h0Om1pcFNpemVbaV0sIG1pcG1hcHM6ZmFsc2V9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHBhc3MgPSBzdGFydFBhc3M7cGFzcyA8IGNtYXBzTGlzdC5sZW5ndGg7cGFzcysrKSB7XG4gICAgICBpZiAoY21hcHNMaXN0W3Bhc3NdICE9IG51bGwpIHtcbiAgICAgICAgaWYgKHBhc3MgPiAxICYmIHJnYm1Tb3VyY2UpIHtcbiAgICAgICAgICBjbWFwc0xpc3RbcGFzc10gPSBjbWFwc0xpc3RbcGFzcyAtIDJdO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IG51bU1pcHM7aSsrKSB7XG4gICAgICAgICAgZm9yIChmYWNlID0gMDtmYWNlIDwgNjtmYWNlKyspIHtcbiAgICAgICAgICAgIHRhcmcgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGRldmljZSwgY21hcHNMaXN0W3Bhc3NdW2ldLCB7ZmFjZTpmYWNlLCBkZXB0aDpmYWxzZX0pO1xuICAgICAgICAgICAgcGFyYW1zLnggPSBmYWNlO1xuICAgICAgICAgICAgcGFyYW1zLnkgPSBwYXNzIDwgMCA/IHVuYmx1cnJlZEdsb3NzIDogZ2xvc3NbaV07XG4gICAgICAgICAgICBwYXJhbXMueiA9IG1pcFNpemVbaV07XG4gICAgICAgICAgICBwYXJhbXMudyA9IHJnYm1Tb3VyY2UgPyAzIDogcGFzcztcbiAgICAgICAgICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKGkgPT09IDAgPyBzb3VyY2VDdWJlbWFwIDogbWV0aG9kID09PSAwID8gY21hcHNMaXN0WzBdW2kgLSAxXSA6IGNtYXBzTGlzdFstMV1baSAtIDFdKTtcbiAgICAgICAgICAgIGNvbnN0YW50UGFyYW1zLnNldFZhbHVlKHBhcmFtcy5kYXRhKTtcbiAgICAgICAgICAgIGlmIChjaHJvbWVGaXgpIHtcbiAgICAgICAgICAgICAgZml4Q2hyb21lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYy5kcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0YXJnLCBzaGFkZXIpO1xuICAgICAgICAgICAgaWYgKGNwdVN5bmMpIHtcbiAgICAgICAgICAgICAgc3luY1RvQ3B1KGRldmljZSwgdGFyZywgZmFjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIG9wdGlvbnMuZmlsdGVyZWQgPSBjbWFwc0xpc3RbMF07XG4gICAgdmFyIG1pcHM7XG4gICAgaWYgKGNwdVN5bmMgJiYgb3B0aW9ucy5zaW5nbGVGaWx0ZXJlZEZpeGVkKSB7XG4gICAgICBtaXBzID0gW3NvdXJjZUN1YmVtYXAsIG9wdGlvbnMuZmlsdGVyZWRGaXhlZFswXSwgb3B0aW9ucy5maWx0ZXJlZEZpeGVkWzFdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRbMl0sIG9wdGlvbnMuZmlsdGVyZWRGaXhlZFszXSwgb3B0aW9ucy5maWx0ZXJlZEZpeGVkWzRdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRbNV1dO1xuICAgICAgY3ViZW1hcCA9IG5ldyBwYy5nZnguVGV4dHVyZShkZXZpY2UsIHtjdWJlbWFwOnRydWUsIHJnYm06cmdibVNvdXJjZSwgZml4Q3ViZW1hcFNlYW1zOnRydWUsIGZvcm1hdDpmb3JtYXQsIHdpZHRoOjEyOCwgaGVpZ2h0OjEyOCwgYWRkcmVzc1U6cGMuQUREUkVTU19DTEFNUF9UT19FREdFLCBhZGRyZXNzVjpwYy5BRERSRVNTX0NMQU1QX1RPX0VER0V9KTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IDY7aSsrKSB7XG4gICAgICAgIGN1YmVtYXAuX2xldmVsc1tpXSA9IG1pcHNbaV0uX2xldmVsc1swXTtcbiAgICAgIH1cbiAgICAgIGN1YmVtYXAudXBsb2FkKCk7XG4gICAgICBjdWJlbWFwLl9wcmVmaWx0ZXJlZE1pcHMgPSB0cnVlO1xuICAgICAgb3B0aW9ucy5zaW5nbGVGaWx0ZXJlZEZpeGVkID0gY3ViZW1hcDtcbiAgICB9XG4gICAgaWYgKGNwdVN5bmMgJiYgb3B0aW9ucy5zaW5nbGVGaWx0ZXJlZEZpeGVkUmdibSAmJiBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtKSB7XG4gICAgICBtaXBzID0gW3NvdXJjZUN1YmVtYXBSZ2JtLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzBdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzFdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzJdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzNdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzRdLCBvcHRpb25zLmZpbHRlcmVkRml4ZWRSZ2JtWzVdXTtcbiAgICAgIGN1YmVtYXAgPSBuZXcgcGMuZ2Z4LlRleHR1cmUoZGV2aWNlLCB7Y3ViZW1hcDp0cnVlLCByZ2JtOnRydWUsIGZpeEN1YmVtYXBTZWFtczp0cnVlLCBmb3JtYXQ6cGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgsIHdpZHRoOjEyOCwgaGVpZ2h0OjEyOCwgYWRkcmVzc1U6cGMuQUREUkVTU19DTEFNUF9UT19FREdFLCBhZGRyZXNzVjpwYy5BRERSRVNTX0NMQU1QX1RPX0VER0V9KTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IDY7aSsrKSB7XG4gICAgICAgIGN1YmVtYXAuX2xldmVsc1tpXSA9IG1pcHNbaV0uX2xldmVsc1swXTtcbiAgICAgIH1cbiAgICAgIGN1YmVtYXAudXBsb2FkKCk7XG4gICAgICBjdWJlbWFwLl9wcmVmaWx0ZXJlZE1pcHMgPSB0cnVlO1xuICAgICAgb3B0aW9ucy5zaW5nbGVGaWx0ZXJlZEZpeGVkUmdibSA9IGN1YmVtYXA7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIGFyZWFFbGVtZW50KHgsIHkpIHtcbiAgICByZXR1cm4gTWF0aC5hdGFuMih4ICogeSwgTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyAxKSk7XG4gIH1cbiAgZnVuY3Rpb24gdGV4ZWxDb29yZFNvbGlkQW5nbGUodSwgdiwgc2l6ZSkge1xuICAgIHZhciBfdSA9IDIuMCAqICh1ICsgMC41KSAvIHNpemUgLSAxLjA7XG4gICAgdmFyIF92ID0gMi4wICogKHYgKyAwLjUpIC8gc2l6ZSAtIDEuMDtcbiAgICBfdSAqPSAxLjAgLSAxLjAgLyBzaXplO1xuICAgIF92ICo9IDEuMCAtIDEuMCAvIHNpemU7XG4gICAgdmFyIGludlJlc29sdXRpb24gPSAxLjAgLyBzaXplO1xuICAgIHZhciB4MCA9IF91IC0gaW52UmVzb2x1dGlvbjtcbiAgICB2YXIgeTAgPSBfdiAtIGludlJlc29sdXRpb247XG4gICAgdmFyIHgxID0gX3UgKyBpbnZSZXNvbHV0aW9uO1xuICAgIHZhciB5MSA9IF92ICsgaW52UmVzb2x1dGlvbjtcbiAgICB2YXIgc29saWRBbmdsZSA9IGFyZWFFbGVtZW50KHgwLCB5MCkgLSBhcmVhRWxlbWVudCh4MCwgeTEpIC0gYXJlYUVsZW1lbnQoeDEsIHkwKSArIGFyZWFFbGVtZW50KHgxLCB5MSk7XG4gICAgaWYgKHUgPT09IDAgJiYgdiA9PT0gMCB8fCB1ID09PSBzaXplIC0gMSAmJiB2ID09PSAwIHx8IHUgPT09IDAgJiYgdiA9PT0gc2l6ZSAtIDEgfHwgdSA9PT0gc2l6ZSAtIDEgJiYgdiA9PT0gc2l6ZSAtIDEpIHtcbiAgICAgIHNvbGlkQW5nbGUgLz0gMztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHUgPT09IDAgfHwgdiA9PT0gMCB8fCB1ID09PSBzaXplIC0gMSB8fCB2ID09PSBzaXplIC0gMSkge1xuICAgICAgICBzb2xpZEFuZ2xlICo9IDAuNTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNvbGlkQW5nbGU7XG4gIH1cbiAgZnVuY3Rpb24gc2hGcm9tQ3ViZW1hcChzb3VyY2UsIGRvbnRGbGlwWCkge1xuICAgIHZhciBmYWNlO1xuICAgIHZhciBjdWJlU2l6ZSA9IHNvdXJjZS53aWR0aDtcbiAgICB2YXIgeCwgeTtcbiAgICBpZiAoc291cmNlLmZvcm1hdCAhPSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCkge1xuICAgICAgY29uc29sZS5lcnJvcihcIkVSUk9SOiBTSDogY3ViZW1hcCBtdXN0IGJlIFJHQkE4XCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXNvdXJjZS5fbGV2ZWxzWzBdKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRVJST1I6IFNIOiBjdWJlbWFwIG11c3QgYmUgc3luY2VkIHRvIENQVVwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCFzb3VyY2UuX2xldmVsc1swXVswXS5sZW5ndGgpIHtcbiAgICAgIGlmIChzb3VyY2UuX2xldmVsc1swXVswXSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpIHtcbiAgICAgICAgdmFyIGRldmljZSA9IHBjLkFwcGxpY2F0aW9uLmdldEFwcGxpY2F0aW9uKCkuZ3JhcGhpY3NEZXZpY2U7XG4gICAgICAgIHZhciBnbCA9IGRldmljZS5nbDtcbiAgICAgICAgdmFyIGNodW5rcyA9IHBjLnNoYWRlckNodW5rcztcbiAgICAgICAgdmFyIHNoYWRlciA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIGNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCBjaHVua3MuZnVsbHNjcmVlblF1YWRQUywgXCJmc1F1YWRTaW1wbGVcIik7XG4gICAgICAgIHZhciBjb25zdGFudFRleFNvdXJjZSA9IGRldmljZS5zY29wZS5yZXNvbHZlKFwic291cmNlXCIpO1xuICAgICAgICBmb3IgKGZhY2UgPSAwO2ZhY2UgPCA2O2ZhY2UrKykge1xuICAgICAgICAgIHZhciBpbWcgPSBzb3VyY2UuX2xldmVsc1swXVtmYWNlXTtcbiAgICAgICAgICB2YXIgdGV4ID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7Y3ViZW1hcDpmYWxzZSwgcmdibTpmYWxzZSwgZm9ybWF0OnNvdXJjZS5mb3JtYXQsIHdpZHRoOmN1YmVTaXplLCBoZWlnaHQ6Y3ViZVNpemUsIG1pcG1hcHM6ZmFsc2V9KTtcbiAgICAgICAgICB0ZXguX2xldmVsc1swXSA9IGltZztcbiAgICAgICAgICB0ZXgudXBsb2FkKCk7XG4gICAgICAgICAgdmFyIHRleDIgPSBuZXcgcGMuVGV4dHVyZShkZXZpY2UsIHtjdWJlbWFwOmZhbHNlLCByZ2JtOmZhbHNlLCBmb3JtYXQ6c291cmNlLmZvcm1hdCwgd2lkdGg6Y3ViZVNpemUsIGhlaWdodDpjdWJlU2l6ZSwgbWlwbWFwczpmYWxzZX0pO1xuICAgICAgICAgIHZhciB0YXJnID0gbmV3IHBjLlJlbmRlclRhcmdldChkZXZpY2UsIHRleDIsIHtkZXB0aDpmYWxzZX0pO1xuICAgICAgICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHRleCk7XG4gICAgICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKGRldmljZSwgdGFyZywgc2hhZGVyKTtcbiAgICAgICAgICB2YXIgcGl4ZWxzID0gbmV3IFVpbnQ4QXJyYXkoY3ViZVNpemUgKiBjdWJlU2l6ZSAqIDQpO1xuICAgICAgICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGFyZy5fZ2xGcmFtZUJ1ZmZlcik7XG4gICAgICAgICAgZ2wucmVhZFBpeGVscygwLCAwLCB0ZXgud2lkdGgsIHRleC5oZWlnaHQsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIHBpeGVscyk7XG4gICAgICAgICAgc291cmNlLl9sZXZlbHNbMF1bZmFjZV0gPSBwaXhlbHM7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogU0g6IGN1YmVtYXAgbXVzdCBiZSBjb21wb3NlZCBvZiBhcnJheXMgb3IgaW1hZ2VzXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBkaXJzID0gW107XG4gICAgZm9yICh5ID0gMDt5IDwgY3ViZVNpemU7eSsrKSB7XG4gICAgICBmb3IgKHggPSAwO3ggPCBjdWJlU2l6ZTt4KyspIHtcbiAgICAgICAgdmFyIHUgPSB4IC8gKGN1YmVTaXplIC0gMSkgKiAyIC0gMTtcbiAgICAgICAgdmFyIHYgPSB5IC8gKGN1YmVTaXplIC0gMSkgKiAyIC0gMTtcbiAgICAgICAgZGlyc1t5ICogY3ViZVNpemUgKyB4XSA9IChuZXcgcGMuVmVjMyh1LCB2LCAxLjApKS5ub3JtYWxpemUoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIHNoID0gbmV3IEZsb2F0MzJBcnJheSg5ICogMyk7XG4gICAgdmFyIGNvZWYxID0gMDtcbiAgICB2YXIgY29lZjIgPSAxICogMztcbiAgICB2YXIgY29lZjMgPSAyICogMztcbiAgICB2YXIgY29lZjQgPSAzICogMztcbiAgICB2YXIgY29lZjUgPSA0ICogMztcbiAgICB2YXIgY29lZjYgPSA1ICogMztcbiAgICB2YXIgY29lZjcgPSA2ICogMztcbiAgICB2YXIgY29lZjggPSA3ICogMztcbiAgICB2YXIgY29lZjkgPSA4ICogMztcbiAgICB2YXIgbnggPSAwO1xuICAgIHZhciBweCA9IDE7XG4gICAgdmFyIG55ID0gMjtcbiAgICB2YXIgcHkgPSAzO1xuICAgIHZhciBueiA9IDQ7XG4gICAgdmFyIHB6ID0gNTtcbiAgICB2YXIgYWRkciwgYywgYSwgdmFsdWUsIHdlaWdodCwgZGlyLCBkeCwgZHksIGR6O1xuICAgIHZhciB3ZWlnaHQxLCB3ZWlnaHQyLCB3ZWlnaHQzLCB3ZWlnaHQ0LCB3ZWlnaHQ1O1xuICAgIHZhciBhY2N1bSA9IDA7XG4gICAgZm9yIChmYWNlID0gMDtmYWNlIDwgNjtmYWNlKyspIHtcbiAgICAgIGZvciAoeSA9IDA7eSA8IGN1YmVTaXplO3krKykge1xuICAgICAgICBmb3IgKHggPSAwO3ggPCBjdWJlU2l6ZTt4KyspIHtcbiAgICAgICAgICBhZGRyID0geSAqIGN1YmVTaXplICsgeDtcbiAgICAgICAgICB3ZWlnaHQgPSB0ZXhlbENvb3JkU29saWRBbmdsZSh4LCB5LCBjdWJlU2l6ZSk7XG4gICAgICAgICAgd2VpZ2h0MSA9IHdlaWdodCAqIDQgLyAxNztcbiAgICAgICAgICB3ZWlnaHQyID0gd2VpZ2h0ICogOCAvIDE3O1xuICAgICAgICAgIHdlaWdodDMgPSB3ZWlnaHQgKiAxNSAvIDE3O1xuICAgICAgICAgIHdlaWdodDQgPSB3ZWlnaHQgKiA1IC8gNjg7XG4gICAgICAgICAgd2VpZ2h0NSA9IHdlaWdodCAqIDE1IC8gNjg7XG4gICAgICAgICAgZGlyID0gZGlyc1thZGRyXTtcbiAgICAgICAgICBpZiAoZmFjZSA9PSBueCkge1xuICAgICAgICAgICAgZHggPSBkaXIuejtcbiAgICAgICAgICAgIGR5ID0gLWRpci55O1xuICAgICAgICAgICAgZHogPSAtZGlyLng7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChmYWNlID09IHB4KSB7XG4gICAgICAgICAgICAgIGR4ID0gLWRpci56O1xuICAgICAgICAgICAgICBkeSA9IC1kaXIueTtcbiAgICAgICAgICAgICAgZHogPSBkaXIueDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChmYWNlID09IG55KSB7XG4gICAgICAgICAgICAgICAgZHggPSBkaXIueDtcbiAgICAgICAgICAgICAgICBkeSA9IGRpci56O1xuICAgICAgICAgICAgICAgIGR6ID0gZGlyLnk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGZhY2UgPT0gcHkpIHtcbiAgICAgICAgICAgICAgICAgIGR4ID0gZGlyLng7XG4gICAgICAgICAgICAgICAgICBkeSA9IC1kaXIuejtcbiAgICAgICAgICAgICAgICAgIGR6ID0gLWRpci55O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBpZiAoZmFjZSA9PSBueikge1xuICAgICAgICAgICAgICAgICAgICBkeCA9IGRpci54O1xuICAgICAgICAgICAgICAgICAgICBkeSA9IC1kaXIueTtcbiAgICAgICAgICAgICAgICAgICAgZHogPSBkaXIuejtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmYWNlID09IHB6KSB7XG4gICAgICAgICAgICAgICAgICAgICAgZHggPSAtZGlyLng7XG4gICAgICAgICAgICAgICAgICAgICAgZHkgPSAtZGlyLnk7XG4gICAgICAgICAgICAgICAgICAgICAgZHogPSAtZGlyLno7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFkb250RmxpcFgpIHtcbiAgICAgICAgICAgIGR4ID0gLWR4O1xuICAgICAgICAgIH1cbiAgICAgICAgICBhID0gc291cmNlLl9sZXZlbHNbMF1bZmFjZV1bYWRkciAqIDQgKyAzXSAvIDI1NS4wO1xuICAgICAgICAgIGZvciAoYyA9IDA7YyA8IDM7YysrKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHNvdXJjZS5fbGV2ZWxzWzBdW2ZhY2VdW2FkZHIgKiA0ICsgY10gLyAyNTUuMDtcbiAgICAgICAgICAgIGlmIChzb3VyY2UucmdibSkge1xuICAgICAgICAgICAgICB2YWx1ZSAqPSBhICogOC4wO1xuICAgICAgICAgICAgICB2YWx1ZSAqPSB2YWx1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5wb3codmFsdWUsIDIuMik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzaFtjb2VmMSArIGNdICs9IHZhbHVlICogd2VpZ2h0MTtcbiAgICAgICAgICAgIHNoW2NvZWYyICsgY10gKz0gdmFsdWUgKiB3ZWlnaHQyICogZHg7XG4gICAgICAgICAgICBzaFtjb2VmMyArIGNdICs9IHZhbHVlICogd2VpZ2h0MiAqIGR5O1xuICAgICAgICAgICAgc2hbY29lZjQgKyBjXSArPSB2YWx1ZSAqIHdlaWdodDIgKiBkejtcbiAgICAgICAgICAgIHNoW2NvZWY1ICsgY10gKz0gdmFsdWUgKiB3ZWlnaHQzICogZHggKiBkejtcbiAgICAgICAgICAgIHNoW2NvZWY2ICsgY10gKz0gdmFsdWUgKiB3ZWlnaHQzICogZHogKiBkeTtcbiAgICAgICAgICAgIHNoW2NvZWY3ICsgY10gKz0gdmFsdWUgKiB3ZWlnaHQzICogZHkgKiBkeDtcbiAgICAgICAgICAgIHNoW2NvZWY4ICsgY10gKz0gdmFsdWUgKiB3ZWlnaHQ0ICogKDMuMCAqIGR6ICogZHogLSAxLjApO1xuICAgICAgICAgICAgc2hbY29lZjkgKyBjXSArPSB2YWx1ZSAqIHdlaWdodDUgKiAoZHggKiBkeCAtIGR5ICogZHkpO1xuICAgICAgICAgICAgYWNjdW0gKz0gd2VpZ2h0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGMgPSAwO2MgPCBzaC5sZW5ndGg7YysrKSB7XG4gICAgICBzaFtjXSAqPSA0ICogTWF0aC5QSSAvIGFjY3VtO1xuICAgIH1cbiAgICByZXR1cm4gc2g7XG4gIH1cbiAgcmV0dXJuIHtwcmVmaWx0ZXJDdWJlbWFwOnByZWZpbHRlckN1YmVtYXAsIHNoRnJvbUN1YmVtYXA6c2hGcm9tQ3ViZW1hcH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIGRwTXVsdCA9IDIuMDtcbiAgZnVuY3Rpb24gcGFyYWJvbG9pZEZyb21DdWJlbWFwKGRldmljZSwgc291cmNlQ3ViZW1hcCwgZml4U2VhbXNBbW91bnQsIGRvbnRGbGlwWCkge1xuICAgIHZhciBjaHVua3MgPSBwYy5zaGFkZXJDaHVua3M7XG4gICAgdmFyIHNoYWRlciA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIGNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCAoc291cmNlQ3ViZW1hcC5maXhDdWJlbWFwU2VhbXMgPyBjaHVua3MuZml4Q3ViZW1hcFNlYW1zU3RyZXRjaFBTIDogY2h1bmtzLmZpeEN1YmVtYXBTZWFtc05vbmVQUykgKyBjaHVua3MuZ2VuUGFyYWJvbG9pZFBTLCBcImdlblBhcmFib2xvaWRcIik7XG4gICAgdmFyIGNvbnN0YW50VGV4U291cmNlID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoXCJzb3VyY2VcIik7XG4gICAgdmFyIGNvbnN0YW50UGFyYW1zID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoXCJwYXJhbXNcIik7XG4gICAgdmFyIHBhcmFtcyA9IG5ldyBwYy5WZWM0O1xuICAgIHZhciBzaXplID0gc291cmNlQ3ViZW1hcC53aWR0aDtcbiAgICB2YXIgcmdibVNvdXJjZSA9IHNvdXJjZUN1YmVtYXAucmdibTtcbiAgICB2YXIgZm9ybWF0ID0gc291cmNlQ3ViZW1hcC5mb3JtYXQ7XG4gICAgc2l6ZSA9IE1hdGgubWF4KHNpemUsIDgpICogZHBNdWx0O1xuICAgIHZhciB0ZXggPSBuZXcgcGMuZ2Z4LlRleHR1cmUoZGV2aWNlLCB7cmdibTpyZ2JtU291cmNlLCBmb3JtYXQ6Zm9ybWF0LCB3aWR0aDpzaXplICogMiwgaGVpZ2h0OnNpemUsIG1pcG1hcHM6ZmFsc2V9KTtcbiAgICB2YXIgdGFyZyA9IG5ldyBwYy5SZW5kZXJUYXJnZXQoZGV2aWNlLCB0ZXgsIHtkZXB0aDpmYWxzZX0pO1xuICAgIHBhcmFtcy54ID0gZml4U2VhbXNBbW91bnQ7XG4gICAgcGFyYW1zLnkgPSBkb250RmxpcFggPyAtMS4wIDogMS4wO1xuICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHNvdXJjZUN1YmVtYXApO1xuICAgIGNvbnN0YW50UGFyYW1zLnNldFZhbHVlKHBhcmFtcy5kYXRhKTtcbiAgICBwYy5kcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0YXJnLCBzaGFkZXIpO1xuICAgIHJldHVybiB0ZXg7XG4gIH1cbiAgZnVuY3Rpb24gZ2V0RHBBdGxhc1JlY3QocmVjdCwgbWlwKSB7XG4gICAgcmVjdC54ID0gcGMubWF0aC5jbGFtcChtaXAgLSAyLjAsIDAsIDEpICogMC41O1xuICAgIHZhciB0ID0gbWlwIC0gcmVjdC54ICogNi4wO1xuICAgIHZhciBpID0gMS4wIC0gcmVjdC54O1xuICAgIHJlY3QueSA9IE1hdGgubWluKHQgKiAwLjUsIDAuNzUpICogaSArIHJlY3QueDtcbiAgICByZWN0LnogPSAoMS4wIC0gcGMubWF0aC5jbGFtcCh0LCAwLCAxKSAqIDAuNSkgKiBpO1xuICAgIHJlY3QudyA9IHJlY3QueiAqIDAuNTtcbiAgICByZXR1cm4gMS4wIC8gcmVjdC56O1xuICB9XG4gIGZ1bmN0aW9uIGdlbmVyYXRlRHBBdGxhcyhkZXZpY2UsIHNpeEN1YmVtYXBzLCBkb250RmxpcFgpIHtcbiAgICB2YXIgZHAsIHJlY3Q7XG4gICAgcmVjdCA9IG5ldyBwYy5WZWM0O1xuICAgIHZhciBwYXJhbXMgPSBuZXcgcGMuVmVjNDtcbiAgICB2YXIgc2l6ZSA9IHNpeEN1YmVtYXBzWzBdLndpZHRoICogMiAqIGRwTXVsdDtcbiAgICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICAgIHZhciBzaGFkZXIgPSBjaHVua3MuY3JlYXRlU2hhZGVyRnJvbUNvZGUoZGV2aWNlLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgY2h1bmtzLmRwQXRsYXNRdWFkUFMsIFwiZHBBdGxhc1F1YWRcIik7XG4gICAgdmFyIGNvbnN0YW50VGV4U291cmNlID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoXCJzb3VyY2VcIik7XG4gICAgdmFyIGNvbnN0YW50UGFyYW1zID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoXCJwYXJhbXNcIik7XG4gICAgdmFyIHRleCA9IG5ldyBwYy5nZnguVGV4dHVyZShkZXZpY2UsIHtyZ2JtOnNpeEN1YmVtYXBzWzBdLnJnYm0sIGZvcm1hdDpzaXhDdWJlbWFwc1swXS5mb3JtYXQsIHdpZHRoOnNpemUsIGhlaWdodDpzaXplLCBtaXBtYXBzOmZhbHNlfSk7XG4gICAgdmFyIHRhcmcgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGRldmljZSwgdGV4LCB7ZGVwdGg6ZmFsc2V9KTtcbiAgICB2YXIgYm9yZGVyU2l6ZSA9IDI7XG4gICAgdmFyIG1pcDBXaWR0aCA9IHNpemU7XG4gICAgdmFyIHNjYWxlRmFjdG9yID0gKG1pcDBXaWR0aCArIGJvcmRlclNpemUpIC8gbWlwMFdpZHRoIC0gMTtcbiAgICB2YXIgc2NhbGVBbW91bnQ7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDY7aSsrKSB7XG4gICAgICBkcCA9IHBjLnBhcmFib2xvaWRGcm9tQ3ViZW1hcChkZXZpY2UsIHNpeEN1YmVtYXBzW2ldLCBpLCBkb250RmxpcFgpO1xuICAgICAgY29uc3RhbnRUZXhTb3VyY2Uuc2V0VmFsdWUoZHApO1xuICAgICAgc2NhbGVBbW91bnQgPSBnZXREcEF0bGFzUmVjdChyZWN0LCBpKTtcbiAgICAgIHBhcmFtcy54ID0gc2NhbGVBbW91bnQgKiBzY2FsZUZhY3RvcjtcbiAgICAgIHBhcmFtcy55ID0gcGFyYW1zLnggKiAyO1xuICAgICAgcGFyYW1zLnggKz0gMTtcbiAgICAgIHBhcmFtcy55ICs9IDE7XG4gICAgICBjb25zdGFudFBhcmFtcy5zZXRWYWx1ZShwYXJhbXMuZGF0YSk7XG4gICAgICByZWN0LnggKj0gc2l6ZTtcbiAgICAgIHJlY3QueSAqPSBzaXplO1xuICAgICAgcmVjdC56ICo9IHNpemU7XG4gICAgICByZWN0LncgKj0gc2l6ZTtcbiAgICAgIHBjLmRyYXdRdWFkV2l0aFNoYWRlcihkZXZpY2UsIHRhcmcsIHNoYWRlciwgcmVjdCk7XG4gICAgfVxuICAgIHJldHVybiB0ZXg7XG4gIH1cbiAgcmV0dXJuIHtwYXJhYm9sb2lkRnJvbUN1YmVtYXA6cGFyYWJvbG9pZEZyb21DdWJlbWFwLCBnZW5lcmF0ZURwQXRsYXM6Z2VuZXJhdGVEcEF0bGFzfTtcbn0oKSk7XG5wYy5zaGFkZXJDaHVua3MuVEJOUFMgPSBcInZvaWQgZ2V0VEJOKCkge1xcbiAgICBkVEJOID0gbWF0Myhub3JtYWxpemUoZFRhbmdlbnRXKSwgbm9ybWFsaXplKGRCaW5vcm1hbFcpLCBub3JtYWxpemUoZFZlcnRleE5vcm1hbFcpKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuVEJOZmFzdFBTID0gXCJ2b2lkIGdldFRCTigpIHtcXG4gICAgZFRCTiA9IG1hdDMoZFRhbmdlbnRXLCBkQmlub3JtYWxXLCBkVmVydGV4Tm9ybWFsVyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmFscGhhVGVzdFBTID0gXCJ1bmlmb3JtIGZsb2F0IGFscGhhX3JlZjtcXG52b2lkIGFscGhhVGVzdChmbG9hdCBhKSB7XFxuICAgIGlmIChhIDwgYWxwaGFfcmVmKSBkaXNjYXJkO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5hbWJpZW50Q29uc3RhbnRQUyA9IFwiXFxudm9pZCBhZGRBbWJpZW50KCkge1xcbiAgICBkRGlmZnVzZUxpZ2h0ICs9IGxpZ2h0X2dsb2JhbEFtYmllbnQ7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmFtYmllbnRQcmVmaWx0ZXJlZEN1YmVQUyA9IFwidm9pZCBhZGRBbWJpZW50KCkge1xcbiAgICB2ZWMzIGZpeGVkUmVmbERpciA9IGZpeFNlYW1zU3RhdGljKGROb3JtYWxXLCAxLjAgLSAxLjAgLyA0LjApO1xcbiAgICBmaXhlZFJlZmxEaXIueCAqPSAtMS4wO1xcbiAgICBkRGlmZnVzZUxpZ2h0ICs9IHByb2Nlc3NFbnZpcm9ubWVudCgkREVDT0RFKHRleHR1cmVDdWJlKHRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwNCwgZml4ZWRSZWZsRGlyKSkucmdiKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYW1iaWVudFByZWZpbHRlcmVkQ3ViZUxvZFBTID0gXCJ2b2lkIGFkZEFtYmllbnQoKSB7XFxuICAgIHZlYzMgZml4ZWRSZWZsRGlyID0gZml4U2VhbXNTdGF0aWMoZE5vcm1hbFcsIDEuMCAtIDEuMCAvIDQuMCk7XFxuICAgIGZpeGVkUmVmbERpci54ICo9IC0xLjA7XFxuICAgIGREaWZmdXNlTGlnaHQgKz0gcHJvY2Vzc0Vudmlyb25tZW50KCRERUNPREUoIHRleHR1cmVDdWJlTG9kRVhUKHRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTI4LCBmaXhlZFJlZmxEaXIsIDUuMCkgKS5yZ2IpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5hbWJpZW50U0hQUyA9IFwidW5pZm9ybSB2ZWMzIGFtYmllbnRTSFs5XTtcXG52b2lkIGFkZEFtYmllbnQoKSB7XFxuICAgIHZlYzMgbiA9IGROb3JtYWxXO1xcbiAgICB2ZWMzIGNvbG9yID1cXG4gICAgICAgICAgICAgICAgICAgICAgICBhbWJpZW50U0hbMF0gK1xcbiAgICAgICAgICAgICAgICAgICAgICAgIGFtYmllbnRTSFsxXSAqIG4ueCArXFxuICAgICAgICAgICAgICAgICAgICAgICAgYW1iaWVudFNIWzJdICogbi55ICtcXG4gICAgICAgICAgICAgICAgICAgICAgICBhbWJpZW50U0hbM10gKiBuLnogK1xcbiAgICAgICAgICAgICAgICAgICAgICAgIGFtYmllbnRTSFs0XSAqIG4ueCAqIG4ueiArXFxuICAgICAgICAgICAgICAgICAgICAgICAgYW1iaWVudFNIWzVdICogbi56ICogbi55ICtcXG4gICAgICAgICAgICAgICAgICAgICAgICBhbWJpZW50U0hbNl0gKiBuLnkgKiBuLnggK1xcbiAgICAgICAgICAgICAgICAgICAgICAgIGFtYmllbnRTSFs3XSAqICgzLjAgKiBuLnogKiBuLnogLSAxLjApICtcXG4gICAgICAgICAgICAgICAgICAgICAgICBhbWJpZW50U0hbOF0gKiAobi54ICogbi54IC0gbi55ICogbi55KTtcXG4gICAgZERpZmZ1c2VMaWdodCArPSBwcm9jZXNzRW52aXJvbm1lbnQobWF4KGNvbG9yLCB2ZWMzKDAuMCkpKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYW9TcGVjT2NjUFMgPSBcInVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfb2NjbHVkZVNwZWN1bGFySW50ZW5zaXR5O1xcbnZvaWQgb2NjbHVkZVNwZWN1bGFyKCkge1xcbiAgICAvLyBhcHByb3hpbWF0ZWQgc3BlY3VsYXIgb2NjbHVzaW9uIGZyb20gQU9cXG4gICAgZmxvYXQgc3BlY1BvdyA9IGV4cDIoZEdsb3NzaW5lc3MgKiAxMS4wKTtcXG4gICAgLy8gaHR0cDovL3Jlc2VhcmNoLnRyaS1hY2UuY29tL0RhdGEvY2VkZWMyMDExX1JlYWx0aW1lUEJSX0ltcGxlbWVudGF0aW9uX2UucHB0eFxcbiAgICBmbG9hdCBzcGVjT2NjID0gc2F0dXJhdGUocG93KGRvdChkTm9ybWFsVywgZFZpZXdEaXJXKSArIGRBbywgMC4wMSpzcGVjUG93KSAtIDEuMCArIGRBbyk7XFxuICAgIHNwZWNPY2MgPSBtaXgoMS4wLCBzcGVjT2NjLCBtYXRlcmlhbF9vY2NsdWRlU3BlY3VsYXJJbnRlbnNpdHkpO1xcbiAgICBkU3BlY3VsYXJMaWdodCAqPSBzcGVjT2NjO1xcbiAgICBkUmVmbGVjdGlvbiAqPSBzcGVjT2NjO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5hb1NwZWNPY2NDb25zdFBTID0gXCJ2b2lkIG9jY2x1ZGVTcGVjdWxhcigpIHtcXG4gICAgLy8gYXBwcm94aW1hdGVkIHNwZWN1bGFyIG9jY2x1c2lvbiBmcm9tIEFPXFxuICAgIGZsb2F0IHNwZWNQb3cgPSBleHAyKGRHbG9zc2luZXNzICogMTEuMCk7XFxuICAgIC8vIGh0dHA6Ly9yZXNlYXJjaC50cmktYWNlLmNvbS9EYXRhL2NlZGVjMjAxMV9SZWFsdGltZVBCUl9JbXBsZW1lbnRhdGlvbl9lLnBwdHhcXG4gICAgZmxvYXQgc3BlY09jYyA9IHNhdHVyYXRlKHBvdyhkb3QoZE5vcm1hbFcsIGRWaWV3RGlyVykgKyBkQW8sIDAuMDEqc3BlY1BvdykgLSAxLjAgKyBkQW8pO1xcbiAgICBkU3BlY3VsYXJMaWdodCAqPSBzcGVjT2NjO1xcbiAgICBkUmVmbGVjdGlvbiAqPSBzcGVjT2NjO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5hb1NwZWNPY2NDb25zdFNpbXBsZVBTID0gXCJ2b2lkIG9jY2x1ZGVTcGVjdWxhcigpIHtcXG4gICAgZmxvYXQgc3BlY09jYyA9IGRBbztcXG4gICAgZFNwZWN1bGFyTGlnaHQgKj0gc3BlY09jYztcXG4gICAgZFJlZmxlY3Rpb24gKj0gc3BlY09jYztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYW9TcGVjT2NjU2ltcGxlUFMgPSBcInVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfb2NjbHVkZVNwZWN1bGFySW50ZW5zaXR5O1xcbnZvaWQgb2NjbHVkZVNwZWN1bGFyKCkge1xcbiAgICBmbG9hdCBzcGVjT2NjID0gbWl4KDEuMCwgZEFvLCBtYXRlcmlhbF9vY2NsdWRlU3BlY3VsYXJJbnRlbnNpdHkpO1xcbiAgICBkU3BlY3VsYXJMaWdodCAqPSBzcGVjT2NjO1xcbiAgICBkUmVmbGVjdGlvbiAqPSBzcGVjT2NjO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5hb1RleFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX2FvTWFwO1xcbnZvaWQgYXBwbHlBTygpIHtcXG4gICAgZEFvID0gdGV4dHVyZTJEKHRleHR1cmVfYW9NYXAsICRVVikuJENIO1xcbiAgICBkRGlmZnVzZUxpZ2h0ICo9IGRBbztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYW9WZXJ0UFMgPSBcInZvaWQgYXBwbHlBTygpIHtcXG4gICAgZEFvID0gc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCk7XFxuICAgIGREaWZmdXNlTGlnaHQgKj0gZEFvO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5iYWtlRGlyTG1FbmRQUyA9IFwiXFxuICAgIHZlYzQgZGlyTG0gPSB0ZXh0dXJlMkQodGV4dHVyZV9kaXJMaWdodE1hcCwgdlV2MSk7XFxuICAgIGlmIChiYWtlRGlyID4gMC41KSB7XFxuICAgICAgICBpZiAoZEF0dGVuID4gMC4wMDAwMSkge1xcbiAgICAgICAgICAgIGRpckxtLnh5eiA9IGRpckxtLnh5eiAqIDIuMCAtIHZlYzMoMS4wKTtcXG4gICAgICAgICAgICBkQXR0ZW4gPSBzYXR1cmF0ZShkQXR0ZW4pO1xcbiAgICAgICAgICAgIGdsX0ZyYWdDb2xvci5yZ2IgPSBub3JtYWxpemUoZExpZ2h0RGlyTm9ybVcueHl6KmRBdHRlbiArIGRpckxtLnh5eipkaXJMbS53KSAqIDAuNSArIHZlYzMoMC41KTtcXG4gICAgICAgICAgICBnbF9GcmFnQ29sb3IuYSA9IGRpckxtLncgKyBkQXR0ZW47XFxuICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yLmEgPSBtYXgoZ2xfRnJhZ0NvbG9yLmEsIDEuMCAvIDI1NS4wKTtcXG4gICAgICAgIH0gZWxzZSB7XFxuICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gZGlyTG07XFxuICAgICAgICB9XFxuICAgIH0gZWxzZSB7XFxuICAgICAgICBnbF9GcmFnQ29sb3IucmdiID0gZGlyTG0ueHl6O1xcbiAgICAgICAgZ2xfRnJhZ0NvbG9yLmEgPSBtYXgoZGlyTG0udywgZEF0dGVuID4gMC4wMDAwMT8gKDEuMC8yNTUuMCkgOiAwLjApO1xcbiAgICB9XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYmFrZUxtRW5kUFMgPSBcIlxcbmdsX0ZyYWdDb2xvci5yZ2IgPSBkRGlmZnVzZUxpZ2h0O1xcbmdsX0ZyYWdDb2xvci5yZ2IgPSBwb3coZ2xfRnJhZ0NvbG9yLnJnYiwgdmVjMygwLjUpKTtcXG5nbF9GcmFnQ29sb3IucmdiIC89IDguMDtcXG5nbF9GcmFnQ29sb3IuYSA9IGNsYW1wKCBtYXgoIG1heCggZ2xfRnJhZ0NvbG9yLnIsIGdsX0ZyYWdDb2xvci5nICksIG1heCggZ2xfRnJhZ0NvbG9yLmIsIDEuMCAvIDI1NS4wICkgKSwgMC4wLDEuMCApO1xcbmdsX0ZyYWdDb2xvci5hID0gY2VpbChnbF9GcmFnQ29sb3IuYSAqIDI1NS4wKSAvIDI1NS4wO1xcbmdsX0ZyYWdDb2xvci5yZ2IgLz0gZ2xfRnJhZ0NvbG9yLmE7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuYmFzZVBTID0gXCJcXG51bmlmb3JtIHZlYzMgdmlld19wb3NpdGlvbjtcXG51bmlmb3JtIHZlYzMgbGlnaHRfZ2xvYmFsQW1iaWVudDtcXG5mbG9hdCBzcXVhcmUoZmxvYXQgeCkge1xcbiAgICByZXR1cm4geCp4O1xcbn1cXG5mbG9hdCBzYXR1cmF0ZShmbG9hdCB4KSB7XFxuICAgIHJldHVybiBjbGFtcCh4LCAwLjAsIDEuMCk7XFxufVxcbnZlYzMgc2F0dXJhdGUodmVjMyB4KSB7XFxuICAgIHJldHVybiBjbGFtcCh4LCB2ZWMzKDAuMCksIHZlYzMoMS4wKSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmJhc2VWUyA9IFwiXFxuYXR0cmlidXRlIHZlYzMgdmVydGV4X3Bvc2l0aW9uO1xcbmF0dHJpYnV0ZSB2ZWMzIHZlcnRleF9ub3JtYWw7XFxuYXR0cmlidXRlIHZlYzQgdmVydGV4X3RhbmdlbnQ7XFxuYXR0cmlidXRlIHZlYzIgdmVydGV4X3RleENvb3JkMDtcXG5hdHRyaWJ1dGUgdmVjMiB2ZXJ0ZXhfdGV4Q29vcmQxO1xcbmF0dHJpYnV0ZSB2ZWM0IHZlcnRleF9jb2xvcjtcXG51bmlmb3JtIG1hdDQgbWF0cml4X3ZpZXdQcm9qZWN0aW9uO1xcbnVuaWZvcm0gbWF0NCBtYXRyaXhfbW9kZWw7XFxudW5pZm9ybSBtYXQzIG1hdHJpeF9ub3JtYWw7XFxudmVjMyBkUG9zaXRpb25XO1xcbm1hdDQgZE1vZGVsTWF0cml4O1xcbm1hdDMgZE5vcm1hbE1hdHJpeDtcXG52ZWMzIGRMaWdodFBvc1c7XFxudmVjMyBkTGlnaHREaXJOb3JtVztcXG52ZWMzIGROb3JtYWxXO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmJpYXNDb25zdFBTID0gXCIjZGVmaW5lIFNIQURPV0JJQVNcXG5mbG9hdCBnZXRTaGFkb3dCaWFzKGZsb2F0IHJlc29sdXRpb24sIGZsb2F0IG1heEJpYXMpIHtcXG4gICAgcmV0dXJuIG1heEJpYXM7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmJsdXJWU01QUyA9IFwiXFxudmFyeWluZyB2ZWMyIHZVdjA7XFxudW5pZm9ybSBzYW1wbGVyMkQgc291cmNlO1xcbnVuaWZvcm0gdmVjMiBwaXhlbE9mZnNldDtcXG4jaWZkZWYgR0FVU1NcXG51bmlmb3JtIGZsb2F0IHdlaWdodFtTQU1QTEVTXTtcXG4jZW5kaWZcXG4jaWZkZWYgUEFDS0VEXFxuZmxvYXQgZGVjb2RlRmxvYXRSRyh2ZWMyIHJnKSB7XFxuICAgIHJldHVybiByZy55KigxLjAvMjU1LjApICsgcmcueDtcXG59XFxudmVjMiBlbmNvZGVGbG9hdFJHKCBmbG9hdCB2ICkge1xcbiAgdmVjMiBlbmMgPSB2ZWMyKDEuMCwgMjU1LjApICogdjtcXG4gIGVuYyA9IGZyYWN0KGVuYyk7XFxuICBlbmMgLT0gZW5jLnl5ICogdmVjMigxLjAvMjU1LjAsIDEuMC8yNTUuMCk7XFxuICByZXR1cm4gZW5jO1xcbn1cXG4jZW5kaWZcXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWMzIG1vbWVudHMgPSB2ZWMzKDAuMCk7XFxuICAgIHZlYzIgdXYgPSB2VXYwIC0gcGl4ZWxPZmZzZXQgKiAoZmxvYXQoU0FNUExFUykgKiAwLjUpO1xcbiAgICBmb3IoaW50IGk9MDsgaTxTQU1QTEVTOyBpKyspIHtcXG4gICAgICAgIHZlYzQgYyA9IHRleHR1cmUyRChzb3VyY2UsIHV2ICsgcGl4ZWxPZmZzZXQgKiBmbG9hdChpKSk7XFxuICAgICAgICAjaWZkZWYgUEFDS0VEXFxuICAgICAgICBjLnh5ID0gdmVjMihkZWNvZGVGbG9hdFJHKGMueHkpLCBkZWNvZGVGbG9hdFJHKGMuencpKTtcXG4gICAgICAgICNlbmRpZlxcbiAgICAgICAgI2lmZGVmIEdBVVNTXFxuICAgICAgICBtb21lbnRzICs9IGMueHl6ICogd2VpZ2h0W2ldO1xcbiAgICAgICAgI2Vsc2VcXG4gICAgICAgIG1vbWVudHMgKz0gYy54eXo7XFxuICAgICAgICAjZW5kaWZcXG4gICAgfVxcbiAgICAjaWZuZGVmIEdBVVNTXFxuICAgIG1vbWVudHMgLz0gZmxvYXQoU0FNUExFUyk7XFxuICAgICNlbmRpZlxcbiAgICAjaWZkZWYgUEFDS0VEXFxuICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZW5jb2RlRmxvYXRSRyhtb21lbnRzLngpLCBlbmNvZGVGbG9hdFJHKG1vbWVudHMueSkpO1xcbiAgICAjZWxzZVxcbiAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KG1vbWVudHMueCwgbW9tZW50cy55LCBtb21lbnRzLnosIDEuMCk7XFxuICAgICNlbmRpZlxcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5jb21iaW5lRGlmZnVzZVBTID0gXCJ2ZWMzIGNvbWJpbmVDb2xvcigpIHtcXG4gICAgcmV0dXJuIGRBbGJlZG8gKiBkRGlmZnVzZUxpZ2h0O1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5jb21iaW5lRGlmZnVzZVNwZWN1bGFyUFMgPSBcInZlYzMgY29tYmluZUNvbG9yKCkge1xcbiAgICByZXR1cm4gbWl4KGRBbGJlZG8gKiBkRGlmZnVzZUxpZ2h0LCBkU3BlY3VsYXJMaWdodCArIGRSZWZsZWN0aW9uLnJnYiAqIGRSZWZsZWN0aW9uLmEsIGRTcGVjdWxhcml0eSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmNvbWJpbmVEaWZmdXNlU3BlY3VsYXJOb0NvbnNlcnZlUFMgPSBcInZlYzMgY29tYmluZUNvbG9yKCkge1xcbiAgICByZXR1cm4gZEFsYmVkbyAqIGREaWZmdXNlTGlnaHQgKyAoZFNwZWN1bGFyTGlnaHQgKyBkUmVmbGVjdGlvbi5yZ2IgKiBkUmVmbGVjdGlvbi5hKSAqIGRTcGVjdWxhcml0eTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuY29tYmluZURpZmZ1c2VTcGVjdWxhck5vUmVmbFBTID0gXCJ2ZWMzIGNvbWJpbmVDb2xvcigpIHtcXG4gICAgcmV0dXJuIGRBbGJlZG8gKiBkRGlmZnVzZUxpZ2h0ICsgZFNwZWN1bGFyTGlnaHQgKiBkU3BlY3VsYXJpdHk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmNvbWJpbmVEaWZmdXNlU3BlY3VsYXJOb1JlZmxTZXBhcmF0ZUFtYmllbnRQUyA9IFwidW5pZm9ybSB2ZWMzIG1hdGVyaWFsX2FtYmllbnQ7XFxudmVjMyBjb21iaW5lQ29sb3IoKSB7XFxuICAgIHJldHVybiAoZERpZmZ1c2VMaWdodCAtIGxpZ2h0X2dsb2JhbEFtYmllbnQpICogZEFsYmVkbyArIGRTcGVjdWxhckxpZ2h0ICogZFNwZWN1bGFyaXR5ICsgbWF0ZXJpYWxfYW1iaWVudCAqIGxpZ2h0X2dsb2JhbEFtYmllbnQ7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmNvbWJpbmVEaWZmdXNlU3BlY3VsYXJPbGRQUyA9IFwidmVjMyBjb21iaW5lQ29sb3IoKSB7XFxuICAgIHJldHVybiBtaXgoZEFsYmVkbyAqIGREaWZmdXNlTGlnaHQgKyBkU3BlY3VsYXJMaWdodCAqIGRTcGVjdWxhcml0eSwgZFJlZmxlY3Rpb24ucmdiLCBkUmVmbGVjdGlvbi5hKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuY29va2llUFMgPSBcInZlYzQgZ2V0Q29va2llMkQoc2FtcGxlcjJEIHRleCwgbWF0NCB0cmFuc2Zvcm0sIGZsb2F0IGludGVuc2l0eSkge1xcbiAgICB2ZWM0IHByb2pQb3MgPSB0cmFuc2Zvcm0gKiB2ZWM0KHZQb3NpdGlvblcsIDEuMCk7XFxuICAgIHByb2pQb3MueHkgLz0gcHJvalBvcy53O1xcbiAgICByZXR1cm4gbWl4KHZlYzQoMS4wKSwgdGV4dHVyZTJEKHRleCwgcHJvalBvcy54eSksIGludGVuc2l0eSk7XFxufVxcbnZlYzQgZ2V0Q29va2llMkRDbGlwKHNhbXBsZXIyRCB0ZXgsIG1hdDQgdHJhbnNmb3JtLCBmbG9hdCBpbnRlbnNpdHkpIHtcXG4gICAgdmVjNCBwcm9qUG9zID0gdHJhbnNmb3JtICogdmVjNCh2UG9zaXRpb25XLCAxLjApO1xcbiAgICBwcm9qUG9zLnh5IC89IHByb2pQb3MudztcXG4gICAgaWYgKHByb2pQb3MueCA8IDAuMCB8fCBwcm9qUG9zLnggPiAxLjAgfHwgcHJvalBvcy55IDwgMC4wIHx8IHByb2pQb3MueSA+IDEuMCB8fCBwcm9qUG9zLnogPCAwLjApIHJldHVybiB2ZWM0KDAuMCk7XFxuICAgIHJldHVybiBtaXgodmVjNCgxLjApLCB0ZXh0dXJlMkQodGV4LCBwcm9qUG9zLnh5KSwgaW50ZW5zaXR5KTtcXG59XFxudmVjNCBnZXRDb29raWUyRFhmb3JtKHNhbXBsZXIyRCB0ZXgsIG1hdDQgdHJhbnNmb3JtLCBmbG9hdCBpbnRlbnNpdHksIHZlYzQgY29va2llTWF0cml4LCB2ZWMyIGNvb2tpZU9mZnNldCkge1xcbiAgICB2ZWM0IHByb2pQb3MgPSB0cmFuc2Zvcm0gKiB2ZWM0KHZQb3NpdGlvblcsIDEuMCk7XFxuICAgIHByb2pQb3MueHkgLz0gcHJvalBvcy53O1xcbiAgICBwcm9qUG9zLnh5ICs9IGNvb2tpZU9mZnNldDtcXG4gICAgdmVjMiB1diA9IG1hdDIoY29va2llTWF0cml4KSAqIChwcm9qUG9zLnh5LXZlYzIoMC41KSkgKyB2ZWMyKDAuNSk7XFxuICAgIHJldHVybiBtaXgodmVjNCgxLjApLCB0ZXh0dXJlMkQodGV4LCB1diksIGludGVuc2l0eSk7XFxufVxcbnZlYzQgZ2V0Q29va2llMkRDbGlwWGZvcm0oc2FtcGxlcjJEIHRleCwgbWF0NCB0cmFuc2Zvcm0sIGZsb2F0IGludGVuc2l0eSwgdmVjNCBjb29raWVNYXRyaXgsIHZlYzIgY29va2llT2Zmc2V0KSB7XFxuICAgIHZlYzQgcHJvalBvcyA9IHRyYW5zZm9ybSAqIHZlYzQodlBvc2l0aW9uVywgMS4wKTtcXG4gICAgcHJvalBvcy54eSAvPSBwcm9qUG9zLnc7XFxuICAgIHByb2pQb3MueHkgKz0gY29va2llT2Zmc2V0O1xcbiAgICBpZiAocHJvalBvcy54IDwgMC4wIHx8IHByb2pQb3MueCA+IDEuMCB8fCBwcm9qUG9zLnkgPCAwLjAgfHwgcHJvalBvcy55ID4gMS4wIHx8IHByb2pQb3MueiA8IDAuMCkgcmV0dXJuIHZlYzQoMC4wKTtcXG4gICAgdmVjMiB1diA9IG1hdDIoY29va2llTWF0cml4KSAqIChwcm9qUG9zLnh5LXZlYzIoMC41KSkgKyB2ZWMyKDAuNSk7XFxuICAgIHJldHVybiBtaXgodmVjNCgxLjApLCB0ZXh0dXJlMkQodGV4LCB1diksIGludGVuc2l0eSk7XFxufVxcbnZlYzQgZ2V0Q29va2llQ3ViZShzYW1wbGVyQ3ViZSB0ZXgsIG1hdDQgdHJhbnNmb3JtLCBmbG9hdCBpbnRlbnNpdHkpIHtcXG4gICAgcmV0dXJuIG1peCh2ZWM0KDEuMCksIHRleHR1cmVDdWJlKHRleCwgZExpZ2h0RGlyTm9ybVcgKiBtYXQzKHRyYW5zZm9ybSkpLCBpbnRlbnNpdHkpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5jdWJlTWFwUHJvamVjdEJveFBTID0gXCJ1bmlmb3JtIHZlYzMgZW52Qm94TWluLCBlbnZCb3hNYXg7XFxudmVjMyBjdWJlTWFwUHJvamVjdCh2ZWMzIG5yZGlyKSB7XFxuICAgIHZlYzMgcmJtYXggPSAoZW52Qm94TWF4IC0gdlBvc2l0aW9uVykgLyBucmRpcjtcXG4gICAgdmVjMyByYm1pbiA9IChlbnZCb3hNaW4gLSB2UG9zaXRpb25XKSAvIG5yZGlyO1xcbiAgICB2ZWMzIHJibWlubWF4O1xcbiAgICByYm1pbm1heC54ID0gbnJkaXIueD4wLjA/IHJibWF4LnggOiByYm1pbi54O1xcbiAgICByYm1pbm1heC55ID0gbnJkaXIueT4wLjA/IHJibWF4LnkgOiByYm1pbi55O1xcbiAgICByYm1pbm1heC56ID0gbnJkaXIuej4wLjA/IHJibWF4LnogOiByYm1pbi56O1xcbiAgICBmbG9hdCBmYSA9IG1pbihtaW4ocmJtaW5tYXgueCwgcmJtaW5tYXgueSksIHJibWlubWF4LnopO1xcbiAgICB2ZWMzIHBvc29uYm94ID0gdlBvc2l0aW9uVyArIG5yZGlyICogZmE7XFxuICAgIHZlYzMgZW52Qm94UG9zID0gKGVudkJveE1pbiArIGVudkJveE1heCkgKiAwLjU7XFxuICAgIHJldHVybiBwb3NvbmJveCAtIGVudkJveFBvcztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuY3ViZU1hcFByb2plY3ROb25lUFMgPSBcInZlYzMgY3ViZU1hcFByb2plY3QodmVjMyBkaXIpIHtcXG4gICAgcmV0dXJuIGRpcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZGlmZnVzZUNvbnN0UFMgPSBcInVuaWZvcm0gdmVjMyBtYXRlcmlhbF9kaWZmdXNlO1xcbnZvaWQgZ2V0QWxiZWRvKCkge1xcbiAgICBkQWxiZWRvID0gbWF0ZXJpYWxfZGlmZnVzZS5yZ2I7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmRpZmZ1c2VUZXhQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9kaWZmdXNlTWFwO1xcbnZvaWQgZ2V0QWxiZWRvKCkge1xcbiAgICBkQWxiZWRvID0gdGV4dHVyZTJEU1JHQih0ZXh0dXJlX2RpZmZ1c2VNYXAsICRVVikuJENIO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5kaWZmdXNlVGV4Q29uc3RQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9kaWZmdXNlTWFwO1xcbnVuaWZvcm0gdmVjMyBtYXRlcmlhbF9kaWZmdXNlO1xcbnZvaWQgZ2V0QWxiZWRvKCkge1xcbiAgICBkQWxiZWRvID0gdGV4dHVyZTJEU1JHQih0ZXh0dXJlX2RpZmZ1c2VNYXAsICRVVikuJENIICogbWF0ZXJpYWxfZGlmZnVzZTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZGlmZnVzZVZlcnRQUyA9IFwidm9pZCBnZXRBbGJlZG8oKSB7XFxuICAgIGRBbGJlZG8gPSBnYW1tYUNvcnJlY3RJbnB1dChzYXR1cmF0ZSh2VmVydGV4Q29sb3IuJENIKSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmRpZmZ1c2VWZXJ0Q29uc3RQUyA9IFwidW5pZm9ybSB2ZWMzIG1hdGVyaWFsX2RpZmZ1c2U7XFxudm9pZCBnZXRBbGJlZG8oKSB7XFxuICAgIGRBbGJlZG8gPSBnYW1tYUNvcnJlY3RJbnB1dChzYXR1cmF0ZSh2VmVydGV4Q29sb3IuJENIKSkgKiBtYXRlcmlhbF9kaWZmdXNlO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5kaWxhdGVQUyA9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxudW5pZm9ybSBzYW1wbGVyMkQgc291cmNlO1xcbnVuaWZvcm0gdmVjMiBwaXhlbE9mZnNldDtcXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWM0IGMgPSB0ZXh0dXJlMkQoc291cmNlLCB2VXYwKTtcXG4gICAgYyA9IGMuYT4wLjA/IGMgOiB0ZXh0dXJlMkQoc291cmNlLCB2VXYwIC0gcGl4ZWxPZmZzZXQpO1xcbiAgICBjID0gYy5hPjAuMD8gYyA6IHRleHR1cmUyRChzb3VyY2UsIHZVdjAgKyB2ZWMyKDAsIC1waXhlbE9mZnNldC55KSk7XFxuICAgIGMgPSBjLmE+MC4wPyBjIDogdGV4dHVyZTJEKHNvdXJjZSwgdlV2MCArIHZlYzIocGl4ZWxPZmZzZXQueCwgLXBpeGVsT2Zmc2V0LnkpKTtcXG4gICAgYyA9IGMuYT4wLjA/IGMgOiB0ZXh0dXJlMkQoc291cmNlLCB2VXYwICsgdmVjMigtcGl4ZWxPZmZzZXQueCwgMCkpO1xcbiAgICBjID0gYy5hPjAuMD8gYyA6IHRleHR1cmUyRChzb3VyY2UsIHZVdjAgKyB2ZWMyKHBpeGVsT2Zmc2V0LngsIDApKTtcXG4gICAgYyA9IGMuYT4wLjA/IGMgOiB0ZXh0dXJlMkQoc291cmNlLCB2VXYwICsgdmVjMigtcGl4ZWxPZmZzZXQueCwgcGl4ZWxPZmZzZXQueSkpO1xcbiAgICBjID0gYy5hPjAuMD8gYyA6IHRleHR1cmUyRChzb3VyY2UsIHZVdjAgKyB2ZWMyKDAsIHBpeGVsT2Zmc2V0LnkpKTtcXG4gICAgYyA9IGMuYT4wLjA/IGMgOiB0ZXh0dXJlMkQoc291cmNlLCB2VXYwICsgcGl4ZWxPZmZzZXQpO1xcbiAgICBnbF9GcmFnQ29sb3IgPSBjO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5kcEF0bGFzUXVhZFBTID0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG51bmlmb3JtIHNhbXBsZXIyRCBzb3VyY2U7XFxudW5pZm9ybSB2ZWM0IHBhcmFtcztcXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWMyIHV2ID0gdlV2MDtcXG4gICAgdXYgPSB1diAqIDIuMCAtIHZlYzIoMS4wKTtcXG4gICAgdXYgKj0gcGFyYW1zLnh5O1xcbiAgICB1diA9IHV2ICogMC41ICsgMC41O1xcbiAgICBnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQoc291cmNlLCB1dik7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmVtaXNzaXZlQ29uc3RQUyA9IFwidW5pZm9ybSB2ZWMzIG1hdGVyaWFsX2VtaXNzaXZlO1xcbnZlYzMgZ2V0RW1pc3Npb24oKSB7XFxuICAgIHJldHVybiBtYXRlcmlhbF9lbWlzc2l2ZTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZW1pc3NpdmVUZXhQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9lbWlzc2l2ZU1hcDtcXG52ZWMzIGdldEVtaXNzaW9uKCkge1xcbiAgICByZXR1cm4gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX2VtaXNzaXZlTWFwLCAkVVYpLiRDSDtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZW1pc3NpdmVUZXhDb25zdFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX2VtaXNzaXZlTWFwO1xcbnVuaWZvcm0gdmVjMyBtYXRlcmlhbF9lbWlzc2l2ZTtcXG52ZWMzIGdldEVtaXNzaW9uKCkge1xcbiAgICByZXR1cm4gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX2VtaXNzaXZlTWFwLCAkVVYpLiRDSCAqIG1hdGVyaWFsX2VtaXNzaXZlO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5lbWlzc2l2ZVRleENvbnN0RmxvYXRQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9lbWlzc2l2ZU1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX2VtaXNzaXZlSW50ZW5zaXR5O1xcbnZlYzMgZ2V0RW1pc3Npb24oKSB7XFxuICAgIHJldHVybiAkdGV4dHVyZTJEU0FNUExFKHRleHR1cmVfZW1pc3NpdmVNYXAsICRVVikuJENIICogbWF0ZXJpYWxfZW1pc3NpdmVJbnRlbnNpdHk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmVtaXNzaXZlVmVydFBTID0gXCJ2ZWMzIGdldEVtaXNzaW9uKCkge1xcbiAgICByZXR1cm4gZ2FtbWFDb3JyZWN0SW5wdXQoc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCkpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5lbWlzc2l2ZVZlcnRDb25zdFBTID0gXCJ1bmlmb3JtIHZlYzMgbWF0ZXJpYWxfZW1pc3NpdmU7XFxudmVjMyBnZXRFbWlzc2lvbigpIHtcXG4gICAgcmV0dXJuIGdhbW1hQ29ycmVjdElucHV0KHNhdHVyYXRlKHZWZXJ0ZXhDb2xvci4kQ0gpKSAqIG1hdGVyaWFsX2VtaXNzaXZlO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5lbWlzc2l2ZVZlcnRDb25zdEZsb2F0UFMgPSBcInVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfZW1pc3NpdmVJbnRlbnNpdHk7XFxudmVjMyBnZXRFbWlzc2lvbigpIHtcXG4gICAgcmV0dXJuIGdhbW1hQ29ycmVjdElucHV0KHNhdHVyYXRlKHZWZXJ0ZXhDb2xvci4kQ0gpKSAqIG1hdGVyaWFsX2VtaXNzaXZlSW50ZW5zaXR5O1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5lbmRQUyA9IFwiICAgZ2xfRnJhZ0NvbG9yLnJnYiA9IGNvbWJpbmVDb2xvcigpO1xcbiAgIGdsX0ZyYWdDb2xvci5yZ2IgKz0gZ2V0RW1pc3Npb24oKTtcXG4gICBnbF9GcmFnQ29sb3IucmdiID0gYWRkRm9nKGdsX0ZyYWdDb2xvci5yZ2IpO1xcbiAgICNpZm5kZWYgSERSXFxuICAgIGdsX0ZyYWdDb2xvci5yZ2IgPSB0b25lTWFwKGdsX0ZyYWdDb2xvci5yZ2IpO1xcbiAgICBnbF9GcmFnQ29sb3IucmdiID0gZ2FtbWFDb3JyZWN0T3V0cHV0KGdsX0ZyYWdDb2xvci5yZ2IpO1xcbiAgICNlbmRpZlxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmVudkNvbnN0UFMgPSBcInZlYzMgcHJvY2Vzc0Vudmlyb25tZW50KHZlYzMgY29sb3IpIHtcXG4gICAgcmV0dXJuIGNvbG9yO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5lbnZNdWx0aXBseVBTID0gXCJ1bmlmb3JtIGZsb2F0IHNreWJveEludGVuc2l0eTtcXG52ZWMzIHByb2Nlc3NFbnZpcm9ubWVudCh2ZWMzIGNvbG9yKSB7XFxuICAgIHJldHVybiBjb2xvciAqIHNreWJveEludGVuc2l0eTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZXh0ZW5zaW9uUFMgPSBcIlwiO1xucGMuc2hhZGVyQ2h1bmtzLmV4dGVuc2lvblZTID0gXCJcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5mYWxsb2ZmSW52U3F1YXJlZFBTID0gXCJmbG9hdCBnZXRGYWxsb2ZmSW52U3F1YXJlZChmbG9hdCBsaWdodFJhZGl1cykge1xcbiAgICBmbG9hdCBzcXJEaXN0ID0gZG90KGRMaWdodERpclcsIGRMaWdodERpclcpO1xcbiAgICBmbG9hdCBmYWxsb2ZmID0gMS4wIC8gKHNxckRpc3QgKyAxLjApO1xcbiAgICBmbG9hdCBpbnZSYWRpdXMgPSAxLjAgLyBsaWdodFJhZGl1cztcXG4gICAgZmFsbG9mZiAqPSAxNi4wO1xcbiAgICBmYWxsb2ZmICo9IHNxdWFyZSggc2F0dXJhdGUoIDEuMCAtIHNxdWFyZSggc3FyRGlzdCAqIHNxdWFyZShpbnZSYWRpdXMpICkgKSApO1xcbiAgICByZXR1cm4gZmFsbG9mZjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZmFsbG9mZkxpbmVhclBTID0gXCJmbG9hdCBnZXRGYWxsb2ZmTGluZWFyKGZsb2F0IGxpZ2h0UmFkaXVzKSB7XFxuICAgIGZsb2F0IGQgPSBsZW5ndGgoZExpZ2h0RGlyVyk7XFxuICAgIHJldHVybiBtYXgoKChsaWdodFJhZGl1cyAtIGQpIC8gbGlnaHRSYWRpdXMpLCAwLjApO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5maXhDdWJlbWFwU2VhbXNOb25lUFMgPSBcInZlYzMgZml4U2VhbXModmVjMyB2ZWMsIGZsb2F0IG1pcG1hcEluZGV4KSB7XFxuICAgIHJldHVybiB2ZWM7XFxufVxcbnZlYzMgZml4U2VhbXModmVjMyB2ZWMpIHtcXG4gICAgcmV0dXJuIHZlYztcXG59XFxudmVjMyBmaXhTZWFtc1N0YXRpYyh2ZWMzIHZlYywgZmxvYXQgaW52UmVjTWlwU2l6ZSkge1xcbiAgICByZXR1cm4gdmVjO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5maXhDdWJlbWFwU2VhbXNTdHJldGNoUFMgPSBcInZlYzMgZml4U2VhbXModmVjMyB2ZWMsIGZsb2F0IG1pcG1hcEluZGV4KSB7XFxuICAgIGZsb2F0IHNjYWxlID0gMS4wIC0gZXhwMihtaXBtYXBJbmRleCkgLyAxMjguMDtcXG4gICAgZmxvYXQgTSA9IG1heChtYXgoYWJzKHZlYy54KSwgYWJzKHZlYy55KSksIGFicyh2ZWMueikpO1xcbiAgICBpZiAoYWJzKHZlYy54KSAhPSBNKSB2ZWMueCAqPSBzY2FsZTtcXG4gICAgaWYgKGFicyh2ZWMueSkgIT0gTSkgdmVjLnkgKj0gc2NhbGU7XFxuICAgIGlmIChhYnModmVjLnopICE9IE0pIHZlYy56ICo9IHNjYWxlO1xcbiAgICByZXR1cm4gdmVjO1xcbn1cXG52ZWMzIGZpeFNlYW1zKHZlYzMgdmVjKSB7XFxuICAgIGZsb2F0IHNjYWxlID0gMS4wIC0gMS4wIC8gMTI4LjA7XFxuICAgIGZsb2F0IE0gPSBtYXgobWF4KGFicyh2ZWMueCksIGFicyh2ZWMueSkpLCBhYnModmVjLnopKTtcXG4gICAgaWYgKGFicyh2ZWMueCkgIT0gTSkgdmVjLnggKj0gc2NhbGU7XFxuICAgIGlmIChhYnModmVjLnkpICE9IE0pIHZlYy55ICo9IHNjYWxlO1xcbiAgICBpZiAoYWJzKHZlYy56KSAhPSBNKSB2ZWMueiAqPSBzY2FsZTtcXG4gICAgcmV0dXJuIHZlYztcXG59XFxudmVjMyBmaXhTZWFtc1N0YXRpYyh2ZWMzIHZlYywgZmxvYXQgaW52UmVjTWlwU2l6ZSkge1xcbiAgICBmbG9hdCBzY2FsZSA9IGludlJlY01pcFNpemU7XFxuICAgIGZsb2F0IE0gPSBtYXgobWF4KGFicyh2ZWMueCksIGFicyh2ZWMueSkpLCBhYnModmVjLnopKTtcXG4gICAgaWYgKGFicyh2ZWMueCkgIT0gTSkgdmVjLnggKj0gc2NhbGU7XFxuICAgIGlmIChhYnModmVjLnkpICE9IE0pIHZlYy55ICo9IHNjYWxlO1xcbiAgICBpZiAoYWJzKHZlYy56KSAhPSBNKSB2ZWMueiAqPSBzY2FsZTtcXG4gICAgcmV0dXJuIHZlYztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZm9nRXhwUFMgPSBcInVuaWZvcm0gdmVjMyBmb2dfY29sb3I7XFxudW5pZm9ybSBmbG9hdCBmb2dfZGVuc2l0eTtcXG52ZWMzIGFkZEZvZyh2ZWMzIGNvbG9yKSB7XFxuICAgIGZsb2F0IGRlcHRoID0gZ2xfRnJhZ0Nvb3JkLnogLyBnbF9GcmFnQ29vcmQudztcXG4gICAgZmxvYXQgZm9nRmFjdG9yID0gZXhwKC1kZXB0aCAqIGZvZ19kZW5zaXR5KTtcXG4gICAgZm9nRmFjdG9yID0gY2xhbXAoZm9nRmFjdG9yLCAwLjAsIDEuMCk7XFxuICAgIHJldHVybiBtaXgoZm9nX2NvbG9yLCBjb2xvciwgZm9nRmFjdG9yKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZm9nRXhwMlBTID0gXCJ1bmlmb3JtIHZlYzMgZm9nX2NvbG9yO1xcbnVuaWZvcm0gZmxvYXQgZm9nX2RlbnNpdHk7XFxudmVjMyBhZGRGb2codmVjMyBjb2xvcikge1xcbiAgICBmbG9hdCBkZXB0aCA9IGdsX0ZyYWdDb29yZC56IC8gZ2xfRnJhZ0Nvb3JkLnc7XFxuICAgIGZsb2F0IGZvZ0ZhY3RvciA9IGV4cCgtZGVwdGggKiBkZXB0aCAqIGZvZ19kZW5zaXR5ICogZm9nX2RlbnNpdHkpO1xcbiAgICBmb2dGYWN0b3IgPSBjbGFtcChmb2dGYWN0b3IsIDAuMCwgMS4wKTtcXG4gICAgcmV0dXJuIG1peChmb2dfY29sb3IsIGNvbG9yLCBmb2dGYWN0b3IpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5mb2dMaW5lYXJQUyA9IFwidW5pZm9ybSB2ZWMzIGZvZ19jb2xvcjtcXG51bmlmb3JtIGZsb2F0IGZvZ19zdGFydDtcXG51bmlmb3JtIGZsb2F0IGZvZ19lbmQ7XFxudmVjMyBhZGRGb2codmVjMyBjb2xvcikge1xcbiAgICBmbG9hdCBkZXB0aCA9IGdsX0ZyYWdDb29yZC56IC8gZ2xfRnJhZ0Nvb3JkLnc7XFxuICAgIGZsb2F0IGZvZ0ZhY3RvciA9IChmb2dfZW5kIC0gZGVwdGgpIC8gKGZvZ19lbmQgLSBmb2dfc3RhcnQpO1xcbiAgICBmb2dGYWN0b3IgPSBjbGFtcChmb2dGYWN0b3IsIDAuMCwgMS4wKTtcXG4gICAgZm9nRmFjdG9yID0gZ2FtbWFDb3JyZWN0SW5wdXQoZm9nRmFjdG9yKTtcXG4gICAgcmV0dXJuIG1peChmb2dfY29sb3IsIGNvbG9yLCBmb2dGYWN0b3IpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5mb2dOb25lUFMgPSBcInZlYzMgYWRkRm9nKHZlYzMgY29sb3IpIHtcXG4gICAgcmV0dXJuIGNvbG9yO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5mcmVzbmVsU2NobGlja1BTID0gXCIvLyBTY2hsaWNrJ3MgYXBwcm94aW1hdGlvblxcbnVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfZnJlc25lbEZhY3RvcjsgLy8gdW51c2VkXFxudm9pZCBnZXRGcmVzbmVsKCkge1xcbiAgICBmbG9hdCBmcmVzbmVsID0gMS4wIC0gbWF4KGRvdChkTm9ybWFsVywgZFZpZXdEaXJXKSwgMC4wKTtcXG4gICAgZmxvYXQgZnJlc25lbDIgPSBmcmVzbmVsICogZnJlc25lbDtcXG4gICAgZnJlc25lbCAqPSBmcmVzbmVsMiAqIGZyZXNuZWwyO1xcbiAgICBmcmVzbmVsICo9IGRHbG9zc2luZXNzICogZEdsb3NzaW5lc3M7XFxuICAgIGRTcGVjdWxhcml0eSA9IGRTcGVjdWxhcml0eSArICgxLjAgLSBkU3BlY3VsYXJpdHkpICogZnJlc25lbDtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZnVsbHNjcmVlblF1YWRQUyA9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxudW5pZm9ybSBzYW1wbGVyMkQgc291cmNlO1xcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIGdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRChzb3VyY2UsIHZVdjApO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5mdWxsc2NyZWVuUXVhZFZTID0gXCJhdHRyaWJ1dGUgdmVjMiB2ZXJ0ZXhfcG9zaXRpb247XFxudmFyeWluZyB2ZWMyIHZVdjA7XFxudm9pZCBtYWluKHZvaWQpXFxue1xcbiAgICBnbF9Qb3NpdGlvbiA9IHZlYzQodmVydGV4X3Bvc2l0aW9uLCAwLjUsIDEuMCk7XFxuICAgIHZVdjAgPSB2ZXJ0ZXhfcG9zaXRpb24ueHkqMC41KzAuNTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZ2FtbWExXzBQUyA9IFwidmVjNCB0ZXh0dXJlMkRTUkdCKHNhbXBsZXIyRCB0ZXgsIHZlYzIgdXYpIHtcXG4gICAgcmV0dXJuIHRleHR1cmUyRCh0ZXgsIHV2KTtcXG59XFxudmVjNCB0ZXh0dXJlQ3ViZVNSR0Ioc2FtcGxlckN1YmUgdGV4LCB2ZWMzIHV2dykge1xcbiAgICByZXR1cm4gdGV4dHVyZUN1YmUodGV4LCB1dncpO1xcbn1cXG52ZWMzIGdhbW1hQ29ycmVjdE91dHB1dCh2ZWMzIGNvbG9yKSB7XFxuICAgIHJldHVybiBjb2xvcjtcXG59XFxudmVjMyBnYW1tYUNvcnJlY3RJbnB1dCh2ZWMzIGNvbG9yKSB7XFxuICAgIHJldHVybiBjb2xvcjtcXG59XFxuZmxvYXQgZ2FtbWFDb3JyZWN0SW5wdXQoZmxvYXQgY29sb3IpIHtcXG4gICAgcmV0dXJuIGNvbG9yO1xcbn1cXG52ZWM0IGdhbW1hQ29ycmVjdElucHV0KHZlYzQgY29sb3IpIHtcXG4gICAgcmV0dXJuIGNvbG9yO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5nYW1tYTJfMlBTID0gXCJ2ZWMzIGdhbW1hQ29ycmVjdElucHV0KHZlYzMgY29sb3IpIHtcXG4gICAgcmV0dXJuIHBvdyhjb2xvciwgdmVjMygyLjIpKTtcXG59XFxuZmxvYXQgZ2FtbWFDb3JyZWN0SW5wdXQoZmxvYXQgY29sb3IpIHtcXG4gICAgcmV0dXJuIHBvdyhjb2xvciwgMi4yKTtcXG59XFxudmVjNCBnYW1tYUNvcnJlY3RJbnB1dCh2ZWM0IGNvbG9yKSB7XFxuICAgIHJldHVybiB2ZWM0KHBvdyhjb2xvci5yZ2IsIHZlYzMoMi4yKSksIGNvbG9yLmEpO1xcbn1cXG52ZWM0IHRleHR1cmUyRFNSR0Ioc2FtcGxlcjJEIHRleCwgdmVjMiB1dikge1xcbiAgICB2ZWM0IHJnYmEgPSB0ZXh0dXJlMkQodGV4LCB1dik7XFxuICAgIHJnYmEucmdiID0gZ2FtbWFDb3JyZWN0SW5wdXQocmdiYS5yZ2IpO1xcbiAgICByZXR1cm4gcmdiYTtcXG59XFxudmVjNCB0ZXh0dXJlQ3ViZVNSR0Ioc2FtcGxlckN1YmUgdGV4LCB2ZWMzIHV2dykge1xcbiAgICB2ZWM0IHJnYmEgPSB0ZXh0dXJlQ3ViZSh0ZXgsIHV2dyk7XFxuICAgIHJnYmEucmdiID0gZ2FtbWFDb3JyZWN0SW5wdXQocmdiYS5yZ2IpO1xcbiAgICByZXR1cm4gcmdiYTtcXG59XFxudmVjMyBnYW1tYUNvcnJlY3RPdXRwdXQodmVjMyBjb2xvcikge1xcbiNpZmRlZiBIRFJcXG4gICAgcmV0dXJuIGNvbG9yO1xcbiNlbHNlXFxuICAgIGNvbG9yICs9IHZlYzMoMC4wMDAwMDAxKTtcXG4gICAgcmV0dXJuIHBvdyhjb2xvciwgdmVjMygwLjQ1KSk7XFxuI2VuZGlmXFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmdlblBhcmFib2xvaWRQUyA9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSBzb3VyY2U7XFxudW5pZm9ybSB2ZWM0IHBhcmFtczsgLy8geCA9IG1pcFxcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIHZlYzIgdXYgPSB2VXYwO1xcbiAgICBmbG9hdCBzaWRlID0gdXYueCA8IDAuNT8gMS4wIDogLTEuMDtcXG4gICAgdmVjMiB0YztcXG4gICAgdGMueCA9IGZyYWN0KHV2LnggKiAyLjApICogMi4wIC0gMS4wO1xcbiAgICB0Yy55ID0gdXYueSAqIDIuMCAtIDEuMDtcXG4gICAgLy8gc2NhbGUgcHJvamVjdGlvbiBhIGJpdCB0byBoYXZlIGEgbGl0dGxlIG92ZXJsYXAgZm9yIGZpbHRlcmluZ1xcbiAgICBjb25zdCBmbG9hdCBzY2FsZSA9IDEuMTtcXG4gICAgdGMgKj0gc2NhbGU7XFxuICAgIHZlYzMgZGlyO1xcbiAgICBkaXIueSA9IChkb3QodGMsIHRjKSAtIDEuMCkgKiBzaWRlOyAvLyBmcm9tIDEuMCBjZW50ZXIgdG8gMC4wIGJvcmRlcnMgcXVhZHJhdGljYWxseVxcbiAgICBkaXIueHogPSB0YyAqIC0yLjA7XFxuICAgIGRpci54ICo9IC1zaWRlICogcGFyYW1zLnk7IC8vIGZsaXAgb3JpZ2luYWwgY3ViZW1hcCB4IGluc3RlYWQgb2YgZG9pbmcgaXQgYXQgcnVudGltZVxcbiAgICBkaXIgPSBmaXhTZWFtcyhkaXIsIHBhcmFtcy54KTtcXG4gICAgdmVjNCBjb2xvciA9IHRleHR1cmVDdWJlKHNvdXJjZSwgZGlyLCAtMTAwLjApO1xcbiAgICBnbF9GcmFnQ29sb3IgPSBjb2xvcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZ2xlczNQUyA9IFwiI2RlZmluZSB2YXJ5aW5nIGluXFxub3V0IGhpZ2hwIHZlYzQgcGNfZnJhZ0NvbG9yO1xcbiNkZWZpbmUgZ2xfRnJhZ0NvbG9yIHBjX2ZyYWdDb2xvclxcbiNkZWZpbmUgdGV4dHVyZTJEIHRleHR1cmVcXG4jZGVmaW5lIHRleHR1cmVDdWJlIHRleHR1cmVcXG4jZGVmaW5lIHRleHR1cmUyRFByb2ogdGV4dHVyZVByb2pcXG4jZGVmaW5lIHRleHR1cmUyRExvZEVYVCB0ZXh0dXJlTG9kXFxuI2RlZmluZSB0ZXh0dXJlMkRQcm9qTG9kRVhUIHRleHR1cmVQcm9qTG9kXFxuI2RlZmluZSB0ZXh0dXJlQ3ViZUxvZEVYVCB0ZXh0dXJlTG9kXFxuI2RlZmluZSB0ZXh0dXJlMkRHcmFkRVhUIHRleHR1cmVHcmFkXFxuI2RlZmluZSB0ZXh0dXJlMkRQcm9qR3JhZEVYVCB0ZXh0dXJlUHJvakdyYWRcXG4jZGVmaW5lIHRleHR1cmVDdWJlR3JhZEVYVCB0ZXh0dXJlR3JhZFxcbiNkZWZpbmUgR0wyXFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZ2xlczNWUyA9IFwiI2RlZmluZSBhdHRyaWJ1dGUgaW5cXG4jZGVmaW5lIHZhcnlpbmcgb3V0XFxuI2RlZmluZSB0ZXh0dXJlMkQgdGV4dHVyZVxcbiNkZWZpbmUgR0wyXFxuXCI7XG5wYy5zaGFkZXJDaHVua3MuZ2xvc3NDb25zdFBTID0gXCJ1bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3NoaW5pbmVzcztcXG52b2lkIGdldEdsb3NzaW5lc3MoKSB7XFxuICAgIGRHbG9zc2luZXNzID0gbWF0ZXJpYWxfc2hpbmluZXNzICsgMC4wMDAwMDAxO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5nbG9zc1RleFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX2dsb3NzTWFwO1xcbnZvaWQgZ2V0R2xvc3NpbmVzcygpIHtcXG4gICAgZEdsb3NzaW5lc3MgPSB0ZXh0dXJlMkQodGV4dHVyZV9nbG9zc01hcCwgJFVWKS4kQ0ggKyAwLjAwMDAwMDE7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmdsb3NzVGV4Q29uc3RQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9nbG9zc01hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3NoaW5pbmVzcztcXG52b2lkIGdldEdsb3NzaW5lc3MoKSB7XFxuICAgIGRHbG9zc2luZXNzID0gbWF0ZXJpYWxfc2hpbmluZXNzICogdGV4dHVyZTJEKHRleHR1cmVfZ2xvc3NNYXAsICRVVikuJENIICsgMC4wMDAwMDAxO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5nbG9zc1ZlcnRQUyA9IFwidm9pZCBnZXRHbG9zc2luZXNzKCkge1xcbiAgICBkR2xvc3NpbmVzcyA9IHNhdHVyYXRlKHZWZXJ0ZXhDb2xvci4kQ0gpICsgMC4wMDAwMDAxO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5nbG9zc1ZlcnRDb25zdFBTID0gXCJ1bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3NoaW5pbmVzcztcXG52b2lkIGdldEdsb3NzaW5lc3MoKSB7XFxuICAgIGRHbG9zc2luZXNzID0gbWF0ZXJpYWxfc2hpbmluZXNzICogc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCkgKyAwLjAwMDAwMDE7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmluc3RhbmNpbmdWUyA9IFwiXFxuYXR0cmlidXRlIHZlYzQgaW5zdGFuY2VfbGluZTE7XFxuYXR0cmlidXRlIHZlYzQgaW5zdGFuY2VfbGluZTI7XFxuYXR0cmlidXRlIHZlYzQgaW5zdGFuY2VfbGluZTM7XFxuYXR0cmlidXRlIHZlYzQgaW5zdGFuY2VfbGluZTQ7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MubGlnaHREaWZmdXNlTGFtYmVydFBTID0gXCJmbG9hdCBnZXRMaWdodERpZmZ1c2UoKSB7XFxuICAgIHJldHVybiBtYXgoZG90KGROb3JtYWxXLCAtZExpZ2h0RGlyTm9ybVcpLCAwLjApO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5saWdodERpclBvaW50UFMgPSBcInZvaWQgZ2V0TGlnaHREaXJQb2ludCh2ZWMzIGxpZ2h0UG9zVykge1xcbiAgICBkTGlnaHREaXJXID0gdlBvc2l0aW9uVyAtIGxpZ2h0UG9zVztcXG4gICAgZExpZ2h0RGlyTm9ybVcgPSBub3JtYWxpemUoZExpZ2h0RGlyVyk7XFxuICAgIGRMaWdodFBvc1cgPSBsaWdodFBvc1c7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmxpZ2h0U3BlY3VsYXJCbGlublBTID0gXCIvLyBFbmVyZ3ktY29uc2VydmluZyAoaG9wZWZ1bGx5KSBCbGlubi1QaG9uZ1xcbmZsb2F0IGdldExpZ2h0U3BlY3VsYXIoKSB7XFxuICAgIHZlYzMgaCA9IG5vcm1hbGl6ZSggLWRMaWdodERpck5vcm1XICsgZFZpZXdEaXJXICk7XFxuICAgIGZsb2F0IG5oID0gbWF4KCBkb3QoIGgsIGROb3JtYWxXICksIDAuMCApO1xcbiAgICBmbG9hdCBzcGVjUG93ID0gZXhwMihkR2xvc3NpbmVzcyAqIDExLjApOyAvLyBnbG9zc2luZXNzIGlzIGxpbmVhciwgcG93ZXIgaXMgbm90OyAwIC0gMjA0OFxcbiAgICBzcGVjUG93ID0gYW50aUFsaWFzR2xvc3NpbmVzcyhzcGVjUG93KTtcXG4gICAgLy8gSGFjazogT24gTWFjIE9TIFgsIGNhbGxpbmcgcG93IHdpdGggemVybyBmb3IgdGhlIGV4cG9uZW50IGdlbmVyYXRlcyBoaWRlb3VzIGFydGlmYWN0cyBzbyBiaWFzIHVwIGEgbGl0dGxlXFxuICAgIHNwZWNQb3cgPSBtYXgoc3BlY1BvdywgMC4wMDAxKTtcXG4gICAgcmV0dXJuIHBvdyhuaCwgc3BlY1BvdykgKiAoc3BlY1BvdyArIDIuMCkgLyA4LjA7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmxpZ2h0U3BlY3VsYXJQaG9uZ1BTID0gXCJmbG9hdCBnZXRMaWdodFNwZWN1bGFyKCkge1xcbiAgICBmbG9hdCBzcGVjUG93ID0gZEdsb3NzaW5lc3M7XFxuICAgIHNwZWNQb3cgPSBhbnRpQWxpYXNHbG9zc2luZXNzKHNwZWNQb3cpO1xcbiAgICAvLyBIYWNrOiBPbiBNYWMgT1MgWCwgY2FsbGluZyBwb3cgd2l0aCB6ZXJvIGZvciB0aGUgZXhwb25lbnQgZ2VuZXJhdGVzIGhpZGVvdXMgYXJ0aWZhY3RzIHNvIGJpYXMgdXAgYSBsaXR0bGVcXG4gICAgcmV0dXJuIHBvdyhtYXgoZG90KGRSZWZsRGlyVywgLWRMaWdodERpck5vcm1XKSwgMC4wKSwgc3BlY1BvdyArIDAuMDAwMSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLmxpZ2h0bWFwRGlyUFMgPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfbGlnaHRNYXA7XFxudW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9kaXJMaWdodE1hcDtcXG52b2lkIGFkZExpZ2h0TWFwKCkge1xcbiAgICB2ZWMzIGNvbG9yID0gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX2xpZ2h0TWFwLCAkVVYpLiRDSDtcXG4gICAgdmVjNCBkaXIgPSB0ZXh0dXJlMkQodGV4dHVyZV9kaXJMaWdodE1hcCwgJFVWKTtcXG4gICAgaWYgKGRvdChkaXIueHl6LHZlYzMoMS4wKSkgPCAwLjAwMDAxKSB7XFxuICAgICAgICBkRGlmZnVzZUxpZ2h0ICs9IGNvbG9yO1xcbiAgICAgICAgcmV0dXJuO1xcbiAgICB9XFxuICAgIGRMaWdodERpck5vcm1XID0gbm9ybWFsaXplKGRpci54eXogKiAyLjAgLSB2ZWMzKDEuMCkpO1xcbiAgICBmbG9hdCB2bGlnaHQgPSBzYXR1cmF0ZShkb3QoZExpZ2h0RGlyTm9ybVcsIC1kVmVydGV4Tm9ybWFsVykpO1xcbiAgICBmbG9hdCBmbGlnaHQgPSBzYXR1cmF0ZShkb3QoZExpZ2h0RGlyTm9ybVcsIC1kTm9ybWFsVykpO1xcbiAgICBmbG9hdCBubGlnaHQgPSAoZmxpZ2h0IC8gbWF4KHZsaWdodCwwLjAxKSkgKiAwLjU7XFxuICAgIGREaWZmdXNlTGlnaHQgKz0gY29sb3IgKiBubGlnaHQgKiAyLjA7XFxufVxcbnZvaWQgYWRkRGlyTGlnaHRNYXAoKSB7XFxuICAgIHZlYzQgZGlyID0gdGV4dHVyZTJEKHRleHR1cmVfZGlyTGlnaHRNYXAsICRVVik7XFxuICAgIGlmIChkb3QoZGlyLnh5eix2ZWMzKDEuMCkpIDwgMC4wMDAwMSkgcmV0dXJuO1xcbiAgICB2ZWMzIGNvbG9yID0gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX2xpZ2h0TWFwLCAkVVYpLiRDSDtcXG4gICAgZExpZ2h0RGlyTm9ybVcgPSBub3JtYWxpemUoZGlyLnh5eiAqIDIuMCAtIHZlYzMoMS4wKSk7XFxuICAgIGRTcGVjdWxhckxpZ2h0ICs9IHZlYzMoZ2V0TGlnaHRTcGVjdWxhcigpKSAqIGNvbG9yO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5saWdodG1hcFNpbmdsZVBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX2xpZ2h0TWFwO1xcbnZvaWQgYWRkTGlnaHRNYXAoKSB7XFxuICAgIGREaWZmdXNlTGlnaHQgKz0gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX2xpZ2h0TWFwLCAkVVYpLiRDSDtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MubGlnaHRtYXBTaW5nbGVWZXJ0UFMgPSBcInZvaWQgYWRkTGlnaHRNYXAoKSB7XFxuICAgIGREaWZmdXNlTGlnaHQgKz0gc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm1ldGFsbmVzc1BTID0gXCJ2b2lkIHByb2Nlc3NNZXRhbG5lc3MoZmxvYXQgbWV0YWxuZXNzKSB7XFxuICAgIGNvbnN0IGZsb2F0IGRpZWxlY3RyaWNGMCA9IDAuMDQ7XFxuICAgIGRTcGVjdWxhcml0eSA9IG1peCh2ZWMzKGRpZWxlY3RyaWNGMCksIGRBbGJlZG8sIG1ldGFsbmVzcyk7XFxuICAgIGRBbGJlZG8gKj0gMS4wIC0gbWV0YWxuZXNzO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5tZXRhbG5lc3NDb25zdFBTID0gXCJ1bmlmb3JtIGZsb2F0IG1hdGVyaWFsX21ldGFsbmVzcztcXG52b2lkIGdldFNwZWN1bGFyaXR5KCkge1xcbiAgICBwcm9jZXNzTWV0YWxuZXNzKG1hdGVyaWFsX21ldGFsbmVzcyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm1ldGFsbmVzc1RleFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX21ldGFsbmVzc01hcDtcXG52b2lkIGdldFNwZWN1bGFyaXR5KCkge1xcbiAgICBwcm9jZXNzTWV0YWxuZXNzKHRleHR1cmUyRCh0ZXh0dXJlX21ldGFsbmVzc01hcCwgJFVWKS4kQ0gpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5tZXRhbG5lc3NUZXhDb25zdFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX21ldGFsbmVzc01hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX21ldGFsbmVzcztcXG52b2lkIGdldFNwZWN1bGFyaXR5KCkge1xcbiAgICBwcm9jZXNzTWV0YWxuZXNzKHRleHR1cmUyRCh0ZXh0dXJlX21ldGFsbmVzc01hcCwgJFVWKS4kQ0ggKiBtYXRlcmlhbF9tZXRhbG5lc3MpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5tZXRhbG5lc3NWZXJ0UFMgPSBcInZvaWQgZ2V0U3BlY3VsYXJpdHkoKSB7XFxuICAgIHByb2Nlc3NNZXRhbG5lc3Moc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCkpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5tZXRhbG5lc3NWZXJ0Q29uc3RQUyA9IFwidW5pZm9ybSBmbG9hdCBtYXRlcmlhbF9tZXRhbG5lc3M7XFxudm9pZCBnZXRTcGVjdWxhcml0eSgpIHtcXG4gICAgcHJvY2Vzc01ldGFsbmVzcyhzYXR1cmF0ZSh2VmVydGV4Q29sb3IuJENIKSAqIG1hdGVyaWFsX21ldGFsbmVzcyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm1zZGZQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9tc2RmTWFwO1xcbiNpZmRlZiBHTF9PRVNfc3RhbmRhcmRfZGVyaXZhdGl2ZXNcXG4jZGVmaW5lIFVTRV9GV0lEVEhcXG4jZW5kaWZcXG4jaWZkZWYgR0wyXFxuI2RlZmluZSBVU0VfRldJRFRIXFxuI2VuZGlmXFxuZmxvYXQgbWVkaWFuKGZsb2F0IHIsIGZsb2F0IGcsIGZsb2F0IGIpIHtcXG4gICAgcmV0dXJuIG1heChtaW4ociwgZyksIG1pbihtYXgociwgZyksIGIpKTtcXG59XFxuZmxvYXQgbWFwIChmbG9hdCBtaW4sIGZsb2F0IG1heCwgZmxvYXQgdikge1xcbiAgICByZXR1cm4gKHYgLSBtaW4pIC8gKG1heCAtIG1pbik7XFxufVxcbi8vIG1zZGYgd2F5XFxuLy8gdmVjNCBhcHBseU1zZGYodmVjNCBjb2xvcikge1xcbi8vICAgICB2ZWMzIHRzYW1wbGUgPSB0ZXh0dXJlKHRleHR1cmVfbXNkZk1hcCwgdlV2MCkucmdiO1xcbiAgIFxcbi8vICAgICAvLyBzZXBhcmF0ZVxcbi8vICAgICB2ZWMyIG1zZGZVbml0ID0gNC4wIC8gdmVjMig1MTIuMCwgMjU2LjApO1xcbi8vICAgICBmbG9hdCBzaWdEaXN0ID0gbWVkaWFuKHRzYW1wbGUuciwgdHNhbXBsZS5nLCB0c2FtcGxlLmIpIC0gMC41O1xcbi8vICAgICBzaWdEaXN0ICo9IGRvdChtc2RmVW5pdCwgMC41L2Z3aWR0aCh2VXYwKSk7XFxuLy8gICAgIGZsb2F0IGRpc3RhbmNlID0gY2xhbXAoc2lnRGlzdCArIDAuNSwgMC4wLCAxLjApO1xcbi8vICAgICByZXR1cm4gbWl4KHZlYzQoMC4wKSwgY29sb3IsIGRpc3RhbmNlKTtcXG4vLyB9XFxudW5pZm9ybSBmbG9hdCBmb250X3NkZkludGVuc2l0eTsgLy8gaW50ZW5zaXR5IGlzIHVzZWQgdG8gYm9vc3QgdGhlIHZhbHVlIHJlYWQgZnJvbSB0aGUgU0RGLCAwIGlzIG5vIGJvb3N0LCAxLjAgaXMgbWF4IGJvb3N0XFxudW5pZm9ybSBmbG9hdCBmb250X3B4cmFuZ2U7ICAgICAgLy8gdGhlIG51bWJlciBvZiBwaXhlbHMgYmV0d2VlbiBpbnNpZGUgYW5kIG91dHNpZGUgdGhlIGZvbnQgaW4gU0RGXFxudW5pZm9ybSBmbG9hdCBmb250X3RleHR1cmVXaWR0aDsgLy8gdGhlIHdpZHRoIG9mIHRoZSB0ZXh0dXJlIGF0bGFzXFxudmVjNCBhcHBseU1zZGYodmVjNCBjb2xvcikge1xcbiAgICBmbG9hdCBmb250X3NpemUgPSAxNi4wOyAvLyBUT0RPIGZpeCB0aGlzXFxuICAgIC8vIHNhbXBsZSB0aGUgZmllbGRcXG4gICAgdmVjMyB0c2FtcGxlID0gdGV4dHVyZTJEKHRleHR1cmVfbXNkZk1hcCwgdlV2MCkucmdiO1xcbiAgICAvLyBnZXQgdGhlIHNpZ25lZCBkaXN0YW5jZSB2YWx1ZVxcbiAgICBmbG9hdCBzaWdEaXN0ID0gbWVkaWFuKHRzYW1wbGUuciwgdHNhbXBsZS5nLCB0c2FtcGxlLmIpO1xcbiAgICAjaWZkZWYgVVNFX0ZXSURUSFxcbiAgICAgICAgLy8gc21vb3RoaW5nIGRlcGVuZHMgb24gc2l6ZSBvZiB0ZXh0dXJlIG9uIHNjcmVlblxcbiAgICAgICAgdmVjMiB3ID0gZndpZHRoKHZVdjApO1xcbiAgICAgICAgZmxvYXQgc21vb3RoaW5nID0gY2xhbXAobWFwKDAuMCwgMi4wICogZm9udF9weHJhbmdlIC8gZm9udF90ZXh0dXJlV2lkdGgsIHcueCksIDAuMCwgMC41KTtcXG4gICAgI2Vsc2VcXG4gICAgICAgIC8vIHNtb290aGluZyBnZXRzIHNtYWxsZXIgYXMgdGhlIGZvbnQgc2l6ZSBnZXRzIGJpZ2dlclxcbiAgICAgICAgLy8gZG9uJ3QgaGF2ZSBmd2lkdGggd2UgY2FuIGFwcHJveGltYXRlIGZyb20gZm9udCBzaXplLCB0aGlzIGRvZXNuJ3QgYWNjb3VudCBmb3Igc2NhbGluZ1xcbiAgICAgICAgLy8gc28gYSBiaWcgZm9udCBzY2FsZWQgZG93biB3aWxsIGJlIHdyb25nLi4uXFxuICAgICAgICBmbG9hdCBzbW9vdGhpbmcgPSBjbGFtcCgyLjAgKiBmb250X3B4cmFuZ2UgLyBmb250X3NpemUsIDAuMCwgMC41KTtcXG4gICAgICAgIC8vIGZvciBzbWFsbCBmb250cyB3ZSByZW1hcCB0aGUgZGlzdGFuY2UgZmllbGQgdG8gaW50ZW5zaWZ5IGl0XFxuICAgICAgICAvLyBmbG9hdCBtYXBNaW4gPSAwLjA1O1xcbiAgICAgICAgLy8gZmxvYXQgbWFwTWF4ID0gY2xhbXAoKChmb250X3NpemUgKiAwLjQgLyA0MC4wKSArIDAuNTIpLCBtYXBNaW4sIDEuMCk7XFxuICAgICNlbmRpZlxcbiAgICBmbG9hdCBtYXBNaW4gPSAwLjA1O1xcbiAgICBmbG9hdCBtYXBNYXggPSBjbGFtcCgxLjAgLSBmb250X3NkZkludGVuc2l0eSwgbWFwTWluLCAxLjApO1xcbiAgICBcXG4gICAgLy8gcmVtYXAgdG8gYSBzbWFsbGVyIHJhbmdlICh1c2VkIG9uIHNtYWxsZXIgZm9udCBzaXplcylcXG4gICAgc2lnRGlzdCA9IG1hcChtYXBNaW4sIG1hcE1heCwgc2lnRGlzdCk7XFxuICAgIGZsb2F0IGNlbnRlciA9IDAuNTtcXG4gICAgLy8gY2FsY3VsYXRlIHNtb290aGluZyBhbmQgdXNlIHRvIGdlbmVyYXRlIG9wYWNpdHlcXG4gICAgLy8gZmxvYXQgc21vb3RoaW5nID0gY2xhbXAoZm9udF9zbW9vdGhpbmcgKiAoMS4wLXJveSksIDAuMCwgY2VudGVyKTtcXG4gICAgZmxvYXQgb3BhY2l0eSA9IHNtb290aHN0ZXAoY2VudGVyLXNtb290aGluZywgY2VudGVyK3Ntb290aGluZywgc2lnRGlzdCk7XFxuICAgIC8vIHJldHVybiBmaW5hbCBjb2xvclxcbiAgICByZXR1cm4gbWl4KHZlYzQoMC4wKSwgY29sb3IsIG9wYWNpdHkpO1xcbn1cIjtcbnBjLnNoYWRlckNodW5rcy5ub3JtYWxWUyA9IFwidmVjMyBnZXROb3JtYWwoKSB7XFxuICAgIGROb3JtYWxNYXRyaXggPSBtYXRyaXhfbm9ybWFsO1xcbiAgICByZXR1cm4gbm9ybWFsaXplKGROb3JtYWxNYXRyaXggKiB2ZXJ0ZXhfbm9ybWFsKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Mubm9ybWFsSW5zdGFuY2VkVlMgPSBcInZlYzMgZ2V0Tm9ybWFsKCkge1xcbiAgICBkTm9ybWFsTWF0cml4ID0gbWF0MyhpbnN0YW5jZV9saW5lMS54eXosIGluc3RhbmNlX2xpbmUyLnh5eiwgaW5zdGFuY2VfbGluZTMueHl6KTtcXG4gICAgcmV0dXJuIG5vcm1hbGl6ZShkTm9ybWFsTWF0cml4ICogdmVydGV4X25vcm1hbCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm5vcm1hbE1hcFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX25vcm1hbE1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX2J1bXBpbmVzcztcXG52b2lkIGdldE5vcm1hbCgpIHtcXG4gICAgdmVjMyBub3JtYWxNYXAgPSB1bnBhY2tOb3JtYWwodGV4dHVyZTJEKHRleHR1cmVfbm9ybWFsTWFwLCAkVVYpKTtcXG4gICAgZE5vcm1hbE1hcCA9IG5vcm1hbE1hcDtcXG4gICAgZE5vcm1hbFcgPSBkVEJOICogbm9ybWFsTWFwO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5ub3JtYWxNYXBGbG9hdFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX25vcm1hbE1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX2J1bXBpbmVzcztcXG52b2lkIGdldE5vcm1hbCgpIHtcXG4gICAgdmVjMyBub3JtYWxNYXAgPSB1bnBhY2tOb3JtYWwodGV4dHVyZTJEKHRleHR1cmVfbm9ybWFsTWFwLCAkVVYpKTtcXG4gICAgZE5vcm1hbE1hcCA9IG5vcm1hbE1hcDtcXG4gICAgbm9ybWFsTWFwID0gbm9ybWFsaXplKG1peCh2ZWMzKDAuMCwgMC4wLCAxLjApLCBub3JtYWxNYXAsIG1hdGVyaWFsX2J1bXBpbmVzcykpO1xcbiAgICBkTm9ybWFsVyA9IGRUQk4gKiBub3JtYWxNYXA7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm5vcm1hbE1hcEZsb2F0VEJOZmFzdFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX25vcm1hbE1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX2J1bXBpbmVzcztcXG52b2lkIGdldE5vcm1hbCgpIHtcXG4gICAgdmVjMyBub3JtYWxNYXAgPSB1bnBhY2tOb3JtYWwodGV4dHVyZTJEKHRleHR1cmVfbm9ybWFsTWFwLCAkVVYpKTtcXG4gICAgZE5vcm1hbE1hcCA9IG5vcm1hbE1hcDtcXG4gICAgbm9ybWFsTWFwID0gbWl4KHZlYzMoMC4wLCAwLjAsIDEuMCksIG5vcm1hbE1hcCwgbWF0ZXJpYWxfYnVtcGluZXNzKTtcXG4gICAgZE5vcm1hbFcgPSBub3JtYWxpemUoZFRCTiAqIG5vcm1hbE1hcCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm5vcm1hbFNraW5uZWRWUyA9IFwidmVjMyBnZXROb3JtYWwoKSB7XFxuICAgIGROb3JtYWxNYXRyaXggPSBtYXQzKGRNb2RlbE1hdHJpeFswXS54eXosIGRNb2RlbE1hdHJpeFsxXS54eXosIGRNb2RlbE1hdHJpeFsyXS54eXopO1xcbiAgICByZXR1cm4gbm9ybWFsaXplKGROb3JtYWxNYXRyaXggKiB2ZXJ0ZXhfbm9ybWFsKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Mubm9ybWFsVmVydGV4UFMgPSBcInZvaWQgZ2V0Tm9ybWFsKCkge1xcbiAgICBkTm9ybWFsVyA9IG5vcm1hbGl6ZShkVmVydGV4Tm9ybWFsVyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm5vcm1hbFhZUFMgPSBcInZlYzMgdW5wYWNrTm9ybWFsKHZlYzQgbm1hcCkge1xcbiAgICB2ZWMzIG5vcm1hbDtcXG4gICAgbm9ybWFsLnh5ID0gbm1hcC53eSAqIDIuMCAtIDEuMDtcXG4gICAgbm9ybWFsLnogPSBzcXJ0KDEuMCAtIHNhdHVyYXRlKGRvdChub3JtYWwueHksIG5vcm1hbC54eSkpKTtcXG4gICAgcmV0dXJuIG5vcm1hbDtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Mubm9ybWFsWFlaUFMgPSBcInZlYzMgdW5wYWNrTm9ybWFsKHZlYzQgbm1hcCkge1xcbiAgICByZXR1cm4gbm1hcC54eXogKiAyLjAgLSAxLjA7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm9wYWNpdHlDb25zdFBTID0gXCJ1bmlmb3JtIGZsb2F0IG1hdGVyaWFsX29wYWNpdHk7XFxudm9pZCBnZXRPcGFjaXR5KCkge1xcbiAgICBkQWxwaGEgPSBtYXRlcmlhbF9vcGFjaXR5O1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5vcGFjaXR5VGV4UFMgPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfb3BhY2l0eU1hcDtcXG52b2lkIGdldE9wYWNpdHkoKSB7XFxuICAgIGRBbHBoYSA9IHRleHR1cmUyRCh0ZXh0dXJlX29wYWNpdHlNYXAsICRVVikuJENIO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5vcGFjaXR5VGV4Q29uc3RQUyA9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9vcGFjaXR5TWFwO1xcbnVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfb3BhY2l0eTtcXG52b2lkIGdldE9wYWNpdHkoKSB7XFxuICAgIGRBbHBoYSA9IHRleHR1cmUyRCh0ZXh0dXJlX29wYWNpdHlNYXAsICRVVikuJENIICogbWF0ZXJpYWxfb3BhY2l0eTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Mub3BhY2l0eVZlcnRQUyA9IFwidm9pZCBnZXRPcGFjaXR5KCkge1xcbiAgICBkQWxwaGEgPSBzYXR1cmF0ZSh2VmVydGV4Q29sb3IuJENIKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Mub3BhY2l0eVZlcnRDb25zdFBTID0gXCJ1bmlmb3JtIGZsb2F0IG1hdGVyaWFsX29wYWNpdHk7XFxudm9pZCBnZXRPcGFjaXR5KCkge1xcbiAgICBkQWxwaGEgPSBzYXR1cmF0ZSh2VmVydGV4Q29sb3IuJENIKSAqIG1hdGVyaWFsX29wYWNpdHk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm91dHB1dEFscGhhUFMgPSBcImdsX0ZyYWdDb2xvci5hID0gZEFscGhhO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm91dHB1dEFscGhhT3BhcXVlUFMgPSBcImdsX0ZyYWdDb2xvci5hID0gMS4wO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm91dHB1dEFscGhhUHJlbXVsUFMgPSBcImdsX0ZyYWdDb2xvci5yZ2IgKj0gZEFscGhhO1xcbmdsX0ZyYWdDb2xvci5hID0gZEFscGhhO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLm91dHB1dEN1YmVtYXBQUyA9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSBzb3VyY2U7XFxudW5pZm9ybSB2ZWM0IHBhcmFtcztcXG5mbG9hdCBzYXR1cmF0ZShmbG9hdCB4KSB7XFxuICAgIHJldHVybiBjbGFtcCh4LCAwLjAsIDEuMCk7XFxufVxcbnZlYzQgZW5jb2RlUkdCTSh2ZWM0IGNvbG9yKSB7IC8vIG1vZGlmaWVkIFJHQk1cXG4gICAgY29sb3IucmdiID0gcG93KGNvbG9yLnJnYiwgdmVjMygwLjUpKTtcXG4gICAgY29sb3IucmdiICo9IDEuMCAvIDguMDtcXG4gICAgY29sb3IuYSA9IHNhdHVyYXRlKCBtYXgoIG1heCggY29sb3IuciwgY29sb3IuZyApLCBtYXgoIGNvbG9yLmIsIDEuMCAvIDI1NS4wICkgKSApO1xcbiAgICBjb2xvci5hID0gY2VpbChjb2xvci5hICogMjU1LjApIC8gMjU1LjA7XFxuICAgIGNvbG9yLnJnYiAvPSBjb2xvci5hO1xcbiAgICByZXR1cm4gY29sb3I7XFxufVxcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIHZlYzIgc3QgPSB2VXYwICogMi4wIC0gMS4wO1xcbiAgICBmbG9hdCBmYWNlID0gcGFyYW1zLng7XFxuICAgIHZlYzMgdmVjO1xcbiAgICBpZiAoZmFjZT09MC4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKDEsIC1zdC55LCAtc3QueCk7XFxuICAgIH0gZWxzZSBpZiAoZmFjZT09MS4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKC0xLCAtc3QueSwgc3QueCk7XFxuICAgIH0gZWxzZSBpZiAoZmFjZT09Mi4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKHN0LngsIDEsIHN0LnkpO1xcbiAgICB9IGVsc2UgaWYgKGZhY2U9PTMuMCkge1xcbiAgICAgICAgdmVjID0gdmVjMyhzdC54LCAtMSwgLXN0LnkpO1xcbiAgICB9IGVsc2UgaWYgKGZhY2U9PTQuMCkge1xcbiAgICAgICAgdmVjID0gdmVjMyhzdC54LCAtc3QueSwgMSk7XFxuICAgIH0gZWxzZSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKC1zdC54LCAtc3QueSwgLTEpO1xcbiAgICB9XFxuICAgIGdsX0ZyYWdDb2xvciA9IHRleHR1cmVDdWJlKHNvdXJjZSwgdmVjKTtcXG4gICAgaWYgKHBhcmFtcy53ID49IDIuMCkgZ2xfRnJhZ0NvbG9yID0gZW5jb2RlUkdCTShnbF9GcmFnQ29sb3IpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5vdXRwdXRUZXgyRFBTID0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG51bmlmb3JtIHNhbXBsZXIyRCBzb3VyY2U7XFxudm9pZCBtYWluKHZvaWQpIHtcXG4gICAgZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHNvdXJjZSwgdlV2MCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhY2tEZXB0aFBTID0gXCIvLyBQYWNraW5nIGEgZmxvYXQgaW4gR0xTTCB3aXRoIG11bHRpcGxpY2F0aW9uIGFuZCBtb2RcXG4vLyBodHRwOi8vYmxvZy5ncmFkaWVudHN0dWRpb3MuY29tLzIwMTIvMDgvMjMvc2hhZG93LW1hcC1pbXByb3ZlbWVudFxcbnZlYzQgcGFja0Zsb2F0KGZsb2F0IGRlcHRoKSB7XFxuICAgIGNvbnN0IHZlYzQgYml0X3NoaWZ0ID0gdmVjNCgyNTYuMCAqIDI1Ni4wICogMjU2LjAsIDI1Ni4wICogMjU2LjAsIDI1Ni4wLCAxLjApO1xcbiAgICBjb25zdCB2ZWM0IGJpdF9tYXNrICA9IHZlYzQoMC4wLCAxLjAgLyAyNTYuMCwgMS4wIC8gMjU2LjAsIDEuMCAvIDI1Ni4wKTtcXG4gICAgLy8gY29tYmluYXRpb24gb2YgbW9kIGFuZCBtdWx0aXBsaWNhdGlvbiBhbmQgZGl2aXNpb24gd29ya3MgYmV0dGVyXFxuICAgIHZlYzQgcmVzID0gbW9kKGRlcHRoICogYml0X3NoaWZ0ICogdmVjNCgyNTUpLCB2ZWM0KDI1NikgKSAvIHZlYzQoMjU1KTtcXG4gICAgcmVzIC09IHJlcy54eHl6ICogYml0X21hc2s7XFxuICAgIHJldHVybiByZXM7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhY2tEZXB0aE1hc2tQUyA9IFwidmVjNCBwYWNrRmxvYXQoZmxvYXQgZGVwdGgpIHtcXG4gICAgY29uc3QgdmVjNCBiaXRfc2hpZnQgPSB2ZWM0KDI1Ni4wICogMjU2LjAgKiAyNTYuMCwgMjU2LjAgKiAyNTYuMCwgMjU2LjAsIDEuMCk7XFxuICAgIGNvbnN0IHZlYzQgYml0X21hc2sgID0gdmVjNCgwLjAsIDEuMCAvIDI1Ni4wLCAxLjAgLyAyNTYuMCwgMS4wIC8gMjU2LjApO1xcbiAgICAvLyBjb21iaW5hdGlvbiBvZiBtb2QgYW5kIG11bHRpcGxpY2F0aW9uIGFuZCBkaXZpc2lvbiB3b3JrcyBiZXR0ZXJcXG4gICAgdmVjNCByZXMgPSBtb2QoZGVwdGggKiBiaXRfc2hpZnQgKiB2ZWM0KDI1NSksIHZlYzQoMjU2KSApIC8gdmVjNCgyNTUpO1xcbiAgICByZXMueCA9IDAuMDtcXG4gICAgcmVzIC09IHJlcy54eHl6ICogYml0X21hc2s7XFxuICAgIHJldHVybiByZXM7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcmFsbGF4UFMgPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfaGVpZ2h0TWFwO1xcbnVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfaGVpZ2h0TWFwRmFjdG9yO1xcbnZvaWQgZ2V0UGFyYWxsYXgoKSB7XFxuICAgIGZsb2F0IHBhcmFsbGF4U2NhbGUgPSBtYXRlcmlhbF9oZWlnaHRNYXBGYWN0b3I7XFxuICAgIGZsb2F0IGhlaWdodCA9IHRleHR1cmUyRCh0ZXh0dXJlX2hlaWdodE1hcCwgJFVWKS4kQ0g7XFxuICAgIGhlaWdodCA9IGhlaWdodCAqIHBhcmFsbGF4U2NhbGUgLSBwYXJhbGxheFNjYWxlKjAuNTtcXG4gICAgdmVjMyB2aWV3RGlyVCA9IGRWaWV3RGlyVyAqIGRUQk47XFxuICAgIHZpZXdEaXJULnogKz0gMC40MjtcXG4gICAgZFV2T2Zmc2V0ID0gaGVpZ2h0ICogKHZpZXdEaXJULnh5IC8gdmlld0RpclQueik7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlUFMgPSBcInZhcnlpbmcgdmVjNCB0ZXhDb29yZHNBbHBoYUxpZmU7XFxudW5pZm9ybSBzYW1wbGVyMkQgY29sb3JNYXA7XFxudW5pZm9ybSBzYW1wbGVyMkQgaW50ZXJuYWxUZXgzO1xcbnVuaWZvcm0gZmxvYXQgZ3JhcGhTYW1wbGVTaXplO1xcbnVuaWZvcm0gZmxvYXQgZ3JhcGhOdW1TYW1wbGVzO1xcbnVuaWZvcm0gZmxvYXQgY2FtZXJhX2ZhcjtcXG51bmlmb3JtIGZsb2F0IHNvZnRlbmluZztcXG51bmlmb3JtIGZsb2F0IGNvbG9yTXVsdDtcXG5mbG9hdCBzYXR1cmF0ZShmbG9hdCB4KSB7XFxuICAgIHJldHVybiBjbGFtcCh4LCAwLjAsIDEuMCk7XFxufVxcbmZsb2F0IHVucGFja0Zsb2F0KHZlYzQgcmdiYURlcHRoKSB7XFxuICAgIGNvbnN0IHZlYzQgYml0U2hpZnQgPSB2ZWM0KDEuMCAvICgyNTYuMCAqIDI1Ni4wICogMjU2LjApLCAxLjAgLyAoMjU2LjAgKiAyNTYuMCksIDEuMCAvIDI1Ni4wLCAxLjApO1xcbiAgICBmbG9hdCBkZXB0aCA9IGRvdChyZ2JhRGVwdGgsIGJpdFNoaWZ0KTtcXG4gICAgcmV0dXJuIGRlcHRoO1xcbn1cXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWM0IHRleCAgICAgICAgID0gdGV4dHVyZTJEU1JHQihjb2xvck1hcCwgdGV4Q29vcmRzQWxwaGFMaWZlLnh5KTtcXG4gICAgdmVjNCByYW1wICAgICA9IHRleHR1cmUyRFNSR0IoaW50ZXJuYWxUZXgzLCB2ZWMyKHRleENvb3Jkc0FscGhhTGlmZS53LCAwLjApKTtcXG4gICAgcmFtcC5yZ2IgKj0gY29sb3JNdWx0O1xcbiAgICByYW1wLmEgKz0gdGV4Q29vcmRzQWxwaGFMaWZlLno7XFxuICAgIHZlYzMgcmdiID0gICAgIHRleC5yZ2IgKiByYW1wLnJnYjtcXG4gICAgZmxvYXQgYSA9ICAgICAgICAgdGV4LmEgKiByYW1wLmE7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVWUyA9IFwiXFxudmVjMyB1bnBhY2szTkZsb2F0cyhmbG9hdCBzcmMpIHtcXG4gICAgZmxvYXQgciA9IGZyYWN0KHNyYyk7XFxuICAgIGZsb2F0IGcgPSBmcmFjdChzcmMgKiAyNTYuMCk7XFxuICAgIGZsb2F0IGIgPSBmcmFjdChzcmMgKiA2NTUzNi4wKTtcXG4gICAgcmV0dXJuIHZlYzMociwgZywgYik7XFxufVxcbmZsb2F0IHNhdHVyYXRlKGZsb2F0IHgpIHtcXG4gICAgcmV0dXJuIGNsYW1wKHgsIDAuMCwgMS4wKTtcXG59XFxudmVjNCB0ZXgxRGxvZF9sZXJwKHNhbXBsZXIyRCB0ZXgsIHZlYzIgdGMpIHtcXG4gICAgcmV0dXJuIG1peCggdGV4dHVyZTJEKHRleCx0YyksIHRleHR1cmUyRCh0ZXgsdGMgKyBncmFwaFNhbXBsZVNpemUpLCBmcmFjdCh0Yy54KmdyYXBoTnVtU2FtcGxlcykgKTtcXG59XFxudmVjNCB0ZXgxRGxvZF9sZXJwKHNhbXBsZXIyRCB0ZXgsIHZlYzIgdGMsIG91dCB2ZWMzIHcpIHtcXG4gICAgdmVjNCBhID0gdGV4dHVyZTJEKHRleCx0Yyk7XFxuICAgIHZlYzQgYiA9IHRleHR1cmUyRCh0ZXgsdGMgKyBncmFwaFNhbXBsZVNpemUpO1xcbiAgICBmbG9hdCBjID0gZnJhY3QodGMueCpncmFwaE51bVNhbXBsZXMpO1xcbiAgICB2ZWMzIHVucGFja2VkQSA9IHVucGFjazNORmxvYXRzKGEudyk7XFxuICAgIHZlYzMgdW5wYWNrZWRCID0gdW5wYWNrM05GbG9hdHMoYi53KTtcXG4gICAgdyA9IG1peCh1bnBhY2tlZEEsIHVucGFja2VkQiwgYyk7XFxuICAgIHJldHVybiBtaXgoYSwgYiwgYyk7XFxufVxcbnZlYzIgcm90YXRlKHZlYzIgcXVhZFhZLCBmbG9hdCBwUm90YXRpb24sIG91dCBtYXQyIHJvdE1hdHJpeCkge1xcbiAgICBmbG9hdCBjID0gY29zKHBSb3RhdGlvbik7XFxuICAgIGZsb2F0IHMgPSBzaW4ocFJvdGF0aW9uKTtcXG4gICAgbWF0MiBtID0gbWF0MihjLCAtcywgcywgYyk7XFxuICAgIHJvdE1hdHJpeCA9IG07XFxuICAgIHJldHVybiBtICogcXVhZFhZO1xcbn1cXG52ZWMzIGJpbGxib2FyZCh2ZWMzIEluc3RhbmNlQ29vcmRzLCB2ZWMyIHF1YWRYWSkge1xcbiAgICB2ZWMzIHBvcyA9IC1tYXRyaXhfdmlld0ludmVyc2VbMF0ueHl6ICogcXVhZFhZLnggKyAtbWF0cml4X3ZpZXdJbnZlcnNlWzFdLnh5eiAqIHF1YWRYWS55O1xcbiAgICByZXR1cm4gcG9zO1xcbn1cXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWMzIG1lc2hMb2NhbFBvcyA9IHBhcnRpY2xlX3ZlcnRleERhdGEueHl6O1xcbiAgICBmbG9hdCBpZCA9IGZsb29yKHBhcnRpY2xlX3ZlcnRleERhdGEudyk7XFxuICAgIGZsb2F0IHJuZEZhY3RvciA9IGZyYWN0KHNpbihpZCArIDEuMCArIHNlZWQpKTtcXG4gICAgdmVjMyBybmRGYWN0b3IzID0gdmVjMyhybmRGYWN0b3IsIGZyYWN0KHJuZEZhY3RvcioxMC4wKSwgZnJhY3Qocm5kRmFjdG9yKjEwMC4wKSk7XFxuICAgIGZsb2F0IHV2ID0gaWQgLyBudW1QYXJ0aWNsZXNQb3Q7XFxuICAgIHJlYWRJbnB1dCh1dik7XFxuICAgIHZlYzIgdmVsb2NpdHlWID0gbm9ybWFsaXplKChtYXQzKG1hdHJpeF92aWV3KSAqIGluVmVsKS54eSk7IC8vIHNob3VsZCBiZSByZW1vdmVkIGJ5IGNvbXBpbGVyIGlmIGFsaWduL3N0cmV0Y2ggaXMgbm90IHVzZWRcXG4gICAgZmxvYXQgcGFydGljbGVMaWZldGltZSA9IGxpZmV0aW1lO1xcbiAgICBpZiAoaW5MaWZlIDw9IDAuMCB8fCBpbkxpZmUgPiBwYXJ0aWNsZUxpZmV0aW1lIHx8ICFpblNob3cpIG1lc2hMb2NhbFBvcyA9IHZlYzMoMC4wKTtcXG4gICAgdmVjMiBxdWFkWFkgPSBtZXNoTG9jYWxQb3MueHk7XFxuICAgIGZsb2F0IG5saWZlID0gY2xhbXAoaW5MaWZlIC8gcGFydGljbGVMaWZldGltZSwgMC4wLCAxLjApO1xcbiAgICB2ZWMzIHBhcmFtRGl2O1xcbiAgICB2ZWM0IHBhcmFtcyA9IHRleDFEbG9kX2xlcnAoaW50ZXJuYWxUZXgyLCB2ZWMyKG5saWZlLCAwKSwgcGFyYW1EaXYpO1xcbiAgICBmbG9hdCBzY2FsZSA9IHBhcmFtcy55O1xcbiAgICBmbG9hdCBzY2FsZURpdiA9IHBhcmFtRGl2Lng7XFxuICAgIGZsb2F0IGFscGhhRGl2ID0gcGFyYW1EaXYuejtcXG4gICAgc2NhbGUgKz0gKHNjYWxlRGl2ICogMi4wIC0gMS4wKSAqIHNjYWxlRGl2TXVsdCAqIGZyYWN0KHJuZEZhY3RvcioxMDAwMC4wKTtcXG4gICAgdGV4Q29vcmRzQWxwaGFMaWZlID0gdmVjNChxdWFkWFkgKiAtMC41ICsgMC41LCAgICAoYWxwaGFEaXYgKiAyLjAgLSAxLjApICogYWxwaGFEaXZNdWx0ICogZnJhY3Qocm5kRmFjdG9yKjEwMDAuMCksICAgIG5saWZlKTtcXG4gICAgdmVjMyBwYXJ0aWNsZVBvcyA9IGluUG9zO1xcbiAgICB2ZWMzIHBhcnRpY2xlUG9zTW92ZWQgPSB2ZWMzKDAuMCk7XFxuICAgIG1hdDIgcm90TWF0cml4O1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlQW5pbUZyYW1lQ2xhbXBWUyA9IFwiXFxuICAgIGZsb2F0IGFuaW1GcmFtZSA9IG1pbihmbG9vcih0ZXhDb29yZHNBbHBoYUxpZmUudyAqIGFuaW1UZXhQYXJhbXMueiksIGFuaW1UZXhQYXJhbXMudyk7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVBbmltRnJhbWVMb29wVlMgPSBcIlxcbiAgICBmbG9hdCBhbmltRnJhbWUgPSBmbG9vcih0ZXhDb29yZHNBbHBoYUxpZmUudyAqIGFuaW1UZXhQYXJhbXMueik7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVBbmltVGV4VlMgPSBcIlxcbiAgICBmbG9hdCBhdGxhc1ggPSBhbmltRnJhbWUgKiBhbmltVGV4UGFyYW1zLng7XFxuICAgIGZsb2F0IGF0bGFzWSA9IGZsb29yKGF0bGFzWCkgKiBhbmltVGV4UGFyYW1zLnk7XFxuICAgIGF0bGFzWCA9IGZyYWN0KGF0bGFzWCk7XFxuICAgIHRleENvb3Jkc0FscGhhTGlmZS54eSAqPSBhbmltVGV4UGFyYW1zLnh5O1xcbiAgICB0ZXhDb29yZHNBbHBoYUxpZmUueHkgKz0gdmVjMihhdGxhc1gsIGF0bGFzWSk7XFxuICAgIHRleENvb3Jkc0FscGhhTGlmZS55ID0gMS4wIC0gdGV4Q29vcmRzQWxwaGFMaWZlLnk7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVJbnB1dEZsb2F0UFMgPSBcInZvaWQgcmVhZElucHV0KGZsb2F0IHV2KSB7XFxuICAgIHZlYzQgdGV4ID0gdGV4dHVyZTJEKHBhcnRpY2xlVGV4SU4sIHZlYzIodXYsIDAuMjUpKTtcXG4gICAgdmVjNCB0ZXgyID0gdGV4dHVyZTJEKHBhcnRpY2xlVGV4SU4sIHZlYzIodXYsIDAuNzUpKTtcXG4gICAgaW5Qb3MgPSB0ZXgueHl6O1xcbiAgICBpblZlbCA9IHRleDIueHl6O1xcbiAgICBpbkFuZ2xlID0gKHRleC53IDwgMC4wPyAtdGV4LncgOiB0ZXgudykgLSAxMDAwLjA7XFxuICAgIGluU2hvdyA9IHRleC53ID49IDAuMDtcXG4gICAgaW5MaWZlID0gdGV4Mi53O1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZUlucHV0UmdiYThQUyA9IFwiLy9SRz1YLCBCQT1ZXFxuLy9SRz1aLCBCQT1BXFxuLy9SR0I9ViwgQT12aXNNb2RlXFxuLy9SR0JBPWxpZmVcXG4jZGVmaW5lIFBJMiA2LjI4MzE4NTMwNzE3OTU4NlxcbnVuaWZvcm0gdmVjMyBpbkJvdW5kc1NpemU7XFxudW5pZm9ybSB2ZWMzIGluQm91bmRzQ2VudGVyO1xcbnVuaWZvcm0gZmxvYXQgbWF4VmVsO1xcbmZsb2F0IGRlY29kZUZsb2F0UkcodmVjMiByZykge1xcbiAgICByZXR1cm4gcmcueSooMS4wLzI1NS4wKSArIHJnLng7XFxufVxcbmZsb2F0IGRlY29kZUZsb2F0UkdCQSggdmVjNCByZ2JhICkge1xcbiAgcmV0dXJuIGRvdCggcmdiYSwgdmVjNCgxLjAsIDEuMC8yNTUuMCwgMS4wLzY1MDI1LjAsIDEuMC8xNjA1ODEzNzUuMCkgKTtcXG59XFxudm9pZCByZWFkSW5wdXQoZmxvYXQgdXYpIHtcXG4gICAgdmVjNCB0ZXgwID0gdGV4dHVyZTJEKHBhcnRpY2xlVGV4SU4sIHZlYzIodXYsIDAuMTI1KSk7XFxuICAgIHZlYzQgdGV4MSA9IHRleHR1cmUyRChwYXJ0aWNsZVRleElOLCB2ZWMyKHV2LCAwLjM3NSkpO1xcbiAgICB2ZWM0IHRleDIgPSB0ZXh0dXJlMkQocGFydGljbGVUZXhJTiwgdmVjMih1diwgMC42MjUpKTtcXG4gICAgdmVjNCB0ZXgzID0gdGV4dHVyZTJEKHBhcnRpY2xlVGV4SU4sIHZlYzIodXYsIDAuODc1KSk7XFxuICAgIGluUG9zID0gdmVjMyhkZWNvZGVGbG9hdFJHKHRleDAucmcpLCBkZWNvZGVGbG9hdFJHKHRleDAuYmEpLCBkZWNvZGVGbG9hdFJHKHRleDEucmcpKTtcXG4gICAgaW5Qb3MgPSAoaW5Qb3MgLSB2ZWMzKDAuNSkpICogaW5Cb3VuZHNTaXplICsgaW5Cb3VuZHNDZW50ZXI7XFxuICAgIGluVmVsID0gdGV4Mi54eXo7XFxuICAgIGluVmVsID0gKGluVmVsIC0gdmVjMygwLjUpKSAqIG1heFZlbDtcXG4gICAgaW5BbmdsZSA9IGRlY29kZUZsb2F0UkcodGV4MS5iYSkgKiBQSTI7XFxuICAgIGluU2hvdyA9IHRleDIuYSA+IDAuNTtcXG4gICAgaW5MaWZlID0gZGVjb2RlRmxvYXRSR0JBKHRleDMpO1xcbiAgICBmbG9hdCBtYXhOZWdMaWZlID0gbWF4KGxpZmV0aW1lLCAobnVtUGFydGljbGVzIC0gMS4wKSAqIChyYXRlK3JhdGVEaXYpKTtcXG4gICAgZmxvYXQgbWF4UG9zTGlmZSA9IGxpZmV0aW1lKzEuMDtcXG4gICAgaW5MaWZlID0gaW5MaWZlICogKG1heE5lZ0xpZmUgKyBtYXhQb3NMaWZlKSAtIG1heE5lZ0xpZmU7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlT3V0cHV0RmxvYXRQUyA9IFwidm9pZCB3cml0ZU91dHB1dCgpIHtcXG4gICAgaWYgKGdsX0ZyYWdDb29yZC55PDEuMCkge1xcbiAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChvdXRQb3MsIChvdXRBbmdsZSArIDEwMDAuMCkgKiB2aXNNb2RlKTtcXG4gICAgfSBlbHNlIHtcXG4gICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQob3V0VmVsLCBvdXRMaWZlKTtcXG4gICAgfVxcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZU91dHB1dFJnYmE4UFMgPSBcInVuaWZvcm0gdmVjMyBvdXRCb3VuZHNNdWw7XFxudW5pZm9ybSB2ZWMzIG91dEJvdW5kc0FkZDtcXG52ZWMyIGVuY29kZUZsb2F0UkcoIGZsb2F0IHYgKSB7XFxuICB2ZWMyIGVuYyA9IHZlYzIoMS4wLCAyNTUuMCkgKiB2O1xcbiAgZW5jID0gZnJhY3QoZW5jKTtcXG4gIGVuYyAtPSBlbmMueXkgKiB2ZWMyKDEuMC8yNTUuMCwgMS4wLzI1NS4wKTtcXG4gIHJldHVybiBlbmM7XFxufVxcbnZlYzQgZW5jb2RlRmxvYXRSR0JBKCBmbG9hdCB2ICkge1xcbiAgdmVjNCBlbmMgPSB2ZWM0KDEuMCwgMjU1LjAsIDY1MDI1LjAsIDE2MDU4MTM3NS4wKSAqIHY7XFxuICBlbmMgPSBmcmFjdChlbmMpO1xcbiAgZW5jIC09IGVuYy55end3ICogdmVjNCgxLjAvMjU1LjAsMS4wLzI1NS4wLDEuMC8yNTUuMCwwLjApO1xcbiAgcmV0dXJuIGVuYztcXG59XFxudm9pZCB3cml0ZU91dHB1dCgpIHtcXG4gICAgLy9vdXRQb3MgPSAob3V0UG9zIC0gb3V0Qm91bmRzQ2VudGVyKSAvIG91dEJvdW5kc1NpemUgKyB2ZWMzKDAuNSk7XFxuICAgIG91dFBvcyA9IG91dFBvcyAqIG91dEJvdW5kc011bCArIG91dEJvdW5kc0FkZDtcXG4gICAgb3V0QW5nbGUgPSBmcmFjdChvdXRBbmdsZSAvIFBJMik7XFxuICAgIG91dFZlbCA9IChvdXRWZWwgLyBtYXhWZWwpICsgdmVjMygwLjUpOyAvLyBUT0RPOiBtdWxcXG4gICAgZmxvYXQgbWF4TmVnTGlmZSA9IG1heChsaWZldGltZSwgKG51bVBhcnRpY2xlcyAtIDEuMCkgKiAocmF0ZStyYXRlRGl2KSk7XFxuICAgIGZsb2F0IG1heFBvc0xpZmUgPSBsaWZldGltZSsxLjA7XFxuICAgIG91dExpZmUgPSAob3V0TGlmZSArIG1heE5lZ0xpZmUpIC8gKG1heE5lZ0xpZmUgKyBtYXhQb3NMaWZlKTtcXG4gICAgaWYgKGdsX0ZyYWdDb29yZC55IDwgMS4wKSB7XFxuICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGVuY29kZUZsb2F0Ukcob3V0UG9zLngpLCBlbmNvZGVGbG9hdFJHKG91dFBvcy55KSk7XFxuICAgIH0gZWxzZSBpZiAoZ2xfRnJhZ0Nvb3JkLnkgPCAyLjApIHtcXG4gICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoZW5jb2RlRmxvYXRSRyhvdXRQb3MueiksIGVuY29kZUZsb2F0Ukcob3V0QW5nbGUpKTtcXG4gICAgfSBlbHNlIGlmIChnbF9GcmFnQ29vcmQueSA8IDMuMCkge1xcbiAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChvdXRWZWwsIHZpc01vZGUqMC41KzAuNSk7XFxuICAgIH0gZWxzZSB7XFxuICAgICAgICBnbF9GcmFnQ29sb3IgPSBlbmNvZGVGbG9hdFJHQkEob3V0TGlmZSk7XFxuICAgIH1cXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVVcGRhdGVyQUFCQlBTID0gXCJ1bmlmb3JtIG1hdDMgc3Bhd25Cb3VuZHM7XFxudmVjMyBjYWxjU3Bhd25Qb3NpdGlvbih2ZWMzIGluQm91bmRzLCBmbG9hdCBybmRGYWN0b3IpIHtcXG4gICAgcmV0dXJuIGVtaXR0ZXJQb3MgKyBzcGF3bkJvdW5kcyAqIChpbkJvdW5kcyAtIHZlYzMoMC41KSk7XFxufVxcbnZvaWQgYWRkSW5pdGlhbFZlbG9jaXR5KGlub3V0IHZlYzMgbG9jYWxWZWxvY2l0eSwgdmVjMyBpbkJvdW5kcykge1xcbiAgICBsb2NhbFZlbG9jaXR5IC09IHZlYzMoMCwgMCwgaW5pdGlhbFZlbG9jaXR5KTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVVcGRhdGVyRW5kUFMgPSBcIlxcbiAgICB3cml0ZU91dHB1dCgpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZVVwZGF0ZXJJbml0UFMgPSBcInZhcnlpbmcgdmVjMiB2VXYwO1xcbnVuaWZvcm0gc2FtcGxlcjJEIHBhcnRpY2xlVGV4SU47XFxudW5pZm9ybSBzYW1wbGVyMkQgaW50ZXJuYWxUZXgwO1xcbnVuaWZvcm0gc2FtcGxlcjJEIGludGVybmFsVGV4MTtcXG51bmlmb3JtIHNhbXBsZXIyRCBpbnRlcm5hbFRleDI7XFxudW5pZm9ybSBtYXQzIGVtaXR0ZXJNYXRyaXg7XFxudW5pZm9ybSB2ZWMzIGVtaXR0ZXJTY2FsZTtcXG51bmlmb3JtIHZlYzMgZW1pdHRlclBvcywgZnJhbWVSYW5kb20sIGxvY2FsVmVsb2NpdHlEaXZNdWx0LCB2ZWxvY2l0eURpdk11bHQ7XFxudW5pZm9ybSBmbG9hdCBkZWx0YSwgcmF0ZSwgcmF0ZURpdiwgbGlmZXRpbWUsIG51bVBhcnRpY2xlcywgcm90U3BlZWREaXZNdWx0LCBzZWVkO1xcbnVuaWZvcm0gZmxvYXQgc3RhcnRBbmdsZSwgc3RhcnRBbmdsZTI7XFxudW5pZm9ybSBmbG9hdCBpbml0aWFsVmVsb2NpdHk7XFxudW5pZm9ybSBmbG9hdCBncmFwaFNhbXBsZVNpemU7XFxudW5pZm9ybSBmbG9hdCBncmFwaE51bVNhbXBsZXM7XFxudmVjMyBpblBvcztcXG52ZWMzIGluVmVsO1xcbmZsb2F0IGluQW5nbGU7XFxuYm9vbCBpblNob3c7XFxuZmxvYXQgaW5MaWZlO1xcbmZsb2F0IHZpc01vZGU7XFxudmVjMyBvdXRQb3M7XFxudmVjMyBvdXRWZWw7XFxuZmxvYXQgb3V0QW5nbGU7XFxuYm9vbCBvdXRTaG93O1xcbmZsb2F0IG91dExpZmU7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVVcGRhdGVyTm9SZXNwYXduUFMgPSBcIiAgICBpZiAob3V0TGlmZSA+PSBsaWZldGltZSkge1xcbiAgICAgICAgb3V0TGlmZSAtPSBtYXgobGlmZXRpbWUsIChudW1QYXJ0aWNsZXMgLSAxLjApICogcGFydGljbGVSYXRlKTtcXG4gICAgICAgIHZpc01vZGUgPSAtMS4wO1xcbiAgICB9XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVVcGRhdGVyT25TdG9wUFMgPSBcIiAgICB2aXNNb2RlID0gb3V0TGlmZSA8IDAuMD8gLTEuMDogdmlzTW9kZTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZVVwZGF0ZXJSZXNwYXduUFMgPSBcIiAgICBpZiAob3V0TGlmZSA+PSBsaWZldGltZSkge1xcbiAgICAgICAgb3V0TGlmZSAtPSBtYXgobGlmZXRpbWUsIChudW1QYXJ0aWNsZXMgLSAxLjApICogcGFydGljbGVSYXRlKTtcXG4gICAgICAgIHZpc01vZGUgPSAxLjA7XFxuICAgIH1cXG4gICAgdmlzTW9kZSA9IG91dExpZmUgPCAwLjA/IDEuMDogdmlzTW9kZTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZVVwZGF0ZXJTcGhlcmVQUyA9IFwidW5pZm9ybSBmbG9hdCBzcGF3bkJvdW5kc1NwaGVyZTtcXG52ZWMzIGNhbGNTcGF3blBvc2l0aW9uKHZlYzMgaW5Cb3VuZHMsIGZsb2F0IHJuZEZhY3Rvcikge1xcbiAgICBmbG9hdCBybmQ0ID0gZnJhY3Qocm5kRmFjdG9yICogMTAwMC4wKTtcXG4gICAgcmV0dXJuIGVtaXR0ZXJQb3MgKyBub3JtYWxpemUoaW5Cb3VuZHMueHl6IC0gdmVjMygwLjUpKSAqIHJuZDQgKiBzcGF3bkJvdW5kc1NwaGVyZTtcXG59XFxudm9pZCBhZGRJbml0aWFsVmVsb2NpdHkoaW5vdXQgdmVjMyBsb2NhbFZlbG9jaXR5LCB2ZWMzIGluQm91bmRzKSB7XFxuICAgIGxvY2FsVmVsb2NpdHkgKz0gbm9ybWFsaXplKGluQm91bmRzIC0gdmVjMygwLjUpKSAqIGluaXRpYWxWZWxvY2l0eTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVVcGRhdGVyU3RhcnRQUyA9IFwiZmxvYXQgc2F0dXJhdGUoZmxvYXQgeCkge1xcbiAgICByZXR1cm4gY2xhbXAoeCwgMC4wLCAxLjApO1xcbn1cXG52ZWMzIHVucGFjazNORmxvYXRzKGZsb2F0IHNyYykge1xcbiAgICBmbG9hdCByID0gZnJhY3Qoc3JjKTtcXG4gICAgZmxvYXQgZyA9IGZyYWN0KHNyYyAqIDI1Ni4wKTtcXG4gICAgZmxvYXQgYiA9IGZyYWN0KHNyYyAqIDY1NTM2LjApO1xcbiAgICByZXR1cm4gdmVjMyhyLCBnLCBiKTtcXG59XFxudmVjMyB0ZXgxRGxvZF9sZXJwKHNhbXBsZXIyRCB0ZXgsIHZlYzIgdGMsIG91dCB2ZWMzIHcpIHtcXG4gICAgdmVjNCBhID0gdGV4dHVyZTJEKHRleCwgdGMpO1xcbiAgICB2ZWM0IGIgPSB0ZXh0dXJlMkQodGV4LCB0YyArIGdyYXBoU2FtcGxlU2l6ZSk7XFxuICAgIGZsb2F0IGMgPSBmcmFjdCh0Yy54ICogZ3JhcGhOdW1TYW1wbGVzKTtcXG4gICAgdmVjMyB1bnBhY2tlZEEgPSB1bnBhY2szTkZsb2F0cyhhLncpO1xcbiAgICB2ZWMzIHVucGFja2VkQiA9IHVucGFjazNORmxvYXRzKGIudyk7XFxuICAgIHcgPSBtaXgodW5wYWNrZWRBLCB1bnBhY2tlZEIsIGMpO1xcbiAgICByZXR1cm4gbWl4KGEueHl6LCBiLnh5eiwgYyk7XFxufVxcbiNkZWZpbmUgSEFTSFNDQUxFNCB2ZWM0KDEwMzEsIC4xMDMwLCAuMDk3MywgLjEwOTkpXFxudmVjNCBoYXNoNDEoZmxvYXQgcCkge1xcbiAgICB2ZWM0IHA0ID0gZnJhY3QodmVjNChwKSAqIEhBU0hTQ0FMRTQpO1xcbiAgICBwNCArPSBkb3QocDQsIHA0Lnd6eHkrMTkuMTkpO1xcbiAgICByZXR1cm4gZnJhY3QodmVjNCgocDQueCArIHA0LnkpKnA0LnosIChwNC54ICsgcDQueikqcDQueSwgKHA0LnkgKyBwNC56KSpwNC53LCAocDQueiArIHA0LncpKnA0LngpKTtcXG59XFxudm9pZCBtYWluKHZvaWQpXFxue1xcbiAgICBpZiAoZ2xfRnJhZ0Nvb3JkLnggPiBudW1QYXJ0aWNsZXMpIGRpc2NhcmQ7XFxuICAgIHJlYWRJbnB1dCh2VXYwLngpO1xcbiAgICB2aXNNb2RlID0gaW5TaG93PyAxLjAgOiAtMS4wO1xcbiAgICB2ZWM0IHJuZEZhY3RvciA9IGhhc2g0MShnbF9GcmFnQ29vcmQueCArIHNlZWQpO1xcbiAgICBmbG9hdCBwYXJ0aWNsZVJhdGUgPSByYXRlICsgcmF0ZURpdiAqIHJuZEZhY3Rvci54O1xcbiAgICBvdXRMaWZlID0gaW5MaWZlICsgZGVsdGE7XFxuICAgIGZsb2F0IG5saWZlID0gY2xhbXAob3V0TGlmZSAvIGxpZmV0aW1lLCAwLjAsIDEuMCk7XFxuICAgIHZlYzMgbG9jYWxWZWxvY2l0eURpdjtcXG4gICAgdmVjMyB2ZWxvY2l0eURpdjtcXG4gICAgdmVjMyBwYXJhbURpdjtcXG4gICAgdmVjMyBsb2NhbFZlbG9jaXR5ID0gdGV4MURsb2RfbGVycChpbnRlcm5hbFRleDAsIHZlYzIobmxpZmUsIDApLCBsb2NhbFZlbG9jaXR5RGl2KTtcXG4gICAgdmVjMyB2ZWxvY2l0eSA9ICAgICAgdGV4MURsb2RfbGVycChpbnRlcm5hbFRleDEsIHZlYzIobmxpZmUsIDApLCB2ZWxvY2l0eURpdik7XFxuICAgIHZlYzMgcGFyYW1zID0gICAgICAgIHRleDFEbG9kX2xlcnAoaW50ZXJuYWxUZXgyLCB2ZWMyKG5saWZlLCAwKSwgcGFyYW1EaXYpO1xcbiAgICBmbG9hdCByb3RTcGVlZCA9IHBhcmFtcy54O1xcbiAgICBmbG9hdCByb3RTcGVlZERpdiA9IHBhcmFtRGl2Lnk7XFxuICAgIGxvY2FsVmVsb2NpdHkgKz0gICAgKGxvY2FsVmVsb2NpdHlEaXYgKiB2ZWMzKDIuMCkgLSB2ZWMzKDEuMCkpICogbG9jYWxWZWxvY2l0eURpdk11bHQgKiBybmRGYWN0b3IueHl6O1xcbiAgICB2ZWxvY2l0eSArPSAgICAgICAgICh2ZWxvY2l0eURpdiAqIHZlYzMoMi4wKSAtIHZlYzMoMS4wKSkgKiB2ZWxvY2l0eURpdk11bHQgKiBybmRGYWN0b3IueHl6O1xcbiAgICByb3RTcGVlZCArPSAgICAgICAgIChyb3RTcGVlZERpdiAqIDIuMCAtIDEuMCkgKiByb3RTcGVlZERpdk11bHQgKiBybmRGYWN0b3IueTtcXG4gICAgYWRkSW5pdGlhbFZlbG9jaXR5KGxvY2FsVmVsb2NpdHksIHJuZEZhY3Rvci54eXopO1xcbiAgICBvdXRWZWwgPSBlbWl0dGVyTWF0cml4ICogbG9jYWxWZWxvY2l0eS54eXogKyB2ZWxvY2l0eS54eXogKiBlbWl0dGVyU2NhbGU7XFxuICAgIG91dFBvcyA9IGluUG9zICsgb3V0VmVsICogZGVsdGE7XFxuICAgIG91dEFuZ2xlID0gaW5BbmdsZSArIHJvdFNwZWVkICogZGVsdGE7XFxuICAgIGJvb2wgcmVzcGF3biA9IG91dExpZmUgPD0gMC4wIHx8IG91dExpZmUgPj0gbGlmZXRpbWU7XFxuICAgIG91dFBvcyA9IHJlc3Bhd24/IGNhbGNTcGF3blBvc2l0aW9uKHJuZEZhY3Rvci54eXosIHJuZEZhY3Rvci54KSA6IG91dFBvcztcXG4gICAgb3V0QW5nbGUgPSByZXNwYXduPyBtaXgoc3RhcnRBbmdsZSwgc3RhcnRBbmdsZTIsIHJuZEZhY3Rvci54KSA6IG91dEFuZ2xlO1xcbiAgICBvdXRWZWwgPSByZXNwYXduPyB2ZWMzKDAuMCkgOiBvdXRWZWw7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfVEJOVlMgPSBcIlxcbiAgICBtYXQzIHJvdDMgPSBtYXQzKHJvdE1hdHJpeFswXVswXSwgcm90TWF0cml4WzBdWzFdLCAwLjAsICAgICAgICByb3RNYXRyaXhbMV1bMF0sIHJvdE1hdHJpeFsxXVsxXSwgMC4wLCAgICAgICAgMC4wLCAwLjAsIDEuMCk7XFxuICAgIFBhcnRpY2xlTWF0ID0gbWF0MygtbWF0cml4X3ZpZXdJbnZlcnNlWzBdLnh5eiwgLW1hdHJpeF92aWV3SW52ZXJzZVsxXS54eXosIG1hdHJpeF92aWV3SW52ZXJzZVsyXS54eXopICogcm90MztcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9iaWxsYm9hcmRWUyA9IFwiXFxuICAgIHF1YWRYWSA9IHJvdGF0ZShxdWFkWFksIGluQW5nbGUsIHJvdE1hdHJpeCk7XFxuICAgIHZlYzMgbG9jYWxQb3MgPSBiaWxsYm9hcmQocGFydGljbGVQb3MsIHF1YWRYWSk7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfYmxlbmRBZGRQUyA9IFwiXFxuICAgIHJnYiAqPSBzYXR1cmF0ZShnYW1tYUNvcnJlY3RJbnB1dChhKSk7XFxuICAgIGlmICgocmdiLnIgKyByZ2IuZyArIHJnYi5iKSA8IDAuMDAwMDAxKSBkaXNjYXJkO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX2JsZW5kTXVsdGlwbHlQUyA9IFwiXFxuICAgIHJnYiA9IG1peCh2ZWMzKDEuMCksIHJnYiwgdmVjMyhhKSk7XFxuICAgIGlmIChyZ2IuciArIHJnYi5nICsgcmdiLmIgPiAyLjk5KSBkaXNjYXJkO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX2JsZW5kTm9ybWFsUFMgPSBcIlxcbiAgICBpZiAoYSA8IDAuMDEpIGRpc2NhcmQ7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfY3B1VlMgPSBcImF0dHJpYnV0ZSB2ZWM0IHBhcnRpY2xlX3ZlcnRleERhdGE7ICAgICAvLyBYWVogPSB3b3JsZCBwb3MsIFcgPSBsaWZlXFxuYXR0cmlidXRlIHZlYzQgcGFydGljbGVfdmVydGV4RGF0YTI7ICAgICAvLyBYID0gYW5nbGUsIFkgPSBzY2FsZSwgWiA9IGFscGhhLCBXID0gdmVsb2NpdHkueFxcbmF0dHJpYnV0ZSB2ZWM0IHBhcnRpY2xlX3ZlcnRleERhdGEzOyAgICAgLy8gWFlaID0gcGFydGljbGUgbG9jYWwgcG9zLCBXID0gdmVsb2NpdHkueVxcbmF0dHJpYnV0ZSB2ZWMyIHBhcnRpY2xlX3ZlcnRleERhdGE0OyAgICAgLy8gWCA9IHZlbG9jaXR5LnosIFcgPSBwYXJ0aWNsZSBJRFxcbnVuaWZvcm0gbWF0NCBtYXRyaXhfdmlld1Byb2plY3Rpb247XFxudW5pZm9ybSBtYXQ0IG1hdHJpeF9tb2RlbDtcXG51bmlmb3JtIG1hdDQgbWF0cml4X3ZpZXc7XFxudW5pZm9ybSBtYXQzIG1hdHJpeF9ub3JtYWw7XFxudW5pZm9ybSBtYXQ0IG1hdHJpeF92aWV3SW52ZXJzZTtcXG51bmlmb3JtIGZsb2F0IG51bVBhcnRpY2xlcztcXG51bmlmb3JtIGZsb2F0IGxpZmV0aW1lO1xcbnVuaWZvcm0gZmxvYXQgc3RyZXRjaDtcXG4vL3VuaWZvcm0gZmxvYXQgZ3JhcGhTYW1wbGVTaXplO1xcbi8vdW5pZm9ybSBmbG9hdCBncmFwaE51bVNhbXBsZXM7XFxudW5pZm9ybSB2ZWMzIHdyYXBCb3VuZHMsIGVtaXR0ZXJTY2FsZTtcXG51bmlmb3JtIHNhbXBsZXIyRCB0ZXhMaWZlQW5kU291cmNlUG9zT1VUO1xcbnVuaWZvcm0gc2FtcGxlcjJEIGludGVybmFsVGV4MDtcXG51bmlmb3JtIHNhbXBsZXIyRCBpbnRlcm5hbFRleDE7XFxudW5pZm9ybSBzYW1wbGVyMkQgaW50ZXJuYWxUZXgyO1xcbnVuaWZvcm0gdmVjMyBlbWl0dGVyUG9zO1xcbnZhcnlpbmcgdmVjNCB0ZXhDb29yZHNBbHBoYUxpZmU7XFxudmVjMiByb3RhdGUodmVjMiBxdWFkWFksIGZsb2F0IHBSb3RhdGlvbiwgb3V0IG1hdDIgcm90TWF0cml4KVxcbntcXG4gICAgZmxvYXQgYyA9IGNvcyhwUm90YXRpb24pO1xcbiAgICBmbG9hdCBzID0gc2luKHBSb3RhdGlvbik7XFxuICAgIC8vdmVjNCByb3RhdGlvbk1hdHJpeCA9IHZlYzQoYywgLXMsIHMsIGMpO1xcbiAgICBtYXQyIG0gPSBtYXQyKGMsIC1zLCBzLCBjKTtcXG4gICAgcm90TWF0cml4ID0gbTtcXG4gICAgcmV0dXJuIG0gKiBxdWFkWFk7XFxufVxcbnZlYzMgYmlsbGJvYXJkKHZlYzMgSW5zdGFuY2VDb29yZHMsIHZlYzIgcXVhZFhZKVxcbntcXG4gICAgdmVjMyBwb3MgPSAtbWF0cml4X3ZpZXdJbnZlcnNlWzBdLnh5eiAqIHF1YWRYWS54ICsgLW1hdHJpeF92aWV3SW52ZXJzZVsxXS54eXogKiBxdWFkWFkueTtcXG4gICAgcmV0dXJuIHBvcztcXG59XFxudm9pZCBtYWluKHZvaWQpXFxue1xcbiAgICB2ZWMzIHBhcnRpY2xlUG9zID0gcGFydGljbGVfdmVydGV4RGF0YS54eXo7XFxuICAgIHZlYzMgaW5Qb3MgPSBwYXJ0aWNsZVBvcztcXG4gICAgdmVjMyB2ZXJ0UG9zID0gcGFydGljbGVfdmVydGV4RGF0YTMueHl6O1xcbiAgICB2ZWMzIGluVmVsID0gdmVjMyhwYXJ0aWNsZV92ZXJ0ZXhEYXRhMi53LCBwYXJ0aWNsZV92ZXJ0ZXhEYXRhMy53LCBwYXJ0aWNsZV92ZXJ0ZXhEYXRhNC54KTtcXG4gICAgdmVjMiB2ZWxvY2l0eVYgPSBub3JtYWxpemUoKG1hdDMobWF0cml4X3ZpZXcpICogaW5WZWwpLnh5KTsgLy8gc2hvdWxkIGJlIHJlbW92ZWQgYnkgY29tcGlsZXIgaWYgYWxpZ24vc3RyZXRjaCBpcyBub3QgdXNlZFxcbiAgICB2ZWMyIHF1YWRYWSA9IHZlcnRQb3MueHk7XFxuICAgIHRleENvb3Jkc0FscGhhTGlmZSA9IHZlYzQocXVhZFhZICogLTAuNSArIDAuNSwgcGFydGljbGVfdmVydGV4RGF0YTIueiwgcGFydGljbGVfdmVydGV4RGF0YS53KTtcXG4gICAgbWF0MiByb3RNYXRyaXg7XFxuICAgIGZsb2F0IGluQW5nbGUgPSBwYXJ0aWNsZV92ZXJ0ZXhEYXRhMi54O1xcbiAgICB2ZWMzIHBhcnRpY2xlUG9zTW92ZWQgPSB2ZWMzKDAuMCk7XFxuICAgIHZlYzMgbWVzaExvY2FsUG9zID0gcGFydGljbGVfdmVydGV4RGF0YTMueHl6O1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX2NwdV9lbmRWUyA9IFwiXFxuICAgIGxvY2FsUG9zICo9IHBhcnRpY2xlX3ZlcnRleERhdGEyLnkgKiBlbWl0dGVyU2NhbGU7XFxuICAgIGxvY2FsUG9zICs9IHBhcnRpY2xlUG9zO1xcbiAgICBnbF9Qb3NpdGlvbiA9IG1hdHJpeF92aWV3UHJvamVjdGlvbiAqIHZlYzQobG9jYWxQb3MsIDEuMCk7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfZW5kUFMgPSBcIiAgICByZ2IgPSBhZGRGb2cocmdiKTtcXG4gICAgcmdiID0gdG9uZU1hcChyZ2IpO1xcbiAgICByZ2IgPSBnYW1tYUNvcnJlY3RPdXRwdXQocmdiKTtcXG4gICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChyZ2IsIGEpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9lbmRWUyA9IFwiXFxuICAgIGxvY2FsUG9zICo9IHNjYWxlICogZW1pdHRlclNjYWxlO1xcbiAgICBsb2NhbFBvcyArPSBwYXJ0aWNsZVBvcztcXG4gICAgZ2xfUG9zaXRpb24gPSBtYXRyaXhfdmlld1Byb2plY3Rpb24gKiB2ZWM0KGxvY2FsUG9zLnh5eiwgMS4wKTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9oYWxmbGFtYmVydFBTID0gXCJcXG4gICAgdmVjMyBuZWdOb3JtYWwgPSBub3JtYWwqMC41KzAuNTtcXG4gICAgdmVjMyBwb3NOb3JtYWwgPSAtbm9ybWFsKjAuNSswLjU7XFxuICAgIG5lZ05vcm1hbCAqPSBuZWdOb3JtYWw7XFxuICAgIHBvc05vcm1hbCAqPSBwb3NOb3JtYWw7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfaW5pdFZTID0gXCJhdHRyaWJ1dGUgdmVjNCBwYXJ0aWNsZV92ZXJ0ZXhEYXRhOyAvLyBYWVogPSBwYXJ0aWNsZSBwb3NpdGlvbiwgVyA9IHBhcnRpY2xlIElEICsgcmFuZG9tIGZhY3RvclxcbnVuaWZvcm0gbWF0NCBtYXRyaXhfdmlld1Byb2plY3Rpb247XFxudW5pZm9ybSBtYXQ0IG1hdHJpeF9tb2RlbDtcXG51bmlmb3JtIG1hdDMgbWF0cml4X25vcm1hbDtcXG51bmlmb3JtIG1hdDQgbWF0cml4X3ZpZXdJbnZlcnNlO1xcbnVuaWZvcm0gbWF0NCBtYXRyaXhfdmlldztcXG51bmlmb3JtIGZsb2F0IG51bVBhcnRpY2xlcywgbnVtUGFydGljbGVzUG90O1xcbnVuaWZvcm0gZmxvYXQgZ3JhcGhTYW1wbGVTaXplO1xcbnVuaWZvcm0gZmxvYXQgZ3JhcGhOdW1TYW1wbGVzO1xcbnVuaWZvcm0gZmxvYXQgc3RyZXRjaDtcXG51bmlmb3JtIHZlYzMgd3JhcEJvdW5kcztcXG51bmlmb3JtIHZlYzMgZW1pdHRlclNjYWxlLCBlbWl0dGVyUG9zO1xcbnVuaWZvcm0gZmxvYXQgcmF0ZSwgcmF0ZURpdiwgbGlmZXRpbWUsIGRlbHRhUmFuZG9tbmVzc1N0YXRpYywgc2NhbGVEaXZNdWx0LCBhbHBoYURpdk11bHQsIHNlZWQsIGRlbHRhO1xcbnVuaWZvcm0gc2FtcGxlcjJEIHBhcnRpY2xlVGV4T1VULCBwYXJ0aWNsZVRleElOO1xcbnVuaWZvcm0gc2FtcGxlcjJEIGludGVybmFsVGV4MDtcXG51bmlmb3JtIHNhbXBsZXIyRCBpbnRlcm5hbFRleDE7XFxudW5pZm9ybSBzYW1wbGVyMkQgaW50ZXJuYWxUZXgyO1xcbnZhcnlpbmcgdmVjNCB0ZXhDb29yZHNBbHBoYUxpZmU7XFxudmVjMyBpblBvcztcXG52ZWMzIGluVmVsO1xcbmZsb2F0IGluQW5nbGU7XFxuYm9vbCBpblNob3c7XFxuZmxvYXQgaW5MaWZlO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX2xhbWJlcnRQUyA9IFwiXFxuICAgIHZlYzMgbmVnTm9ybWFsID0gbWF4KG5vcm1hbCwgdmVjMygwLjApKTtcXG4gICAgdmVjMyBwb3NOb3JtYWwgPSBtYXgoLW5vcm1hbCwgdmVjMygwLjApKTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9saWdodGluZ1BTID0gXCJcXG4gICAgdmVjMyBsaWdodCA9IG5lZ05vcm1hbC54KmxpZ2h0Q3ViZVswXSArIHBvc05vcm1hbC54KmxpZ2h0Q3ViZVsxXSArXFxuICAgICAgICAgICAgICAgICAgICAgICAgbmVnTm9ybWFsLnkqbGlnaHRDdWJlWzJdICsgcG9zTm9ybWFsLnkqbGlnaHRDdWJlWzNdICtcXG4gICAgICAgICAgICAgICAgICAgICAgICBuZWdOb3JtYWwueipsaWdodEN1YmVbNF0gKyBwb3NOb3JtYWwueipsaWdodEN1YmVbNV07XFxuICAgIHJnYiAqPSBsaWdodDtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9sb2NhbFNoaWZ0VlMgPSBcIiAgICBwYXJ0aWNsZVBvcyArPSBlbWl0dGVyUG9zO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX21lc2hWUyA9IFwiXFxuICAgIHZlYzMgbG9jYWxQb3MgPSBtZXNoTG9jYWxQb3M7XFxuICAgIGxvY2FsUG9zLnh5ID0gcm90YXRlKGxvY2FsUG9zLnh5LCBpbkFuZ2xlLCByb3RNYXRyaXgpO1xcbiAgICBsb2NhbFBvcy55eiA9IHJvdGF0ZShsb2NhbFBvcy55eiwgaW5BbmdsZSwgcm90TWF0cml4KTtcXG4gICAgYmlsbGJvYXJkKHBhcnRpY2xlUG9zLCBxdWFkWFkpO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX25vcm1hbFZTID0gXCJcXG4gICAgTm9ybWFsID0gbm9ybWFsaXplKGxvY2FsUG9zICsgbWF0cml4X3ZpZXdJbnZlcnNlWzJdLnh5eik7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfbm9ybWFsTWFwUFMgPSBcIlxcbiAgICB2ZWMzIG5vcm1hbE1hcCAgICAgICAgID0gbm9ybWFsaXplKCB0ZXh0dXJlMkQobm9ybWFsTWFwLCB0ZXhDb29yZHNBbHBoYUxpZmUueHkpLnh5eiAqIDIuMCAtIDEuMCApO1xcbiAgICB2ZWMzIG5vcm1hbCA9IFBhcnRpY2xlTWF0ICogbm9ybWFsTWFwO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnBhcnRpY2xlX3BvaW50QWxvbmdWUyA9IFwiICAgIGluQW5nbGUgPSBhdGFuKHZlbG9jaXR5Vi54LCB2ZWxvY2l0eVYueSk7IC8vIG5vdCB0aGUgZmFzdGVzdCB3YXksIGJ1dCBlYXNpZXIgdG8gcGx1ZyBpbjsgVE9ETzogY3JlYXRlIHJvdCBtYXRyaXggcmlnaHQgZnJvbSB2ZWN0b3JzXFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfc29mdFBTID0gXCJcXG4gICAgdmVjMiBzY3JlZW5UQyA9IGdsX0ZyYWdDb29yZC54eSAqIHVTY3JlZW5TaXplLnp3O1xcbiAgICBmbG9hdCBkZXB0aCA9IHVucGFja0Zsb2F0KCB0ZXh0dXJlMkQodURlcHRoTWFwLCBzY3JlZW5UQykgKSAqIGNhbWVyYV9mYXI7XFxuICAgIGZsb2F0IHBhcnRpY2xlRGVwdGggPSB2RGVwdGg7XFxuICAgIGZsb2F0IGRlcHRoRGlmZiA9IHNhdHVyYXRlKGFicyhwYXJ0aWNsZURlcHRoIC0gZGVwdGgpICogc29mdGVuaW5nKTtcXG4gICAgYSAqPSBkZXB0aERpZmY7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucGFydGljbGVfc29mdFZTID0gXCJcXG4gICAgdkRlcHRoID0gLShtYXRyaXhfdmlldyAqIHZlYzQobG9jYWxQb3MsMS4wKSkuejtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV9zdHJldGNoVlMgPSBcIiAgICB2ZWMzIG1vdmVEaXIgPSBpblZlbCAqIHN0cmV0Y2g7XFxuICAgIHZlYzMgcG9zUHJldiA9IGluUG9zIC0gbW92ZURpcjtcXG4gICAgcG9zUHJldiArPSBwYXJ0aWNsZVBvc01vdmVkO1xcbiAgICB2ZWMyIGNlbnRlclRvVmVydGV4ViA9IG5vcm1hbGl6ZSgobWF0MyhtYXRyaXhfdmlldykgKiBsb2NhbFBvcykueHkpO1xcbiAgICBmbG9hdCBpbnRlcnBvbGF0aW9uID0gZG90KC12ZWxvY2l0eVYsIGNlbnRlclRvVmVydGV4VikgKiAwLjUgKyAwLjU7XFxuICAgIHBhcnRpY2xlUG9zID0gbWl4KHBhcnRpY2xlUG9zLCBwb3NQcmV2LCBpbnRlcnBvbGF0aW9uKTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5wYXJ0aWNsZV93cmFwVlMgPSBcIlxcbiAgICB2ZWMzIG9yaWdQYXJ0aWNsZVBvcyA9IHBhcnRpY2xlUG9zO1xcbiAgICBwYXJ0aWNsZVBvcyAtPSBtYXRyaXhfbW9kZWxbM10ueHl6O1xcbiAgICBwYXJ0aWNsZVBvcyA9IG1vZChwYXJ0aWNsZVBvcywgd3JhcEJvdW5kcykgLSB3cmFwQm91bmRzICogMC41O1xcbiAgICBwYXJ0aWNsZVBvcyArPSBtYXRyaXhfbW9kZWxbM10ueHl6O1xcbiAgICBwYXJ0aWNsZVBvc01vdmVkID0gcGFydGljbGVQb3MgLSBvcmlnUGFydGljbGVQb3M7XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucHJlY2lzaW9uVGVzdFBTID0gXCJ2b2lkIG1haW4odm9pZCkge1xcbiAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KDIxNDc0ODM2NDguMCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnByZWNpc2lvblRlc3QyUFMgPSBcInVuaWZvcm0gc2FtcGxlcjJEIHNvdXJjZTtcXG52ZWM0IHBhY2tGbG9hdChmbG9hdCBkZXB0aCkge1xcbiAgICBjb25zdCB2ZWM0IGJpdF9zaGlmdCA9IHZlYzQoMjU2LjAgKiAyNTYuMCAqIDI1Ni4wLCAyNTYuMCAqIDI1Ni4wLCAyNTYuMCwgMS4wKTtcXG4gICAgY29uc3QgdmVjNCBiaXRfbWFzayAgPSB2ZWM0KDAuMCwgMS4wIC8gMjU2LjAsIDEuMCAvIDI1Ni4wLCAxLjAgLyAyNTYuMCk7XFxuICAgIHZlYzQgcmVzID0gbW9kKGRlcHRoICogYml0X3NoaWZ0ICogdmVjNCgyNTUpLCB2ZWM0KDI1NikgKSAvIHZlYzQoMjU1KTtcXG4gICAgcmVzIC09IHJlcy54eHl6ICogYml0X21hc2s7XFxuICAgIHJldHVybiByZXM7XFxufVxcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIGZsb2F0IGMgPSB0ZXh0dXJlMkQoc291cmNlLCB2ZWMyKDAuMCkpLnI7XFxuICAgIGZsb2F0IGRpZmYgPSBhYnMoYyAtIDIxNDc0ODM2NDguMCkgLyAyMTQ3NDgzNjQ4LjA7XFxuICAgIGdsX0ZyYWdDb2xvciA9IHBhY2tGbG9hdChkaWZmKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucHJlZmlsdGVyQ3ViZW1hcFBTID0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG51bmlmb3JtIHNhbXBsZXJDdWJlIHNvdXJjZTtcXG51bmlmb3JtIHZlYzQgcGFyYW1zO1xcbmZsb2F0IHNhdHVyYXRlKGZsb2F0IHgpIHtcXG4gICAgcmV0dXJuIGNsYW1wKHgsIDAuMCwgMS4wKTtcXG59XFxuZmxvYXQgcm5kKHZlYzIgdXYpIHtcXG4gICAgcmV0dXJuIGZyYWN0KHNpbihkb3QodXYsIHZlYzIoMTIuOTg5OCwgNzguMjMzKSAqIDIuMCkpICogNDM3NTguNTQ1Myk7XFxufVxcbmNvbnN0IGZsb2F0IFBJID0gMy4xNDE1OTI2NTM1ODk3OTtcXG52ZWMzIGhlbWlzcGhlcmVTYW1wbGVfY29zKHZlYzIgdXYsIG1hdDMgdmVjU3BhY2UsIHZlYzMgY3ViZURpciwgZmxvYXQgZ2xvc3MpIHsgLy8gY29zICsgbGVycGVkIGNvbmUgc2l6ZSAoYmV0dGVyIHRoYW4ganVzdCBsZXJwZWQpXFxuICAgIGZsb2F0IHBoaSA9IHV2LnkgKiAyLjAgKiBQSTtcXG4gICAgZmxvYXQgY29zVGhldGEgPSBzcXJ0KDEuMCAtIHV2LngpO1xcbiAgICBmbG9hdCBzaW5UaGV0YSA9IHNxcnQoMS4wIC0gY29zVGhldGEgKiBjb3NUaGV0YSk7XFxuICAgIHZlYzMgc2FtcGxlRGlyID0gdmVjMyhjb3MocGhpKSAqIHNpblRoZXRhLCBzaW4ocGhpKSAqIHNpblRoZXRhLCBjb3NUaGV0YSk7XFxuICAgIHJldHVybiBub3JtYWxpemUobWl4KHZlY1NwYWNlICogc2FtcGxlRGlyLCBjdWJlRGlyLCBwYXJhbXMueSkpO1xcbn1cXG52ZWMzIGhlbWlzcGhlcmVTYW1wbGVfcGhvbmcodmVjMiB1diwgbWF0MyB2ZWNTcGFjZSwgdmVjMyBjdWJlRGlyLCBmbG9hdCBzcGVjUG93KSB7XFxuICAgIGZsb2F0IHBoaSA9IHV2LnkgKiAyLjAgKiBQSTtcXG4gICAgZmxvYXQgY29zVGhldGEgPSBwb3coMS4wIC0gdXYueCwgMS4wIC8gKHNwZWNQb3cgKyAxLjApKTtcXG4gICAgZmxvYXQgc2luVGhldGEgPSBzcXJ0KDEuMCAtIGNvc1RoZXRhICogY29zVGhldGEpO1xcbiAgICB2ZWMzIHNhbXBsZURpciA9IHZlYzMoY29zKHBoaSkgKiBzaW5UaGV0YSwgc2luKHBoaSkgKiBzaW5UaGV0YSwgY29zVGhldGEpO1xcbiAgICByZXR1cm4gdmVjU3BhY2UgKiBzYW1wbGVEaXI7XFxufVxcbm1hdDMgbWF0cml4RnJvbVZlY3Rvcih2ZWMzIG4pIHsgLy8gZnJpc3ZhZFxcbiAgICBmbG9hdCBhID0gMS4wIC8gKDEuMCArIG4ueik7XFxuICAgIGZsb2F0IGIgPSAtbi54ICogbi55ICogYTtcXG4gICAgdmVjMyBiMSA9IHZlYzMoMS4wIC0gbi54ICogbi54ICogYSwgYiwgLW4ueCk7XFxuICAgIHZlYzMgYjIgPSB2ZWMzKGIsIDEuMCAtIG4ueSAqIG4ueSAqIGEsIC1uLnkpO1xcbiAgICByZXR1cm4gbWF0MyhiMSwgYjIsIG4pO1xcbn1cXG52ZWM0IGVuY29kZVJHQk0odmVjMyBjb2xvcikgeyAvLyBtb2RpZmllZCBSR0JNXFxuICAgIHZlYzQgZW5jb2RlZDtcXG4gICAgZW5jb2RlZC5yZ2IgPSBwb3coY29sb3IucmdiLCB2ZWMzKDAuNSkpO1xcbiAgICBlbmNvZGVkLnJnYiAqPSAxLjAgLyA4LjA7XFxuICAgIGVuY29kZWQuYSA9IHNhdHVyYXRlKCBtYXgoIG1heCggZW5jb2RlZC5yLCBlbmNvZGVkLmcgKSwgbWF4KCBlbmNvZGVkLmIsIDEuMCAvIDI1NS4wICkgKSApO1xcbiAgICBlbmNvZGVkLmEgPSBjZWlsKGVuY29kZWQuYSAqIDI1NS4wKSAvIDI1NS4wO1xcbiAgICBlbmNvZGVkLnJnYiAvPSBlbmNvZGVkLmE7XFxuICAgIHJldHVybiBlbmNvZGVkO1xcbn1cXG52b2lkIG1haW4odm9pZCkge1xcbiAgICB2ZWMyIHN0ID0gdlV2MCAqIDIuMCAtIDEuMDtcXG4gICAgaWYgKHBhcmFtcy53PT0xLjAgfHwgcGFyYW1zLnc9PTMuMCkge1xcbiAgICAgICAgc3QgPSAyLjAgKiBmbG9vcihnbF9GcmFnQ29vcmQueHkpIC8gKHBhcmFtcy56IC0gMS4wKSAtIDEuMDtcXG4gICAgfVxcbiAgICBmbG9hdCBmYWNlID0gcGFyYW1zLng7XFxuICAgIHZlYzMgdmVjO1xcbiAgICBpZiAoZmFjZT09MC4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKDEsIC1zdC55LCAtc3QueCk7XFxuICAgIH0gZWxzZSBpZiAoZmFjZT09MS4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKC0xLCAtc3QueSwgc3QueCk7XFxuICAgIH0gZWxzZSBpZiAoZmFjZT09Mi4wKSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKHN0LngsIDEsIHN0LnkpO1xcbiAgICB9IGVsc2UgaWYgKGZhY2U9PTMuMCkge1xcbiAgICAgICAgdmVjID0gdmVjMyhzdC54LCAtMSwgLXN0LnkpO1xcbiAgICB9IGVsc2UgaWYgKGZhY2U9PTQuMCkge1xcbiAgICAgICAgdmVjID0gdmVjMyhzdC54LCAtc3QueSwgMSk7XFxuICAgIH0gZWxzZSB7XFxuICAgICAgICB2ZWMgPSB2ZWMzKC1zdC54LCAtc3QueSwgLTEpO1xcbiAgICB9XFxuICAgIG1hdDMgdmVjU3BhY2UgPSBtYXRyaXhGcm9tVmVjdG9yKG5vcm1hbGl6ZSh2ZWMpKTtcXG4gICAgdmVjMyBjb2xvciA9IHZlYzMoMC4wKTtcXG4gICAgY29uc3QgaW50IHNhbXBsZXMgPSAkTlVNU0FNUExFUztcXG4gICAgdmVjMyB2ZWN0O1xcbiAgICBmb3IoaW50IGk9MDsgaTxzYW1wbGVzOyBpKyspIHtcXG4gICAgICAgIGZsb2F0IHNpbmkgPSBzaW4oZmxvYXQoaSkpO1xcbiAgICAgICAgZmxvYXQgY29zaSA9IGNvcyhmbG9hdChpKSk7XFxuICAgICAgICBmbG9hdCByYW5kID0gcm5kKHZlYzIoc2luaSwgY29zaSkpO1xcbiAgICAgICAgdmVjdCA9IGhlbWlzcGhlcmVTYW1wbGVfJE1FVEhPRCh2ZWMyKGZsb2F0KGkpIC8gZmxvYXQoc2FtcGxlcyksIHJhbmQpLCB2ZWNTcGFjZSwgdmVjLCBwYXJhbXMueSk7XFxuICAgICAgICBjb2xvciArPSAkdGV4dHVyZUN1YmUoc291cmNlLCB2ZWN0KS5yZ2I7XFxuICAgIH1cXG4gICAgY29sb3IgLz0gZmxvYXQoc2FtcGxlcyk7XFxuICAgIGdsX0ZyYWdDb2xvciA9IHBhcmFtcy53IDwgMi4wPyB2ZWM0KGNvbG9yLCAxLjApIDogZW5jb2RlUkdCTShjb2xvcik7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnJlZmxEaXJQUyA9IFwidm9pZCBnZXRSZWZsRGlyKCkge1xcbiAgICBkUmVmbERpclcgPSBub3JtYWxpemUoLXJlZmxlY3QoZFZpZXdEaXJXLCBkTm9ybWFsVykpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5yZWZsZWN0aW9uQ3ViZVBTID0gXCJ1bmlmb3JtIHNhbXBsZXJDdWJlIHRleHR1cmVfY3ViZU1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3JlZmxlY3Rpdml0eTtcXG52b2lkIGFkZFJlZmxlY3Rpb24oKSB7XFxuICAgIHZlYzMgbG9va3VwVmVjID0gZml4U2VhbXMoY3ViZU1hcFByb2plY3QoZFJlZmxEaXJXKSk7XFxuICAgIGxvb2t1cFZlYy54ICo9IC0xLjA7XFxuICAgIGRSZWZsZWN0aW9uICs9IHZlYzQoJHRleHR1cmVDdWJlU0FNUExFKHRleHR1cmVfY3ViZU1hcCwgbG9va3VwVmVjKS5yZ2IsIG1hdGVyaWFsX3JlZmxlY3Rpdml0eSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnJlZmxlY3Rpb25EcEF0bGFzUFMgPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfc3BoZXJlTWFwO1xcbnVuaWZvcm0gZmxvYXQgbWF0ZXJpYWxfcmVmbGVjdGl2aXR5O1xcbnZlYzIgZ2V0RHBBdGxhc1V2KHZlYzIgdXYsIGZsb2F0IG1pcCkge1xcbiAgICB2ZWM0IHJlY3Q7XFxuICAgIGZsb2F0IHN4ID0gc2F0dXJhdGUobWlwIC0gMi4wKTtcXG4gICAgcmVjdC54ID0gc3ggKiAwLjU7XFxuICAgIGZsb2F0IHQgPSBtaXAgLSByZWN0LnggKiA2LjA7XFxuICAgIGZsb2F0IGkgPSAxLjAgLSByZWN0Lng7XFxuICAgIHJlY3QueSA9IG1pbih0ICogMC41LCAwLjc1KSAqIGkgKyByZWN0Lng7XFxuICAgIGZsb2F0IHN0ID0gc2F0dXJhdGUodCk7XFxuICAgIHJlY3QueiA9ICgxLjAgLSBzdCAqIDAuNSkgKiBpO1xcbiAgICByZWN0LncgPSByZWN0LnogKiAwLjU7XFxuICAgIGZsb2F0IHJjUmVjdFogPSAxLjAgLyByZWN0Lno7XFxuICAgIGZsb2F0IHNjYWxlRmFjdG9yID0gMC4wMDM5MDYyNSAqIHJjUmVjdFo7IC8vIDAuMDA3ODEyNSA9ICgyNTYgKyAyKSAvIDI1NiAtIDEsIDAuMDAzOTA2MjUgc2FtZSBmb3IgNTEyXFxuICAgIHZlYzIgc2NhbGUgPSB2ZWMyKHNjYWxlRmFjdG9yLCBzY2FsZUZhY3RvciAqIDIuMCk7XFxuICAgIHV2ID0gdXYgKiAodmVjMigxLjApIC0gc2NhbGUpICsgc2NhbGUgKiAwLjU7XFxuICAgIHV2ID0gdXYgKiByZWN0Lnp3ICsgcmVjdC54eTtcXG4gICAgcmV0dXJuIHV2O1xcbn1cXG52b2lkIGFkZFJlZmxlY3Rpb24oKSB7XFxuICAgIHZlYzMgcmVmbERpciA9IG5vcm1hbGl6ZShjdWJlTWFwUHJvamVjdChkUmVmbERpclcpKTtcXG4gICAgLy8gQ29udmVydCB2ZWN0b3IgdG8gRFAgY29vcmRzXFxuICAgIGJvb2wgdXAgPSByZWZsRGlyLnkgPiAwLjA7XFxuICAgIGZsb2F0IHNjYWxlID0gMC45MDkwOTA5MDkwOTA5MDkwOTA5MDkwOTA5MDkwOTA5MTsvLyAxLjAgLyAxLjE7XFxuICAgIHZlYzMgcmVmbERpcldhcnAgPSByZWZsRGlyLnh6eCAqIHZlYzMoLTAuMjUsIDAuNSwgMC4yNSk7XFxuICAgIGZsb2F0IHJlZmxEaXJWZXIgPSBhYnMocmVmbERpci55KSArIDEuMDtcXG4gICAgcmVmbERpcldhcnAgLz0gcmVmbERpclZlcjtcXG4gICAgcmVmbERpcldhcnAgKj0gc2NhbGU7XFxuICAgIHJlZmxEaXJXYXJwID0gdmVjMygwLjc1LCAwLjUsIDAuMjUpIC0gcmVmbERpcldhcnA7XFxuICAgIHZlYzIgdGMgPSB1cD8gcmVmbERpcldhcnAueHkgOiByZWZsRGlyV2FycC56eTtcXG4gICAgZmxvYXQgYmlhcyA9IHNhdHVyYXRlKDEuMCAtIGRHbG9zc2luZXNzKSAqIDUuMDsgLy8gbXVsdGlwbHkgYnkgbWF4IG1pcCBsZXZlbFxcbiAgICBmbG9hdCBtaXAgPSBmbG9vcihiaWFzKTtcXG4gICAgdmVjMyB0ZXgxID0gJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX3NwaGVyZU1hcCwgZ2V0RHBBdGxhc1V2KHRjLCBtaXApKS5yZ2I7XFxuICAgIG1pcCA9IG1pbihtaXAgKyAxLjAsIDUuMCk7XFxuICAgIHZlYzMgdGV4MiA9ICR0ZXh0dXJlMkRTQU1QTEUodGV4dHVyZV9zcGhlcmVNYXAsIGdldERwQXRsYXNVdih0YywgbWlwKSkucmdiO1xcbiAgICB0ZXgxID0gbWl4KHRleDEsIHRleDIsIGZyYWN0KGJpYXMpKTtcXG4gICAgdGV4MSA9IHByb2Nlc3NFbnZpcm9ubWVudCh0ZXgxKTtcXG4gICAgZFJlZmxlY3Rpb24gKz0gdmVjNCh0ZXgxLCBtYXRlcmlhbF9yZWZsZWN0aXZpdHkpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5yZWZsZWN0aW9uUHJlZmlsdGVyZWRDdWJlUFMgPSBcInVuaWZvcm0gc2FtcGxlckN1YmUgdGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAxMjg7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDY0O1xcbnVuaWZvcm0gc2FtcGxlckN1YmUgdGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAzMjtcXG51bmlmb3JtIHNhbXBsZXJDdWJlIHRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTY7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDg7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDQ7XFxudW5pZm9ybSBmbG9hdCBtYXRlcmlhbF9yZWZsZWN0aXZpdHk7XFxudm9pZCBhZGRSZWZsZWN0aW9uKCkge1xcbiAgICAvLyBVbmZvcnR1bmF0ZWx5LCBXZWJHTCBkb2Vzbid0IGFsbG93IHVzIHVzaW5nIHRleHR1cmVDdWJlTG9kLiBUaGVyZWZvcmUgYnVuY2ggb2YgbmFzdHkgd29ya2Fyb3VuZHMgaXMgcmVxdWlyZWQuXFxuICAgIC8vIFdlIGZpeCBtaXAwIHRvIDEyOHgxMjgsIHNvIGNvZGUgaXMgcmF0aGVyIHN0YXRpYy5cXG4gICAgLy8gTWlwcyBzbWFsbGVyIHRoYW4gNHg0IGFyZW4ndCBncmVhdCBldmVuIGZvciBkaWZmdXNlLiBEb24ndCBmb3JnZXQgdGhhdCB3ZSBkb24ndCBoYXZlIGJpbGluZWFyIGZpbHRlcmluZyBiZXR3ZWVuIGRpZmZlcmVudCBmYWNlcy5cXG4gICAgZmxvYXQgYmlhcyA9IHNhdHVyYXRlKDEuMCAtIGRHbG9zc2luZXNzKSAqIDUuMDsgLy8gbXVsdGlwbHkgYnkgbWF4IG1pcCBsZXZlbFxcbiAgICBpbnQgaW5kZXgxID0gaW50KGJpYXMpO1xcbiAgICBpbnQgaW5kZXgyID0gaW50KG1pbihiaWFzICsgMS4wLCA3LjApKTtcXG4gICAgdmVjMyBmaXhlZFJlZmxEaXIgPSBmaXhTZWFtcyhjdWJlTWFwUHJvamVjdChkUmVmbERpclcpLCBiaWFzKTtcXG4gICAgZml4ZWRSZWZsRGlyLnggKj0gLTEuMDtcXG4gICAgdmVjNCBjdWJlc1s2XTtcXG4gICAgY3ViZXNbMF0gPSB0ZXh0dXJlQ3ViZSh0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDEyOCwgZml4ZWRSZWZsRGlyKTtcXG4gICAgY3ViZXNbMV0gPSB0ZXh0dXJlQ3ViZSh0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDY0LCBmaXhlZFJlZmxEaXIpO1xcbiAgICBjdWJlc1syXSA9IHRleHR1cmVDdWJlKHRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMzIsIGZpeGVkUmVmbERpcik7XFxuICAgIGN1YmVzWzNdID0gdGV4dHVyZUN1YmUodGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAxNiwgZml4ZWRSZWZsRGlyKTtcXG4gICAgY3ViZXNbNF0gPSB0ZXh0dXJlQ3ViZSh0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDgsIGZpeGVkUmVmbERpcik7XFxuICAgIGN1YmVzWzVdID0gdGV4dHVyZUN1YmUodGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXA0LCBmaXhlZFJlZmxEaXIpO1xcbiAgICAvLyBBbHNvIHdlIGRvbid0IGhhdmUgZHluYW1pYyBpbmRleGluZyBpbiBQUywgc28uLi5cXG4gICAgdmVjNCBjdWJlWzJdO1xcbiAgICBmb3IoaW50IGkgPSAwOyBpIDwgNjsgaSsrKSB7XFxuICAgICAgICBpZiAoaSA9PSBpbmRleDEpIHtcXG4gICAgICAgICAgICBjdWJlWzBdID0gY3ViZXNbaV07XFxuICAgICAgICB9XFxuICAgICAgICBpZiAoaSA9PSBpbmRleDIpIHtcXG4gICAgICAgICAgICBjdWJlWzFdID0gY3ViZXNbaV07XFxuICAgICAgICB9XFxuICAgIH1cXG4gICAgLy8gYW5vdGhlciB2YXJpYW50XFxuICAgIC8qaWYgKGluZGV4MT09MCl7IGN1YmVbMF09Y3ViZXNbMF07XFxuICAgIH1lbHNlIGlmIChpbmRleDE9PTEpeyBjdWJlWzBdPWN1YmVzWzFdO1xcbiAgICB9ZWxzZSBpZiAoaW5kZXgxPT0yKXsgY3ViZVswXT1jdWJlc1syXTtcXG4gICAgfWVsc2UgaWYgKGluZGV4MT09Myl7IGN1YmVbMF09Y3ViZXNbM107XFxuICAgIH1lbHNlIGlmIChpbmRleDE9PTQpeyBjdWJlWzBdPWN1YmVzWzRdO1xcbiAgICB9ZWxzZSBpZiAoaW5kZXgxPT01KXsgY3ViZVswXT1jdWJlc1s1XTt9XFxuICAgIGlmIChpbmRleDI9PTApeyBjdWJlWzFdPWN1YmVzWzBdO1xcbiAgICB9ZWxzZSBpZiAoaW5kZXgyPT0xKXsgY3ViZVsxXT1jdWJlc1sxXTtcXG4gICAgfWVsc2UgaWYgKGluZGV4Mj09Mil7IGN1YmVbMV09Y3ViZXNbMl07XFxuICAgIH1lbHNlIGlmIChpbmRleDI9PTMpeyBjdWJlWzFdPWN1YmVzWzNdO1xcbiAgICB9ZWxzZSBpZiAoaW5kZXgyPT00KXsgY3ViZVsxXT1jdWJlc1s0XTtcXG4gICAgfWVsc2UgaWYgKGluZGV4Mj09NSl7IGN1YmVbMV09Y3ViZXNbNV07fSovXFxuICAgIHZlYzQgY3ViZUZpbmFsID0gbWl4KGN1YmVbMF0sIGN1YmVbMV0sIGZyYWN0KGJpYXMpKTtcXG4gICAgdmVjMyByZWZsID0gcHJvY2Vzc0Vudmlyb25tZW50KCRERUNPREUoY3ViZUZpbmFsKS5yZ2IpO1xcbiAgICBkUmVmbGVjdGlvbiArPSB2ZWM0KHJlZmwsIG1hdGVyaWFsX3JlZmxlY3Rpdml0eSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnJlZmxlY3Rpb25QcmVmaWx0ZXJlZEN1YmVMb2RQUyA9IFwiI2V4dGVuc2lvbiBHTF9FWFRfc2hhZGVyX3RleHR1cmVfbG9kIDogZW5hYmxlXFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDEyODtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3JlZmxlY3Rpdml0eTtcXG52b2lkIGFkZFJlZmxlY3Rpb24oKSB7XFxuICAgIGZsb2F0IGJpYXMgPSBzYXR1cmF0ZSgxLjAgLSBkR2xvc3NpbmVzcykgKiA1LjA7IC8vIG11bHRpcGx5IGJ5IG1heCBtaXAgbGV2ZWxcXG4gICAgdmVjMyBmaXhlZFJlZmxEaXIgPSBmaXhTZWFtcyhjdWJlTWFwUHJvamVjdChkUmVmbERpclcpLCBiaWFzKTtcXG4gICAgZml4ZWRSZWZsRGlyLnggKj0gLTEuMDtcXG4gICAgdmVjMyByZWZsID0gcHJvY2Vzc0Vudmlyb25tZW50KCRERUNPREUoIHRleHR1cmVDdWJlTG9kRVhUKHRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTI4LCBmaXhlZFJlZmxEaXIsIGJpYXMpICkucmdiKTtcXG4gICAgZFJlZmxlY3Rpb24gKz0gdmVjNChyZWZsLCBtYXRlcmlhbF9yZWZsZWN0aXZpdHkpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5yZWZsZWN0aW9uU3BoZXJlUFMgPSBcInVuaWZvcm0gbWF0NCBtYXRyaXhfdmlldztcXG51bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX3NwaGVyZU1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3JlZmxlY3Rpdml0eTtcXG52b2lkIGFkZFJlZmxlY3Rpb24oKSB7XFxuICAgIHZlYzMgcmVmbERpclYgPSAobWF0MyhtYXRyaXhfdmlldykgKiBkUmVmbERpclcpLnh5ejtcXG4gICAgZmxvYXQgbSA9IDIuMCAqIHNxcnQoIGRvdChyZWZsRGlyVi54eSwgcmVmbERpclYueHkpICsgKHJlZmxEaXJWLnorMS4wKSoocmVmbERpclYueisxLjApICk7XFxuICAgIHZlYzIgc3BoZXJlTWFwVXYgPSByZWZsRGlyVi54eSAvIG0gKyAwLjU7XFxuICAgIGRSZWZsZWN0aW9uICs9IHZlYzQoJHRleHR1cmUyRFNBTVBMRSh0ZXh0dXJlX3NwaGVyZU1hcCwgc3BoZXJlTWFwVXYpLnJnYiwgbWF0ZXJpYWxfcmVmbGVjdGl2aXR5KTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucmVmbGVjdGlvblNwaGVyZUxvd1BTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX3NwaGVyZU1hcDtcXG51bmlmb3JtIGZsb2F0IG1hdGVyaWFsX3JlZmxlY3Rpdml0eTtcXG52b2lkIGFkZFJlZmxlY3Rpb24oKSB7XFxuICAgIHZlYzMgcmVmbERpclYgPSB2Tm9ybWFsVjtcXG4gICAgdmVjMiBzcGhlcmVNYXBVdiA9IHJlZmxEaXJWLnh5ICogMC41ICsgMC41O1xcbiAgICBkUmVmbGVjdGlvbiArPSB2ZWM0KCR0ZXh0dXJlMkRTQU1QTEUodGV4dHVyZV9zcGhlcmVNYXAsIHNwaGVyZU1hcFV2KS5yZ2IsIG1hdGVyaWFsX3JlZmxlY3Rpdml0eSk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnJlZnJhY3Rpb25QUyA9IFwidW5pZm9ybSBmbG9hdCBtYXRlcmlhbF9yZWZyYWN0aW9uLCBtYXRlcmlhbF9yZWZyYWN0aW9uSW5kZXg7XFxudmVjMyByZWZyYWN0Mih2ZWMzIHZpZXdWZWMsIHZlYzMgTm9ybWFsLCBmbG9hdCBJT1IpIHtcXG4gICAgZmxvYXQgdm4gPSBkb3Qodmlld1ZlYywgTm9ybWFsKTtcXG4gICAgZmxvYXQgayA9IDEuMCAtIElPUiAqIElPUiAqICgxLjAgLSB2biAqIHZuKTtcXG4gICAgdmVjMyByZWZyVmVjID0gSU9SICogdmlld1ZlYyAtIChJT1IgKiB2biArIHNxcnQoaykpICogTm9ybWFsO1xcbiAgICByZXR1cm4gcmVmclZlYztcXG59XFxudm9pZCBhZGRSZWZyYWN0aW9uKCkge1xcbiAgICAvLyB1c2Ugc2FtZSByZWZsZWN0aW9uIGNvZGUgd2l0aCByZWZyYWN0aW9uIHZlY3RvclxcbiAgICB2ZWMzIHRtcCA9IGRSZWZsRGlyVztcXG4gICAgdmVjNCB0bXAyID0gZFJlZmxlY3Rpb247XFxuICAgIGRSZWZsZWN0aW9uID0gdmVjNCgwLjApO1xcbiAgICBkUmVmbERpclcgPSByZWZyYWN0MigtZFZpZXdEaXJXLCBkTm9ybWFsVywgbWF0ZXJpYWxfcmVmcmFjdGlvbkluZGV4KTtcXG4gICAgYWRkUmVmbGVjdGlvbigpO1xcbiAgICBkRGlmZnVzZUxpZ2h0ID0gbWl4KGREaWZmdXNlTGlnaHQsIGRSZWZsZWN0aW9uLnJnYiAqIGRBbGJlZG8sIG1hdGVyaWFsX3JlZnJhY3Rpb24pO1xcbiAgICBkUmVmbERpclcgPSB0bXA7XFxuICAgIGRSZWZsZWN0aW9uID0gdG1wMjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MucmdibVBTID0gXCJ2ZWMzIGRlY29kZVJHQk0odmVjNCByZ2JtKSB7XFxuICAgIHZlYzMgY29sb3IgPSAoOC4wICogcmdibS5hKSAqIHJnYm0ucmdiO1xcbiAgICByZXR1cm4gY29sb3IgKiBjb2xvcjtcXG59XFxudmVjMyB0ZXh0dXJlMkRSR0JNKHNhbXBsZXIyRCB0ZXgsIHZlYzIgdXYpIHtcXG4gICAgcmV0dXJuIGRlY29kZVJHQk0odGV4dHVyZTJEKHRleCwgdXYpKTtcXG59XFxudmVjMyB0ZXh0dXJlQ3ViZVJHQk0oc2FtcGxlckN1YmUgdGV4LCB2ZWMzIHV2dykge1xcbiAgICByZXR1cm4gZGVjb2RlUkdCTSh0ZXh0dXJlQ3ViZSh0ZXgsIHV2dykpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zaGFkb3dDb21tb25QUyA9IFwidm9pZCBub3JtYWxPZmZzZXRQb2ludFNoYWRvdyh2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICBmbG9hdCBkaXN0U2NhbGUgPSBsZW5ndGgoZExpZ2h0RGlyVyk7XFxuICAgIHZlYzMgd1BvcyA9IHZQb3NpdGlvblcgKyBkVmVydGV4Tm9ybWFsVyAqIHNoYWRvd1BhcmFtcy55ICogY2xhbXAoMS4wIC0gZG90KGRWZXJ0ZXhOb3JtYWxXLCAtZExpZ2h0RGlyTm9ybVcpLCAwLjAsIDEuMCkgKiBkaXN0U2NhbGU7IC8vMC4wMlxcbiAgICB2ZWMzIGRpciA9IHdQb3MgLSBkTGlnaHRQb3NXO1xcbiAgICBkTGlnaHREaXJXID0gZGlyO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zaGFkb3dDb29yZFBTID0gXCJ2b2lkIF9nZXRTaGFkb3dDb29yZE9ydGhvKG1hdDQgc2hhZG93TWF0cml4LCB2ZWMzIHNoYWRvd1BhcmFtcywgdmVjMyB3UG9zKSB7XFxuICAgIGRTaGFkb3dDb29yZCA9IChzaGFkb3dNYXRyaXggKiB2ZWM0KHdQb3MsIDEuMCkpLnh5ejtcXG4gICAgZFNoYWRvd0Nvb3JkLnogPSBzYXR1cmF0ZShkU2hhZG93Q29vcmQueikgLSAwLjAwMDE7XFxuICAgICNpZmRlZiBTSEFET1dCSUFTXFxuICAgICAgICBkU2hhZG93Q29vcmQueiArPSBnZXRTaGFkb3dCaWFzKHNoYWRvd1BhcmFtcy54LCBzaGFkb3dQYXJhbXMueik7XFxuICAgICNlbmRpZlxcbn1cXG52b2lkIF9nZXRTaGFkb3dDb29yZFBlcnNwKG1hdDQgc2hhZG93TWF0cml4LCB2ZWM0IHNoYWRvd1BhcmFtcywgdmVjMyB3UG9zKSB7XFxuICAgIHZlYzQgcHJvalBvcyA9IHNoYWRvd01hdHJpeCAqIHZlYzQod1BvcywgMS4wKTtcXG4gICAgcHJvalBvcy54eSAvPSBwcm9qUG9zLnc7XFxuICAgIGRTaGFkb3dDb29yZC54eSA9IHByb2pQb3MueHk7XFxuICAgIGRTaGFkb3dDb29yZC56ID0gbGVuZ3RoKGRMaWdodERpclcpICogc2hhZG93UGFyYW1zLnc7XFxuICAgICNpZmRlZiBTSEFET1dCSUFTXFxuICAgICAgICBkU2hhZG93Q29vcmQueiArPSBnZXRTaGFkb3dCaWFzKHNoYWRvd1BhcmFtcy54LCBzaGFkb3dQYXJhbXMueik7XFxuICAgICNlbmRpZlxcbn1cXG52b2lkIGdldFNoYWRvd0Nvb3JkT3J0aG8obWF0NCBzaGFkb3dNYXRyaXgsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgIF9nZXRTaGFkb3dDb29yZE9ydGhvKHNoYWRvd01hdHJpeCwgc2hhZG93UGFyYW1zLCB2UG9zaXRpb25XKTtcXG59XFxudm9pZCBnZXRTaGFkb3dDb29yZFBlcnNwKG1hdDQgc2hhZG93TWF0cml4LCB2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICBfZ2V0U2hhZG93Q29vcmRQZXJzcChzaGFkb3dNYXRyaXgsIHNoYWRvd1BhcmFtcywgdlBvc2l0aW9uVyk7XFxufVxcbnZvaWQgZ2V0U2hhZG93Q29vcmRQZXJzcE5vcm1hbE9mZnNldChtYXQ0IHNoYWRvd01hdHJpeCwgdmVjNCBzaGFkb3dQYXJhbXMpIHtcXG4gICAgZmxvYXQgZGlzdFNjYWxlID0gYWJzKGRvdCh2UG9zaXRpb25XIC0gZExpZ2h0UG9zVywgZExpZ2h0RGlyTm9ybVcpKTsgLy8gZm92P1xcbiAgICB2ZWMzIHdQb3MgPSB2UG9zaXRpb25XICsgZFZlcnRleE5vcm1hbFcgKiBzaGFkb3dQYXJhbXMueSAqIGNsYW1wKDEuMCAtIGRvdChkVmVydGV4Tm9ybWFsVywgLWRMaWdodERpck5vcm1XKSwgMC4wLCAxLjApICogZGlzdFNjYWxlO1xcbiAgICBfZ2V0U2hhZG93Q29vcmRQZXJzcChzaGFkb3dNYXRyaXgsIHNoYWRvd1BhcmFtcywgd1Bvcyk7XFxufVxcbnZvaWQgZ2V0U2hhZG93Q29vcmRPcnRob05vcm1hbE9mZnNldChtYXQ0IHNoYWRvd01hdHJpeCwgdmVjMyBzaGFkb3dQYXJhbXMpIHtcXG4gICAgdmVjMyB3UG9zID0gdlBvc2l0aW9uVyArIGRWZXJ0ZXhOb3JtYWxXICogc2hhZG93UGFyYW1zLnkgKiBjbGFtcCgxLjAgLSBkb3QoZFZlcnRleE5vcm1hbFcsIC1kTGlnaHREaXJOb3JtVyksIDAuMCwgMS4wKTsgLy8wLjA4XFxuICAgIF9nZXRTaGFkb3dDb29yZE9ydGhvKHNoYWRvd01hdHJpeCwgc2hhZG93UGFyYW1zLCB3UG9zKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93Q29vcmRWUyA9IFwidm9pZCBnZXRMaWdodERpclBvaW50KHZlYzMgbGlnaHRQb3NXKSB7XFxuICAgIHZlYzMgbGlnaHREaXJXID0gdlBvc2l0aW9uVyAtIGxpZ2h0UG9zVztcXG4gICAgZExpZ2h0RGlyTm9ybVcgPSBub3JtYWxpemUobGlnaHREaXJXKTtcXG4gICAgZExpZ2h0UG9zVyA9IGxpZ2h0UG9zVztcXG59XFxudm9pZCBfZ2V0U2hhZG93Q29vcmRPcnRobyhtYXQ0IHNoYWRvd01hdHJpeCwgdmVjMyBzaGFkb3dQYXJhbXMsIHZlYzMgd1Bvcykge1xcbiAgICB2ZWM0IHByb2pQb3MgPSBzaGFkb3dNYXRyaXggKiB2ZWM0KHdQb3MsIDEuMCk7XFxuICAgIHZNYWluU2hhZG93VXYgPSBwcm9qUG9zO1xcbn1cXG52b2lkIF9nZXRTaGFkb3dDb29yZFBlcnNwKG1hdDQgc2hhZG93TWF0cml4LCB2ZWMzIHNoYWRvd1BhcmFtcywgdmVjMyB3UG9zKSB7XFxuICAgIHZlYzQgcHJvalBvcyA9IHNoYWRvd01hdHJpeCAqIHZlYzQod1BvcywgMS4wKTtcXG4gICAgdk1haW5TaGFkb3dVdiA9IHByb2pQb3M7XFxufVxcbnZvaWQgZ2V0U2hhZG93Q29vcmRPcnRobyhtYXQ0IHNoYWRvd01hdHJpeCwgdmVjMyBzaGFkb3dQYXJhbXMpIHtcXG4gICAgX2dldFNoYWRvd0Nvb3JkT3J0aG8oc2hhZG93TWF0cml4LCBzaGFkb3dQYXJhbXMsIHZQb3NpdGlvblcpO1xcbn1cXG52b2lkIGdldFNoYWRvd0Nvb3JkUGVyc3AobWF0NCBzaGFkb3dNYXRyaXgsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgIF9nZXRTaGFkb3dDb29yZFBlcnNwKHNoYWRvd01hdHJpeCwgc2hhZG93UGFyYW1zLCB2UG9zaXRpb25XKTtcXG59XFxudm9pZCBnZXRTaGFkb3dDb29yZFBlcnNwTm9ybWFsT2Zmc2V0KG1hdDQgc2hhZG93TWF0cml4LCB2ZWMzIHNoYWRvd1BhcmFtcykge1xcbiAgICBmbG9hdCBkaXN0U2NhbGUgPSBhYnMoZG90KHZQb3NpdGlvblcgLSBkTGlnaHRQb3NXLCBkTGlnaHREaXJOb3JtVykpOyAvLyBmb3Y/XFxuICAgIHZlYzMgd1BvcyA9IHZQb3NpdGlvblcgKyBkTm9ybWFsVyAqIHNoYWRvd1BhcmFtcy55ICogY2xhbXAoMS4wIC0gZG90KGROb3JtYWxXLCAtZExpZ2h0RGlyTm9ybVcpLCAwLjAsIDEuMCkgKiBkaXN0U2NhbGU7XFxuICAgIF9nZXRTaGFkb3dDb29yZFBlcnNwKHNoYWRvd01hdHJpeCwgc2hhZG93UGFyYW1zLCB3UG9zKTtcXG59XFxudm9pZCBnZXRTaGFkb3dDb29yZE9ydGhvTm9ybWFsT2Zmc2V0KG1hdDQgc2hhZG93TWF0cml4LCB2ZWMzIHNoYWRvd1BhcmFtcykge1xcbiAgICB2ZWMzIHdQb3MgPSB2UG9zaXRpb25XICsgZE5vcm1hbFcgKiBzaGFkb3dQYXJhbXMueSAqIGNsYW1wKDEuMCAtIGRvdChkTm9ybWFsVywgLWRMaWdodERpck5vcm1XKSwgMC4wLCAxLjApOyAvLzAuMDhcXG4gICAgX2dldFNoYWRvd0Nvb3JkT3J0aG8oc2hhZG93TWF0cml4LCBzaGFkb3dQYXJhbXMsIHdQb3MpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zaGFkb3dDb29yZFBlcnNwWmJ1ZmZlclBTID0gXCJ2b2lkIF9nZXRTaGFkb3dDb29yZFBlcnNwWmJ1ZmZlcihtYXQ0IHNoYWRvd01hdHJpeCwgdmVjNCBzaGFkb3dQYXJhbXMsIHZlYzMgd1Bvcykge1xcbiAgICB2ZWM0IHByb2pQb3MgPSBzaGFkb3dNYXRyaXggKiB2ZWM0KHdQb3MsIDEuMCk7XFxuICAgIHByb2pQb3MueHl6IC89IHByb2pQb3MudztcXG4gICAgZFNoYWRvd0Nvb3JkID0gcHJvalBvcy54eXo7XFxuICAgIC8vIGRlcHRoIGJpYXMgaXMgYWxyZWFkeSBhcHBsaWVkIG9uIHJlbmRlclxcbn1cXG52b2lkIGdldFNoYWRvd0Nvb3JkUGVyc3BaYnVmZmVyTm9ybWFsT2Zmc2V0KG1hdDQgc2hhZG93TWF0cml4LCB2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICBmbG9hdCBkaXN0U2NhbGUgPSBhYnMoZG90KHZQb3NpdGlvblcgLSBkTGlnaHRQb3NXLCBkTGlnaHREaXJOb3JtVykpOyAvLyBmb3Y/XFxuICAgIHZlYzMgd1BvcyA9IHZQb3NpdGlvblcgKyBkVmVydGV4Tm9ybWFsVyAqIHNoYWRvd1BhcmFtcy55ICogY2xhbXAoMS4wIC0gZG90KGRWZXJ0ZXhOb3JtYWxXLCAtZExpZ2h0RGlyTm9ybVcpLCAwLjAsIDEuMCkgKiBkaXN0U2NhbGU7XFxuICAgIF9nZXRTaGFkb3dDb29yZFBlcnNwWmJ1ZmZlcihzaGFkb3dNYXRyaXgsIHNoYWRvd1BhcmFtcywgd1Bvcyk7XFxufVxcbnZvaWQgZ2V0U2hhZG93Q29vcmRQZXJzcFpidWZmZXIobWF0NCBzaGFkb3dNYXRyaXgsIHZlYzQgc2hhZG93UGFyYW1zKSB7XFxuICAgIF9nZXRTaGFkb3dDb29yZFBlcnNwWmJ1ZmZlcihzaGFkb3dNYXRyaXgsIHNoYWRvd1BhcmFtcywgdlBvc2l0aW9uVyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNoYWRvd0VWU01QUyA9IFwiZmxvYXQgVlNNJChzYW1wbGVyMkQgdGV4LCB2ZWMyIHRleENvb3JkcywgZmxvYXQgcmVzb2x1dGlvbiwgZmxvYXQgWiwgZmxvYXQgdnNtQmlhcywgZmxvYXQgZXhwb25lbnQpIHtcXG4gICAgdmVjMyBtb21lbnRzID0gdGV4dHVyZTJEKHRleCwgdGV4Q29vcmRzKS54eXo7XFxuICAgIHJldHVybiBjYWxjdWxhdGVFVlNNKG1vbWVudHMsIFosIHZzbUJpYXMsIGV4cG9uZW50KTtcXG59XFxuZmxvYXQgZ2V0U2hhZG93VlNNJChzYW1wbGVyMkQgc2hhZG93TWFwLCB2ZWMzIHNoYWRvd1BhcmFtcywgZmxvYXQgZXhwb25lbnQpIHtcXG4gICAgcmV0dXJuIFZTTSQoc2hhZG93TWFwLCBkU2hhZG93Q29vcmQueHksIHNoYWRvd1BhcmFtcy54LCBkU2hhZG93Q29vcmQueiwgc2hhZG93UGFyYW1zLnksIGV4cG9uZW50KTtcXG59XFxuZmxvYXQgZ2V0U2hhZG93U3BvdFZTTSQoc2FtcGxlcjJEIHNoYWRvd01hcCwgdmVjNCBzaGFkb3dQYXJhbXMsIGZsb2F0IGV4cG9uZW50KSB7XFxuICAgIHJldHVybiBWU00kKHNoYWRvd01hcCwgZFNoYWRvd0Nvb3JkLnh5LCBzaGFkb3dQYXJhbXMueCwgbGVuZ3RoKGRMaWdodERpclcpICogc2hhZG93UGFyYW1zLncgKyBzaGFkb3dQYXJhbXMueiwgc2hhZG93UGFyYW1zLnksIGV4cG9uZW50KTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93RVZTTW5QUyA9IFwiZmxvYXQgVlNNJChzYW1wbGVyMkQgdGV4LCB2ZWMyIHRleENvb3JkcywgZmxvYXQgcmVzb2x1dGlvbiwgZmxvYXQgWiwgZmxvYXQgdnNtQmlhcywgZmxvYXQgZXhwb25lbnQpIHtcXG4gICAgZmxvYXQgcGl4ZWxTaXplID0gMS4wIC8gcmVzb2x1dGlvbjtcXG4gICAgdGV4Q29vcmRzIC09IHZlYzIocGl4ZWxTaXplKTtcXG4gICAgdmVjMyBzMDAgPSB0ZXh0dXJlMkQodGV4LCB0ZXhDb29yZHMpLnh5ejtcXG4gICAgdmVjMyBzMTAgPSB0ZXh0dXJlMkQodGV4LCB0ZXhDb29yZHMgKyB2ZWMyKHBpeGVsU2l6ZSwgMCkpLnh5ejtcXG4gICAgdmVjMyBzMDEgPSB0ZXh0dXJlMkQodGV4LCB0ZXhDb29yZHMgKyB2ZWMyKDAsIHBpeGVsU2l6ZSkpLnh5ejtcXG4gICAgdmVjMyBzMTEgPSB0ZXh0dXJlMkQodGV4LCB0ZXhDb29yZHMgKyB2ZWMyKHBpeGVsU2l6ZSkpLnh5ejtcXG4gICAgdmVjMiBmciA9IGZyYWN0KHRleENvb3JkcyAqIHJlc29sdXRpb24pO1xcbiAgICB2ZWMzIGgwID0gbWl4KHMwMCwgczEwLCBmci54KTtcXG4gICAgdmVjMyBoMSA9IG1peChzMDEsIHMxMSwgZnIueCk7XFxuICAgIHZlYzMgbW9tZW50cyA9IG1peChoMCwgaDEsIGZyLnkpO1xcbiAgICByZXR1cm4gY2FsY3VsYXRlRVZTTShtb21lbnRzLCBaLCB2c21CaWFzLCBleHBvbmVudCk7XFxufVxcbmZsb2F0IGdldFNoYWRvd1ZTTSQoc2FtcGxlcjJEIHNoYWRvd01hcCwgdmVjMyBzaGFkb3dQYXJhbXMsIGZsb2F0IGV4cG9uZW50KSB7XFxuICAgIHJldHVybiBWU00kKHNoYWRvd01hcCwgZFNoYWRvd0Nvb3JkLnh5LCBzaGFkb3dQYXJhbXMueCwgZFNoYWRvd0Nvb3JkLnosIHNoYWRvd1BhcmFtcy55LCBleHBvbmVudCk7XFxufVxcbmZsb2F0IGdldFNoYWRvd1Nwb3RWU00kKHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzQgc2hhZG93UGFyYW1zLCBmbG9hdCBleHBvbmVudCkge1xcbiAgICByZXR1cm4gVlNNJChzaGFkb3dNYXAsIGRTaGFkb3dDb29yZC54eSwgc2hhZG93UGFyYW1zLngsIGxlbmd0aChkTGlnaHREaXJXKSAqIHNoYWRvd1BhcmFtcy53ICsgc2hhZG93UGFyYW1zLnosIHNoYWRvd1BhcmFtcy55LCBleHBvbmVudCk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNoYWRvd1N0YW5kYXJkUFMgPSBcInZlYzMgbGVzc1RoYW4yKHZlYzMgYSwgdmVjMyBiKSB7XFxuICAgIHJldHVybiBjbGFtcCgoYiAtIGEpKjEwMDAuMCwgMC4wLCAxLjApOyAvLyBzb2Z0ZXIgdmVyc2lvblxcbn1cXG5mbG9hdCB1bnBhY2tGbG9hdCh2ZWM0IHJnYmFEZXB0aCkge1xcbiAgICBjb25zdCB2ZWM0IGJpdFNoaWZ0ID0gdmVjNCgxLjAgLyAoMjU2LjAgKiAyNTYuMCAqIDI1Ni4wKSwgMS4wIC8gKDI1Ni4wICogMjU2LjApLCAxLjAgLyAyNTYuMCwgMS4wKTtcXG4gICAgcmV0dXJuIGRvdChyZ2JhRGVwdGgsIGJpdFNoaWZ0KTtcXG59XFxuLy8gLS0tLS0gRGlyZWN0L1Nwb3QgU2FtcGxpbmcgLS0tLS1cXG4jaWZkZWYgR0wyXFxuICAgIGZsb2F0IF9nZXRTaGFkb3dQQ0YzeDMoc2FtcGxlcjJEU2hhZG93IHNoYWRvd01hcCwgdmVjMyBzaGFkb3dQYXJhbXMpIHtcXG4gICAgICAgIGZsb2F0IHogPSBkU2hhZG93Q29vcmQuejtcXG4gICAgICAgIHZlYzIgdXYgPSBkU2hhZG93Q29vcmQueHkgKiBzaGFkb3dQYXJhbXMueDsgLy8gMSB1bml0IC0gMSB0ZXhlbFxcbiAgICAgICAgZmxvYXQgc2hhZG93TWFwU2l6ZUludiA9IDEuMCAvIHNoYWRvd1BhcmFtcy54O1xcbiAgICAgICAgdmVjMiBiYXNlX3V2ID0gZmxvb3IodXYgKyAwLjUpO1xcbiAgICAgICAgZmxvYXQgcyA9ICh1di54ICsgMC41IC0gYmFzZV91di54KTtcXG4gICAgICAgIGZsb2F0IHQgPSAodXYueSArIDAuNSAtIGJhc2VfdXYueSk7XFxuICAgICAgICBiYXNlX3V2IC09IHZlYzIoMC41KTtcXG4gICAgICAgIGJhc2VfdXYgKj0gc2hhZG93TWFwU2l6ZUludjtcXG4gICAgICAgIGZsb2F0IHN1bSA9IDAuMDtcXG4gICAgICAgIGZsb2F0IHV3MCA9ICgzLjAgLSAyLjAgKiBzKTtcXG4gICAgICAgIGZsb2F0IHV3MSA9ICgxLjAgKyAyLjAgKiBzKTtcXG4gICAgICAgIGZsb2F0IHUwID0gKDIuMCAtIHMpIC8gdXcwIC0gMS4wO1xcbiAgICAgICAgZmxvYXQgdTEgPSBzIC8gdXcxICsgMS4wO1xcbiAgICAgICAgZmxvYXQgdncwID0gKDMuMCAtIDIuMCAqIHQpO1xcbiAgICAgICAgZmxvYXQgdncxID0gKDEuMCArIDIuMCAqIHQpO1xcbiAgICAgICAgZmxvYXQgdjAgPSAoMi4wIC0gdCkgLyB2dzAgLSAxLjA7XFxuICAgICAgICBmbG9hdCB2MSA9IHQgLyB2dzEgKyAxLjA7XFxuICAgICAgICB1MCA9IHUwICogc2hhZG93TWFwU2l6ZUludiArIGJhc2VfdXYueDtcXG4gICAgICAgIHYwID0gdjAgKiBzaGFkb3dNYXBTaXplSW52ICsgYmFzZV91di55O1xcbiAgICAgICAgdTEgPSB1MSAqIHNoYWRvd01hcFNpemVJbnYgKyBiYXNlX3V2Lng7XFxuICAgICAgICB2MSA9IHYxICogc2hhZG93TWFwU2l6ZUludiArIGJhc2VfdXYueTtcXG4gICAgICAgIHN1bSArPSB1dzAgKiB2dzAgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MCwgdjAsIHopKTtcXG4gICAgICAgIHN1bSArPSB1dzEgKiB2dzAgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MSwgdjAsIHopKTtcXG4gICAgICAgIHN1bSArPSB1dzAgKiB2dzEgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MCwgdjEsIHopKTtcXG4gICAgICAgIHN1bSArPSB1dzEgKiB2dzEgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MSwgdjEsIHopKTtcXG4gICAgICAgIHN1bSAqPSAxLjBmIC8gMTYuMDtcXG4gICAgICAgIHJldHVybiBzdW07XFxuICAgIH1cXG4gICAgZmxvYXQgZ2V0U2hhZG93UENGM3gzKHNhbXBsZXIyRFNoYWRvdyBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgICAgICByZXR1cm4gX2dldFNoYWRvd1BDRjN4MyhzaGFkb3dNYXAsIHNoYWRvd1BhcmFtcyk7XFxuICAgIH1cXG4gICAgZmxvYXQgZ2V0U2hhZG93U3BvdFBDRjN4MyhzYW1wbGVyMkRTaGFkb3cgc2hhZG93TWFwLCB2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICAgICAgcmV0dXJuIF9nZXRTaGFkb3dQQ0YzeDMoc2hhZG93TWFwLCBzaGFkb3dQYXJhbXMueHl6KTtcXG4gICAgfVxcbiNlbHNlXFxuICAgIGZsb2F0IF94Z2V0U2hhZG93UENGM3gzKG1hdDMgZGVwdGhLZXJuZWwsIHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgICAgICBtYXQzIHNoYWRvd0tlcm5lbDtcXG4gICAgICAgIHZlYzMgc2hhZG93Q29vcmQgPSBkU2hhZG93Q29vcmQ7XFxuICAgICAgICB2ZWMzIHNoYWRvd1ogPSB2ZWMzKHNoYWRvd0Nvb3JkLnopO1xcbiAgICAgICAgc2hhZG93S2VybmVsWzBdID0gdmVjMyhncmVhdGVyVGhhbihkZXB0aEtlcm5lbFswXSwgc2hhZG93WikpO1xcbiAgICAgICAgc2hhZG93S2VybmVsWzFdID0gdmVjMyhncmVhdGVyVGhhbihkZXB0aEtlcm5lbFsxXSwgc2hhZG93WikpO1xcbiAgICAgICAgc2hhZG93S2VybmVsWzJdID0gdmVjMyhncmVhdGVyVGhhbihkZXB0aEtlcm5lbFsyXSwgc2hhZG93WikpO1xcbiAgICAgICAgdmVjMiBmcmFjdGlvbmFsQ29vcmQgPSBmcmFjdCggc2hhZG93Q29vcmQueHkgKiBzaGFkb3dQYXJhbXMueCApO1xcbiAgICAgICAgc2hhZG93S2VybmVsWzBdID0gbWl4KHNoYWRvd0tlcm5lbFswXSwgc2hhZG93S2VybmVsWzFdLCBmcmFjdGlvbmFsQ29vcmQueCk7XFxuICAgICAgICBzaGFkb3dLZXJuZWxbMV0gPSBtaXgoc2hhZG93S2VybmVsWzFdLCBzaGFkb3dLZXJuZWxbMl0sIGZyYWN0aW9uYWxDb29yZC54KTtcXG4gICAgICAgIHZlYzQgc2hhZG93VmFsdWVzO1xcbiAgICAgICAgc2hhZG93VmFsdWVzLnggPSBtaXgoc2hhZG93S2VybmVsWzBdWzBdLCBzaGFkb3dLZXJuZWxbMF1bMV0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgICAgIHNoYWRvd1ZhbHVlcy55ID0gbWl4KHNoYWRvd0tlcm5lbFswXVsxXSwgc2hhZG93S2VybmVsWzBdWzJdLCBmcmFjdGlvbmFsQ29vcmQueSk7XFxuICAgICAgICBzaGFkb3dWYWx1ZXMueiA9IG1peChzaGFkb3dLZXJuZWxbMV1bMF0sIHNoYWRvd0tlcm5lbFsxXVsxXSwgZnJhY3Rpb25hbENvb3JkLnkpO1xcbiAgICAgICAgc2hhZG93VmFsdWVzLncgPSBtaXgoc2hhZG93S2VybmVsWzFdWzFdLCBzaGFkb3dLZXJuZWxbMV1bMl0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgICAgIHJldHVybiBkb3QoIHNoYWRvd1ZhbHVlcywgdmVjNCggMS4wICkgKSAqIDAuMjU7XFxuICAgIH1cXG4gICAgZmxvYXQgX2dldFNoYWRvd1BDRjN4MyhzYW1wbGVyMkQgc2hhZG93TWFwLCB2ZWMzIHNoYWRvd1BhcmFtcykge1xcbiAgICAgICAgdmVjMyBzaGFkb3dDb29yZCA9IGRTaGFkb3dDb29yZDtcXG4gICAgICAgIGZsb2F0IHhvZmZzZXQgPSAxLjAgLyBzaGFkb3dQYXJhbXMueDsgLy8gMS9zaGFkb3cgbWFwIHdpZHRoXFxuICAgICAgICBmbG9hdCBkeDAgPSAteG9mZnNldDtcXG4gICAgICAgIGZsb2F0IGR4MSA9IHhvZmZzZXQ7XFxuICAgICAgICBtYXQzIGRlcHRoS2VybmVsO1xcbiAgICAgICAgZGVwdGhLZXJuZWxbMF1bMF0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlMkQoc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoZHgwLCBkeDApKSk7XFxuICAgICAgICBkZXB0aEtlcm5lbFswXVsxXSA9IHVucGFja0Zsb2F0KHRleHR1cmUyRChzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMihkeDAsIDAuMCkpKTtcXG4gICAgICAgIGRlcHRoS2VybmVsWzBdWzJdID0gdW5wYWNrRmxvYXQodGV4dHVyZTJEKHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKGR4MCwgZHgxKSkpO1xcbiAgICAgICAgZGVwdGhLZXJuZWxbMV1bMF0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlMkQoc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoMC4wLCBkeDApKSk7XFxuICAgICAgICBkZXB0aEtlcm5lbFsxXVsxXSA9IHVucGFja0Zsb2F0KHRleHR1cmUyRChzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5KSk7XFxuICAgICAgICBkZXB0aEtlcm5lbFsxXVsyXSA9IHVucGFja0Zsb2F0KHRleHR1cmUyRChzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMigwLjAsIGR4MSkpKTtcXG4gICAgICAgIGRlcHRoS2VybmVsWzJdWzBdID0gdW5wYWNrRmxvYXQodGV4dHVyZTJEKHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKGR4MSwgZHgwKSkpO1xcbiAgICAgICAgZGVwdGhLZXJuZWxbMl1bMV0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlMkQoc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoZHgxLCAwLjApKSk7XFxuICAgICAgICBkZXB0aEtlcm5lbFsyXVsyXSA9IHVucGFja0Zsb2F0KHRleHR1cmUyRChzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMihkeDEsIGR4MSkpKTtcXG4gICAgICAgIHJldHVybiBfeGdldFNoYWRvd1BDRjN4MyhkZXB0aEtlcm5lbCwgc2hhZG93TWFwLCBzaGFkb3dQYXJhbXMpO1xcbiAgICB9XFxuICAgIGZsb2F0IGdldFNoYWRvd1BDRjN4MyhzYW1wbGVyMkQgc2hhZG93TWFwLCB2ZWMzIHNoYWRvd1BhcmFtcykge1xcbiAgICAgICAgcmV0dXJuIF9nZXRTaGFkb3dQQ0YzeDMoc2hhZG93TWFwLCBzaGFkb3dQYXJhbXMpO1xcbiAgICB9XFxuICAgIGZsb2F0IGdldFNoYWRvd1Nwb3RQQ0YzeDMoc2FtcGxlcjJEIHNoYWRvd01hcCwgdmVjNCBzaGFkb3dQYXJhbXMpIHtcXG4gICAgICAgIHJldHVybiBfZ2V0U2hhZG93UENGM3gzKHNoYWRvd01hcCwgc2hhZG93UGFyYW1zLnh5eik7XFxuICAgIH1cXG4jZW5kaWZcXG4vLyAtLS0tLSBQb2ludCBTYW1wbGluZyAtLS0tLVxcbmZsb2F0IF9nZXRTaGFkb3dQb2ludChzYW1wbGVyQ3ViZSBzaGFkb3dNYXAsIHZlYzQgc2hhZG93UGFyYW1zLCB2ZWMzIGRpcikge1xcbiAgICB2ZWMzIHRjID0gbm9ybWFsaXplKGRpcik7XFxuICAgIHZlYzMgdGNBYnMgPSBhYnModGMpO1xcbiAgICB2ZWM0IGRpclggPSB2ZWM0KDEsMCwwLCB0Yy54KTtcXG4gICAgdmVjNCBkaXJZID0gdmVjNCgwLDEsMCwgdGMueSk7XFxuICAgIGZsb2F0IG1ham9yQXhpc0xlbmd0aCA9IHRjLno7XFxuICAgIGlmICgodGNBYnMueCA+IHRjQWJzLnkpICYmICh0Y0Ficy54ID4gdGNBYnMueikpIHtcXG4gICAgICAgIGRpclggPSB2ZWM0KDAsMCwxLCB0Yy56KTtcXG4gICAgICAgIGRpclkgPSB2ZWM0KDAsMSwwLCB0Yy55KTtcXG4gICAgICAgIG1ham9yQXhpc0xlbmd0aCA9IHRjLng7XFxuICAgIH0gZWxzZSBpZiAoKHRjQWJzLnkgPiB0Y0Ficy54KSAmJiAodGNBYnMueSA+IHRjQWJzLnopKSB7XFxuICAgICAgICBkaXJYID0gdmVjNCgxLDAsMCwgdGMueCk7XFxuICAgICAgICBkaXJZID0gdmVjNCgwLDAsMSwgdGMueik7XFxuICAgICAgICBtYWpvckF4aXNMZW5ndGggPSB0Yy55O1xcbiAgICB9XFxuICAgIGZsb2F0IHNoYWRvd1BhcmFtc0luRmFjZVNwYWNlID0gKCgxLjAvc2hhZG93UGFyYW1zLngpICogMi4wKSAqIGFicyhtYWpvckF4aXNMZW5ndGgpO1xcbiAgICB2ZWMzIHhvZmZzZXQgPSAoZGlyWC54eXogKiBzaGFkb3dQYXJhbXNJbkZhY2VTcGFjZSk7XFxuICAgIHZlYzMgeW9mZnNldCA9IChkaXJZLnh5eiAqIHNoYWRvd1BhcmFtc0luRmFjZVNwYWNlKTtcXG4gICAgdmVjMyBkeDAgPSAteG9mZnNldDtcXG4gICAgdmVjMyBkeTAgPSAteW9mZnNldDtcXG4gICAgdmVjMyBkeDEgPSB4b2Zmc2V0O1xcbiAgICB2ZWMzIGR5MSA9IHlvZmZzZXQ7XFxuICAgIG1hdDMgc2hhZG93S2VybmVsO1xcbiAgICBtYXQzIGRlcHRoS2VybmVsO1xcbiAgICBkZXB0aEtlcm5lbFswXVswXSA9IHVucGFja0Zsb2F0KHRleHR1cmVDdWJlKHNoYWRvd01hcCwgdGMgKyBkeDAgKyBkeTApKTtcXG4gICAgZGVwdGhLZXJuZWxbMF1bMV0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlQ3ViZShzaGFkb3dNYXAsIHRjICsgZHgwKSk7XFxuICAgIGRlcHRoS2VybmVsWzBdWzJdID0gdW5wYWNrRmxvYXQodGV4dHVyZUN1YmUoc2hhZG93TWFwLCB0YyArIGR4MCArIGR5MSkpO1xcbiAgICBkZXB0aEtlcm5lbFsxXVswXSA9IHVucGFja0Zsb2F0KHRleHR1cmVDdWJlKHNoYWRvd01hcCwgdGMgKyBkeTApKTtcXG4gICAgZGVwdGhLZXJuZWxbMV1bMV0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlQ3ViZShzaGFkb3dNYXAsIHRjKSk7XFxuICAgIGRlcHRoS2VybmVsWzFdWzJdID0gdW5wYWNrRmxvYXQodGV4dHVyZUN1YmUoc2hhZG93TWFwLCB0YyArIGR5MSkpO1xcbiAgICBkZXB0aEtlcm5lbFsyXVswXSA9IHVucGFja0Zsb2F0KHRleHR1cmVDdWJlKHNoYWRvd01hcCwgdGMgKyBkeDEgKyBkeTApKTtcXG4gICAgZGVwdGhLZXJuZWxbMl1bMV0gPSB1bnBhY2tGbG9hdCh0ZXh0dXJlQ3ViZShzaGFkb3dNYXAsIHRjICsgZHgxKSk7XFxuICAgIGRlcHRoS2VybmVsWzJdWzJdID0gdW5wYWNrRmxvYXQodGV4dHVyZUN1YmUoc2hhZG93TWFwLCB0YyArIGR4MSArIGR5MSkpO1xcbiAgICB2ZWMzIHNoYWRvd1ogPSB2ZWMzKGxlbmd0aChkaXIpICogc2hhZG93UGFyYW1zLncgKyBzaGFkb3dQYXJhbXMueik7XFxuICAgIHNoYWRvd0tlcm5lbFswXSA9IHZlYzMobGVzc1RoYW4yKGRlcHRoS2VybmVsWzBdLCBzaGFkb3daKSk7XFxuICAgIHNoYWRvd0tlcm5lbFsxXSA9IHZlYzMobGVzc1RoYW4yKGRlcHRoS2VybmVsWzFdLCBzaGFkb3daKSk7XFxuICAgIHNoYWRvd0tlcm5lbFsyXSA9IHZlYzMobGVzc1RoYW4yKGRlcHRoS2VybmVsWzJdLCBzaGFkb3daKSk7XFxuICAgIHZlYzIgdXYgPSAodmVjMihkaXJYLncsIGRpclkudykgLyBhYnMobWFqb3JBeGlzTGVuZ3RoKSkgKiAwLjU7XFxuICAgIHZlYzIgZnJhY3Rpb25hbENvb3JkID0gZnJhY3QoIHV2ICogc2hhZG93UGFyYW1zLnggKTtcXG4gICAgc2hhZG93S2VybmVsWzBdID0gbWl4KHNoYWRvd0tlcm5lbFswXSwgc2hhZG93S2VybmVsWzFdLCBmcmFjdGlvbmFsQ29vcmQueCk7XFxuICAgIHNoYWRvd0tlcm5lbFsxXSA9IG1peChzaGFkb3dLZXJuZWxbMV0sIHNoYWRvd0tlcm5lbFsyXSwgZnJhY3Rpb25hbENvb3JkLngpO1xcbiAgICB2ZWM0IHNoYWRvd1ZhbHVlcztcXG4gICAgc2hhZG93VmFsdWVzLnggPSBtaXgoc2hhZG93S2VybmVsWzBdWzBdLCBzaGFkb3dLZXJuZWxbMF1bMV0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgc2hhZG93VmFsdWVzLnkgPSBtaXgoc2hhZG93S2VybmVsWzBdWzFdLCBzaGFkb3dLZXJuZWxbMF1bMl0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgc2hhZG93VmFsdWVzLnogPSBtaXgoc2hhZG93S2VybmVsWzFdWzBdLCBzaGFkb3dLZXJuZWxbMV1bMV0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgc2hhZG93VmFsdWVzLncgPSBtaXgoc2hhZG93S2VybmVsWzFdWzFdLCBzaGFkb3dLZXJuZWxbMV1bMl0sIGZyYWN0aW9uYWxDb29yZC55KTtcXG4gICAgcmV0dXJuIDEuMCAtIGRvdCggc2hhZG93VmFsdWVzLCB2ZWM0KCAxLjAgKSApICogMC4yNTtcXG59XFxuZmxvYXQgZ2V0U2hhZG93UG9pbnRQQ0YzeDMoc2FtcGxlckN1YmUgc2hhZG93TWFwLCB2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICByZXR1cm4gX2dldFNoYWRvd1BvaW50KHNoYWRvd01hcCwgc2hhZG93UGFyYW1zLCBkTGlnaHREaXJXKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93U3RhbmRhcmRHTDJQUyA9IFwiZmxvYXQgX2dldFNoYWRvd1BDRjV4NShzYW1wbGVyMkRTaGFkb3cgc2hhZG93TWFwLCB2ZWMzIHNoYWRvd1BhcmFtcykge1xcbiAgICAvLyBodHRwOi8vdGhlLXdpdG5lc3MubmV0L25ld3MvMjAxMy8wOS9zaGFkb3ctbWFwcGluZy1zdW1tYXJ5LXBhcnQtMS9cXG4gICAgZmxvYXQgeiA9IGRTaGFkb3dDb29yZC56O1xcbiAgICB2ZWMyIHV2ID0gZFNoYWRvd0Nvb3JkLnh5ICogc2hhZG93UGFyYW1zLng7IC8vIDEgdW5pdCAtIDEgdGV4ZWxcXG4gICAgZmxvYXQgc2hhZG93TWFwU2l6ZUludiA9IDEuMCAvIHNoYWRvd1BhcmFtcy54O1xcbiAgICB2ZWMyIGJhc2VfdXYgPSBmbG9vcih1diArIDAuNSk7XFxuICAgIGZsb2F0IHMgPSAodXYueCArIDAuNSAtIGJhc2VfdXYueCk7XFxuICAgIGZsb2F0IHQgPSAodXYueSArIDAuNSAtIGJhc2VfdXYueSk7XFxuICAgIGJhc2VfdXYgLT0gdmVjMigwLjUpO1xcbiAgICBiYXNlX3V2ICo9IHNoYWRvd01hcFNpemVJbnY7XFxuICAgIGZsb2F0IHV3MCA9ICg0LjAgLSAzLjAgKiBzKTtcXG4gICAgZmxvYXQgdXcxID0gNy4wO1xcbiAgICBmbG9hdCB1dzIgPSAoMS4wICsgMy4wICogcyk7XFxuICAgIGZsb2F0IHUwID0gKDMuMCAtIDIuMCAqIHMpIC8gdXcwIC0gMi4wO1xcbiAgICBmbG9hdCB1MSA9ICgzLjAgKyBzKSAvIHV3MTtcXG4gICAgZmxvYXQgdTIgPSBzIC8gdXcyICsgMi4wO1xcbiAgICBmbG9hdCB2dzAgPSAoNC4wIC0gMy4wICogdCk7XFxuICAgIGZsb2F0IHZ3MSA9IDcuMDtcXG4gICAgZmxvYXQgdncyID0gKDEuMCArIDMuMCAqIHQpO1xcbiAgICBmbG9hdCB2MCA9ICgzLjAgLSAyLjAgKiB0KSAvIHZ3MCAtIDIuMDtcXG4gICAgZmxvYXQgdjEgPSAoMy4wICsgdCkgLyB2dzE7XFxuICAgIGZsb2F0IHYyID0gdCAvIHZ3MiArIDIuMDtcXG4gICAgZmxvYXQgc3VtID0gMC4wO1xcbiAgICB1MCA9IHUwICogc2hhZG93TWFwU2l6ZUludiArIGJhc2VfdXYueDtcXG4gICAgdjAgPSB2MCAqIHNoYWRvd01hcFNpemVJbnYgKyBiYXNlX3V2Lnk7XFxuICAgIHUxID0gdTEgKiBzaGFkb3dNYXBTaXplSW52ICsgYmFzZV91di54O1xcbiAgICB2MSA9IHYxICogc2hhZG93TWFwU2l6ZUludiArIGJhc2VfdXYueTtcXG4gICAgdTIgPSB1MiAqIHNoYWRvd01hcFNpemVJbnYgKyBiYXNlX3V2Lng7XFxuICAgIHYyID0gdjIgKiBzaGFkb3dNYXBTaXplSW52ICsgYmFzZV91di55O1xcbiAgICBzdW0gKz0gdXcwICogdncwICogdGV4dHVyZShzaGFkb3dNYXAsIHZlYzModTAsIHYwLCB6KSk7XFxuICAgIHN1bSArPSB1dzEgKiB2dzAgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MSwgdjAsIHopKTtcXG4gICAgc3VtICs9IHV3MiAqIHZ3MCAqIHRleHR1cmUoc2hhZG93TWFwLCB2ZWMzKHUyLCB2MCwgeikpO1xcbiAgICBzdW0gKz0gdXcwICogdncxICogdGV4dHVyZShzaGFkb3dNYXAsIHZlYzModTAsIHYxLCB6KSk7XFxuICAgIHN1bSArPSB1dzEgKiB2dzEgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MSwgdjEsIHopKTtcXG4gICAgc3VtICs9IHV3MiAqIHZ3MSAqIHRleHR1cmUoc2hhZG93TWFwLCB2ZWMzKHUyLCB2MSwgeikpO1xcbiAgICBzdW0gKz0gdXcwICogdncyICogdGV4dHVyZShzaGFkb3dNYXAsIHZlYzModTAsIHYyLCB6KSk7XFxuICAgIHN1bSArPSB1dzEgKiB2dzIgKiB0ZXh0dXJlKHNoYWRvd01hcCwgdmVjMyh1MSwgdjIsIHopKTtcXG4gICAgc3VtICs9IHV3MiAqIHZ3MiAqIHRleHR1cmUoc2hhZG93TWFwLCB2ZWMzKHUyLCB2MiwgeikpO1xcbiAgICBzdW0gKj0gMS4wZiAvIDE0NC4wO1xcbiAgICBzdW0gPSBnYW1tYUNvcnJlY3RJbnB1dChzdW0pOyAvLyBnaXZlcyBzb2Z0ZXIgZ3JhZGllbnRcXG4gICAgcmV0dXJuIHN1bTtcXG59XFxuZmxvYXQgZ2V0U2hhZG93UENGNXg1KHNhbXBsZXIyRFNoYWRvdyBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgIHJldHVybiBfZ2V0U2hhZG93UENGNXg1KHNoYWRvd01hcCwgc2hhZG93UGFyYW1zKTtcXG59XFxuZmxvYXQgZ2V0U2hhZG93U3BvdFBDRjV4NShzYW1wbGVyMkRTaGFkb3cgc2hhZG93TWFwLCB2ZWM0IHNoYWRvd1BhcmFtcykge1xcbiAgICByZXR1cm4gX2dldFNoYWRvd1BDRjV4NShzaGFkb3dNYXAsIHNoYWRvd1BhcmFtcy54eXopO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zaGFkb3dTdGFuZGFyZEdMMlZTUFMgPSBcImZsb2F0IGdldFNoYWRvd1BDRjV4NVZTKHNhbXBsZXIyRFNoYWRvdyBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgIGRTaGFkb3dDb29yZCA9IHZNYWluU2hhZG93VXYueHl6O1xcbiAgICBkU2hhZG93Q29vcmQueiA9IHNhdHVyYXRlKGRTaGFkb3dDb29yZC56KSAtIDAuMDAwMTsgLy8gcHJldmVudCBnb2luZyB0byBkYXJrIGFmdGVyIHRoZSBmYXIgcGxhbmVcXG4gICAgcmV0dXJuIF9nZXRTaGFkb3dQQ0Y1eDUoc2hhZG93TWFwLCBzaGFkb3dQYXJhbXMpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zaGFkb3dTdGFuZGFyZFZTUFMgPSBcIiNpZmRlZiBHTDJcXG4jZGVmaW5lIFNIQURPV19TQU1QTEVSVlMgc2FtcGxlcjJEU2hhZG93XFxuI2Vsc2VcXG4jZGVmaW5lIFNIQURPV19TQU1QTEVSVlMgc2FtcGxlcjJEXFxuI2VuZGlmXFxuZmxvYXQgZ2V0U2hhZG93UENGM3gzVlMoU0hBRE9XX1NBTVBMRVJWUyBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zKSB7XFxuICAgIGRTaGFkb3dDb29yZCA9IHZNYWluU2hhZG93VXYueHl6O1xcbiAgICBkU2hhZG93Q29vcmQueiA9IHNhdHVyYXRlKGRTaGFkb3dDb29yZC56KSAtIDAuMDAwMTtcXG4gICAgI2lmZGVmIFNIQURPV0JJQVNcXG4gICAgICAgIGRTaGFkb3dDb29yZC56ICs9IGdldFNoYWRvd0JpYXMoc2hhZG93UGFyYW1zLngsIHNoYWRvd1BhcmFtcy56KTtcXG4gICAgI2VuZGlmXFxuICAgIHJldHVybiBfZ2V0U2hhZG93UENGM3gzKHNoYWRvd01hcCwgc2hhZG93UGFyYW1zKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93VlNNOFBTID0gXCJmbG9hdCBjYWxjdWxhdGVWU004KHZlYzMgbW9tZW50cywgZmxvYXQgWiwgZmxvYXQgdnNtQmlhcykge1xcbiAgICBmbG9hdCBWU01CaWFzID0gdnNtQmlhczsvLzAuMDEgKiAwLjI1O1xcbiAgICBmbG9hdCBkZXB0aFNjYWxlID0gVlNNQmlhcyAqIFo7XFxuICAgIGZsb2F0IG1pblZhcmlhbmNlMSA9IGRlcHRoU2NhbGUgKiBkZXB0aFNjYWxlO1xcbiAgICByZXR1cm4gY2hlYnlzaGV2VXBwZXJCb3VuZChtb21lbnRzLnh5LCBaLCBtaW5WYXJpYW5jZTEsIDAuMSk7XFxufVxcbmZsb2F0IGRlY29kZUZsb2F0UkcodmVjMiByZykge1xcbiAgICByZXR1cm4gcmcueSooMS4wLzI1NS4wKSArIHJnLng7XFxufVxcbmZsb2F0IFZTTTgoc2FtcGxlcjJEIHRleCwgdmVjMiB0ZXhDb29yZHMsIGZsb2F0IHJlc29sdXRpb24sIGZsb2F0IFosIGZsb2F0IHZzbUJpYXMsIGZsb2F0IGV4cG9uZW50KSB7XFxuICAgIHZlYzQgYyA9IHRleHR1cmUyRCh0ZXgsIHRleENvb3Jkcyk7XFxuICAgIHZlYzMgbW9tZW50cyA9IHZlYzMoZGVjb2RlRmxvYXRSRyhjLnh5KSwgZGVjb2RlRmxvYXRSRyhjLnp3KSwgMC4wKTtcXG4gICAgcmV0dXJuIGNhbGN1bGF0ZVZTTTgobW9tZW50cywgWiwgdnNtQmlhcyk7XFxufVxcbmZsb2F0IGdldFNoYWRvd1ZTTTgoc2FtcGxlcjJEIHNoYWRvd01hcCwgdmVjMyBzaGFkb3dQYXJhbXMsIGZsb2F0IGV4cG9uZW50KSB7XFxuICAgIHJldHVybiBWU004KHNoYWRvd01hcCwgZFNoYWRvd0Nvb3JkLnh5LCBzaGFkb3dQYXJhbXMueCwgZFNoYWRvd0Nvb3JkLnosIHNoYWRvd1BhcmFtcy55LCAwLjApO1xcbn1cXG5mbG9hdCBnZXRTaGFkb3dTcG90VlNNOChzYW1wbGVyMkQgc2hhZG93TWFwLCB2ZWM0IHNoYWRvd1BhcmFtcywgZmxvYXQgZXhwb25lbnQpIHtcXG4gICAgcmV0dXJuIFZTTTgoc2hhZG93TWFwLCBkU2hhZG93Q29vcmQueHksIHNoYWRvd1BhcmFtcy54LCBsZW5ndGgoZExpZ2h0RGlyVykgKiBzaGFkb3dQYXJhbXMudyArIHNoYWRvd1BhcmFtcy56LCBzaGFkb3dQYXJhbXMueSwgMC4wKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93VlNNVlNQUyA9IFwiZmxvYXQgZ2V0U2hhZG93VlNNJFZTKHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzMgc2hhZG93UGFyYW1zLCBmbG9hdCBleHBvbmVudCkge1xcbiAgICBkU2hhZG93Q29vcmQgPSB2TWFpblNoYWRvd1V2Lnh5ejtcXG4gICAgZFNoYWRvd0Nvb3JkLnogKz0gc2hhZG93UGFyYW1zLno7XFxuICAgIGRTaGFkb3dDb29yZC54eXogLz0gdk1haW5TaGFkb3dVdi53O1xcbiAgICBkU2hhZG93Q29vcmQueiA9IG1pbihkU2hhZG93Q29vcmQueiwgMS4wKTtcXG4gICAgcmV0dXJuICRWU00oc2hhZG93TWFwLCBkU2hhZG93Q29vcmQueHksIHNoYWRvd1BhcmFtcy54LCBkU2hhZG93Q29vcmQueiwgc2hhZG93UGFyYW1zLnksIGV4cG9uZW50KTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2hhZG93VlNNX2NvbW1vblBTID0gXCJmbG9hdCBsaW5zdGVwKGZsb2F0IGEsIGZsb2F0IGIsIGZsb2F0IHYpIHtcXG4gICAgcmV0dXJuIHNhdHVyYXRlKCh2IC0gYSkgLyAoYiAtIGEpKTtcXG59XFxuZmxvYXQgcmVkdWNlTGlnaHRCbGVlZGluZyhmbG9hdCBwTWF4LCBmbG9hdCBhbW91bnQpIHtcXG4gIC8vIFJlbW92ZSB0aGUgWzAsIGFtb3VudF0gdGFpbCBhbmQgbGluZWFybHkgcmVzY2FsZSAoYW1vdW50LCAxXS5cXG4gICByZXR1cm4gbGluc3RlcChhbW91bnQsIDEuMCwgcE1heCk7XFxufVxcbmZsb2F0IGNoZWJ5c2hldlVwcGVyQm91bmQodmVjMiBtb21lbnRzLCBmbG9hdCBtZWFuLCBmbG9hdCBtaW5WYXJpYW5jZSwgZmxvYXQgbGlnaHRCbGVlZGluZ1JlZHVjdGlvbikge1xcbiAgICAvLyBDb21wdXRlIHZhcmlhbmNlXFxuICAgIGZsb2F0IHZhcmlhbmNlID0gbW9tZW50cy55IC0gKG1vbWVudHMueCAqIG1vbWVudHMueCk7XFxuICAgIHZhcmlhbmNlID0gbWF4KHZhcmlhbmNlLCBtaW5WYXJpYW5jZSk7XFxuICAgIC8vIENvbXB1dGUgcHJvYmFiaWxpc3RpYyB1cHBlciBib3VuZFxcbiAgICBmbG9hdCBkID0gbWVhbiAtIG1vbWVudHMueDtcXG4gICAgZmxvYXQgcE1heCA9IHZhcmlhbmNlIC8gKHZhcmlhbmNlICsgKGQgKiBkKSk7XFxuICAgIHBNYXggPSByZWR1Y2VMaWdodEJsZWVkaW5nKHBNYXgsIGxpZ2h0QmxlZWRpbmdSZWR1Y3Rpb24pO1xcbiAgICAvLyBPbmUtdGFpbGVkIENoZWJ5c2hldlxcbiAgICByZXR1cm4gKG1lYW4gPD0gbW9tZW50cy54ID8gMS4wIDogcE1heCk7XFxufVxcbmZsb2F0IGNhbGN1bGF0ZUVWU00odmVjMyBtb21lbnRzLCBmbG9hdCBaLCBmbG9hdCB2c21CaWFzLCBmbG9hdCBleHBvbmVudCkge1xcbiAgICBaID0gMi4wICogWiAtIDEuMDtcXG4gICAgZmxvYXQgd2FycGVkRGVwdGggPSBleHAoZXhwb25lbnQgKiBaKTtcXG4gICAgbW9tZW50cy54eSArPSB2ZWMyKHdhcnBlZERlcHRoLCB3YXJwZWREZXB0aCp3YXJwZWREZXB0aCkgKiAoMS4wIC0gbW9tZW50cy56KTtcXG4gICAgZmxvYXQgVlNNQmlhcyA9IHZzbUJpYXM7Ly8wLjAxICogMC4yNTtcXG4gICAgZmxvYXQgZGVwdGhTY2FsZSA9IFZTTUJpYXMgKiBleHBvbmVudCAqIHdhcnBlZERlcHRoO1xcbiAgICBmbG9hdCBtaW5WYXJpYW5jZTEgPSBkZXB0aFNjYWxlICogZGVwdGhTY2FsZTtcXG4gICAgcmV0dXJuIGNoZWJ5c2hldlVwcGVyQm91bmQobW9tZW50cy54eSwgd2FycGVkRGVwdGgsIG1pblZhcmlhbmNlMSwgMC4xKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2tpbkJhdGNoQ29uc3RWUyA9IFwiYXR0cmlidXRlIGZsb2F0IHZlcnRleF9ib25lSW5kaWNlcztcXG51bmlmb3JtIG1hdDQgbWF0cml4X3Bvc2VbQk9ORV9MSU1JVF07XFxubWF0NCBnZXRCb25lTWF0cml4KGNvbnN0IGluIGZsb2F0IGkpIHtcXG4gICAgbWF0NCBib25lID0gbWF0cml4X3Bvc2VbaW50KGkpXTtcXG4gICAgcmV0dXJuIGJvbmU7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNraW5CYXRjaFRleFZTID0gXCJhdHRyaWJ1dGUgZmxvYXQgdmVydGV4X2JvbmVJbmRpY2VzO1xcbnVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfcG9zZU1hcDtcXG51bmlmb3JtIHZlYzIgdGV4dHVyZV9wb3NlTWFwU2l6ZTtcXG5tYXQ0IGdldEJvbmVNYXRyaXgoY29uc3QgaW4gZmxvYXQgaSkge1xcbiAgICBmbG9hdCBqID0gaSAqIDQuMDtcXG4gICAgZmxvYXQgeCA9IG1vZChqLCBmbG9hdCh0ZXh0dXJlX3Bvc2VNYXBTaXplLngpKTtcXG4gICAgZmxvYXQgeSA9IGZsb29yKGogLyBmbG9hdCh0ZXh0dXJlX3Bvc2VNYXBTaXplLngpKTtcXG4gICAgZmxvYXQgZHggPSAxLjAgLyBmbG9hdCh0ZXh0dXJlX3Bvc2VNYXBTaXplLngpO1xcbiAgICBmbG9hdCBkeSA9IDEuMCAvIGZsb2F0KHRleHR1cmVfcG9zZU1hcFNpemUueSk7XFxuICAgIHkgPSBkeSAqICh5ICsgMC41KTtcXG4gICAgdmVjNCB2MSA9IHRleHR1cmUyRCh0ZXh0dXJlX3Bvc2VNYXAsIHZlYzIoZHggKiAoeCArIDAuNSksIHkpKTtcXG4gICAgdmVjNCB2MiA9IHRleHR1cmUyRCh0ZXh0dXJlX3Bvc2VNYXAsIHZlYzIoZHggKiAoeCArIDEuNSksIHkpKTtcXG4gICAgdmVjNCB2MyA9IHRleHR1cmUyRCh0ZXh0dXJlX3Bvc2VNYXAsIHZlYzIoZHggKiAoeCArIDIuNSksIHkpKTtcXG4gICAgdmVjNCB2NCA9IHRleHR1cmUyRCh0ZXh0dXJlX3Bvc2VNYXAsIHZlYzIoZHggKiAoeCArIDMuNSksIHkpKTtcXG4gICAgbWF0NCBib25lID0gbWF0NCh2MSwgdjIsIHYzLCB2NCk7XFxuICAgIHJldHVybiBib25lO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5za2luQ29uc3RWUyA9IFwiYXR0cmlidXRlIHZlYzQgdmVydGV4X2JvbmVXZWlnaHRzO1xcbmF0dHJpYnV0ZSB2ZWM0IHZlcnRleF9ib25lSW5kaWNlcztcXG51bmlmb3JtIG1hdDQgbWF0cml4X3Bvc2VbQk9ORV9MSU1JVF07XFxudW5pZm9ybSB2ZWMzIHNraW5Qb3NPZmZzZXQ7XFxubWF0NCBnZXRCb25lTWF0cml4KGNvbnN0IGluIGZsb2F0IGkpXFxue1xcbiAgICBtYXQ0IGJvbmUgPSBtYXRyaXhfcG9zZVtpbnQoaSldO1xcbiAgICByZXR1cm4gYm9uZTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc2tpblRleFZTID0gXCJhdHRyaWJ1dGUgdmVjNCB2ZXJ0ZXhfYm9uZVdlaWdodHM7XFxuYXR0cmlidXRlIHZlYzQgdmVydGV4X2JvbmVJbmRpY2VzO1xcbnVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfcG9zZU1hcDtcXG51bmlmb3JtIHZlYzIgdGV4dHVyZV9wb3NlTWFwU2l6ZTtcXG51bmlmb3JtIHZlYzMgc2tpblBvc09mZnNldDtcXG5tYXQ0IGdldEJvbmVNYXRyaXgoY29uc3QgaW4gZmxvYXQgaSlcXG57XFxuICAgIGZsb2F0IGogPSBpICogNC4wO1xcbiAgICBmbG9hdCB4ID0gbW9kKGosIGZsb2F0KHRleHR1cmVfcG9zZU1hcFNpemUueCkpO1xcbiAgICBmbG9hdCB5ID0gZmxvb3IoaiAvIGZsb2F0KHRleHR1cmVfcG9zZU1hcFNpemUueCkpO1xcbiAgICBmbG9hdCBkeCA9IDEuMCAvIGZsb2F0KHRleHR1cmVfcG9zZU1hcFNpemUueCk7XFxuICAgIGZsb2F0IGR5ID0gMS4wIC8gZmxvYXQodGV4dHVyZV9wb3NlTWFwU2l6ZS55KTtcXG4gICAgeSA9IGR5ICogKHkgKyAwLjUpO1xcbiAgICB2ZWM0IHYxID0gdGV4dHVyZTJEKHRleHR1cmVfcG9zZU1hcCwgdmVjMihkeCAqICh4ICsgMC41KSwgeSkpO1xcbiAgICB2ZWM0IHYyID0gdGV4dHVyZTJEKHRleHR1cmVfcG9zZU1hcCwgdmVjMihkeCAqICh4ICsgMS41KSwgeSkpO1xcbiAgICB2ZWM0IHYzID0gdGV4dHVyZTJEKHRleHR1cmVfcG9zZU1hcCwgdmVjMihkeCAqICh4ICsgMi41KSwgeSkpO1xcbiAgICB2ZWM0IHY0ID0gdGV4dHVyZTJEKHRleHR1cmVfcG9zZU1hcCwgdmVjMihkeCAqICh4ICsgMy41KSwgeSkpO1xcbiAgICBtYXQ0IGJvbmUgPSBtYXQ0KHYxLCB2MiwgdjMsIHY0KTtcXG4gICAgcmV0dXJuIGJvbmU7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNreWJveFBTID0gXCJ2YXJ5aW5nIHZlYzMgdlZpZXdEaXI7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX2N1YmVNYXA7XFxudm9pZCBtYWluKHZvaWQpIHtcXG4gICAgZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZUN1YmUodGV4dHVyZV9jdWJlTWFwLCBmaXhTZWFtcyh2Vmlld0RpcikpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5za3lib3hWUyA9IFwiYXR0cmlidXRlIHZlYzMgYVBvc2l0aW9uO1xcbnVuaWZvcm0gbWF0NCBtYXRyaXhfdmlldztcXG51bmlmb3JtIG1hdDQgbWF0cml4X3Byb2plY3Rpb247XFxudmFyeWluZyB2ZWMzIHZWaWV3RGlyO1xcbnZvaWQgbWFpbih2b2lkKVxcbntcXG4gICAgbWF0NCB2aWV3ID0gbWF0cml4X3ZpZXc7XFxuICAgIHZpZXdbM11bMF0gPSB2aWV3WzNdWzFdID0gdmlld1szXVsyXSA9IDAuMDtcXG4gICAgZ2xfUG9zaXRpb24gPSBtYXRyaXhfcHJvamVjdGlvbiAqIHZpZXcgKiB2ZWM0KGFQb3NpdGlvbiwgMS4wKTtcXG4gICAgLy8gRm9yY2Ugc2t5Ym94IHRvIGZhciBaLCByZWdhcmRsZXNzIG9mIHRoZSBjbGlwIHBsYW5lcyBvbiB0aGUgY2FtZXJhXFxuICAgIC8vIFN1YnRyYWN0IGEgdGlueSBmdWRnZSBmYWN0b3IgdG8gZW5zdXJlIGZsb2F0aW5nIHBvaW50IGVycm9ycyBkb24ndFxcbiAgICAvLyBzdGlsbCBwdXNoIHBpeGVscyBiZXlvbmQgZmFyIFouIFNlZTpcXG4gICAgLy8gaHR0cDovL3d3dy5vcGVuZ2wub3JnL2Rpc2N1c3Npb25fYm9hcmRzL3Nob3d0aHJlYWQucGhwLzE3MTg2Ny1za3lib3gtcHJvYmxlbVxcbiAgICBnbF9Qb3NpdGlvbi56ID0gZ2xfUG9zaXRpb24udyAtIDAuMDAwMDE7XFxuICAgIHZWaWV3RGlyID0gYVBvc2l0aW9uO1xcbiAgICB2Vmlld0Rpci54ICo9IC0xLjA7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNreWJveEhEUlBTID0gXCJ2YXJ5aW5nIHZlYzMgdlZpZXdEaXI7XFxudW5pZm9ybSBzYW1wbGVyQ3ViZSB0ZXh0dXJlX2N1YmVNYXA7XFxudm9pZCBtYWluKHZvaWQpIHtcXG4gICAgdmVjMyBjb2xvciA9IHByb2Nlc3NFbnZpcm9ubWVudCgkdGV4dHVyZUN1YmVTQU1QTEUodGV4dHVyZV9jdWJlTWFwLCBmaXhTZWFtc1N0YXRpYyh2Vmlld0RpciwgJEZJWENPTlNUKSkucmdiKTtcXG4gICAgY29sb3IgPSB0b25lTWFwKGNvbG9yKTtcXG4gICAgY29sb3IgPSBnYW1tYUNvcnJlY3RPdXRwdXQoY29sb3IpO1xcbiAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5za3lib3hQcmVmaWx0ZXJlZEN1YmVQUyA9IFwidmFyeWluZyB2ZWMzIHZWaWV3RGlyO1xcbnVuaWZvcm0gc2FtcGxlckN1YmUgdGV4dHVyZV9jdWJlTWFwO1xcbnZlYzMgZml4U2VhbXNTdHJldGNoKHZlYzMgdmVjLCBmbG9hdCBtaXBtYXBJbmRleCwgZmxvYXQgY3ViZW1hcFNpemUpIHtcXG4gICAgZmxvYXQgc2NhbGUgPSAxLjAgLSBleHAyKG1pcG1hcEluZGV4KSAvIGN1YmVtYXBTaXplO1xcbiAgICBmbG9hdCBNID0gbWF4KG1heChhYnModmVjLngpLCBhYnModmVjLnkpKSwgYWJzKHZlYy56KSk7XFxuICAgIGlmIChhYnModmVjLngpICE9IE0pIHZlYy54ICo9IHNjYWxlO1xcbiAgICBpZiAoYWJzKHZlYy55KSAhPSBNKSB2ZWMueSAqPSBzY2FsZTtcXG4gICAgaWYgKGFicyh2ZWMueikgIT0gTSkgdmVjLnogKj0gc2NhbGU7XFxuICAgIHJldHVybiB2ZWM7XFxufVxcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIHZlYzMgY29sb3IgPSB0ZXh0dXJlQ3ViZVJHQk0odGV4dHVyZV9jdWJlTWFwLCBmaXhTZWFtc1N0cmV0Y2godlZpZXdEaXIsIDAuMCwgMTI4LjApKTtcXG4gICAgY29sb3IgPSB0b25lTWFwKGNvbG9yKTtcXG4gICAgY29sb3IgPSBnYW1tYUNvcnJlY3RPdXRwdXQoY29sb3IpO1xcbiAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLCAxLjApO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zcGVjdWxhckFhTm9uZVBTID0gXCJmbG9hdCBhbnRpQWxpYXNHbG9zc2luZXNzKGZsb2F0IHBvd2VyKSB7XFxuICAgIHJldHVybiBwb3dlcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc3BlY3VsYXJBYVRva3N2aWdQUyA9IFwiZmxvYXQgYW50aUFsaWFzR2xvc3NpbmVzcyhmbG9hdCBwb3dlcikge1xcbiAgICBmbG9hdCBybGVuID0gMS4wIC8gc2F0dXJhdGUobGVuZ3RoKGROb3JtYWxNYXApKTtcXG4gICAgZmxvYXQgdG9rc3ZpZyA9IDEuMCAvICgxLjAgKyBwb3dlciAqIChybGVuIC0gMS4wKSk7XFxuICAgIHJldHVybiBwb3dlciAqIHRva3N2aWc7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNwZWN1bGFyQWFUb2tzdmlnRmxvYXRQUyA9IFwiZmxvYXQgYW50aUFsaWFzR2xvc3NpbmVzcyhmbG9hdCBwb3dlcikge1xcbiAgICBmbG9hdCBybGVuID0gMS4wIC8gc2F0dXJhdGUobGVuZ3RoKGROb3JtYWxNYXApKTtcXG4gICAgZmxvYXQgdG9rc3ZpZyA9IDEuMCAvICgxLjAgKyBwb3dlciAqIChybGVuIC0gMS4wKSk7XFxuICAgIHJldHVybiBwb3dlciAqIG1peCgxLjAsIHRva3N2aWcsIG1hdGVyaWFsX2J1bXBpbmVzcyk7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnNwZWN1bGFyQ29uc3RQUyA9IFwidW5pZm9ybSB2ZWMzIG1hdGVyaWFsX3NwZWN1bGFyO1xcbnZvaWQgZ2V0U3BlY3VsYXJpdHkoKSB7XFxuICAgIGRTcGVjdWxhcml0eSA9IG1hdGVyaWFsX3NwZWN1bGFyO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zcGVjdWxhclRleFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX3NwZWN1bGFyTWFwO1xcbnZvaWQgZ2V0U3BlY3VsYXJpdHkoKSB7XFxuICAgIGRTcGVjdWxhcml0eSA9IHRleHR1cmUyRCh0ZXh0dXJlX3NwZWN1bGFyTWFwLCAkVVYpLiRDSDtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc3BlY3VsYXJUZXhDb25zdFBTID0gXCJ1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlX3NwZWN1bGFyTWFwO1xcbnVuaWZvcm0gdmVjMyBtYXRlcmlhbF9zcGVjdWxhcjtcXG52b2lkIGdldFNwZWN1bGFyaXR5KCkge1xcbiAgICBkU3BlY3VsYXJpdHkgPSB0ZXh0dXJlMkQodGV4dHVyZV9zcGVjdWxhck1hcCwgJFVWKS4kQ0ggKiBtYXRlcmlhbF9zcGVjdWxhcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc3BlY3VsYXJWZXJ0UFMgPSBcInZvaWQgZ2V0U3BlY3VsYXJpdHkoKSB7XFxuICAgIGRTcGVjdWxhcml0eSA9IHNhdHVyYXRlKHZWZXJ0ZXhDb2xvci4kQ0gpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zcGVjdWxhclZlcnRDb25zdFBTID0gXCJ1bmlmb3JtIHZlYzMgbWF0ZXJpYWxfc3BlY3VsYXI7XFxudm9pZCBnZXRTcGVjdWxhcml0eSgpIHtcXG4gICAgZFNwZWN1bGFyaXR5ID0gc2F0dXJhdGUodlZlcnRleENvbG9yLiRDSCkgKiBtYXRlcmlhbF9zcGVjdWxhcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc3BvdFBTID0gXCJmbG9hdCBnZXRTcG90RWZmZWN0KHZlYzMgbGlnaHRTcG90RGlyVywgZmxvYXQgbGlnaHRJbm5lckNvbmVBbmdsZSwgZmxvYXQgbGlnaHRPdXRlckNvbmVBbmdsZSkge1xcbiAgICBmbG9hdCBjb3NBbmdsZSA9IGRvdChkTGlnaHREaXJOb3JtVywgbGlnaHRTcG90RGlyVyk7XFxuICAgIHJldHVybiBzbW9vdGhzdGVwKGxpZ2h0T3V0ZXJDb25lQW5nbGUsIGxpZ2h0SW5uZXJDb25lQW5nbGUsIGNvc0FuZ2xlKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3Muc3RhcnRQUyA9IFwiXFxudm9pZCBtYWluKHZvaWQpIHtcXG4gICAgZERpZmZ1c2VMaWdodCA9IHZlYzMoMCk7XFxuICAgIGRTcGVjdWxhckxpZ2h0ID0gdmVjMygwKTtcXG4gICAgZFJlZmxlY3Rpb24gPSB2ZWM0KDApO1xcbiAgICBkU3BlY3VsYXJpdHkgPSB2ZWMzKDApO1xcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnN0YXJ0VlMgPSBcIlxcbnZvaWQgbWFpbih2b2lkKSB7XFxuICAgIGdsX1Bvc2l0aW9uID0gZ2V0UG9zaXRpb24oKTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy5zdG9yZUVWU01QUyA9IFwiZmxvYXQgZXhwb25lbnQgPSBWU01fRVhQT05FTlQ7XFxuZGVwdGggPSAyLjAgKiBkZXB0aCAtIDEuMDtcXG5kZXB0aCA9ICBleHAoZXhwb25lbnQgKiBkZXB0aCk7XFxuZ2xfRnJhZ0NvbG9yID0gdmVjNChkZXB0aCwgZGVwdGgqZGVwdGgsIDEuMCwgMS4wKTtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy50YW5nZW50Qmlub3JtYWxWUyA9IFwiXFxudmVjMyBnZXRUYW5nZW50KCkge1xcbiAgICByZXR1cm4gbm9ybWFsaXplKGROb3JtYWxNYXRyaXggKiB2ZXJ0ZXhfdGFuZ2VudC54eXopO1xcbn1cXG52ZWMzIGdldEJpbm9ybWFsKCkge1xcbiAgICByZXR1cm4gY3Jvc3Modk5vcm1hbFcsIHZUYW5nZW50VykgKiB2ZXJ0ZXhfdGFuZ2VudC53O1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy50b25lbWFwcGluZ0FjZXNQUyA9IFwidW5pZm9ybSBmbG9hdCBleHBvc3VyZTtcXG52ZWMzIHRvbmVNYXAodmVjMyBjb2xvcikge1xcbiAgICBmbG9hdCB0QSA9IDIuNTE7XFxuICAgIGZsb2F0IHRCID0gMC4wMztcXG4gICAgZmxvYXQgdEMgPSAyLjQzO1xcbiAgICBmbG9hdCB0RCA9IDAuNTk7XFxuICAgIGZsb2F0IHRFID0gMC4xNDtcXG4gICAgdmVjMyB4ID0gY29sb3IgKiBleHBvc3VyZTtcXG4gICAgcmV0dXJuICh4Kih0QSp4K3RCKSkvKHgqKHRDKngrdEQpK3RFKTtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MudG9uZW1hcHBpbmdBY2VzMlBTID0gXCJ1bmlmb3JtIGZsb2F0IGV4cG9zdXJlO1xcbi8vIEFDRVMgYXBwcm94aW1hdGlvbiBieSBTdGVwaGVuIEhpbGxcXG4vLyBzUkdCID0+IFhZWiA9PiBENjVfMl9ENjAgPT4gQVAxID0+IFJSVF9TQVRcXG5jb25zdCBtYXQzIEFDRVNJbnB1dE1hdCA9IG1hdDMoXFxuICAgIDAuNTk3MTksIDAuMzU0NTgsIDAuMDQ4MjMsXFxuICAgIDAuMDc2MDAsIDAuOTA4MzQsIDAuMDE1NjYsXFxuICAgIDAuMDI4NDAsIDAuMTMzODMsIDAuODM3NzdcXG4pO1xcbi8vIE9EVF9TQVQgPT4gWFlaID0+IEQ2MF8yX0Q2NSA9PiBzUkdCXFxuY29uc3QgbWF0MyBBQ0VTT3V0cHV0TWF0ID0gbWF0MyhcXG4gICAgIDEuNjA0NzUsIC0wLjUzMTA4LCAtMC4wNzM2NyxcXG4gICAgLTAuMTAyMDgsICAxLjEwODEzLCAtMC4wMDYwNSxcXG4gICAgLTAuMDAzMjcsIC0wLjA3Mjc2LCAgMS4wNzYwMlxcbik7XFxudmVjMyBSUlRBbmRPRFRGaXQodmVjMyB2KSB7XFxuICAgIHZlYzMgYSA9IHYgKiAodiArIDAuMDI0NTc4NikgLSAwLjAwMDA5MDUzNztcXG4gICAgdmVjMyBiID0gdiAqICgwLjk4MzcyOSAqIHYgKyAwLjQzMjk1MTApICsgMC4yMzgwODE7XFxuICAgIHJldHVybiBhIC8gYjtcXG59XFxudmVjMyB0b25lTWFwKHZlYzMgY29sb3IpIHtcXG4gICAgY29sb3IgKj0gZXhwb3N1cmU7XFxuICAgIGNvbG9yID0gY29sb3IgKiBBQ0VTSW5wdXRNYXQ7XFxuICAgIC8vIEFwcGx5IFJSVCBhbmQgT0RUXFxuICAgIGNvbG9yID0gUlJUQW5kT0RURml0KGNvbG9yKTtcXG4gICAgY29sb3IgPSBjb2xvciAqIEFDRVNPdXRwdXRNYXQ7XFxuICAgIC8vIENsYW1wIHRvIFswLCAxXVxcbiAgICBjb2xvciA9IGNsYW1wKGNvbG9yLCAwLjAsIDEuMCk7XFxuICAgIHJldHVybiBjb2xvcjtcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MudG9uZW1hcHBpbmdGaWxtaWNQUyA9IFwiY29uc3QgZmxvYXQgQSA9ICAwLjE1O1xcbmNvbnN0IGZsb2F0IEIgPSAgMC41MDtcXG5jb25zdCBmbG9hdCBDID0gIDAuMTA7XFxuY29uc3QgZmxvYXQgRCA9ICAwLjIwO1xcbmNvbnN0IGZsb2F0IEUgPSAgMC4wMjtcXG5jb25zdCBmbG9hdCBGID0gIDAuMzA7XFxuY29uc3QgZmxvYXQgVyA9ICAxMS4yO1xcbnVuaWZvcm0gZmxvYXQgZXhwb3N1cmU7XFxudmVjMyB1bmNoYXJ0ZWQyVG9uZW1hcCh2ZWMzIHgpIHtcXG4gICByZXR1cm4gKCh4KihBKngrQypCKStEKkUpLyh4KihBKngrQikrRCpGKSktRS9GO1xcbn1cXG52ZWMzIHRvbmVNYXAodmVjMyBjb2xvcikge1xcbiAgICBjb2xvciA9IHVuY2hhcnRlZDJUb25lbWFwKGNvbG9yICogZXhwb3N1cmUpO1xcbiAgICB2ZWMzIHdoaXRlU2NhbGUgPSAxLjAgLyB1bmNoYXJ0ZWQyVG9uZW1hcCh2ZWMzKFcsVyxXKSk7XFxuICAgIGNvbG9yID0gY29sb3IgKiB3aGl0ZVNjYWxlO1xcbiAgICByZXR1cm4gY29sb3I7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnRvbmVtYXBwaW5nSGVqbFBTID0gXCJ1bmlmb3JtIGZsb2F0IGV4cG9zdXJlO1xcbnZlYzMgdG9uZU1hcCh2ZWMzIGNvbG9yKSB7XFxuICAgIGNvbG9yICo9IGV4cG9zdXJlO1xcbiAgICBjb25zdCBmbG9hdCAgQSA9IDAuMjIsIEIgPSAwLjMsIEMgPSAuMSwgRCA9IDAuMiwgRSA9IC4wMSwgRiA9IDAuMztcXG4gICAgY29uc3QgZmxvYXQgU2NsID0gMS4yNTtcXG4gICAgdmVjMyBoID0gbWF4KCB2ZWMzKDAuMCksIGNvbG9yIC0gdmVjMygwLjAwNCkgKTtcXG4gICAgcmV0dXJuIChoKigoU2NsKkEpKmgrU2NsKnZlYzMoQypCLEMqQixDKkIpKStTY2wqdmVjMyhEKkUsRCpFLEQqRSkpIC8gKGgqKEEqaCt2ZWMzKEIsQixCKSkrdmVjMyhEKkYsRCpGLEQqRikpIC0gU2NsKnZlYzMoRS9GLEUvRixFL0YpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy50b25lbWFwcGluZ0xpbmVhclBTID0gXCJ1bmlmb3JtIGZsb2F0IGV4cG9zdXJlO1xcbnZlYzMgdG9uZU1hcCh2ZWMzIGNvbG9yKSB7XFxuICAgIHJldHVybiBjb2xvciAqIGV4cG9zdXJlO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy50b25lbWFwcGluZ05vbmVQUyA9IFwidmVjMyB0b25lTWFwKHZlYzMgY29sb3IpIHtcXG4gICAgcmV0dXJuIGNvbG9yO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy50cmFuc2Zvcm1WUyA9IFwibWF0NCBnZXRNb2RlbE1hdHJpeCgpIHtcXG4gICAgcmV0dXJuIG1hdHJpeF9tb2RlbDtcXG59XFxudmVjNCBnZXRQb3NpdGlvbigpIHtcXG4gICAgZE1vZGVsTWF0cml4ID0gZ2V0TW9kZWxNYXRyaXgoKTtcXG4gICAgdmVjNCBwb3NXID0gZE1vZGVsTWF0cml4ICogdmVjNCh2ZXJ0ZXhfcG9zaXRpb24sIDEuMCk7XFxuICAgIGRQb3NpdGlvblcgPSBwb3NXLnh5ejtcXG4gICAgcmV0dXJuIG1hdHJpeF92aWV3UHJvamVjdGlvbiAqIHBvc1c7XFxufVxcbnZlYzMgZ2V0V29ybGRQb3NpdGlvbigpIHtcXG4gICAgcmV0dXJuIGRQb3NpdGlvblc7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnRyYW5zZm9ybUJhdGNoU2tpbm5lZFZTID0gXCJtYXQ0IGdldE1vZGVsTWF0cml4KCkge1xcbiAgICByZXR1cm4gZ2V0Qm9uZU1hdHJpeCh2ZXJ0ZXhfYm9uZUluZGljZXMpO1xcbn1cXG52ZWM0IGdldFBvc2l0aW9uKCkge1xcbiAgICBkTW9kZWxNYXRyaXggPSBnZXRNb2RlbE1hdHJpeCgpO1xcbiAgICB2ZWM0IHBvc1cgPSBkTW9kZWxNYXRyaXggKiB2ZWM0KHZlcnRleF9wb3NpdGlvbiwgMS4wKTtcXG4gICAgZFBvc2l0aW9uVyA9IHBvc1cueHl6O1xcbiAgICByZXR1cm4gbWF0cml4X3ZpZXdQcm9qZWN0aW9uICogcG9zVztcXG59XFxudmVjMyBnZXRXb3JsZFBvc2l0aW9uKCkge1xcbiAgICByZXR1cm4gZFBvc2l0aW9uVztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MudHJhbnNmb3JtRGVjbFZTID0gXCJhdHRyaWJ1dGUgdmVjMyB2ZXJ0ZXhfcG9zaXRpb247XFxudW5pZm9ybSBtYXQ0IG1hdHJpeF9tb2RlbDtcXG51bmlmb3JtIG1hdDQgbWF0cml4X3ZpZXdQcm9qZWN0aW9uO1xcbnZlYzMgZFBvc2l0aW9uVztcXG5tYXQ0IGRNb2RlbE1hdHJpeDtcXG5cIjtcbnBjLnNoYWRlckNodW5rcy50cmFuc2Zvcm1JbnN0YW5jZWRWUyA9IFwibWF0NCBnZXRNb2RlbE1hdHJpeCgpIHtcXG4gICAgcmV0dXJuIG1hdDQoaW5zdGFuY2VfbGluZTEsIGluc3RhbmNlX2xpbmUyLCBpbnN0YW5jZV9saW5lMywgaW5zdGFuY2VfbGluZTQpO1xcbn1cXG52ZWM0IGdldFBvc2l0aW9uKCkge1xcbiAgICBkTW9kZWxNYXRyaXggPSBnZXRNb2RlbE1hdHJpeCgpO1xcbiAgICB2ZWM0IHBvc1cgPSBkTW9kZWxNYXRyaXggKiB2ZWM0KHZlcnRleF9wb3NpdGlvbiwgMS4wKTtcXG4gICAgZFBvc2l0aW9uVyA9IHBvc1cueHl6O1xcbiAgICByZXR1cm4gbWF0cml4X3ZpZXdQcm9qZWN0aW9uICogcG9zVztcXG59XFxudmVjMyBnZXRXb3JsZFBvc2l0aW9uKCkge1xcbiAgICByZXR1cm4gZFBvc2l0aW9uVztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MudHJhbnNmb3JtU2NyZWVuU3BhY2VWUyA9IFwibWF0NCBnZXRNb2RlbE1hdHJpeCgpIHtcXG4gICAgcmV0dXJuIG1hdHJpeF9tb2RlbDtcXG59XFxudmVjNCBnZXRQb3NpdGlvbigpIHtcXG4gICAgdmVjNCBwb3NXID0gdmVjNCgoZ2V0TW9kZWxNYXRyaXgoKSAqIHZlYzQodmVydGV4X3Bvc2l0aW9uLCAxLjApKS54eSwgMC4wLCAxLjApO1xcbiAgICBkUG9zaXRpb25XID0gcG9zVy54eXo7XFxuICAgIHJldHVybiBwb3NXO1xcbn1cXG52ZWMzIGdldFdvcmxkUG9zaXRpb24oKSB7XFxuICAgIHJldHVybiBkUG9zaXRpb25XO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy50cmFuc2Zvcm1TY3JlZW5TcGFjZUJhdGNoU2tpbm5lZFZTID0gXCJtYXQ0IGdldE1vZGVsTWF0cml4KCkge1xcbiAgICByZXR1cm4gZ2V0Qm9uZU1hdHJpeCh2ZXJ0ZXhfYm9uZUluZGljZXMpO1xcbn1cXG52ZWM0IGdldFBvc2l0aW9uKCkge1xcbiAgICB2ZWM0IHBvc1cgPSB2ZWM0KChnZXRNb2RlbE1hdHJpeCgpICogdmVjNCh2ZXJ0ZXhfcG9zaXRpb24sIDEuMCkpLnh5LCAwLjAsIDEuMCk7XFxuICAgIGRQb3NpdGlvblcgPSBwb3NXLnh5ejtcXG4gICAgcmV0dXJuIHBvc1c7XFxufVxcbnZlYzMgZ2V0V29ybGRQb3NpdGlvbigpIHtcXG4gICAgcmV0dXJuIGRQb3NpdGlvblc7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnRyYW5zZm9ybVNraW5uZWRWUyA9IFwibWF0NCBnZXRNb2RlbE1hdHJpeCgpIHtcXG4gICAgcmV0dXJuIGdldEJvbmVNYXRyaXgodmVydGV4X2JvbmVJbmRpY2VzLngpICogdmVydGV4X2JvbmVXZWlnaHRzLnggK1xcbiAgICAgICAgICAgZ2V0Qm9uZU1hdHJpeCh2ZXJ0ZXhfYm9uZUluZGljZXMueSkgKiB2ZXJ0ZXhfYm9uZVdlaWdodHMueSArXFxuICAgICAgICAgICBnZXRCb25lTWF0cml4KHZlcnRleF9ib25lSW5kaWNlcy56KSAqIHZlcnRleF9ib25lV2VpZ2h0cy56ICtcXG4gICAgICAgICAgIGdldEJvbmVNYXRyaXgodmVydGV4X2JvbmVJbmRpY2VzLncpICogdmVydGV4X2JvbmVXZWlnaHRzLnc7XFxufVxcbnZlYzQgZ2V0UG9zaXRpb24oKSB7XFxuICAgIGRNb2RlbE1hdHJpeCA9IGdldE1vZGVsTWF0cml4KCk7XFxuICAgIHZlYzQgcG9zVyA9IGRNb2RlbE1hdHJpeCAqIHZlYzQodmVydGV4X3Bvc2l0aW9uLCAxLjApO1xcbiAgICAvL3Bvc1cueHl6IC89IHBvc1cudztcXG4gICAgcG9zVy54eXogKz0gc2tpblBvc09mZnNldDtcXG4gICAgZFBvc2l0aW9uVyA9IHBvc1cueHl6Oy8vIC8gcG9zVy53O1xcbiAgICByZXR1cm4gbWF0cml4X3ZpZXdQcm9qZWN0aW9uICogcG9zVztcXG59XFxudmVjMyBnZXRXb3JsZFBvc2l0aW9uKCkge1xcbiAgICByZXR1cm4gZFBvc2l0aW9uVztcXG59XFxuXCI7XG5wYy5zaGFkZXJDaHVua3MudHJhbnNmb3JtVXYxVlMgPSBcIm1hdDQgZ2V0TW9kZWxNYXRyaXgoKSB7XFxuICAgIHJldHVybiBtYXRyaXhfbW9kZWw7XFxufVxcbnZlYzQgZ2V0UG9zaXRpb24oKSB7XFxuICAgIGRNb2RlbE1hdHJpeCA9IGdldE1vZGVsTWF0cml4KCk7XFxuICAgIHZlYzQgcG9zVyA9IGRNb2RlbE1hdHJpeCAqIHZlYzQodmVydGV4X3Bvc2l0aW9uLCAxLjApO1xcbiAgICBkUG9zaXRpb25XID0gcG9zVy54eXo7XFxuICAgIHJldHVybiB2ZWM0KHZlcnRleF90ZXhDb29yZDEueHkgKiAyLjAgLSAxLjAsIDAuNSwgMSk7XFxufVxcbnZlYzMgZ2V0V29ybGRQb3NpdGlvbigpIHtcXG4gICAgcmV0dXJuIGRQb3NpdGlvblc7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnV2MFZTID0gXCJcXG52ZWMyIGdldFV2MCgpIHtcXG4gICAgcmV0dXJuIHZlcnRleF90ZXhDb29yZDA7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnV2MVZTID0gXCJcXG52ZWMyIGdldFV2MSgpIHtcXG4gICAgcmV0dXJuIHZlcnRleF90ZXhDb29yZDE7XFxufVxcblwiO1xucGMuc2hhZGVyQ2h1bmtzLnZpZXdEaXJQUyA9IFwidm9pZCBnZXRWaWV3RGlyKCkge1xcbiAgICBkVmlld0RpclcgPSBub3JtYWxpemUodmlld19wb3NpdGlvbiAtIHZQb3NpdGlvblcpO1xcbn1cXG5cIjtcbnBjLnNoYWRlckNodW5rcy52aWV3Tm9ybWFsVlMgPSBcIlxcbnVuaWZvcm0gbWF0NCBtYXRyaXhfdmlldztcXG52ZWMzIGdldFZpZXdOb3JtYWwoKSB7XFxuICAgIHJldHVybiBtYXQzKG1hdHJpeF92aWV3KSAqIHZOb3JtYWxXO1xcbn1cXG5cIjtcbnBjLnByb2dyYW1saWIgPSB7Z2FtbWFDb2RlOmZ1bmN0aW9uKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gcGMuR0FNTUFfU1JHQiB8fCB2YWx1ZSA9PT0gcGMuR0FNTUFfU1JHQkZBU1QpIHtcbiAgICByZXR1cm4gcGMuc2hhZGVyQ2h1bmtzLmdhbW1hMl8yUFM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHZhbHVlID09PSBwYy5HQU1NQV9TUkdCSERSKSB7XG4gICAgICByZXR1cm4gXCIjZGVmaW5lIEhEUlxcblwiICsgcGMuc2hhZGVyQ2h1bmtzLmdhbW1hMl8yUFM7XG4gICAgfVxuICB9XG4gIHJldHVybiBwYy5zaGFkZXJDaHVua3MuZ2FtbWExXzBQUztcbn0sIHRvbmVtYXBDb2RlOmZ1bmN0aW9uKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gcGMuVE9ORU1BUF9GSUxNSUMpIHtcbiAgICByZXR1cm4gcGMuc2hhZGVyQ2h1bmtzLnRvbmVtYXBwaW5nRmlsbWljUFM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHZhbHVlID09PSBwYy5UT05FTUFQX0xJTkVBUikge1xuICAgICAgcmV0dXJuIHBjLnNoYWRlckNodW5rcy50b25lbWFwcGluZ0xpbmVhclBTO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodmFsdWUgPT09IHBjLlRPTkVNQVBfSEVKTCkge1xuICAgICAgICByZXR1cm4gcGMuc2hhZGVyQ2h1bmtzLnRvbmVtYXBwaW5nSGVqbFBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHZhbHVlID09PSBwYy5UT05FTUFQX0FDRVMpIHtcbiAgICAgICAgICByZXR1cm4gcGMuc2hhZGVyQ2h1bmtzLnRvbmVtYXBwaW5nQWNlc1BTO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICh2YWx1ZSA9PT0gcGMuVE9ORU1BUF9BQ0VTMikge1xuICAgICAgICAgICAgcmV0dXJuIHBjLnNoYWRlckNodW5rcy50b25lbWFwcGluZ0FjZXMyUFM7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBwYy5zaGFkZXJDaHVua3MudG9uZW1hcHBpbmdOb25lUFM7XG59LCBmb2dDb2RlOmZ1bmN0aW9uKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gXCJsaW5lYXJcIikge1xuICAgIHJldHVybiBwYy5zaGFkZXJDaHVua3MuZm9nTGluZWFyUFM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHZhbHVlID09PSBcImV4cFwiKSB7XG4gICAgICByZXR1cm4gcGMuc2hhZGVyQ2h1bmtzLmZvZ0V4cFBTO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodmFsdWUgPT09IFwiZXhwMlwiKSB7XG4gICAgICAgIHJldHVybiBwYy5zaGFkZXJDaHVua3MuZm9nRXhwMlBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHBjLnNoYWRlckNodW5rcy5mb2dOb25lUFM7XG4gICAgICB9XG4gICAgfVxuICB9XG59LCBza2luQ29kZTpmdW5jdGlvbihkZXZpY2UsIGNodW5rcykge1xuICBpZiAoIWNodW5rcykge1xuICAgIGNodW5rcyA9IHBjLnNoYWRlckNodW5rcztcbiAgfVxuICBpZiAoZGV2aWNlLnN1cHBvcnRzQm9uZVRleHR1cmVzKSB7XG4gICAgcmV0dXJuIGNodW5rcy5za2luVGV4VlM7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFwiI2RlZmluZSBCT05FX0xJTUlUIFwiICsgZGV2aWNlLmdldEJvbmVMaW1pdCgpICsgXCJcXG5cIiArIGNodW5rcy5za2luQ29uc3RWUztcbiAgfVxufSwgcHJlY2lzaW9uQ29kZTpmdW5jdGlvbihkZXZpY2UpIHtcbiAgdmFyIHBjb2RlID0gXCJwcmVjaXNpb24gXCIgKyBkZXZpY2UucHJlY2lzaW9uICsgXCIgZmxvYXQ7XFxuXCI7XG4gIGlmIChkZXZpY2Uud2ViZ2wyKSB7XG4gICAgcGNvZGUgKz0gXCIjaWZkZWYgR0wyXFxucHJlY2lzaW9uIFwiICsgZGV2aWNlLnByZWNpc2lvbiArIFwiIHNhbXBsZXIyRFNoYWRvdztcXG4jZW5kaWZcXG5cIjtcbiAgfVxuICByZXR1cm4gcGNvZGU7XG59LCB2ZXJzaW9uQ29kZTpmdW5jdGlvbihkZXZpY2UpIHtcbiAgcmV0dXJuIGRldmljZS53ZWJnbDIgPyBcIiN2ZXJzaW9uIDMwMCBlc1xcblwiIDogXCJcIjtcbn0sIGR1bW15RnJhZ21lbnRDb2RlOmZ1bmN0aW9uKCkge1xuICByZXR1cm4gXCJ2b2lkIG1haW4odm9pZCkge2dsX0ZyYWdDb2xvciA9IHZlYzQoMC4wKTt9XCI7XG59LCBiZWdpbjpmdW5jdGlvbigpIHtcbiAgcmV0dXJuIFwidm9pZCBtYWluKHZvaWQpXFxue1xcblwiO1xufSwgZW5kOmZ1bmN0aW9uKCkge1xuICByZXR1cm4gXCJ9XFxuXCI7XG59fTtcbnBjLnByb2dyYW1saWIuYmFzaWMgPSB7Z2VuZXJhdGVLZXk6ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBrZXkgPSBcImJhc2ljXCI7XG4gIGlmIChvcHRpb25zLmZvZykge1xuICAgIGtleSArPSBcIl9mb2dcIjtcbiAgfVxuICBpZiAob3B0aW9ucy5hbHBoYVRlc3QpIHtcbiAgICBrZXkgKz0gXCJfYXRzdFwiO1xuICB9XG4gIGlmIChvcHRpb25zLnZlcnRleENvbG9ycykge1xuICAgIGtleSArPSBcIl92Y29sXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMuZGlmZnVzZU1hcCkge1xuICAgIGtleSArPSBcIl9kaWZmXCI7XG4gIH1cbiAgcmV0dXJuIGtleTtcbn0sIGNyZWF0ZVNoYWRlckRlZmluaXRpb246ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBhdHRyaWJ1dGVzID0ge3ZlcnRleF9wb3NpdGlvbjpwYy5TRU1BTlRJQ19QT1NJVElPTn07XG4gIGlmIChvcHRpb25zLnNraW4pIHtcbiAgICBhdHRyaWJ1dGVzLnZlcnRleF9ib25lV2VpZ2h0cyA9IHBjLlNFTUFOVElDX0JMRU5EV0VJR0hUO1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X2JvbmVJbmRpY2VzID0gcGMuU0VNQU5USUNfQkxFTkRJTkRJQ0VTO1xuICB9XG4gIGlmIChvcHRpb25zLnZlcnRleENvbG9ycykge1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X2NvbG9yID0gcGMuU0VNQU5USUNfQ09MT1I7XG4gIH1cbiAgaWYgKG9wdGlvbnMuZGlmZnVzZU1hcCkge1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X3RleENvb3JkMCA9IHBjLlNFTUFOVElDX1RFWENPT1JEMDtcbiAgfVxuICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICB2YXIgY29kZSA9IFwiXCI7XG4gIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybURlY2xWUztcbiAgaWYgKG9wdGlvbnMuc2tpbikge1xuICAgIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5za2luQ29kZShkZXZpY2UpO1xuICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNraW5uZWRWUztcbiAgfSBlbHNlIHtcbiAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1WUztcbiAgfVxuICBpZiAob3B0aW9ucy52ZXJ0ZXhDb2xvcnMpIHtcbiAgICBjb2RlICs9IFwiYXR0cmlidXRlIHZlYzQgdmVydGV4X2NvbG9yO1xcblwiO1xuICAgIGNvZGUgKz0gXCJ2YXJ5aW5nIHZlYzQgdkNvbG9yO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLmRpZmZ1c2VNYXApIHtcbiAgICBjb2RlICs9IFwiYXR0cmlidXRlIHZlYzIgdmVydGV4X3RleENvb3JkMDtcXG5cIjtcbiAgICBjb2RlICs9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxuXCI7XG4gIH1cbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmJlZ2luKCk7XG4gIGNvZGUgKz0gXCIgICBnbF9Qb3NpdGlvbiA9IGdldFBvc2l0aW9uKCk7XFxuXCI7XG4gIGlmIChvcHRpb25zLnZlcnRleENvbG9ycykge1xuICAgIGNvZGUgKz0gXCIgICAgdkNvbG9yID0gdmVydGV4X2NvbG9yO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLmRpZmZ1c2VNYXApIHtcbiAgICBjb2RlICs9IFwiICAgIHZVdjAgPSB2ZXJ0ZXhfdGV4Q29vcmQwO1xcblwiO1xuICB9XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5lbmQoKTtcbiAgdmFyIHZzaGFkZXIgPSBjb2RlO1xuICBjb2RlID0gcGMucHJvZ3JhbWxpYi5wcmVjaXNpb25Db2RlKGRldmljZSk7XG4gIGlmIChvcHRpb25zLnZlcnRleENvbG9ycykge1xuICAgIGNvZGUgKz0gXCJ2YXJ5aW5nIHZlYzQgdkNvbG9yO1xcblwiO1xuICB9IGVsc2Uge1xuICAgIGNvZGUgKz0gXCJ1bmlmb3JtIHZlYzQgdUNvbG9yO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLmRpZmZ1c2VNYXApIHtcbiAgICBjb2RlICs9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxuXCI7XG4gICAgY29kZSArPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfZGlmZnVzZU1hcDtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5mb2cpIHtcbiAgICBjb2RlICs9IHBjLnByb2dyYW1saWIuZm9nQ29kZShvcHRpb25zLmZvZyk7XG4gIH1cbiAgaWYgKG9wdGlvbnMuYWxwaGF0ZXN0KSB7XG4gICAgY29kZSArPSBjaHVua3MuYWxwaGFUZXN0UFM7XG4gIH1cbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmJlZ2luKCk7XG4gIGlmIChvcHRpb25zLnZlcnRleENvbG9ycykge1xuICAgIGNvZGUgKz0gXCIgICAgZ2xfRnJhZ0NvbG9yID0gdkNvbG9yO1xcblwiO1xuICB9IGVsc2Uge1xuICAgIGNvZGUgKz0gXCIgICAgZ2xfRnJhZ0NvbG9yID0gdUNvbG9yO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLmRpZmZ1c2VNYXApIHtcbiAgICBjb2RlICs9IFwiICAgIGdsX0ZyYWdDb2xvciAqPSB0ZXh0dXJlMkQodGV4dHVyZV9kaWZmdXNlTWFwLCB2VXYwKTtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5hbHBoYXRlc3QpIHtcbiAgICBjb2RlICs9IFwiICAgYWxwaGFUZXN0KGdsX0ZyYWdDb2xvci5hKTtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5mb2cpIHtcbiAgICBjb2RlICs9IFwiICAgZ2xGcmFnQ29sb3IucmdiID0gYWRkRm9nKGdsX0ZyYWdDb2xvci5yZ2IpO1xcblwiO1xuICB9XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5lbmQoKTtcbiAgdmFyIGZzaGFkZXIgPSBjb2RlO1xuICByZXR1cm4ge2F0dHJpYnV0ZXM6YXR0cmlidXRlcywgdnNoYWRlcjp2c2hhZGVyLCBmc2hhZGVyOmZzaGFkZXJ9O1xufX07XG5wYy5wcm9ncmFtbGliLmRlcHRoID0ge2dlbmVyYXRlS2V5OmZ1bmN0aW9uKGRldmljZSwgb3B0aW9ucykge1xuICB2YXIga2V5ID0gXCJkZXB0aFwiO1xuICBpZiAob3B0aW9ucy5za2luKSB7XG4gICAga2V5ICs9IFwiX3NraW5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAga2V5ICs9IFwiX29wYW1cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5pbnN0YW5jaW5nKSB7XG4gICAga2V5ICs9IFwiX2luc3RcIjtcbiAgfVxuICByZXR1cm4ga2V5O1xufSwgY3JlYXRlU2hhZGVyRGVmaW5pdGlvbjpmdW5jdGlvbihkZXZpY2UsIG9wdGlvbnMpIHtcbiAgdmFyIGF0dHJpYnV0ZXMgPSB7dmVydGV4X3Bvc2l0aW9uOnBjLlNFTUFOVElDX1BPU0lUSU9OfTtcbiAgaWYgKG9wdGlvbnMuc2tpbikge1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X2JvbmVXZWlnaHRzID0gcGMuU0VNQU5USUNfQkxFTkRXRUlHSFQ7XG4gICAgYXR0cmlidXRlcy52ZXJ0ZXhfYm9uZUluZGljZXMgPSBwYy5TRU1BTlRJQ19CTEVORElORElDRVM7XG4gIH1cbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X3RleENvb3JkMCA9IHBjLlNFTUFOVElDX1RFWENPT1JEMDtcbiAgfVxuICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICB2YXIgY29kZSA9IFwiXCI7XG4gIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybURlY2xWUztcbiAgaWYgKG9wdGlvbnMuc2tpbikge1xuICAgIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5za2luQ29kZShkZXZpY2UpO1xuICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNraW5uZWRWUztcbiAgfSBlbHNlIHtcbiAgICBpZiAob3B0aW9ucy5pbnN0YW5jaW5nKSB7XG4gICAgICBhdHRyaWJ1dGVzLmluc3RhbmNlX2xpbmUxID0gcGMuU0VNQU5USUNfVEVYQ09PUkQyO1xuICAgICAgYXR0cmlidXRlcy5pbnN0YW5jZV9saW5lMiA9IHBjLlNFTUFOVElDX1RFWENPT1JEMztcbiAgICAgIGF0dHJpYnV0ZXMuaW5zdGFuY2VfbGluZTMgPSBwYy5TRU1BTlRJQ19URVhDT09SRDQ7XG4gICAgICBhdHRyaWJ1dGVzLmluc3RhbmNlX2xpbmU0ID0gcGMuU0VNQU5USUNfVEVYQ09PUkQ1O1xuICAgICAgY29kZSArPSBjaHVua3MuaW5zdGFuY2luZ1ZTO1xuICAgICAgY29kZSArPSBjaHVua3MudHJhbnNmb3JtSW5zdGFuY2VkVlM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcHRpb25zLnNjcmVlblNwYWNlKSB7XG4gICAgICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNjcmVlblNwYWNlVlM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1WUztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCJhdHRyaWJ1dGUgdmVjMiB2ZXJ0ZXhfdGV4Q29vcmQwO1xcblxcblwiO1xuICAgIGNvZGUgKz0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG5cXG5cIjtcbiAgfVxuICBjb2RlICs9IFwidmFyeWluZyBmbG9hdCB2RGVwdGg7XFxuXCI7XG4gIGNvZGUgKz0gXCJ1bmlmb3JtIG1hdDQgbWF0cml4X3ZpZXc7XFxuXCI7XG4gIGNvZGUgKz0gXCJ1bmlmb3JtIGZsb2F0IGNhbWVyYV9mYXI7XFxuXFxuXCI7XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5iZWdpbigpO1xuICBjb2RlICs9IFwiICAgZ2xfUG9zaXRpb24gPSBnZXRQb3NpdGlvbigpO1xcblwiO1xuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgY29kZSArPSBcIiAgICB2VXYwID0gdmVydGV4X3RleENvb3JkMDtcXG5cIjtcbiAgfVxuICBjb2RlICs9IFwiICAgIHZEZXB0aCA9IC0obWF0cml4X3ZpZXcgKiB2ZWM0KGdldFdvcmxkUG9zaXRpb24oKSwxLjApKS56IC8gY2FtZXJhX2ZhcjtcXG5cIjtcbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmVuZCgpO1xuICB2YXIgdnNoYWRlciA9IGNvZGU7XG4gIGNvZGUgPSBwYy5wcm9ncmFtbGliLnByZWNpc2lvbkNvZGUoZGV2aWNlKTtcbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG5cXG5cIjtcbiAgICBjb2RlICs9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9vcGFjaXR5TWFwO1xcblxcblwiO1xuICAgIGNvZGUgKz0gY2h1bmtzLmFscGhhVGVzdFBTO1xuICB9XG4gIGNvZGUgKz0gXCJ2YXJ5aW5nIGZsb2F0IHZEZXB0aDtcXG5cXG5cIjtcbiAgY29kZSArPSBcInZlYzQgcGFja0Zsb2F0KGZsb2F0IGRlcHRoKVxcblwiO1xuICBjb2RlICs9IFwie1xcblwiO1xuICBjb2RlICs9IFwiICAgIGNvbnN0IHZlYzQgYml0X3NoaWZ0ID0gdmVjNCgyNTYuMCAqIDI1Ni4wICogMjU2LjAsIDI1Ni4wICogMjU2LjAsIDI1Ni4wLCAxLjApO1xcblwiO1xuICBjb2RlICs9IFwiICAgIGNvbnN0IHZlYzQgYml0X21hc2sgID0gdmVjNCgwLjAsIDEuMCAvIDI1Ni4wLCAxLjAgLyAyNTYuMCwgMS4wIC8gMjU2LjApO1xcblwiO1xuICBjb2RlICs9IFwiICAgIHZlYzQgcmVzID0gbW9kKGRlcHRoICogYml0X3NoaWZ0ICogdmVjNCgyNTUpLCB2ZWM0KDI1NikgKSAvIHZlYzQoMjU1KTtcXG5cIjtcbiAgY29kZSArPSBcIiAgICByZXMgLT0gcmVzLnh4eXogKiBiaXRfbWFzaztcXG5cIjtcbiAgY29kZSArPSBcIiAgICByZXR1cm4gcmVzO1xcblwiO1xuICBjb2RlICs9IFwifVxcblxcblwiO1xuICBjb2RlICs9IHBjLnByb2dyYW1saWIuYmVnaW4oKTtcbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCIgICAgYWxwaGFUZXN0KHRleHR1cmUyRCh0ZXh0dXJlX29wYWNpdHlNYXAsIHZVdjApLlwiICsgb3B0aW9ucy5vcGFjaXR5Q2hhbm5lbFswXSArIFwiICk7XFxuXFxuXCI7XG4gIH1cbiAgY29kZSArPSBcImZsb2F0IGRlcHRoID0gdkRlcHRoO1xcblwiO1xuICBjb2RlICs9IFwiZ2xfRnJhZ0NvbG9yID0gcGFja0Zsb2F0KGRlcHRoKTtcXG5cIjtcbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmVuZCgpO1xuICB2YXIgZnNoYWRlciA9IGNvZGU7XG4gIHJldHVybiB7YXR0cmlidXRlczphdHRyaWJ1dGVzLCB2c2hhZGVyOnZzaGFkZXIsIGZzaGFkZXI6ZnNoYWRlcn07XG59fTtcbnBjLnByb2dyYW1saWIuZGVwdGhyZ2JhID0ge2hhc2hDb2RlOmZ1bmN0aW9uKHN0cikge1xuICB2YXIgaGFzaCA9IDA7XG4gIGlmIChzdHIubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIGhhc2g7XG4gIH1cbiAgZm9yICh2YXIgaSA9IDA7aSA8IHN0ci5sZW5ndGg7aSsrKSB7XG4gICAgdmFyIGNoYXIgPSBzdHIuY2hhckNvZGVBdChpKTtcbiAgICBoYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hhcjtcbiAgICBoYXNoID0gaGFzaCAmIGhhc2g7XG4gIH1cbiAgcmV0dXJuIGhhc2g7XG59LCBnZW5lcmF0ZUtleTpmdW5jdGlvbihkZXZpY2UsIG9wdGlvbnMpIHtcbiAgdmFyIGtleSA9IFwiZGVwdGhyZ2JhXCI7XG4gIGlmIChvcHRpb25zLnNraW4pIHtcbiAgICBrZXkgKz0gXCJfc2tpblwiO1xuICB9XG4gIGlmIChvcHRpb25zLm9wYWNpdHlNYXApIHtcbiAgICBrZXkgKz0gXCJfb3BhbVwiICsgb3B0aW9ucy5vcGFjaXR5Q2hhbm5lbDtcbiAgfVxuICBpZiAob3B0aW9ucy50eXBlKSB7XG4gICAga2V5ICs9IG9wdGlvbnMudHlwZTtcbiAgfVxuICBpZiAob3B0aW9ucy5pbnN0YW5jaW5nKSB7XG4gICAga2V5ICs9IFwiX2luc3RcIjtcbiAgfVxuICBrZXkgKz0gXCJfXCIgKyBvcHRpb25zLnNoYWRvd1R5cGU7XG4gIGlmIChvcHRpb25zLmNodW5rcykge1xuICAgIHZhciBzdHIgPSBcIlwiO1xuICAgIGZvciAodmFyIHAgaW4gb3B0aW9ucy5jaHVua3MpIHtcbiAgICAgIGlmIChvcHRpb25zLmNodW5rcy5oYXNPd25Qcm9wZXJ0eShwKSkge1xuICAgICAgICBzdHIgKz0gcCArIG9wdGlvbnMuY2h1bmtzW3BdO1xuICAgICAgfVxuICAgIH1cbiAgICBrZXkgKz0gdGhpcy5oYXNoQ29kZShzdHIpO1xuICB9XG4gIHJldHVybiBrZXk7XG59LCBjcmVhdGVTaGFkZXJEZWZpbml0aW9uOmZ1bmN0aW9uKGRldmljZSwgb3B0aW9ucykge1xuICB2YXIgYXR0cmlidXRlcyA9IHt2ZXJ0ZXhfcG9zaXRpb246cGMuU0VNQU5USUNfUE9TSVRJT059O1xuICBpZiAob3B0aW9ucy5za2luKSB7XG4gICAgYXR0cmlidXRlcy52ZXJ0ZXhfYm9uZVdlaWdodHMgPSBwYy5TRU1BTlRJQ19CTEVORFdFSUdIVDtcbiAgICBhdHRyaWJ1dGVzLnZlcnRleF9ib25lSW5kaWNlcyA9IHBjLlNFTUFOVElDX0JMRU5ESU5ESUNFUztcbiAgfVxuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgYXR0cmlidXRlcy52ZXJ0ZXhfdGV4Q29vcmQwID0gcGMuU0VNQU5USUNfVEVYQ09PUkQwO1xuICB9XG4gIHZhciBjaHVua3MgPSBwYy5zaGFkZXJDaHVua3M7XG4gIGlmIChvcHRpb25zLmNodW5rcykge1xuICAgIHZhciBjdXN0b21DaHVua3MgPSBbXTtcbiAgICBmb3IgKHZhciBwIGluIGNodW5rcykge1xuICAgICAgaWYgKGNodW5rcy5oYXNPd25Qcm9wZXJ0eShwKSkge1xuICAgICAgICBpZiAoIW9wdGlvbnMuY2h1bmtzW3BdKSB7XG4gICAgICAgICAgY3VzdG9tQ2h1bmtzW3BdID0gY2h1bmtzW3BdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGN1c3RvbUNodW5rc1twXSA9IG9wdGlvbnMuY2h1bmtzW3BdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNodW5rcyA9IGN1c3RvbUNodW5rcztcbiAgfVxuICB2YXIgY29kZSA9IFwiXCI7XG4gIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybURlY2xWUztcbiAgaWYgKG9wdGlvbnMuY2h1bmtzICYmIG9wdGlvbnMuYXR0cmlidXRlcykge1xuICAgIGZvciAodmFyIHAgaW4gb3B0aW9ucy5hdHRyaWJ1dGVzKSB7XG4gICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHApKSB7XG4gICAgICAgIGF0dHJpYnV0ZXNbcF0gPSBvcHRpb25zLmF0dHJpYnV0ZXNbcF07XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHZhciB1dkFkZGVkID0gZmFsc2U7XG4gIGlmIChhdHRyaWJ1dGVzLnZlcnRleF9ub3JtYWwpIHtcbiAgICBjb2RlICs9IFwiYXR0cmlidXRlIHZlYzMgdmVydGV4X25vcm1hbDtcXG5cIjtcbiAgfVxuICBpZiAoYXR0cmlidXRlcy52ZXJ0ZXhfdGFuZ2VudCkge1xuICAgIGNvZGUgKz0gXCJhdHRyaWJ1dGUgdmVjNCB2ZXJ0ZXhfdGFuZ2VudDtcXG5cIjtcbiAgfVxuICBpZiAoYXR0cmlidXRlcy52ZXJ0ZXhfdGV4Q29vcmQwKSB7XG4gICAgdXZBZGRlZCA9IHRydWU7XG4gICAgY29kZSArPSBcImF0dHJpYnV0ZSB2ZWMyIHZlcnRleF90ZXhDb29yZDA7XFxuXCI7XG4gIH1cbiAgaWYgKGF0dHJpYnV0ZXMudmVydGV4X3RleENvb3JkMSkge1xuICAgIGNvZGUgKz0gXCJhdHRyaWJ1dGUgdmVjMiB2ZXJ0ZXhfdGV4Q29vcmQxO1xcblwiO1xuICB9XG4gIGlmIChhdHRyaWJ1dGVzLnZlcnRleF9jb2xvcikge1xuICAgIGNvZGUgKz0gXCJhdHRyaWJ1dGUgdmVjNCB2ZXJ0ZXhfY29sb3I7XFxuXCI7XG4gIH1cbiAgaWYgKCFvcHRpb25zLnNraW4gJiYgYXR0cmlidXRlcy52ZXJ0ZXhfYm9uZVdlaWdodHMpIHtcbiAgICBjb2RlICs9IFwiYXR0cmlidXRlIHZlYzQgdmVydGV4X2JvbmVXZWlnaHRzO1xcblwiO1xuICB9XG4gIGlmICghb3B0aW9ucy5za2luICYmIGF0dHJpYnV0ZXMudmVydGV4X2JvbmVJbmRpY2VzKSB7XG4gICAgY29kZSArPSBcImF0dHJpYnV0ZSB2ZWM0IHZlcnRleF9ib25lSW5kaWNlcztcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5za2luKSB7XG4gICAgY29kZSArPSBwYy5wcm9ncmFtbGliLnNraW5Db2RlKGRldmljZSwgY2h1bmtzKTtcbiAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1Ta2lubmVkVlM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKG9wdGlvbnMuaW5zdGFuY2luZykge1xuICAgICAgYXR0cmlidXRlcy5pbnN0YW5jZV9saW5lMSA9IHBjLlNFTUFOVElDX1RFWENPT1JEMjtcbiAgICAgIGF0dHJpYnV0ZXMuaW5zdGFuY2VfbGluZTIgPSBwYy5TRU1BTlRJQ19URVhDT09SRDM7XG4gICAgICBhdHRyaWJ1dGVzLmluc3RhbmNlX2xpbmUzID0gcGMuU0VNQU5USUNfVEVYQ09PUkQ0O1xuICAgICAgYXR0cmlidXRlcy5pbnN0YW5jZV9saW5lNCA9IHBjLlNFTUFOVElDX1RFWENPT1JENTtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLmluc3RhbmNpbmdWUztcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybUluc3RhbmNlZFZTO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAob3B0aW9ucy5zY3JlZW5TcGFjZSkge1xuICAgICAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1TY3JlZW5TcGFjZVZTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MudHJhbnNmb3JtVlM7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChvcHRpb25zLm9wYWNpdHlNYXApIHtcbiAgICBpZiAoIXV2QWRkZWQpIHtcbiAgICAgIGNvZGUgKz0gXCJhdHRyaWJ1dGUgdmVjMiB2ZXJ0ZXhfdGV4Q29vcmQwO1xcblxcblwiO1xuICAgIH1cbiAgICBjb2RlICs9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxuXFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMudHlwZSAhPT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgY29kZSArPSBcInZhcnlpbmcgdmVjMyB3b3JsZFBvcztcXG5cXG5cIjtcbiAgfVxuICBjb2RlICs9IHBjLnByb2dyYW1saWIuYmVnaW4oKTtcbiAgY29kZSArPSBcIiAgIGdsX1Bvc2l0aW9uID0gZ2V0UG9zaXRpb24oKTtcXG5cIjtcbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCIgICAgdlV2MCA9IHZlcnRleF90ZXhDb29yZDA7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMudHlwZSAhPT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgY29kZSArPSBcIiAgICB3b3JsZFBvcyA9IGRQb3NpdGlvblc7XFxuXCI7XG4gIH1cbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmVuZCgpO1xuICB2YXIgdnNoYWRlciA9IGNvZGU7XG4gIGNvZGUgPSBcIlwiO1xuICBpZiAoZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMgJiYgIWRldmljZS53ZWJnbDIpIHtcbiAgICBjb2RlICs9IFwiI2V4dGVuc2lvbiBHTF9PRVNfc3RhbmRhcmRfZGVyaXZhdGl2ZXMgOiBlbmFibGVcXG5cXG5cIjtcbiAgfVxuICBjb2RlICs9IHBjLnByb2dyYW1saWIucHJlY2lzaW9uQ29kZShkZXZpY2UpO1xuICBpZiAoZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMgJiYgIWRldmljZS53ZWJnbDIpIHtcbiAgICBjb2RlICs9IFwidW5pZm9ybSB2ZWMyIHBvbHlnb25PZmZzZXQ7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMuc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1ZTTTMyKSB7XG4gICAgaWYgKGRldmljZS5leHRUZXh0dXJlRmxvYXRIaWdoUHJlY2lzaW9uKSB7XG4gICAgICBjb2RlICs9IFwiI2RlZmluZSBWU01fRVhQT05FTlQgMTUuMFxcblxcblwiO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2RlICs9IFwiI2RlZmluZSBWU01fRVhQT05FTlQgNS41NFxcblxcblwiO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAob3B0aW9ucy5zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNMTYpIHtcbiAgICAgIGNvZGUgKz0gXCIjZGVmaW5lIFZTTV9FWFBPTkVOVCA1LjU0XFxuXFxuXCI7XG4gICAgfVxuICB9XG4gIGlmIChvcHRpb25zLm9wYWNpdHlNYXApIHtcbiAgICBjb2RlICs9IFwidmFyeWluZyB2ZWMyIHZVdjA7XFxuXCI7XG4gICAgY29kZSArPSBcInVuaWZvcm0gc2FtcGxlcjJEIHRleHR1cmVfb3BhY2l0eU1hcDtcXG5cIjtcbiAgICBjb2RlICs9IGNodW5rcy5hbHBoYVRlc3RQUztcbiAgfVxuICBpZiAob3B0aW9ucy50eXBlICE9PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwpIHtcbiAgICBjb2RlICs9IFwidmFyeWluZyB2ZWMzIHdvcmxkUG9zO1xcblwiO1xuICAgIGNvZGUgKz0gXCJ1bmlmb3JtIHZlYzMgdmlld19wb3NpdGlvbjtcXG5cIjtcbiAgICBjb2RlICs9IFwidW5pZm9ybSBmbG9hdCBsaWdodF9yYWRpdXM7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMuc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1BDRjMgJiYgKCFkZXZpY2Uud2ViZ2wyIHx8IG9wdGlvbnMudHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSkge1xuICAgIGNvZGUgKz0gY2h1bmtzLnBhY2tEZXB0aFBTO1xuICB9IGVsc2Uge1xuICAgIGlmIChvcHRpb25zLnNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19WU004KSB7XG4gICAgICBjb2RlICs9IFwidmVjMiBlbmNvZGVGbG9hdFJHKCBmbG9hdCB2ICkge1xcblwiO1xuICAgICAgY29kZSArPSBcIiAgICB2ZWMyIGVuYyA9IHZlYzIoMS4wLCAyNTUuMCkgKiB2O1xcblwiO1xuICAgICAgY29kZSArPSBcIiAgICBlbmMgPSBmcmFjdChlbmMpO1xcblwiO1xuICAgICAgY29kZSArPSBcIiAgICBlbmMgLT0gZW5jLnl5ICogdmVjMigxLjAvMjU1LjAsIDEuMC8yNTUuMCk7XFxuXCI7XG4gICAgICBjb2RlICs9IFwiICAgIHJldHVybiBlbmM7XFxuXCI7XG4gICAgICBjb2RlICs9IFwifVxcblxcblwiO1xuICAgIH1cbiAgfVxuICBjb2RlICs9IHBjLnByb2dyYW1saWIuYmVnaW4oKTtcbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCIgICAgYWxwaGFUZXN0KCB0ZXh0dXJlMkQodGV4dHVyZV9vcGFjaXR5TWFwLCB2VXYwKS5cIiArIG9wdGlvbnMub3BhY2l0eUNoYW5uZWwgKyBcIiApO1xcblxcblwiO1xuICB9XG4gIHZhciBpc1ZzbSA9IG9wdGlvbnMuc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1ZTTTggfHwgb3B0aW9ucy5zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNMTYgfHwgb3B0aW9ucy5zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNMzI7XG4gIGlmIChvcHRpb25zLnR5cGUgPT09IHBjLkxJR0hUVFlQRV9QT0lOVCB8fCBpc1ZzbSAmJiBvcHRpb25zLnR5cGUgIT09IHBjLkxJR0hUVFlQRV9ESVJFQ1RJT05BTCkge1xuICAgIGNvZGUgKz0gXCIgICBmbG9hdCBkZXB0aCA9IG1pbihkaXN0YW5jZSh2aWV3X3Bvc2l0aW9uLCB3b3JsZFBvcykgLyBsaWdodF9yYWRpdXMsIDAuOTk5OTkpO1xcblwiO1xuICB9IGVsc2Uge1xuICAgIGNvZGUgKz0gXCIgICBmbG9hdCBkZXB0aCA9IGdsX0ZyYWdDb29yZC56O1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLnNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19QQ0YzICYmICghZGV2aWNlLndlYmdsMiB8fCBvcHRpb25zLnR5cGUgPT09IHBjLkxJR0hUVFlQRV9QT0lOVCkpIHtcbiAgICBpZiAoZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMgJiYgIWRldmljZS53ZWJnbDIpIHtcbiAgICAgIGNvZGUgKz0gXCIgICBmbG9hdCBtaW5WYWx1ZSA9IDIuMzM3NDM3MDUwMDE1MzE4NmUtMTA7IC8vKDEuMCAvIDI1NS4wKSAvICgyNTYuMCAqIDI1Ni4wICogMjU2LjApO1xcblwiO1xuICAgICAgY29kZSArPSBcIiAgIGRlcHRoICs9IHBvbHlnb25PZmZzZXQueCAqIG1heChhYnMoZEZkeChkZXB0aCkpLCBhYnMoZEZkeShkZXB0aCkpKSArIG1pblZhbHVlICogcG9seWdvbk9mZnNldC55O1xcblwiO1xuICAgICAgY29kZSArPSBcIiAgIGdsX0ZyYWdEYXRhWzBdID0gcGFja0Zsb2F0KGRlcHRoKTtcXG5cIjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBcIiAgIGdsX0ZyYWdEYXRhWzBdID0gcGFja0Zsb2F0KGRlcHRoKTtcXG5cIjtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKG9wdGlvbnMuc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1BDRjMgfHwgb3B0aW9ucy5zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfUENGNSkge1xuICAgICAgY29kZSArPSBcIiAgIGdsX0ZyYWdEYXRhWzBdID0gdmVjNCgxLjApO1xcblwiO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAob3B0aW9ucy5zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNOCkge1xuICAgICAgICBjb2RlICs9IFwiICAgZ2xfRnJhZ0NvbG9yID0gdmVjNChlbmNvZGVGbG9hdFJHKGRlcHRoKSwgZW5jb2RlRmxvYXRSRyhkZXB0aCpkZXB0aCkpO1xcblwiO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBjaHVua3Muc3RvcmVFVlNNUFM7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5lbmQoKTtcbiAgdmFyIGZzaGFkZXIgPSBjb2RlO1xuICByZXR1cm4ge2F0dHJpYnV0ZXM6YXR0cmlidXRlcywgdnNoYWRlcjp2c2hhZGVyLCBmc2hhZGVyOmZzaGFkZXJ9O1xufX07XG5wYy5wcm9ncmFtbGliLnBhcnRpY2xlID0ge2dlbmVyYXRlS2V5OmZ1bmN0aW9uKGRldmljZSwgb3B0aW9ucykge1xuICB2YXIga2V5ID0gXCJwYXJ0aWNsZVwiO1xuICBmb3IgKHZhciBwcm9wIGluIG9wdGlvbnMpIHtcbiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAga2V5ICs9IG9wdGlvbnNbcHJvcF07XG4gICAgfVxuICB9XG4gIHJldHVybiBrZXk7XG59LCBfYW5pbVRleDpmdW5jdGlvbihvcHRpb25zLCBjaHVuaykge1xuICB2YXIgdnNoYWRlciA9IFwiXCI7XG4gIHZzaGFkZXIgKz0gb3B0aW9ucy5hbmltVGV4TG9vcCA/IGNodW5rLnBhcnRpY2xlQW5pbUZyYW1lTG9vcFZTIDogY2h1bmsucGFydGljbGVBbmltRnJhbWVDbGFtcFZTO1xuICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlQW5pbVRleFZTO1xuICByZXR1cm4gdnNoYWRlcjtcbn0sIGNyZWF0ZVNoYWRlckRlZmluaXRpb246ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBjaHVuayA9IHBjLnNoYWRlckNodW5rcztcbiAgdmFyIHZzaGFkZXIgPSBcIlwiO1xuICB2YXIgZnNoYWRlciA9IHBjLnByb2dyYW1saWIucHJlY2lzaW9uQ29kZShkZXZpY2UpICsgXCJcXG5cIjtcbiAgaWYgKG9wdGlvbnMuYW5pbVRleCkge1xuICAgIHZzaGFkZXIgKz0gXCJcXG51bmlmb3JtIHZlYzQgYW5pbVRleFBhcmFtcztcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5ub3JtYWwgPT0gMikge1xuICAgIHZzaGFkZXIgKz0gXCJcXG52YXJ5aW5nIG1hdDMgUGFydGljbGVNYXQ7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMubm9ybWFsID09IDEpIHtcbiAgICB2c2hhZGVyICs9IFwiXFxudmFyeWluZyB2ZWMzIE5vcm1hbDtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5zb2Z0KSB7XG4gICAgdnNoYWRlciArPSBcIlxcbnZhcnlpbmcgZmxvYXQgdkRlcHRoO1xcblwiO1xuICB9XG4gIGlmICghb3B0aW9ucy51c2VDcHUpIHtcbiAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX2luaXRWUztcbiAgICB2c2hhZGVyICs9IG9wdGlvbnMucGFjazggPyBjaHVuay5wYXJ0aWNsZUlucHV0UmdiYThQUyA6IGNodW5rLnBhcnRpY2xlSW5wdXRGbG9hdFBTO1xuICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVWUztcbiAgICBpZiAob3B0aW9ucy5sb2NhbFNwYWNlKSB7XG4gICAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX2xvY2FsU2hpZnRWUztcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuYW5pbVRleCkge1xuICAgICAgdnNoYWRlciArPSB0aGlzLl9hbmltVGV4KG9wdGlvbnMsIGNodW5rKTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMud3JhcCkge1xuICAgICAgdnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV93cmFwVlM7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmFsaWduVG9Nb3Rpb24pIHtcbiAgICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfcG9pbnRBbG9uZ1ZTO1xuICAgIH1cbiAgICB2c2hhZGVyICs9IG9wdGlvbnMubWVzaCA/IGNodW5rLnBhcnRpY2xlX21lc2hWUyA6IGNodW5rLnBhcnRpY2xlX2JpbGxib2FyZFZTO1xuICAgIGlmIChvcHRpb25zLm5vcm1hbCA9PSAxKSB7XG4gICAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX25vcm1hbFZTO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5ub3JtYWwgPT0gMikge1xuICAgICAgdnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9UQk5WUztcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuc3RyZXRjaCA+IDAuMCkge1xuICAgICAgdnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9zdHJldGNoVlM7XG4gICAgfVxuICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfZW5kVlM7XG4gICAgaWYgKG9wdGlvbnMuc29mdCA+IDApIHtcbiAgICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfc29mdFZTO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX2NwdVZTO1xuICAgIGlmIChvcHRpb25zLmxvY2FsU3BhY2UpIHtcbiAgICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfbG9jYWxTaGlmdFZTO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5hbmltVGV4KSB7XG4gICAgICB2c2hhZGVyICs9IHRoaXMuX2FuaW1UZXgob3B0aW9ucywgY2h1bmspO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5hbGlnblRvTW90aW9uKSB7XG4gICAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX3BvaW50QWxvbmdWUztcbiAgICB9XG4gICAgdnNoYWRlciArPSBvcHRpb25zLm1lc2ggPyBjaHVuay5wYXJ0aWNsZV9tZXNoVlMgOiBjaHVuay5wYXJ0aWNsZV9iaWxsYm9hcmRWUztcbiAgICBpZiAob3B0aW9ucy5ub3JtYWwgPT0gMSkge1xuICAgICAgdnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9ub3JtYWxWUztcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMubm9ybWFsID09IDIpIHtcbiAgICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfVEJOVlM7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnN0cmV0Y2ggPiAwLjApIHtcbiAgICAgIHZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfc3RyZXRjaFZTO1xuICAgIH1cbiAgICB2c2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX2NwdV9lbmRWUztcbiAgICBpZiAob3B0aW9ucy5zb2Z0ID4gMCkge1xuICAgICAgdnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9zb2Z0VlM7XG4gICAgfVxuICB9XG4gIHZzaGFkZXIgKz0gXCJ9XFxuXCI7XG4gIGlmIChvcHRpb25zLm5vcm1hbCA+IDApIHtcbiAgICBpZiAob3B0aW9ucy5ub3JtYWwgPT0gMSkge1xuICAgICAgZnNoYWRlciArPSBcIlxcbnZhcnlpbmcgdmVjMyBOb3JtYWw7XFxuXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcHRpb25zLm5vcm1hbCA9PSAyKSB7XG4gICAgICAgIGZzaGFkZXIgKz0gXCJcXG52YXJ5aW5nIG1hdDMgUGFydGljbGVNYXQ7XFxuXCI7XG4gICAgICB9XG4gICAgfVxuICAgIGZzaGFkZXIgKz0gXCJcXG51bmlmb3JtIHZlYzMgbGlnaHRDdWJlWzZdO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLnNvZnQpIHtcbiAgICBmc2hhZGVyICs9IFwiXFxudmFyeWluZyBmbG9hdCB2RGVwdGg7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMubm9ybWFsID09PSAwICYmIG9wdGlvbnMuZm9nID09PSBcIm5vbmVcIikge1xuICAgIG9wdGlvbnMuc3JnYiA9IGZhbHNlO1xuICB9XG4gIGZzaGFkZXIgKz0gcGMucHJvZ3JhbWxpYi5nYW1tYUNvZGUob3B0aW9ucy5nYW1tYSk7XG4gIGZzaGFkZXIgKz0gcGMucHJvZ3JhbWxpYi50b25lbWFwQ29kZShvcHRpb25zLnRvbmVNYXApO1xuICBpZiAob3B0aW9ucy5mb2cgPT09IFwibGluZWFyXCIpIHtcbiAgICBmc2hhZGVyICs9IGNodW5rLmZvZ0xpbmVhclBTO1xuICB9IGVsc2Uge1xuICAgIGlmIChvcHRpb25zLmZvZyA9PT0gXCJleHBcIikge1xuICAgICAgZnNoYWRlciArPSBjaHVuay5mb2dFeHBQUztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG9wdGlvbnMuZm9nID09PSBcImV4cDJcIikge1xuICAgICAgICBmc2hhZGVyICs9IGNodW5rLmZvZ0V4cDJQUztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZzaGFkZXIgKz0gY2h1bmsuZm9nTm9uZVBTO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5ub3JtYWwgPT0gMikge1xuICAgIGZzaGFkZXIgKz0gXCJcXG51bmlmb3JtIHNhbXBsZXIyRCBub3JtYWxNYXA7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMuc29mdCA+IDApIHtcbiAgICBmc2hhZGVyICs9IFwiXFxudW5pZm9ybSBzYW1wbGVyMkQgdURlcHRoTWFwO1xcbiB1bmlmb3JtIHZlYzQgdVNjcmVlblNpemU7XFxuXCI7XG4gIH1cbiAgZnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZVBTO1xuICBpZiAob3B0aW9ucy5zb2Z0ID4gMCkge1xuICAgIGZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfc29mdFBTO1xuICB9XG4gIGlmIChvcHRpb25zLm5vcm1hbCA9PSAxKSB7XG4gICAgZnNoYWRlciArPSBcIlxcbnZlYzMgbm9ybWFsID0gTm9ybWFsO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLm5vcm1hbCA9PSAyKSB7XG4gICAgZnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9ub3JtYWxNYXBQUztcbiAgfVxuICBpZiAob3B0aW9ucy5ub3JtYWwgPiAwKSB7XG4gICAgZnNoYWRlciArPSBvcHRpb25zLmhhbGZsYW1iZXJ0ID8gY2h1bmsucGFydGljbGVfaGFsZmxhbWJlcnRQUyA6IGNodW5rLnBhcnRpY2xlX2xhbWJlcnRQUztcbiAgfVxuICBpZiAob3B0aW9ucy5ub3JtYWwgPiAwKSB7XG4gICAgZnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9saWdodGluZ1BTO1xuICB9XG4gIGlmIChvcHRpb25zLmJsZW5kID09IHBjLkJMRU5EX05PUk1BTCkge1xuICAgIGZzaGFkZXIgKz0gY2h1bmsucGFydGljbGVfYmxlbmROb3JtYWxQUztcbiAgfSBlbHNlIHtcbiAgICBpZiAob3B0aW9ucy5ibGVuZCA9PSBwYy5CTEVORF9BRERJVElWRSkge1xuICAgICAgZnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9ibGVuZEFkZFBTO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAob3B0aW9ucy5ibGVuZCA9PSBwYy5CTEVORF9NVUxUSVBMSUNBVElWRSkge1xuICAgICAgICBmc2hhZGVyICs9IGNodW5rLnBhcnRpY2xlX2JsZW5kTXVsdGlwbHlQUztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgZnNoYWRlciArPSBjaHVuay5wYXJ0aWNsZV9lbmRQUztcbiAgdmFyIGF0dHJpYnV0ZXMgPSBwYy5zaGFkZXJDaHVua3MuY29sbGVjdEF0dHJpYnModnNoYWRlcik7XG4gIHJldHVybiB7YXR0cmlidXRlczphdHRyaWJ1dGVzLCB2c2hhZGVyOnZzaGFkZXIsIGZzaGFkZXI6ZnNoYWRlcn07XG59fTtcbnBjLnByb2dyYW1saWIuc3RhbmRhcmQgPSB7aGFzaENvZGU6ZnVuY3Rpb24oc3RyKSB7XG4gIHZhciBoYXNoID0gMDtcbiAgaWYgKHN0ci5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gaGFzaDtcbiAgfVxuICBmb3IgKHZhciBpID0gMDtpIDwgc3RyLmxlbmd0aDtpKyspIHtcbiAgICB2YXIgY2hhciA9IHN0ci5jaGFyQ29kZUF0KGkpO1xuICAgIGhhc2ggPSAoaGFzaCA8PCA1KSAtIGhhc2ggKyBjaGFyO1xuICAgIGhhc2ggPSBoYXNoICYgaGFzaDtcbiAgfVxuICByZXR1cm4gaGFzaDtcbn0sIGdlbmVyYXRlS2V5OmZ1bmN0aW9uKGRldmljZSwgb3B0aW9ucykge1xuICB2YXIgcHJvcHMgPSBbXTtcbiAgdmFyIGtleSA9IFwic3RhbmRhcmRcIjtcbiAgdmFyIGxpZ2h0O1xuICBmb3IgKHZhciBwcm9wIGluIG9wdGlvbnMpIHtcbiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgaWYgKHByb3AgPT09IFwiY2h1bmtzXCIpIHtcbiAgICAgICAgZm9yICh2YXIgcCBpbiBvcHRpb25zW3Byb3BdKSB7XG4gICAgICAgICAgaWYgKG9wdGlvbnNbcHJvcF0uaGFzT3duUHJvcGVydHkocCkpIHtcbiAgICAgICAgICAgIHByb3BzLnB1c2gocCArIG9wdGlvbnMuY2h1bmtzW3BdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChvcHRpb25zW3Byb3BdKSB7XG4gICAgICAgICAgcHJvcHMucHVzaChwcm9wKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBwcm9wcy5zb3J0KCk7XG4gIGZvciAocHJvcCBpbiBwcm9wcykge1xuICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAga2V5ICs9IHByb3BzW3Byb3BdICsgb3B0aW9uc1twcm9wc1twcm9wXV07XG4gICAgfVxuICB9XG4gIGlmIChvcHRpb25zLmxpZ2h0cykge1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBvcHRpb25zLmxpZ2h0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBsaWdodCA9IG9wdGlvbnMubGlnaHRzW2ldO1xuICAgICAga2V5ICs9IGxpZ2h0LmtleTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHRoaXMuaGFzaENvZGUoa2V5KTtcbn0sIF9jb3JyZWN0Q2hhbm5lbDpmdW5jdGlvbihwLCBjaGFuKSB7XG4gIGlmIChwYy5fbWF0VGV4MkRbcF0gPiAwKSB7XG4gICAgaWYgKHBjLl9tYXRUZXgyRFtwXSA8IGNoYW4ubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gY2hhbi5zdWJzdHJpbmcoMCwgcGMuX21hdFRleDJEW3BdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBjLl9tYXRUZXgyRFtwXSA+IGNoYW4ubGVuZ3RoKSB7XG4gICAgICAgIHZhciBzdHIgPSBjaGFuO1xuICAgICAgICB2YXIgY2hyID0gc3RyLmNoYXJBdChzdHIubGVuZ3RoIC0gMSk7XG4gICAgICAgIHZhciBhZGRMZW4gPSBwYy5fbWF0VGV4MkRbcF0gLSBzdHIubGVuZ3RoO1xuICAgICAgICBmb3IgKHZhciBpID0gMDtpIDwgYWRkTGVuO2krKykge1xuICAgICAgICAgIHN0ciArPSBjaHI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNoYW47XG4gIH1cbn0sIF9zZXRNYXBUcmFuc2Zvcm06ZnVuY3Rpb24oY29kZXMsIG5hbWUsIGlkLCB1dikge1xuICBjb2Rlc1swXSArPSBcInVuaWZvcm0gdmVjNCB0ZXh0dXJlX1wiICsgbmFtZSArIFwiTWFwVHJhbnNmb3JtO1xcblwiO1xuICB2YXIgY2hlY2tJZCA9IGlkICsgdXYgKiAxMDA7XG4gIGlmICghY29kZXNbM11bY2hlY2tJZF0pIHtcbiAgICBjb2Rlc1sxXSArPSBcInZhcnlpbmcgdmVjMiB2VVZcIiArIHV2ICsgXCJfXCIgKyBpZCArIFwiO1xcblwiO1xuICAgIGNvZGVzWzJdICs9IFwiICAgdlVWXCIgKyB1diArIFwiX1wiICsgaWQgKyBcIiA9IHV2XCIgKyB1diArIFwiICogdGV4dHVyZV9cIiArIG5hbWUgKyBcIk1hcFRyYW5zZm9ybS54eSArIHRleHR1cmVfXCIgKyBuYW1lICsgXCJNYXBUcmFuc2Zvcm0uenc7XFxuXCI7XG4gICAgY29kZXNbM11bY2hlY2tJZF0gPSB0cnVlO1xuICB9XG4gIHJldHVybiBjb2Rlcztcbn0sIF91dlNvdXJjZTpmdW5jdGlvbihpZCwgdXYpIHtcbiAgcmV0dXJuIGlkID09PSAwID8gXCJ2VXZcIiArIHV2IDogXCJ2VVZcIiArIHV2ICsgXCJfXCIgKyBpZDtcbn0sIF9hZGRNYXA6ZnVuY3Rpb24ocCwgb3B0aW9ucywgY2h1bmtzLCB1dk9mZnNldCwgc3ViQ29kZSwgZm9ybWF0KSB7XG4gIHZhciBjbmFtZSwgdG5hbWUsIHVuYW1lO1xuICB2YXIgbW5hbWUgPSBwICsgXCJNYXBcIjtcbiAgdmFyIHRpbnQ7XG4gIGlmIChvcHRpb25zW21uYW1lICsgXCJWZXJ0ZXhDb2xvclwiXSkge1xuICAgIGNuYW1lID0gbW5hbWUgKyBcIkNoYW5uZWxcIjtcbiAgICBpZiAoIXN1YkNvZGUpIHtcbiAgICAgIHRpbnQgPSBvcHRpb25zW3AgKyBcIlRpbnRcIl07XG4gICAgICBpZiAodGludCkge1xuICAgICAgICBpZiAodGludCA9PT0gMSkge1xuICAgICAgICAgIHN1YkNvZGUgPSBjaHVua3NbcCArIFwiVmVydENvbnN0RmxvYXRQU1wiXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzdWJDb2RlID0gY2h1bmtzW3AgKyBcIlZlcnRDb25zdFBTXCJdO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdWJDb2RlID0gY2h1bmtzW3AgKyBcIlZlcnRQU1wiXTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHN1YkNvZGUucmVwbGFjZSgvXFwkQ0gvZywgb3B0aW9uc1tjbmFtZV0pO1xuICB9IGVsc2Uge1xuICAgIGlmIChvcHRpb25zW21uYW1lXSkge1xuICAgICAgdG5hbWUgPSBtbmFtZSArIFwiVHJhbnNmb3JtXCI7XG4gICAgICBjbmFtZSA9IG1uYW1lICsgXCJDaGFubmVsXCI7XG4gICAgICB1bmFtZSA9IG1uYW1lICsgXCJVdlwiO1xuICAgICAgdmFyIHV2ID0gdGhpcy5fdXZTb3VyY2Uob3B0aW9uc1t0bmFtZV0sIG9wdGlvbnNbdW5hbWVdKSArIHV2T2Zmc2V0O1xuICAgICAgaWYgKCFzdWJDb2RlKSB7XG4gICAgICAgIHRpbnQgPSBvcHRpb25zW3AgKyBcIlRpbnRcIl07XG4gICAgICAgIGlmICh0aW50KSB7XG4gICAgICAgICAgaWYgKHRpbnQgPT09IDEpIHtcbiAgICAgICAgICAgIHN1YkNvZGUgPSBjaHVua3NbcCArIFwiVGV4Q29uc3RGbG9hdFBTXCJdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdWJDb2RlID0gY2h1bmtzW3AgKyBcIlRleENvbnN0UFNcIl07XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN1YkNvZGUgPSBjaHVua3NbcCArIFwiVGV4UFNcIl07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChmb3JtYXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB2YXIgZm10ID0gZm9ybWF0ID09PSAwID8gXCJ0ZXh0dXJlMkRTUkdCXCIgOiBmb3JtYXQgPT09IDEgPyBcInRleHR1cmUyRFJHQk1cIiA6IFwidGV4dHVyZTJEXCI7XG4gICAgICAgIHN1YkNvZGUgPSBzdWJDb2RlLnJlcGxhY2UoL1xcJHRleHR1cmUyRFNBTVBMRS9nLCBmbXQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHN1YkNvZGUucmVwbGFjZSgvXFwkVVYvZywgdXYpLnJlcGxhY2UoL1xcJENIL2csIG9wdGlvbnNbY25hbWVdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGNodW5rc1twICsgXCJDb25zdFBTXCJdO1xuICAgIH1cbiAgfVxufSwgX25vblBvaW50U2hhZG93TWFwUHJvamVjdGlvbjpmdW5jdGlvbihkZXZpY2UsIGxpZ2h0LCBzaGFkb3dDb29yZEFyZ3MpIHtcbiAgaWYgKCFsaWdodC5fbm9ybWFsT2Zmc2V0QmlhcyB8fCBsaWdodC5faXNWc20pIHtcbiAgICBpZiAobGlnaHQuX3R5cGUgPT09IHBjLkxJR0hUVFlQRV9TUE9UKSB7XG4gICAgICBpZiAobGlnaHQuX2lzUGNmICYmIChkZXZpY2Uud2ViZ2wyIHx8IGRldmljZS5leHRTdGFuZGFyZERlcml2YXRpdmVzKSkge1xuICAgICAgICByZXR1cm4gXCIgICAgICAgZ2V0U2hhZG93Q29vcmRQZXJzcFpidWZmZXJcIiArIHNoYWRvd0Nvb3JkQXJncztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBcIiAgICAgICBnZXRTaGFkb3dDb29yZFBlcnNwXCIgKyBzaGFkb3dDb29yZEFyZ3M7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBcIiAgICAgICBnZXRTaGFkb3dDb29yZE9ydGhvXCIgKyBzaGFkb3dDb29yZEFyZ3M7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChsaWdodC5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgIGlmIChsaWdodC5faXNQY2YgJiYgKGRldmljZS53ZWJnbDIgfHwgZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMpKSB7XG4gICAgICAgIHJldHVybiBcIiAgICAgICBnZXRTaGFkb3dDb29yZFBlcnNwWmJ1ZmZlck5vcm1hbE9mZnNldFwiICsgc2hhZG93Q29vcmRBcmdzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFwiICAgICAgIGdldFNoYWRvd0Nvb3JkUGVyc3BOb3JtYWxPZmZzZXRcIiArIHNoYWRvd0Nvb3JkQXJncztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFwiICAgICAgIGdldFNoYWRvd0Nvb3JkT3J0aG9Ob3JtYWxPZmZzZXRcIiArIHNoYWRvd0Nvb3JkQXJncztcbiAgICB9XG4gIH1cbn0sIF9hZGRWYXJ5aW5nSWZOZWVkZWQ6ZnVuY3Rpb24oY29kZSwgdHlwZSwgbmFtZSkge1xuICByZXR1cm4gY29kZS5pbmRleE9mKG5hbWUpID49IDAgPyBcInZhcnlpbmcgXCIgKyB0eXBlICsgXCIgXCIgKyBuYW1lICsgXCI7XFxuXCIgOiBcIlwiO1xufSwgY3JlYXRlU2hhZGVyRGVmaW5pdGlvbjpmdW5jdGlvbihkZXZpY2UsIG9wdGlvbnMpIHtcbiAgdmFyIGksIHA7XG4gIHZhciBsaWdodGluZyA9IG9wdGlvbnMubGlnaHRzLmxlbmd0aCA+IDA7XG4gIGlmIChvcHRpb25zLmRpckxpZ2h0TWFwKSB7XG4gICAgbGlnaHRpbmcgPSB0cnVlO1xuICAgIG9wdGlvbnMudXNlU3BlY3VsYXIgPSB0cnVlO1xuICB9XG4gIGlmIChvcHRpb25zLnNoYWRpbmdNb2RlbCA9PT0gcGMuU1BFQ1VMQVJfUEhPTkcpIHtcbiAgICBvcHRpb25zLmZyZXNuZWxNb2RlbCA9IDA7XG4gICAgb3B0aW9ucy5zcGVjdWxhckFBID0gZmFsc2U7XG4gICAgb3B0aW9ucy5wcmVmaWx0ZXJlZEN1YmVtYXAgPSBmYWxzZTtcbiAgICBvcHRpb25zLmRwQXRsYXMgPSBmYWxzZTtcbiAgICBvcHRpb25zLmFtYmllbnRTSCA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgIG9wdGlvbnMuZnJlc25lbE1vZGVsID0gb3B0aW9ucy5mcmVzbmVsTW9kZWwgPT09IDAgPyBwYy5GUkVTTkVMX1NDSExJQ0sgOiBvcHRpb25zLmZyZXNuZWxNb2RlbDtcbiAgfVxuICB2YXIgY3ViZW1hcFJlZmxlY3Rpb24gPSBvcHRpb25zLmN1YmVNYXAgfHwgb3B0aW9ucy5wcmVmaWx0ZXJlZEN1YmVtYXAgJiYgb3B0aW9ucy51c2VTcGVjdWxhcjtcbiAgdmFyIHJlZmxlY3Rpb25zID0gb3B0aW9ucy5zcGhlcmVNYXAgfHwgY3ViZW1hcFJlZmxlY3Rpb24gfHwgb3B0aW9ucy5kcEF0bGFzO1xuICB2YXIgdXNlVGFuZ2VudHMgPSBwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHM7XG4gIHZhciB1c2VUZXhDdWJlTG9kID0gb3B0aW9ucy51c2VUZXhDdWJlTG9kO1xuICBpZiAob3B0aW9ucy5jdWJlTWFwIHx8IG9wdGlvbnMucHJlZmlsdGVyZWRDdWJlbWFwKSB7XG4gICAgb3B0aW9ucy5zcGhlcmVNYXAgPSBudWxsO1xuICB9XG4gIGlmIChvcHRpb25zLmRwQXRsYXMpIHtcbiAgICBvcHRpb25zLnNwaGVyZU1hcCA9IG9wdGlvbnMuY3ViZU1hcCA9IG9wdGlvbnMucHJlZmlsdGVyZWRDdWJlbWFwID0gY3ViZW1hcFJlZmxlY3Rpb24gPSBudWxsO1xuICB9XG4gIGlmICghb3B0aW9ucy51c2VTcGVjdWxhcikge1xuICAgIG9wdGlvbnMuc3BlY3VsYXJNYXAgPSBvcHRpb25zLmdsb3NzTWFwID0gbnVsbDtcbiAgfVxuICB2YXIgbmVlZHNOb3JtYWwgPSBsaWdodGluZyB8fCByZWZsZWN0aW9ucyB8fCBvcHRpb25zLmFtYmllbnRTSCB8fCBvcHRpb25zLnByZWZpbHRlcmVkQ3ViZW1hcCB8fCBvcHRpb25zLmhlaWdodE1hcDtcbiAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgdmFyIGNvZGUgPSBcIlwiO1xuICB2YXIgY29kZUJvZHkgPSBcIlwiO1xuICB2YXIgdmFyeWluZ3MgPSBcIlwiO1xuICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICB2YXIgbGlnaHRUeXBlO1xuICB2YXIgc2hhZG93Q29vcmRBcmdzO1xuICBpZiAob3B0aW9ucy5jaHVua3MpIHtcbiAgICB2YXIgY3VzdG9tQ2h1bmtzID0gW107XG4gICAgZm9yIChwIGluIGNodW5rcykge1xuICAgICAgaWYgKGNodW5rcy5oYXNPd25Qcm9wZXJ0eShwKSkge1xuICAgICAgICBpZiAoIW9wdGlvbnMuY2h1bmtzW3BdKSB7XG4gICAgICAgICAgY3VzdG9tQ2h1bmtzW3BdID0gY2h1bmtzW3BdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGN1c3RvbUNodW5rc1twXSA9IG9wdGlvbnMuY2h1bmtzW3BdO1xuICAgICAgICAgIGlmICghbmVlZHNOb3JtYWwpIHtcbiAgICAgICAgICAgIGN1c3RvbUNodW5rc1twXSA9IGN1c3RvbUNodW5rc1twXS5yZXBsYWNlKC92ZXJ0ZXhfbm9ybWFsL2csIFwidmVjMygwKVwiKS5yZXBsYWNlKC92ZXJ0ZXhfdGFuZ2VudC9nLCBcInZlYzQoMClcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNodW5rcyA9IGN1c3RvbUNodW5rcztcbiAgfVxuICBjb2RlICs9IGNodW5rcy5iYXNlVlM7XG4gIHZhciBtYWluU2hhZG93TGlnaHQgPSAtMTtcbiAgaWYgKCFvcHRpb25zLm5vU2hhZG93ICYmICFvcHRpb25zLnR3b1NpZGVkTGlnaHRpbmcpIHtcbiAgICBmb3IgKGkgPSAwO2kgPCBvcHRpb25zLmxpZ2h0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBsaWdodFR5cGUgPSBvcHRpb25zLmxpZ2h0c1tpXS5fdHlwZTtcbiAgICAgIGlmIChvcHRpb25zLmxpZ2h0c1tpXS5jYXN0U2hhZG93cykge1xuICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwpIHtcbiAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBtYXQ0IGxpZ2h0XCIgKyBpICsgXCJfc2hhZG93TWF0cml4VlM7XFxuXCI7XG4gICAgICAgICAgY29kZSArPSBcInVuaWZvcm0gdmVjMyBsaWdodFwiICsgaSArIFwiX3NoYWRvd1BhcmFtc1ZTO1xcblwiO1xuICAgICAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIHZlYzMgbGlnaHRcIiArIGkgKyAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwgPyBcIl9kaXJlY3Rpb25WU1wiIDogXCJfcG9zaXRpb25WU1wiKSArIFwiO1xcblwiO1xuICAgICAgICAgIG1haW5TaGFkb3dMaWdodCA9IGk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG1haW5TaGFkb3dMaWdodCA+PSAwKSB7XG4gICAgICBjb2RlICs9IGNodW5rcy5zaGFkb3dDb29yZFZTO1xuICAgIH1cbiAgfVxuICB2YXIgYXR0cmlidXRlcyA9IHt2ZXJ0ZXhfcG9zaXRpb246cGMuU0VNQU5USUNfUE9TSVRJT059O1xuICBjb2RlQm9keSArPSBcIiAgIHZQb3NpdGlvblcgICAgPSBnZXRXb3JsZFBvc2l0aW9uKCk7XFxuXCI7XG4gIGlmIChvcHRpb25zLnVzZUluc3RhbmNpbmcpIHtcbiAgICBhdHRyaWJ1dGVzLmluc3RhbmNlX2xpbmUxID0gcGMuU0VNQU5USUNfVEVYQ09PUkQyO1xuICAgIGF0dHJpYnV0ZXMuaW5zdGFuY2VfbGluZTIgPSBwYy5TRU1BTlRJQ19URVhDT09SRDM7XG4gICAgYXR0cmlidXRlcy5pbnN0YW5jZV9saW5lMyA9IHBjLlNFTUFOVElDX1RFWENPT1JENDtcbiAgICBhdHRyaWJ1dGVzLmluc3RhbmNlX2xpbmU0ID0gcGMuU0VNQU5USUNfVEVYQ09PUkQ1O1xuICAgIGNvZGUgKz0gY2h1bmtzLmluc3RhbmNpbmdWUztcbiAgfVxuICBpZiAobmVlZHNOb3JtYWwpIHtcbiAgICBhdHRyaWJ1dGVzLnZlcnRleF9ub3JtYWwgPSBwYy5TRU1BTlRJQ19OT1JNQUw7XG4gICAgY29kZUJvZHkgKz0gXCIgICB2Tm9ybWFsVyAgICA9IGROb3JtYWxXID0gZ2V0Tm9ybWFsKCk7XFxuXCI7XG4gICAgaWYgKG9wdGlvbnMuc3BoZXJlTWFwICYmIGRldmljZS5mcmFnbWVudFVuaWZvcm1zQ291bnQgPD0gMTYpIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnZpZXdOb3JtYWxWUztcbiAgICAgIGNvZGVCb2R5ICs9IFwiICAgdk5vcm1hbFYgICAgPSBnZXRWaWV3Tm9ybWFsKCk7XFxuXCI7XG4gICAgfVxuICAgIGlmICgob3B0aW9ucy5oZWlnaHRNYXAgfHwgb3B0aW9ucy5ub3JtYWxNYXApICYmIHVzZVRhbmdlbnRzKSB7XG4gICAgICBhdHRyaWJ1dGVzLnZlcnRleF90YW5nZW50ID0gcGMuU0VNQU5USUNfVEFOR0VOVDtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnRhbmdlbnRCaW5vcm1hbFZTO1xuICAgICAgY29kZUJvZHkgKz0gXCIgICB2VGFuZ2VudFcgICA9IGdldFRhbmdlbnQoKTtcXG5cIjtcbiAgICAgIGNvZGVCb2R5ICs9IFwiICAgdkJpbm9ybWFsVyAgPSBnZXRCaW5vcm1hbCgpO1xcblwiO1xuICAgIH1cbiAgICBpZiAobWFpblNoYWRvd0xpZ2h0ID49IDApIHtcbiAgICAgIGxpZ2h0VHlwZSA9IG9wdGlvbnMubGlnaHRzW21haW5TaGFkb3dMaWdodF0uX3R5cGU7XG4gICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwpIHtcbiAgICAgICAgY29kZUJvZHkgKz0gXCIgICBkTGlnaHREaXJOb3JtVyA9IGxpZ2h0XCIgKyBtYWluU2hhZG93TGlnaHQgKyBcIl9kaXJlY3Rpb25WUztcXG5cIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvZGVCb2R5ICs9IFwiICAgZ2V0TGlnaHREaXJQb2ludChsaWdodFwiICsgbWFpblNoYWRvd0xpZ2h0ICsgXCJfcG9zaXRpb25WUyk7XFxuXCI7XG4gICAgICB9XG4gICAgICBzaGFkb3dDb29yZEFyZ3MgPSBcIihsaWdodFwiICsgbWFpblNoYWRvd0xpZ2h0ICsgXCJfc2hhZG93TWF0cml4VlMsIGxpZ2h0XCIgKyBtYWluU2hhZG93TGlnaHQgKyBcIl9zaGFkb3dQYXJhbXNWUyk7XFxuXCI7XG4gICAgICBjb2RlQm9keSArPSB0aGlzLl9ub25Qb2ludFNoYWRvd01hcFByb2plY3Rpb24oZGV2aWNlLCBvcHRpb25zLmxpZ2h0c1ttYWluU2hhZG93TGlnaHRdLCBzaGFkb3dDb29yZEFyZ3MpO1xuICAgIH1cbiAgfVxuICB2YXIgdXNlVXYgPSBbXTtcbiAgdmFyIHVzZVVubW9kaWZpZWRVdiA9IFtdO1xuICB2YXIgbWF4VXZTZXRzID0gMjtcbiAgdmFyIGNuYW1lLCBtbmFtZSwgdG5hbWUsIHVuYW1lO1xuICBmb3IgKHAgaW4gcGMuX21hdFRleDJEKSB7XG4gICAgbW5hbWUgPSBwICsgXCJNYXBcIjtcbiAgICBpZiAob3B0aW9uc1ttbmFtZSArIFwiVmVydGV4Q29sb3JcIl0pIHtcbiAgICAgIGNuYW1lID0gbW5hbWUgKyBcIkNoYW5uZWxcIjtcbiAgICAgIG9wdGlvbnNbY25hbWVdID0gdGhpcy5fY29ycmVjdENoYW5uZWwocCwgb3B0aW9uc1tjbmFtZV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAob3B0aW9uc1ttbmFtZV0pIHtcbiAgICAgICAgY25hbWUgPSBtbmFtZSArIFwiQ2hhbm5lbFwiO1xuICAgICAgICB0bmFtZSA9IG1uYW1lICsgXCJUcmFuc2Zvcm1cIjtcbiAgICAgICAgdW5hbWUgPSBtbmFtZSArIFwiVXZcIjtcbiAgICAgICAgb3B0aW9uc1t1bmFtZV0gPSBNYXRoLm1pbihvcHRpb25zW3VuYW1lXSwgbWF4VXZTZXRzIC0gMSk7XG4gICAgICAgIG9wdGlvbnNbY25hbWVdID0gdGhpcy5fY29ycmVjdENoYW5uZWwocCwgb3B0aW9uc1tjbmFtZV0pO1xuICAgICAgICB2YXIgdXZTZXQgPSBvcHRpb25zW3VuYW1lXTtcbiAgICAgICAgdXNlVXZbdXZTZXRdID0gdHJ1ZTtcbiAgICAgICAgdXNlVW5tb2RpZmllZFV2W3V2U2V0XSA9IHVzZVVubW9kaWZpZWRVdlt1dlNldF0gfHwgb3B0aW9uc1ttbmFtZV0gJiYgIW9wdGlvbnNbdG5hbWVdO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5mb3JjZVV2MSkge1xuICAgIHVzZVV2WzFdID0gdHJ1ZTtcbiAgfVxuICBmb3IgKGkgPSAwO2kgPCBtYXhVdlNldHM7aSsrKSB7XG4gICAgaWYgKHVzZVV2W2ldKSB7XG4gICAgICBhdHRyaWJ1dGVzW1widmVydGV4X3RleENvb3JkXCIgKyBpXSA9IHBjW1wiU0VNQU5USUNfVEVYQ09PUkRcIiArIGldO1xuICAgICAgY29kZSArPSBjaHVua3NbXCJ1dlwiICsgaSArIFwiVlNcIl07XG4gICAgICBjb2RlQm9keSArPSBcIiAgIHZlYzIgdXZcIiArIGkgKyBcIiA9IGdldFV2XCIgKyBpICsgXCIoKTtcXG5cIjtcbiAgICB9XG4gICAgaWYgKHVzZVVubW9kaWZpZWRVdltpXSkge1xuICAgICAgY29kZUJvZHkgKz0gXCIgICB2VXZcIiArIGkgKyBcIiA9IHV2XCIgKyBpICsgXCI7XFxuXCI7XG4gICAgfVxuICB9XG4gIHZhciBjb2RlcyA9IFtjb2RlLCB2YXJ5aW5ncywgY29kZUJvZHksIFtdXTtcbiAgZm9yIChwIGluIHBjLl9tYXRUZXgyRCkge1xuICAgIG1uYW1lID0gcCArIFwiTWFwXCI7XG4gICAgaWYgKG9wdGlvbnNbbW5hbWVdKSB7XG4gICAgICB0bmFtZSA9IG1uYW1lICsgXCJUcmFuc2Zvcm1cIjtcbiAgICAgIGlmIChvcHRpb25zW3RuYW1lXSkge1xuICAgICAgICB1bmFtZSA9IG1uYW1lICsgXCJVdlwiO1xuICAgICAgICB0aGlzLl9zZXRNYXBUcmFuc2Zvcm0oY29kZXMsIHAsIG9wdGlvbnNbdG5hbWVdLCBvcHRpb25zW3VuYW1lXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGNvZGUgPSBjb2Rlc1swXTtcbiAgdmFyeWluZ3MgPSBjb2Rlc1sxXTtcbiAgY29kZUJvZHkgPSBjb2Rlc1syXTtcbiAgaWYgKG9wdGlvbnMudmVydGV4Q29sb3JzKSB7XG4gICAgYXR0cmlidXRlcy52ZXJ0ZXhfY29sb3IgPSBwYy5TRU1BTlRJQ19DT0xPUjtcbiAgICBjb2RlQm9keSArPSBcIiAgIHZWZXJ0ZXhDb2xvciA9IHZlcnRleF9jb2xvcjtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5zY3JlZW5TcGFjZSkge1xuICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNjcmVlblNwYWNlVlM7XG4gICAgaWYgKG5lZWRzTm9ybWFsKSB7XG4gICAgICBjb2RlICs9IGNodW5rcy5ub3JtYWxWUztcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKG9wdGlvbnMuc2tpbikge1xuICAgICAgYXR0cmlidXRlcy52ZXJ0ZXhfYm9uZVdlaWdodHMgPSBwYy5TRU1BTlRJQ19CTEVORFdFSUdIVDtcbiAgICAgIGF0dHJpYnV0ZXMudmVydGV4X2JvbmVJbmRpY2VzID0gcGMuU0VNQU5USUNfQkxFTkRJTkRJQ0VTO1xuICAgICAgY29kZSArPSBwYy5wcm9ncmFtbGliLnNraW5Db2RlKGRldmljZSwgY2h1bmtzKTtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNraW5uZWRWUztcbiAgICAgIGlmIChuZWVkc05vcm1hbCkge1xuICAgICAgICBjb2RlICs9IGNodW5rcy5ub3JtYWxTa2lubmVkVlM7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcHRpb25zLnVzZUluc3RhbmNpbmcpIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MudHJhbnNmb3JtSW5zdGFuY2VkVlM7XG4gICAgICAgIGlmIChuZWVkc05vcm1hbCkge1xuICAgICAgICAgIGNvZGUgKz0gY2h1bmtzLm5vcm1hbEluc3RhbmNlZFZTO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1WUztcbiAgICAgICAgaWYgKG5lZWRzTm9ybWFsKSB7XG4gICAgICAgICAgY29kZSArPSBjaHVua3Mubm9ybWFsVlM7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY29kZSArPSBcIlxcblwiO1xuICBjb2RlICs9IGNodW5rcy5zdGFydFZTO1xuICBjb2RlICs9IGNvZGVCb2R5O1xuICBjb2RlICs9IFwifVwiO1xuICB2YXIgdnNoYWRlciA9IGNvZGU7XG4gIHZhciBvbGRWYXJzID0gdmFyeWluZ3M7XG4gIHZhcnlpbmdzID0gXCJcIjtcbiAgdmFyeWluZ3MgKz0gdGhpcy5fYWRkVmFyeWluZ0lmTmVlZGVkKGNvZGUsIFwidmVjNFwiLCBcInZNYWluU2hhZG93VXZcIik7XG4gIHZhcnlpbmdzICs9IHRoaXMuX2FkZFZhcnlpbmdJZk5lZWRlZChjb2RlLCBcInZlYzRcIiwgXCJ2VmVydGV4Q29sb3JcIik7XG4gIHZhcnlpbmdzICs9IHRoaXMuX2FkZFZhcnlpbmdJZk5lZWRlZChjb2RlLCBcInZlYzNcIiwgXCJ2UG9zaXRpb25XXCIpO1xuICB2YXJ5aW5ncyArPSB0aGlzLl9hZGRWYXJ5aW5nSWZOZWVkZWQoY29kZSwgXCJ2ZWMzXCIsIFwidk5vcm1hbFZcIik7XG4gIHZhcnlpbmdzICs9IHRoaXMuX2FkZFZhcnlpbmdJZk5lZWRlZChjb2RlLCBcInZlYzNcIiwgXCJ2Tm9ybWFsV1wiKTtcbiAgdmFyeWluZ3MgKz0gdGhpcy5fYWRkVmFyeWluZ0lmTmVlZGVkKGNvZGUsIFwidmVjM1wiLCBcInZUYW5nZW50V1wiKTtcbiAgdmFyeWluZ3MgKz0gdGhpcy5fYWRkVmFyeWluZ0lmTmVlZGVkKGNvZGUsIFwidmVjM1wiLCBcInZCaW5vcm1hbFdcIik7XG4gIHZhcnlpbmdzICs9IHRoaXMuX2FkZFZhcnlpbmdJZk5lZWRlZChjb2RlLCBcInZlYzJcIiwgXCJ2VXYwXCIpO1xuICB2YXJ5aW5ncyArPSB0aGlzLl9hZGRWYXJ5aW5nSWZOZWVkZWQoY29kZSwgXCJ2ZWMyXCIsIFwidlV2MVwiKTtcbiAgdmFyeWluZ3MgKz0gb2xkVmFycztcbiAgdnNoYWRlciA9IHZhcnlpbmdzICsgdnNoYWRlcjtcbiAgdmFyIHN0YXJ0Q29kZSA9IFwiXCI7XG4gIGlmIChkZXZpY2Uud2ViZ2wyKSB7XG4gICAgc3RhcnRDb2RlID0gcGMucHJvZ3JhbWxpYi52ZXJzaW9uQ29kZShkZXZpY2UpO1xuICAgIGlmIChjaHVua3MuZXh0ZW5zaW9uVlMpIHtcbiAgICAgIHN0YXJ0Q29kZSArPSBjaHVua3MuZXh0ZW5zaW9uVlMgKyBcIlxcblwiO1xuICAgIH1cbiAgICB2c2hhZGVyID0gc3RhcnRDb2RlICsgY2h1bmtzLmdsZXMzVlMgKyB2c2hhZGVyO1xuICB9IGVsc2Uge1xuICAgIGlmIChjaHVua3MuZXh0ZW5zaW9uVlMpIHtcbiAgICAgIHN0YXJ0Q29kZSA9IGNodW5rcy5leHRlbnNpb25WUyArIFwiXFxuXCI7XG4gICAgfVxuICAgIHZzaGFkZXIgPSBzdGFydENvZGUgKyB2c2hhZGVyO1xuICB9XG4gIGlmIChvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24gJiYgb3B0aW9ucy5mb3JjZUZyYWdtZW50UHJlY2lzaW9uICE9IFwiaGlnaHBcIiAmJiBvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24gIT09IFwibWVkaXVtcFwiICYmIG9wdGlvbnMuZm9yY2VGcmFnbWVudFByZWNpc2lvbiAhPT0gXCJsb3dwXCIpIHtcbiAgICBvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24gPSBudWxsO1xuICB9XG4gIGlmIChvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24pIHtcbiAgICBpZiAob3B0aW9ucy5mb3JjZUZyYWdtZW50UHJlY2lzaW9uID09PSBcImhpZ2hwXCIgJiYgZGV2aWNlLm1heFByZWNpc2lvbiAhPT0gXCJoaWdocFwiKSB7XG4gICAgICBvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24gPSBcIm1lZGl1bXBcIjtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuZm9yY2VGcmFnbWVudFByZWNpc2lvbiA9PT0gXCJtZWRpdW1wXCIgJiYgZGV2aWNlLm1heFByZWNpc2lvbiA9PT0gXCJsb3dwXCIpIHtcbiAgICAgIG9wdGlvbnMuZm9yY2VGcmFnbWVudFByZWNpc2lvbiA9IFwibG93cFwiO1xuICAgIH1cbiAgfVxuICB2YXIgZnNoYWRlcjtcbiAgY29kZSA9IFwiXCI7XG4gIGlmIChkZXZpY2Uud2ViZ2wyKSB7XG4gICAgY29kZSArPSBwYy5wcm9ncmFtbGliLnZlcnNpb25Db2RlKGRldmljZSk7XG4gIH1cbiAgaWYgKGRldmljZS5leHRTdGFuZGFyZERlcml2YXRpdmVzICYmICFkZXZpY2Uud2ViZ2wyKSB7XG4gICAgY29kZSArPSBcIiNleHRlbnNpb24gR0xfT0VTX3N0YW5kYXJkX2Rlcml2YXRpdmVzIDogZW5hYmxlXFxuXFxuXCI7XG4gIH1cbiAgaWYgKGNodW5rcy5leHRlbnNpb25QUykge1xuICAgIGNvZGUgKz0gY2h1bmtzLmV4dGVuc2lvblBTICsgXCJcXG5cIjtcbiAgfVxuICBpZiAoZGV2aWNlLndlYmdsMikge1xuICAgIGNvZGUgKz0gY2h1bmtzLmdsZXMzUFM7XG4gIH1cbiAgY29kZSArPSBvcHRpb25zLmZvcmNlRnJhZ21lbnRQcmVjaXNpb24gPyBcInByZWNpc2lvbiBcIiArIG9wdGlvbnMuZm9yY2VGcmFnbWVudFByZWNpc2lvbiArIFwiIGZsb2F0O1xcblxcblwiIDogcGMucHJvZ3JhbWxpYi5wcmVjaXNpb25Db2RlKGRldmljZSk7XG4gIGlmIChvcHRpb25zLmN1c3RvbUZyYWdtZW50U2hhZGVyKSB7XG4gICAgZnNoYWRlciA9IGNvZGUgKyBvcHRpb25zLmN1c3RvbUZyYWdtZW50U2hhZGVyO1xuICAgIHJldHVybiB7YXR0cmlidXRlczphdHRyaWJ1dGVzLCB2c2hhZGVyOnZzaGFkZXIsIGZzaGFkZXI6ZnNoYWRlciwgdGFnOnBjLlNIQURFUlRBR19NQVRFUklBTH07XG4gIH1cbiAgY29kZSArPSB2YXJ5aW5ncztcbiAgY29kZSArPSBjaHVua3MuYmFzZVBTO1xuICB2YXIgY29kZUJlZ2luID0gY29kZTtcbiAgY29kZSA9IFwiXCI7XG4gIHZhciBudW1TaGFkb3dMaWdodHMgPSAwO1xuICB2YXIgc2hhZG93VHlwZVVzZWQgPSBbXTtcbiAgdmFyIHVzZVZzbSA9IGZhbHNlO1xuICB2YXIgdXNlUGVyc3BaYnVmZmVyU2hhZG93ID0gZmFsc2U7XG4gIHZhciBsaWdodDtcbiAgZm9yIChpID0gMDtpIDwgb3B0aW9ucy5saWdodHMubGVuZ3RoO2krKykge1xuICAgIGxpZ2h0ID0gb3B0aW9ucy5saWdodHNbaV07XG4gICAgbGlnaHRUeXBlID0gbGlnaHQuX3R5cGU7XG4gICAgY29kZSArPSBcInVuaWZvcm0gdmVjMyBsaWdodFwiICsgaSArIFwiX2NvbG9yO1xcblwiO1xuICAgIGlmIChsaWdodFR5cGUgPT09IHBjLkxJR0hUVFlQRV9ESVJFQ1RJT05BTCkge1xuICAgICAgY29kZSArPSBcInVuaWZvcm0gdmVjMyBsaWdodFwiICsgaSArIFwiX2RpcmVjdGlvbjtcXG5cIjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBcInVuaWZvcm0gdmVjMyBsaWdodFwiICsgaSArIFwiX3Bvc2l0aW9uO1xcblwiO1xuICAgICAgY29kZSArPSBcInVuaWZvcm0gZmxvYXQgbGlnaHRcIiArIGkgKyBcIl9yYWRpdXM7XFxuXCI7XG4gICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICBjb2RlICs9IFwidW5pZm9ybSB2ZWMzIGxpZ2h0XCIgKyBpICsgXCJfZGlyZWN0aW9uO1xcblwiO1xuICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBmbG9hdCBsaWdodFwiICsgaSArIFwiX2lubmVyQ29uZUFuZ2xlO1xcblwiO1xuICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBmbG9hdCBsaWdodFwiICsgaSArIFwiX291dGVyQ29uZUFuZ2xlO1xcblwiO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAobGlnaHQuY2FzdFNoYWRvd3MgJiYgIW9wdGlvbnMubm9TaGFkb3cpIHtcbiAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIG1hdDQgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXRyaXg7XFxuXCI7XG4gICAgICBpZiAobGlnaHRUeXBlICE9PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwpIHtcbiAgICAgICAgY29kZSArPSBcInVuaWZvcm0gdmVjNCBsaWdodFwiICsgaSArIFwiX3NoYWRvd1BhcmFtcztcXG5cIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIHZlYzMgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dQYXJhbXM7XFxuXCI7XG4gICAgICB9XG4gICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgY29kZSArPSBcInVuaWZvcm0gc2FtcGxlckN1YmUgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXA7XFxuXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobGlnaHQuX2lzUGNmICYmIGRldmljZS53ZWJnbDIpIHtcbiAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBzYW1wbGVyMkRTaGFkb3cgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXA7XFxuXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29kZSArPSBcInVuaWZvcm0gc2FtcGxlcjJEIGxpZ2h0XCIgKyBpICsgXCJfc2hhZG93TWFwO1xcblwiO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBudW1TaGFkb3dMaWdodHMrKztcbiAgICAgIHNoYWRvd1R5cGVVc2VkW2xpZ2h0Ll9zaGFkb3dUeXBlXSA9IHRydWU7XG4gICAgICBpZiAobGlnaHQuX2lzVnNtKSB7XG4gICAgICAgIHVzZVZzbSA9IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAobGlnaHQuX2lzUGNmICYmIChkZXZpY2Uud2ViZ2wyIHx8IGRldmljZS5leHRTdGFuZGFyZERlcml2YXRpdmVzKSAmJiBsaWdodFR5cGUgPT09IHBjLkxJR0hUVFlQRV9TUE9UKSB7XG4gICAgICAgIHVzZVBlcnNwWmJ1ZmZlclNoYWRvdyA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChsaWdodC5fY29va2llKSB7XG4gICAgICBpZiAobGlnaHQuX2Nvb2tpZS5fY3ViZW1hcCkge1xuICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBzYW1wbGVyQ3ViZSBsaWdodFwiICsgaSArIFwiX2Nvb2tpZTtcXG5cIjtcbiAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBmbG9hdCBsaWdodFwiICsgaSArIFwiX2Nvb2tpZUludGVuc2l0eTtcXG5cIjtcbiAgICAgICAgICBpZiAoIWxpZ2h0LmNhc3RTaGFkb3dzIHx8IG9wdGlvbnMubm9TaGFkb3cpIHtcbiAgICAgICAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIG1hdDQgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXRyaXg7XFxuXCI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIHNhbXBsZXIyRCBsaWdodFwiICsgaSArIFwiX2Nvb2tpZTtcXG5cIjtcbiAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSBmbG9hdCBsaWdodFwiICsgaSArIFwiX2Nvb2tpZUludGVuc2l0eTtcXG5cIjtcbiAgICAgICAgICBpZiAoIWxpZ2h0LmNhc3RTaGFkb3dzIHx8IG9wdGlvbnMubm9TaGFkb3cpIHtcbiAgICAgICAgICAgIGNvZGUgKz0gXCJ1bmlmb3JtIG1hdDQgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXRyaXg7XFxuXCI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChsaWdodC5fY29va2llVHJhbnNmb3JtKSB7XG4gICAgICAgICAgICBjb2RlICs9IFwidW5pZm9ybSB2ZWM0IGxpZ2h0XCIgKyBpICsgXCJfY29va2llTWF0cml4O1xcblwiO1xuICAgICAgICAgICAgY29kZSArPSBcInVuaWZvcm0gdmVjMiBsaWdodFwiICsgaSArIFwiX2Nvb2tpZU9mZnNldDtcXG5cIjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY29kZSArPSBcIlxcblwiO1xuICB2YXIgdXZPZmZzZXQgPSBvcHRpb25zLmhlaWdodE1hcCA/IFwiICsgZFV2T2Zmc2V0XCIgOiBcIlwiO1xuICB2YXIgdGJuID0gb3B0aW9ucy5mYXN0VGJuID8gY2h1bmtzLlRCTmZhc3RQUyA6IGNodW5rcy5UQk5QUztcbiAgaWYgKG5lZWRzTm9ybWFsKSB7XG4gICAgaWYgKG9wdGlvbnMubm9ybWFsTWFwICYmIHVzZVRhbmdlbnRzKSB7XG4gICAgICBjb2RlICs9IG9wdGlvbnMucGFja2VkTm9ybWFsID8gY2h1bmtzLm5vcm1hbFhZUFMgOiBjaHVua3Mubm9ybWFsWFlaUFM7XG4gICAgICB2YXIgdXYgPSB0aGlzLl91dlNvdXJjZShvcHRpb25zLm5vcm1hbE1hcFRyYW5zZm9ybSwgb3B0aW9ucy5ub3JtYWxNYXBVdikgKyB1dk9mZnNldDtcbiAgICAgIGlmIChvcHRpb25zLm5lZWRzTm9ybWFsRmxvYXQpIHtcbiAgICAgICAgY29kZSArPSAob3B0aW9ucy5mYXN0VGJuID8gY2h1bmtzLm5vcm1hbE1hcEZsb2F0VEJOZmFzdFBTIDogY2h1bmtzLm5vcm1hbE1hcEZsb2F0UFMpLnJlcGxhY2UoL1xcJFVWL2csIHV2KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvZGUgKz0gY2h1bmtzLm5vcm1hbE1hcFBTLnJlcGxhY2UoL1xcJFVWL2csIHV2KTtcbiAgICAgIH1cbiAgICAgIGNvZGUgKz0gdGJuO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2RlICs9IGNodW5rcy5ub3JtYWxWZXJ0ZXhQUztcbiAgICB9XG4gIH1cbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLmdhbW1hQ29kZShvcHRpb25zLmdhbW1hKTtcbiAgY29kZSArPSBwYy5wcm9ncmFtbGliLnRvbmVtYXBDb2RlKG9wdGlvbnMudG9uZU1hcCk7XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5mb2dDb2RlKG9wdGlvbnMuZm9nKTtcbiAgaWYgKG9wdGlvbnMudXNlUmdibSkge1xuICAgIGNvZGUgKz0gY2h1bmtzLnJnYm1QUztcbiAgfVxuICBpZiAoY3ViZW1hcFJlZmxlY3Rpb24gfHwgb3B0aW9ucy5wcmVmaWx0ZXJlZEN1YmVtYXApIHtcbiAgICBjb2RlICs9IG9wdGlvbnMuZml4U2VhbXMgPyBjaHVua3MuZml4Q3ViZW1hcFNlYW1zU3RyZXRjaFBTIDogY2h1bmtzLmZpeEN1YmVtYXBTZWFtc05vbmVQUztcbiAgfVxuICBpZiAobmVlZHNOb3JtYWwpIHtcbiAgICBjb2RlICs9IG9wdGlvbnMuY3ViZU1hcFByb2plY3Rpb24gPiAwID8gY2h1bmtzLmN1YmVNYXBQcm9qZWN0Qm94UFMgOiBjaHVua3MuY3ViZU1hcFByb2plY3ROb25lUFM7XG4gICAgY29kZSArPSBvcHRpb25zLnNreWJveEludGVuc2l0eSA/IGNodW5rcy5lbnZNdWx0aXBseVBTIDogY2h1bmtzLmVudkNvbnN0UFM7XG4gIH1cbiAgY29kZSArPSB0aGlzLl9hZGRNYXAoXCJkaWZmdXNlXCIsIG9wdGlvbnMsIGNodW5rcywgdXZPZmZzZXQpO1xuICBpZiAob3B0aW9ucy5ibGVuZFR5cGUgIT09IHBjLkJMRU5EX05PTkUgfHwgb3B0aW9ucy5hbHBoYVRlc3QgfHwgb3B0aW9ucy5hbHBoYVRvQ292ZXJhZ2UpIHtcbiAgICBjb2RlICs9IHRoaXMuX2FkZE1hcChcIm9wYWNpdHlcIiwgb3B0aW9ucywgY2h1bmtzLCB1dk9mZnNldCk7XG4gIH1cbiAgY29kZSArPSB0aGlzLl9hZGRNYXAoXCJlbWlzc2l2ZVwiLCBvcHRpb25zLCBjaHVua3MsIHV2T2Zmc2V0LCBudWxsLCBvcHRpb25zLmVtaXNzaXZlRm9ybWF0KTtcbiAgaWYgKG9wdGlvbnMudXNlU3BlY3VsYXIgJiYgKGxpZ2h0aW5nIHx8IHJlZmxlY3Rpb25zKSkge1xuICAgIGlmIChvcHRpb25zLnNwZWN1bGFyQUEgJiYgb3B0aW9ucy5ub3JtYWxNYXApIHtcbiAgICAgIGlmIChvcHRpb25zLm5lZWRzTm9ybWFsRmxvYXQgJiYgbmVlZHNOb3JtYWwpIHtcbiAgICAgICAgY29kZSArPSBjaHVua3Muc3BlY3VsYXJBYVRva3N2aWdGbG9hdFBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBjaHVua3Muc3BlY3VsYXJBYVRva3N2aWdQUztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBjaHVua3Muc3BlY3VsYXJBYU5vbmVQUztcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMudXNlTWV0YWxuZXNzKSB7XG4gICAgICBjb2RlICs9IGNodW5rcy5tZXRhbG5lc3NQUztcbiAgICB9XG4gICAgY29kZSArPSB0aGlzLl9hZGRNYXAob3B0aW9ucy51c2VNZXRhbG5lc3MgPyBcIm1ldGFsbmVzc1wiIDogXCJzcGVjdWxhclwiLCBvcHRpb25zLCBjaHVua3MsIHV2T2Zmc2V0KTtcbiAgICBjb2RlICs9IHRoaXMuX2FkZE1hcChcImdsb3NzXCIsIG9wdGlvbnMsIGNodW5rcywgdXZPZmZzZXQpO1xuICAgIGlmIChvcHRpb25zLmZyZXNuZWxNb2RlbCA+IDApIHtcbiAgICAgIGlmIChvcHRpb25zLmZyZXNuZWxNb2RlbCA9PT0gcGMuRlJFU05FTF9TSU1QTEUpIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MuZnJlc25lbFNpbXBsZVBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuZnJlc25lbE1vZGVsID09PSBwYy5GUkVTTkVMX1NDSExJQ0spIHtcbiAgICAgICAgICBjb2RlICs9IGNodW5rcy5mcmVzbmVsU2NobGlja1BTO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChvcHRpb25zLmZyZXNuZWxNb2RlbCA9PT0gcGMuRlJFU05FTF9DT01QTEVYKSB7XG4gICAgICAgICAgICBjb2RlICs9IGNodW5rcy5mcmVzbmVsQ29tcGxleFBTO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5oZWlnaHRNYXApIHtcbiAgICBpZiAoIW9wdGlvbnMubm9ybWFsTWFwKSB7XG4gICAgICBjb2RlICs9IHRibjtcbiAgICB9XG4gICAgY29kZSArPSB0aGlzLl9hZGRNYXAoXCJoZWlnaHRcIiwgb3B0aW9ucywgY2h1bmtzLCBcIlwiLCBjaHVua3MucGFyYWxsYXhQUyk7XG4gIH1cbiAgdmFyIHVzZUFvID0gb3B0aW9ucy5hb01hcCB8fCBvcHRpb25zLmFvTWFwVmVydGV4Q29sb3I7XG4gIGlmICh1c2VBbykge1xuICAgIGNvZGUgKz0gdGhpcy5fYWRkTWFwKFwiYW9cIiwgb3B0aW9ucywgY2h1bmtzLCB1dk9mZnNldCwgb3B0aW9ucy5hb01hcFZlcnRleENvbG9yID8gY2h1bmtzLmFvVmVydFBTIDogY2h1bmtzLmFvVGV4UFMpO1xuICAgIGlmIChvcHRpb25zLm9jY2x1ZGVTcGVjdWxhcikge1xuICAgICAgaWYgKG9wdGlvbnMub2NjbHVkZVNwZWN1bGFyID09PSBwYy5TUEVDT0NDX0FPKSB7XG4gICAgICAgIGNvZGUgKz0gb3B0aW9ucy5vY2NsdWRlU3BlY3VsYXJGbG9hdCA/IGNodW5rcy5hb1NwZWNPY2NTaW1wbGVQUyA6IGNodW5rcy5hb1NwZWNPY2NDb25zdFNpbXBsZVBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBvcHRpb25zLm9jY2x1ZGVTcGVjdWxhckZsb2F0ID8gY2h1bmtzLmFvU3BlY09jY1BTIDogY2h1bmtzLmFvU3BlY09jY0NvbnN0UFM7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHZhciByZWZsZWN0aW9uRGVjb2RlID0gb3B0aW9ucy5yZ2JtUmVmbGVjdGlvbiA/IFwiZGVjb2RlUkdCTVwiIDogb3B0aW9ucy5oZHJSZWZsZWN0aW9uID8gXCJcIiA6IFwiZ2FtbWFDb3JyZWN0SW5wdXRcIjtcbiAgaWYgKGN1YmVtYXBSZWZsZWN0aW9uIHx8IG9wdGlvbnMucHJlZmlsdGVyZWRDdWJlbWFwKSB7XG4gICAgaWYgKG9wdGlvbnMucHJlZmlsdGVyZWRDdWJlbWFwKSB7XG4gICAgICBpZiAodXNlVGV4Q3ViZUxvZCkge1xuICAgICAgICBjb2RlICs9IGNodW5rcy5yZWZsZWN0aW9uUHJlZmlsdGVyZWRDdWJlTG9kUFMucmVwbGFjZSgvXFwkREVDT0RFL2csIHJlZmxlY3Rpb25EZWNvZGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MucmVmbGVjdGlvblByZWZpbHRlcmVkQ3ViZVBTLnJlcGxhY2UoL1xcJERFQ09ERS9nLCByZWZsZWN0aW9uRGVjb2RlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBjaHVua3MucmVmbGVjdGlvbkN1YmVQUy5yZXBsYWNlKC9cXCR0ZXh0dXJlQ3ViZVNBTVBMRS9nLCBvcHRpb25zLnJnYm1SZWZsZWN0aW9uID8gXCJ0ZXh0dXJlQ3ViZVJHQk1cIiA6IG9wdGlvbnMuaGRyUmVmbGVjdGlvbiA/IFwidGV4dHVyZUN1YmVcIiA6IFwidGV4dHVyZUN1YmVTUkdCXCIpO1xuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5zcGhlcmVNYXApIHtcbiAgICB2YXIgc2NvZGUgPSBkZXZpY2UuZnJhZ21lbnRVbmlmb3Jtc0NvdW50ID4gMTYgPyBjaHVua3MucmVmbGVjdGlvblNwaGVyZVBTIDogY2h1bmtzLnJlZmxlY3Rpb25TcGhlcmVMb3dQUztcbiAgICBzY29kZSA9IHNjb2RlLnJlcGxhY2UoL1xcJHRleHR1cmUyRFNBTVBMRS9nLCBvcHRpb25zLnJnYm1SZWZsZWN0aW9uID8gXCJ0ZXh0dXJlMkRSR0JNXCIgOiBvcHRpb25zLmhkclJlZmxlY3Rpb24gPyBcInRleHR1cmUyRFwiIDogXCJ0ZXh0dXJlMkRTUkdCXCIpO1xuICAgIGNvZGUgKz0gc2NvZGU7XG4gIH1cbiAgaWYgKG9wdGlvbnMuZHBBdGxhcykge1xuICAgIGNvZGUgKz0gY2h1bmtzLnJlZmxlY3Rpb25EcEF0bGFzUFMucmVwbGFjZSgvXFwkdGV4dHVyZTJEU0FNUExFL2csIG9wdGlvbnMucmdibVJlZmxlY3Rpb24gPyBcInRleHR1cmUyRFJHQk1cIiA6IG9wdGlvbnMuaGRyUmVmbGVjdGlvbiA/IFwidGV4dHVyZTJEXCIgOiBcInRleHR1cmUyRFNSR0JcIik7XG4gIH1cbiAgaWYgKChjdWJlbWFwUmVmbGVjdGlvbiB8fCBvcHRpb25zLnNwaGVyZU1hcCB8fCBvcHRpb25zLmRwQXRsYXMpICYmIG9wdGlvbnMucmVmcmFjdGlvbikge1xuICAgIGNvZGUgKz0gY2h1bmtzLnJlZnJhY3Rpb25QUztcbiAgfVxuICBpZiAobnVtU2hhZG93TGlnaHRzID4gMCkge1xuICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfUENGM10pIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnNoYWRvd1N0YW5kYXJkUFM7XG4gICAgfVxuICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfUENGNV0pIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnNoYWRvd1N0YW5kYXJkR0wyUFM7XG4gICAgfVxuICAgIGlmICh1c2VWc20pIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnNoYWRvd1ZTTV9jb21tb25QUztcbiAgICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfVlNNOF0pIHtcbiAgICAgICAgY29kZSArPSBjaHVua3Muc2hhZG93VlNNOFBTO1xuICAgICAgfVxuICAgICAgaWYgKHNoYWRvd1R5cGVVc2VkW3BjLlNIQURPV19WU00xNl0pIHtcbiAgICAgICAgY29kZSArPSBkZXZpY2UuZXh0VGV4dHVyZUhhbGZGbG9hdExpbmVhciA/IGNodW5rcy5zaGFkb3dFVlNNUFMucmVwbGFjZSgvXFwkL2csIFwiMTZcIikgOiBjaHVua3Muc2hhZG93RVZTTW5QUy5yZXBsYWNlKC9cXCQvZywgXCIxNlwiKTtcbiAgICAgIH1cbiAgICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfVlNNMzJdKSB7XG4gICAgICAgIGNvZGUgKz0gZGV2aWNlLmV4dFRleHR1cmVGbG9hdExpbmVhciA/IGNodW5rcy5zaGFkb3dFVlNNUFMucmVwbGFjZSgvXFwkL2csIFwiMzJcIikgOiBjaHVua3Muc2hhZG93RVZTTW5QUy5yZXBsYWNlKC9cXCQvZywgXCIzMlwiKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGRldmljZS53ZWJnbDIgfHwgZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMpIHtcbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBjaHVua3MuYmlhc0NvbnN0UFM7XG4gICAgfVxuICAgIGNvZGUgKz0gY2h1bmtzLnNoYWRvd0Nvb3JkUFMgKyBjaHVua3Muc2hhZG93Q29tbW9uUFM7XG4gICAgaWYgKHVzZVBlcnNwWmJ1ZmZlclNoYWRvdykge1xuICAgICAgY29kZSArPSBjaHVua3Muc2hhZG93Q29vcmRQZXJzcFpidWZmZXJQUztcbiAgICB9XG4gICAgaWYgKG1haW5TaGFkb3dMaWdodCA+PSAwKSB7XG4gICAgICBpZiAoc2hhZG93VHlwZVVzZWRbcGMuU0hBRE9XX1BDRjNdKSB7XG4gICAgICAgIGNvZGUgKz0gY2h1bmtzLnNoYWRvd1N0YW5kYXJkVlNQUztcbiAgICAgIH1cbiAgICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfUENGNV0pIHtcbiAgICAgICAgY29kZSArPSBjaHVua3Muc2hhZG93U3RhbmRhcmRHTDJWU1BTO1xuICAgICAgfVxuICAgICAgaWYgKHVzZVZzbSkge1xuICAgICAgICBpZiAoc2hhZG93VHlwZVVzZWRbcGMuU0hBRE9XX1ZTTThdKSB7XG4gICAgICAgICAgY29kZSArPSBjaHVua3Muc2hhZG93VlNNVlNQUy5yZXBsYWNlKC9cXCRWU00vZywgXCJWU004XCIpLnJlcGxhY2UoL1xcJC9nLCBcIjhcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNoYWRvd1R5cGVVc2VkW3BjLlNIQURPV19WU00xNl0pIHtcbiAgICAgICAgICBjb2RlICs9IGNodW5rcy5zaGFkb3dWU01WU1BTLnJlcGxhY2UoL1xcJFZTTS9nLCBcIlZTTTE2XCIpLnJlcGxhY2UoL1xcJC9nLCBcIjE2XCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzaGFkb3dUeXBlVXNlZFtwYy5TSEFET1dfVlNNMzJdKSB7XG4gICAgICAgICAgY29kZSArPSBjaHVua3Muc2hhZG93VlNNVlNQUy5yZXBsYWNlKC9cXCRWU00vZywgXCJWU00zMlwiKS5yZXBsYWNlKC9cXCQvZywgXCIzMlwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAobGlnaHRpbmcpIHtcbiAgICBjb2RlICs9IGNodW5rcy5saWdodERpZmZ1c2VMYW1iZXJ0UFM7XG4gIH1cbiAgdmFyIHVzZU9sZEFtYmllbnQgPSBmYWxzZTtcbiAgaWYgKG9wdGlvbnMudXNlU3BlY3VsYXIpIHtcbiAgICBpZiAobGlnaHRpbmcpIHtcbiAgICAgIGNvZGUgKz0gb3B0aW9ucy5zaGFkaW5nTW9kZWwgPT09IHBjLlNQRUNVTEFSX1BIT05HID8gY2h1bmtzLmxpZ2h0U3BlY3VsYXJQaG9uZ1BTIDogY2h1bmtzLmxpZ2h0U3BlY3VsYXJCbGlublBTO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5zcGhlcmVNYXAgfHwgY3ViZW1hcFJlZmxlY3Rpb24gfHwgb3B0aW9ucy5kcEF0bGFzIHx8IG9wdGlvbnMuZnJlc25lbE1vZGVsID4gMCkge1xuICAgICAgaWYgKG9wdGlvbnMuZnJlc25lbE1vZGVsID4gMCkge1xuICAgICAgICBpZiAob3B0aW9ucy5jb25zZXJ2ZUVuZXJneSkge1xuICAgICAgICAgIGNvZGUgKz0gY2h1bmtzLmNvbWJpbmVEaWZmdXNlU3BlY3VsYXJQUztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb2RlICs9IGNodW5rcy5jb21iaW5lRGlmZnVzZVNwZWN1bGFyTm9Db25zZXJ2ZVBTO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2RlICs9IGNodW5rcy5jb21iaW5lRGlmZnVzZVNwZWN1bGFyT2xkUFM7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcHRpb25zLmRpZmZ1c2VNYXApIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MuY29tYmluZURpZmZ1c2VTcGVjdWxhck5vUmVmbFBTO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBjaHVua3MuY29tYmluZURpZmZ1c2VTcGVjdWxhck5vUmVmbFNlcGFyYXRlQW1iaWVudFBTO1xuICAgICAgICB1c2VPbGRBbWJpZW50ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29kZSArPSBjaHVua3MuY29tYmluZURpZmZ1c2VQUztcbiAgfVxuICB2YXIgYWRkQW1iaWVudCA9IHRydWU7XG4gIGlmIChvcHRpb25zLmxpZ2h0TWFwIHx8IG9wdGlvbnMubGlnaHRNYXBWZXJ0ZXhDb2xvcikge1xuICAgIGNvZGUgKz0gdGhpcy5fYWRkTWFwKFwibGlnaHRcIiwgb3B0aW9ucywgY2h1bmtzLCB1dk9mZnNldCwgb3B0aW9ucy5saWdodE1hcFZlcnRleENvbG9yID8gY2h1bmtzLmxpZ2h0bWFwU2luZ2xlVmVydFBTIDogb3B0aW9ucy5kaXJMaWdodE1hcCA/IGNodW5rcy5saWdodG1hcERpclBTIDogY2h1bmtzLmxpZ2h0bWFwU2luZ2xlUFMsIG9wdGlvbnMubGlnaHRNYXBGb3JtYXQpO1xuICAgIGFkZEFtYmllbnQgPSBvcHRpb25zLmxpZ2h0TWFwV2l0aG91dEFtYmllbnQ7XG4gIH1cbiAgaWYgKGFkZEFtYmllbnQpIHtcbiAgICBpZiAob3B0aW9ucy5hbWJpZW50U0gpIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLmFtYmllbnRTSFBTO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAob3B0aW9ucy5wcmVmaWx0ZXJlZEN1YmVtYXApIHtcbiAgICAgICAgaWYgKHVzZVRleEN1YmVMb2QpIHtcbiAgICAgICAgICBjb2RlICs9IGNodW5rcy5hbWJpZW50UHJlZmlsdGVyZWRDdWJlTG9kUFMucmVwbGFjZSgvXFwkREVDT0RFL2csIHJlZmxlY3Rpb25EZWNvZGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvZGUgKz0gY2h1bmtzLmFtYmllbnRQcmVmaWx0ZXJlZEN1YmVQUy5yZXBsYWNlKC9cXCRERUNPREUvZywgcmVmbGVjdGlvbkRlY29kZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvZGUgKz0gY2h1bmtzLmFtYmllbnRDb25zdGFudFBTO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5tb2R1bGF0ZUFtYmllbnQgJiYgIXVzZU9sZEFtYmllbnQpIHtcbiAgICBjb2RlICs9IFwidW5pZm9ybSB2ZWMzIG1hdGVyaWFsX2FtYmllbnQ7XFxuXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMuYWxwaGFUZXN0KSB7XG4gICAgY29kZSArPSBjaHVua3MuYWxwaGFUZXN0UFM7XG4gIH1cbiAgaWYgKG9wdGlvbnMubXNkZikge1xuICAgIGNvZGUgKz0gY2h1bmtzLm1zZGZQUztcbiAgfVxuICBpZiAobmVlZHNOb3JtYWwpIHtcbiAgICBjb2RlICs9IGNodW5rcy52aWV3RGlyUFM7XG4gICAgaWYgKG9wdGlvbnMudXNlU3BlY3VsYXIpIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnJlZmxEaXJQUztcbiAgICB9XG4gIH1cbiAgdmFyIGhhc1BvaW50TGlnaHRzID0gZmFsc2U7XG4gIHZhciB1c2VzTGluZWFyRmFsbG9mZiA9IGZhbHNlO1xuICB2YXIgdXNlc0ludlNxdWFyZWRGYWxsb2ZmID0gZmFsc2U7XG4gIHZhciB1c2VzU3BvdCA9IGZhbHNlO1xuICB2YXIgdXNlc0Nvb2tpZSA9IGZhbHNlO1xuICB2YXIgdXNlc0Nvb2tpZU5vdztcbiAgY29kZSArPSBjaHVua3Muc3RhcnRQUztcbiAgaWYgKG5lZWRzTm9ybWFsKSB7XG4gICAgaWYgKG9wdGlvbnMudHdvU2lkZWRMaWdodGluZykge1xuICAgICAgY29kZSArPSBcIiAgIGRWZXJ0ZXhOb3JtYWxXID0gZ2xfRnJvbnRGYWNpbmcgPyB2Tm9ybWFsVyA6IC12Tm9ybWFsVztcXG5cIjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29kZSArPSBcIiAgIGRWZXJ0ZXhOb3JtYWxXID0gdk5vcm1hbFc7XFxuXCI7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmhlaWdodE1hcCB8fCBvcHRpb25zLm5vcm1hbE1hcCkge1xuICAgICAgaWYgKG9wdGlvbnMudHdvU2lkZWRMaWdodGluZykge1xuICAgICAgICBjb2RlICs9IFwiICAgZFRhbmdlbnRXID0gZ2xfRnJvbnRGYWNpbmcgPyB2VGFuZ2VudFcgOiAtdlRhbmdlbnRXO1xcblwiO1xuICAgICAgICBjb2RlICs9IFwiICAgZEJpbm9ybWFsVyA9IGdsX0Zyb250RmFjaW5nID8gdkJpbm9ybWFsVyA6IC12Qmlub3JtYWxXO1xcblwiO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29kZSArPSBcIiAgIGRUYW5nZW50VyA9IHZUYW5nZW50VztcXG5cIjtcbiAgICAgICAgY29kZSArPSBcIiAgIGRCaW5vcm1hbFcgPSB2Qmlub3JtYWxXO1xcblwiO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICB2YXIgb3BhY2l0eVBhcmFsbGF4ID0gZmFsc2U7XG4gIGlmIChvcHRpb25zLmJsZW5kVHlwZSA9PT0gcGMuQkxFTkRfTk9ORSAmJiAhb3B0aW9ucy5hbHBoYVRlc3QgJiYgIW9wdGlvbnMuYWxwaGFUb0NvdmVyYWdlKSB7XG4gICAgY29kZSArPSBcIiAgIGRBbHBoYSA9IDEuMDtcXG5cIjtcbiAgfSBlbHNlIHtcbiAgICBpZiAob3B0aW9ucy5oZWlnaHRNYXAgJiYgb3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgICBvcGFjaXR5UGFyYWxsYXggPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2RlICs9IFwiICAgZ2V0T3BhY2l0eSgpO1xcblwiO1xuICAgICAgaWYgKG9wdGlvbnMuYWxwaGFUZXN0KSB7XG4gICAgICAgIGNvZGUgKz0gXCIgICBhbHBoYVRlc3QoZEFscGhhKTtcXG5cIjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKG5lZWRzTm9ybWFsKSB7XG4gICAgY29kZSArPSBcIiAgIGdldFZpZXdEaXIoKTtcXG5cIjtcbiAgICBpZiAob3B0aW9ucy5oZWlnaHRNYXAgfHwgb3B0aW9ucy5ub3JtYWxNYXApIHtcbiAgICAgIGNvZGUgKz0gXCIgICBnZXRUQk4oKTtcXG5cIjtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuaGVpZ2h0TWFwKSB7XG4gICAgICBjb2RlICs9IFwiICAgZ2V0UGFyYWxsYXgoKTtcXG5cIjtcbiAgICB9XG4gICAgaWYgKG9wYWNpdHlQYXJhbGxheCkge1xuICAgICAgY29kZSArPSBcIiAgIGdldE9wYWNpdHkoKTtcXG5cIjtcbiAgICAgIGlmIChvcHRpb25zLmFscGhhVGVzdCkge1xuICAgICAgICBjb2RlICs9IFwiICAgYWxwaGFUZXN0KGRBbHBoYSk7XFxuXCI7XG4gICAgICB9XG4gICAgfVxuICAgIGNvZGUgKz0gXCIgICBnZXROb3JtYWwoKTtcXG5cIjtcbiAgICBpZiAob3B0aW9ucy51c2VTcGVjdWxhcikge1xuICAgICAgY29kZSArPSBcIiAgIGdldFJlZmxEaXIoKTtcXG5cIjtcbiAgICB9XG4gIH1cbiAgY29kZSArPSBcIiAgIGdldEFsYmVkbygpO1xcblwiO1xuICBpZiAobGlnaHRpbmcgJiYgb3B0aW9ucy51c2VTcGVjdWxhciB8fCByZWZsZWN0aW9ucykge1xuICAgIGNvZGUgKz0gXCIgICBnZXRTcGVjdWxhcml0eSgpO1xcblwiO1xuICAgIGNvZGUgKz0gXCIgICBnZXRHbG9zc2luZXNzKCk7XFxuXCI7XG4gICAgaWYgKG9wdGlvbnMuZnJlc25lbE1vZGVsID4gMCkge1xuICAgICAgY29kZSArPSBcIiAgIGdldEZyZXNuZWwoKTtcXG5cIjtcbiAgICB9XG4gIH1cbiAgaWYgKGFkZEFtYmllbnQpIHtcbiAgICBjb2RlICs9IFwiICAgYWRkQW1iaWVudCgpO1xcblwiO1xuICB9XG4gIGlmIChvcHRpb25zLm1vZHVsYXRlQW1iaWVudCAmJiAhdXNlT2xkQW1iaWVudCkge1xuICAgIGNvZGUgKz0gXCIgICBkRGlmZnVzZUxpZ2h0ICo9IG1hdGVyaWFsX2FtYmllbnQ7XFxuXCI7XG4gIH1cbiAgaWYgKHVzZUFvICYmICFvcHRpb25zLm9jY2x1ZGVEaXJlY3QpIHtcbiAgICBjb2RlICs9IFwiICAgIGFwcGx5QU8oKTtcXG5cIjtcbiAgfVxuICBpZiAob3B0aW9ucy5saWdodE1hcCB8fCBvcHRpb25zLmxpZ2h0TWFwVmVydGV4Q29sb3IpIHtcbiAgICBjb2RlICs9IFwiICAgYWRkTGlnaHRNYXAoKTtcXG5cIjtcbiAgfVxuICBpZiAobGlnaHRpbmcgfHwgcmVmbGVjdGlvbnMpIHtcbiAgICBpZiAoY3ViZW1hcFJlZmxlY3Rpb24gfHwgb3B0aW9ucy5zcGhlcmVNYXAgfHwgb3B0aW9ucy5kcEF0bGFzKSB7XG4gICAgICBjb2RlICs9IFwiICAgYWRkUmVmbGVjdGlvbigpO1xcblwiO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5kaXJMaWdodE1hcCkge1xuICAgICAgY29kZSArPSBcIiAgIGFkZERpckxpZ2h0TWFwKCk7XFxuXCI7XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IG9wdGlvbnMubGlnaHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIGxpZ2h0ID0gb3B0aW9ucy5saWdodHNbaV07XG4gICAgICBsaWdodFR5cGUgPSBsaWdodC5fdHlwZTtcbiAgICAgIHVzZXNDb29raWVOb3cgPSBmYWxzZTtcbiAgICAgIGlmIChsaWdodFR5cGUgPT09IHBjLkxJR0hUVFlQRV9ESVJFQ1RJT05BTCkge1xuICAgICAgICBjb2RlICs9IFwiICAgZExpZ2h0RGlyTm9ybVcgPSBsaWdodFwiICsgaSArIFwiX2RpcmVjdGlvbjtcXG5cIjtcbiAgICAgICAgY29kZSArPSBcIiAgIGRBdHRlbiA9IDEuMDtcXG5cIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChsaWdodC5fY29va2llKSB7XG4gICAgICAgICAgaWYgKGxpZ2h0VHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QgJiYgIWxpZ2h0Ll9jb29raWUuX2N1YmVtYXApIHtcbiAgICAgICAgICAgIHVzZXNDb29raWUgPSB0cnVlO1xuICAgICAgICAgICAgdXNlc0Nvb2tpZU5vdyA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChsaWdodFR5cGUgPT09IHBjLkxJR0hUVFlQRV9QT0lOVCAmJiBsaWdodC5fY29va2llLl9jdWJlbWFwKSB7XG4gICAgICAgICAgICAgIHVzZXNDb29raWUgPSB0cnVlO1xuICAgICAgICAgICAgICB1c2VzQ29va2llTm93ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29kZSArPSBcIiAgIGdldExpZ2h0RGlyUG9pbnQobGlnaHRcIiArIGkgKyBcIl9wb3NpdGlvbik7XFxuXCI7XG4gICAgICAgIGhhc1BvaW50TGlnaHRzID0gdHJ1ZTtcbiAgICAgICAgaWYgKHVzZXNDb29raWVOb3cpIHtcbiAgICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICAgICAgY29kZSArPSBcIiAgIGRBdHRlbjMgPSBnZXRDb29raWUyRFwiICsgKGxpZ2h0Ll9jb29raWVGYWxsb2ZmID8gXCJcIiA6IFwiQ2xpcFwiKSArIChsaWdodC5fY29va2llVHJhbnNmb3JtID8gXCJYZm9ybVwiIDogXCJcIikgKyBcIihsaWdodFwiICsgaSArIFwiX2Nvb2tpZSwgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXRyaXgsIGxpZ2h0XCIgKyBpICsgXCJfY29va2llSW50ZW5zaXR5XCIgKyAobGlnaHQuX2Nvb2tpZVRyYW5zZm9ybSA/IFwiLCBsaWdodFwiICsgaSArIFwiX2Nvb2tpZU1hdHJpeCwgbGlnaHRcIiArIGkgKyBcIl9jb29raWVPZmZzZXRcIiA6IFwiXCIpICsgXCIpLlwiICsgbGlnaHQuX2Nvb2tpZUNoYW5uZWwgKyBcIjtcXG5cIjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29kZSArPSBcIiAgIGRBdHRlbjMgPSBnZXRDb29raWVDdWJlKGxpZ2h0XCIgKyBpICsgXCJfY29va2llLCBsaWdodFwiICsgaSArIFwiX3NoYWRvd01hdHJpeCwgbGlnaHRcIiArIGkgKyBcIl9jb29raWVJbnRlbnNpdHkpLlwiICsgbGlnaHQuX2Nvb2tpZUNoYW5uZWwgKyBcIjtcXG5cIjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpZ2h0Ll9mYWxsb2ZmTW9kZSA9PT0gcGMuTElHSFRGQUxMT0ZGX0xJTkVBUikge1xuICAgICAgICAgIGNvZGUgKz0gXCIgICBkQXR0ZW4gPSBnZXRGYWxsb2ZmTGluZWFyKGxpZ2h0XCIgKyBpICsgXCJfcmFkaXVzKTtcXG5cIjtcbiAgICAgICAgICB1c2VzTGluZWFyRmFsbG9mZiA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29kZSArPSBcIiAgIGRBdHRlbiA9IGdldEZhbGxvZmZJbnZTcXVhcmVkKGxpZ2h0XCIgKyBpICsgXCJfcmFkaXVzKTtcXG5cIjtcbiAgICAgICAgICB1c2VzSW52U3F1YXJlZEZhbGxvZmYgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvZGUgKz0gXCIgICBpZiAoZEF0dGVuID4gMC4wMDAwMSkge1xcblwiO1xuICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICAgIGlmICghKHVzZXNDb29raWVOb3cgJiYgIWxpZ2h0Ll9jb29raWVGYWxsb2ZmKSkge1xuICAgICAgICAgICAgY29kZSArPSBcIiAgICAgICBkQXR0ZW4gKj0gZ2V0U3BvdEVmZmVjdChsaWdodFwiICsgaSArIFwiX2RpcmVjdGlvbiwgbGlnaHRcIiArIGkgKyBcIl9pbm5lckNvbmVBbmdsZSwgbGlnaHRcIiArIGkgKyBcIl9vdXRlckNvbmVBbmdsZSk7XFxuXCI7XG4gICAgICAgICAgICB1c2VzU3BvdCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb2RlICs9IFwiICAgICAgIGRBdHRlbiAqPSBnZXRMaWdodERpZmZ1c2UoKTtcXG5cIjtcbiAgICAgIGlmIChsaWdodC5jYXN0U2hhZG93cyAmJiAhb3B0aW9ucy5ub1NoYWRvdykge1xuICAgICAgICB2YXIgc2hhZG93UmVhZE1vZGUgPSBudWxsO1xuICAgICAgICB2YXIgZXZzbUV4cDtcbiAgICAgICAgaWYgKGxpZ2h0Ll9zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNOCkge1xuICAgICAgICAgIHNoYWRvd1JlYWRNb2RlID0gXCJWU004XCI7XG4gICAgICAgICAgZXZzbUV4cCA9IFwiMC4wXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGxpZ2h0Ll9zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNMTYpIHtcbiAgICAgICAgICAgIHNoYWRvd1JlYWRNb2RlID0gXCJWU00xNlwiO1xuICAgICAgICAgICAgZXZzbUV4cCA9IFwiNS41NFwiO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobGlnaHQuX3NoYWRvd1R5cGUgPT09IHBjLlNIQURPV19WU00zMikge1xuICAgICAgICAgICAgICBzaGFkb3dSZWFkTW9kZSA9IFwiVlNNMzJcIjtcbiAgICAgICAgICAgICAgaWYgKGRldmljZS5leHRUZXh0dXJlRmxvYXRIaWdoUHJlY2lzaW9uKSB7XG4gICAgICAgICAgICAgICAgZXZzbUV4cCA9IFwiMTUuMFwiO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGV2c21FeHAgPSBcIjUuNTRcIjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKGxpZ2h0Ll9zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfUENGNSkge1xuICAgICAgICAgICAgICAgIHNoYWRvd1JlYWRNb2RlID0gXCJQQ0Y1eDVcIjtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzaGFkb3dSZWFkTW9kZSA9IFwiUENGM3gzXCI7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNoYWRvd1JlYWRNb2RlICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGxpZ2h0VHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICAgICAgICBzaGFkb3dDb29yZEFyZ3MgPSBcIihsaWdodFwiICsgaSArIFwiX3NoYWRvd01hcCwgbGlnaHRcIiArIGkgKyBcIl9zaGFkb3dQYXJhbXMpO1xcblwiO1xuICAgICAgICAgICAgaWYgKGxpZ2h0Ll9ub3JtYWxPZmZzZXRCaWFzKSB7XG4gICAgICAgICAgICAgIGNvZGUgKz0gXCIgICAgICAgbm9ybWFsT2Zmc2V0UG9pbnRTaGFkb3cobGlnaHRcIiArIGkgKyBcIl9zaGFkb3dQYXJhbXMpO1xcblwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29kZSArPSBcIiAgICAgICBkQXR0ZW4gKj0gZ2V0U2hhZG93UG9pbnRcIiArIHNoYWRvd1JlYWRNb2RlICsgc2hhZG93Q29vcmRBcmdzO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobWFpblNoYWRvd0xpZ2h0ID09PSBpKSB7XG4gICAgICAgICAgICAgIHNoYWRvd1JlYWRNb2RlICs9IFwiVlNcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNoYWRvd0Nvb3JkQXJncyA9IFwiKGxpZ2h0XCIgKyBpICsgXCJfc2hhZG93TWF0cml4LCBsaWdodFwiICsgaSArIFwiX3NoYWRvd1BhcmFtcyk7XFxuXCI7XG4gICAgICAgICAgICAgIGNvZGUgKz0gdGhpcy5fbm9uUG9pbnRTaGFkb3dNYXBQcm9qZWN0aW9uKGRldmljZSwgb3B0aW9ucy5saWdodHNbaV0sIHNoYWRvd0Nvb3JkQXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGlnaHRUeXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgICAgICAgICBzaGFkb3dSZWFkTW9kZSA9IFwiU3BvdFwiICsgc2hhZG93UmVhZE1vZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb2RlICs9IFwiICAgICAgIGRBdHRlbiAqPSBnZXRTaGFkb3dcIiArIHNoYWRvd1JlYWRNb2RlICsgXCIobGlnaHRcIiArIGkgKyBcIl9zaGFkb3dNYXAsIGxpZ2h0XCIgKyBpICsgXCJfc2hhZG93UGFyYW1zXCIgKyAobGlnaHQuX2lzVnNtID8gXCIsIFwiICsgZXZzbUV4cCA6IFwiXCIpICsgXCIpO1xcblwiO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29kZSArPSBcIiAgICAgICBkRGlmZnVzZUxpZ2h0ICs9IGRBdHRlbiAqIGxpZ2h0XCIgKyBpICsgXCJfY29sb3JcIiArICh1c2VzQ29va2llTm93ID8gXCIgKiBkQXR0ZW4zXCIgOiBcIlwiKSArIFwiO1xcblwiO1xuICAgICAgaWYgKG9wdGlvbnMudXNlU3BlY3VsYXIpIHtcbiAgICAgICAgY29kZSArPSBcIiAgICAgICBkQXR0ZW4gKj0gZ2V0TGlnaHRTcGVjdWxhcigpO1xcblwiO1xuICAgICAgICBjb2RlICs9IFwiICAgICAgIGRTcGVjdWxhckxpZ2h0ICs9IGRBdHRlbiAqIGxpZ2h0XCIgKyBpICsgXCJfY29sb3JcIiArICh1c2VzQ29va2llTm93ID8gXCIgKiBkQXR0ZW4zXCIgOiBcIlwiKSArIFwiO1xcblwiO1xuICAgICAgfVxuICAgICAgaWYgKGxpZ2h0VHlwZSAhPT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgICAgIGNvZGUgKz0gXCIgICB9XFxuXCI7XG4gICAgICB9XG4gICAgICBjb2RlICs9IFwiXFxuXCI7XG4gICAgfVxuICAgIGlmICgoY3ViZW1hcFJlZmxlY3Rpb24gfHwgb3B0aW9ucy5zcGhlcmVNYXAgfHwgb3B0aW9ucy5kcEF0bGFzKSAmJiBvcHRpb25zLnJlZnJhY3Rpb24pIHtcbiAgICAgIGNvZGUgKz0gXCIgICBhZGRSZWZyYWN0aW9uKCk7XFxuXCI7XG4gICAgfVxuICB9XG4gIGNvZGUgKz0gXCJcXG5cIjtcbiAgaWYgKHVzZUFvKSB7XG4gICAgaWYgKG9wdGlvbnMub2NjbHVkZURpcmVjdCkge1xuICAgICAgY29kZSArPSBcIiAgICBhcHBseUFPKCk7XFxuXCI7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLm9jY2x1ZGVTcGVjdWxhcikge1xuICAgICAgY29kZSArPSBcIiAgICBvY2NsdWRlU3BlY3VsYXIoKTtcXG5cIjtcbiAgICB9XG4gIH1cbiAgY29kZSArPSBjaHVua3MuZW5kUFM7XG4gIGlmIChvcHRpb25zLmJsZW5kVHlwZSA9PT0gcGMuQkxFTkRfTk9STUFMIHx8IG9wdGlvbnMuYmxlbmRUeXBlID09PSBwYy5CTEVORF9BRERJVElWRUFMUEhBIHx8IG9wdGlvbnMuYWxwaGFUb0NvdmVyYWdlKSB7XG4gICAgY29kZSArPSBjaHVua3Mub3V0cHV0QWxwaGFQUztcbiAgfSBlbHNlIHtcbiAgICBpZiAob3B0aW9ucy5ibGVuZFR5cGUgPT09IHBjLkJMRU5EX1BSRU1VTFRJUExJRUQpIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLm91dHB1dEFscGhhUHJlbXVsUFM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLm91dHB1dEFscGhhT3BhcXVlUFM7XG4gICAgfVxuICB9XG4gIGlmIChvcHRpb25zLm1zZGYpIHtcbiAgICBjb2RlICs9IFwiICAgZ2xfRnJhZ0NvbG9yID0gYXBwbHlNc2RmKGdsX0ZyYWdDb2xvcik7XFxuXCI7XG4gIH1cbiAgY29kZSArPSBcIlxcblwiO1xuICBjb2RlICs9IHBjLnByb2dyYW1saWIuZW5kKCk7XG4gIGlmIChoYXNQb2ludExpZ2h0cykge1xuICAgIGNvZGUgPSBjaHVua3MubGlnaHREaXJQb2ludFBTICsgY29kZTtcbiAgfVxuICBpZiAodXNlc0xpbmVhckZhbGxvZmYpIHtcbiAgICBjb2RlID0gY2h1bmtzLmZhbGxvZmZMaW5lYXJQUyArIGNvZGU7XG4gIH1cbiAgaWYgKHVzZXNJbnZTcXVhcmVkRmFsbG9mZikge1xuICAgIGNvZGUgPSBjaHVua3MuZmFsbG9mZkludlNxdWFyZWRQUyArIGNvZGU7XG4gIH1cbiAgaWYgKHVzZXNTcG90KSB7XG4gICAgY29kZSA9IGNodW5rcy5zcG90UFMgKyBjb2RlO1xuICB9XG4gIGlmICh1c2VzQ29va2llKSB7XG4gICAgY29kZSA9IGNodW5rcy5jb29raWVQUyArIGNvZGU7XG4gIH1cbiAgdmFyIHN0cnVjdENvZGUgPSBcIlwiO1xuICBpZiAoY29kZS5pbmNsdWRlcyhcImRSZWZsZWN0aW9uXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzQgZFJlZmxlY3Rpb247XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkVEJOXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcIm1hdDMgZFRCTjtcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRBbGJlZG9cIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkQWxiZWRvO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZEVtaXNzaW9uXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZEVtaXNzaW9uO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZE5vcm1hbFdcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkTm9ybWFsVztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRWZXJ0ZXhOb3JtYWxXXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZFZlcnRleE5vcm1hbFc7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkVGFuZ2VudFdcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkVGFuZ2VudFc7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkQmlub3JtYWxXXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZEJpbm9ybWFsVztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRWaWV3RGlyV1wiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJ2ZWMzIGRWaWV3RGlyVztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRSZWZsRGlyV1wiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJ2ZWMzIGRSZWZsRGlyVztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImREaWZmdXNlTGlnaHRcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkRGlmZnVzZUxpZ2h0O1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZFNwZWN1bGFyTGlnaHRcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkU3BlY3VsYXJMaWdodDtcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRMaWdodERpck5vcm1XXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZExpZ2h0RGlyTm9ybVc7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkTGlnaHREaXJXXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZExpZ2h0RGlyVztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRMaWdodFBvc1dcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkTGlnaHRQb3NXO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZFNoYWRvd0Nvb3JkXCIpKSB7XG4gICAgc3RydWN0Q29kZSArPSBcInZlYzMgZFNoYWRvd0Nvb3JkO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZE5vcm1hbE1hcFwiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJ2ZWMzIGROb3JtYWxNYXA7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkU3BlY3VsYXJpdHlcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMyBkU3BlY3VsYXJpdHk7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkVXZPZmZzZXRcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjMiBkVXZPZmZzZXQ7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkR2xvc3NpbmVzc1wiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJmbG9hdCBkR2xvc3NpbmVzcztcXG5cIjtcbiAgfVxuICBpZiAoY29kZS5pbmNsdWRlcyhcImRBbHBoYVwiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJmbG9hdCBkQWxwaGE7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkQXR0ZW5cIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwiZmxvYXQgZEF0dGVuO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZEF0dGVuM1wiKSkge1xuICAgIHN0cnVjdENvZGUgKz0gXCJ2ZWMzIGRBdHRlbjM7XFxuXCI7XG4gIH1cbiAgaWYgKGNvZGUuaW5jbHVkZXMoXCJkQW9cIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwiZmxvYXQgZEFvO1xcblwiO1xuICB9XG4gIGlmIChjb2RlLmluY2x1ZGVzKFwiZE1zZGZcIikpIHtcbiAgICBzdHJ1Y3RDb2RlICs9IFwidmVjNCBkTXNkZjtcXG5cIjtcbiAgfVxuICBjb2RlID0gY29kZUJlZ2luICsgc3RydWN0Q29kZSArIGNvZGU7XG4gIGZzaGFkZXIgPSBjb2RlO1xuICByZXR1cm4ge2F0dHJpYnV0ZXM6YXR0cmlidXRlcywgdnNoYWRlcjp2c2hhZGVyLCBmc2hhZGVyOmZzaGFkZXIsIHRhZzpwYy5TSEFERVJUQUdfTUFURVJJQUx9O1xufX07XG5wYy5wcm9ncmFtbGliLnBpY2sgPSB7Z2VuZXJhdGVLZXk6ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBrZXkgPSBcInBpY2tcIjtcbiAgaWYgKG9wdGlvbnMuc2tpbikge1xuICAgIGtleSArPSBcIl9za2luXCI7XG4gIH1cbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGtleSArPSBcIl9vcGFtXCIgKyBvcHRpb25zLm9wYWNpdHlDaGFubmVsO1xuICB9XG4gIGlmIChvcHRpb25zLnNjcmVlblNwYWNlKSB7XG4gICAga2V5ICs9IFwiX3NjcmVlbnNwYWNlXCI7XG4gIH1cbiAgcmV0dXJuIGtleTtcbn0sIGNyZWF0ZVNoYWRlckRlZmluaXRpb246ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBhdHRyaWJ1dGVzID0ge3ZlcnRleF9wb3NpdGlvbjpwYy5TRU1BTlRJQ19QT1NJVElPTn07XG4gIGlmIChvcHRpb25zLnNraW4pIHtcbiAgICBhdHRyaWJ1dGVzLnZlcnRleF9ib25lV2VpZ2h0cyA9IHBjLlNFTUFOVElDX0JMRU5EV0VJR0hUO1xuICAgIGF0dHJpYnV0ZXMudmVydGV4X2JvbmVJbmRpY2VzID0gcGMuU0VNQU5USUNfQkxFTkRJTkRJQ0VTO1xuICB9XG4gIGlmIChvcHRpb25zLm9wYWNpdHlNYXApIHtcbiAgICBhdHRyaWJ1dGVzLnZlcnRleF90ZXhDb29yZDAgPSBwYy5TRU1BTlRJQ19URVhDT09SRDA7XG4gIH1cbiAgdmFyIGNodW5rcyA9IHBjLnNoYWRlckNodW5rcztcbiAgdmFyIGNvZGUgPSBcIlwiO1xuICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1EZWNsVlM7XG4gIGlmIChvcHRpb25zLnNraW4pIHtcbiAgICBjb2RlICs9IHBjLnByb2dyYW1saWIuc2tpbkNvZGUoZGV2aWNlKTtcbiAgICBjb2RlICs9IGNodW5rcy50cmFuc2Zvcm1Ta2lubmVkVlM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKG9wdGlvbnMuc2NyZWVuU3BhY2UpIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVNjcmVlblNwYWNlVlM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUgKz0gY2h1bmtzLnRyYW5zZm9ybVZTO1xuICAgIH1cbiAgfVxuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgY29kZSArPSBcImF0dHJpYnV0ZSB2ZWMyIHZlcnRleF90ZXhDb29yZDA7XFxuXFxuXCI7XG4gICAgY29kZSArPSBcInZhcnlpbmcgdmVjMiB2VXYwO1xcblxcblwiO1xuICB9XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5iZWdpbigpO1xuICBjb2RlICs9IFwiICAgZ2xfUG9zaXRpb24gPSBnZXRQb3NpdGlvbigpO1xcblwiO1xuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgY29kZSArPSBcIiAgICB2VXYwID0gdmVydGV4X3RleENvb3JkMDtcXG5cIjtcbiAgfVxuICBjb2RlICs9IHBjLnByb2dyYW1saWIuZW5kKCk7XG4gIHZhciB2c2hhZGVyID0gY29kZTtcbiAgY29kZSA9IHBjLnByb2dyYW1saWIucHJlY2lzaW9uQ29kZShkZXZpY2UpO1xuICBjb2RlICs9IFwidW5pZm9ybSB2ZWM0IHVDb2xvcjtcIjtcbiAgaWYgKG9wdGlvbnMub3BhY2l0eU1hcCkge1xuICAgIGNvZGUgKz0gXCJ2YXJ5aW5nIHZlYzIgdlV2MDtcXG5cXG5cIjtcbiAgICBjb2RlICs9IFwidW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9vcGFjaXR5TWFwO1xcblxcblwiO1xuICAgIGNvZGUgKz0gY2h1bmtzLmFscGhhVGVzdFBTO1xuICB9XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5iZWdpbigpO1xuICBpZiAob3B0aW9ucy5vcGFjaXR5TWFwKSB7XG4gICAgY29kZSArPSBcIiAgICBhbHBoYVRlc3QoIHRleHR1cmUyRCh0ZXh0dXJlX29wYWNpdHlNYXAsIHZVdjApLlwiICsgb3B0aW9ucy5vcGFjaXR5Q2hhbm5lbFswXSArIFwiICk7XFxuXFxuXCI7XG4gIH1cbiAgY29kZSArPSBcIiAgICBnbF9GcmFnQ29sb3IgPSB1Q29sb3I7XFxuXCI7XG4gIGNvZGUgKz0gcGMucHJvZ3JhbWxpYi5lbmQoKTtcbiAgdmFyIGZzaGFkZXIgPSBjb2RlO1xuICByZXR1cm4ge2F0dHJpYnV0ZXM6YXR0cmlidXRlcywgdnNoYWRlcjp2c2hhZGVyLCBmc2hhZGVyOmZzaGFkZXJ9O1xufX07XG5wYy5wcm9ncmFtbGliLnNreWJveCA9IHtnZW5lcmF0ZUtleTpmdW5jdGlvbihkZXZpY2UsIG9wdGlvbnMpIHtcbiAgdmFyIGtleSA9IFwic2t5Ym94XCIgKyBvcHRpb25zLnJnYm0gKyBcIiBcIiArIG9wdGlvbnMuaGRyICsgXCIgXCIgKyBvcHRpb25zLmZpeFNlYW1zICsgXCJcIiArIG9wdGlvbnMudG9uZU1hcHBpbmcgKyBcIlwiICsgb3B0aW9ucy5nYW1tYSArIFwiXCIgKyBvcHRpb25zLnVzZUludGVuc2l0eSArIFwiXCIgKyBvcHRpb25zLm1pcDtcbiAgcmV0dXJuIGtleTtcbn0sIGNyZWF0ZVNoYWRlckRlZmluaXRpb246ZnVuY3Rpb24oZGV2aWNlLCBvcHRpb25zKSB7XG4gIHZhciBjaHVua3MgPSBwYy5zaGFkZXJDaHVua3M7XG4gIHZhciBtaXAyc2l6ZSA9IFsxMjgsIDY0LCAxNiwgOCwgNCwgMl07XG4gIHJldHVybiB7YXR0cmlidXRlczp7YVBvc2l0aW9uOnBjLlNFTUFOVElDX1BPU0lUSU9OfSwgdnNoYWRlcjpjaHVua3Muc2t5Ym94VlMsIGZzaGFkZXI6cGMucHJvZ3JhbWxpYi5wcmVjaXNpb25Db2RlKGRldmljZSkgKyAob3B0aW9ucy5taXAgPyBjaHVua3MuZml4Q3ViZW1hcFNlYW1zU3RyZXRjaFBTIDogY2h1bmtzLmZpeEN1YmVtYXBTZWFtc05vbmVQUykgKyAob3B0aW9ucy51c2VJbnRlbnNpdHkgPyBjaHVua3MuZW52TXVsdGlwbHlQUyA6IGNodW5rcy5lbnZDb25zdFBTKSArIHBjLnByb2dyYW1saWIuZ2FtbWFDb2RlKG9wdGlvbnMuZ2FtbWEpICsgcGMucHJvZ3JhbWxpYi50b25lbWFwQ29kZShvcHRpb25zLnRvbmVNYXBwaW5nKSArIGNodW5rcy5yZ2JtUFMgKyBjaHVua3Muc2t5Ym94SERSUFMucmVwbGFjZSgvXFwkdGV4dHVyZUN1YmVTQU1QTEUvZywgb3B0aW9ucy5yZ2JtID8gXCJ0ZXh0dXJlQ3ViZVJHQk1cIiA6IG9wdGlvbnMuaGRyID8gXCJ0ZXh0dXJlQ3ViZVwiIDogXCJ0ZXh0dXJlQ3ViZVNSR0JcIikucmVwbGFjZSgvXFwkRklYQ09OU1QvZyxcbiAgMS4wIC0gMS4wIC8gbWlwMnNpemVbb3B0aW9ucy5taXBdICsgXCJcIil9O1xufX07XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgcHJpbWl0aXZlID0ge3R5cGU6cGMuUFJJTUlUSVZFX1RSSVNUUklQLCBiYXNlOjAsIGNvdW50OjQsIGluZGV4ZWQ6ZmFsc2V9O1xuICB2YXIgUG9zdEVmZmVjdCA9IGZ1bmN0aW9uKGdyYXBoaWNzRGV2aWNlKSB7XG4gICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICB0aGlzLnNoYWRlciA9IG51bGw7XG4gICAgdGhpcy5kZXB0aE1hcCA9IG51bGw7XG4gICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSBwYy5jcmVhdGVGdWxsc2NyZWVuUXVhZChncmFwaGljc0RldmljZSk7XG4gICAgdGhpcy5uZWVkc0RlcHRoQnVmZmVyID0gZmFsc2U7XG4gIH07XG4gIFBvc3RFZmZlY3QucHJvdG90eXBlID0ge3JlbmRlcjpmdW5jdGlvbihpbnB1dFRhcmdldCwgb3V0cHV0VGFyZ2V0LCByZWN0KSB7XG4gIH19O1xuICBmdW5jdGlvbiBjcmVhdGVGdWxsc2NyZWVuUXVhZChkZXZpY2UpIHtcbiAgICB2YXIgdmVydGV4Rm9ybWF0ID0gbmV3IHBjLlZlcnRleEZvcm1hdChkZXZpY2UsIFt7c2VtYW50aWM6cGMuU0VNQU5USUNfUE9TSVRJT04sIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XSk7XG4gICAgdmFyIHZlcnRleEJ1ZmZlciA9IG5ldyBwYy5WZXJ0ZXhCdWZmZXIoZGV2aWNlLCB2ZXJ0ZXhGb3JtYXQsIDQpO1xuICAgIHZhciBpdGVyYXRvciA9IG5ldyBwYy5WZXJ0ZXhJdGVyYXRvcih2ZXJ0ZXhCdWZmZXIpO1xuICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCgtMS4wLCAtMS4wKTtcbiAgICBpdGVyYXRvci5uZXh0KCk7XG4gICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19QT1NJVElPTl0uc2V0KDEuMCwgLTEuMCk7XG4gICAgaXRlcmF0b3IubmV4dCgpO1xuICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCgtMS4wLCAxLjApO1xuICAgIGl0ZXJhdG9yLm5leHQoKTtcbiAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX1BPU0lUSU9OXS5zZXQoMS4wLCAxLjApO1xuICAgIGl0ZXJhdG9yLmVuZCgpO1xuICAgIHJldHVybiB2ZXJ0ZXhCdWZmZXI7XG4gIH1cbiAgZnVuY3Rpb24gZHJhd0Z1bGxzY3JlZW5RdWFkKGRldmljZSwgdGFyZ2V0LCB2ZXJ0ZXhCdWZmZXIsIHNoYWRlciwgcmVjdCkge1xuICAgIGRldmljZS5zZXRSZW5kZXJUYXJnZXQodGFyZ2V0KTtcbiAgICBkZXZpY2UudXBkYXRlQmVnaW4oKTtcbiAgICB2YXIgdyA9IHRhcmdldCAhPT0gbnVsbCA/IHRhcmdldC53aWR0aCA6IGRldmljZS53aWR0aDtcbiAgICB2YXIgaCA9IHRhcmdldCAhPT0gbnVsbCA/IHRhcmdldC5oZWlnaHQgOiBkZXZpY2UuaGVpZ2h0O1xuICAgIHZhciB4ID0gMDtcbiAgICB2YXIgeSA9IDA7XG4gICAgaWYgKHJlY3QpIHtcbiAgICAgIHggPSByZWN0LnggKiB3O1xuICAgICAgeSA9IHJlY3QueSAqIGg7XG4gICAgICB3ICo9IHJlY3QuejtcbiAgICAgIGggKj0gcmVjdC53O1xuICAgIH1cbiAgICBkZXZpY2Uuc2V0Vmlld3BvcnQoeCwgeSwgdywgaCk7XG4gICAgZGV2aWNlLnNldFNjaXNzb3IoeCwgeSwgdywgaCk7XG4gICAgdmFyIG9sZEJsZW5kaW5nID0gZGV2aWNlLmdldEJsZW5kaW5nKCk7XG4gICAgdmFyIG9sZERlcHRoVGVzdCA9IGRldmljZS5nZXREZXB0aFRlc3QoKTtcbiAgICB2YXIgb2xkRGVwdGhXcml0ZSA9IGRldmljZS5nZXREZXB0aFdyaXRlKCk7XG4gICAgdmFyIG9sZEN1bGxNb2RlID0gZGV2aWNlLmdldEN1bGxNb2RlKCk7XG4gICAgdmFyIG9sZFdSID0gZGV2aWNlLndyaXRlUmVkO1xuICAgIHZhciBvbGRXRyA9IGRldmljZS53cml0ZUdyZWVuO1xuICAgIHZhciBvbGRXQiA9IGRldmljZS53cml0ZUJsdWU7XG4gICAgdmFyIG9sZFdBID0gZGV2aWNlLndyaXRlQWxwaGE7XG4gICAgZGV2aWNlLnNldEJsZW5kaW5nKGZhbHNlKTtcbiAgICBkZXZpY2Uuc2V0RGVwdGhUZXN0KGZhbHNlKTtcbiAgICBkZXZpY2Uuc2V0RGVwdGhXcml0ZShmYWxzZSk7XG4gICAgZGV2aWNlLnNldEN1bGxNb2RlKHBjLkNVTExGQUNFX0JBQ0spO1xuICAgIGRldmljZS5zZXRDb2xvcldyaXRlKHRydWUsIHRydWUsIHRydWUsIHRydWUpO1xuICAgIGRldmljZS5zZXRWZXJ0ZXhCdWZmZXIodmVydGV4QnVmZmVyLCAwKTtcbiAgICBkZXZpY2Uuc2V0U2hhZGVyKHNoYWRlcik7XG4gICAgZGV2aWNlLmRyYXcocHJpbWl0aXZlKTtcbiAgICBkZXZpY2Uuc2V0QmxlbmRpbmcob2xkQmxlbmRpbmcpO1xuICAgIGRldmljZS5zZXREZXB0aFRlc3Qob2xkRGVwdGhUZXN0KTtcbiAgICBkZXZpY2Uuc2V0RGVwdGhXcml0ZShvbGREZXB0aFdyaXRlKTtcbiAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUob2xkQ3VsbE1vZGUpO1xuICAgIGRldmljZS5zZXRDb2xvcldyaXRlKG9sZFdSLCBvbGRXRywgb2xkV0IsIG9sZFdBKTtcbiAgICBkZXZpY2UudXBkYXRlRW5kKCk7XG4gIH1cbiAgcmV0dXJuIHtQb3N0RWZmZWN0OlBvc3RFZmZlY3QsIGNyZWF0ZUZ1bGxzY3JlZW5RdWFkOmNyZWF0ZUZ1bGxzY3JlZW5RdWFkLCBkcmF3RnVsbHNjcmVlblF1YWQ6ZHJhd0Z1bGxzY3JlZW5RdWFkfTtcbn0oKSk7XG4oZnVuY3Rpb24oKSB7XG4gIHZhciBlbnVtcyA9IHtCTEVORF9TVUJUUkFDVElWRTowLCBCTEVORF9BRERJVElWRToxLCBCTEVORF9OT1JNQUw6MiwgQkxFTkRfTk9ORTozLCBCTEVORF9QUkVNVUxUSVBMSUVEOjQsIEJMRU5EX01VTFRJUExJQ0FUSVZFOjUsIEJMRU5EX0FERElUSVZFQUxQSEE6NiwgQkxFTkRfTVVMVElQTElDQVRJVkUyWDo3LCBCTEVORF9TQ1JFRU46OCwgQkxFTkRfTUlOOjksIEJMRU5EX01BWDoxMCwgRk9HX05PTkU6XCJub25lXCIsIEZPR19MSU5FQVI6XCJsaW5lYXJcIiwgRk9HX0VYUDpcImV4cFwiLCBGT0dfRVhQMjpcImV4cDJcIiwgRlJFU05FTF9OT05FOjAsIEZSRVNORUxfU0NITElDSzoyLCBMQVlFUl9IVUQ6MCwgTEFZRVJfR0laTU86MSwgTEFZRVJfRlg6MiwgTEFZRVJfV09STEQ6MTUsIExJR0hUVFlQRV9ESVJFQ1RJT05BTDowLCBMSUdIVFRZUEVfUE9JTlQ6MSwgTElHSFRUWVBFX1NQT1Q6MiwgTElHSFRGQUxMT0ZGX0xJTkVBUjowLCBMSUdIVEZBTExPRkZfSU5WRVJTRVNRVUFSRUQ6MSwgU0hBRE9XX1BDRjM6MCxcbiAgU0hBRE9XX0RFUFRIOjAsIFNIQURPV19WU004OjEsIFNIQURPV19WU00xNjoyLCBTSEFET1dfVlNNMzI6MywgU0hBRE9XX1BDRjU6NCwgQkxVUl9CT1g6MCwgQkxVUl9HQVVTU0lBTjoxLCBQQVJUSUNMRVNPUlRfTk9ORTowLCBQQVJUSUNMRVNPUlRfRElTVEFOQ0U6MSwgUEFSVElDTEVTT1JUX05FV0VSX0ZJUlNUOjIsIFBBUlRJQ0xFU09SVF9PTERFUl9GSVJTVDozLCBQQVJUSUNMRU1PREVfR1BVOjAsIFBBUlRJQ0xFTU9ERV9DUFU6MSwgRU1JVFRFUlNIQVBFX0JPWDowLCBFTUlUVEVSU0hBUEVfU1BIRVJFOjEsIFBST0pFQ1RJT05fUEVSU1BFQ1RJVkU6MCwgUFJPSkVDVElPTl9PUlRIT0dSQVBISUM6MSwgUkVOREVSU1RZTEVfU09MSUQ6MCwgUkVOREVSU1RZTEVfV0lSRUZSQU1FOjEsIFJFTkRFUlNUWUxFX1BPSU5UUzoyLCBDVUJFUFJPSl9OT05FOjAsIENVQkVQUk9KX0JPWDoxLCBTUEVDVUxBUl9QSE9ORzowLCBTUEVDVUxBUl9CTElOTjoxLCBHQU1NQV9OT05FOjAsIEdBTU1BX1NSR0I6MSxcbiAgR0FNTUFfU1JHQkZBU1Q6MiwgR0FNTUFfU1JHQkhEUjozLCBUT05FTUFQX0xJTkVBUjowLCBUT05FTUFQX0ZJTE1JQzoxLCBUT05FTUFQX0hFSkw6MiwgVE9ORU1BUF9BQ0VTOjMsIFRPTkVNQVBfQUNFUzI6NCwgU1BFQ09DQ19OT05FOjAsIFNQRUNPQ0NfQU86MSwgU1BFQ09DQ19HTE9TU0RFUEVOREVOVDoyLCBTSEFERVJERUZfTk9TSEFET1c6MSwgU0hBREVSREVGX1NLSU46MiwgU0hBREVSREVGX1VWMDo0LCBTSEFERVJERUZfVVYxOjgsIFNIQURFUkRFRl9WQ09MT1I6MTYsIFNIQURFUkRFRl9JTlNUQU5DSU5HOjMyLCBTSEFERVJERUZfTE06NjQsIFNIQURFUkRFRl9ESVJMTToxMjgsIFNIQURFUkRFRl9TQ1JFRU5TUEFDRToyNTYsIExJTkVCQVRDSF9XT1JMRDowLCBMSU5FQkFUQ0hfT1ZFUkxBWToxLCBMSU5FQkFUQ0hfR0laTU86MiwgU0hBRE9XVVBEQVRFX05PTkU6MCwgU0hBRE9XVVBEQVRFX1RISVNGUkFNRToxLCBTSEFET1dVUERBVEVfUkVBTFRJTUU6MiwgU09SVEtFWV9GT1JXQVJEOjAsXG4gIFNPUlRLRVlfREVQVEg6MSwgU0hBREVSX0ZPUldBUkQ6MCwgU0hBREVSX0ZPUldBUkRIRFI6MSwgU0hBREVSX0RFUFRIOjIsIFNIQURFUl9TSEFET1c6MywgU0hBREVSX1BJQ0s6MTgsIEJBS0VfQ09MT1I6MCwgQkFLRV9DT0xPUkRJUjoxLCBWSUVXX0NFTlRFUjowLCBWSUVXX0xFRlQ6MSwgVklFV19SSUdIVDoyfTtcbiAgcGMuZXh0ZW5kKHBjLCBlbnVtcyk7XG4gIHBjLnNjZW5lID0ge307XG4gIHBjLmV4dGVuZChwYy5zY2VuZSwgZW51bXMpO1xufSkoKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBTY2VuZSA9IGZ1bmN0aW9uIFNjZW5lKCkge1xuICAgIHRoaXMucm9vdCA9IG51bGw7XG4gICAgdGhpcy5fZ3Jhdml0eSA9IG5ldyBwYy5WZWMzKDAsIC05LjgsIDApO1xuICAgIHRoaXMuZHJhd0NhbGxzID0gW107XG4gICAgdGhpcy5zaGFkb3dDYXN0ZXJzID0gW107XG4gICAgdGhpcy5pbW1lZGlhdGVEcmF3Q2FsbHMgPSBbXTtcbiAgICB0aGlzLl9mb2cgPSBwYy5GT0dfTk9ORTtcbiAgICB0aGlzLmZvZ0NvbG9yID0gbmV3IHBjLkNvbG9yKDAsIDAsIDApO1xuICAgIHRoaXMuZm9nU3RhcnQgPSAxO1xuICAgIHRoaXMuZm9nRW5kID0gMTAwMDtcbiAgICB0aGlzLmZvZ0RlbnNpdHkgPSAwO1xuICAgIHRoaXMuYW1iaWVudExpZ2h0ID0gbmV3IHBjLkNvbG9yKDAsIDAsIDApO1xuICAgIHRoaXMuX2dhbW1hQ29ycmVjdGlvbiA9IHBjLkdBTU1BX05PTkU7XG4gICAgdGhpcy5fdG9uZU1hcHBpbmcgPSAwO1xuICAgIHRoaXMuZXhwb3N1cmUgPSAxLjA7XG4gICAgdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWQgPSBbbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbF07XG4gICAgdGhpcy5fc2t5Ym94Q3ViZU1hcCA9IG51bGw7XG4gICAgdGhpcy5fc2t5Ym94TW9kZWwgPSBudWxsO1xuICAgIHRoaXMuX3NreWJveEludGVuc2l0eSA9IDE7XG4gICAgdGhpcy5fc2t5Ym94TWlwID0gMDtcbiAgICB0aGlzLmxpZ2h0bWFwU2l6ZU11bHRpcGxpZXIgPSAxO1xuICAgIHRoaXMubGlnaHRtYXBNYXhSZXNvbHV0aW9uID0gMjA0ODtcbiAgICB0aGlzLmxpZ2h0bWFwTW9kZSA9IHBjLkJBS0VfQ09MT1JESVI7XG4gICAgdGhpcy5fc3RhdHMgPSB7bWVzaEluc3RhbmNlczowLCBsaWdodHM6MCwgZHluYW1pY0xpZ2h0czowLCBiYWtlZExpZ2h0czowLCBsYXN0U3RhdGljUHJlcGFyZUZ1bGxUaW1lOjAsIGxhc3RTdGF0aWNQcmVwYXJlU2VhcmNoVGltZTowLCBsYXN0U3RhdGljUHJlcGFyZVdyaXRlVGltZTowLCBsYXN0U3RhdGljUHJlcGFyZVRyaUFhYmJUaW1lOjAsIGxhc3RTdGF0aWNQcmVwYXJlQ29tYmluZVRpbWU6MCwgdXBkYXRlU2hhZGVyc1RpbWU6MH07XG4gICAgdGhpcy5fbW9kZWxzID0gW107XG4gICAgdGhpcy5fbGlnaHRzID0gW107XG4gICAgdGhpcy5fZ2xvYmFsTGlnaHRzID0gW107XG4gICAgdGhpcy5fbG9jYWxMaWdodHMgPSBbW10sIFtdXTtcbiAgICB0aGlzLl91cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICB0aGlzLl9zY2VuZVNoYWRlcnNWZXJzaW9uID0gMDtcbiAgICB0aGlzLl9uZWVkc1N0YXRpY1ByZXBhcmUgPSB0cnVlO1xuICB9O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcInVwZGF0ZVNoYWRlcnNcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdXBkYXRlU2hhZGVycztcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbCkge1xuICAgIGlmICh2YWwgIT09IHRoaXMuX3VwZGF0ZVNoYWRlcnMpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVNoYWRlcnMgPSB2YWw7XG4gICAgICBpZiAoIXRoaXMuX21vZGVscykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodmFsKSB7XG4gICAgICAgIHRoaXMuX3NjZW5lU2hhZGVyc1ZlcnNpb24rKztcbiAgICAgIH1cbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLl9tb2RlbHMubGVuZ3RoO2krKykge1xuICAgICAgICB0aGlzLl9tb2RlbHNbaV0uX3NoYWRlcnNWZXJzaW9uID0gdGhpcy5fc2NlbmVTaGFkZXJzVmVyc2lvbjtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNjZW5lLnByb3RvdHlwZSwgXCJmb2dcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fZm9nO1xuICB9LCBzZXQ6ZnVuY3Rpb24odHlwZSkge1xuICAgIGlmICh0eXBlICE9PSB0aGlzLl9mb2cpIHtcbiAgICAgIHRoaXMuX2ZvZyA9IHR5cGU7XG4gICAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcImdhbW1hQ29ycmVjdGlvblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9nYW1tYUNvcnJlY3Rpb247XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5fZ2FtbWFDb3JyZWN0aW9uKSB7XG4gICAgICB0aGlzLl9nYW1tYUNvcnJlY3Rpb24gPSB2YWx1ZTtcbiAgICAgIHRoaXMudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY2VuZS5wcm90b3R5cGUsIFwidG9uZU1hcHBpbmdcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdG9uZU1hcHBpbmc7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5fdG9uZU1hcHBpbmcpIHtcbiAgICAgIHRoaXMuX3RvbmVNYXBwaW5nID0gdmFsdWU7XG4gICAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcInNreWJveFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9za3lib3hDdWJlTWFwO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9za3lib3hDdWJlTWFwID0gdmFsdWU7XG4gICAgdGhpcy5fcmVzZXRTa3lib3hNb2RlbCgpO1xuICAgIHRoaXMudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNjZW5lLnByb3RvdHlwZSwgXCJza3lib3hJbnRlbnNpdHlcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2t5Ym94SW50ZW5zaXR5O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9za3lib3hJbnRlbnNpdHkgPSB2YWx1ZTtcbiAgICB0aGlzLl9yZXNldFNreWJveE1vZGVsKCk7XG4gICAgdGhpcy51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcInNreWJveE1pcFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9za3lib3hNaXA7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3NreWJveE1pcCA9IHZhbHVlO1xuICAgIHRoaXMuX3Jlc2V0U2t5Ym94TW9kZWwoKTtcbiAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY2VuZS5wcm90b3R5cGUsIFwic2t5Ym94UHJlZmlsdGVyZWQxMjhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbMF07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFswXSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbMF0gPSB2YWx1ZTtcbiAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY2VuZS5wcm90b3R5cGUsIFwic2t5Ym94UHJlZmlsdGVyZWQ2NFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFsxXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzFdID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFsxXSA9IHZhbHVlO1xuICAgIHRoaXMudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNjZW5lLnByb3RvdHlwZSwgXCJza3lib3hQcmVmaWx0ZXJlZDMyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzJdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbMl0gPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzJdID0gdmFsdWU7XG4gICAgdGhpcy51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcInNreWJveFByZWZpbHRlcmVkMTZcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbM107XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFszXSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbM10gPSB2YWx1ZTtcbiAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY2VuZS5wcm90b3R5cGUsIFwic2t5Ym94UHJlZmlsdGVyZWQ4XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzRdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbNF0gPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzRdID0gdmFsdWU7XG4gICAgdGhpcy51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NlbmUucHJvdG90eXBlLCBcInNreWJveFByZWZpbHRlcmVkNFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFs1XTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX3NreWJveFByZWZpbHRlcmVkWzVdID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFs1XSA9IHZhbHVlO1xuICAgIHRoaXMudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gIH19KTtcbiAgU2NlbmUucHJvdG90eXBlLmFwcGx5U2V0dGluZ3MgPSBmdW5jdGlvbihzZXR0aW5ncykge1xuICAgIHRoaXMuX2dyYXZpdHkuc2V0KHNldHRpbmdzLnBoeXNpY3MuZ3Jhdml0eVswXSwgc2V0dGluZ3MucGh5c2ljcy5ncmF2aXR5WzFdLCBzZXR0aW5ncy5waHlzaWNzLmdyYXZpdHlbMl0pO1xuICAgIHRoaXMuYW1iaWVudExpZ2h0LnNldChzZXR0aW5ncy5yZW5kZXIuZ2xvYmFsX2FtYmllbnRbMF0sIHNldHRpbmdzLnJlbmRlci5nbG9iYWxfYW1iaWVudFsxXSwgc2V0dGluZ3MucmVuZGVyLmdsb2JhbF9hbWJpZW50WzJdKTtcbiAgICB0aGlzLl9mb2cgPSBzZXR0aW5ncy5yZW5kZXIuZm9nO1xuICAgIHRoaXMuZm9nQ29sb3Iuc2V0KHNldHRpbmdzLnJlbmRlci5mb2dfY29sb3JbMF0sIHNldHRpbmdzLnJlbmRlci5mb2dfY29sb3JbMV0sIHNldHRpbmdzLnJlbmRlci5mb2dfY29sb3JbMl0pO1xuICAgIHRoaXMuZm9nU3RhcnQgPSBzZXR0aW5ncy5yZW5kZXIuZm9nX3N0YXJ0O1xuICAgIHRoaXMuZm9nRW5kID0gc2V0dGluZ3MucmVuZGVyLmZvZ19lbmQ7XG4gICAgdGhpcy5mb2dEZW5zaXR5ID0gc2V0dGluZ3MucmVuZGVyLmZvZ19kZW5zaXR5O1xuICAgIHRoaXMuX2dhbW1hQ29ycmVjdGlvbiA9IHNldHRpbmdzLnJlbmRlci5nYW1tYV9jb3JyZWN0aW9uO1xuICAgIHRoaXMuX3RvbmVNYXBwaW5nID0gc2V0dGluZ3MucmVuZGVyLnRvbmVtYXBwaW5nO1xuICAgIHRoaXMubGlnaHRtYXBTaXplTXVsdGlwbGllciA9IHNldHRpbmdzLnJlbmRlci5saWdodG1hcFNpemVNdWx0aXBsaWVyO1xuICAgIHRoaXMubGlnaHRtYXBNYXhSZXNvbHV0aW9uID0gc2V0dGluZ3MucmVuZGVyLmxpZ2h0bWFwTWF4UmVzb2x1dGlvbjtcbiAgICB0aGlzLmxpZ2h0bWFwTW9kZSA9IHNldHRpbmdzLnJlbmRlci5saWdodG1hcE1vZGU7XG4gICAgdGhpcy5leHBvc3VyZSA9IHNldHRpbmdzLnJlbmRlci5leHBvc3VyZTtcbiAgICB0aGlzLl9za3lib3hJbnRlbnNpdHkgPSBzZXR0aW5ncy5yZW5kZXIuc2t5Ym94SW50ZW5zaXR5ID09PSB1bmRlZmluZWQgPyAxIDogc2V0dGluZ3MucmVuZGVyLnNreWJveEludGVuc2l0eTtcbiAgICB0aGlzLl9za3lib3hNaXAgPSBzZXR0aW5ncy5yZW5kZXIuc2t5Ym94TWlwID09PSB1bmRlZmluZWQgPyAwIDogc2V0dGluZ3MucmVuZGVyLnNreWJveE1pcDtcbiAgICB0aGlzLl9yZXNldFNreWJveE1vZGVsKCk7XG4gICAgdGhpcy51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgfTtcbiAgU2NlbmUucHJvdG90eXBlLnVwZGF0ZVNoYWRlcnNGdW5jID0gZnVuY3Rpb24oZGV2aWNlKSB7XG4gICAgdmFyIGk7XG4gICAgdmFyIHRpbWUgPSBwYy5ub3coKTtcbiAgICBpZiAodGhpcy5fc2t5Ym94Q3ViZU1hcCAmJiAhdGhpcy5fc2t5Ym94TW9kZWwpIHtcbiAgICAgIHZhciBtYXRlcmlhbCA9IG5ldyBwYy5NYXRlcmlhbDtcbiAgICAgIHZhciBzY2VuZSA9IHRoaXM7XG4gICAgICBtYXRlcmlhbC51cGRhdGVTaGFkZXIgPSBmdW5jdGlvbihkZXYsIHNjLCBkZWZzLCBzdGF0aWNMaWdodExpc3QsIHBhc3MpIHtcbiAgICAgICAgdmFyIGxpYnJhcnkgPSBkZXZpY2UuZ2V0UHJvZ3JhbUxpYnJhcnkoKTtcbiAgICAgICAgdmFyIHNoYWRlciA9IGxpYnJhcnkuZ2V0UHJvZ3JhbShcInNreWJveFwiLCB7cmdibTpzY2VuZS5fc2t5Ym94Q3ViZU1hcC5yZ2JtLCBoZHI6c2NlbmUuX3NreWJveEN1YmVNYXAucmdibSB8fCBzY2VuZS5fc2t5Ym94Q3ViZU1hcC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYsIHVzZUludGVuc2l0eTpzY2VuZS5za3lib3hJbnRlbnNpdHkgIT09IDEsIG1pcDpzY2VuZS5fc2t5Ym94Q3ViZU1hcC5maXhDdWJlbWFwU2VhbXMgPyBzY2VuZS5za3lib3hNaXAgOiAwLCBmaXhTZWFtczpzY2VuZS5fc2t5Ym94Q3ViZU1hcC5maXhDdWJlbWFwU2VhbXMsIGdhbW1hOnBhc3MgPT09IHBjLlNIQURFUl9GT1JXQVJESERSID8gc2NlbmUuZ2FtbWFDb3JyZWN0aW9uID8gcGMuR0FNTUFfU1JHQkhEUiA6IHBjLkdBTU1BX05PTkUgOiBzY2VuZS5nYW1tYUNvcnJlY3Rpb24sIHRvbmVNYXBwaW5nOnBhc3MgPT09IHBjLlNIQURFUl9GT1JXQVJESERSID8gcGMuVE9ORU1BUF9MSU5FQVIgOlxuICAgICAgICBzY2VuZS50b25lTWFwcGluZ30pO1xuICAgICAgICB0aGlzLnNldFNoYWRlcihzaGFkZXIpO1xuICAgICAgfTtcbiAgICAgIG1hdGVyaWFsLnVwZGF0ZVNoYWRlcigpO1xuICAgICAgaWYgKCF0aGlzLl9za3lib3hDdWJlTWFwLmZpeEN1YmVtYXBTZWFtcyB8fCAhc2NlbmUuX3NreWJveE1pcCkge1xuICAgICAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX2N1YmVNYXBcIiwgdGhpcy5fc2t5Ym94Q3ViZU1hcCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgbWlwMnRleCA9IFtudWxsLCBcIjY0XCIsIFwiMTZcIiwgXCI4XCIsIFwiNFwiXTtcbiAgICAgICAgdmFyIG1pcFRleCA9IHRoaXNbXCJza3lib3hQcmVmaWx0ZXJlZFwiICsgbWlwMnRleFtzY2VuZS5fc2t5Ym94TWlwXV07XG4gICAgICAgIGlmIChtaXBUZXgpIHtcbiAgICAgICAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX2N1YmVNYXBcIiwgbWlwVGV4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbWF0ZXJpYWwuY3VsbCA9IHBjLkNVTExGQUNFX05PTkU7XG4gICAgICB2YXIgbm9kZSA9IG5ldyBwYy5HcmFwaE5vZGU7XG4gICAgICB2YXIgbWVzaCA9IHBjLmNyZWF0ZUJveChkZXZpY2UpO1xuICAgICAgdmFyIG1lc2hJbnN0YW5jZSA9IG5ldyBwYy5NZXNoSW5zdGFuY2Uobm9kZSwgbWVzaCwgbWF0ZXJpYWwpO1xuICAgICAgbWVzaEluc3RhbmNlLnVwZGF0ZUtleSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbWF0ZXJpYWwgPSB0aGlzLm1hdGVyaWFsO1xuICAgICAgICB0aGlzLmtleSA9IHBjLl9nZXREcmF3Y2FsbFNvcnRLZXkodGhpcy5sYXllciwgbWF0ZXJpYWwuYmxlbmRUeXBlLCBmYWxzZSwgMCk7XG4gICAgICB9O1xuICAgICAgbWVzaEluc3RhbmNlLnVwZGF0ZUtleSgpO1xuICAgICAgbWVzaEluc3RhbmNlLmN1bGwgPSBmYWxzZTtcbiAgICAgIG1lc2hJbnN0YW5jZS5kcmF3VG9EZXB0aCA9IGZhbHNlO1xuICAgICAgdmFyIG1vZGVsID0gbmV3IHBjLk1vZGVsO1xuICAgICAgbW9kZWwuZ3JhcGggPSBub2RlO1xuICAgICAgbW9kZWwubWVzaEluc3RhbmNlcyA9IFttZXNoSW5zdGFuY2VdO1xuICAgICAgdGhpcy5fc2t5Ym94TW9kZWwgPSBtb2RlbDtcbiAgICAgIHRoaXMuYWRkTW9kZWwobW9kZWwpO1xuICAgIH1cbiAgICB2YXIgbWF0ZXJpYWxzID0gW107XG4gICAgdmFyIGRyYXdDYWxscyA9IHRoaXMuZHJhd0NhbGxzO1xuICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxscy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgZHJhd0NhbGwgPSBkcmF3Q2FsbHNbaV07XG4gICAgICBpZiAoZHJhd0NhbGwubWF0ZXJpYWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAobWF0ZXJpYWxzLmluZGV4T2YoZHJhd0NhbGwubWF0ZXJpYWwpID09PSAtMSkge1xuICAgICAgICAgIG1hdGVyaWFscy5wdXNoKGRyYXdDYWxsLm1hdGVyaWFsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBtYXRlcmlhbHMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIG1hdCA9IG1hdGVyaWFsc1tpXTtcbiAgICAgIGlmIChtYXQudXBkYXRlU2hhZGVyICE9PSBwYy5NYXRlcmlhbC5wcm90b3R5cGUudXBkYXRlU2hhZGVyKSB7XG4gICAgICAgIG1hdC5jbGVhclZhcmlhbnRzKCk7XG4gICAgICAgIG1hdC5zaGFkZXIgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9zdGF0cy51cGRhdGVTaGFkZXJzVGltZSArPSBwYy5ub3coKSAtIHRpbWU7XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS5nZXRNb2RlbHMgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWxzO1xuICB9O1xuICBTY2VuZS5wcm90b3R5cGUuX3VwZGF0ZVN0YXRzID0gZnVuY3Rpb24oKSB7XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS5fdXBkYXRlTGlnaHRTdGF0cyA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBzdGF0cyA9IHRoaXMuX3N0YXRzO1xuICAgIHN0YXRzLmxpZ2h0cyA9IHRoaXMuX2xpZ2h0cy5sZW5ndGg7XG4gICAgc3RhdHMuZHluYW1pY0xpZ2h0cyA9IDA7XG4gICAgc3RhdHMuYmFrZWRMaWdodHMgPSAwO1xuICAgIHZhciBsO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBzdGF0cy5saWdodHM7aSsrKSB7XG4gICAgICBsID0gdGhpcy5fbGlnaHRzW2ldO1xuICAgICAgaWYgKGwuX2VuYWJsZWQpIHtcbiAgICAgICAgaWYgKGwuX21hc2sgJiBwYy5NQVNLX0RZTkFNSUMgfHwgbC5fbWFzayAmIHBjLk1BU0tfQkFLRUQpIHtcbiAgICAgICAgICBzdGF0cy5keW5hbWljTGlnaHRzKys7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGwuX21hc2sgJiBwYy5NQVNLX0xJR0hUTUFQKSB7XG4gICAgICAgICAgc3RhdHMuYmFrZWRMaWdodHMrKztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgU2NlbmUucHJvdG90eXBlLmFkZE1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHtcbiAgICB2YXIgaSwgbGVuO1xuICAgIHZhciB1cGRhdGVNb2RlbFNoYWRlcnMgPSBtb2RlbC5fc2hhZGVyc1ZlcnNpb24gIT09IHRoaXMuX3NjZW5lU2hhZGVyc1ZlcnNpb247XG4gICAgbW9kZWwuX3NoYWRlcnNWZXJzaW9uID0gdGhpcy5fc2NlbmVTaGFkZXJzVmVyc2lvbjtcbiAgICB2YXIgaW5kZXggPSB0aGlzLl9tb2RlbHMuaW5kZXhPZihtb2RlbCk7XG4gICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgdGhpcy5fbW9kZWxzLnB1c2gobW9kZWwpO1xuICAgICAgdmFyIG1hdGVyaWFscyA9IG1vZGVsLmdldE1hdGVyaWFscygpO1xuICAgICAgZm9yIChpID0gMDtpIDwgbWF0ZXJpYWxzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgbWF0ZXJpYWxzW2ldLnNjZW5lID0gdGhpcztcbiAgICAgIH1cbiAgICAgIHZhciBtZXNoSW5zdGFuY2U7XG4gICAgICB2YXIgbnVtTWVzaEluc3RhbmNlcyA9IG1vZGVsLm1lc2hJbnN0YW5jZXMubGVuZ3RoO1xuICAgICAgZm9yIChpID0gMDtpIDwgbnVtTWVzaEluc3RhbmNlcztpKyspIHtcbiAgICAgICAgbWVzaEluc3RhbmNlID0gbW9kZWwubWVzaEluc3RhbmNlc1tpXTtcbiAgICAgICAgaWYgKHVwZGF0ZU1vZGVsU2hhZGVycykge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbC5jbGVhclZhcmlhbnRzKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZHJhd0NhbGxzLmluZGV4T2YobWVzaEluc3RhbmNlKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aGlzLmRyYXdDYWxscy5wdXNoKG1lc2hJbnN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc2hJbnN0YW5jZS5jYXN0U2hhZG93KSB7XG4gICAgICAgICAgaWYgKHRoaXMuc2hhZG93Q2FzdGVycy5pbmRleE9mKG1lc2hJbnN0YW5jZSkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLnNoYWRvd0Nhc3RlcnMucHVzaChtZXNoSW5zdGFuY2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdmFyIGxpZ2h0cyA9IG1vZGVsLmdldExpZ2h0cygpO1xuICAgICAgZm9yIChpID0gMCwgbGVuID0gbGlnaHRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgICB0aGlzLmFkZExpZ2h0KGxpZ2h0c1tpXSk7XG4gICAgICB9XG4gICAgICB0aGlzLl91cGRhdGVTdGF0cygpO1xuICAgIH1cbiAgfTtcbiAgU2NlbmUucHJvdG90eXBlLmFkZFNoYWRvd0Nhc3RlciA9IGZ1bmN0aW9uKG1vZGVsKSB7XG4gICAgdmFyIG1lc2hJbnN0YW5jZTtcbiAgICB2YXIgbnVtTWVzaEluc3RhbmNlcyA9IG1vZGVsLm1lc2hJbnN0YW5jZXMubGVuZ3RoO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBudW1NZXNoSW5zdGFuY2VzO2krKykge1xuICAgICAgbWVzaEluc3RhbmNlID0gbW9kZWwubWVzaEluc3RhbmNlc1tpXTtcbiAgICAgIGlmIChtZXNoSW5zdGFuY2UuY2FzdFNoYWRvdykge1xuICAgICAgICBpZiAodGhpcy5zaGFkb3dDYXN0ZXJzLmluZGV4T2YobWVzaEluc3RhbmNlKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aGlzLnNoYWRvd0Nhc3RlcnMucHVzaChtZXNoSW5zdGFuY2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBTY2VuZS5wcm90b3R5cGUucmVtb3ZlTW9kZWwgPSBmdW5jdGlvbihtb2RlbCkge1xuICAgIHZhciBpLCBqLCBsZW4sIGRyYXdDYWxsLCBzcGxpY2VPZmZzZXQsIHNwbGljZUNvdW50O1xuICAgIHZhciBpbmRleCA9IHRoaXMuX21vZGVscy5pbmRleE9mKG1vZGVsKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICB0aGlzLl9tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIHZhciBtYXRlcmlhbHMgPSBtb2RlbC5nZXRNYXRlcmlhbHMoKTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IG1hdGVyaWFscy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIG1hdGVyaWFsc1tpXS5zY2VuZSA9IG51bGw7XG4gICAgICB9XG4gICAgICB2YXIgbWVzaEluc3RhbmNlO1xuICAgICAgdmFyIG51bU1lc2hJbnN0YW5jZXMgPSBtb2RlbC5tZXNoSW5zdGFuY2VzLmxlbmd0aDtcbiAgICAgIGZvciAoaSA9IDA7aSA8IG51bU1lc2hJbnN0YW5jZXM7aSsrKSB7XG4gICAgICAgIG1lc2hJbnN0YW5jZSA9IG1vZGVsLm1lc2hJbnN0YW5jZXNbaV07XG4gICAgICAgIHNwbGljZU9mZnNldCA9IC0xO1xuICAgICAgICBzcGxpY2VDb3VudCA9IDA7XG4gICAgICAgIGxlbiA9IHRoaXMuZHJhd0NhbGxzLmxlbmd0aDtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbGVuO2orKykge1xuICAgICAgICAgIGRyYXdDYWxsID0gdGhpcy5kcmF3Q2FsbHNbal07XG4gICAgICAgICAgaWYgKGRyYXdDYWxsID09PSBtZXNoSW5zdGFuY2UpIHtcbiAgICAgICAgICAgIHNwbGljZU9mZnNldCA9IGo7XG4gICAgICAgICAgICBzcGxpY2VDb3VudCA9IDE7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGRyYXdDYWxsLl9zdGF0aWNTb3VyY2UgPT09IG1lc2hJbnN0YW5jZSkge1xuICAgICAgICAgICAgaWYgKHNwbGljZU9mZnNldCA8IDApIHtcbiAgICAgICAgICAgICAgc3BsaWNlT2Zmc2V0ID0gajtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNwbGljZUNvdW50Kys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChzcGxpY2VPZmZzZXQgPj0gMCkge1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNwbGljZU9mZnNldCA+PSAwKSB7XG4gICAgICAgICAgdGhpcy5kcmF3Q2FsbHMuc3BsaWNlKHNwbGljZU9mZnNldCwgc3BsaWNlQ291bnQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNoSW5zdGFuY2UuY2FzdFNoYWRvdykge1xuICAgICAgICAgIGluZGV4ID0gdGhpcy5zaGFkb3dDYXN0ZXJzLmluZGV4T2YobWVzaEluc3RhbmNlKTtcbiAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLnNoYWRvd0Nhc3RlcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHZhciBsaWdodHMgPSBtb2RlbC5nZXRMaWdodHMoKTtcbiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGxpZ2h0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgdGhpcy5yZW1vdmVMaWdodChsaWdodHNbaV0pO1xuICAgICAgfVxuICAgICAgdGhpcy5fdXBkYXRlU3RhdHMoKTtcbiAgICB9XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS5yZW1vdmVTaGFkb3dDYXN0ZXIgPSBmdW5jdGlvbihtb2RlbCkge1xuICAgIHZhciBtZXNoSW5zdGFuY2UsIGluZGV4O1xuICAgIHZhciBudW1NZXNoSW5zdGFuY2VzID0gbW9kZWwubWVzaEluc3RhbmNlcy5sZW5ndGg7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG51bU1lc2hJbnN0YW5jZXM7aSsrKSB7XG4gICAgICBtZXNoSW5zdGFuY2UgPSBtb2RlbC5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgaWYgKG1lc2hJbnN0YW5jZS5jYXN0U2hhZG93KSB7XG4gICAgICAgIGluZGV4ID0gdGhpcy5zaGFkb3dDYXN0ZXJzLmluZGV4T2YobWVzaEluc3RhbmNlKTtcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgIHRoaXMuc2hhZG93Q2FzdGVycy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBTY2VuZS5wcm90b3R5cGUuY29udGFpbnNNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vZGVscy5pbmRleE9mKG1vZGVsKSA+PSAwO1xuICB9O1xuICBTY2VuZS5wcm90b3R5cGUuYWRkTGlnaHQgPSBmdW5jdGlvbihsaWdodCkge1xuICAgIHZhciBpbmRleCA9IHRoaXMuX2xpZ2h0cy5pbmRleE9mKGxpZ2h0KTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJwYy5TY2VuZSNhZGRMaWdodDogbGlnaHQgaXMgYWxyZWFkeSBpbiB0aGUgc2NlbmVcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2xpZ2h0cy5wdXNoKGxpZ2h0KTtcbiAgICAgIGxpZ2h0Ll9zY2VuZSA9IHRoaXM7XG4gICAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVMaWdodFN0YXRzKCk7XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS5yZW1vdmVMaWdodCA9IGZ1bmN0aW9uKGxpZ2h0KSB7XG4gICAgdmFyIGluZGV4ID0gdGhpcy5fbGlnaHRzLmluZGV4T2YobGlnaHQpO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIGNvbnNvbGUud2FybihcInBjLlNjZW5lI3JlbW92ZUxpZ2h0OiBsaWdodCBpcyBub3QgaW4gdGhlIHNjZW5lXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9saWdodHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIGxpZ2h0Ll9zY2VuZSA9IG51bGw7XG4gICAgICB0aGlzLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVMaWdodFN0YXRzKCk7XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS5fcmVzZXRTa3lib3hNb2RlbCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9za3lib3hNb2RlbCkge1xuICAgICAgaWYgKHRoaXMuY29udGFpbnNNb2RlbCh0aGlzLl9za3lib3hNb2RlbCkpIHtcbiAgICAgICAgdGhpcy5yZW1vdmVNb2RlbCh0aGlzLl9za3lib3hNb2RlbCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX3NreWJveE1vZGVsID0gbnVsbDtcbiAgfTtcbiAgU2NlbmUucHJvdG90eXBlLnNldFNreWJveCA9IGZ1bmN0aW9uKGN1YmVtYXBzKSB7XG4gICAgdmFyIGk7XG4gICAgaWYgKCFjdWJlbWFwcykge1xuICAgICAgY3ViZW1hcHMgPSBbbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbF07XG4gICAgfVxuICAgIHZhciBkaWZmZXJlbnQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5fc2t5Ym94Q3ViZU1hcCAhPT0gY3ViZW1hcHNbMF0pIHtcbiAgICAgIGRpZmZlcmVudCA9IHRydWU7XG4gICAgfVxuICAgIGlmICghZGlmZmVyZW50KSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCA2ICYmICFkaWZmZXJlbnQ7aSsrKSB7XG4gICAgICAgIGlmICh0aGlzLl9za3lib3hQcmVmaWx0ZXJlZFtpXSAhPT0gY3ViZW1hcHNbaSArIDFdKSB7XG4gICAgICAgICAgZGlmZmVyZW50ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWRpZmZlcmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCA2O2krKykge1xuICAgICAgdGhpcy5fc2t5Ym94UHJlZmlsdGVyZWRbaV0gPSBjdWJlbWFwc1tpICsgMV07XG4gICAgfVxuICAgIHRoaXMuc2t5Ym94ID0gY3ViZW1hcHNbMF07XG4gIH07XG4gIFNjZW5lLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fbW9kZWxzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdGhpcy5fbW9kZWxzW2ldLmdldEdyYXBoKCkuc3luY0hpZXJhcmNoeSgpO1xuICAgIH1cbiAgfTtcbiAgU2NlbmUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgbW9kZWxzID0gdGhpcy5nZXRNb2RlbHMoKTtcbiAgICBmb3IgKGkgPSAwO2kgPCBtb2RlbHMubGVuZ3RoO2krKykge1xuICAgICAgdGhpcy5yZW1vdmVNb2RlbChtb2RlbHNbaV0pO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl9saWdodHMubGVuZ3RoO2krKykge1xuICAgICAgdGhpcy5yZW1vdmVMaWdodCh0aGlzLl9saWdodHNbaV0pO1xuICAgIH1cbiAgICB0aGlzLnNreWJveCA9IG51bGw7XG4gIH07XG4gIHJldHVybiB7U2NlbmU6U2NlbmV9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBzY2FsZVNoaWZ0ID0gKG5ldyBwYy5NYXQ0KS5tdWwyKChuZXcgcGMuTWF0NCkuc2V0VHJhbnNsYXRlKDAuNSwgMC41LCAwLjUpLCAobmV3IHBjLk1hdDQpLnNldFNjYWxlKDAuNSwgMC41LCAwLjUpKTtcbiAgdmFyIHJnYmFEZXB0aENsZWFyT3B0aW9ucyA9IHtjb2xvcjpbMjU0LjAgLyAyNTUsIDI1NC4wIC8gMjU1LCAyNTQuMCAvIDI1NSwgMjU0LjAgLyAyNTVdLCBkZXB0aDoxLjAsIGZsYWdzOnBjLkNMRUFSRkxBR19DT0xPUiB8IHBjLkNMRUFSRkxBR19ERVBUSH07XG4gIHZhciBvcENoYW5JZCA9IHtyOjEsIGc6MiwgYjozLCBhOjR9O1xuICB2YXIgbnVtU2hhZG93TW9kZXMgPSA1O1xuICB2YXIgc2hhZG93TWFwQ2FjaGUgPSBbe30sIHt9LCB7fSwge30sIHt9XTtcbiAgdmFyIGRpcmVjdGlvbmFsU2hhZG93RXBzaWxvbiA9IDAuMDE7XG4gIHZhciBwaXhlbE9mZnNldCA9IG5ldyBwYy5WZWMyO1xuICB2YXIgYmx1clNjaXNzb3JSZWN0ID0ge3g6MSwgeToxLCB6OjAsIHc6MH07XG4gIHZhciBzaGFkb3dDYW1WaWV3ID0gbmV3IHBjLk1hdDQ7XG4gIHZhciBzaGFkb3dDYW1WaWV3UHJvaiA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgYzJzYyA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgdmlld0ludk1hdCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgdmlld01hdCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgdmlld01hdDMgPSBuZXcgcGMuTWF0MztcbiAgdmFyIHZpZXdQcm9qTWF0ID0gbmV3IHBjLk1hdDQ7XG4gIHZhciBwcm9qTWF0O1xuICB2YXIgdmlld0ludkwgPSBuZXcgcGMuTWF0NDtcbiAgdmFyIHZpZXdJbnZSID0gbmV3IHBjLk1hdDQ7XG4gIHZhciB2aWV3TCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgdmlld1IgPSBuZXcgcGMuTWF0NDtcbiAgdmFyIHZpZXdQb3NMID0gbmV3IHBjLlZlYzM7XG4gIHZhciB2aWV3UG9zUiA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcHJvakwsIHByb2pSO1xuICB2YXIgdmlld01hdDNMID0gbmV3IHBjLk1hdDQ7XG4gIHZhciB2aWV3TWF0M1IgPSBuZXcgcGMuTWF0NDtcbiAgdmFyIHZpZXdQcm9qTWF0TCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgdmlld1Byb2pNYXRSID0gbmV3IHBjLk1hdDQ7XG4gIHZhciBmcnVzdHVtRGlhZ29uYWwgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHRlbXBTcGhlcmUgPSB7Y2VudGVyOm51bGwsIHJhZGl1czowfTtcbiAgdmFyIG1lc2hQb3M7XG4gIHZhciB2aXNpYmxlU2NlbmVBYWJiID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICB2YXIgbGlnaHRCb3VuZHMgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gIHZhciBjdWxsZWQgPSBbXTtcbiAgdmFyIGZpbHRlcmVkID0gW107XG4gIHZhciBib25lVGV4dHVyZVNpemUgPSBbMCwgMF07XG4gIHZhciBib25lVGV4dHVyZSwgaW5zdGFuY2luZ0RhdGEsIG1vZGVsTWF0cml4LCBub3JtYWxNYXRyaXg7XG4gIHZhciBzaGFkb3dNYXBDdWJlQ2FjaGUgPSB7fTtcbiAgdmFyIG1heEJsdXJTaXplID0gMjU7XG4gIHZhciBrZXlBLCBrZXlCO1xuICB2YXIgZnJ1c3R1bVBvaW50cyA9IFtdO1xuICBmb3IgKHZhciBpID0gMDtpIDwgODtpKyspIHtcbiAgICBmcnVzdHVtUG9pbnRzLnB1c2gobmV3IHBjLlZlYzMpO1xuICB9XG4gIGZ1bmN0aW9uIF9nZXRGcnVzdHVtUG9pbnRzKGNhbWVyYSwgZmFyQ2xpcCwgcG9pbnRzKSB7XG4gICAgdmFyIG5lYXJDbGlwID0gY2FtZXJhLl9uZWFyQ2xpcDtcbiAgICB2YXIgZm92ID0gY2FtZXJhLl9mb3YgKiBNYXRoLlBJIC8gMTgwLjA7XG4gICAgdmFyIGFzcGVjdCA9IGNhbWVyYS5fYXNwZWN0O1xuICAgIHZhciBwcm9qZWN0aW9uID0gY2FtZXJhLl9wcm9qZWN0aW9uO1xuICAgIHZhciB4LCB5O1xuICAgIGlmIChwcm9qZWN0aW9uID09PSBwYy5QUk9KRUNUSU9OX1BFUlNQRUNUSVZFKSB7XG4gICAgICB5ID0gTWF0aC50YW4oZm92IC8gMi4wKSAqIG5lYXJDbGlwO1xuICAgIH0gZWxzZSB7XG4gICAgICB5ID0gY2FtZXJhLl9vcnRob0hlaWdodDtcbiAgICB9XG4gICAgeCA9IHkgKiBhc3BlY3Q7XG4gICAgcG9pbnRzWzBdLnggPSB4O1xuICAgIHBvaW50c1swXS55ID0gLXk7XG4gICAgcG9pbnRzWzBdLnogPSAtbmVhckNsaXA7XG4gICAgcG9pbnRzWzFdLnggPSB4O1xuICAgIHBvaW50c1sxXS55ID0geTtcbiAgICBwb2ludHNbMV0ueiA9IC1uZWFyQ2xpcDtcbiAgICBwb2ludHNbMl0ueCA9IC14O1xuICAgIHBvaW50c1syXS55ID0geTtcbiAgICBwb2ludHNbMl0ueiA9IC1uZWFyQ2xpcDtcbiAgICBwb2ludHNbM10ueCA9IC14O1xuICAgIHBvaW50c1szXS55ID0gLXk7XG4gICAgcG9pbnRzWzNdLnogPSAtbmVhckNsaXA7XG4gICAgaWYgKHByb2plY3Rpb24gPT09IHBjLlBST0pFQ1RJT05fUEVSU1BFQ1RJVkUpIHtcbiAgICAgIHkgPSBNYXRoLnRhbihmb3YgLyAyLjApICogZmFyQ2xpcDtcbiAgICAgIHggPSB5ICogYXNwZWN0O1xuICAgIH1cbiAgICBwb2ludHNbNF0ueCA9IHg7XG4gICAgcG9pbnRzWzRdLnkgPSAteTtcbiAgICBwb2ludHNbNF0ueiA9IC1mYXJDbGlwO1xuICAgIHBvaW50c1s1XS54ID0geDtcbiAgICBwb2ludHNbNV0ueSA9IHk7XG4gICAgcG9pbnRzWzVdLnogPSAtZmFyQ2xpcDtcbiAgICBwb2ludHNbNl0ueCA9IC14O1xuICAgIHBvaW50c1s2XS55ID0geTtcbiAgICBwb2ludHNbNl0ueiA9IC1mYXJDbGlwO1xuICAgIHBvaW50c1s3XS54ID0gLXg7XG4gICAgcG9pbnRzWzddLnkgPSAteTtcbiAgICBwb2ludHNbN10ueiA9IC1mYXJDbGlwO1xuICAgIHJldHVybiBwb2ludHM7XG4gIH1cbiAgZnVuY3Rpb24gU3RhdGljQXJyYXkoc2l6ZSkge1xuICAgIHZhciBkYXRhID0gbmV3IEFycmF5KHNpemUpO1xuICAgIHZhciBvYmogPSBmdW5jdGlvbihpZHgpIHtcbiAgICAgIHJldHVybiBkYXRhW2lkeF07XG4gICAgfTtcbiAgICBvYmouc2l6ZSA9IDA7XG4gICAgb2JqLnB1c2ggPSBmdW5jdGlvbih2KSB7XG4gICAgICBkYXRhW3RoaXMuc2l6ZV0gPSB2O1xuICAgICAgKyt0aGlzLnNpemU7XG4gICAgfTtcbiAgICBvYmouZGF0YSA9IGRhdGE7XG4gICAgcmV0dXJuIG9iajtcbiAgfVxuICB2YXIgaW50ZXJzZWN0Q2FjaGUgPSB7dGVtcDpbbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjM10sIHZlcnRpY2VzOm5ldyBBcnJheSgzKSwgbmVnYXRpdmU6bmV3IFN0YXRpY0FycmF5KDMpLCBwb3NpdGl2ZTpuZXcgU3RhdGljQXJyYXkoMyksIGludGVyc2VjdGlvbnM6bmV3IFN0YXRpY0FycmF5KDMpLCB6Q29sbGVjdGlvbjpuZXcgU3RhdGljQXJyYXkoMzYpfTtcbiAgZnVuY3Rpb24gX2dyb3VwVmVydGljZXMoY29vcmQsIGZhY2UsIHNtYWxsZXJJc05lZ2F0aXZlKSB7XG4gICAgdmFyIGludGVyc2VjdGlvbnMgPSBpbnRlcnNlY3RDYWNoZS5pbnRlcnNlY3Rpb25zO1xuICAgIHZhciBzbWFsbCwgbGFyZ2U7XG4gICAgaWYgKHNtYWxsZXJJc05lZ2F0aXZlKSB7XG4gICAgICBzbWFsbCA9IGludGVyc2VjdENhY2hlLm5lZ2F0aXZlO1xuICAgICAgbGFyZ2UgPSBpbnRlcnNlY3RDYWNoZS5wb3NpdGl2ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgc21hbGwgPSBpbnRlcnNlY3RDYWNoZS5wb3NpdGl2ZTtcbiAgICAgIGxhcmdlID0gaW50ZXJzZWN0Q2FjaGUubmVnYXRpdmU7XG4gICAgfVxuICAgIGludGVyc2VjdGlvbnMuc2l6ZSA9IDA7XG4gICAgc21hbGwuc2l6ZSA9IDA7XG4gICAgbGFyZ2Uuc2l6ZSA9IDA7XG4gICAgdmFyIGludGVyc2VjdENvdW50ID0gMDtcbiAgICB2YXIgdjtcbiAgICBmb3IgKHZhciBqID0gMDtqIDwgMzsrK2opIHtcbiAgICAgIHYgPSBpbnRlcnNlY3RDYWNoZS52ZXJ0aWNlc1tqXTtcbiAgICAgIGlmICh2W2Nvb3JkXSA8IGZhY2UpIHtcbiAgICAgICAgc21hbGwucHVzaCh2KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh2W2Nvb3JkXSA9PT0gZmFjZSkge1xuICAgICAgICAgIGludGVyc2VjdGlvbnMucHVzaChpbnRlcnNlY3RDYWNoZS50ZW1wW2ludGVyc2VjdGlvbnMuc2l6ZV0uY29weSh2KSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFyZ2UucHVzaCh2KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBmdW5jdGlvbiBfdHJpWEZhY2UoenMsIHgsIHksIGZhY2VUZXN0LCB5TWluLCB5TWF4KSB7XG4gICAgdmFyIG5lZ2F0aXZlID0gaW50ZXJzZWN0Q2FjaGUubmVnYXRpdmU7XG4gICAgdmFyIHBvc2l0aXZlID0gaW50ZXJzZWN0Q2FjaGUucG9zaXRpdmU7XG4gICAgdmFyIGludGVyc2VjdGlvbnMgPSBpbnRlcnNlY3RDYWNoZS5pbnRlcnNlY3Rpb25zO1xuICAgIGlmIChuZWdhdGl2ZS5zaXplID09PSAzKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChuZWdhdGl2ZS5zaXplICYmIHBvc2l0aXZlLnNpemUpIHtcbiAgICAgIGludGVyc2VjdGlvbnMucHVzaChpbnRlcnNlY3RDYWNoZS50ZW1wW2ludGVyc2VjdGlvbnMuc2l6ZV0ubGVycChuZWdhdGl2ZSgwKSwgcG9zaXRpdmUoMCksIChmYWNlVGVzdCAtIG5lZ2F0aXZlKDApW3hdKSAvIChwb3NpdGl2ZSgwKVt4XSAtIG5lZ2F0aXZlKDApW3hdKSkpO1xuICAgICAgaWYgKG5lZ2F0aXZlLnNpemUgPT09IDIpIHtcbiAgICAgICAgaW50ZXJzZWN0aW9ucy5wdXNoKGludGVyc2VjdENhY2hlLnRlbXBbaW50ZXJzZWN0aW9ucy5zaXplXS5sZXJwKG5lZ2F0aXZlKDEpLCBwb3NpdGl2ZSgwKSwgKGZhY2VUZXN0IC0gbmVnYXRpdmUoMSlbeF0pIC8gKHBvc2l0aXZlKDApW3hdIC0gbmVnYXRpdmUoMSlbeF0pKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAocG9zaXRpdmUuc2l6ZSA9PT0gMikge1xuICAgICAgICAgIGludGVyc2VjdGlvbnMucHVzaChpbnRlcnNlY3RDYWNoZS50ZW1wW2ludGVyc2VjdGlvbnMuc2l6ZV0ubGVycChuZWdhdGl2ZSgwKSwgcG9zaXRpdmUoMSksIChmYWNlVGVzdCAtIG5lZ2F0aXZlKDApW3hdKSAvIChwb3NpdGl2ZSgxKVt4XSAtIG5lZ2F0aXZlKDApW3hdKSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbnRlcnNlY3Rpb25zLnNpemUgPT09IDApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoaW50ZXJzZWN0aW9ucy5zaXplID09PSAxKSB7XG4gICAgICBpZiAoeU1pbiA8PSBpbnRlcnNlY3Rpb25zKDApW3ldICYmIGludGVyc2VjdGlvbnMoMClbeV0gPD0geU1heCkge1xuICAgICAgICB6cy5wdXNoKGludGVyc2VjdGlvbnMoMCkueik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGludGVyc2VjdGlvbnMoMSlbeV0gPT09IGludGVyc2VjdGlvbnMoMClbeV0pIHtcbiAgICAgIGlmICh5TWluIDw9IGludGVyc2VjdGlvbnMoMClbeV0gJiYgaW50ZXJzZWN0aW9ucygwKVt5XSA8PSB5TWF4KSB7XG4gICAgICAgIHpzLnB1c2goaW50ZXJzZWN0aW9ucygwKS56KTtcbiAgICAgICAgenMucHVzaChpbnRlcnNlY3Rpb25zKDEpLnopO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgZGVsdGEgPSAoaW50ZXJzZWN0aW9ucygxKS56IC0gaW50ZXJzZWN0aW9ucygwKS56KSAvIChpbnRlcnNlY3Rpb25zKDEpW3ldIC0gaW50ZXJzZWN0aW9ucygwKVt5XSk7XG4gICAgICBpZiAoaW50ZXJzZWN0aW9ucygwKVt5XSA+IHlNYXgpIHtcbiAgICAgICAgenMucHVzaChpbnRlcnNlY3Rpb25zKDApLnogKyBkZWx0YSAqICh5TWF4IC0gaW50ZXJzZWN0aW9ucygwKVt5XSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGludGVyc2VjdGlvbnMoMClbeV0gPCB5TWluKSB7XG4gICAgICAgICAgenMucHVzaChpbnRlcnNlY3Rpb25zKDApLnogKyBkZWx0YSAqICh5TWluIC0gaW50ZXJzZWN0aW9ucygwKVt5XSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHpzLnB1c2goaW50ZXJzZWN0aW9ucygwKS56KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGludGVyc2VjdGlvbnMoMSlbeV0gPiB5TWF4KSB7XG4gICAgICAgIHpzLnB1c2goaW50ZXJzZWN0aW9ucygxKS56ICsgZGVsdGEgKiAoeU1heCAtIGludGVyc2VjdGlvbnMoMSlbeV0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChpbnRlcnNlY3Rpb25zKDEpW3ldIDwgeU1pbikge1xuICAgICAgICAgIHpzLnB1c2goaW50ZXJzZWN0aW9ucygxKS56ICsgZGVsdGEgKiAoeU1pbiAtIGludGVyc2VjdGlvbnMoMSlbeV0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB6cy5wdXNoKGludGVyc2VjdGlvbnMoMSkueik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgdmFyIF9zY2VuZUFBQkJfTFMgPSBbbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzXTtcbiAgdmFyIGlBQUJCVHJpSW5kZXhlcyA9IFswLCAxLCAyLCAxLCAyLCAzLCA0LCA1LCA2LCA1LCA2LCA3LCAwLCAyLCA0LCAyLCA0LCA2LCAxLCAzLCA1LCAzLCA1LCA3LCAwLCAxLCA0LCAxLCA0LCA1LCAyLCAzLCA2LCAzLCA2LCA3XTtcbiAgZnVuY3Rpb24gX2dldFpGcm9tQUFCQih3MnNjLCBhYWJiTWluLCBhYWJiTWF4LCBsY2FtTWluWCwgbGNhbU1heFgsIGxjYW1NaW5ZLCBsY2FtTWF4WSkge1xuICAgIF9zY2VuZUFBQkJfTFNbMF0ueCA9IF9zY2VuZUFBQkJfTFNbMV0ueCA9IF9zY2VuZUFBQkJfTFNbMl0ueCA9IF9zY2VuZUFBQkJfTFNbM10ueCA9IGFhYmJNaW4ueDtcbiAgICBfc2NlbmVBQUJCX0xTWzFdLnkgPSBfc2NlbmVBQUJCX0xTWzNdLnkgPSBfc2NlbmVBQUJCX0xTWzddLnkgPSBfc2NlbmVBQUJCX0xTWzVdLnkgPSBhYWJiTWluLnk7XG4gICAgX3NjZW5lQUFCQl9MU1syXS56ID0gX3NjZW5lQUFCQl9MU1szXS56ID0gX3NjZW5lQUFCQl9MU1s2XS56ID0gX3NjZW5lQUFCQl9MU1s3XS56ID0gYWFiYk1pbi56O1xuICAgIF9zY2VuZUFBQkJfTFNbNF0ueCA9IF9zY2VuZUFBQkJfTFNbNV0ueCA9IF9zY2VuZUFBQkJfTFNbNl0ueCA9IF9zY2VuZUFBQkJfTFNbN10ueCA9IGFhYmJNYXgueDtcbiAgICBfc2NlbmVBQUJCX0xTWzBdLnkgPSBfc2NlbmVBQUJCX0xTWzJdLnkgPSBfc2NlbmVBQUJCX0xTWzRdLnkgPSBfc2NlbmVBQUJCX0xTWzZdLnkgPSBhYWJiTWF4Lnk7XG4gICAgX3NjZW5lQUFCQl9MU1swXS56ID0gX3NjZW5lQUFCQl9MU1sxXS56ID0gX3NjZW5lQUFCQl9MU1s0XS56ID0gX3NjZW5lQUFCQl9MU1s1XS56ID0gYWFiYk1heC56O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCA4OysraSkge1xuICAgICAgdzJzYy50cmFuc2Zvcm1Qb2ludChfc2NlbmVBQUJCX0xTW2ldLCBfc2NlbmVBQUJCX0xTW2ldKTtcbiAgICB9XG4gICAgdmFyIG1pbnogPSA5OTk5OTk5OTk5O1xuICAgIHZhciBtYXh6ID0gLTk5OTk5OTk5OTk7XG4gICAgdmFyIHZlcnRpY2VzID0gaW50ZXJzZWN0Q2FjaGUudmVydGljZXM7XG4gICAgdmFyIHBvc2l0aXZlID0gaW50ZXJzZWN0Q2FjaGUucG9zaXRpdmU7XG4gICAgdmFyIHpzID0gaW50ZXJzZWN0Q2FjaGUuekNvbGxlY3Rpb247XG4gICAgenMuc2l6ZSA9IDA7XG4gICAgZm9yICh2YXIgQUFCQlRyaUl0ZXIgPSAwO0FBQkJUcmlJdGVyIDwgMTI7KytBQUJCVHJpSXRlcikge1xuICAgICAgdmVydGljZXNbMF0gPSBfc2NlbmVBQUJCX0xTW2lBQUJCVHJpSW5kZXhlc1tBQUJCVHJpSXRlciAqIDMgKyAwXV07XG4gICAgICB2ZXJ0aWNlc1sxXSA9IF9zY2VuZUFBQkJfTFNbaUFBQkJUcmlJbmRleGVzW0FBQkJUcmlJdGVyICogMyArIDFdXTtcbiAgICAgIHZlcnRpY2VzWzJdID0gX3NjZW5lQUFCQl9MU1tpQUFCQlRyaUluZGV4ZXNbQUFCQlRyaUl0ZXIgKiAzICsgMl1dO1xuICAgICAgdmFyIHZlcnRpY2VzV2l0aGluQm91bmQgPSAwO1xuICAgICAgX2dyb3VwVmVydGljZXMoXCJ4XCIsIGxjYW1NaW5YLCB0cnVlKTtcbiAgICAgIGlmICghX3RyaVhGYWNlKHpzLCBcInhcIiwgXCJ5XCIsIGxjYW1NaW5YLCBsY2FtTWluWSwgbGNhbU1heFkpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdmVydGljZXNXaXRoaW5Cb3VuZCArPSBwb3NpdGl2ZS5zaXplO1xuICAgICAgX2dyb3VwVmVydGljZXMoXCJ4XCIsIGxjYW1NYXhYLCBmYWxzZSk7XG4gICAgICBpZiAoIV90cmlYRmFjZSh6cywgXCJ4XCIsIFwieVwiLCBsY2FtTWF4WCwgbGNhbU1pblksIGxjYW1NYXhZKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZlcnRpY2VzV2l0aGluQm91bmQgKz0gcG9zaXRpdmUuc2l6ZTtcbiAgICAgIF9ncm91cFZlcnRpY2VzKFwieVwiLCBsY2FtTWluWSwgdHJ1ZSk7XG4gICAgICBpZiAoIV90cmlYRmFjZSh6cywgXCJ5XCIsIFwieFwiLCBsY2FtTWluWSwgbGNhbU1pblgsIGxjYW1NYXhYKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZlcnRpY2VzV2l0aGluQm91bmQgKz0gcG9zaXRpdmUuc2l6ZTtcbiAgICAgIF9ncm91cFZlcnRpY2VzKFwieVwiLCBsY2FtTWF4WSwgZmFsc2UpO1xuICAgICAgX3RyaVhGYWNlKHpzLCBcInlcIiwgXCJ4XCIsIGxjYW1NYXhZLCBsY2FtTWluWCwgbGNhbU1heFgpO1xuICAgICAgaWYgKHZlcnRpY2VzV2l0aGluQm91bmQgKyBwb3NpdGl2ZS5zaXplID09IDEyKSB7XG4gICAgICAgIHpzLnB1c2godmVydGljZXNbMF0ueik7XG4gICAgICAgIHpzLnB1c2godmVydGljZXNbMV0ueik7XG4gICAgICAgIHpzLnB1c2godmVydGljZXNbMl0ueik7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciB6O1xuICAgIGZvciAodmFyIGogPSAwLCBsZW4gPSB6cy5zaXplO2ogPCBsZW47aisrKSB7XG4gICAgICB6ID0genMoaik7XG4gICAgICBpZiAoeiA8IG1pbnopIHtcbiAgICAgICAgbWlueiA9IHo7XG4gICAgICB9XG4gICAgICBpZiAoeiA+IG1heHopIHtcbiAgICAgICAgbWF4eiA9IHo7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7bWluOm1pbnosIG1heDptYXh6fTtcbiAgfVxuICBmdW5jdGlvbiBfZ2V0WkZyb21BQUJCU2ltcGxlKHcyc2MsIGFhYmJNaW4sIGFhYmJNYXgsIGxjYW1NaW5YLCBsY2FtTWF4WCwgbGNhbU1pblksIGxjYW1NYXhZKSB7XG4gICAgX3NjZW5lQUFCQl9MU1swXS54ID0gX3NjZW5lQUFCQl9MU1sxXS54ID0gX3NjZW5lQUFCQl9MU1syXS54ID0gX3NjZW5lQUFCQl9MU1szXS54ID0gYWFiYk1pbi54O1xuICAgIF9zY2VuZUFBQkJfTFNbMV0ueSA9IF9zY2VuZUFBQkJfTFNbM10ueSA9IF9zY2VuZUFBQkJfTFNbN10ueSA9IF9zY2VuZUFBQkJfTFNbNV0ueSA9IGFhYmJNaW4ueTtcbiAgICBfc2NlbmVBQUJCX0xTWzJdLnogPSBfc2NlbmVBQUJCX0xTWzNdLnogPSBfc2NlbmVBQUJCX0xTWzZdLnogPSBfc2NlbmVBQUJCX0xTWzddLnogPSBhYWJiTWluLno7XG4gICAgX3NjZW5lQUFCQl9MU1s0XS54ID0gX3NjZW5lQUFCQl9MU1s1XS54ID0gX3NjZW5lQUFCQl9MU1s2XS54ID0gX3NjZW5lQUFCQl9MU1s3XS54ID0gYWFiYk1heC54O1xuICAgIF9zY2VuZUFBQkJfTFNbMF0ueSA9IF9zY2VuZUFBQkJfTFNbMl0ueSA9IF9zY2VuZUFBQkJfTFNbNF0ueSA9IF9zY2VuZUFBQkJfTFNbNl0ueSA9IGFhYmJNYXgueTtcbiAgICBfc2NlbmVBQUJCX0xTWzBdLnogPSBfc2NlbmVBQUJCX0xTWzFdLnogPSBfc2NlbmVBQUJCX0xTWzRdLnogPSBfc2NlbmVBQUJCX0xTWzVdLnogPSBhYWJiTWF4Lno7XG4gICAgdmFyIG1pbnogPSA5OTk5OTk5OTk5O1xuICAgIHZhciBtYXh6ID0gLTk5OTk5OTk5OTk7XG4gICAgdmFyIHo7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDg7KytpKSB7XG4gICAgICB3MnNjLnRyYW5zZm9ybVBvaW50KF9zY2VuZUFBQkJfTFNbaV0sIF9zY2VuZUFBQkJfTFNbaV0pO1xuICAgICAgeiA9IF9zY2VuZUFBQkJfTFNbaV0uejtcbiAgICAgIGlmICh6IDwgbWlueikge1xuICAgICAgICBtaW56ID0gejtcbiAgICAgIH1cbiAgICAgIGlmICh6ID4gbWF4eikge1xuICAgICAgICBtYXh6ID0gejtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHttaW46bWlueiwgbWF4Om1heHp9O1xuICB9XG4gIGZ1bmN0aW9uIGdldFNoYWRvd0Zvcm1hdChkZXZpY2UsIHNoYWRvd1R5cGUpIHtcbiAgICBpZiAoc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1ZTTTMyKSB7XG4gICAgICByZXR1cm4gcGMuUElYRUxGT1JNQVRfUkdCQTMyRjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19WU00xNikge1xuICAgICAgICByZXR1cm4gcGMuUElYRUxGT1JNQVRfUkdCQTE2RjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChzaGFkb3dUeXBlID09PSBwYy5TSEFET1dfUENGNSkge1xuICAgICAgICAgIHJldHVybiBwYy5QSVhFTEZPUk1BVF9ERVBUSDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1BDRjMgJiYgZGV2aWNlLndlYmdsMikge1xuICAgICAgICAgICAgcmV0dXJuIHBjLlBJWEVMRk9STUFUX0RFUFRIO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTg7XG4gIH1cbiAgZnVuY3Rpb24gZ2V0U2hhZG93RmlsdGVyaW5nKGRldmljZSwgc2hhZG93VHlwZSkge1xuICAgIGlmIChzaGFkb3dUeXBlID09PSBwYy5TSEFET1dfUENGMyAmJiAhZGV2aWNlLndlYmdsMikge1xuICAgICAgcmV0dXJuIHBjLkZJTFRFUl9ORUFSRVNUO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1ZTTTMyKSB7XG4gICAgICAgIHJldHVybiBkZXZpY2UuZXh0VGV4dHVyZUZsb2F0TGluZWFyID8gcGMuRklMVEVSX0xJTkVBUiA6IHBjLkZJTFRFUl9ORUFSRVNUO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19WU00xNikge1xuICAgICAgICAgIHJldHVybiBkZXZpY2UuZXh0VGV4dHVyZUhhbGZGbG9hdExpbmVhciA/IHBjLkZJTFRFUl9MSU5FQVIgOiBwYy5GSUxURVJfTkVBUkVTVDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGMuRklMVEVSX0xJTkVBUjtcbiAgfVxuICBmdW5jdGlvbiBjcmVhdGVTaGFkb3dNYXAoZGV2aWNlLCB3aWR0aCwgaGVpZ2h0LCBzaGFkb3dUeXBlKSB7XG4gICAgdmFyIGZvcm1hdCA9IGdldFNoYWRvd0Zvcm1hdChkZXZpY2UsIHNoYWRvd1R5cGUpO1xuICAgIHZhciBmaWx0ZXIgPSBnZXRTaGFkb3dGaWx0ZXJpbmcoZGV2aWNlLCBzaGFkb3dUeXBlKTtcbiAgICB2YXIgc2hhZG93TWFwID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7Zm9ybWF0OmZvcm1hdCwgd2lkdGg6d2lkdGgsIGhlaWdodDpoZWlnaHQsIG1pcG1hcHM6ZmFsc2UsIG1pbkZpbHRlcjpmaWx0ZXIsIG1hZ0ZpbHRlcjpmaWx0ZXIsIGFkZHJlc3NVOnBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRSwgYWRkcmVzc1Y6cGMuQUREUkVTU19DTEFNUF9UT19FREdFfSk7XG4gICAgaWYgKHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19QQ0Y1IHx8IHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19QQ0YzICYmIGRldmljZS53ZWJnbDIpIHtcbiAgICAgIHNoYWRvd01hcC5jb21wYXJlT25SZWFkID0gdHJ1ZTtcbiAgICAgIHNoYWRvd01hcC5jb21wYXJlRnVuYyA9IHBjLkZVTkNfTEVTUztcbiAgICAgIHJldHVybiBuZXcgcGMuUmVuZGVyVGFyZ2V0KHtkZXB0aEJ1ZmZlcjpzaGFkb3dNYXB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBwYy5SZW5kZXJUYXJnZXQoe2NvbG9yQnVmZmVyOnNoYWRvd01hcCwgZGVwdGg6dHJ1ZX0pO1xuICB9XG4gIGZ1bmN0aW9uIGNyZWF0ZVNoYWRvd0N1YmVNYXAoZGV2aWNlLCBzaXplKSB7XG4gICAgdmFyIGN1YmVtYXAgPSBuZXcgcGMuVGV4dHVyZShkZXZpY2UsIHtmb3JtYXQ6cGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgsIHdpZHRoOnNpemUsIGhlaWdodDpzaXplLCBjdWJlbWFwOnRydWUsIG1pcG1hcHM6ZmFsc2UsIG1pbkZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVCwgbWFnRmlsdGVyOnBjLkZJTFRFUl9ORUFSRVNULCBhZGRyZXNzVTpwYy5BRERSRVNTX0NMQU1QX1RPX0VER0UsIGFkZHJlc3NWOnBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRX0pO1xuICAgIHZhciB0YXJnZXRzID0gW107XG4gICAgdmFyIHRhcmdldDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgNjtpKyspIHtcbiAgICAgIHRhcmdldCA9IG5ldyBwYy5SZW5kZXJUYXJnZXQoe2NvbG9yQnVmZmVyOmN1YmVtYXAsIGZhY2U6aSwgZGVwdGg6dHJ1ZX0pO1xuICAgICAgdGFyZ2V0cy5wdXNoKHRhcmdldCk7XG4gICAgfVxuICAgIHJldHVybiB0YXJnZXRzO1xuICB9XG4gIGZ1bmN0aW9uIGdhdXNzKHgsIHNpZ21hKSB7XG4gICAgcmV0dXJuIE1hdGguZXhwKC0oeCAqIHgpIC8gKDIuMCAqIHNpZ21hICogc2lnbWEpKTtcbiAgfVxuICBmdW5jdGlvbiBnYXVzc1dlaWdodHMoa2VybmVsU2l6ZSkge1xuICAgIGlmIChrZXJuZWxTaXplID4gbWF4Qmx1clNpemUpIHtcbiAgICAgIGtlcm5lbFNpemUgPSBtYXhCbHVyU2l6ZTtcbiAgICB9XG4gICAgdmFyIHNpZ21hID0gKGtlcm5lbFNpemUgLSAxKSAvICgyICogMyk7XG4gICAgdmFyIGksIHZhbHVlcywgc3VtLCBoYWxmV2lkdGg7XG4gICAgaGFsZldpZHRoID0gKGtlcm5lbFNpemUgLSAxKSAqIDAuNTtcbiAgICB2YWx1ZXMgPSBuZXcgQXJyYXkoa2VybmVsU2l6ZSk7XG4gICAgc3VtID0gMC4wO1xuICAgIGZvciAoaSA9IDA7aSA8IGtlcm5lbFNpemU7KytpKSB7XG4gICAgICB2YWx1ZXNbaV0gPSBnYXVzcyhpIC0gaGFsZldpZHRoLCBzaWdtYSk7XG4gICAgICBzdW0gKz0gdmFsdWVzW2ldO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBrZXJuZWxTaXplOysraSkge1xuICAgICAgdmFsdWVzW2ldIC89IHN1bTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlcztcbiAgfVxuICBmdW5jdGlvbiBjcmVhdGVTaGFkb3dDYW1lcmEoZGV2aWNlLCBzaGFkb3dUeXBlLCB0eXBlKSB7XG4gICAgdmFyIGZsYWdzID0gcGMuQ0xFQVJGTEFHX0RFUFRIO1xuICAgIHZhciBod1BjZiA9IHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19QQ0Y1IHx8IHNoYWRvd1R5cGUgPT09IHBjLlNIQURPV19QQ0YzICYmIGRldmljZS53ZWJnbDI7XG4gICAgaWYgKHR5cGUgPT09IHBjLkxJR0hUVFlQRV9QT0lOVCkge1xuICAgICAgaHdQY2YgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCFod1BjZikge1xuICAgICAgZmxhZ3MgfD0gcGMuQ0xFQVJGTEFHX0NPTE9SO1xuICAgIH1cbiAgICB2YXIgc2hhZG93Q2FtID0gbmV3IHBjLkNhbWVyYTtcbiAgICBpZiAoc2hhZG93VHlwZSA+PSBwYy5TSEFET1dfVlNNOCAmJiBzaGFkb3dUeXBlIDw9IHBjLlNIQURPV19WU00zMikge1xuICAgICAgc2hhZG93Q2FtLmNsZWFyQ29sb3JbMF0gPSAwO1xuICAgICAgc2hhZG93Q2FtLmNsZWFyQ29sb3JbMV0gPSAwO1xuICAgICAgc2hhZG93Q2FtLmNsZWFyQ29sb3JbMl0gPSAwO1xuICAgICAgc2hhZG93Q2FtLmNsZWFyQ29sb3JbM10gPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICBzaGFkb3dDYW0uY2xlYXJDb2xvclswXSA9IDE7XG4gICAgICBzaGFkb3dDYW0uY2xlYXJDb2xvclsxXSA9IDE7XG4gICAgICBzaGFkb3dDYW0uY2xlYXJDb2xvclsyXSA9IDE7XG4gICAgICBzaGFkb3dDYW0uY2xlYXJDb2xvclszXSA9IDE7XG4gICAgfVxuICAgIHNoYWRvd0NhbS5jbGVhckRlcHRoID0gMTtcbiAgICBzaGFkb3dDYW0uY2xlYXJGbGFncyA9IGZsYWdzO1xuICAgIHNoYWRvd0NhbS5jbGVhclN0ZW5jaWwgPSBudWxsO1xuICAgIHNoYWRvd0NhbS5fbm9kZSA9IG5ldyBwYy5HcmFwaE5vZGU7XG4gICAgcmV0dXJuIHNoYWRvd0NhbTtcbiAgfVxuICBmdW5jdGlvbiBnZXRTaGFkb3dNYXBGcm9tQ2FjaGUoZGV2aWNlLCByZXMsIG1vZGUsIGxheWVyKSB7XG4gICAgaWYgKCFsYXllcikge1xuICAgICAgbGF5ZXIgPSAwO1xuICAgIH1cbiAgICB2YXIgaWQgPSBsYXllciAqIDEwMDAwICsgcmVzO1xuICAgIHZhciBzaGFkb3dCdWZmZXIgPSBzaGFkb3dNYXBDYWNoZVttb2RlXVtpZF07XG4gICAgaWYgKCFzaGFkb3dCdWZmZXIpIHtcbiAgICAgIHNoYWRvd0J1ZmZlciA9IGNyZWF0ZVNoYWRvd01hcChkZXZpY2UsIHJlcywgcmVzLCBtb2RlID8gbW9kZSA6IHBjLlNIQURPV19QQ0YzKTtcbiAgICAgIHNoYWRvd01hcENhY2hlW21vZGVdW2lkXSA9IHNoYWRvd0J1ZmZlcjtcbiAgICB9XG4gICAgcmV0dXJuIHNoYWRvd0J1ZmZlcjtcbiAgfVxuICBmdW5jdGlvbiBjcmVhdGVTaGFkb3dCdWZmZXIoZGV2aWNlLCBsaWdodCkge1xuICAgIHZhciBzaGFkb3dCdWZmZXI7XG4gICAgaWYgKGxpZ2h0Ll90eXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgIGlmIChsaWdodC5fc2hhZG93VHlwZSA+IHBjLlNIQURPV19QQ0YzKSB7XG4gICAgICAgIGxpZ2h0Ll9zaGFkb3dUeXBlID0gcGMuU0hBRE9XX1BDRjM7XG4gICAgICB9XG4gICAgICBpZiAobGlnaHQuX2NhY2hlU2hhZG93TWFwKSB7XG4gICAgICAgIHNoYWRvd0J1ZmZlciA9IHNoYWRvd01hcEN1YmVDYWNoZVtsaWdodC5fc2hhZG93UmVzb2x1dGlvbl07XG4gICAgICAgIGlmICghc2hhZG93QnVmZmVyKSB7XG4gICAgICAgICAgc2hhZG93QnVmZmVyID0gY3JlYXRlU2hhZG93Q3ViZU1hcChkZXZpY2UsIGxpZ2h0Ll9zaGFkb3dSZXNvbHV0aW9uKTtcbiAgICAgICAgICBzaGFkb3dNYXBDdWJlQ2FjaGVbbGlnaHQuX3NoYWRvd1Jlc29sdXRpb25dID0gc2hhZG93QnVmZmVyO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzaGFkb3dCdWZmZXIgPSBjcmVhdGVTaGFkb3dDdWJlTWFwKGRldmljZSwgbGlnaHQuX3NoYWRvd1Jlc29sdXRpb24pO1xuICAgICAgfVxuICAgICAgbGlnaHQuX3NoYWRvd0NhbWVyYS5yZW5kZXJUYXJnZXQgPSBzaGFkb3dCdWZmZXJbMF07XG4gICAgICBsaWdodC5fc2hhZG93Q3ViZU1hcCA9IHNoYWRvd0J1ZmZlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGxpZ2h0Ll9jYWNoZVNoYWRvd01hcCkge1xuICAgICAgICBzaGFkb3dCdWZmZXIgPSBnZXRTaGFkb3dNYXBGcm9tQ2FjaGUoZGV2aWNlLCBsaWdodC5fc2hhZG93UmVzb2x1dGlvbiwgbGlnaHQuX3NoYWRvd1R5cGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2hhZG93QnVmZmVyID0gY3JlYXRlU2hhZG93TWFwKGRldmljZSwgbGlnaHQuX3NoYWRvd1Jlc29sdXRpb24sIGxpZ2h0Ll9zaGFkb3dSZXNvbHV0aW9uLCBsaWdodC5fc2hhZG93VHlwZSk7XG4gICAgICB9XG4gICAgICBsaWdodC5fc2hhZG93Q2FtZXJhLnJlbmRlclRhcmdldCA9IHNoYWRvd0J1ZmZlcjtcbiAgICB9XG4gICAgbGlnaHQuX2lzQ2FjaGVkU2hhZG93TWFwID0gbGlnaHQuX2NhY2hlU2hhZG93TWFwO1xuICB9XG4gIGZ1bmN0aW9uIGdldERlcHRoS2V5KG1lc2hJbnN0YW5jZSkge1xuICAgIHZhciBtYXRlcmlhbCA9IG1lc2hJbnN0YW5jZS5tYXRlcmlhbDtcbiAgICB2YXIgeCA9IG1lc2hJbnN0YW5jZS5za2luSW5zdGFuY2UgPyAxMCA6IDA7XG4gICAgdmFyIHkgPSAwO1xuICAgIGlmIChtYXRlcmlhbC5vcGFjaXR5TWFwKSB7XG4gICAgICB2YXIgb3BDaGFuID0gbWF0ZXJpYWwub3BhY2l0eU1hcENoYW5uZWw7XG4gICAgICBpZiAob3BDaGFuKSB7XG4gICAgICAgIHkgPSBvcENoYW5JZFtvcENoYW5dO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4geCArIHk7XG4gIH1cbiAgZnVuY3Rpb24gRm9yd2FyZFJlbmRlcmVyKGdyYXBoaWNzRGV2aWNlKSB7XG4gICAgdGhpcy5kZXZpY2UgPSBncmFwaGljc0RldmljZTtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5kZXZpY2U7XG4gICAgdGhpcy5fZGVwdGhEcmF3Q2FsbHMgPSAwO1xuICAgIHRoaXMuX3NoYWRvd0RyYXdDYWxscyA9IDA7XG4gICAgdGhpcy5fZm9yd2FyZERyYXdDYWxscyA9IDA7XG4gICAgdGhpcy5fc2tpbkRyYXdDYWxscyA9IDA7XG4gICAgdGhpcy5faW5zdGFuY2VkRHJhd0NhbGxzID0gMDtcbiAgICB0aGlzLl9pbW1lZGlhdGVSZW5kZXJlZCA9IDA7XG4gICAgdGhpcy5fcmVtb3ZlZEJ5SW5zdGFuY2luZyA9IDA7XG4gICAgdGhpcy5fY2FtZXJhc1JlbmRlcmVkID0gMDtcbiAgICB0aGlzLl9tYXRlcmlhbFN3aXRjaGVzID0gMDtcbiAgICB0aGlzLl9zaGFkb3dNYXBVcGRhdGVzID0gMDtcbiAgICB0aGlzLl9zaGFkb3dNYXBUaW1lID0gMDtcbiAgICB0aGlzLl9kZXB0aE1hcFRpbWUgPSAwO1xuICAgIHRoaXMuX2ZvcndhcmRUaW1lID0gMDtcbiAgICB0aGlzLl9jdWxsVGltZSA9IDA7XG4gICAgdGhpcy5fc29ydFRpbWUgPSAwO1xuICAgIHRoaXMuX3NraW5UaW1lID0gMDtcbiAgICB0aGlzLl9tb3JwaFRpbWUgPSAwO1xuICAgIHRoaXMuX2luc3RhbmNpbmdUaW1lID0gMDtcbiAgICB2YXIgbGlicmFyeSA9IGRldmljZS5nZXRQcm9ncmFtTGlicmFyeSgpO1xuICAgIHRoaXMubGlicmFyeSA9IGxpYnJhcnk7XG4gICAgdGhpcy5mcm9udFRvQmFjayA9IGZhbHNlO1xuICAgIHRoaXMuX2RlcHRoU2hhZGVyU3RhdGljID0gbGlicmFyeS5nZXRQcm9ncmFtKFwiZGVwdGhcIiwge3NraW46ZmFsc2V9KTtcbiAgICB0aGlzLl9kZXB0aFNoYWRlclNraW4gPSBsaWJyYXJ5LmdldFByb2dyYW0oXCJkZXB0aFwiLCB7c2tpbjp0cnVlfSk7XG4gICAgdGhpcy5fZGVwdGhTaGFkZXJTdGF0aWNPcCA9IHt9O1xuICAgIHRoaXMuX2RlcHRoU2hhZGVyU2tpbk9wID0ge307XG4gICAgdmFyIGNoYW4gPSBbXCJyXCIsIFwiZ1wiLCBcImJcIiwgXCJhXCJdO1xuICAgIGZvciAodmFyIGMgPSAwO2MgPCA0O2MrKykge1xuICAgICAgdGhpcy5fZGVwdGhTaGFkZXJTdGF0aWNPcFtjaGFuW2NdXSA9IGxpYnJhcnkuZ2V0UHJvZ3JhbShcImRlcHRoXCIsIHtza2luOmZhbHNlLCBvcGFjaXR5TWFwOnRydWUsIG9wYWNpdHlDaGFubmVsOmNoYW5bY119KTtcbiAgICAgIHRoaXMuX2RlcHRoU2hhZGVyU2tpbk9wW2NoYW5bY11dID0gbGlicmFyeS5nZXRQcm9ncmFtKFwiZGVwdGhcIiwge3NraW46dHJ1ZSwgb3BhY2l0eU1hcDp0cnVlLCBvcGFjaXR5Q2hhbm5lbDpjaGFuW2NdfSk7XG4gICAgICB0aGlzLl9kZXB0aFNoYWRlclN0YXRpY09wW2NoYW5bY11dID0gbGlicmFyeS5nZXRQcm9ncmFtKFwiZGVwdGhcIiwge3NraW46ZmFsc2UsIG9wYWNpdHlNYXA6dHJ1ZSwgb3BhY2l0eUNoYW5uZWw6Y2hhbltjXX0pO1xuICAgICAgdGhpcy5fZGVwdGhTaGFkZXJTa2luT3BbY2hhbltjXV0gPSBsaWJyYXJ5LmdldFByb2dyYW0oXCJkZXB0aFwiLCB7c2tpbjp0cnVlLCBvcGFjaXR5TWFwOnRydWUsIG9wYWNpdHlDaGFubmVsOmNoYW5bY119KTtcbiAgICB9XG4gICAgdmFyIHNjb3BlID0gZGV2aWNlLnNjb3BlO1xuICAgIHRoaXMucHJvaklkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF9wcm9qZWN0aW9uXCIpO1xuICAgIHRoaXMudmlld0lkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF92aWV3XCIpO1xuICAgIHRoaXMudmlld0lkMyA9IHNjb3BlLnJlc29sdmUoXCJtYXRyaXhfdmlldzNcIik7XG4gICAgdGhpcy52aWV3SW52SWQgPSBzY29wZS5yZXNvbHZlKFwibWF0cml4X3ZpZXdJbnZlcnNlXCIpO1xuICAgIHRoaXMudmlld1Byb2pJZCA9IHNjb3BlLnJlc29sdmUoXCJtYXRyaXhfdmlld1Byb2plY3Rpb25cIik7XG4gICAgdGhpcy52aWV3UG9zSWQgPSBzY29wZS5yZXNvbHZlKFwidmlld19wb3NpdGlvblwiKTtcbiAgICB0aGlzLm5lYXJDbGlwSWQgPSBzY29wZS5yZXNvbHZlKFwiY2FtZXJhX25lYXJcIik7XG4gICAgdGhpcy5mYXJDbGlwSWQgPSBzY29wZS5yZXNvbHZlKFwiY2FtZXJhX2ZhclwiKTtcbiAgICB0aGlzLnNoYWRvd01hcExpZ2h0UmFkaXVzSWQgPSBzY29wZS5yZXNvbHZlKFwibGlnaHRfcmFkaXVzXCIpO1xuICAgIHRoaXMuZm9nQ29sb3JJZCA9IHNjb3BlLnJlc29sdmUoXCJmb2dfY29sb3JcIik7XG4gICAgdGhpcy5mb2dTdGFydElkID0gc2NvcGUucmVzb2x2ZShcImZvZ19zdGFydFwiKTtcbiAgICB0aGlzLmZvZ0VuZElkID0gc2NvcGUucmVzb2x2ZShcImZvZ19lbmRcIik7XG4gICAgdGhpcy5mb2dEZW5zaXR5SWQgPSBzY29wZS5yZXNvbHZlKFwiZm9nX2RlbnNpdHlcIik7XG4gICAgdGhpcy5tb2RlbE1hdHJpeElkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF9tb2RlbFwiKTtcbiAgICB0aGlzLm5vcm1hbE1hdHJpeElkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF9ub3JtYWxcIik7XG4gICAgdGhpcy5wb3NlTWF0cml4SWQgPSBzY29wZS5yZXNvbHZlKFwibWF0cml4X3Bvc2VbMF1cIik7XG4gICAgdGhpcy5ib25lVGV4dHVyZUlkID0gc2NvcGUucmVzb2x2ZShcInRleHR1cmVfcG9zZU1hcFwiKTtcbiAgICB0aGlzLmJvbmVUZXh0dXJlU2l6ZUlkID0gc2NvcGUucmVzb2x2ZShcInRleHR1cmVfcG9zZU1hcFNpemVcIik7XG4gICAgdGhpcy5za2luUG9zT2Zmc2V0SWQgPSBzY29wZS5yZXNvbHZlKFwic2tpblBvc09mZnNldFwiKTtcbiAgICB0aGlzLmFscGhhVGVzdElkID0gc2NvcGUucmVzb2x2ZShcImFscGhhX3JlZlwiKTtcbiAgICB0aGlzLm9wYWNpdHlNYXBJZCA9IHNjb3BlLnJlc29sdmUoXCJ0ZXh0dXJlX29wYWNpdHlNYXBcIik7XG4gICAgdGhpcy5hbWJpZW50SWQgPSBzY29wZS5yZXNvbHZlKFwibGlnaHRfZ2xvYmFsQW1iaWVudFwiKTtcbiAgICB0aGlzLmV4cG9zdXJlSWQgPSBzY29wZS5yZXNvbHZlKFwiZXhwb3N1cmVcIik7XG4gICAgdGhpcy5za3lib3hJbnRlbnNpdHlJZCA9IHNjb3BlLnJlc29sdmUoXCJza3lib3hJbnRlbnNpdHlcIik7XG4gICAgdGhpcy5saWdodENvbG9ySWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0RGlySWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0U2hhZG93TWFwSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0U2hhZG93TWF0cml4SWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0U2hhZG93UGFyYW1zSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0U2hhZG93TWF0cml4VnNJZCA9IFtdO1xuICAgIHRoaXMubGlnaHRTaGFkb3dQYXJhbXNWc0lkID0gW107XG4gICAgdGhpcy5saWdodERpclZzSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0UmFkaXVzSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0UG9zSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0SW5BbmdsZUlkID0gW107XG4gICAgdGhpcy5saWdodE91dEFuZ2xlSWQgPSBbXTtcbiAgICB0aGlzLmxpZ2h0UG9zVnNJZCA9IFtdO1xuICAgIHRoaXMubGlnaHRDb29raWVJZCA9IFtdO1xuICAgIHRoaXMubGlnaHRDb29raWVJbnRJZCA9IFtdO1xuICAgIHRoaXMubGlnaHRDb29raWVNYXRyaXhJZCA9IFtdO1xuICAgIHRoaXMubGlnaHRDb29raWVPZmZzZXRJZCA9IFtdO1xuICAgIHRoaXMuZGVwdGhNYXBJZCA9IHNjb3BlLnJlc29sdmUoXCJ1RGVwdGhNYXBcIik7XG4gICAgdGhpcy5zY3JlZW5TaXplSWQgPSBzY29wZS5yZXNvbHZlKFwidVNjcmVlblNpemVcIik7XG4gICAgdGhpcy5fc2NyZWVuU2l6ZSA9IG5ldyBwYy5WZWM0O1xuICAgIHRoaXMuc291cmNlSWQgPSBzY29wZS5yZXNvbHZlKFwic291cmNlXCIpO1xuICAgIHRoaXMucGl4ZWxPZmZzZXRJZCA9IHNjb3BlLnJlc29sdmUoXCJwaXhlbE9mZnNldFwiKTtcbiAgICB0aGlzLndlaWdodElkID0gc2NvcGUucmVzb2x2ZShcIndlaWdodFswXVwiKTtcbiAgICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICAgIHRoaXMuYmx1clZzbVNoYWRlckNvZGUgPSBbY2h1bmtzLmJsdXJWU01QUywgXCIjZGVmaW5lIEdBVVNTXFxuXCIgKyBjaHVua3MuYmx1clZTTVBTXTtcbiAgICB2YXIgcGFja2VkID0gXCIjZGVmaW5lIFBBQ0tFRFxcblwiO1xuICAgIHRoaXMuYmx1clBhY2tlZFZzbVNoYWRlckNvZGUgPSBbcGFja2VkICsgdGhpcy5ibHVyVnNtU2hhZGVyQ29kZVswXSwgcGFja2VkICsgdGhpcy5ibHVyVnNtU2hhZGVyQ29kZVsxXV07XG4gICAgdGhpcy5ibHVyVnNtU2hhZGVyID0gW3t9LCB7fV07XG4gICAgdGhpcy5ibHVyUGFja2VkVnNtU2hhZGVyID0gW3t9LCB7fV07XG4gICAgdGhpcy5ibHVyVnNtV2VpZ2h0cyA9IHt9O1xuICAgIHRoaXMucG9seWdvbk9mZnNldElkID0gc2NvcGUucmVzb2x2ZShcInBvbHlnb25PZmZzZXRcIik7XG4gICAgdGhpcy5wb2x5Z29uT2Zmc2V0ID0gbmV3IEZsb2F0MzJBcnJheSgyKTtcbiAgICB0aGlzLmZvZ0NvbG9yID0gbmV3IEZsb2F0MzJBcnJheSgzKTtcbiAgICB0aGlzLmFtYmllbnRDb2xvciA9IG5ldyBGbG9hdDMyQXJyYXkoMyk7XG4gIH1cbiAgZnVuY3Rpb24gbWF0M0Zyb21NYXQ0KG0zLCBtNCkge1xuICAgIG0zLmRhdGFbMF0gPSBtNC5kYXRhWzBdO1xuICAgIG0zLmRhdGFbMV0gPSBtNC5kYXRhWzFdO1xuICAgIG0zLmRhdGFbMl0gPSBtNC5kYXRhWzJdO1xuICAgIG0zLmRhdGFbM10gPSBtNC5kYXRhWzRdO1xuICAgIG0zLmRhdGFbNF0gPSBtNC5kYXRhWzVdO1xuICAgIG0zLmRhdGFbNV0gPSBtNC5kYXRhWzZdO1xuICAgIG0zLmRhdGFbNl0gPSBtNC5kYXRhWzhdO1xuICAgIG0zLmRhdGFbN10gPSBtNC5kYXRhWzldO1xuICAgIG0zLmRhdGFbOF0gPSBtNC5kYXRhWzEwXTtcbiAgfVxuICBwYy5leHRlbmQoRm9yd2FyZFJlbmRlcmVyLnByb3RvdHlwZSwge3NvcnRDb21wYXJlOmZ1bmN0aW9uKGRyYXdDYWxsQSwgZHJhd0NhbGxCKSB7XG4gICAgaWYgKGRyYXdDYWxsQS5sYXllciA9PT0gZHJhd0NhbGxCLmxheWVyKSB7XG4gICAgICBpZiAoZHJhd0NhbGxBLmRyYXdPcmRlciAmJiBkcmF3Q2FsbEIuZHJhd09yZGVyKSB7XG4gICAgICAgIHJldHVybiBkcmF3Q2FsbEEuZHJhd09yZGVyIC0gZHJhd0NhbGxCLmRyYXdPcmRlcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChkcmF3Q2FsbEEuemRpc3QgJiYgZHJhd0NhbGxCLnpkaXN0KSB7XG4gICAgICAgICAgcmV0dXJuIGRyYXdDYWxsQi56ZGlzdCAtIGRyYXdDYWxsQS56ZGlzdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoZHJhd0NhbGxBLnpkaXN0MiAmJiBkcmF3Q2FsbEIuemRpc3QyKSB7XG4gICAgICAgICAgICByZXR1cm4gZHJhd0NhbGxBLnpkaXN0MiAtIGRyYXdDYWxsQi56ZGlzdDI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkcmF3Q2FsbEIuX2tleVtwYy5TT1JUS0VZX0ZPUldBUkRdIC0gZHJhd0NhbGxBLl9rZXlbcGMuU09SVEtFWV9GT1JXQVJEXTtcbiAgfSwgc29ydENvbXBhcmVNZXNoOmZ1bmN0aW9uKGRyYXdDYWxsQSwgZHJhd0NhbGxCKSB7XG4gICAgaWYgKGRyYXdDYWxsQS5sYXllciA9PT0gZHJhd0NhbGxCLmxheWVyKSB7XG4gICAgICBpZiAoZHJhd0NhbGxBLmRyYXdPcmRlciAmJiBkcmF3Q2FsbEIuZHJhd09yZGVyKSB7XG4gICAgICAgIHJldHVybiBkcmF3Q2FsbEEuZHJhd09yZGVyIC0gZHJhd0NhbGxCLmRyYXdPcmRlcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChkcmF3Q2FsbEEuemRpc3QgJiYgZHJhd0NhbGxCLnpkaXN0KSB7XG4gICAgICAgICAgcmV0dXJuIGRyYXdDYWxsQi56ZGlzdCAtIGRyYXdDYWxsQS56ZGlzdDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBrZXlBID0gZHJhd0NhbGxBLl9rZXlbcGMuU09SVEtFWV9GT1JXQVJEXTtcbiAgICBrZXlCID0gZHJhd0NhbGxCLl9rZXlbcGMuU09SVEtFWV9GT1JXQVJEXTtcbiAgICBpZiAoa2V5QSA9PT0ga2V5QiAmJiBkcmF3Q2FsbEEubWVzaCAmJiBkcmF3Q2FsbEIubWVzaCkge1xuICAgICAgcmV0dXJuIGRyYXdDYWxsQi5tZXNoLmlkIC0gZHJhd0NhbGxBLm1lc2guaWQ7XG4gICAgfVxuICAgIHJldHVybiBrZXlCIC0ga2V5QTtcbiAgfSwgZGVwdGhTb3J0Q29tcGFyZTpmdW5jdGlvbihkcmF3Q2FsbEEsIGRyYXdDYWxsQikge1xuICAgIGtleUEgPSBkcmF3Q2FsbEEuX2tleVtwYy5TT1JUS0VZX0RFUFRIXTtcbiAgICBrZXlCID0gZHJhd0NhbGxCLl9rZXlbcGMuU09SVEtFWV9ERVBUSF07XG4gICAgaWYgKGtleUEgPT09IGtleUIgJiYgZHJhd0NhbGxBLm1lc2ggJiYgZHJhd0NhbGxCLm1lc2gpIHtcbiAgICAgIHJldHVybiBkcmF3Q2FsbEIubWVzaC5pZCAtIGRyYXdDYWxsQS5tZXNoLmlkO1xuICAgIH1cbiAgICByZXR1cm4ga2V5QiAtIGtleUE7XG4gIH0sIGxpZ2h0Q29tcGFyZTpmdW5jdGlvbihsaWdodEEsIGxpZ2h0Qikge1xuICAgIHJldHVybiBsaWdodEEua2V5IC0gbGlnaHRCLmtleTtcbiAgfSwgX2lzVmlzaWJsZTpmdW5jdGlvbihjYW1lcmEsIG1lc2hJbnN0YW5jZSkge1xuICAgIGlmICghbWVzaEluc3RhbmNlLnZpc2libGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbWVzaFBvcyA9IG1lc2hJbnN0YW5jZS5hYWJiLmNlbnRlcjtcbiAgICBpZiAobWVzaEluc3RhbmNlLl9hYWJiLl9yYWRpdXNWZXIgIT09IG1lc2hJbnN0YW5jZS5fYWFiYlZlcikge1xuICAgICAgbWVzaEluc3RhbmNlLl9hYWJiLl9yYWRpdXMgPSBtZXNoSW5zdGFuY2UuX2FhYmIuaGFsZkV4dGVudHMubGVuZ3RoKCk7XG4gICAgICBtZXNoSW5zdGFuY2UuX2FhYmIuX3JhZGl1c1ZlciA9IG1lc2hJbnN0YW5jZS5fYWFiYlZlcjtcbiAgICB9XG4gICAgdGVtcFNwaGVyZS5yYWRpdXMgPSBtZXNoSW5zdGFuY2UuX2FhYmIuX3JhZGl1cztcbiAgICB0ZW1wU3BoZXJlLmNlbnRlciA9IG1lc2hQb3M7XG4gICAgcmV0dXJuIGNhbWVyYS5mcnVzdHVtLmNvbnRhaW5zU3BoZXJlKHRlbXBTcGhlcmUpO1xuICB9LCBnZXRTaGFkb3dDYW1lcmE6ZnVuY3Rpb24oZGV2aWNlLCBsaWdodCkge1xuICAgIHZhciBzaGFkb3dDYW0gPSBsaWdodC5fc2hhZG93Q2FtZXJhO1xuICAgIHZhciBzaGFkb3dCdWZmZXI7XG4gICAgaWYgKHNoYWRvd0NhbSA9PT0gbnVsbCkge1xuICAgICAgc2hhZG93Q2FtID0gbGlnaHQuX3NoYWRvd0NhbWVyYSA9IGNyZWF0ZVNoYWRvd0NhbWVyYShkZXZpY2UsIGxpZ2h0Ll9zaGFkb3dUeXBlLCBsaWdodC5fdHlwZSk7XG4gICAgICBjcmVhdGVTaGFkb3dCdWZmZXIoZGV2aWNlLCBsaWdodCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNoYWRvd0J1ZmZlciA9IHNoYWRvd0NhbS5yZW5kZXJUYXJnZXQ7XG4gICAgICBpZiAoc2hhZG93QnVmZmVyLndpZHRoICE9PSBsaWdodC5fc2hhZG93UmVzb2x1dGlvbiB8fCBzaGFkb3dCdWZmZXIuaGVpZ2h0ICE9PSBsaWdodC5fc2hhZG93UmVzb2x1dGlvbikge1xuICAgICAgICBjcmVhdGVTaGFkb3dCdWZmZXIoZGV2aWNlLCBsaWdodCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzaGFkb3dDYW07XG4gIH0sIHVwZGF0ZUNhbWVyYUZydXN0dW06ZnVuY3Rpb24oY2FtZXJhKSB7XG4gICAgaWYgKGNhbWVyYS52ckRpc3BsYXkgJiYgY2FtZXJhLnZyRGlzcGxheS5wcmVzZW50aW5nKSB7XG4gICAgICBwcm9qTWF0ID0gY2FtZXJhLnZyRGlzcGxheS5jb21iaW5lZFByb2o7XG4gICAgICB2YXIgcGFyZW50ID0gY2FtZXJhLl9ub2RlLmdldFBhcmVudCgpO1xuICAgICAgaWYgKHBhcmVudCkge1xuICAgICAgICB2aWV3TWF0LmNvcHkocGFyZW50LmdldFdvcmxkVHJhbnNmb3JtKCkpLm11bChjYW1lcmEudnJEaXNwbGF5LmNvbWJpbmVkVmlld0ludikuaW52ZXJ0KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2aWV3TWF0LmNvcHkoY2FtZXJhLnZyRGlzcGxheS5jb21iaW5lZFZpZXcpO1xuICAgICAgfVxuICAgICAgdmlld0ludk1hdC5jb3B5KHZpZXdNYXQpLmludmVydCgpO1xuICAgICAgdGhpcy52aWV3SW52SWQuc2V0VmFsdWUodmlld0ludk1hdC5kYXRhKTtcbiAgICAgIGNhbWVyYS5mcnVzdHVtLnVwZGF0ZShwcm9qTWF0LCB2aWV3TWF0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcHJvak1hdCA9IGNhbWVyYS5nZXRQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgaWYgKGNhbWVyYS5vdmVycmlkZUNhbGN1bGF0ZVByb2plY3Rpb24pIHtcbiAgICAgIGNhbWVyYS5jYWxjdWxhdGVQcm9qZWN0aW9uKHByb2pNYXQsIHBjLlZJRVdfQ0VOVEVSKTtcbiAgICB9XG4gICAgaWYgKGNhbWVyYS5vdmVycmlkZUNhbGN1bGF0ZVRyYW5zZm9ybSkge1xuICAgICAgY2FtZXJhLmNhbGN1bGF0ZVRyYW5zZm9ybSh2aWV3SW52TWF0LCBwYy5WSUVXX0NFTlRFUik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBwb3MgPSBjYW1lcmEuX25vZGUuZ2V0UG9zaXRpb24oKTtcbiAgICAgIHZhciByb3QgPSBjYW1lcmEuX25vZGUuZ2V0Um90YXRpb24oKTtcbiAgICAgIHZpZXdJbnZNYXQuc2V0VFJTKHBvcywgcm90LCBwYy5WZWMzLk9ORSk7XG4gICAgICB0aGlzLnZpZXdJbnZJZC5zZXRWYWx1ZSh2aWV3SW52TWF0LmRhdGEpO1xuICAgIH1cbiAgICB2aWV3TWF0LmNvcHkodmlld0ludk1hdCkuaW52ZXJ0KCk7XG4gICAgY2FtZXJhLmZydXN0dW0udXBkYXRlKHByb2pNYXQsIHZpZXdNYXQpO1xuICB9LCBzZXRDYW1lcmE6ZnVuY3Rpb24oY2FtZXJhLCBjdWxsQm9yZGVyKSB7XG4gICAgdmFyIHZyRGlzcGxheSA9IGNhbWVyYS52ckRpc3BsYXk7XG4gICAgaWYgKCF2ckRpc3BsYXkgfHwgIXZyRGlzcGxheS5wcmVzZW50aW5nKSB7XG4gICAgICBwcm9qTWF0ID0gY2FtZXJhLmdldFByb2plY3Rpb25NYXRyaXgoKTtcbiAgICAgIGlmIChjYW1lcmEub3ZlcnJpZGVDYWxjdWxhdGVQcm9qZWN0aW9uKSB7XG4gICAgICAgIGNhbWVyYS5jYWxjdWxhdGVQcm9qZWN0aW9uKHByb2pNYXQsIHBjLlZJRVdfQ0VOVEVSKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucHJvaklkLnNldFZhbHVlKHByb2pNYXQuZGF0YSk7XG4gICAgICBpZiAoY2FtZXJhLm92ZXJyaWRlQ2FsY3VsYXRlVHJhbnNmb3JtKSB7XG4gICAgICAgIGNhbWVyYS5jYWxjdWxhdGVUcmFuc2Zvcm0odmlld0ludk1hdCwgcGMuVklFV19DRU5URVIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHBvcyA9IGNhbWVyYS5fbm9kZS5nZXRQb3NpdGlvbigpO1xuICAgICAgICB2YXIgcm90ID0gY2FtZXJhLl9ub2RlLmdldFJvdGF0aW9uKCk7XG4gICAgICAgIHZpZXdJbnZNYXQuc2V0VFJTKHBvcywgcm90LCBwYy5WZWMzLk9ORSk7XG4gICAgICB9XG4gICAgICB0aGlzLnZpZXdJbnZJZC5zZXRWYWx1ZSh2aWV3SW52TWF0LmRhdGEpO1xuICAgICAgdmlld01hdC5jb3B5KHZpZXdJbnZNYXQpLmludmVydCgpO1xuICAgICAgdGhpcy52aWV3SWQuc2V0VmFsdWUodmlld01hdC5kYXRhKTtcbiAgICAgIG1hdDNGcm9tTWF0NCh2aWV3TWF0Mywgdmlld01hdCk7XG4gICAgICB0aGlzLnZpZXdJZDMuc2V0VmFsdWUodmlld01hdDMuZGF0YSk7XG4gICAgICB2aWV3UHJvak1hdC5tdWwyKHByb2pNYXQsIHZpZXdNYXQpO1xuICAgICAgdGhpcy52aWV3UHJvaklkLnNldFZhbHVlKHZpZXdQcm9qTWF0LmRhdGEpO1xuICAgICAgdGhpcy52aWV3UG9zSWQuc2V0VmFsdWUoY2FtZXJhLl9ub2RlLmdldFBvc2l0aW9uKCkuZGF0YSk7XG4gICAgICBjYW1lcmEuZnJ1c3R1bS51cGRhdGUocHJvak1hdCwgdmlld01hdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb2pMID0gdnJEaXNwbGF5LmxlZnRQcm9qO1xuICAgICAgcHJvalIgPSB2ckRpc3BsYXkucmlnaHRQcm9qO1xuICAgICAgcHJvak1hdCA9IHZyRGlzcGxheS5jb21iaW5lZFByb2o7XG4gICAgICBpZiAoY2FtZXJhLm92ZXJyaWRlQ2FsY3VsYXRlUHJvamVjdGlvbikge1xuICAgICAgICBjYW1lcmEuY2FsY3VsYXRlUHJvamVjdGlvbihwcm9qTCwgcGMuVklFV19MRUZUKTtcbiAgICAgICAgY2FtZXJhLmNhbGN1bGF0ZVByb2plY3Rpb24ocHJvalIsIHBjLlZJRVdfUklHSFQpO1xuICAgICAgICBjYW1lcmEuY2FsY3VsYXRlUHJvamVjdGlvbihwcm9qTWF0LCBwYy5WSUVXX0NFTlRFUik7XG4gICAgICB9XG4gICAgICBpZiAoY2FtZXJhLm92ZXJyaWRlQ2FsY3VsYXRlVHJhbnNmb3JtKSB7XG4gICAgICAgIGNhbWVyYS5jYWxjdWxhdGVUcmFuc2Zvcm0odmlld0ludkwsIHBjLlZJRVdfTEVGVCk7XG4gICAgICAgIGNhbWVyYS5jYWxjdWxhdGVUcmFuc2Zvcm0odmlld0ludlIsIHBjLlZJRVdfUklHSFQpO1xuICAgICAgICBjYW1lcmEuY2FsY3VsYXRlVHJhbnNmb3JtKHZpZXdJbnZNYXQsIHBjLlZJRVdfQ0VOVEVSKTtcbiAgICAgICAgdmlld0wuY29weSh2aWV3SW52TCkuaW52ZXJ0KCk7XG4gICAgICAgIHZpZXdSLmNvcHkodmlld0ludlIpLmludmVydCgpO1xuICAgICAgICB2aWV3TWF0LmNvcHkodmlld0ludk1hdCkuaW52ZXJ0KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcGFyZW50ID0gY2FtZXJhLl9ub2RlLmdldFBhcmVudCgpO1xuICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgdmFyIHRyYW5zZm9ybSA9IHBhcmVudC5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgICAgIHZpZXdJbnZMLm11bDIodHJhbnNmb3JtLCB2ckRpc3BsYXkubGVmdFZpZXdJbnYpO1xuICAgICAgICAgIHZpZXdJbnZSLm11bDIodHJhbnNmb3JtLCB2ckRpc3BsYXkucmlnaHRWaWV3SW52KTtcbiAgICAgICAgICB2aWV3TC5jb3B5KHZpZXdJbnZMKS5pbnZlcnQoKTtcbiAgICAgICAgICB2aWV3Ui5jb3B5KHZpZXdJbnZSKS5pbnZlcnQoKTtcbiAgICAgICAgICB2aWV3TWF0LmNvcHkocGFyZW50LmdldFdvcmxkVHJhbnNmb3JtKCkpLm11bCh2ckRpc3BsYXkuY29tYmluZWRWaWV3SW52KS5pbnZlcnQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB2aWV3SW52TC5jb3B5KHZyRGlzcGxheS5sZWZ0Vmlld0ludik7XG4gICAgICAgICAgdmlld0ludlIuY29weSh2ckRpc3BsYXkucmlnaHRWaWV3SW52KTtcbiAgICAgICAgICB2aWV3TC5jb3B5KHZyRGlzcGxheS5sZWZ0Vmlldyk7XG4gICAgICAgICAgdmlld1IuY29weSh2ckRpc3BsYXkucmlnaHRWaWV3KTtcbiAgICAgICAgICB2aWV3TWF0LmNvcHkodnJEaXNwbGF5LmNvbWJpbmVkVmlldyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG1hdDNGcm9tTWF0NCh2aWV3TWF0M0wsIHZpZXdMKTtcbiAgICAgIG1hdDNGcm9tTWF0NCh2aWV3TWF0M1IsIHZpZXdSKTtcbiAgICAgIHZpZXdQcm9qTWF0TC5tdWwyKHByb2pMLCB2aWV3TCk7XG4gICAgICB2aWV3UHJvak1hdFIubXVsMihwcm9qUiwgdmlld1IpO1xuICAgICAgdmlld1Bvc0wuZGF0YVswXSA9IHZpZXdJbnZMLmRhdGFbMTJdO1xuICAgICAgdmlld1Bvc0wuZGF0YVsxXSA9IHZpZXdJbnZMLmRhdGFbMTNdO1xuICAgICAgdmlld1Bvc0wuZGF0YVsyXSA9IHZpZXdJbnZMLmRhdGFbMTRdO1xuICAgICAgdmlld1Bvc1IuZGF0YVswXSA9IHZpZXdJbnZSLmRhdGFbMTJdO1xuICAgICAgdmlld1Bvc1IuZGF0YVsxXSA9IHZpZXdJbnZSLmRhdGFbMTNdO1xuICAgICAgdmlld1Bvc1IuZGF0YVsyXSA9IHZpZXdJbnZSLmRhdGFbMTRdO1xuICAgICAgY2FtZXJhLmZydXN0dW0udXBkYXRlKHByb2pNYXQsIHZpZXdNYXQpO1xuICAgIH1cbiAgICB0aGlzLm5lYXJDbGlwSWQuc2V0VmFsdWUoY2FtZXJhLl9uZWFyQ2xpcCk7XG4gICAgdGhpcy5mYXJDbGlwSWQuc2V0VmFsdWUoY2FtZXJhLl9mYXJDbGlwKTtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5kZXZpY2U7XG4gICAgdmFyIHRhcmdldCA9IGNhbWVyYS5yZW5kZXJUYXJnZXQ7XG4gICAgZGV2aWNlLnNldFJlbmRlclRhcmdldCh0YXJnZXQpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICAgIHZhciByZWN0ID0gY2FtZXJhLmdldFJlY3QoKTtcbiAgICB2YXIgcGl4ZWxXaWR0aCA9IHRhcmdldCA/IHRhcmdldC53aWR0aCA6IGRldmljZS53aWR0aDtcbiAgICB2YXIgcGl4ZWxIZWlnaHQgPSB0YXJnZXQgPyB0YXJnZXQuaGVpZ2h0IDogZGV2aWNlLmhlaWdodDtcbiAgICB2YXIgeCA9IE1hdGguZmxvb3IocmVjdC54ICogcGl4ZWxXaWR0aCk7XG4gICAgdmFyIHkgPSBNYXRoLmZsb29yKHJlY3QueSAqIHBpeGVsSGVpZ2h0KTtcbiAgICB2YXIgdyA9IE1hdGguZmxvb3IocmVjdC53aWR0aCAqIHBpeGVsV2lkdGgpO1xuICAgIHZhciBoID0gTWF0aC5mbG9vcihyZWN0LmhlaWdodCAqIHBpeGVsSGVpZ2h0KTtcbiAgICBkZXZpY2Uuc2V0Vmlld3BvcnQoeCwgeSwgdywgaCk7XG4gICAgZGV2aWNlLnNldFNjaXNzb3IoeCwgeSwgdywgaCk7XG4gICAgZGV2aWNlLmNsZWFyKGNhbWVyYS5fY2xlYXJPcHRpb25zKTtcbiAgICByZWN0ID0gY2FtZXJhLl9zY2lzc29yUmVjdDtcbiAgICB4ID0gTWF0aC5mbG9vcihyZWN0LnggKiBwaXhlbFdpZHRoKTtcbiAgICB5ID0gTWF0aC5mbG9vcihyZWN0LnkgKiBwaXhlbEhlaWdodCk7XG4gICAgdyA9IE1hdGguZmxvb3IocmVjdC53aWR0aCAqIHBpeGVsV2lkdGgpO1xuICAgIGggPSBNYXRoLmZsb29yKHJlY3QuaGVpZ2h0ICogcGl4ZWxIZWlnaHQpO1xuICAgIGRldmljZS5zZXRTY2lzc29yKHgsIHksIHcsIGgpO1xuICAgIGlmIChjdWxsQm9yZGVyKSB7XG4gICAgICBkZXZpY2Uuc2V0U2Npc3NvcigxLCAxLCBwaXhlbFdpZHRoIC0gMiwgcGl4ZWxIZWlnaHQgLSAyKTtcbiAgICB9XG4gIH0sIGRpc3BhdGNoR2xvYmFsTGlnaHRzOmZ1bmN0aW9uKHNjZW5lKSB7XG4gICAgdmFyIGk7XG4gICAgdGhpcy5tYWluTGlnaHQgPSAtMTtcbiAgICB2YXIgc2NvcGUgPSB0aGlzLmRldmljZS5zY29wZTtcbiAgICB0aGlzLmFtYmllbnRDb2xvclswXSA9IHNjZW5lLmFtYmllbnRMaWdodC5kYXRhWzBdO1xuICAgIHRoaXMuYW1iaWVudENvbG9yWzFdID0gc2NlbmUuYW1iaWVudExpZ2h0LmRhdGFbMV07XG4gICAgdGhpcy5hbWJpZW50Q29sb3JbMl0gPSBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVsyXTtcbiAgICBpZiAoc2NlbmUuZ2FtbWFDb3JyZWN0aW9uKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCAzO2krKykge1xuICAgICAgICB0aGlzLmFtYmllbnRDb2xvcltpXSA9IE1hdGgucG93KHRoaXMuYW1iaWVudENvbG9yW2ldLCAyLjIpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmFtYmllbnRJZC5zZXRWYWx1ZSh0aGlzLmFtYmllbnRDb2xvcik7XG4gICAgdGhpcy5leHBvc3VyZUlkLnNldFZhbHVlKHNjZW5lLmV4cG9zdXJlKTtcbiAgICBpZiAoc2NlbmUuX3NreWJveE1vZGVsKSB7XG4gICAgICB0aGlzLnNreWJveEludGVuc2l0eUlkLnNldFZhbHVlKHNjZW5lLnNreWJveEludGVuc2l0eSk7XG4gICAgfVxuICB9LCBfcmVzb2x2ZUxpZ2h0OmZ1bmN0aW9uKHNjb3BlLCBpKSB7XG4gICAgdmFyIGxpZ2h0ID0gXCJsaWdodFwiICsgaTtcbiAgICB0aGlzLmxpZ2h0Q29sb3JJZFtpXSA9IHNjb3BlLnJlc29sdmUobGlnaHQgKyBcIl9jb2xvclwiKTtcbiAgICB0aGlzLmxpZ2h0RGlySWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfZGlyZWN0aW9uXCIpO1xuICAgIHRoaXMubGlnaHRTaGFkb3dNYXBJZFtpXSA9IHNjb3BlLnJlc29sdmUobGlnaHQgKyBcIl9zaGFkb3dNYXBcIik7XG4gICAgdGhpcy5saWdodFNoYWRvd01hdHJpeElkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX3NoYWRvd01hdHJpeFwiKTtcbiAgICB0aGlzLmxpZ2h0U2hhZG93UGFyYW1zSWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfc2hhZG93UGFyYW1zXCIpO1xuICAgIHRoaXMubGlnaHRTaGFkb3dNYXRyaXhWc0lkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX3NoYWRvd01hdHJpeFZTXCIpO1xuICAgIHRoaXMubGlnaHRTaGFkb3dQYXJhbXNWc0lkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX3NoYWRvd1BhcmFtc1ZTXCIpO1xuICAgIHRoaXMubGlnaHREaXJWc0lkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX2RpcmVjdGlvblZTXCIpO1xuICAgIHRoaXMubGlnaHRSYWRpdXNJZFtpXSA9IHNjb3BlLnJlc29sdmUobGlnaHQgKyBcIl9yYWRpdXNcIik7XG4gICAgdGhpcy5saWdodFBvc0lkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX3Bvc2l0aW9uXCIpO1xuICAgIHRoaXMubGlnaHRJbkFuZ2xlSWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfaW5uZXJDb25lQW5nbGVcIik7XG4gICAgdGhpcy5saWdodE91dEFuZ2xlSWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfb3V0ZXJDb25lQW5nbGVcIik7XG4gICAgdGhpcy5saWdodFBvc1ZzSWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfcG9zaXRpb25WU1wiKTtcbiAgICB0aGlzLmxpZ2h0Q29va2llSWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfY29va2llXCIpO1xuICAgIHRoaXMubGlnaHRDb29raWVJbnRJZFtpXSA9IHNjb3BlLnJlc29sdmUobGlnaHQgKyBcIl9jb29raWVJbnRlbnNpdHlcIik7XG4gICAgdGhpcy5saWdodENvb2tpZU1hdHJpeElkW2ldID0gc2NvcGUucmVzb2x2ZShsaWdodCArIFwiX2Nvb2tpZU1hdHJpeFwiKTtcbiAgICB0aGlzLmxpZ2h0Q29va2llT2Zmc2V0SWRbaV0gPSBzY29wZS5yZXNvbHZlKGxpZ2h0ICsgXCJfY29va2llT2Zmc2V0XCIpO1xuICB9LCBkaXNwYXRjaERpcmVjdExpZ2h0czpmdW5jdGlvbihzY2VuZSwgbWFzaykge1xuICAgIHZhciBkaXJzID0gc2NlbmUuX2dsb2JhbExpZ2h0cztcbiAgICB2YXIgbnVtRGlycyA9IGRpcnMubGVuZ3RoO1xuICAgIHZhciBpO1xuICAgIHZhciBkaXJlY3Rpb25hbCwgd3RtO1xuICAgIHZhciBjbnQgPSAwO1xuICAgIHZhciBzY29wZSA9IHRoaXMuZGV2aWNlLnNjb3BlO1xuICAgIGZvciAoaSA9IDA7aSA8IG51bURpcnM7aSsrKSB7XG4gICAgICBpZiAoIShkaXJzW2ldLl9tYXNrICYgbWFzaykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBkaXJlY3Rpb25hbCA9IGRpcnNbaV07XG4gICAgICB3dG0gPSBkaXJlY3Rpb25hbC5fbm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgaWYgKCF0aGlzLmxpZ2h0Q29sb3JJZFtjbnRdKSB7XG4gICAgICAgIHRoaXMuX3Jlc29sdmVMaWdodChzY29wZSwgY250KTtcbiAgICAgIH1cbiAgICAgIHRoaXMubGlnaHRDb2xvcklkW2NudF0uc2V0VmFsdWUoc2NlbmUuZ2FtbWFDb3JyZWN0aW9uID8gZGlyZWN0aW9uYWwuX2xpbmVhckZpbmFsQ29sb3IuZGF0YSA6IGRpcmVjdGlvbmFsLl9maW5hbENvbG9yLmRhdGEpO1xuICAgICAgd3RtLmdldFkoZGlyZWN0aW9uYWwuX2RpcmVjdGlvbikuc2NhbGUoLTEpO1xuICAgICAgdGhpcy5saWdodERpcklkW2NudF0uc2V0VmFsdWUoZGlyZWN0aW9uYWwuX2RpcmVjdGlvbi5ub3JtYWxpemUoKS5kYXRhKTtcbiAgICAgIGlmIChkaXJlY3Rpb25hbC5jYXN0U2hhZG93cykge1xuICAgICAgICB2YXIgc2hhZG93TWFwID0gZGlyZWN0aW9uYWwuX2lzUGNmICYmIHRoaXMuZGV2aWNlLndlYmdsMiA/IGRpcmVjdGlvbmFsLl9zaGFkb3dDYW1lcmEucmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyIDogZGlyZWN0aW9uYWwuX3NoYWRvd0NhbWVyYS5yZW5kZXJUYXJnZXQuY29sb3JCdWZmZXI7XG4gICAgICAgIHZhciBiaWFzO1xuICAgICAgICBpZiAoZGlyZWN0aW9uYWwuX2lzVnNtKSB7XG4gICAgICAgICAgYmlhcyA9IC0wLjAwMDAxICogMjA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYmlhcyA9IGRpcmVjdGlvbmFsLnNoYWRvd0JpYXMgLyBkaXJlY3Rpb25hbC5fc2hhZG93Q2FtZXJhLl9mYXJDbGlwICogMTAwO1xuICAgICAgICAgIGlmICghdGhpcy5kZXZpY2Uud2ViZ2wyICYmIHRoaXMuZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMpIHtcbiAgICAgICAgICAgIGJpYXMgKj0gLTEwMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG5vcm1hbEJpYXMgPSBkaXJlY3Rpb25hbC5faXNWc20gPyBkaXJlY3Rpb25hbC52c21CaWFzIC8gKGRpcmVjdGlvbmFsLl9zaGFkb3dDYW1lcmEuX2ZhckNsaXAgLyA3LjApIDogZGlyZWN0aW9uYWwuX25vcm1hbE9mZnNldEJpYXM7XG4gICAgICAgIHRoaXMubGlnaHRTaGFkb3dNYXBJZFtjbnRdLnNldFZhbHVlKHNoYWRvd01hcCk7XG4gICAgICAgIHRoaXMubGlnaHRTaGFkb3dNYXRyaXhJZFtjbnRdLnNldFZhbHVlKGRpcmVjdGlvbmFsLl9zaGFkb3dNYXRyaXguZGF0YSk7XG4gICAgICAgIHZhciBwYXJhbXMgPSBkaXJlY3Rpb25hbC5fcmVuZGVyZXJQYXJhbXM7XG4gICAgICAgIGlmIChwYXJhbXMubGVuZ3RoICE9PSAzKSB7XG4gICAgICAgICAgcGFyYW1zLmxlbmd0aCA9IDM7XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1zWzBdID0gZGlyZWN0aW9uYWwuX3NoYWRvd1Jlc29sdXRpb247XG4gICAgICAgIHBhcmFtc1sxXSA9IG5vcm1hbEJpYXM7XG4gICAgICAgIHBhcmFtc1syXSA9IGJpYXM7XG4gICAgICAgIHRoaXMubGlnaHRTaGFkb3dQYXJhbXNJZFtjbnRdLnNldFZhbHVlKHBhcmFtcyk7XG4gICAgICAgIGlmICh0aGlzLm1haW5MaWdodCA8IDApIHtcbiAgICAgICAgICB0aGlzLmxpZ2h0U2hhZG93TWF0cml4VnNJZFtjbnRdLnNldFZhbHVlKGRpcmVjdGlvbmFsLl9zaGFkb3dNYXRyaXguZGF0YSk7XG4gICAgICAgICAgdGhpcy5saWdodFNoYWRvd1BhcmFtc1ZzSWRbY250XS5zZXRWYWx1ZShwYXJhbXMpO1xuICAgICAgICAgIHRoaXMubGlnaHREaXJWc0lkW2NudF0uc2V0VmFsdWUoZGlyZWN0aW9uYWwuX2RpcmVjdGlvbi5ub3JtYWxpemUoKS5kYXRhKTtcbiAgICAgICAgICB0aGlzLm1haW5MaWdodCA9IGk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNudCsrO1xuICAgIH1cbiAgICByZXR1cm4gY250O1xuICB9LCBkaXNwYXRjaFBvaW50TGlnaHQ6ZnVuY3Rpb24oc2NlbmUsIHNjb3BlLCBwb2ludCwgY250KSB7XG4gICAgdmFyIHd0bSA9IHBvaW50Ll9ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgaWYgKCF0aGlzLmxpZ2h0Q29sb3JJZFtjbnRdKSB7XG4gICAgICB0aGlzLl9yZXNvbHZlTGlnaHQoc2NvcGUsIGNudCk7XG4gICAgfVxuICAgIHRoaXMubGlnaHRSYWRpdXNJZFtjbnRdLnNldFZhbHVlKHBvaW50LmF0dGVudWF0aW9uRW5kKTtcbiAgICB0aGlzLmxpZ2h0Q29sb3JJZFtjbnRdLnNldFZhbHVlKHNjZW5lLmdhbW1hQ29ycmVjdGlvbiA/IHBvaW50Ll9saW5lYXJGaW5hbENvbG9yLmRhdGEgOiBwb2ludC5fZmluYWxDb2xvci5kYXRhKTtcbiAgICB3dG0uZ2V0VHJhbnNsYXRpb24ocG9pbnQuX3Bvc2l0aW9uKTtcbiAgICB0aGlzLmxpZ2h0UG9zSWRbY250XS5zZXRWYWx1ZShwb2ludC5fcG9zaXRpb24uZGF0YSk7XG4gICAgaWYgKHBvaW50LmNhc3RTaGFkb3dzKSB7XG4gICAgICB2YXIgc2hhZG93TWFwID0gcG9pbnQuX3NoYWRvd0NhbWVyYS5yZW5kZXJUYXJnZXQuY29sb3JCdWZmZXI7XG4gICAgICB0aGlzLmxpZ2h0U2hhZG93TWFwSWRbY250XS5zZXRWYWx1ZShzaGFkb3dNYXApO1xuICAgICAgdmFyIHBhcmFtcyA9IHBvaW50Ll9yZW5kZXJlclBhcmFtcztcbiAgICAgIGlmIChwYXJhbXMubGVuZ3RoICE9PSA0KSB7XG4gICAgICAgIHBhcmFtcy5sZW5ndGggPSA0O1xuICAgICAgfVxuICAgICAgcGFyYW1zWzBdID0gcG9pbnQuX3NoYWRvd1Jlc29sdXRpb247XG4gICAgICBwYXJhbXNbMV0gPSBwb2ludC5fbm9ybWFsT2Zmc2V0QmlhcztcbiAgICAgIHBhcmFtc1syXSA9IHBvaW50LnNoYWRvd0JpYXM7XG4gICAgICBwYXJhbXNbM10gPSAxLjAgLyBwb2ludC5hdHRlbnVhdGlvbkVuZDtcbiAgICAgIHRoaXMubGlnaHRTaGFkb3dQYXJhbXNJZFtjbnRdLnNldFZhbHVlKHBhcmFtcyk7XG4gICAgfVxuICAgIGlmIChwb2ludC5fY29va2llKSB7XG4gICAgICB0aGlzLmxpZ2h0Q29va2llSWRbY250XS5zZXRWYWx1ZShwb2ludC5fY29va2llKTtcbiAgICAgIHRoaXMubGlnaHRTaGFkb3dNYXRyaXhJZFtjbnRdLnNldFZhbHVlKHd0bS5kYXRhKTtcbiAgICAgIHRoaXMubGlnaHRDb29raWVJbnRJZFtjbnRdLnNldFZhbHVlKHBvaW50LmNvb2tpZUludGVuc2l0eSk7XG4gICAgfVxuICB9LCBkaXNwYXRjaFNwb3RMaWdodDpmdW5jdGlvbihzY2VuZSwgc2NvcGUsIHNwb3QsIGNudCkge1xuICAgIHZhciB3dG0gPSBzcG90Ll9ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgaWYgKCF0aGlzLmxpZ2h0Q29sb3JJZFtjbnRdKSB7XG4gICAgICB0aGlzLl9yZXNvbHZlTGlnaHQoc2NvcGUsIGNudCk7XG4gICAgfVxuICAgIHRoaXMubGlnaHRJbkFuZ2xlSWRbY250XS5zZXRWYWx1ZShzcG90Ll9pbm5lckNvbmVBbmdsZUNvcyk7XG4gICAgdGhpcy5saWdodE91dEFuZ2xlSWRbY250XS5zZXRWYWx1ZShzcG90Ll9vdXRlckNvbmVBbmdsZUNvcyk7XG4gICAgdGhpcy5saWdodFJhZGl1c0lkW2NudF0uc2V0VmFsdWUoc3BvdC5hdHRlbnVhdGlvbkVuZCk7XG4gICAgdGhpcy5saWdodENvbG9ySWRbY250XS5zZXRWYWx1ZShzY2VuZS5nYW1tYUNvcnJlY3Rpb24gPyBzcG90Ll9saW5lYXJGaW5hbENvbG9yLmRhdGEgOiBzcG90Ll9maW5hbENvbG9yLmRhdGEpO1xuICAgIHd0bS5nZXRUcmFuc2xhdGlvbihzcG90Ll9wb3NpdGlvbik7XG4gICAgdGhpcy5saWdodFBvc0lkW2NudF0uc2V0VmFsdWUoc3BvdC5fcG9zaXRpb24uZGF0YSk7XG4gICAgd3RtLmdldFkoc3BvdC5fZGlyZWN0aW9uKS5zY2FsZSgtMSk7XG4gICAgdGhpcy5saWdodERpcklkW2NudF0uc2V0VmFsdWUoc3BvdC5fZGlyZWN0aW9uLm5vcm1hbGl6ZSgpLmRhdGEpO1xuICAgIGlmIChzcG90LmNhc3RTaGFkb3dzKSB7XG4gICAgICB2YXIgYmlhcztcbiAgICAgIGlmIChzcG90Ll9pc1ZzbSkge1xuICAgICAgICBiaWFzID0gLTAuMDAwMDEgKiAyMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJpYXMgPSBzcG90LnNoYWRvd0JpYXMgKiAyMDtcbiAgICAgICAgaWYgKCF0aGlzLmRldmljZS53ZWJnbDIgJiYgdGhpcy5kZXZpY2UuZXh0U3RhbmRhcmREZXJpdmF0aXZlcykge1xuICAgICAgICAgIGJpYXMgKj0gLTEwMDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdmFyIG5vcm1hbEJpYXMgPSBzcG90Ll9pc1ZzbSA/IHNwb3QudnNtQmlhcyAvIChzcG90LmF0dGVudWF0aW9uRW5kIC8gNy4wKSA6IHNwb3QuX25vcm1hbE9mZnNldEJpYXM7XG4gICAgICB2YXIgc2hhZG93TWFwID0gc3BvdC5faXNQY2YgJiYgdGhpcy5kZXZpY2Uud2ViZ2wyID8gc3BvdC5fc2hhZG93Q2FtZXJhLnJlbmRlclRhcmdldC5kZXB0aEJ1ZmZlciA6IHNwb3QuX3NoYWRvd0NhbWVyYS5yZW5kZXJUYXJnZXQuY29sb3JCdWZmZXI7XG4gICAgICB0aGlzLmxpZ2h0U2hhZG93TWFwSWRbY250XS5zZXRWYWx1ZShzaGFkb3dNYXApO1xuICAgICAgdGhpcy5saWdodFNoYWRvd01hdHJpeElkW2NudF0uc2V0VmFsdWUoc3BvdC5fc2hhZG93TWF0cml4LmRhdGEpO1xuICAgICAgdmFyIHBhcmFtcyA9IHNwb3QuX3JlbmRlcmVyUGFyYW1zO1xuICAgICAgaWYgKHBhcmFtcy5sZW5ndGggIT09IDQpIHtcbiAgICAgICAgcGFyYW1zLmxlbmd0aCA9IDQ7XG4gICAgICB9XG4gICAgICBwYXJhbXNbMF0gPSBzcG90Ll9zaGFkb3dSZXNvbHV0aW9uO1xuICAgICAgcGFyYW1zWzFdID0gbm9ybWFsQmlhcztcbiAgICAgIHBhcmFtc1syXSA9IGJpYXM7XG4gICAgICBwYXJhbXNbM10gPSAxLjAgLyBzcG90LmF0dGVudWF0aW9uRW5kO1xuICAgICAgdGhpcy5saWdodFNoYWRvd1BhcmFtc0lkW2NudF0uc2V0VmFsdWUocGFyYW1zKTtcbiAgICAgIGlmICh0aGlzLm1haW5MaWdodCA8IDApIHtcbiAgICAgICAgdGhpcy5saWdodFNoYWRvd01hdHJpeFZzSWRbY250XS5zZXRWYWx1ZShzcG90Ll9zaGFkb3dNYXRyaXguZGF0YSk7XG4gICAgICAgIHRoaXMubGlnaHRTaGFkb3dQYXJhbXNWc0lkW2NudF0uc2V0VmFsdWUocGFyYW1zKTtcbiAgICAgICAgdGhpcy5saWdodFBvc1ZzSWRbY250XS5zZXRWYWx1ZShzcG90Ll9wb3NpdGlvbi5kYXRhKTtcbiAgICAgICAgdGhpcy5tYWluTGlnaHQgPSBpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3BvdC5fY29va2llKSB7XG4gICAgICB0aGlzLmxpZ2h0Q29va2llSWRbY250XS5zZXRWYWx1ZShzcG90Ll9jb29raWUpO1xuICAgICAgaWYgKCFzcG90LmNhc3RTaGFkb3dzKSB7XG4gICAgICAgIHZhciBzaGFkb3dDYW0gPSB0aGlzLmdldFNoYWRvd0NhbWVyYSh0aGlzLmRldmljZSwgc3BvdCk7XG4gICAgICAgIHZhciBzaGFkb3dDYW1Ob2RlID0gc2hhZG93Q2FtLl9ub2RlO1xuICAgICAgICBzaGFkb3dDYW1Ob2RlLnNldFBvc2l0aW9uKHNwb3QuX25vZGUuZ2V0UG9zaXRpb24oKSk7XG4gICAgICAgIHNoYWRvd0NhbU5vZGUuc2V0Um90YXRpb24oc3BvdC5fbm9kZS5nZXRSb3RhdGlvbigpKTtcbiAgICAgICAgc2hhZG93Q2FtTm9kZS5yb3RhdGVMb2NhbCgtOTAsIDAsIDApO1xuICAgICAgICBzaGFkb3dDYW0ucHJvamVjdGlvbiA9IHBjLlBST0pFQ1RJT05fUEVSU1BFQ1RJVkU7XG4gICAgICAgIHNoYWRvd0NhbS5hc3BlY3RSYXRpbyA9IDE7XG4gICAgICAgIHNoYWRvd0NhbS5mb3YgPSBzcG90Ll9vdXRlckNvbmVBbmdsZSAqIDI7XG4gICAgICAgIHNoYWRvd0NhbVZpZXcuc2V0VFJTKHNoYWRvd0NhbU5vZGUuZ2V0UG9zaXRpb24oKSwgc2hhZG93Q2FtTm9kZS5nZXRSb3RhdGlvbigpLCBwYy5WZWMzLk9ORSkuaW52ZXJ0KCk7XG4gICAgICAgIHNoYWRvd0NhbVZpZXdQcm9qLm11bDIoc2hhZG93Q2FtLmdldFByb2plY3Rpb25NYXRyaXgoKSwgc2hhZG93Q2FtVmlldyk7XG4gICAgICAgIHNwb3QuX3NoYWRvd01hdHJpeC5tdWwyKHNjYWxlU2hpZnQsIHNoYWRvd0NhbVZpZXdQcm9qKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubGlnaHRTaGFkb3dNYXRyaXhJZFtjbnRdLnNldFZhbHVlKHNwb3QuX3NoYWRvd01hdHJpeC5kYXRhKTtcbiAgICAgIHRoaXMubGlnaHRDb29raWVJbnRJZFtjbnRdLnNldFZhbHVlKHNwb3QuY29va2llSW50ZW5zaXR5KTtcbiAgICAgIGlmIChzcG90Ll9jb29raWVUcmFuc2Zvcm0pIHtcbiAgICAgICAgdGhpcy5saWdodENvb2tpZU1hdHJpeElkW2NudF0uc2V0VmFsdWUoc3BvdC5fY29va2llVHJhbnNmb3JtLmRhdGEpO1xuICAgICAgICB0aGlzLmxpZ2h0Q29va2llT2Zmc2V0SWRbY250XS5zZXRWYWx1ZShzcG90Ll9jb29raWVPZmZzZXQuZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICB9LCBkaXNwYXRjaExvY2FsTGlnaHRzOmZ1bmN0aW9uKHNjZW5lLCBtYXNrLCB1c2VkRGlyTGlnaHRzLCBzdGF0aWNMaWdodExpc3QpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgcG9pbnQsIHNwb3Q7XG4gICAgdmFyIGxvY2FsTGlnaHRzID0gc2NlbmUuX2xvY2FsTGlnaHRzO1xuICAgIHZhciBwbnRzID0gbG9jYWxMaWdodHNbcGMuTElHSFRUWVBFX1BPSU5UIC0gMV07XG4gICAgdmFyIHNwdHMgPSBsb2NhbExpZ2h0c1twYy5MSUdIVFRZUEVfU1BPVCAtIDFdO1xuICAgIHZhciBudW1EaXJzID0gdXNlZERpckxpZ2h0cztcbiAgICB2YXIgbnVtUG50cyA9IHBudHMubGVuZ3RoO1xuICAgIHZhciBudW1TcHRzID0gc3B0cy5sZW5ndGg7XG4gICAgdmFyIGNudCA9IG51bURpcnM7XG4gICAgdmFyIHNjb3BlID0gdGhpcy5kZXZpY2Uuc2NvcGU7XG4gICAgZm9yIChpID0gMDtpIDwgbnVtUG50cztpKyspIHtcbiAgICAgIHBvaW50ID0gcG50c1tpXTtcbiAgICAgIGlmICghKHBvaW50Ll9tYXNrICYgbWFzaykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAocG9pbnQuaXNTdGF0aWMpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0aGlzLmRpc3BhdGNoUG9pbnRMaWdodChzY2VuZSwgc2NvcGUsIHBvaW50LCBjbnQpO1xuICAgICAgY250Kys7XG4gICAgfVxuICAgIHZhciBzdGF0aWNJZCA9IDA7XG4gICAgaWYgKHN0YXRpY0xpZ2h0TGlzdCkge1xuICAgICAgcG9pbnQgPSBzdGF0aWNMaWdodExpc3Rbc3RhdGljSWRdO1xuICAgICAgd2hpbGUgKHBvaW50ICYmIHBvaW50Ll90eXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaFBvaW50TGlnaHQoc2NlbmUsIHNjb3BlLCBwb2ludCwgY250KTtcbiAgICAgICAgY250Kys7XG4gICAgICAgIHN0YXRpY0lkKys7XG4gICAgICAgIHBvaW50ID0gc3RhdGljTGlnaHRMaXN0W3N0YXRpY0lkXTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbnVtU3B0cztpKyspIHtcbiAgICAgIHNwb3QgPSBzcHRzW2ldO1xuICAgICAgaWYgKCEoc3BvdC5fbWFzayAmIG1hc2spKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHNwb3QuaXNTdGF0aWMpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0aGlzLmRpc3BhdGNoU3BvdExpZ2h0KHNjZW5lLCBzY29wZSwgc3BvdCwgY250KTtcbiAgICAgIGNudCsrO1xuICAgIH1cbiAgICBpZiAoc3RhdGljTGlnaHRMaXN0KSB7XG4gICAgICBzcG90ID0gc3RhdGljTGlnaHRMaXN0W3N0YXRpY0lkXTtcbiAgICAgIHdoaWxlIChzcG90ICYmIHNwb3QuX3R5cGUgPT09IHBjLkxJR0hUVFlQRV9TUE9UKSB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hTcG90TGlnaHQoc2NlbmUsIHNjb3BlLCBzcG90LCBjbnQpO1xuICAgICAgICBjbnQrKztcbiAgICAgICAgc3RhdGljSWQrKztcbiAgICAgICAgc3BvdCA9IHN0YXRpY0xpZ2h0TGlzdFtzdGF0aWNJZF07XG4gICAgICB9XG4gICAgfVxuICB9LCBjdWxsOmZ1bmN0aW9uKGNhbWVyYSwgZHJhd0NhbGxzKSB7XG4gICAgY3VsbGVkLmxlbmd0aCA9IDA7XG4gICAgdmFyIGksIGRyYXdDYWxsLCB2aXNpYmxlO1xuICAgIHZhciBkcmF3Q2FsbHNDb3VudCA9IGRyYXdDYWxscy5sZW5ndGg7XG4gICAgdmFyIGN1bGxpbmdNYXNrID0gY2FtZXJhLmN1bGxpbmdNYXNrIHx8IDQyOTQ5NjcyOTU7XG4gICAgaWYgKCFjYW1lcmEuZnJ1c3R1bUN1bGxpbmcpIHtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgICBkcmF3Q2FsbCA9IGRyYXdDYWxsc1tpXTtcbiAgICAgICAgaWYgKCFkcmF3Q2FsbC52aXNpYmxlICYmICFkcmF3Q2FsbC5jb21tYW5kKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRyYXdDYWxsLm1hc2sgJiYgKGRyYXdDYWxsLm1hc2sgJiBjdWxsaW5nTWFzaykgPT09IDApIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBjdWxsZWQucHVzaChkcmF3Q2FsbCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gY3VsbGVkO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBkcmF3Q2FsbHNDb3VudDtpKyspIHtcbiAgICAgIGRyYXdDYWxsID0gZHJhd0NhbGxzW2ldO1xuICAgICAgaWYgKCFkcmF3Q2FsbC5jb21tYW5kKSB7XG4gICAgICAgIGlmICghZHJhd0NhbGwudmlzaWJsZSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHZpc2libGUgPSB0cnVlO1xuICAgICAgICBpZiAoZHJhd0NhbGwubWFzayAmJiAoZHJhd0NhbGwubWFzayAmIGN1bGxpbmdNYXNrKSA9PT0gMCkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkcmF3Q2FsbC5sYXllciA+IHBjLkxBWUVSX0ZYKSB7XG4gICAgICAgICAgaWYgKGRyYXdDYWxsLmN1bGwpIHtcbiAgICAgICAgICAgIHZpc2libGUgPSB0aGlzLl9pc1Zpc2libGUoY2FtZXJhLCBkcmF3Q2FsbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICAgICAgY3VsbGVkLnB1c2goZHJhd0NhbGwpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdWxsZWQucHVzaChkcmF3Q2FsbCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBjdWxsZWQ7XG4gIH0sIGNhbGN1bGF0ZVNvcnREaXN0YW5jZXM6ZnVuY3Rpb24oZHJhd0NhbGxzLCBjYW1Qb3MsIGNhbUZ3ZCwgZnJvbnRUb0JhY2spIHtcbiAgICB2YXIgaSwgZHJhd0NhbGwsIGJ0eXBlLCBtZXNoUG9zO1xuICAgIHZhciB0ZW1weCwgdGVtcHksIHRlbXB6O1xuICAgIHZhciBkcmF3Q2FsbHNDb3VudCA9IGRyYXdDYWxscy5sZW5ndGg7XG4gICAgZm9yIChpID0gMDtpIDwgZHJhd0NhbGxzQ291bnQ7aSsrKSB7XG4gICAgICBkcmF3Q2FsbCA9IGRyYXdDYWxsc1tpXTtcbiAgICAgIGlmIChkcmF3Q2FsbC5jb21tYW5kKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGRyYXdDYWxsLmxheWVyIDw9IHBjLnNjZW5lLkxBWUVSX0ZYKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgYnR5cGUgPSBkcmF3Q2FsbC5tYXRlcmlhbC5ibGVuZFR5cGU7XG4gICAgICBpZiAoYnR5cGUgIT09IHBjLkJMRU5EX05PTkUpIHtcbiAgICAgICAgbWVzaFBvcyA9IGRyYXdDYWxsLmFhYmIuY2VudGVyLmRhdGE7XG4gICAgICAgIHRlbXB4ID0gbWVzaFBvc1swXSAtIGNhbVBvc1swXTtcbiAgICAgICAgdGVtcHkgPSBtZXNoUG9zWzFdIC0gY2FtUG9zWzFdO1xuICAgICAgICB0ZW1weiA9IG1lc2hQb3NbMl0gLSBjYW1Qb3NbMl07XG4gICAgICAgIGRyYXdDYWxsLnpkaXN0ID0gdGVtcHggKiBjYW1Gd2RbMF0gKyB0ZW1weSAqIGNhbUZ3ZFsxXSArIHRlbXB6ICogY2FtRndkWzJdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGRyYXdDYWxsLm1hdGVyaWFsLmFscGhhVGVzdCB8fCBkcmF3Q2FsbC5tYXRlcmlhbC5hbHBoYVRvQ292ZXJhZ2UpIHtcbiAgICAgICAgICBkcmF3Q2FsbC56ZGlzdCA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGRyYXdDYWxsLnpkaXN0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkcmF3Q2FsbC56ZGlzdDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChmcm9udFRvQmFjayAmJiBidHlwZSA9PT0gcGMuQkxFTkRfTk9ORSkge1xuICAgICAgICBtZXNoUG9zID0gZHJhd0NhbGwuYWFiYi5jZW50ZXIuZGF0YTtcbiAgICAgICAgdGVtcHggPSBtZXNoUG9zWzBdIC0gY2FtUG9zWzBdO1xuICAgICAgICB0ZW1weSA9IG1lc2hQb3NbMV0gLSBjYW1Qb3NbMV07XG4gICAgICAgIHRlbXB6ID0gbWVzaFBvc1syXSAtIGNhbVBvc1syXTtcbiAgICAgICAgZHJhd0NhbGwuemRpc3QyID0gdGVtcHggKiBjYW1Gd2RbMF0gKyB0ZW1weSAqIGNhbUZ3ZFsxXSArIHRlbXB6ICogY2FtRndkWzJdO1xuICAgICAgfVxuICAgIH1cbiAgfSwgdXBkYXRlQ3B1U2tpbk1hdHJpY2VzOmZ1bmN0aW9uKGRyYXdDYWxscykge1xuICAgIHZhciBkcmF3Q2FsbHNDb3VudCA9IGRyYXdDYWxscy5sZW5ndGg7XG4gICAgaWYgKGRyYXdDYWxsc0NvdW50ID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBpLCBza2luO1xuICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgc2tpbiA9IGRyYXdDYWxsc1tpXS5za2luSW5zdGFuY2U7XG4gICAgICBpZiAoc2tpbikge1xuICAgICAgICBza2luLnVwZGF0ZU1hdHJpY2VzKCk7XG4gICAgICAgIHNraW4uX2RpcnR5ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHVwZGF0ZUdwdVNraW5NYXRyaWNlczpmdW5jdGlvbihkcmF3Q2FsbHMpIHtcbiAgICB2YXIgaSwgc2tpbjtcbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgc2tpbiA9IGRyYXdDYWxsc1tpXS5za2luSW5zdGFuY2U7XG4gICAgICBpZiAoc2tpbikge1xuICAgICAgICBpZiAoc2tpbi5fZGlydHkpIHtcbiAgICAgICAgICBza2luLnVwZGF0ZU1hdHJpeFBhbGV0dGUoKTtcbiAgICAgICAgICBza2luLl9kaXJ0eSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCB1cGRhdGVNb3JwaGVkQm91bmRzOmZ1bmN0aW9uKGRyYXdDYWxscykge1xuICAgIHZhciBpLCBtb3JwaDtcbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgbW9ycGggPSBkcmF3Q2FsbHNbaV0ubW9ycGhJbnN0YW5jZTtcbiAgICAgIGlmIChtb3JwaCAmJiBtb3JwaC5fZGlydHkpIHtcbiAgICAgICAgbW9ycGgudXBkYXRlQm91bmRzKGRyYXdDYWxsc1tpXS5tZXNoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHVwZGF0ZU1vcnBoaW5nOmZ1bmN0aW9uKGRyYXdDYWxscykge1xuICAgIHZhciBpLCBtb3JwaDtcbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgbW9ycGggPSBkcmF3Q2FsbHNbaV0ubW9ycGhJbnN0YW5jZTtcbiAgICAgIGlmIChtb3JwaCAmJiBtb3JwaC5fZGlydHkpIHtcbiAgICAgICAgbW9ycGgudXBkYXRlKGRyYXdDYWxsc1tpXS5tZXNoKTtcbiAgICAgICAgbW9ycGguX2RpcnR5ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9LCBzb3J0RHJhd0NhbGxzOmZ1bmN0aW9uKGRyYXdDYWxscywgc29ydEZ1bmMsIGtleVR5cGUpIHtcbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIGlmIChkcmF3Q2FsbHNDb3VudCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkcmF3Q2FsbHMuc29ydChzb3J0RnVuYyk7XG4gIH0sIHByZXBhcmVJbnN0YW5jaW5nOmZ1bmN0aW9uKGRldmljZSwgZHJhd0NhbGxzLCBrZXlUeXBlLCBzaGFkZXJUeXBlKSB7XG4gICAgaWYgKCFkZXZpY2UuZXh0SW5zdGFuY2luZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIHZhciBpLCBqLCBtZXNoSW5zdGFuY2UsIG1lc2gsIG5leHQsIGF1dG9JbnN0YW5jZXMsIGtleSwgZGF0YTtcbiAgICB2YXIgb2Zmc2V0ID0gMDtcbiAgICBpZiAoZGV2aWNlLmVuYWJsZUF1dG9JbnN0YW5jaW5nKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBkcmF3Q2FsbHNDb3VudCAtIDE7aSsrKSB7XG4gICAgICAgIG1lc2hJbnN0YW5jZSA9IGRyYXdDYWxsc1tpXTtcbiAgICAgICAgbWVzaCA9IG1lc2hJbnN0YW5jZS5tZXNoO1xuICAgICAgICBrZXkgPSBtZXNoSW5zdGFuY2UuX2tleVtrZXlUeXBlXTtcbiAgICAgICAgbmV4dCA9IGkgKyAxO1xuICAgICAgICBhdXRvSW5zdGFuY2VzID0gMDtcbiAgICAgICAgaWYgKGRyYXdDYWxsc1tuZXh0XS5tZXNoID09PSBtZXNoICYmIGRyYXdDYWxsc1tuZXh0XS5fa2V5W2tleVR5cGVdID09PSBrZXkpIHtcbiAgICAgICAgICBmb3IgKGogPSAwO2ogPCAxNjtqKyspIHtcbiAgICAgICAgICAgIHBjLl9hdXRvSW5zdGFuY2VCdWZmZXJEYXRhW29mZnNldCArIGpdID0gbWVzaEluc3RhbmNlLm5vZGUud29ybGRUcmFuc2Zvcm0uZGF0YVtqXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYXV0b0luc3RhbmNlcyA9IDE7XG4gICAgICAgICAgd2hpbGUgKG5leHQgIT09IGRyYXdDYWxsc0NvdW50ICYmIGRyYXdDYWxsc1tuZXh0XS5tZXNoID09PSBtZXNoICYmIGRyYXdDYWxsc1tuZXh0XS5fa2V5W2tleVR5cGVdID09PSBrZXkpIHtcbiAgICAgICAgICAgIGZvciAoaiA9IDA7aiA8IDE2O2orKykge1xuICAgICAgICAgICAgICBwYy5fYXV0b0luc3RhbmNlQnVmZmVyRGF0YVtvZmZzZXQgKyBhdXRvSW5zdGFuY2VzICogMTYgKyBqXSA9IGRyYXdDYWxsc1tuZXh0XS5ub2RlLndvcmxkVHJhbnNmb3JtLmRhdGFbal07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhdXRvSW5zdGFuY2VzKys7XG4gICAgICAgICAgICBuZXh0Kys7XG4gICAgICAgICAgfVxuICAgICAgICAgIGRhdGEgPSBtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGE7XG4gICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGEgPSBkYXRhID0ge307XG4gICAgICAgICAgfVxuICAgICAgICAgIGRhdGEuY291bnQgPSBhdXRvSW5zdGFuY2VzO1xuICAgICAgICAgIGRhdGEub2Zmc2V0ID0gb2Zmc2V0ICogNDtcbiAgICAgICAgICBkYXRhLl9idWZmZXIgPSBwYy5fYXV0b0luc3RhbmNlQnVmZmVyO1xuICAgICAgICAgIGkgPSBuZXh0IC0gMTtcbiAgICAgICAgfVxuICAgICAgICBvZmZzZXQgKz0gYXV0b0luc3RhbmNlcyAqIDE2O1xuICAgICAgfVxuICAgICAgaWYgKG9mZnNldCA+IDApIHtcbiAgICAgICAgcGMuX2F1dG9JbnN0YW5jZUJ1ZmZlci51bmxvY2soKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgZHJhd0NhbGxzQ291bnQ7aSsrKSB7XG4gICAgICBtZXNoSW5zdGFuY2UgPSBkcmF3Q2FsbHNbaV07XG4gICAgICBpZiAobWVzaEluc3RhbmNlLmluc3RhbmNpbmdEYXRhKSB7XG4gICAgICAgIGlmICghKG1lc2hJbnN0YW5jZS5fc2hhZGVyRGVmcyAmIHBjLlNIQURFUkRFRl9JTlNUQU5DSU5HKSkge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5fc2hhZGVyRGVmcyB8PSBwYy5TSEFERVJERUZfSU5TVEFOQ0lORztcbiAgICAgICAgICBtZXNoSW5zdGFuY2UuX3NoYWRlcltzaGFkZXJUeXBlXSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGEuX2J1ZmZlcikge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5pbnN0YW5jaW5nRGF0YS5fYnVmZmVyID0gbmV3IHBjLlZlcnRleEJ1ZmZlcihkZXZpY2UsIHBjLl9pbnN0YW5jZVZlcnRleEZvcm1hdCwgbWVzaEluc3RhbmNlLmluc3RhbmNpbmdEYXRhLmNvdW50LCBtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGEudXNhZ2UsIG1lc2hJbnN0YW5jZS5pbnN0YW5jaW5nRGF0YS5idWZmZXIpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobWVzaEluc3RhbmNlLl9zaGFkZXJEZWZzICYgcGMuU0hBREVSREVGX0lOU1RBTkNJTkcpIHtcbiAgICAgICAgICBtZXNoSW5zdGFuY2UuX3NoYWRlckRlZnMgJj0gfnBjLlNIQURFUkRFRl9JTlNUQU5DSU5HO1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5fc2hhZGVyW3NoYWRlclR5cGVdID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgc2V0QmFzZUNvbnN0YW50czpmdW5jdGlvbihkZXZpY2UsIG1hdGVyaWFsKSB7XG4gICAgZGV2aWNlLnNldEN1bGxNb2RlKG1hdGVyaWFsLmN1bGwpO1xuICAgIGlmIChtYXRlcmlhbC5vcGFjaXR5TWFwKSB7XG4gICAgICB0aGlzLm9wYWNpdHlNYXBJZC5zZXRWYWx1ZShtYXRlcmlhbC5vcGFjaXR5TWFwKTtcbiAgICAgIHRoaXMuYWxwaGFUZXN0SWQuc2V0VmFsdWUobWF0ZXJpYWwuYWxwaGFUZXN0KTtcbiAgICB9XG4gIH0sIHNldFNraW5uaW5nOmZ1bmN0aW9uKGRldmljZSwgbWVzaEluc3RhbmNlLCBtYXRlcmlhbCkge1xuICAgIGlmIChtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlKSB7XG4gICAgICB0aGlzLl9za2luRHJhd0NhbGxzKys7XG4gICAgICB0aGlzLnNraW5Qb3NPZmZzZXRJZC5zZXRWYWx1ZShtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlLnJvb3ROb2RlLmdldFBvc2l0aW9uKCkuZGF0YSk7XG4gICAgICBpZiAoZGV2aWNlLnN1cHBvcnRzQm9uZVRleHR1cmVzKSB7XG4gICAgICAgIGJvbmVUZXh0dXJlID0gbWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZS5ib25lVGV4dHVyZTtcbiAgICAgICAgdGhpcy5ib25lVGV4dHVyZUlkLnNldFZhbHVlKGJvbmVUZXh0dXJlKTtcbiAgICAgICAgYm9uZVRleHR1cmVTaXplWzBdID0gYm9uZVRleHR1cmUud2lkdGg7XG4gICAgICAgIGJvbmVUZXh0dXJlU2l6ZVsxXSA9IGJvbmVUZXh0dXJlLmhlaWdodDtcbiAgICAgICAgdGhpcy5ib25lVGV4dHVyZVNpemVJZC5zZXRWYWx1ZShib25lVGV4dHVyZVNpemUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5wb3NlTWF0cml4SWQuc2V0VmFsdWUobWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZS5tYXRyaXhQYWxldHRlKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGRyYXdJbnN0YW5jZTpmdW5jdGlvbihkZXZpY2UsIG1lc2hJbnN0YW5jZSwgbWVzaCwgc3R5bGUsIG5vcm1hbCkge1xuICAgIGluc3RhbmNpbmdEYXRhID0gbWVzaEluc3RhbmNlLmluc3RhbmNpbmdEYXRhO1xuICAgIGlmIChpbnN0YW5jaW5nRGF0YSkge1xuICAgICAgdGhpcy5faW5zdGFuY2VkRHJhd0NhbGxzKys7XG4gICAgICB0aGlzLl9yZW1vdmVkQnlJbnN0YW5jaW5nICs9IGluc3RhbmNpbmdEYXRhLmNvdW50O1xuICAgICAgZGV2aWNlLnNldFZlcnRleEJ1ZmZlcihpbnN0YW5jaW5nRGF0YS5fYnVmZmVyLCAxLCBpbnN0YW5jaW5nRGF0YS5vZmZzZXQpO1xuICAgICAgZGV2aWNlLmRyYXcobWVzaC5wcmltaXRpdmVbc3R5bGVdLCBpbnN0YW5jaW5nRGF0YS5jb3VudCk7XG4gICAgICBpZiAoaW5zdGFuY2luZ0RhdGEuX2J1ZmZlciA9PT0gcGMuX2F1dG9JbnN0YW5jZUJ1ZmZlcikge1xuICAgICAgICBtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGEgPSBudWxsO1xuICAgICAgICByZXR1cm4gaW5zdGFuY2luZ0RhdGEuY291bnQgLSAxO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBtb2RlbE1hdHJpeCA9IG1lc2hJbnN0YW5jZS5ub2RlLndvcmxkVHJhbnNmb3JtO1xuICAgICAgdGhpcy5tb2RlbE1hdHJpeElkLnNldFZhbHVlKG1vZGVsTWF0cml4LmRhdGEpO1xuICAgICAgaWYgKG5vcm1hbCkge1xuICAgICAgICBub3JtYWxNYXRyaXggPSBtZXNoSW5zdGFuY2Uubm9kZS5ub3JtYWxNYXRyaXg7XG4gICAgICAgIGlmIChtZXNoSW5zdGFuY2Uubm9kZS5fZGlydHlOb3JtYWwpIHtcbiAgICAgICAgICBtb2RlbE1hdHJpeC5pbnZlcnRUbzN4Myhub3JtYWxNYXRyaXgpO1xuICAgICAgICAgIG5vcm1hbE1hdHJpeC50cmFuc3Bvc2UoKTtcbiAgICAgICAgICBtZXNoSW5zdGFuY2Uubm9kZS5fZGlydHlOb3JtYWwgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vcm1hbE1hdHJpeElkLnNldFZhbHVlKG5vcm1hbE1hdHJpeC5kYXRhKTtcbiAgICAgIH1cbiAgICAgIGRldmljZS5kcmF3KG1lc2gucHJpbWl0aXZlW3N0eWxlXSk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH0sIGRyYXdJbnN0YW5jZTI6ZnVuY3Rpb24oZGV2aWNlLCBtZXNoSW5zdGFuY2UsIG1lc2gsIHN0eWxlKSB7XG4gICAgaW5zdGFuY2luZ0RhdGEgPSBtZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGE7XG4gICAgaWYgKGluc3RhbmNpbmdEYXRhKSB7XG4gICAgICB0aGlzLl9pbnN0YW5jZWREcmF3Q2FsbHMrKztcbiAgICAgIHRoaXMuX3JlbW92ZWRCeUluc3RhbmNpbmcgKz0gaW5zdGFuY2luZ0RhdGEuY291bnQ7XG4gICAgICBkZXZpY2Uuc2V0VmVydGV4QnVmZmVyKGluc3RhbmNpbmdEYXRhLl9idWZmZXIsIDEsIGluc3RhbmNpbmdEYXRhLm9mZnNldCk7XG4gICAgICBkZXZpY2UuZHJhdyhtZXNoLnByaW1pdGl2ZVtzdHlsZV0sIGluc3RhbmNpbmdEYXRhLmNvdW50KTtcbiAgICAgIGlmIChpbnN0YW5jaW5nRGF0YS5fYnVmZmVyID09PSBwYy5fYXV0b0luc3RhbmNlQnVmZmVyKSB7XG4gICAgICAgIG1lc2hJbnN0YW5jZS5pbnN0YW5jaW5nRGF0YSA9IG51bGw7XG4gICAgICAgIHJldHVybiBpbnN0YW5jaW5nRGF0YS5jb3VudCAtIDE7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGRldmljZS5kcmF3KG1lc2gucHJpbWl0aXZlW3N0eWxlXSk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH0sIGZpbmRTaGFkb3dTaGFkZXI6ZnVuY3Rpb24obWVzaEluc3RhbmNlLCB0eXBlLCBzaGFkb3dUeXBlLCBzY2VuZSkge1xuICAgIGlmIChzaGFkb3dUeXBlID49IG51bVNoYWRvd01vZGVzKSB7XG4gICAgICBzaGFkb3dUeXBlIC09IG51bVNoYWRvd01vZGVzO1xuICAgIH1cbiAgICB2YXIgbWF0ZXJpYWwgPSBtZXNoSW5zdGFuY2UubWF0ZXJpYWw7XG4gICAgdmFyIHNtb2RlID0gc2hhZG93VHlwZSArIHR5cGUgKiBudW1TaGFkb3dNb2RlcztcbiAgICBpZiAoIW1hdGVyaWFsLnNoYWRlcikge1xuICAgICAgbWF0ZXJpYWwudXBkYXRlU2hhZGVyKHRoaXMuZGV2aWNlLCBzY2VuZSwgbWVzaEluc3RhbmNlLl9zaGFkZXJEZWZzLCBtZXNoSW5zdGFuY2UuX3N0YXRpY0xpZ2h0TGlzdCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmxpYnJhcnkuZ2V0UHJvZ3JhbShcImRlcHRocmdiYVwiLCB7c2tpbjohIW1lc2hJbnN0YW5jZS5za2luSW5zdGFuY2UsIG9wYWNpdHlNYXA6ISFtYXRlcmlhbC5vcGFjaXR5TWFwLCBvcGFjaXR5Q2hhbm5lbDptYXRlcmlhbC5vcGFjaXR5TWFwID8gbWF0ZXJpYWwub3BhY2l0eU1hcENoYW5uZWwgfHwgXCJyXCIgOiBudWxsLCBzaGFkb3dUeXBlOnNoYWRvd1R5cGUsIGluc3RhbmNpbmc6bWVzaEluc3RhbmNlLmluc3RhbmNpbmdEYXRhLCB0eXBlOnR5cGUsIGNodW5rczptYXRlcmlhbC5jaHVua3MsIGF0dHJpYnV0ZXM6bWF0ZXJpYWwuc2hhZGVyLmRlZmluaXRpb24uYXR0cmlidXRlc30pO1xuICB9LCByZW5kZXJTaGFkb3dzOmZ1bmN0aW9uKGRldmljZSwgY2FtZXJhLCBkcmF3Q2FsbHMsIGxpZ2h0cywgc2NlbmUpIHtcbiAgICB2YXIgaSwgaiwgbGlnaHQsIHNoYWRvd1NoYWRlciwgdHlwZSwgc2hhZG93Q2FtLCBzaGFkb3dDYW1Ob2RlLCBsaWdodE5vZGUsIHBhc3NlcywgcGFzcywgZnJ1c3R1bVNpemUsIHNoYWRvd1R5cGUsIHNtb2RlO1xuICAgIHZhciB1bml0UGVyVGV4ZWwsIGRlbHRhLCBwO1xuICAgIHZhciBtaW54LCBtaW55LCBtaW56LCBtYXh4LCBtYXh5LCBtYXh6LCBjZW50ZXJ4LCBjZW50ZXJ5O1xuICAgIHZhciBvcENoYW47XG4gICAgdmFyIHZpc2libGUsIGN1bGxUaW1lLCBudW1JbnN0YW5jZXM7XG4gICAgdmFyIG1lc2hJbnN0YW5jZSwgbWVzaCwgbWF0ZXJpYWw7XG4gICAgdmFyIHN0eWxlO1xuICAgIHZhciBlbXB0eUFhYmI7XG4gICAgdmFyIGRyYXdDYWxsQWFiYjtcbiAgICB2YXIgcGFzc0ZsYWcgPSAxIDw8IHBjLlNIQURFUl9TSEFET1c7XG4gICAgdmFyIHBhcmFtTmFtZSwgcGFyYW1ldGVyLCBwYXJhbWV0ZXJzO1xuICAgIGZvciAoaSA9IDA7aSA8IGxpZ2h0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBsaWdodCA9IGxpZ2h0c1tpXTtcbiAgICAgIHR5cGUgPSBsaWdodC5fdHlwZTtcbiAgICAgIGlmIChsaWdodC5jYXN0U2hhZG93cyAmJiBsaWdodC5fZW5hYmxlZCAmJiBsaWdodC5zaGFkb3dVcGRhdGVNb2RlICE9PSBwYy5TSEFET1dVUERBVEVfTk9ORSkge1xuICAgICAgICBzaGFkb3dDYW0gPSB0aGlzLmdldFNoYWRvd0NhbWVyYShkZXZpY2UsIGxpZ2h0KTtcbiAgICAgICAgc2hhZG93Q2FtTm9kZSA9IHNoYWRvd0NhbS5fbm9kZTtcbiAgICAgICAgbGlnaHROb2RlID0gbGlnaHQuX25vZGU7XG4gICAgICAgIHBhc3NlcyA9IDE7XG4gICAgICAgIHNoYWRvd0NhbU5vZGUuc2V0UG9zaXRpb24obGlnaHROb2RlLmdldFBvc2l0aW9uKCkpO1xuICAgICAgICBzaGFkb3dDYW1Ob2RlLnNldFJvdGF0aW9uKGxpZ2h0Tm9kZS5nZXRSb3RhdGlvbigpKTtcbiAgICAgICAgc2hhZG93Q2FtTm9kZS5yb3RhdGVMb2NhbCgtOTAsIDAsIDApO1xuICAgICAgICBpZiAodHlwZSA9PT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgICAgICAgX2dldEZydXN0dW1Qb2ludHMoY2FtZXJhLCBsaWdodC5zaGFkb3dEaXN0YW5jZSB8fCBjYW1lcmEuX2ZhckNsaXAsIGZydXN0dW1Qb2ludHMpO1xuICAgICAgICAgIGZydXN0dW1TaXplID0gZnJ1c3R1bURpYWdvbmFsLnN1YjIoZnJ1c3R1bVBvaW50c1swXSwgZnJ1c3R1bVBvaW50c1s2XSkubGVuZ3RoKCk7XG4gICAgICAgICAgZnJ1c3R1bVNpemUgPSBNYXRoLm1heChmcnVzdHVtU2l6ZSwgZnJ1c3R1bURpYWdvbmFsLnN1YjIoZnJ1c3R1bVBvaW50c1s0XSwgZnJ1c3R1bVBvaW50c1s2XSkubGVuZ3RoKCkpO1xuICAgICAgICAgIHNoYWRvd0NhbVZpZXcuY29weShzaGFkb3dDYW1Ob2RlLmdldFdvcmxkVHJhbnNmb3JtKCkpLmludmVydCgpO1xuICAgICAgICAgIGMyc2MuY29weShzaGFkb3dDYW1WaWV3KS5tdWwoY2FtZXJhLl9ub2RlLndvcmxkVHJhbnNmb3JtKTtcbiAgICAgICAgICBmb3IgKGogPSAwO2ogPCA4O2orKykge1xuICAgICAgICAgICAgYzJzYy50cmFuc2Zvcm1Qb2ludChmcnVzdHVtUG9pbnRzW2pdLCBmcnVzdHVtUG9pbnRzW2pdKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbWlueCA9IG1pbnkgPSBtaW56ID0gMTAwMDAwMDtcbiAgICAgICAgICBtYXh4ID0gbWF4eSA9IG1heHogPSAtMTAwMDAwMDtcbiAgICAgICAgICBmb3IgKGogPSAwO2ogPCA4O2orKykge1xuICAgICAgICAgICAgcCA9IGZydXN0dW1Qb2ludHNbal07XG4gICAgICAgICAgICBpZiAocC54IDwgbWlueCkge1xuICAgICAgICAgICAgICBtaW54ID0gcC54O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHAueCA+IG1heHgpIHtcbiAgICAgICAgICAgICAgbWF4eCA9IHAueDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwLnkgPCBtaW55KSB7XG4gICAgICAgICAgICAgIG1pbnkgPSBwLnk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocC55ID4gbWF4eSkge1xuICAgICAgICAgICAgICBtYXh5ID0gcC55O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHAueiA8IG1pbnopIHtcbiAgICAgICAgICAgICAgbWlueiA9IHAuejtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwLnogPiBtYXh6KSB7XG4gICAgICAgICAgICAgIG1heHogPSBwLno7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHVuaXRQZXJUZXhlbCA9IGZydXN0dW1TaXplIC8gbGlnaHQuX3NoYWRvd1Jlc29sdXRpb247XG4gICAgICAgICAgZGVsdGEgPSAoZnJ1c3R1bVNpemUgLSAobWF4eCAtIG1pbngpKSAqIDAuNTtcbiAgICAgICAgICBtaW54ID0gTWF0aC5mbG9vcigobWlueCAtIGRlbHRhKSAvIHVuaXRQZXJUZXhlbCkgKiB1bml0UGVyVGV4ZWw7XG4gICAgICAgICAgZGVsdGEgPSAoZnJ1c3R1bVNpemUgLSAobWF4eSAtIG1pbnkpKSAqIDAuNTtcbiAgICAgICAgICBtaW55ID0gTWF0aC5mbG9vcigobWlueSAtIGRlbHRhKSAvIHVuaXRQZXJUZXhlbCkgKiB1bml0UGVyVGV4ZWw7XG4gICAgICAgICAgbWF4eCA9IG1pbnggKyBmcnVzdHVtU2l6ZTtcbiAgICAgICAgICBtYXh5ID0gbWlueSArIGZydXN0dW1TaXplO1xuICAgICAgICAgIGNlbnRlcnggPSAobWF4eCArIG1pbngpICogMC41O1xuICAgICAgICAgIGNlbnRlcnkgPSAobWF4eSArIG1pbnkpICogMC41O1xuICAgICAgICAgIHNoYWRvd0NhbU5vZGUudHJhbnNsYXRlTG9jYWwoY2VudGVyeCwgY2VudGVyeSwgMTAwMDAwKTtcbiAgICAgICAgICBzaGFkb3dDYW0ucHJvamVjdGlvbiA9IHBjLlBST0pFQ1RJT05fT1JUSE9HUkFQSElDO1xuICAgICAgICAgIHNoYWRvd0NhbS5uZWFyQ2xpcCA9IDA7XG4gICAgICAgICAgc2hhZG93Q2FtLmZhckNsaXAgPSAyMDAwMDA7XG4gICAgICAgICAgc2hhZG93Q2FtLmFzcGVjdFJhdGlvID0gMTtcbiAgICAgICAgICBzaGFkb3dDYW0ub3J0aG9IZWlnaHQgPSBmcnVzdHVtU2l6ZSAqIDAuNTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgICAgICAgIGlmIChjYW1lcmEuZnJ1c3R1bUN1bGxpbmcgJiYgbGlnaHQuc2hhZG93VXBkYXRlTW9kZSA9PT0gcGMuU0hBRE9XVVBEQVRFX1JFQUxUSU1FKSB7XG4gICAgICAgICAgICAgIGxpZ2h0LmdldEJvdW5kaW5nU3BoZXJlKHRlbXBTcGhlcmUpO1xuICAgICAgICAgICAgICBpZiAoIWNhbWVyYS5mcnVzdHVtLmNvbnRhaW5zU3BoZXJlKHRlbXBTcGhlcmUpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNoYWRvd0NhbS5wcm9qZWN0aW9uID0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRTtcbiAgICAgICAgICAgIHNoYWRvd0NhbS5uZWFyQ2xpcCA9IGxpZ2h0LmF0dGVudWF0aW9uRW5kIC8gMTAwMDtcbiAgICAgICAgICAgIHNoYWRvd0NhbS5mYXJDbGlwID0gbGlnaHQuYXR0ZW51YXRpb25FbmQ7XG4gICAgICAgICAgICBzaGFkb3dDYW0uYXNwZWN0UmF0aW8gPSAxO1xuICAgICAgICAgICAgc2hhZG93Q2FtLmZvdiA9IGxpZ2h0Ll9vdXRlckNvbmVBbmdsZSAqIDI7XG4gICAgICAgICAgICB0aGlzLnZpZXdQb3NJZC5zZXRWYWx1ZShzaGFkb3dDYW1Ob2RlLmdldFBvc2l0aW9uKCkuZGF0YSk7XG4gICAgICAgICAgICB0aGlzLnNoYWRvd01hcExpZ2h0UmFkaXVzSWQuc2V0VmFsdWUobGlnaHQuYXR0ZW51YXRpb25FbmQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICAgICAgICAgIGlmIChjYW1lcmEuZnJ1c3R1bUN1bGxpbmcgJiYgbGlnaHQuc2hhZG93VXBkYXRlTW9kZSA9PT0gcGMuU0hBRE9XVVBEQVRFX1JFQUxUSU1FKSB7XG4gICAgICAgICAgICAgICAgbGlnaHQuZ2V0Qm91bmRpbmdTcGhlcmUodGVtcFNwaGVyZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFjYW1lcmEuZnJ1c3R1bS5jb250YWluc1NwaGVyZSh0ZW1wU3BoZXJlKSkge1xuICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHNoYWRvd0NhbS5wcm9qZWN0aW9uID0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRTtcbiAgICAgICAgICAgICAgc2hhZG93Q2FtLm5lYXJDbGlwID0gbGlnaHQuYXR0ZW51YXRpb25FbmQgLyAxMDAwO1xuICAgICAgICAgICAgICBzaGFkb3dDYW0uZmFyQ2xpcCA9IGxpZ2h0LmF0dGVudWF0aW9uRW5kO1xuICAgICAgICAgICAgICBzaGFkb3dDYW0uYXNwZWN0UmF0aW8gPSAxO1xuICAgICAgICAgICAgICBzaGFkb3dDYW0uZm92ID0gOTA7XG4gICAgICAgICAgICAgIHBhc3NlcyA9IDY7XG4gICAgICAgICAgICAgIHRoaXMudmlld1Bvc0lkLnNldFZhbHVlKHNoYWRvd0NhbU5vZGUuZ2V0UG9zaXRpb24oKS5kYXRhKTtcbiAgICAgICAgICAgICAgdGhpcy5zaGFkb3dNYXBMaWdodFJhZGl1c0lkLnNldFZhbHVlKGxpZ2h0LmF0dGVudWF0aW9uRW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRldmljZS53ZWJnbDIpIHtcbiAgICAgICAgICBpZiAodHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICAgICAgICBkZXZpY2Uuc2V0RGVwdGhCaWFzKGZhbHNlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGV2aWNlLnNldERlcHRoQmlhcyh0cnVlKTtcbiAgICAgICAgICAgIGRldmljZS5zZXREZXB0aEJpYXNWYWx1ZXMobGlnaHQuc2hhZG93QmlhcyAqIC0xMDAwLjAsIGxpZ2h0LnNoYWRvd0JpYXMgKiAtMTAwMC4wKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGRldmljZS5leHRTdGFuZGFyZERlcml2YXRpdmVzKSB7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICAgICAgICAgIHRoaXMucG9seWdvbk9mZnNldFswXSA9IDA7XG4gICAgICAgICAgICAgIHRoaXMucG9seWdvbk9mZnNldFsxXSA9IDA7XG4gICAgICAgICAgICAgIHRoaXMucG9seWdvbk9mZnNldElkLnNldFZhbHVlKHRoaXMucG9seWdvbk9mZnNldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLnBvbHlnb25PZmZzZXRbMF0gPSBsaWdodC5zaGFkb3dCaWFzICogLTEwMDAuMDtcbiAgICAgICAgICAgICAgdGhpcy5wb2x5Z29uT2Zmc2V0WzFdID0gbGlnaHQuc2hhZG93QmlhcyAqIC0xMDAwLjA7XG4gICAgICAgICAgICAgIHRoaXMucG9seWdvbk9mZnNldElkLnNldFZhbHVlKHRoaXMucG9seWdvbk9mZnNldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChsaWdodC5zaGFkb3dVcGRhdGVNb2RlID09PSBwYy5TSEFET1dVUERBVEVfVEhJU0ZSQU1FKSB7XG4gICAgICAgICAgbGlnaHQuc2hhZG93VXBkYXRlTW9kZSA9IHBjLlNIQURPV1VQREFURV9OT05FO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NoYWRvd01hcFVwZGF0ZXMgKz0gcGFzc2VzO1xuICAgICAgICBmb3IgKHBhc3MgPSAwO3Bhc3MgPCBwYXNzZXM7cGFzcysrKSB7XG4gICAgICAgICAgZGV2aWNlLnNldEJsZW5kaW5nKGZhbHNlKTtcbiAgICAgICAgICBkZXZpY2Uuc2V0RGVwdGhXcml0ZSh0cnVlKTtcbiAgICAgICAgICBkZXZpY2Uuc2V0RGVwdGhUZXN0KHRydWUpO1xuICAgICAgICAgIGlmIChsaWdodC5faXNQY2YgJiYgZGV2aWNlLndlYmdsMiAmJiB0eXBlICE9PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgICAgIGRldmljZS5zZXRDb2xvcldyaXRlKGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGV2aWNlLnNldENvbG9yV3JpdGUodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0eXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgICAgIGlmIChwYXNzID09PSAwKSB7XG4gICAgICAgICAgICAgIHNoYWRvd0NhbU5vZGUuc2V0RXVsZXJBbmdsZXMoMCwgOTAsIDE4MCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAocGFzcyA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHNoYWRvd0NhbU5vZGUuc2V0RXVsZXJBbmdsZXMoMCwgLTkwLCAxODApO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwYXNzID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICBzaGFkb3dDYW1Ob2RlLnNldEV1bGVyQW5nbGVzKDkwLCAwLCAwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgaWYgKHBhc3MgPT09IDMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5zZXRFdWxlckFuZ2xlcygtOTAsIDAsIDApO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhc3MgPT09IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dDYW1Ob2RlLnNldEV1bGVyQW5nbGVzKDAsIDE4MCwgMTgwKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICBpZiAocGFzcyA9PT0gNSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5zZXRFdWxlckFuZ2xlcygwLCAwLCAxODApO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2hhZG93Q2FtTm9kZS5zZXRQb3NpdGlvbihsaWdodE5vZGUuZ2V0UG9zaXRpb24oKSk7XG4gICAgICAgICAgICBzaGFkb3dDYW0ucmVuZGVyVGFyZ2V0ID0gbGlnaHQuX3NoYWRvd0N1YmVNYXBbcGFzc107XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuc2V0Q2FtZXJhKHNoYWRvd0NhbSwgdHlwZSAhPT0gcGMuTElHSFRUWVBFX1BPSU5UKTtcbiAgICAgICAgICBjdWxsZWQubGVuZ3RoID0gMDtcbiAgICAgICAgICBmb3IgKGogPSAwLCBudW1JbnN0YW5jZXMgPSBkcmF3Q2FsbHMubGVuZ3RoO2ogPCBudW1JbnN0YW5jZXM7aisrKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2UgPSBkcmF3Q2FsbHNbal07XG4gICAgICAgICAgICB2aXNpYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChtZXNoSW5zdGFuY2UuY3VsbCkge1xuICAgICAgICAgICAgICB2aXNpYmxlID0gdGhpcy5faXNWaXNpYmxlKHNoYWRvd0NhbSwgbWVzaEluc3RhbmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICAgICAgICAgIGN1bGxlZC5wdXNoKG1lc2hJbnN0YW5jZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMudXBkYXRlR3B1U2tpbk1hdHJpY2VzKGN1bGxlZCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVNb3JwaGluZyhjdWxsZWQpO1xuICAgICAgICAgIHNoYWRvd1R5cGUgPSBsaWdodC5fc2hhZG93VHlwZTtcbiAgICAgICAgICBzbW9kZSA9IHNoYWRvd1R5cGUgKyB0eXBlICogbnVtU2hhZG93TW9kZXM7XG4gICAgICAgICAgdGhpcy5zb3J0RHJhd0NhbGxzKGN1bGxlZCwgdGhpcy5kZXB0aFNvcnRDb21wYXJlLCBwYy5TT1JUS0VZX0RFUFRIKTtcbiAgICAgICAgICB0aGlzLnByZXBhcmVJbnN0YW5jaW5nKGRldmljZSwgY3VsbGVkLCBwYy5TT1JUS0VZX0RFUFRILCBwYy5TSEFERVJfU0hBRE9XICsgc21vZGUpO1xuICAgICAgICAgIGlmICh0eXBlID09PSBwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwpIHtcbiAgICAgICAgICAgIGVtcHR5QWFiYiA9IHRydWU7XG4gICAgICAgICAgICBmb3IgKGogPSAwO2ogPCBjdWxsZWQubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgICBtZXNoSW5zdGFuY2UgPSBjdWxsZWRbal07XG4gICAgICAgICAgICAgIGRyYXdDYWxsQWFiYiA9IG1lc2hJbnN0YW5jZS5hYWJiO1xuICAgICAgICAgICAgICBpZiAoZW1wdHlBYWJiKSB7XG4gICAgICAgICAgICAgICAgdmlzaWJsZVNjZW5lQWFiYi5jb3B5KGRyYXdDYWxsQWFiYik7XG4gICAgICAgICAgICAgICAgZW1wdHlBYWJiID0gZmFsc2U7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmlzaWJsZVNjZW5lQWFiYi5hZGQoZHJhd0NhbGxBYWJiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHogPSBfZ2V0WkZyb21BQUJCU2ltcGxlKHNoYWRvd0NhbVZpZXcsIHZpc2libGVTY2VuZUFhYmIuZ2V0TWluKCksIHZpc2libGVTY2VuZUFhYmIuZ2V0TWF4KCksIG1pbngsIG1heHgsIG1pbnksIG1heHkpO1xuICAgICAgICAgICAgbWF4eiA9IHoubWF4O1xuICAgICAgICAgICAgaWYgKHoubWluID4gbWlueikge1xuICAgICAgICAgICAgICBtaW56ID0gei5taW47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzaGFkb3dDYW1Ob2RlLnNldFBvc2l0aW9uKGxpZ2h0Tm9kZS5nZXRQb3NpdGlvbigpKTtcbiAgICAgICAgICAgIHNoYWRvd0NhbU5vZGUudHJhbnNsYXRlTG9jYWwoY2VudGVyeCwgY2VudGVyeSwgbWF4eiArIGRpcmVjdGlvbmFsU2hhZG93RXBzaWxvbik7XG4gICAgICAgICAgICBzaGFkb3dDYW0uZmFyQ2xpcCA9IG1heHogLSBtaW56O1xuICAgICAgICAgICAgdGhpcy5zZXRDYW1lcmEoc2hhZG93Q2FtLCB0cnVlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHR5cGUgIT09IHBjLkxJR0hUVFlQRV9QT0lOVCkge1xuICAgICAgICAgICAgc2hhZG93Q2FtVmlldy5zZXRUUlMoc2hhZG93Q2FtTm9kZS5nZXRQb3NpdGlvbigpLCBzaGFkb3dDYW1Ob2RlLmdldFJvdGF0aW9uKCksIHBjLlZlYzMuT05FKS5pbnZlcnQoKTtcbiAgICAgICAgICAgIHNoYWRvd0NhbVZpZXdQcm9qLm11bDIoc2hhZG93Q2FtLmdldFByb2plY3Rpb25NYXRyaXgoKSwgc2hhZG93Q2FtVmlldyk7XG4gICAgICAgICAgICBsaWdodC5fc2hhZG93TWF0cml4Lm11bDIoc2NhbGVTaGlmdCwgc2hhZG93Q2FtVmlld1Byb2opO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb3IgKGogPSAwLCBudW1JbnN0YW5jZXMgPSBjdWxsZWQubGVuZ3RoO2ogPCBudW1JbnN0YW5jZXM7aisrKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2UgPSBjdWxsZWRbal07XG4gICAgICAgICAgICBtZXNoID0gbWVzaEluc3RhbmNlLm1lc2g7XG4gICAgICAgICAgICBtYXRlcmlhbCA9IG1lc2hJbnN0YW5jZS5tYXRlcmlhbDtcbiAgICAgICAgICAgIHRoaXMuc2V0QmFzZUNvbnN0YW50cyhkZXZpY2UsIG1hdGVyaWFsKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U2tpbm5pbmcoZGV2aWNlLCBtZXNoSW5zdGFuY2UsIG1hdGVyaWFsKTtcbiAgICAgICAgICAgIGlmIChtYXRlcmlhbC5jaHVua3MpIHtcbiAgICAgICAgICAgICAgcGFyYW1ldGVycyA9IG1hdGVyaWFsLnBhcmFtZXRlcnM7XG4gICAgICAgICAgICAgIGZvciAocGFyYW1OYW1lIGluIHBhcmFtZXRlcnMpIHtcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXIgPSBwYXJhbWV0ZXJzW3BhcmFtTmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlci5wYXNzRmxhZ3MgJiBwYXNzRmxhZykge1xuICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbWV0ZXIuc2NvcGVJZCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIuc2NvcGVJZCA9IGRldmljZS5zY29wZS5yZXNvbHZlKHBhcmFtTmFtZSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIuc2NvcGVJZC5zZXRWYWx1ZShwYXJhbWV0ZXIuZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHBhcmFtZXRlcnMgPSBtZXNoSW5zdGFuY2UucGFyYW1ldGVycztcbiAgICAgICAgICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1ldGVycykge1xuICAgICAgICAgICAgICAgIHBhcmFtZXRlciA9IHBhcmFtZXRlcnNbcGFyYW1OYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVyLnBhc3NGbGFncyAmIHBhc3NGbGFnKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoIXBhcmFtZXRlci5zY29wZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlci5zY29wZUlkID0gZGV2aWNlLnNjb3BlLnJlc29sdmUocGFyYW1OYW1lKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHBhcmFtZXRlci5zY29wZUlkLnNldFZhbHVlKHBhcmFtZXRlci5kYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNoYWRvd1NoYWRlciA9IG1lc2hJbnN0YW5jZS5fc2hhZGVyW3BjLlNIQURFUl9TSEFET1cgKyBzbW9kZV07XG4gICAgICAgICAgICBpZiAoIXNoYWRvd1NoYWRlcikge1xuICAgICAgICAgICAgICBzaGFkb3dTaGFkZXIgPSB0aGlzLmZpbmRTaGFkb3dTaGFkZXIobWVzaEluc3RhbmNlLCB0eXBlLCBzaGFkb3dUeXBlLCBzY2VuZSk7XG4gICAgICAgICAgICAgIG1lc2hJbnN0YW5jZS5fc2hhZGVyW3BjLlNIQURFUl9TSEFET1cgKyBzbW9kZV0gPSBzaGFkb3dTaGFkZXI7XG4gICAgICAgICAgICAgIG1lc2hJbnN0YW5jZS5fa2V5W3BjLlNPUlRLRVlfREVQVEhdID0gZ2V0RGVwdGhLZXkobWVzaEluc3RhbmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRldmljZS5zZXRTaGFkZXIoc2hhZG93U2hhZGVyKTtcbiAgICAgICAgICAgIHN0eWxlID0gbWVzaEluc3RhbmNlLnJlbmRlclN0eWxlO1xuICAgICAgICAgICAgZGV2aWNlLnNldFZlcnRleEJ1ZmZlcihtZXNoSW5zdGFuY2UubW9ycGhJbnN0YW5jZSAmJiBtZXNoSW5zdGFuY2UubW9ycGhJbnN0YW5jZS5fdmVydGV4QnVmZmVyID8gbWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UuX3ZlcnRleEJ1ZmZlciA6IG1lc2gudmVydGV4QnVmZmVyLCAwKTtcbiAgICAgICAgICAgIGRldmljZS5zZXRJbmRleEJ1ZmZlcihtZXNoLmluZGV4QnVmZmVyW3N0eWxlXSk7XG4gICAgICAgICAgICBqICs9IHRoaXMuZHJhd0luc3RhbmNlKGRldmljZSwgbWVzaEluc3RhbmNlLCBtZXNoLCBzdHlsZSk7XG4gICAgICAgICAgICB0aGlzLl9zaGFkb3dEcmF3Q2FsbHMrKztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpZ2h0Ll9pc1ZzbSkge1xuICAgICAgICAgIHZhciBmaWx0ZXJTaXplID0gbGlnaHQuX3ZzbUJsdXJTaXplO1xuICAgICAgICAgIGlmIChmaWx0ZXJTaXplID4gMSkge1xuICAgICAgICAgICAgdmFyIG9yaWdTaGFkb3dNYXAgPSBzaGFkb3dDYW0ucmVuZGVyVGFyZ2V0O1xuICAgICAgICAgICAgdmFyIHRlbXBSdCA9IGdldFNoYWRvd01hcEZyb21DYWNoZShkZXZpY2UsIGxpZ2h0Ll9zaGFkb3dSZXNvbHV0aW9uLCBsaWdodC5fc2hhZG93VHlwZSwgMSk7XG4gICAgICAgICAgICB2YXIgYmx1ck1vZGUgPSBsaWdodC52c21CbHVyTW9kZTtcbiAgICAgICAgICAgIHZhciBibHVyU2hhZGVyID0gKGxpZ2h0Ll9zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNOCA/IHRoaXMuYmx1clBhY2tlZFZzbVNoYWRlciA6IHRoaXMuYmx1clZzbVNoYWRlcilbYmx1ck1vZGVdW2ZpbHRlclNpemVdO1xuICAgICAgICAgICAgaWYgKCFibHVyU2hhZGVyKSB7XG4gICAgICAgICAgICAgIHRoaXMuYmx1clZzbVdlaWdodHNbZmlsdGVyU2l6ZV0gPSBnYXVzc1dlaWdodHMoZmlsdGVyU2l6ZSk7XG4gICAgICAgICAgICAgIHZhciBjaHVua3MgPSBwYy5zaGFkZXJDaHVua3M7XG4gICAgICAgICAgICAgIChsaWdodC5fc2hhZG93VHlwZSA9PT0gcGMuU0hBRE9XX1ZTTTggPyB0aGlzLmJsdXJQYWNrZWRWc21TaGFkZXIgOiB0aGlzLmJsdXJWc21TaGFkZXIpW2JsdXJNb2RlXVtmaWx0ZXJTaXplXSA9IGJsdXJTaGFkZXIgPSBjaHVua3MuY3JlYXRlU2hhZGVyRnJvbUNvZGUodGhpcy5kZXZpY2UsIGNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCBcIiNkZWZpbmUgU0FNUExFUyBcIiArIGZpbHRlclNpemUgKyBcIlxcblwiICsgKGxpZ2h0Ll9zaGFkb3dUeXBlID09PSBwYy5TSEFET1dfVlNNOCA/IHRoaXMuYmx1clBhY2tlZFZzbVNoYWRlckNvZGUgOiB0aGlzLmJsdXJWc21TaGFkZXJDb2RlKVtibHVyTW9kZV0sIFwiYmx1clZzbVwiICsgYmx1ck1vZGUgKyBcIlwiICsgZmlsdGVyU2l6ZSArIFwiXCIgKyAobGlnaHQuX3NoYWRvd1R5cGUgPT09IHBjLlNIQURPV19WU004KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBibHVyU2Npc3NvclJlY3QueiA9IGxpZ2h0Ll9zaGFkb3dSZXNvbHV0aW9uIC0gMjtcbiAgICAgICAgICAgIGJsdXJTY2lzc29yUmVjdC53ID0gYmx1clNjaXNzb3JSZWN0Lno7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZUlkLnNldFZhbHVlKG9yaWdTaGFkb3dNYXAuY29sb3JCdWZmZXIpO1xuICAgICAgICAgICAgcGl4ZWxPZmZzZXQueCA9IDEuMCAvIGxpZ2h0Ll9zaGFkb3dSZXNvbHV0aW9uO1xuICAgICAgICAgICAgcGl4ZWxPZmZzZXQueSA9IDAuMDtcbiAgICAgICAgICAgIHRoaXMucGl4ZWxPZmZzZXRJZC5zZXRWYWx1ZShwaXhlbE9mZnNldC5kYXRhKTtcbiAgICAgICAgICAgIGlmIChibHVyTW9kZSA9PT0gcGMuQkxVUl9HQVVTU0lBTikge1xuICAgICAgICAgICAgICB0aGlzLndlaWdodElkLnNldFZhbHVlKHRoaXMuYmx1clZzbVdlaWdodHNbZmlsdGVyU2l6ZV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKGRldmljZSwgdGVtcFJ0LCBibHVyU2hhZGVyLCBudWxsLCBibHVyU2Npc3NvclJlY3QpO1xuICAgICAgICAgICAgdGhpcy5zb3VyY2VJZC5zZXRWYWx1ZSh0ZW1wUnQuY29sb3JCdWZmZXIpO1xuICAgICAgICAgICAgcGl4ZWxPZmZzZXQueSA9IHBpeGVsT2Zmc2V0Lng7XG4gICAgICAgICAgICBwaXhlbE9mZnNldC54ID0gMC4wO1xuICAgICAgICAgICAgdGhpcy5waXhlbE9mZnNldElkLnNldFZhbHVlKHBpeGVsT2Zmc2V0LmRhdGEpO1xuICAgICAgICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKGRldmljZSwgb3JpZ1NoYWRvd01hcCwgYmx1clNoYWRlciwgbnVsbCwgYmx1clNjaXNzb3JSZWN0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGRldmljZS53ZWJnbDIpIHtcbiAgICAgIGRldmljZS5zZXREZXB0aEJpYXMoZmFsc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZGV2aWNlLmV4dFN0YW5kYXJkRGVyaXZhdGl2ZXMpIHtcbiAgICAgICAgdGhpcy5wb2x5Z29uT2Zmc2V0WzBdID0gMDtcbiAgICAgICAgdGhpcy5wb2x5Z29uT2Zmc2V0WzFdID0gMDtcbiAgICAgICAgdGhpcy5wb2x5Z29uT2Zmc2V0SWQuc2V0VmFsdWUodGhpcy5wb2x5Z29uT2Zmc2V0KTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGZpbmREZXB0aFNoYWRlcjpmdW5jdGlvbihtZXNoSW5zdGFuY2UpIHtcbiAgICB2YXIgbWF0ZXJpYWwgPSBtZXNoSW5zdGFuY2UubWF0ZXJpYWw7XG4gICAgcmV0dXJuIHRoaXMubGlicmFyeS5nZXRQcm9ncmFtKFwiZGVwdGhcIiwge3NraW46ISFtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlLCBvcGFjaXR5TWFwOiEhbWF0ZXJpYWwub3BhY2l0eU1hcCwgb3BhY2l0eUNoYW5uZWw6bWF0ZXJpYWwub3BhY2l0eU1hcCA/IG1hdGVyaWFsLm9wYWNpdHlNYXBDaGFubmVsIHx8IFwiclwiIDogbnVsbCwgaW5zdGFuY2luZzptZXNoSW5zdGFuY2UuaW5zdGFuY2luZ0RhdGF9KTtcbiAgfSwgZmlsdGVyRGVwdGhNYXBEcmF3Q2FsbHM6ZnVuY3Rpb24oZHJhd0NhbGxzKSB7XG4gICAgZmlsdGVyZWQubGVuZ3RoID0gMDtcbiAgICB2YXIgbWVzaEluc3RhbmNlO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBkcmF3Q2FsbHMubGVuZ3RoO2krKykge1xuICAgICAgbWVzaEluc3RhbmNlID0gZHJhd0NhbGxzW2ldO1xuICAgICAgaWYgKCFtZXNoSW5zdGFuY2UuY29tbWFuZCAmJiBtZXNoSW5zdGFuY2UuZHJhd1RvRGVwdGggJiYgbWVzaEluc3RhbmNlLm1hdGVyaWFsLmJsZW5kVHlwZSA9PT0gcGMuQkxFTkRfTk9ORSkge1xuICAgICAgICBmaWx0ZXJlZC5wdXNoKG1lc2hJbnN0YW5jZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmaWx0ZXJlZDtcbiAgfSwgcmVuZGVyRGVwdGg6ZnVuY3Rpb24oZGV2aWNlLCBjYW1lcmEsIGRyYXdDYWxscykge1xuICAgIGlmIChjYW1lcmEuX3JlbmRlckRlcHRoUmVxdWVzdHMpIHtcbiAgICAgIHZhciBpO1xuICAgICAgdmFyIHNoYWRvd1R5cGU7XG4gICAgICB2YXIgcmVjdCA9IGNhbWVyYS5fcmVjdDtcbiAgICAgIHZhciB0YXJnZXQgPSBjYW1lcmEucmVuZGVyVGFyZ2V0O1xuICAgICAgdmFyIHdpZHRoID0gdGFyZ2V0ID8gdGFyZ2V0LndpZHRoIDogZGV2aWNlLndpZHRoO1xuICAgICAgdmFyIGhlaWdodCA9IHRhcmdldCA/IHRhcmdldC5oZWlnaHQgOiBkZXZpY2UuaGVpZ2h0O1xuICAgICAgd2lkdGggPSBNYXRoLmZsb29yKHJlY3Qud2lkdGggKiB3aWR0aCk7XG4gICAgICBoZWlnaHQgPSBNYXRoLmZsb29yKHJlY3QuaGVpZ2h0ICogaGVpZ2h0KTtcbiAgICAgIHZhciBtZXNoSW5zdGFuY2UsIG1lc2gsIG1hdGVyaWFsLCBzdHlsZSwgZGVwdGhTaGFkZXI7XG4gICAgICB2YXIgdnJEaXNwbGF5ID0gY2FtZXJhLnZyRGlzcGxheTtcbiAgICAgIHZhciBoYWxmV2lkdGggPSBkZXZpY2Uud2lkdGggKiAwLjU7XG4gICAgICBkcmF3Q2FsbHMgPSB0aGlzLmZpbHRlckRlcHRoTWFwRHJhd0NhbGxzKGRyYXdDYWxscyk7XG4gICAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgICAgdGhpcy5zb3J0RHJhd0NhbGxzKGRyYXdDYWxscywgdGhpcy5kZXB0aFNvcnRDb21wYXJlLCBwYy5TT1JUS0VZX0RFUFRIKTtcbiAgICAgIHRoaXMucHJlcGFyZUluc3RhbmNpbmcoZGV2aWNlLCBkcmF3Q2FsbHMsIHBjLlNPUlRLRVlfREVQVEgsIHBjLlNIQURFUl9ERVBUSCk7XG4gICAgICBpZiAoY2FtZXJhLl9kZXB0aFRhcmdldCAmJiAoY2FtZXJhLl9kZXB0aFRhcmdldC53aWR0aCAhPT0gd2lkdGggfHwgY2FtZXJhLl9kZXB0aFRhcmdldC5oZWlnaHQgIT09IGhlaWdodCkpIHtcbiAgICAgICAgY2FtZXJhLl9kZXB0aFRhcmdldC5kZXN0cm95KCk7XG4gICAgICAgIGNhbWVyYS5fZGVwdGhUYXJnZXQgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKCFjYW1lcmEuX2RlcHRoVGFyZ2V0KSB7XG4gICAgICAgIHZhciBjb2xvckJ1ZmZlciA9IG5ldyBwYy5UZXh0dXJlKGRldmljZSwge2Zvcm1hdDpwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgd2lkdGg6d2lkdGgsIGhlaWdodDpoZWlnaHR9KTtcbiAgICAgICAgY29sb3JCdWZmZXIubWluRmlsdGVyID0gcGMuRklMVEVSX05FQVJFU1Q7XG4gICAgICAgIGNvbG9yQnVmZmVyLm1hZ0ZpbHRlciA9IHBjLkZJTFRFUl9ORUFSRVNUO1xuICAgICAgICBjb2xvckJ1ZmZlci5hZGRyZXNzVSA9IHBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRTtcbiAgICAgICAgY29sb3JCdWZmZXIuYWRkcmVzc1YgPSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0U7XG4gICAgICAgIGNhbWVyYS5fZGVwdGhUYXJnZXQgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGRldmljZSwgY29sb3JCdWZmZXIsIHtkZXB0aDp0cnVlLCBzdGVuY2lsOmRldmljZS5zdXBwb3J0c1N0ZW5jaWx9KTtcbiAgICAgIH1cbiAgICAgIGRldmljZS5zZXRCbGVuZGluZyhmYWxzZSk7XG4gICAgICBkZXZpY2Uuc2V0Q29sb3JXcml0ZSh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTtcbiAgICAgIGRldmljZS5zZXREZXB0aFdyaXRlKHRydWUpO1xuICAgICAgZGV2aWNlLnNldERlcHRoVGVzdCh0cnVlKTtcbiAgICAgIHZhciBvbGRUYXJnZXQgPSBjYW1lcmEucmVuZGVyVGFyZ2V0O1xuICAgICAgdmFyIG9sZENsZWFyID0gY2FtZXJhLl9jbGVhck9wdGlvbnM7XG4gICAgICBjYW1lcmEucmVuZGVyVGFyZ2V0ID0gY2FtZXJhLl9kZXB0aFRhcmdldDtcbiAgICAgIGNhbWVyYS5fY2xlYXJPcHRpb25zID0gcmdiYURlcHRoQ2xlYXJPcHRpb25zO1xuICAgICAgdGhpcy5zZXRDYW1lcmEoY2FtZXJhKTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxsc0NvdW50O2krKykge1xuICAgICAgICBtZXNoSW5zdGFuY2UgPSBkcmF3Q2FsbHNbaV07XG4gICAgICAgIG1lc2ggPSBtZXNoSW5zdGFuY2UubWVzaDtcbiAgICAgICAgbWF0ZXJpYWwgPSBtZXNoSW5zdGFuY2UubWF0ZXJpYWw7XG4gICAgICAgIGlmIChjYW1lcmEuX2N1bGxGYWNlcykge1xuICAgICAgICAgIGlmIChjYW1lcmEuX2ZsaXBGYWNlcykge1xuICAgICAgICAgICAgZGV2aWNlLnNldEN1bGxNb2RlKG1hdGVyaWFsLmN1bGwgPiAwID8gbWF0ZXJpYWwuY3VsbCA9PT0gcGMuQ1VMTEZBQ0VfRlJPTlQgPyBwYy5DVUxMRkFDRV9CQUNLIDogcGMuQ1VMTEZBQ0VfRlJPTlQgOiAwKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGV2aWNlLnNldEN1bGxNb2RlKG1hdGVyaWFsLmN1bGwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUocGMuQ1VMTEZBQ0VfTk9ORSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGVyaWFsLm9wYWNpdHlNYXApIHtcbiAgICAgICAgICB0aGlzLm9wYWNpdHlNYXBJZC5zZXRWYWx1ZShtYXRlcmlhbC5vcGFjaXR5TWFwKTtcbiAgICAgICAgICB0aGlzLmFscGhhVGVzdElkLnNldFZhbHVlKG1hdGVyaWFsLmFscGhhVGVzdCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTa2lubmluZyhkZXZpY2UsIG1lc2hJbnN0YW5jZSwgbWF0ZXJpYWwpO1xuICAgICAgICBkZXB0aFNoYWRlciA9IG1lc2hJbnN0YW5jZS5fc2hhZGVyW3BjLlNIQURFUl9ERVBUSF07XG4gICAgICAgIGlmICghZGVwdGhTaGFkZXIpIHtcbiAgICAgICAgICBkZXB0aFNoYWRlciA9IHRoaXMuZmluZERlcHRoU2hhZGVyKG1lc2hJbnN0YW5jZSk7XG4gICAgICAgICAgbWVzaEluc3RhbmNlLl9zaGFkZXJbcGMuU0hBREVSX0RFUFRIXSA9IGRlcHRoU2hhZGVyO1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5fa2V5W3BjLlNPUlRLRVlfREVQVEhdID0gZ2V0RGVwdGhLZXkobWVzaEluc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgICBkZXZpY2Uuc2V0U2hhZGVyKGRlcHRoU2hhZGVyKTtcbiAgICAgICAgc3R5bGUgPSBtZXNoSW5zdGFuY2UucmVuZGVyU3R5bGU7XG4gICAgICAgIGRldmljZS5zZXRWZXJ0ZXhCdWZmZXIobWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UgJiYgbWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UuX3ZlcnRleEJ1ZmZlciA/IG1lc2hJbnN0YW5jZS5tb3JwaEluc3RhbmNlLl92ZXJ0ZXhCdWZmZXIgOiBtZXNoLnZlcnRleEJ1ZmZlciwgMCk7XG4gICAgICAgIGRldmljZS5zZXRJbmRleEJ1ZmZlcihtZXNoLmluZGV4QnVmZmVyW3N0eWxlXSk7XG4gICAgICAgIGlmICh2ckRpc3BsYXkgJiYgdnJEaXNwbGF5LnByZXNlbnRpbmcpIHtcbiAgICAgICAgICBkZXZpY2Uuc2V0Vmlld3BvcnQoMCwgMCwgaGFsZldpZHRoLCBkZXZpY2UuaGVpZ2h0KTtcbiAgICAgICAgICB0aGlzLnZpZXdQcm9qSWQuc2V0VmFsdWUodmlld1Byb2pNYXRMLmRhdGEpO1xuICAgICAgICAgIHRoaXMudmlld1Bvc0lkLnNldFZhbHVlKHZpZXdQb3NMLmRhdGEpO1xuICAgICAgICAgIGkgKz0gdGhpcy5kcmF3SW5zdGFuY2UoZGV2aWNlLCBtZXNoSW5zdGFuY2UsIG1lc2gsIHN0eWxlLCB0cnVlKTtcbiAgICAgICAgICB0aGlzLl9kZXB0aERyYXdDYWxscysrO1xuICAgICAgICAgIGRldmljZS5zZXRWaWV3cG9ydChoYWxmV2lkdGgsIDAsIGhhbGZXaWR0aCwgZGV2aWNlLmhlaWdodCk7XG4gICAgICAgICAgdGhpcy52aWV3UHJvaklkLnNldFZhbHVlKHZpZXdQcm9qTWF0Ui5kYXRhKTtcbiAgICAgICAgICB0aGlzLnZpZXdQb3NJZC5zZXRWYWx1ZSh2aWV3UG9zUi5kYXRhKTtcbiAgICAgICAgICBpICs9IHRoaXMuZHJhd0luc3RhbmNlMihkZXZpY2UsIG1lc2hJbnN0YW5jZSwgbWVzaCwgc3R5bGUpO1xuICAgICAgICAgIHRoaXMuX2RlcHRoRHJhd0NhbGxzKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaSArPSB0aGlzLmRyYXdJbnN0YW5jZShkZXZpY2UsIG1lc2hJbnN0YW5jZSwgbWVzaCwgc3R5bGUpO1xuICAgICAgICAgIHRoaXMuX2RlcHRoRHJhd0NhbGxzKys7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNhbWVyYS5yZW5kZXJUYXJnZXQgPSBvbGRUYXJnZXQ7XG4gICAgICBjYW1lcmEuX2NsZWFyT3B0aW9ucyA9IG9sZENsZWFyO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY2FtZXJhLl9kZXB0aFRhcmdldCkge1xuICAgICAgICBjYW1lcmEuX2RlcHRoVGFyZ2V0LmRlc3Ryb3koKTtcbiAgICAgICAgY2FtZXJhLl9kZXB0aFRhcmdldCA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuICB9LCByZW5kZXJGb3J3YXJkOmZ1bmN0aW9uKGRldmljZSwgY2FtZXJhLCBkcmF3Q2FsbHMsIHNjZW5lLCBwYXNzKSB7XG4gICAgdmFyIHBhc3NGbGFnID0gMSA8PCBwYXNzO1xuICAgIHZhciBkcmF3Q2FsbHNDb3VudCA9IGRyYXdDYWxscy5sZW5ndGg7XG4gICAgdmFyIHZyRGlzcGxheSA9IGNhbWVyYS52ckRpc3BsYXk7XG4gICAgdGhpcy5zb3J0RHJhd0NhbGxzKGRyYXdDYWxscywgdGhpcy5mcm9udFRvQmFjayA/IHRoaXMuc29ydENvbXBhcmUgOiB0aGlzLnNvcnRDb21wYXJlTWVzaCwgcGMuU09SVEtFWV9GT1JXQVJEKTtcbiAgICB0aGlzLnByZXBhcmVJbnN0YW5jaW5nKGRldmljZSwgZHJhd0NhbGxzLCBwYy5TT1JUS0VZX0ZPUldBUkQsIHBhc3MpO1xuICAgIHZhciBpLCBkcmF3Q2FsbCwgbWVzaCwgbWF0ZXJpYWwsIG9iakRlZnMsIHZhcmlhbnRLZXksIGxpZ2h0TWFzaywgc3R5bGUsIHVzZWREaXJMaWdodHM7XG4gICAgdmFyIHByZXZNZXNoSW5zdGFuY2UgPSBudWxsLCBwcmV2TWF0ZXJpYWwgPSBudWxsLCBwcmV2T2JqRGVmcywgcHJldkxpZ2h0TWFzaywgcHJldlN0YXRpYztcbiAgICB2YXIgcGFyYW1OYW1lLCBwYXJhbWV0ZXIsIHBhcmFtZXRlcnM7XG4gICAgdmFyIHN0ZW5jaWxGcm9udCwgc3RlbmNpbEJhY2s7XG4gICAgZGV2aWNlLnNldENvbG9yV3JpdGUodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgdGhpcy5zZXRDYW1lcmEoY2FtZXJhKTtcbiAgICB0aGlzLmRpc3BhdGNoR2xvYmFsTGlnaHRzKHNjZW5lKTtcbiAgICBpZiAoc2NlbmUuZm9nICE9PSBwYy5GT0dfTk9ORSkge1xuICAgICAgdGhpcy5mb2dDb2xvclswXSA9IHNjZW5lLmZvZ0NvbG9yLmRhdGFbMF07XG4gICAgICB0aGlzLmZvZ0NvbG9yWzFdID0gc2NlbmUuZm9nQ29sb3IuZGF0YVsxXTtcbiAgICAgIHRoaXMuZm9nQ29sb3JbMl0gPSBzY2VuZS5mb2dDb2xvci5kYXRhWzJdO1xuICAgICAgaWYgKHNjZW5lLmdhbW1hQ29ycmVjdGlvbikge1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCAzO2krKykge1xuICAgICAgICAgIHRoaXMuZm9nQ29sb3JbaV0gPSBNYXRoLnBvdyh0aGlzLmZvZ0NvbG9yW2ldLCAyLjIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmZvZ0NvbG9ySWQuc2V0VmFsdWUodGhpcy5mb2dDb2xvcik7XG4gICAgICBpZiAoc2NlbmUuZm9nID09PSBwYy5GT0dfTElORUFSKSB7XG4gICAgICAgIHRoaXMuZm9nU3RhcnRJZC5zZXRWYWx1ZShzY2VuZS5mb2dTdGFydCk7XG4gICAgICAgIHRoaXMuZm9nRW5kSWQuc2V0VmFsdWUoc2NlbmUuZm9nRW5kKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZm9nRGVuc2l0eUlkLnNldFZhbHVlKHNjZW5lLmZvZ0RlbnNpdHkpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9zY3JlZW5TaXplLnggPSBkZXZpY2Uud2lkdGg7XG4gICAgdGhpcy5fc2NyZWVuU2l6ZS55ID0gZGV2aWNlLmhlaWdodDtcbiAgICB0aGlzLl9zY3JlZW5TaXplLnogPSAxLjAgLyBkZXZpY2Uud2lkdGg7XG4gICAgdGhpcy5fc2NyZWVuU2l6ZS53ID0gMS4wIC8gZGV2aWNlLmhlaWdodDtcbiAgICB0aGlzLnNjcmVlblNpemVJZC5zZXRWYWx1ZSh0aGlzLl9zY3JlZW5TaXplLmRhdGEpO1xuICAgIHZhciBoYWxmV2lkdGggPSBkZXZpY2Uud2lkdGggKiAwLjU7XG4gICAgaWYgKGNhbWVyYS5fZGVwdGhUYXJnZXQpIHtcbiAgICAgIHRoaXMuZGVwdGhNYXBJZC5zZXRWYWx1ZShjYW1lcmEuX2RlcHRoVGFyZ2V0LmNvbG9yQnVmZmVyKTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgZHJhd0NhbGxzQ291bnQ7aSsrKSB7XG4gICAgICBkcmF3Q2FsbCA9IGRyYXdDYWxsc1tpXTtcbiAgICAgIGlmIChkcmF3Q2FsbC5jb21tYW5kKSB7XG4gICAgICAgIGRyYXdDYWxsLmNvbW1hbmQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1lc2ggPSBkcmF3Q2FsbC5tZXNoO1xuICAgICAgICBtYXRlcmlhbCA9IGRyYXdDYWxsLm1hdGVyaWFsO1xuICAgICAgICBvYmpEZWZzID0gZHJhd0NhbGwuX3NoYWRlckRlZnM7XG4gICAgICAgIGxpZ2h0TWFzayA9IGRyYXdDYWxsLm1hc2s7XG4gICAgICAgIHRoaXMuc2V0U2tpbm5pbmcoZGV2aWNlLCBkcmF3Q2FsbCwgbWF0ZXJpYWwpO1xuICAgICAgICBpZiAobWF0ZXJpYWwgJiYgbWF0ZXJpYWwgPT09IHByZXZNYXRlcmlhbCAmJiBvYmpEZWZzICE9PSBwcmV2T2JqRGVmcykge1xuICAgICAgICAgIHByZXZNYXRlcmlhbCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRyYXdDYWxsLmlzU3RhdGljIHx8IHByZXZTdGF0aWMpIHtcbiAgICAgICAgICBwcmV2TWF0ZXJpYWwgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXRlcmlhbCAhPT0gcHJldk1hdGVyaWFsKSB7XG4gICAgICAgICAgdGhpcy5fbWF0ZXJpYWxTd2l0Y2hlcysrO1xuICAgICAgICAgIGlmICghZHJhd0NhbGwuX3NoYWRlcltwYXNzXSB8fCBkcmF3Q2FsbC5fc2hhZGVyRGVmcyAhPT0gb2JqRGVmcykge1xuICAgICAgICAgICAgaWYgKCFkcmF3Q2FsbC5pc1N0YXRpYykge1xuICAgICAgICAgICAgICB2YXJpYW50S2V5ID0gcGFzcyArIFwiX1wiICsgb2JqRGVmcztcbiAgICAgICAgICAgICAgZHJhd0NhbGwuX3NoYWRlcltwYXNzXSA9IG1hdGVyaWFsLnZhcmlhbnRzW3ZhcmlhbnRLZXldO1xuICAgICAgICAgICAgICBpZiAoIWRyYXdDYWxsLl9zaGFkZXJbcGFzc10pIHtcbiAgICAgICAgICAgICAgICBtYXRlcmlhbC51cGRhdGVTaGFkZXIoZGV2aWNlLCBzY2VuZSwgb2JqRGVmcywgbnVsbCwgcGFzcyk7XG4gICAgICAgICAgICAgICAgZHJhd0NhbGwuX3NoYWRlcltwYXNzXSA9IG1hdGVyaWFsLnZhcmlhbnRzW3ZhcmlhbnRLZXldID0gbWF0ZXJpYWwuc2hhZGVyO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBtYXRlcmlhbC51cGRhdGVTaGFkZXIoZGV2aWNlLCBzY2VuZSwgb2JqRGVmcywgZHJhd0NhbGwuX3N0YXRpY0xpZ2h0TGlzdCwgcGFzcyk7XG4gICAgICAgICAgICAgIGRyYXdDYWxsLl9zaGFkZXJbcGFzc10gPSBtYXRlcmlhbC5zaGFkZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkcmF3Q2FsbC5fc2hhZGVyRGVmcyA9IG9iakRlZnM7XG4gICAgICAgICAgfVxuICAgICAgICAgIGRldmljZS5zZXRTaGFkZXIoZHJhd0NhbGwuX3NoYWRlcltwYXNzXSk7XG4gICAgICAgICAgcGFyYW1ldGVycyA9IG1hdGVyaWFsLnBhcmFtZXRlcnM7XG4gICAgICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1ldGVycykge1xuICAgICAgICAgICAgcGFyYW1ldGVyID0gcGFyYW1ldGVyc1twYXJhbU5hbWVdO1xuICAgICAgICAgICAgaWYgKHBhcmFtZXRlci5wYXNzRmxhZ3MgJiBwYXNzRmxhZykge1xuICAgICAgICAgICAgICBpZiAoIXBhcmFtZXRlci5zY29wZUlkKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyLnNjb3BlSWQgPSBkZXZpY2Uuc2NvcGUucmVzb2x2ZShwYXJhbU5hbWUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHBhcmFtZXRlci5zY29wZUlkLnNldFZhbHVlKHBhcmFtZXRlci5kYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFwcmV2TWF0ZXJpYWwgfHwgbGlnaHRNYXNrICE9PSBwcmV2TGlnaHRNYXNrKSB7XG4gICAgICAgICAgICB1c2VkRGlyTGlnaHRzID0gdGhpcy5kaXNwYXRjaERpcmVjdExpZ2h0cyhzY2VuZSwgbGlnaHRNYXNrKTtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hMb2NhbExpZ2h0cyhzY2VuZSwgbGlnaHRNYXNrLCB1c2VkRGlyTGlnaHRzLCBkcmF3Q2FsbC5fc3RhdGljTGlnaHRMaXN0KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5hbHBoYVRlc3RJZC5zZXRWYWx1ZShtYXRlcmlhbC5hbHBoYVRlc3QpO1xuICAgICAgICAgIGRldmljZS5zZXRCbGVuZGluZyhtYXRlcmlhbC5ibGVuZCk7XG4gICAgICAgICAgaWYgKG1hdGVyaWFsLmJsZW5kKSB7XG4gICAgICAgICAgICBpZiAobWF0ZXJpYWwuc2VwYXJhdGVBbHBoYUJsZW5kKSB7XG4gICAgICAgICAgICAgIGRldmljZS5zZXRCbGVuZEZ1bmN0aW9uU2VwYXJhdGUobWF0ZXJpYWwuYmxlbmRTcmMsIG1hdGVyaWFsLmJsZW5kRHN0LCBtYXRlcmlhbC5ibGVuZFNyY0FscGhhLCBtYXRlcmlhbC5ibGVuZERzdEFscGhhKTtcbiAgICAgICAgICAgICAgZGV2aWNlLnNldEJsZW5kRXF1YXRpb25TZXBhcmF0ZShtYXRlcmlhbC5ibGVuZEVxdWF0aW9uLCBtYXRlcmlhbC5ibGVuZEFscGhhRXF1YXRpb24pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZGV2aWNlLnNldEJsZW5kRnVuY3Rpb24obWF0ZXJpYWwuYmxlbmRTcmMsIG1hdGVyaWFsLmJsZW5kRHN0KTtcbiAgICAgICAgICAgICAgZGV2aWNlLnNldEJsZW5kRXF1YXRpb24obWF0ZXJpYWwuYmxlbmRFcXVhdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGRldmljZS5zZXRDb2xvcldyaXRlKG1hdGVyaWFsLnJlZFdyaXRlLCBtYXRlcmlhbC5ncmVlbldyaXRlLCBtYXRlcmlhbC5ibHVlV3JpdGUsIG1hdGVyaWFsLmFscGhhV3JpdGUpO1xuICAgICAgICAgIGlmIChjYW1lcmEuX2N1bGxGYWNlcykge1xuICAgICAgICAgICAgaWYgKGNhbWVyYS5fZmxpcEZhY2VzKSB7XG4gICAgICAgICAgICAgIGRldmljZS5zZXRDdWxsTW9kZShtYXRlcmlhbC5jdWxsID4gMCA/IG1hdGVyaWFsLmN1bGwgPT09IHBjLkNVTExGQUNFX0ZST05UID8gcGMuQ1VMTEZBQ0VfQkFDSyA6IHBjLkNVTExGQUNFX0ZST05UIDogMCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUobWF0ZXJpYWwuY3VsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRldmljZS5zZXRDdWxsTW9kZShwYy5DVUxMRkFDRV9OT05FKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGV2aWNlLnNldERlcHRoV3JpdGUobWF0ZXJpYWwuZGVwdGhXcml0ZSk7XG4gICAgICAgICAgZGV2aWNlLnNldERlcHRoVGVzdChtYXRlcmlhbC5kZXB0aFRlc3QpO1xuICAgICAgICAgIGRldmljZS5zZXRBbHBoYVRvQ292ZXJhZ2UobWF0ZXJpYWwuYWxwaGFUb0NvdmVyYWdlKTtcbiAgICAgICAgICBzdGVuY2lsRnJvbnQgPSBtYXRlcmlhbC5zdGVuY2lsRnJvbnQ7XG4gICAgICAgICAgc3RlbmNpbEJhY2sgPSBtYXRlcmlhbC5zdGVuY2lsQmFjaztcbiAgICAgICAgICBpZiAoc3RlbmNpbEZyb250IHx8IHN0ZW5jaWxCYWNrKSB7XG4gICAgICAgICAgICBkZXZpY2Uuc2V0U3RlbmNpbFRlc3QodHJ1ZSk7XG4gICAgICAgICAgICBpZiAoc3RlbmNpbEZyb250ID09PSBzdGVuY2lsQmFjaykge1xuICAgICAgICAgICAgICBkZXZpY2Uuc2V0U3RlbmNpbEZ1bmMoc3RlbmNpbEZyb250LmZ1bmMsIHN0ZW5jaWxGcm9udC5yZWYsIHN0ZW5jaWxGcm9udC5yZWFkTWFzayk7XG4gICAgICAgICAgICAgIGRldmljZS5zZXRTdGVuY2lsT3BlcmF0aW9uKHN0ZW5jaWxGcm9udC5mYWlsLCBzdGVuY2lsRnJvbnQuemZhaWwsIHN0ZW5jaWxGcm9udC56cGFzcywgc3RlbmNpbEZyb250LndyaXRlTWFzayk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAoc3RlbmNpbEZyb250KSB7XG4gICAgICAgICAgICAgICAgZGV2aWNlLnNldFN0ZW5jaWxGdW5jRnJvbnQoc3RlbmNpbEZyb250LmZ1bmMsIHN0ZW5jaWxGcm9udC5yZWYsIHN0ZW5jaWxGcm9udC5yZWFkTWFzayk7XG4gICAgICAgICAgICAgICAgZGV2aWNlLnNldFN0ZW5jaWxPcGVyYXRpb25Gcm9udChzdGVuY2lsRnJvbnQuZmFpbCwgc3RlbmNpbEZyb250LnpmYWlsLCBzdGVuY2lsRnJvbnQuenBhc3MsIHN0ZW5jaWxGcm9udC53cml0ZU1hc2spO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRldmljZS5zZXRTdGVuY2lsRnVuY0Zyb250KHBjLkZVTkNfQUxXQVlTLCAwLCAyNTUpO1xuICAgICAgICAgICAgICAgIGRldmljZS5zZXRTdGVuY2lsT3BlcmF0aW9uRnJvbnQocGMuU1RFTkNJTE9QX0tFRVAsIHBjLlNURU5DSUxPUF9LRUVQLCBwYy5TVEVOQ0lMT1BfS0VFUFAsIDI1NSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHN0ZW5jaWxCYWNrKSB7XG4gICAgICAgICAgICAgICAgZGV2aWNlLnNldFN0ZW5jaWxGdW5jQmFjayhzdGVuY2lsQmFjay5mdW5jLCBzdGVuY2lsQmFjay5yZWYsIHN0ZW5jaWxCYWNrLnJlYWRNYXNrKTtcbiAgICAgICAgICAgICAgICBkZXZpY2Uuc2V0U3RlbmNpbE9wZXJhdGlvbkJhY2soc3RlbmNpbEJhY2suZmFpbCwgc3RlbmNpbEJhY2suemZhaWwsIHN0ZW5jaWxCYWNrLnpwYXNzLCBzdGVuY2lsQmFjay53cml0ZU1hc2spO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRldmljZS5zZXRTdGVuY2lsRnVuY0JhY2socGMuRlVOQ19BTFdBWVMsIDAsIDI1NSk7XG4gICAgICAgICAgICAgICAgZGV2aWNlLnNldFN0ZW5jaWxPcGVyYXRpb25CYWNrKHBjLlNURU5DSUxPUF9LRUVQLCBwYy5TVEVOQ0lMT1BfS0VFUCwgcGMuU1RFTkNJTE9QX0tFRVAsIDI1NSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGV2aWNlLnNldFN0ZW5jaWxUZXN0KGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1ldGVycyA9IGRyYXdDYWxsLnBhcmFtZXRlcnM7XG4gICAgICAgIGZvciAocGFyYW1OYW1lIGluIHBhcmFtZXRlcnMpIHtcbiAgICAgICAgICBwYXJhbWV0ZXIgPSBwYXJhbWV0ZXJzW3BhcmFtTmFtZV07XG4gICAgICAgICAgaWYgKHBhcmFtZXRlci5wYXNzRmxhZ3MgJiBwYXNzRmxhZykge1xuICAgICAgICAgICAgaWYgKCFwYXJhbWV0ZXIuc2NvcGVJZCkge1xuICAgICAgICAgICAgICBwYXJhbWV0ZXIuc2NvcGVJZCA9IGRldmljZS5zY29wZS5yZXNvbHZlKHBhcmFtTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYXJhbWV0ZXIuc2NvcGVJZC5zZXRWYWx1ZShwYXJhbWV0ZXIuZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGRldmljZS5zZXRWZXJ0ZXhCdWZmZXIoZHJhd0NhbGwubW9ycGhJbnN0YW5jZSAmJiBkcmF3Q2FsbC5tb3JwaEluc3RhbmNlLl92ZXJ0ZXhCdWZmZXIgPyBkcmF3Q2FsbC5tb3JwaEluc3RhbmNlLl92ZXJ0ZXhCdWZmZXIgOiBtZXNoLnZlcnRleEJ1ZmZlciwgMCk7XG4gICAgICAgIHN0eWxlID0gZHJhd0NhbGwucmVuZGVyU3R5bGU7XG4gICAgICAgIGRldmljZS5zZXRJbmRleEJ1ZmZlcihtZXNoLmluZGV4QnVmZmVyW3N0eWxlXSk7XG4gICAgICAgIGlmICh2ckRpc3BsYXkgJiYgdnJEaXNwbGF5LnByZXNlbnRpbmcpIHtcbiAgICAgICAgICBkZXZpY2Uuc2V0Vmlld3BvcnQoMCwgMCwgaGFsZldpZHRoLCBkZXZpY2UuaGVpZ2h0KTtcbiAgICAgICAgICB0aGlzLnByb2pJZC5zZXRWYWx1ZShwcm9qTC5kYXRhKTtcbiAgICAgICAgICB0aGlzLnZpZXdJbnZJZC5zZXRWYWx1ZSh2aWV3SW52TC5kYXRhKTtcbiAgICAgICAgICB0aGlzLnZpZXdJZC5zZXRWYWx1ZSh2aWV3TC5kYXRhKTtcbiAgICAgICAgICB0aGlzLnZpZXdJZDMuc2V0VmFsdWUodmlld01hdDNMLmRhdGEpO1xuICAgICAgICAgIHRoaXMudmlld1Byb2pJZC5zZXRWYWx1ZSh2aWV3UHJvak1hdEwuZGF0YSk7XG4gICAgICAgICAgdGhpcy52aWV3UG9zSWQuc2V0VmFsdWUodmlld1Bvc0wuZGF0YSk7XG4gICAgICAgICAgaSArPSB0aGlzLmRyYXdJbnN0YW5jZShkZXZpY2UsIGRyYXdDYWxsLCBtZXNoLCBzdHlsZSwgdHJ1ZSk7XG4gICAgICAgICAgdGhpcy5fZm9yd2FyZERyYXdDYWxscysrO1xuICAgICAgICAgIGRldmljZS5zZXRWaWV3cG9ydChoYWxmV2lkdGgsIDAsIGhhbGZXaWR0aCwgZGV2aWNlLmhlaWdodCk7XG4gICAgICAgICAgdGhpcy5wcm9qSWQuc2V0VmFsdWUocHJvalIuZGF0YSk7XG4gICAgICAgICAgdGhpcy52aWV3SW52SWQuc2V0VmFsdWUodmlld0ludlIuZGF0YSk7XG4gICAgICAgICAgdGhpcy52aWV3SWQuc2V0VmFsdWUodmlld1IuZGF0YSk7XG4gICAgICAgICAgdGhpcy52aWV3SWQzLnNldFZhbHVlKHZpZXdNYXQzUi5kYXRhKTtcbiAgICAgICAgICB0aGlzLnZpZXdQcm9qSWQuc2V0VmFsdWUodmlld1Byb2pNYXRSLmRhdGEpO1xuICAgICAgICAgIHRoaXMudmlld1Bvc0lkLnNldFZhbHVlKHZpZXdQb3NSLmRhdGEpO1xuICAgICAgICAgIGkgKz0gdGhpcy5kcmF3SW5zdGFuY2UyKGRldmljZSwgZHJhd0NhbGwsIG1lc2gsIHN0eWxlKTtcbiAgICAgICAgICB0aGlzLl9mb3J3YXJkRHJhd0NhbGxzKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaSArPSB0aGlzLmRyYXdJbnN0YW5jZShkZXZpY2UsIGRyYXdDYWxsLCBtZXNoLCBzdHlsZSwgdHJ1ZSk7XG4gICAgICAgICAgdGhpcy5fZm9yd2FyZERyYXdDYWxscysrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpIDwgZHJhd0NhbGxzQ291bnQgLSAxICYmIGRyYXdDYWxsc1tpICsgMV0ubWF0ZXJpYWwgPT09IG1hdGVyaWFsKSB7XG4gICAgICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1ldGVycykge1xuICAgICAgICAgICAgcGFyYW1ldGVyID0gbWF0ZXJpYWwucGFyYW1ldGVyc1twYXJhbU5hbWVdO1xuICAgICAgICAgICAgaWYgKHBhcmFtZXRlcikge1xuICAgICAgICAgICAgICBwYXJhbWV0ZXIuc2NvcGVJZC5zZXRWYWx1ZShwYXJhbWV0ZXIuZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHByZXZNYXRlcmlhbCA9IG1hdGVyaWFsO1xuICAgICAgICBwcmV2TWVzaEluc3RhbmNlID0gZHJhd0NhbGw7XG4gICAgICAgIHByZXZPYmpEZWZzID0gb2JqRGVmcztcbiAgICAgICAgcHJldkxpZ2h0TWFzayA9IGxpZ2h0TWFzaztcbiAgICAgICAgcHJldlN0YXRpYyA9IGRyYXdDYWxsLmlzU3RhdGljO1xuICAgICAgfVxuICAgIH1cbiAgICBkZXZpY2Uuc2V0U3RlbmNpbFRlc3QoZmFsc2UpO1xuICAgIGRldmljZS5zZXRBbHBoYVRvQ292ZXJhZ2UoZmFsc2UpO1xuICAgIGRldmljZS51cGRhdGVFbmQoKTtcbiAgfSwgc29ydExpZ2h0czpmdW5jdGlvbihzY2VuZSkge1xuICAgIHZhciBsaWdodDtcbiAgICB2YXIgbGlnaHRzID0gc2NlbmUuX2xpZ2h0cztcbiAgICBzY2VuZS5fZ2xvYmFsTGlnaHRzLmxlbmd0aCA9IDA7XG4gICAgc2NlbmUuX2xvY2FsTGlnaHRzWzBdLmxlbmd0aCA9IDA7XG4gICAgc2NlbmUuX2xvY2FsTGlnaHRzWzFdLmxlbmd0aCA9IDA7XG4gICAgZm9yIChpID0gMDtpIDwgbGlnaHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIGxpZ2h0ID0gbGlnaHRzW2ldO1xuICAgICAgaWYgKGxpZ2h0Ll9lbmFibGVkKSB7XG4gICAgICAgIGlmIChsaWdodC5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgICAgICAgc2NlbmUuX2dsb2JhbExpZ2h0cy5wdXNoKGxpZ2h0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzY2VuZS5fbG9jYWxMaWdodHNbbGlnaHQuX3R5cGUgPT09IHBjLkxJR0hUVFlQRV9QT0lOVCA/IDAgOiAxXS5wdXNoKGxpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGlnaHRzO1xuICB9LCBzZXR1cEluc3RhbmNpbmc6ZnVuY3Rpb24oZGV2aWNlKSB7XG4gICAgaWYgKCFwYy5faW5zdGFuY2VWZXJ0ZXhGb3JtYXQpIHtcbiAgICAgIHZhciBmb3JtYXREZXNjID0gW3tzZW1hbnRpYzpwYy5TRU1BTlRJQ19URVhDT09SRDIsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9LCB7c2VtYW50aWM6cGMuU0VNQU5USUNfVEVYQ09PUkQzLCBjb21wb25lbnRzOjQsIHR5cGU6cGMuVFlQRV9GTE9BVDMyfSwge3NlbWFudGljOnBjLlNFTUFOVElDX1RFWENPT1JENCwgY29tcG9uZW50czo0LCB0eXBlOnBjLlRZUEVfRkxPQVQzMn0sIHtzZW1hbnRpYzpwYy5TRU1BTlRJQ19URVhDT09SRDUsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XTtcbiAgICAgIHBjLl9pbnN0YW5jZVZlcnRleEZvcm1hdCA9IG5ldyBwYy5WZXJ0ZXhGb3JtYXQoZGV2aWNlLCBmb3JtYXREZXNjKTtcbiAgICB9XG4gICAgaWYgKGRldmljZS5lbmFibGVBdXRvSW5zdGFuY2luZykge1xuICAgICAgaWYgKCFwYy5fYXV0b0luc3RhbmNlQnVmZmVyKSB7XG4gICAgICAgIHBjLl9hdXRvSW5zdGFuY2VCdWZmZXIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKGRldmljZSwgcGMuX2luc3RhbmNlVmVydGV4Rm9ybWF0LCBkZXZpY2UuYXV0b0luc3RhbmNpbmdNYXhPYmplY3RzLCBwYy5CVUZGRVJfRFlOQU1JQyk7XG4gICAgICAgIHBjLl9hdXRvSW5zdGFuY2VCdWZmZXJEYXRhID0gbmV3IEZsb2F0MzJBcnJheShwYy5fYXV0b0luc3RhbmNlQnVmZmVyLmxvY2soKSk7XG4gICAgICB9XG4gICAgfVxuICB9LCBwcmVwYXJlU3RhdGljTWVzaGVzOmZ1bmN0aW9uKGRldmljZSwgc2NlbmUpIHtcbiAgICB2YXIgaSwgaiwgaywgdiwgcywgaW5kZXg7XG4gICAgdmFyIGRyYXdDYWxscyA9IHNjZW5lLmRyYXdDYWxscztcbiAgICB2YXIgbGlnaHRzID0gc2NlbmUuX2xpZ2h0cztcbiAgICB2YXIgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgIHZhciBkcmF3Q2FsbCwgbGlnaHQ7XG4gICAgdmFyIG5ld0RyYXdDYWxscyA9IFtdO1xuICAgIGlmICghc2NlbmUuX25lZWRzU3RhdGljUHJlcGFyZSkge1xuICAgICAgdmFyIHByZXZTdGF0aWNTb3VyY2U7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBkcmF3Q2FsbHNDb3VudDtpKyspIHtcbiAgICAgICAgZHJhd0NhbGwgPSBkcmF3Q2FsbHNbaV07XG4gICAgICAgIGlmIChkcmF3Q2FsbC5fc3RhdGljU291cmNlKSB7XG4gICAgICAgICAgaWYgKGRyYXdDYWxsLl9zdGF0aWNTb3VyY2UgIT09IHByZXZTdGF0aWNTb3VyY2UpIHtcbiAgICAgICAgICAgIG5ld0RyYXdDYWxscy5wdXNoKGRyYXdDYWxsLl9zdGF0aWNTb3VyY2UpO1xuICAgICAgICAgICAgcHJldlN0YXRpY1NvdXJjZSA9IGRyYXdDYWxsLl9zdGF0aWNTb3VyY2U7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5ld0RyYXdDYWxscy5wdXNoKGRyYXdDYWxsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZHJhd0NhbGxzID0gbmV3RHJhd0NhbGxzO1xuICAgICAgZHJhd0NhbGxzQ291bnQgPSBkcmF3Q2FsbHMubGVuZ3RoO1xuICAgICAgbmV3RHJhd0NhbGxzID0gW107XG4gICAgfVxuICAgIHZhciBtZXNoO1xuICAgIHZhciBpbmRpY2VzLCB2ZXJ0cywgbnVtVHJpcywgZWxlbXMsIHZlcnRTaXplLCBvZmZzZXRQLCBiYXNlSW5kZXg7XG4gICAgdmFyIF94LCBfeSwgX3o7XG4gICAgdmFyIG1pbngsIG1pbnksIG1pbnosIG1heHgsIG1heHksIG1heHo7XG4gICAgdmFyIG1pbnYsIG1heHY7XG4gICAgdmFyIG1pblZlYyA9IG5ldyBwYy5WZWMzO1xuICAgIHZhciBtYXhWZWMgPSBuZXcgcGMuVmVjMztcbiAgICB2YXIgdHJpQWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICB2YXIgbG9jYWxMaWdodEJvdW5kcyA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICB2YXIgaW52TWF0cml4ID0gbmV3IHBjLk1hdDQ7XG4gICAgdmFyIHRyaUxpZ2h0Q29tYiA9IFtdO1xuICAgIHZhciB0cmlMaWdodENvbWJVc2VkO1xuICAgIHZhciBpbmRleEJ1ZmZlciwgdmVydGV4QnVmZmVyO1xuICAgIHZhciBjb21iSW5kaWNlcywgY29tYkliTmFtZSwgY29tYkliO1xuICAgIHZhciBsaWdodFR5cGVQYXNzO1xuICAgIHZhciBsaWdodEFhYmIgPSBbXTtcbiAgICB2YXIgYWFiYjtcbiAgICB2YXIgdHJpQm91bmRzID0gW107XG4gICAgdmFyIHN0YXRpY0xpZ2h0cyA9IFtdO1xuICAgIHZhciBiaXQ7XG4gICAgdmFyIGxodDtcbiAgICBmb3IgKGkgPSAwO2kgPCBkcmF3Q2FsbHNDb3VudDtpKyspIHtcbiAgICAgIGRyYXdDYWxsID0gZHJhd0NhbGxzW2ldO1xuICAgICAgaWYgKCFkcmF3Q2FsbC5pc1N0YXRpYykge1xuICAgICAgICBuZXdEcmF3Q2FsbHMucHVzaChkcmF3Q2FsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhYWJiID0gZHJhd0NhbGwuYWFiYjtcbiAgICAgICAgc3RhdGljTGlnaHRzLmxlbmd0aCA9IDA7XG4gICAgICAgIGZvciAobGlnaHRUeXBlUGFzcyA9IHBjLkxJR0hUVFlQRV9QT0lOVDtsaWdodFR5cGVQYXNzIDw9IHBjLkxJR0hUVFlQRV9TUE9UO2xpZ2h0VHlwZVBhc3MrKykge1xuICAgICAgICAgIGZvciAoaiA9IDA7aiA8IGxpZ2h0cy5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgICBsaWdodCA9IGxpZ2h0c1tqXTtcbiAgICAgICAgICAgIGlmIChsaWdodC5fdHlwZSAhPT0gbGlnaHRUeXBlUGFzcykge1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChsaWdodC5fZW5hYmxlZCkge1xuICAgICAgICAgICAgICBpZiAobGlnaHQuX21hc2sgJiBkcmF3Q2FsbC5tYXNrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxpZ2h0LmlzU3RhdGljKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoIWxpZ2h0QWFiYltqXSkge1xuICAgICAgICAgICAgICAgICAgICBsaWdodEFhYmJbal0gPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgICAgICAgICAgICAgICAgIGxpZ2h0Ll9ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldEJvdW5kaW5nU3BoZXJlKHRlbXBTcGhlcmUpO1xuICAgICAgICAgICAgICAgICAgICBsaWdodEFhYmJbal0uY2VudGVyLmNvcHkodGVtcFNwaGVyZS5jZW50ZXIpO1xuICAgICAgICAgICAgICAgICAgICBsaWdodEFhYmJbal0uaGFsZkV4dGVudHMueCA9IHRlbXBTcGhlcmUucmFkaXVzO1xuICAgICAgICAgICAgICAgICAgICBsaWdodEFhYmJbal0uaGFsZkV4dGVudHMueSA9IHRlbXBTcGhlcmUucmFkaXVzO1xuICAgICAgICAgICAgICAgICAgICBsaWdodEFhYmJbal0uaGFsZkV4dGVudHMueiA9IHRlbXBTcGhlcmUucmFkaXVzO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKCFsaWdodEFhYmJbal0uaW50ZXJzZWN0cyhhYWJiKSkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHN0YXRpY0xpZ2h0cy5wdXNoKGopO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhdGljTGlnaHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIG5ld0RyYXdDYWxscy5wdXNoKGRyYXdDYWxsKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBtZXNoID0gZHJhd0NhbGwubWVzaDtcbiAgICAgICAgdmVydGV4QnVmZmVyID0gbWVzaC52ZXJ0ZXhCdWZmZXI7XG4gICAgICAgIGluZGV4QnVmZmVyID0gbWVzaC5pbmRleEJ1ZmZlcltkcmF3Q2FsbC5yZW5kZXJTdHlsZV07XG4gICAgICAgIGluZGljZXMgPSBpbmRleEJ1ZmZlci5ieXRlc1BlckluZGV4ID09PSAyID8gbmV3IFVpbnQxNkFycmF5KGluZGV4QnVmZmVyLmxvY2soKSkgOiBuZXcgVWludDMyQXJyYXkoaW5kZXhCdWZmZXIubG9jaygpKTtcbiAgICAgICAgbnVtVHJpcyA9IG1lc2gucHJpbWl0aXZlW2RyYXdDYWxsLnJlbmRlclN0eWxlXS5jb3VudCAvIDM7XG4gICAgICAgIGJhc2VJbmRleCA9IG1lc2gucHJpbWl0aXZlW2RyYXdDYWxsLnJlbmRlclN0eWxlXS5iYXNlO1xuICAgICAgICBlbGVtcyA9IHZlcnRleEJ1ZmZlci5mb3JtYXQuZWxlbWVudHM7XG4gICAgICAgIHZlcnRTaXplID0gdmVydGV4QnVmZmVyLmZvcm1hdC5zaXplIC8gNDtcbiAgICAgICAgdmVydHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleEJ1ZmZlci5zdG9yYWdlKTtcbiAgICAgICAgZm9yIChrID0gMDtrIDwgZWxlbXMubGVuZ3RoO2srKykge1xuICAgICAgICAgIGlmIChlbGVtc1trXS5uYW1lID09PSBwYy5TRU1BTlRJQ19QT1NJVElPTikge1xuICAgICAgICAgICAgb2Zmc2V0UCA9IGVsZW1zW2tdLm9mZnNldCAvIDQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRyaUxpZ2h0Q29tYi5sZW5ndGggPSBudW1UcmlzO1xuICAgICAgICBmb3IgKGsgPSAwO2sgPCBudW1UcmlzO2srKykge1xuICAgICAgICAgIHRyaUxpZ2h0Q29tYltrXSA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgdHJpTGlnaHRDb21iVXNlZCA9IGZhbHNlO1xuICAgICAgICB0cmlCb3VuZHMubGVuZ3RoID0gbnVtVHJpcyAqIDY7XG4gICAgICAgIGZvciAoayA9IDA7ayA8IG51bVRyaXM7aysrKSB7XG4gICAgICAgICAgbWlueCA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgICAgbWlueSA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgICAgbWlueiA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgICAgbWF4eCA9IC1OdW1iZXIuTUFYX1ZBTFVFO1xuICAgICAgICAgIG1heHkgPSAtTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgICBtYXh6ID0gLU51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgICAgZm9yICh2ID0gMDt2IDwgMzt2KyspIHtcbiAgICAgICAgICAgIGluZGV4ID0gaW5kaWNlc1trICogMyArIHYgKyBiYXNlSW5kZXhdO1xuICAgICAgICAgICAgaW5kZXggPSBpbmRleCAqIHZlcnRTaXplICsgb2Zmc2V0UDtcbiAgICAgICAgICAgIF94ID0gdmVydHNbaW5kZXhdO1xuICAgICAgICAgICAgX3kgPSB2ZXJ0c1tpbmRleCArIDFdO1xuICAgICAgICAgICAgX3ogPSB2ZXJ0c1tpbmRleCArIDJdO1xuICAgICAgICAgICAgaWYgKF94IDwgbWlueCkge1xuICAgICAgICAgICAgICBtaW54ID0gX3g7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoX3kgPCBtaW55KSB7XG4gICAgICAgICAgICAgIG1pbnkgPSBfeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChfeiA8IG1pbnopIHtcbiAgICAgICAgICAgICAgbWlueiA9IF96O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKF94ID4gbWF4eCkge1xuICAgICAgICAgICAgICBtYXh4ID0gX3g7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoX3kgPiBtYXh5KSB7XG4gICAgICAgICAgICAgIG1heHkgPSBfeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChfeiA+IG1heHopIHtcbiAgICAgICAgICAgICAgbWF4eiA9IF96O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpbmRleCA9IGsgKiA2O1xuICAgICAgICAgIHRyaUJvdW5kc1tpbmRleF0gPSBtaW54O1xuICAgICAgICAgIHRyaUJvdW5kc1tpbmRleCArIDFdID0gbWlueTtcbiAgICAgICAgICB0cmlCb3VuZHNbaW5kZXggKyAyXSA9IG1pbno7XG4gICAgICAgICAgdHJpQm91bmRzW2luZGV4ICsgM10gPSBtYXh4O1xuICAgICAgICAgIHRyaUJvdW5kc1tpbmRleCArIDRdID0gbWF4eTtcbiAgICAgICAgICB0cmlCb3VuZHNbaW5kZXggKyA1XSA9IG1heHo7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChzID0gMDtzIDwgc3RhdGljTGlnaHRzLmxlbmd0aDtzKyspIHtcbiAgICAgICAgICBqID0gc3RhdGljTGlnaHRzW3NdO1xuICAgICAgICAgIGxpZ2h0ID0gbGlnaHRzW2pdO1xuICAgICAgICAgIGludk1hdHJpeC5jb3B5KGRyYXdDYWxsLm5vZGUud29ybGRUcmFuc2Zvcm0pLmludmVydCgpO1xuICAgICAgICAgIGxvY2FsTGlnaHRCb3VuZHMuc2V0RnJvbVRyYW5zZm9ybWVkQWFiYihsaWdodEFhYmJbal0sIGludk1hdHJpeCk7XG4gICAgICAgICAgbWludiA9IGxvY2FsTGlnaHRCb3VuZHMuZ2V0TWluKCkuZGF0YTtcbiAgICAgICAgICBtYXh2ID0gbG9jYWxMaWdodEJvdW5kcy5nZXRNYXgoKS5kYXRhO1xuICAgICAgICAgIGJpdCA9IDEgPDwgcztcbiAgICAgICAgICBmb3IgKGsgPSAwO2sgPCBudW1UcmlzO2srKykge1xuICAgICAgICAgICAgaW5kZXggPSBrICogNjtcbiAgICAgICAgICAgIGlmICh0cmlCb3VuZHNbaW5kZXhdIDw9IG1heHZbMF0gJiYgdHJpQm91bmRzW2luZGV4ICsgM10gPj0gbWludlswXSAmJiB0cmlCb3VuZHNbaW5kZXggKyAxXSA8PSBtYXh2WzFdICYmIHRyaUJvdW5kc1tpbmRleCArIDRdID49IG1pbnZbMV0gJiYgdHJpQm91bmRzW2luZGV4ICsgMl0gPD0gbWF4dlsyXSAmJiB0cmlCb3VuZHNbaW5kZXggKyA1XSA+PSBtaW52WzJdKSB7XG4gICAgICAgICAgICAgIHRyaUxpZ2h0Q29tYltrXSB8PSBiaXQ7XG4gICAgICAgICAgICAgIHRyaUxpZ2h0Q29tYlVzZWQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodHJpTGlnaHRDb21iVXNlZCkge1xuICAgICAgICAgIGNvbWJJbmRpY2VzID0ge307XG4gICAgICAgICAgZm9yIChrID0gMDtrIDwgbnVtVHJpcztrKyspIHtcbiAgICAgICAgICAgIGogPSBrICogMyArIGJhc2VJbmRleDtcbiAgICAgICAgICAgIGNvbWJJYk5hbWUgPSB0cmlMaWdodENvbWJba107XG4gICAgICAgICAgICBpZiAoIWNvbWJJbmRpY2VzW2NvbWJJYk5hbWVdKSB7XG4gICAgICAgICAgICAgIGNvbWJJbmRpY2VzW2NvbWJJYk5hbWVdID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb21iSWIgPSBjb21iSW5kaWNlc1tjb21iSWJOYW1lXTtcbiAgICAgICAgICAgIGNvbWJJYi5wdXNoKGluZGljZXNbal0pO1xuICAgICAgICAgICAgY29tYkliLnB1c2goaW5kaWNlc1tqICsgMV0pO1xuICAgICAgICAgICAgY29tYkliLnB1c2goaW5kaWNlc1tqICsgMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb3IgKGNvbWJJYk5hbWUgaW4gY29tYkluZGljZXMpIHtcbiAgICAgICAgICAgIGNvbWJJYiA9IGNvbWJJbmRpY2VzW2NvbWJJYk5hbWVdO1xuICAgICAgICAgICAgdmFyIGliID0gbmV3IHBjLkluZGV4QnVmZmVyKGRldmljZSwgaW5kZXhCdWZmZXIuZm9ybWF0LCBjb21iSWIubGVuZ3RoLCBpbmRleEJ1ZmZlci51c2FnZSk7XG4gICAgICAgICAgICB2YXIgaWIyID0gaWIuYnl0ZXNQZXJJbmRleCA9PT0gMiA/IG5ldyBVaW50MTZBcnJheShpYi5sb2NrKCkpIDogbmV3IFVpbnQzMkFycmF5KGliLmxvY2soKSk7XG4gICAgICAgICAgICBpYjIuc2V0KGNvbWJJYik7XG4gICAgICAgICAgICBpYi51bmxvY2soKTtcbiAgICAgICAgICAgIG1pbnggPSBOdW1iZXIuTUFYX1ZBTFVFO1xuICAgICAgICAgICAgbWlueSA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgICAgICAgICBtaW56ID0gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgICAgIG1heHggPSAtTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgICAgIG1heHkgPSAtTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgICAgIG1heHogPSAtTnVtYmVyLk1BWF9WQUxVRTtcbiAgICAgICAgICAgIGZvciAoayA9IDA7ayA8IGNvbWJJYi5sZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIGluZGV4ID0gY29tYkliW2tdO1xuICAgICAgICAgICAgICBfeCA9IHZlcnRzW2luZGV4ICogdmVydFNpemUgKyBvZmZzZXRQXTtcbiAgICAgICAgICAgICAgX3kgPSB2ZXJ0c1tpbmRleCAqIHZlcnRTaXplICsgb2Zmc2V0UCArIDFdO1xuICAgICAgICAgICAgICBfeiA9IHZlcnRzW2luZGV4ICogdmVydFNpemUgKyBvZmZzZXRQICsgMl07XG4gICAgICAgICAgICAgIGlmIChfeCA8IG1pbngpIHtcbiAgICAgICAgICAgICAgICBtaW54ID0gX3g7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKF95IDwgbWlueSkge1xuICAgICAgICAgICAgICAgIG1pbnkgPSBfeTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoX3ogPCBtaW56KSB7XG4gICAgICAgICAgICAgICAgbWlueiA9IF96O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChfeCA+IG1heHgpIHtcbiAgICAgICAgICAgICAgICBtYXh4ID0gX3g7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKF95ID4gbWF4eSkge1xuICAgICAgICAgICAgICAgIG1heHkgPSBfeTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoX3ogPiBtYXh6KSB7XG4gICAgICAgICAgICAgICAgbWF4eiA9IF96O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtaW5WZWMuc2V0KG1pbngsIG1pbnksIG1pbnopO1xuICAgICAgICAgICAgbWF4VmVjLnNldChtYXh4LCBtYXh5LCBtYXh6KTtcbiAgICAgICAgICAgIHZhciBjaHVua0FhYmIgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgICAgICAgICBjaHVua0FhYmIuc2V0TWluTWF4KG1pblZlYywgbWF4VmVjKTtcbiAgICAgICAgICAgIHZhciBtZXNoMiA9IG5ldyBwYy5NZXNoO1xuICAgICAgICAgICAgbWVzaDIudmVydGV4QnVmZmVyID0gdmVydGV4QnVmZmVyO1xuICAgICAgICAgICAgbWVzaDIuaW5kZXhCdWZmZXJbMF0gPSBpYjtcbiAgICAgICAgICAgIG1lc2gyLnByaW1pdGl2ZVswXS50eXBlID0gcGMuUFJJTUlUSVZFX1RSSUFOR0xFUztcbiAgICAgICAgICAgIG1lc2gyLnByaW1pdGl2ZVswXS5iYXNlID0gMDtcbiAgICAgICAgICAgIG1lc2gyLnByaW1pdGl2ZVswXS5jb3VudCA9IGNvbWJJYi5sZW5ndGg7XG4gICAgICAgICAgICBtZXNoMi5wcmltaXRpdmVbMF0uaW5kZXhlZCA9IHRydWU7XG4gICAgICAgICAgICBtZXNoMi5hYWJiID0gY2h1bmtBYWJiO1xuICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IHBjLk1lc2hJbnN0YW5jZShkcmF3Q2FsbC5ub2RlLCBtZXNoMiwgZHJhd0NhbGwubWF0ZXJpYWwpO1xuICAgICAgICAgICAgaW5zdGFuY2UuaXNTdGF0aWMgPSBkcmF3Q2FsbC5pc1N0YXRpYztcbiAgICAgICAgICAgIGluc3RhbmNlLnZpc2libGUgPSBkcmF3Q2FsbC52aXNpYmxlO1xuICAgICAgICAgICAgaW5zdGFuY2UubGF5ZXIgPSBkcmF3Q2FsbC5sYXllcjtcbiAgICAgICAgICAgIGluc3RhbmNlLmNhc3RTaGFkb3cgPSBkcmF3Q2FsbC5jYXN0U2hhZG93O1xuICAgICAgICAgICAgaW5zdGFuY2UuX3JlY2VpdmVTaGFkb3cgPSBkcmF3Q2FsbC5fcmVjZWl2ZVNoYWRvdztcbiAgICAgICAgICAgIGluc3RhbmNlLmRyYXdUb0RlcHRoID0gZHJhd0NhbGwuZHJhd1RvRGVwdGg7XG4gICAgICAgICAgICBpbnN0YW5jZS5jdWxsID0gZHJhd0NhbGwuY3VsbDtcbiAgICAgICAgICAgIGluc3RhbmNlLnBpY2sgPSBkcmF3Q2FsbC5waWNrO1xuICAgICAgICAgICAgaW5zdGFuY2UubWFzayA9IGRyYXdDYWxsLm1hc2s7XG4gICAgICAgICAgICBpbnN0YW5jZS5wYXJhbWV0ZXJzID0gZHJhd0NhbGwucGFyYW1ldGVycztcbiAgICAgICAgICAgIGluc3RhbmNlLl9zaGFkZXJEZWZzID0gZHJhd0NhbGwuX3NoYWRlckRlZnM7XG4gICAgICAgICAgICBpbnN0YW5jZS5fc3RhdGljU291cmNlID0gZHJhd0NhbGw7XG4gICAgICAgICAgICBpZiAoZHJhd0NhbGwuX3N0YXRpY0xpZ2h0TGlzdCkge1xuICAgICAgICAgICAgICBpbnN0YW5jZS5fc3RhdGljTGlnaHRMaXN0ID0gZHJhd0NhbGwuX3N0YXRpY0xpZ2h0TGlzdDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGluc3RhbmNlLl9zdGF0aWNMaWdodExpc3QgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAoayA9IDA7ayA8IHN0YXRpY0xpZ2h0cy5sZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIGJpdCA9IDEgPDwgaztcbiAgICAgICAgICAgICAgaWYgKGNvbWJJYk5hbWUgJiBiaXQpIHtcbiAgICAgICAgICAgICAgICBsaHQgPSBsaWdodHNbc3RhdGljTGlnaHRzW2tdXTtcbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuX3N0YXRpY0xpZ2h0TGlzdC5pbmRleE9mKGxodCkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICBpbnN0YW5jZS5fc3RhdGljTGlnaHRMaXN0LnB1c2gobGh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc3RhbmNlLl9zdGF0aWNMaWdodExpc3Quc29ydCh0aGlzLmxpZ2h0Q29tcGFyZSk7XG4gICAgICAgICAgICBuZXdEcmF3Q2FsbHMucHVzaChpbnN0YW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5ld0RyYXdDYWxscy5wdXNoKGRyYXdDYWxsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBzY2VuZS5kcmF3Q2FsbHMgPSBuZXdEcmF3Q2FsbHM7XG4gIH0sIHJlbmRlcjpmdW5jdGlvbihzY2VuZSwgY2FtZXJhKSB7XG4gICAgdmFyIGRldmljZSA9IHRoaXMuZGV2aWNlO1xuICAgIHNjZW5lLl9hY3RpdmVDYW1lcmEgPSBjYW1lcmE7XG4gICAgaWYgKHNjZW5lLnVwZGF0ZVNoYWRlcnMpIHtcbiAgICAgIHNjZW5lLnVwZGF0ZVNoYWRlcnNGdW5jKGRldmljZSk7XG4gICAgICBzY2VuZS51cGRhdGVTaGFkZXJzID0gZmFsc2U7XG4gICAgfVxuICAgIGlmIChzY2VuZS5fbmVlZHNTdGF0aWNQcmVwYXJlKSB7XG4gICAgICB0aGlzLnByZXBhcmVTdGF0aWNNZXNoZXMoZGV2aWNlLCBzY2VuZSk7XG4gICAgICBzY2VuZS5fbmVlZHNTdGF0aWNQcmVwYXJlID0gZmFsc2U7XG4gICAgfVxuICAgIHZhciB0YXJnZXQgPSBjYW1lcmEucmVuZGVyVGFyZ2V0O1xuICAgIHZhciBpc0hkciA9IGZhbHNlO1xuICAgIHZhciBvbGRFeHBvc3VyZSA9IHNjZW5lLmV4cG9zdXJlO1xuICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmNvbG9yQnVmZmVyKSB7XG4gICAgICB2YXIgZm9ybWF0ID0gdGFyZ2V0LmNvbG9yQnVmZmVyLmZvcm1hdDtcbiAgICAgIGlmIChmb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQjE2RiB8fCBmb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQjMyRiB8fCBmb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkExNkYgfHwgZm9ybWF0ID09PSBwYy5QSVhFTEZPUk1BVF9SR0JBMzJGIHx8IGZvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfMTExMTEwRikge1xuICAgICAgICBpc0hkciA9IHRydWU7XG4gICAgICAgIHNjZW5lLmV4cG9zdXJlID0gMTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGk7XG4gICAgdmFyIGRyYXdDYWxscyA9IHNjZW5lLmRyYXdDYWxscztcbiAgICB2YXIgc2hhZG93Q2FzdGVycyA9IHNjZW5lLnNoYWRvd0Nhc3RlcnM7XG4gICAgdmFyIGxpZ2h0cyA9IHRoaXMuc29ydExpZ2h0cyhzY2VuZSk7XG4gICAgdmFyIGNhbVBvcyA9IGNhbWVyYS5fbm9kZS5nZXRQb3NpdGlvbigpLmRhdGE7XG4gICAgdmFyIGNhbUZ3ZCA9IGNhbWVyYS5fbm9kZS5mb3J3YXJkLmRhdGE7XG4gICAgdGhpcy5zZXR1cEluc3RhbmNpbmcoZGV2aWNlKTtcbiAgICB0aGlzLnVwZGF0ZUNhbWVyYUZydXN0dW0oY2FtZXJhKTtcbiAgICB0aGlzLnVwZGF0ZUNwdVNraW5NYXRyaWNlcyhkcmF3Q2FsbHMpO1xuICAgIHRoaXMudXBkYXRlTW9ycGhlZEJvdW5kcyhkcmF3Q2FsbHMpO1xuICAgIHRoaXMucmVuZGVyU2hhZG93cyhkZXZpY2UsIGNhbWVyYSwgc2hhZG93Q2FzdGVycywgbGlnaHRzLCBzY2VuZSk7XG4gICAgZHJhd0NhbGxzID0gdGhpcy5jdWxsKGNhbWVyYSwgZHJhd0NhbGxzKTtcbiAgICB0aGlzLmNhbGN1bGF0ZVNvcnREaXN0YW5jZXMoZHJhd0NhbGxzLCBjYW1Qb3MsIGNhbUZ3ZCwgdGhpcy5mcm9udFRvQmFjayk7XG4gICAgdGhpcy51cGRhdGVHcHVTa2luTWF0cmljZXMoZHJhd0NhbGxzKTtcbiAgICB0aGlzLnVwZGF0ZU1vcnBoaW5nKGRyYXdDYWxscyk7XG4gICAgZm9yIChpID0gMDtpIDwgc2NlbmUuaW1tZWRpYXRlRHJhd0NhbGxzLmxlbmd0aDtpKyspIHtcbiAgICAgIGRyYXdDYWxscy5wdXNoKHNjZW5lLmltbWVkaWF0ZURyYXdDYWxsc1tpXSk7XG4gICAgfVxuICAgIHRoaXMuX2ltbWVkaWF0ZVJlbmRlcmVkICs9IHNjZW5lLmltbWVkaWF0ZURyYXdDYWxscy5sZW5ndGg7XG4gICAgdGhpcy5yZW5kZXJEZXB0aChkZXZpY2UsIGNhbWVyYSwgZHJhd0NhbGxzKTtcbiAgICB0aGlzLnJlbmRlckZvcndhcmQoZGV2aWNlLCBjYW1lcmEsIGRyYXdDYWxscywgc2NlbmUsIGlzSGRyID8gcGMuU0hBREVSX0ZPUldBUkRIRFIgOiBwYy5TSEFERVJfRk9SV0FSRCk7XG4gICAgZGV2aWNlLnNldENvbG9yV3JpdGUodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgaWYgKHNjZW5lLmltbWVkaWF0ZURyYXdDYWxscy5sZW5ndGggPiAwKSB7XG4gICAgICBzY2VuZS5pbW1lZGlhdGVEcmF3Q2FsbHMgPSBbXTtcbiAgICB9XG4gICAgaWYgKGlzSGRyKSB7XG4gICAgICBzY2VuZS5leHBvc3VyZSA9IG9sZEV4cG9zdXJlO1xuICAgIH1cbiAgICB0aGlzLl9jYW1lcmFzUmVuZGVyZWQrKztcbiAgfX0pO1xuICByZXR1cm4ge0ZvcndhcmRSZW5kZXJlcjpGb3J3YXJkUmVuZGVyZXIsIGdhdXNzV2VpZ2h0czpnYXVzc1dlaWdodHN9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBzY2FsZUNvbXBlbnNhdGVQb3NUcmFuc2Zvcm0gPSBuZXcgcGMuTWF0NDtcbiAgdmFyIHNjYWxlQ29tcGVuc2F0ZVBvcyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgc2NhbGVDb21wZW5zYXRlUm90ID0gbmV3IHBjLlF1YXQ7XG4gIHZhciBzY2FsZUNvbXBlbnNhdGVSb3QyID0gbmV3IHBjLlF1YXQ7XG4gIHZhciBzY2FsZUNvbXBlbnNhdGVTY2FsZSA9IG5ldyBwYy5WZWMzO1xuICB2YXIgc2NhbGVDb21wZW5zYXRlU2NhbGVGb3JQYXJlbnQgPSBuZXcgcGMuVmVjMztcbiAgdmFyIEdyYXBoTm9kZSA9IGZ1bmN0aW9uIEdyYXBoTm9kZShuYW1lKSB7XG4gICAgdGhpcy5uYW1lID0gdHlwZW9mIG5hbWUgPT09IFwic3RyaW5nXCIgPyBuYW1lIDogXCJVbnRpdGxlZFwiO1xuICAgIHRoaXMudGFncyA9IG5ldyBwYy5UYWdzKHRoaXMpO1xuICAgIHRoaXMuX2xhYmVscyA9IHt9O1xuICAgIHRoaXMubG9jYWxQb3NpdGlvbiA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMubG9jYWxSb3RhdGlvbiA9IG5ldyBwYy5RdWF0KDAsIDAsIDAsIDEpO1xuICAgIHRoaXMubG9jYWxTY2FsZSA9IG5ldyBwYy5WZWMzKDEsIDEsIDEpO1xuICAgIHRoaXMubG9jYWxFdWxlckFuZ2xlcyA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMucG9zaXRpb24gPSBuZXcgcGMuVmVjMygwLCAwLCAwKTtcbiAgICB0aGlzLnJvdGF0aW9uID0gbmV3IHBjLlF1YXQoMCwgMCwgMCwgMSk7XG4gICAgdGhpcy5ldWxlckFuZ2xlcyA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMubG9jYWxUcmFuc2Zvcm0gPSBuZXcgcGMuTWF0NDtcbiAgICB0aGlzLl9kaXJ0eUxvY2FsID0gZmFsc2U7XG4gICAgdGhpcy5fYWFiYlZlciA9IDA7XG4gICAgdGhpcy53b3JsZFRyYW5zZm9ybSA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMuX2RpcnR5V29ybGQgPSBmYWxzZTtcbiAgICB0aGlzLm5vcm1hbE1hdHJpeCA9IG5ldyBwYy5NYXQzO1xuICAgIHRoaXMuX2RpcnR5Tm9ybWFsID0gdHJ1ZTtcbiAgICB0aGlzLl9yaWdodCA9IG5ldyBwYy5WZWMzO1xuICAgIHRoaXMuX3VwID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5fZm9yd2FyZCA9IG5ldyBwYy5WZWMzO1xuICAgIHRoaXMuX3BhcmVudCA9IG51bGw7XG4gICAgdGhpcy5fY2hpbGRyZW4gPSBbXTtcbiAgICB0aGlzLl9lbmFibGVkID0gdHJ1ZTtcbiAgICB0aGlzLl9lbmFibGVkSW5IaWVyYXJjaHkgPSBmYWxzZTtcbiAgICB0aGlzLnNjYWxlQ29tcGVuc2F0aW9uID0gZmFsc2U7XG4gIH07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShHcmFwaE5vZGUucHJvdG90eXBlLCBcInJpZ2h0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0V29ybGRUcmFuc2Zvcm0oKS5nZXRYKHRoaXMuX3JpZ2h0KS5ub3JtYWxpemUoKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoR3JhcGhOb2RlLnByb3RvdHlwZSwgXCJ1cFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmdldFdvcmxkVHJhbnNmb3JtKCkuZ2V0WSh0aGlzLl91cCkubm9ybWFsaXplKCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoTm9kZS5wcm90b3R5cGUsIFwiZm9yd2FyZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmdldFdvcmxkVHJhbnNmb3JtKCkuZ2V0Wih0aGlzLl9mb3J3YXJkKS5ub3JtYWxpemUoKS5zY2FsZSgtMSk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoTm9kZS5wcm90b3R5cGUsIFwiZW5hYmxlZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9lbmFibGVkICYmIHRoaXMuX2VuYWJsZWRJbkhpZXJhcmNoeTtcbiAgfSwgc2V0OmZ1bmN0aW9uKGVuYWJsZWQpIHtcbiAgICBpZiAodGhpcy5fZW5hYmxlZCAhPT0gZW5hYmxlZCkge1xuICAgICAgdGhpcy5fZW5hYmxlZCA9IGVuYWJsZWQ7XG4gICAgICBpZiAoIXRoaXMuX3BhcmVudCB8fCB0aGlzLl9wYXJlbnQuZW5hYmxlZCkge1xuICAgICAgICB0aGlzLl9ub3RpZnlIaWVyYXJjaHlTdGF0ZUNoYW5nZWQodGhpcywgZW5hYmxlZCk7XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShHcmFwaE5vZGUucHJvdG90eXBlLCBcInBhcmVudFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9wYXJlbnQ7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdyYXBoTm9kZS5wcm90b3R5cGUsIFwicm9vdFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBwYXJlbnQgPSB0aGlzLl9wYXJlbnQ7XG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB3aGlsZSAocGFyZW50Ll9wYXJlbnQpIHtcbiAgICAgIHBhcmVudCA9IHBhcmVudC5fcGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShHcmFwaE5vZGUucHJvdG90eXBlLCBcImNoaWxkcmVuXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NoaWxkcmVuO1xuICB9fSk7XG4gIHBjLmV4dGVuZChHcmFwaE5vZGUucHJvdG90eXBlLCB7X25vdGlmeUhpZXJhcmNoeVN0YXRlQ2hhbmdlZDpmdW5jdGlvbihub2RlLCBlbmFibGVkKSB7XG4gICAgbm9kZS5fb25IaWVyYXJjaHlTdGF0ZUNoYW5nZWQoZW5hYmxlZCk7XG4gICAgdmFyIGMgPSBub2RlLl9jaGlsZHJlbjtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmIChjW2ldLl9lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX25vdGlmeUhpZXJhcmNoeVN0YXRlQ2hhbmdlZChjW2ldLCBlbmFibGVkKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vbkhpZXJhcmNoeVN0YXRlQ2hhbmdlZDpmdW5jdGlvbihlbmFibGVkKSB7XG4gICAgdGhpcy5fZW5hYmxlZEluSGllcmFyY2h5ID0gZW5hYmxlZDtcbiAgfSwgX2Nsb25lSW50ZXJuYWw6ZnVuY3Rpb24oY2xvbmUpIHtcbiAgICBjbG9uZS5uYW1lID0gdGhpcy5uYW1lO1xuICAgIHZhciB0YWdzID0gdGhpcy50YWdzLl9saXN0O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0YWdzLmxlbmd0aDtpKyspIHtcbiAgICAgIGNsb25lLnRhZ3MuYWRkKHRhZ3NbaV0pO1xuICAgIH1cbiAgICBjbG9uZS5fbGFiZWxzID0gcGMuZXh0ZW5kKHRoaXMuX2xhYmVscywge30pO1xuICAgIGNsb25lLmxvY2FsUG9zaXRpb24uY29weSh0aGlzLmxvY2FsUG9zaXRpb24pO1xuICAgIGNsb25lLmxvY2FsUm90YXRpb24uY29weSh0aGlzLmxvY2FsUm90YXRpb24pO1xuICAgIGNsb25lLmxvY2FsU2NhbGUuY29weSh0aGlzLmxvY2FsU2NhbGUpO1xuICAgIGNsb25lLmxvY2FsRXVsZXJBbmdsZXMuY29weSh0aGlzLmxvY2FsRXVsZXJBbmdsZXMpO1xuICAgIGNsb25lLnBvc2l0aW9uLmNvcHkodGhpcy5wb3NpdGlvbik7XG4gICAgY2xvbmUucm90YXRpb24uY29weSh0aGlzLnJvdGF0aW9uKTtcbiAgICBjbG9uZS5ldWxlckFuZ2xlcy5jb3B5KHRoaXMuZXVsZXJBbmdsZXMpO1xuICAgIGNsb25lLmxvY2FsVHJhbnNmb3JtLmNvcHkodGhpcy5sb2NhbFRyYW5zZm9ybSk7XG4gICAgY2xvbmUuX2RpcnR5TG9jYWwgPSB0aGlzLl9kaXJ0eUxvY2FsO1xuICAgIGNsb25lLndvcmxkVHJhbnNmb3JtLmNvcHkodGhpcy53b3JsZFRyYW5zZm9ybSk7XG4gICAgY2xvbmUuX2RpcnR5V29ybGQgPSB0aGlzLl9kaXJ0eVdvcmxkO1xuICAgIGNsb25lLl9kaXJ0eU5vcm1hbCA9IHRoaXMuX2RpcnR5Tm9ybWFsO1xuICAgIGNsb25lLl9hYWJiVmVyID0gdGhpcy5fYWFiYlZlciArIDE7XG4gICAgY2xvbmUuX2VuYWJsZWQgPSB0aGlzLl9lbmFibGVkO1xuICAgIGNsb25lLnNjYWxlQ29tcGVuc2F0aW9uID0gdGhpcy5zY2FsZUNvbXBlbnNhdGlvbjtcbiAgICBjbG9uZS5fZW5hYmxlZEluSGllcmFyY2h5ID0gZmFsc2U7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5HcmFwaE5vZGU7XG4gICAgdGhpcy5fY2xvbmVJbnRlcm5hbChjbG9uZSk7XG4gICAgcmV0dXJuIGNsb25lO1xuICB9LCBmaW5kOmZ1bmN0aW9uKGF0dHIsIHZhbHVlKSB7XG4gICAgdmFyIHJlc3VsdHMgPSBbXTtcbiAgICB2YXIgbGVuID0gdGhpcy5fY2hpbGRyZW4ubGVuZ3RoO1xuICAgIHZhciBpLCBkZXNjZW5kYW50cztcbiAgICBpZiAoYXR0ciBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICB2YXIgZm4gPSBhdHRyO1xuICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICBpZiAoZm4odGhpcy5fY2hpbGRyZW5baV0pKSB7XG4gICAgICAgICAgcmVzdWx0cy5wdXNoKHRoaXMuX2NoaWxkcmVuW2ldKTtcbiAgICAgICAgfVxuICAgICAgICBkZXNjZW5kYW50cyA9IHRoaXMuX2NoaWxkcmVuW2ldLmZpbmQoZm4pO1xuICAgICAgICBpZiAoZGVzY2VuZGFudHMubGVuZ3RoKSB7XG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KGRlc2NlbmRhbnRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgdGVzdFZhbHVlO1xuICAgICAgaWYgKHRoaXNbYXR0cl0pIHtcbiAgICAgICAgaWYgKHRoaXNbYXR0cl0gaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICAgIHRlc3RWYWx1ZSA9IHRoaXNbYXR0cl0oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0ZXN0VmFsdWUgPSB0aGlzW2F0dHJdO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0ZXN0VmFsdWUgPT09IHZhbHVlKSB7XG4gICAgICAgICAgcmVzdWx0cy5wdXNoKHRoaXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmb3IgKGkgPSAwO2kgPCBsZW47KytpKSB7XG4gICAgICAgIGRlc2NlbmRhbnRzID0gdGhpcy5fY2hpbGRyZW5baV0uZmluZChhdHRyLCB2YWx1ZSk7XG4gICAgICAgIGlmIChkZXNjZW5kYW50cy5sZW5ndGgpIHtcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQoZGVzY2VuZGFudHMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9LCBmaW5kT25lOmZ1bmN0aW9uKGF0dHIsIHZhbHVlKSB7XG4gICAgdmFyIGk7XG4gICAgdmFyIGxlbiA9IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDtcbiAgICB2YXIgcmVzdWx0ID0gbnVsbDtcbiAgICBpZiAoYXR0ciBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICB2YXIgZm4gPSBhdHRyO1xuICAgICAgcmVzdWx0ID0gZm4odGhpcyk7XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICByZXN1bHQgPSB0aGlzLl9jaGlsZHJlbltpXS5maW5kT25lKGZuKTtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbltpXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgdGVzdFZhbHVlO1xuICAgICAgaWYgKHRoaXNbYXR0cl0pIHtcbiAgICAgICAgaWYgKHRoaXNbYXR0cl0gaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICAgIHRlc3RWYWx1ZSA9IHRoaXNbYXR0cl0oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0ZXN0VmFsdWUgPSB0aGlzW2F0dHJdO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0ZXN0VmFsdWUgPT09IHZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAoaSA9IDA7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5fY2hpbGRyZW5baV0uZmluZE9uZShhdHRyLCB2YWx1ZSk7XG4gICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwpIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9LCBmaW5kQnlUYWc6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHRhZ3MgPSB0aGlzLnRhZ3MuX3Byb2Nlc3NBcmd1bWVudHMoYXJndW1lbnRzKTtcbiAgICByZXR1cm4gdGhpcy5fZmluZEJ5VGFnKHRhZ3MpO1xuICB9LCBfZmluZEJ5VGFnOmZ1bmN0aW9uKHRhZ3MpIHtcbiAgICB2YXIgcmVzdWx0ID0gW107XG4gICAgdmFyIGksIGxlbiA9IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDtcbiAgICB2YXIgZGVzY2VuZGFudHM7XG4gICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKHRoaXMuX2NoaWxkcmVuW2ldLnRhZ3MuX2hhcyh0YWdzKSkge1xuICAgICAgICByZXN1bHQucHVzaCh0aGlzLl9jaGlsZHJlbltpXSk7XG4gICAgICB9XG4gICAgICBkZXNjZW5kYW50cyA9IHRoaXMuX2NoaWxkcmVuW2ldLl9maW5kQnlUYWcodGFncyk7XG4gICAgICBpZiAoZGVzY2VuZGFudHMubGVuZ3RoKSB7XG4gICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoZGVzY2VuZGFudHMpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9LCBmaW5kQnlOYW1lOmZ1bmN0aW9uKG5hbWUpIHtcbiAgICBpZiAodGhpcy5uYW1lID09PSBuYW1lKSB7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBmb3VuZCA9IHRoaXMuX2NoaWxkcmVuW2ldLmZpbmRCeU5hbWUobmFtZSk7XG4gICAgICBpZiAoZm91bmQgIT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGZvdW5kO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfSwgZmluZEJ5UGF0aDpmdW5jdGlvbihwYXRoKSB7XG4gICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdChcIi9cIik7XG4gICAgdmFyIGN1cnJlbnRQYXJlbnQgPSB0aGlzO1xuICAgIHZhciByZXN1bHQgPSBudWxsO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbWF4ID0gcGFydHMubGVuZ3RoO2kgPCBpbWF4ICYmIGN1cnJlbnRQYXJlbnQ7aSsrKSB7XG4gICAgICB2YXIgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgcmVzdWx0ID0gbnVsbDtcbiAgICAgIHZhciBjaGlsZHJlbiA9IGN1cnJlbnRQYXJlbnQuX2NoaWxkcmVuO1xuICAgICAgZm9yICh2YXIgaiA9IDAsIGptYXggPSBjaGlsZHJlbi5sZW5ndGg7aiA8IGptYXg7aisrKSB7XG4gICAgICAgIGlmIChjaGlsZHJlbltqXS5uYW1lID09IHBhcnQpIHtcbiAgICAgICAgICByZXN1bHQgPSBjaGlsZHJlbltqXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY3VycmVudFBhcmVudCA9IHJlc3VsdDtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSwgZ2V0UGF0aDpmdW5jdGlvbigpIHtcbiAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50O1xuICAgIGlmIChwYXJlbnQpIHtcbiAgICAgIHZhciBwYXRoID0gdGhpcy5uYW1lO1xuICAgICAgdmFyIGZvcm1hdCA9IFwiezB9L3sxfVwiO1xuICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQuX3BhcmVudCkge1xuICAgICAgICBwYXRoID0gcGMuc3RyaW5nLmZvcm1hdChmb3JtYXQsIHBhcmVudC5uYW1lLCBwYXRoKTtcbiAgICAgICAgcGFyZW50ID0gcGFyZW50Ll9wYXJlbnQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gcGF0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICB9LCBnZXRSb290OmZ1bmN0aW9uKCkge1xuICAgIHZhciBwYXJlbnQgPSB0aGlzLl9wYXJlbnQ7XG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB3aGlsZSAocGFyZW50Ll9wYXJlbnQpIHtcbiAgICAgIHBhcmVudCA9IHBhcmVudC5fcGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xuICB9LCBnZXRQYXJlbnQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3BhcmVudDtcbiAgfSwgaXNEZXNjZW5kYW50T2Y6ZnVuY3Rpb24obm9kZSkge1xuICAgIHZhciBwYXJlbnQgPSB0aGlzLl9wYXJlbnQ7XG4gICAgd2hpbGUgKHBhcmVudCkge1xuICAgICAgaWYgKHBhcmVudCA9PT0gbm9kZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHBhcmVudCA9IHBhcmVudC5fcGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0sIGlzQW5jZXN0b3JPZjpmdW5jdGlvbihub2RlKSB7XG4gICAgcmV0dXJuIG5vZGUuaXNEZXNjZW5kYW50T2YodGhpcyk7XG4gIH0sIGdldENoaWxkcmVuOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbjtcbiAgfSwgZ2V0RXVsZXJBbmdsZXM6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5nZXRXb3JsZFRyYW5zZm9ybSgpLmdldEV1bGVyQW5nbGVzKHRoaXMuZXVsZXJBbmdsZXMpO1xuICAgIHJldHVybiB0aGlzLmV1bGVyQW5nbGVzO1xuICB9LCBnZXRMb2NhbEV1bGVyQW5nbGVzOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMubG9jYWxSb3RhdGlvbi5nZXRFdWxlckFuZ2xlcyh0aGlzLmxvY2FsRXVsZXJBbmdsZXMpO1xuICAgIHJldHVybiB0aGlzLmxvY2FsRXVsZXJBbmdsZXM7XG4gIH0sIGdldExvY2FsUG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubG9jYWxQb3NpdGlvbjtcbiAgfSwgZ2V0TG9jYWxSb3RhdGlvbjpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5sb2NhbFJvdGF0aW9uO1xuICB9LCBnZXRMb2NhbFNjYWxlOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmxvY2FsU2NhbGU7XG4gIH0sIGdldExvY2FsVHJhbnNmb3JtOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLmxvY2FsVHJhbnNmb3JtLnNldFRSUyh0aGlzLmxvY2FsUG9zaXRpb24sIHRoaXMubG9jYWxSb3RhdGlvbiwgdGhpcy5sb2NhbFNjYWxlKTtcbiAgICAgIHRoaXMuX2RpcnR5TG9jYWwgPSBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubG9jYWxUcmFuc2Zvcm07XG4gIH0sIGdldE5hbWU6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubmFtZTtcbiAgfSwgZ2V0UG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5nZXRXb3JsZFRyYW5zZm9ybSgpLmdldFRyYW5zbGF0aW9uKHRoaXMucG9zaXRpb24pO1xuICAgIHJldHVybiB0aGlzLnBvc2l0aW9uO1xuICB9LCBnZXRSb3RhdGlvbjpmdW5jdGlvbigpIHtcbiAgICB0aGlzLnJvdGF0aW9uLnNldEZyb21NYXQ0KHRoaXMuZ2V0V29ybGRUcmFuc2Zvcm0oKSk7XG4gICAgcmV0dXJuIHRoaXMucm90YXRpb247XG4gIH0sIGdldFdvcmxkVHJhbnNmb3JtOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fZGlydHlMb2NhbCAmJiAhdGhpcy5fZGlydHlXb3JsZCkge1xuICAgICAgcmV0dXJuIHRoaXMud29ybGRUcmFuc2Zvcm07XG4gICAgfVxuICAgIGlmICh0aGlzLl9wYXJlbnQpIHtcbiAgICAgIHRoaXMuX3BhcmVudC5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgIH1cbiAgICB0aGlzLl9zeW5jKCk7XG4gICAgcmV0dXJuIHRoaXMud29ybGRUcmFuc2Zvcm07XG4gIH0sIHJlcGFyZW50OmZ1bmN0aW9uKHBhcmVudCwgaW5kZXgpIHtcbiAgICB2YXIgY3VycmVudCA9IHRoaXMuX3BhcmVudDtcbiAgICBpZiAoY3VycmVudCkge1xuICAgICAgY3VycmVudC5yZW1vdmVDaGlsZCh0aGlzKTtcbiAgICB9XG4gICAgaWYgKHBhcmVudCkge1xuICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgcGFyZW50Lmluc2VydENoaWxkKHRoaXMsIGluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcmVudC5hZGRDaGlsZCh0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHNldExvY2FsRXVsZXJBbmdsZXM6ZnVuY3Rpb24oeCwgeSwgeikge1xuICAgIGlmICh4IGluc3RhbmNlb2YgcGMuVmVjMykge1xuICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLnNldEZyb21FdWxlckFuZ2xlcyh4LmRhdGFbMF0sIHguZGF0YVsxXSwgeC5kYXRhWzJdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLnNldEZyb21FdWxlckFuZ2xlcyh4LCB5LCB6KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLl9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgfSwgc2V0TG9jYWxQb3NpdGlvbjpmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgaWYgKHggaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICB0aGlzLmxvY2FsUG9zaXRpb24uY29weSh4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbFBvc2l0aW9uLnNldCh4LCB5LCB6KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLl9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgfSwgc2V0TG9jYWxSb3RhdGlvbjpmdW5jdGlvbih4LCB5LCB6LCB3KSB7XG4gICAgaWYgKHggaW5zdGFuY2VvZiBwYy5RdWF0KSB7XG4gICAgICB0aGlzLmxvY2FsUm90YXRpb24uY29weSh4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLnNldCh4LCB5LCB6LCB3KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLl9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgfSwgc2V0TG9jYWxTY2FsZTpmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgaWYgKHggaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICB0aGlzLmxvY2FsU2NhbGUuY29weSh4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbFNjYWxlLnNldCh4LCB5LCB6KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLl9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgfSwgc2V0TmFtZTpmdW5jdGlvbihuYW1lKSB7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfSwgX2RpcnRpZnk6ZnVuY3Rpb24obG9jYWwpIHtcbiAgICBpZiAoKCFsb2NhbCB8fCBsb2NhbCAmJiB0aGlzLl9kaXJ0eUxvY2FsKSAmJiB0aGlzLl9kaXJ0eVdvcmxkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChsb2NhbCkge1xuICAgICAgdGhpcy5fZGlydHlMb2NhbCA9IHRydWU7XG4gICAgfVxuICAgIGlmICghdGhpcy5fZGlydHlXb3JsZCkge1xuICAgICAgdGhpcy5fZGlydHlXb3JsZCA9IHRydWU7XG4gICAgICB2YXIgaSA9IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDtcbiAgICAgIHdoaWxlIChpLS0pIHtcbiAgICAgICAgaWYgKHRoaXMuX2NoaWxkcmVuW2ldLl9kaXJ0eVdvcmxkKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY2hpbGRyZW5baV0uX2RpcnRpZnkoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fZGlydHlOb3JtYWwgPSB0cnVlO1xuICAgIHRoaXMuX2FhYmJWZXIrKztcbiAgfSwgc2V0UG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBvc2l0aW9uID0gbmV3IHBjLlZlYzM7XG4gICAgdmFyIGludlBhcmVudFd0bSA9IG5ldyBwYy5NYXQ0O1xuICAgIHJldHVybiBmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgICBpZiAoeCBpbnN0YW5jZW9mIHBjLlZlYzMpIHtcbiAgICAgICAgcG9zaXRpb24uY29weSh4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBvc2l0aW9uLnNldCh4LCB5LCB6KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9wYXJlbnQgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5sb2NhbFBvc2l0aW9uLmNvcHkocG9zaXRpb24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW52UGFyZW50V3RtLmNvcHkodGhpcy5fcGFyZW50LmdldFdvcmxkVHJhbnNmb3JtKCkpLmludmVydCgpO1xuICAgICAgICBpbnZQYXJlbnRXdG0udHJhbnNmb3JtUG9pbnQocG9zaXRpb24sIHRoaXMubG9jYWxQb3NpdGlvbik7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuX2RpcnR5TG9jYWwpIHtcbiAgICAgICAgdGhpcy5fZGlydGlmeSh0cnVlKTtcbiAgICAgIH1cbiAgICB9O1xuICB9KCksIHNldFJvdGF0aW9uOmZ1bmN0aW9uKCkge1xuICAgIHZhciByb3RhdGlvbiA9IG5ldyBwYy5RdWF0O1xuICAgIHZhciBpbnZQYXJlbnRSb3QgPSBuZXcgcGMuUXVhdDtcbiAgICByZXR1cm4gZnVuY3Rpb24oeCwgeSwgeiwgdykge1xuICAgICAgaWYgKHggaW5zdGFuY2VvZiBwYy5RdWF0KSB7XG4gICAgICAgIHJvdGF0aW9uLmNvcHkoeCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByb3RhdGlvbi5zZXQoeCwgeSwgeiwgdyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fcGFyZW50ID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMubG9jYWxSb3RhdGlvbi5jb3B5KHJvdGF0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBwYXJlbnRSb3QgPSB0aGlzLl9wYXJlbnQuZ2V0Um90YXRpb24oKTtcbiAgICAgICAgaW52UGFyZW50Um90LmNvcHkocGFyZW50Um90KS5pbnZlcnQoKTtcbiAgICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLmNvcHkoaW52UGFyZW50Um90KS5tdWwocm90YXRpb24pO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICAgIHRoaXMuX2RpcnRpZnkodHJ1ZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfSgpLCBzZXRFdWxlckFuZ2xlczpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW52UGFyZW50Um90ID0gbmV3IHBjLlF1YXQ7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHgsIHksIHopIHtcbiAgICAgIGlmICh4IGluc3RhbmNlb2YgcGMuVmVjMykge1xuICAgICAgICB0aGlzLmxvY2FsUm90YXRpb24uc2V0RnJvbUV1bGVyQW5nbGVzKHguZGF0YVswXSwgeC5kYXRhWzFdLCB4LmRhdGFbMl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLnNldEZyb21FdWxlckFuZ2xlcyh4LCB5LCB6KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgdmFyIHBhcmVudFJvdCA9IHRoaXMuX3BhcmVudC5nZXRSb3RhdGlvbigpO1xuICAgICAgICBpbnZQYXJlbnRSb3QuY29weShwYXJlbnRSb3QpLmludmVydCgpO1xuICAgICAgICB0aGlzLmxvY2FsUm90YXRpb24ubXVsMihpbnZQYXJlbnRSb3QsIHRoaXMubG9jYWxSb3RhdGlvbik7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuX2RpcnR5TG9jYWwpIHtcbiAgICAgICAgdGhpcy5fZGlydGlmeSh0cnVlKTtcbiAgICAgIH1cbiAgICB9O1xuICB9KCksIGFkZENoaWxkOmZ1bmN0aW9uKG5vZGUpIHtcbiAgICBpZiAobm9kZS5fcGFyZW50ICE9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJHcmFwaE5vZGUgaXMgYWxyZWFkeSBwYXJlbnRlZFwiKTtcbiAgICB9XG4gICAgdGhpcy5fY2hpbGRyZW4ucHVzaChub2RlKTtcbiAgICB0aGlzLl9vbkluc2VydENoaWxkKG5vZGUpO1xuICB9LCBhZGRDaGlsZEFuZFNhdmVUcmFuc2Zvcm06ZnVuY3Rpb24obm9kZSkge1xuICAgIHZhciB3UG9zID0gbm9kZS5nZXRQb3NpdGlvbigpO1xuICAgIHZhciB3Um90ID0gbm9kZS5nZXRSb3RhdGlvbigpO1xuICAgIHZhciBjdXJyZW50ID0gbm9kZS5fcGFyZW50O1xuICAgIGlmIChjdXJyZW50KSB7XG4gICAgICBjdXJyZW50LnJlbW92ZUNoaWxkKG5vZGUpO1xuICAgIH1cbiAgICBpZiAodGhpcy50bXBNYXQ0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMudG1wTWF0NCA9IG5ldyBwYy5NYXQ0O1xuICAgICAgdGhpcy50bXBRdWF0ID0gbmV3IHBjLlF1YXQ7XG4gICAgfVxuICAgIG5vZGUuc2V0UG9zaXRpb24odGhpcy50bXBNYXQ0LmNvcHkodGhpcy53b3JsZFRyYW5zZm9ybSkuaW52ZXJ0KCkudHJhbnNmb3JtUG9pbnQod1BvcykpO1xuICAgIG5vZGUuc2V0Um90YXRpb24odGhpcy50bXBRdWF0LmNvcHkodGhpcy5nZXRSb3RhdGlvbigpKS5pbnZlcnQoKS5tdWwod1JvdCkpO1xuICAgIHRoaXMuX2NoaWxkcmVuLnB1c2gobm9kZSk7XG4gICAgdGhpcy5fb25JbnNlcnRDaGlsZChub2RlKTtcbiAgfSwgaW5zZXJ0Q2hpbGQ6ZnVuY3Rpb24obm9kZSwgaW5kZXgpIHtcbiAgICBpZiAobm9kZS5fcGFyZW50ICE9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJHcmFwaE5vZGUgaXMgYWxyZWFkeSBwYXJlbnRlZFwiKTtcbiAgICB9XG4gICAgdGhpcy5fY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAwLCBub2RlKTtcbiAgICB0aGlzLl9vbkluc2VydENoaWxkKG5vZGUpO1xuICB9LCBfb25JbnNlcnRDaGlsZDpmdW5jdGlvbihub2RlKSB7XG4gICAgbm9kZS5fcGFyZW50ID0gdGhpcztcbiAgICB2YXIgZW5hYmxlZEluSGllcmFyY2h5ID0gbm9kZS5fZW5hYmxlZCAmJiB0aGlzLmVuYWJsZWQ7XG4gICAgaWYgKG5vZGUuX2VuYWJsZWRJbkhpZXJhcmNoeSAhPT0gZW5hYmxlZEluSGllcmFyY2h5KSB7XG4gICAgICBub2RlLl9lbmFibGVkSW5IaWVyYXJjaHkgPSBlbmFibGVkSW5IaWVyYXJjaHk7XG4gICAgICBub2RlLl9ub3RpZnlIaWVyYXJjaHlTdGF0ZUNoYW5nZWQobm9kZSwgZW5hYmxlZEluSGllcmFyY2h5KTtcbiAgICB9XG4gICAgbm9kZS5fZGlydGlmeSgpO1xuICAgIGlmIChub2RlLmZpcmUpIHtcbiAgICAgIG5vZGUuZmlyZShcImluc2VydFwiLCB0aGlzKTtcbiAgICB9XG4gIH0sIHJlbW92ZUNoaWxkOmZ1bmN0aW9uKGNoaWxkKSB7XG4gICAgdmFyIGk7XG4gICAgdmFyIGxlbmd0aCA9IHRoaXMuX2NoaWxkcmVuLmxlbmd0aDtcbiAgICBmb3IgKGkgPSAwO2kgPCBsZW5ndGg7KytpKSB7XG4gICAgICBpZiAodGhpcy5fY2hpbGRyZW5baV0gPT09IGNoaWxkKSB7XG4gICAgICAgIHRoaXMuX2NoaWxkcmVuLnNwbGljZShpLCAxKTtcbiAgICAgICAgY2hpbGQuX3BhcmVudCA9IG51bGw7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGFkZExhYmVsOmZ1bmN0aW9uKGxhYmVsKSB7XG4gICAgdGhpcy5fbGFiZWxzW2xhYmVsXSA9IHRydWU7XG4gIH0sIGdldExhYmVsczpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fbGFiZWxzKTtcbiAgfSwgaGFzTGFiZWw6ZnVuY3Rpb24obGFiZWwpIHtcbiAgICByZXR1cm4gISF0aGlzLl9sYWJlbHNbbGFiZWxdO1xuICB9LCByZW1vdmVMYWJlbDpmdW5jdGlvbihsYWJlbCkge1xuICAgIGRlbGV0ZSB0aGlzLl9sYWJlbHNbbGFiZWxdO1xuICB9LCBmaW5kQnlMYWJlbDpmdW5jdGlvbihsYWJlbCwgcmVzdWx0cykge1xuICAgIHZhciBpLCBsZW5ndGggPSB0aGlzLl9jaGlsZHJlbi5sZW5ndGg7XG4gICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107XG4gICAgaWYgKHRoaXMuaGFzTGFiZWwobGFiZWwpKSB7XG4gICAgICByZXN1bHRzLnB1c2godGhpcyk7XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IGxlbmd0aDsrK2kpIHtcbiAgICAgIHJlc3VsdHMgPSB0aGlzLl9jaGlsZHJlbltpXS5maW5kQnlMYWJlbChsYWJlbCwgcmVzdWx0cyk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9LCBfc3luYzpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fZGlydHlMb2NhbCkge1xuICAgICAgdGhpcy5sb2NhbFRyYW5zZm9ybS5zZXRUUlModGhpcy5sb2NhbFBvc2l0aW9uLCB0aGlzLmxvY2FsUm90YXRpb24sIHRoaXMubG9jYWxTY2FsZSk7XG4gICAgICB0aGlzLl9kaXJ0eUxvY2FsID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLl9kaXJ0eVdvcmxkKSB7XG4gICAgICBpZiAodGhpcy5fcGFyZW50ID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMud29ybGRUcmFuc2Zvcm0uY29weSh0aGlzLmxvY2FsVHJhbnNmb3JtKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLnNjYWxlQ29tcGVuc2F0aW9uKSB7XG4gICAgICAgICAgdmFyIHBhcmVudFdvcmxkU2NhbGU7XG4gICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuX3BhcmVudDtcbiAgICAgICAgICB2YXIgc2NhbGUgPSB0aGlzLmxvY2FsU2NhbGU7XG4gICAgICAgICAgdmFyIHBhcmVudFRvVXNlU2NhbGVGcm9tID0gcGFyZW50O1xuICAgICAgICAgIGlmIChwYXJlbnRUb1VzZVNjYWxlRnJvbSkge1xuICAgICAgICAgICAgd2hpbGUgKHBhcmVudFRvVXNlU2NhbGVGcm9tICYmIHBhcmVudFRvVXNlU2NhbGVGcm9tLnNjYWxlQ29tcGVuc2F0aW9uKSB7XG4gICAgICAgICAgICAgIHBhcmVudFRvVXNlU2NhbGVGcm9tID0gcGFyZW50VG9Vc2VTY2FsZUZyb20uX3BhcmVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJlbnRUb1VzZVNjYWxlRnJvbSkge1xuICAgICAgICAgICAgICBwYXJlbnRUb1VzZVNjYWxlRnJvbSA9IHBhcmVudFRvVXNlU2NhbGVGcm9tLl9wYXJlbnQ7XG4gICAgICAgICAgICAgIGlmIChwYXJlbnRUb1VzZVNjYWxlRnJvbSkge1xuICAgICAgICAgICAgICAgIHBhcmVudFdvcmxkU2NhbGUgPSBwYXJlbnRUb1VzZVNjYWxlRnJvbS53b3JsZFRyYW5zZm9ybS5nZXRTY2FsZSgpO1xuICAgICAgICAgICAgICAgIHNjYWxlQ29tcGVuc2F0ZVNjYWxlLm11bDIocGFyZW50V29ybGRTY2FsZSwgdGhpcy5sb2NhbFNjYWxlKTtcbiAgICAgICAgICAgICAgICBzY2FsZSA9IHNjYWxlQ29tcGVuc2F0ZVNjYWxlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHNjYWxlQ29tcGVuc2F0ZVJvdDIuc2V0RnJvbU1hdDQocGFyZW50LndvcmxkVHJhbnNmb3JtKTtcbiAgICAgICAgICBzY2FsZUNvbXBlbnNhdGVSb3QubXVsMihzY2FsZUNvbXBlbnNhdGVSb3QyLCB0aGlzLmxvY2FsUm90YXRpb24pO1xuICAgICAgICAgIHZhciB0bWF0cml4ID0gcGFyZW50LndvcmxkVHJhbnNmb3JtO1xuICAgICAgICAgIGlmIChwYXJlbnQuc2NhbGVDb21wZW5zYXRpb24pIHtcbiAgICAgICAgICAgIHNjYWxlQ29tcGVuc2F0ZVNjYWxlRm9yUGFyZW50Lm11bDIocGFyZW50V29ybGRTY2FsZSwgcGFyZW50LmdldExvY2FsU2NhbGUoKSk7XG4gICAgICAgICAgICBzY2FsZUNvbXBlbnNhdGVQb3NUcmFuc2Zvcm0uc2V0VFJTKHBhcmVudC53b3JsZFRyYW5zZm9ybS5nZXRUcmFuc2xhdGlvbihzY2FsZUNvbXBlbnNhdGVQb3MpLCBzY2FsZUNvbXBlbnNhdGVSb3QyLCBzY2FsZUNvbXBlbnNhdGVTY2FsZUZvclBhcmVudCk7XG4gICAgICAgICAgICB0bWF0cml4ID0gc2NhbGVDb21wZW5zYXRlUG9zVHJhbnNmb3JtO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0bWF0cml4LnRyYW5zZm9ybVBvaW50KHRoaXMubG9jYWxQb3NpdGlvbiwgc2NhbGVDb21wZW5zYXRlUG9zKTtcbiAgICAgICAgICB0aGlzLndvcmxkVHJhbnNmb3JtLnNldFRSUyhzY2FsZUNvbXBlbnNhdGVQb3MsIHNjYWxlQ29tcGVuc2F0ZVJvdCwgc2NhbGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMud29ybGRUcmFuc2Zvcm0ubXVsMih0aGlzLl9wYXJlbnQud29ybGRUcmFuc2Zvcm0sIHRoaXMubG9jYWxUcmFuc2Zvcm0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLl9kaXJ0eVdvcmxkID0gZmFsc2U7XG4gICAgfVxuICB9LCBzeW5jSGllcmFyY2h5OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fZW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZGlydHlMb2NhbCB8fCB0aGlzLl9kaXJ0eVdvcmxkKSB7XG4gICAgICB0aGlzLl9zeW5jKCk7XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLl9jaGlsZHJlbi5sZW5ndGg7aSsrKSB7XG4gICAgICB0aGlzLl9jaGlsZHJlbltpXS5zeW5jSGllcmFyY2h5KCk7XG4gICAgfVxuICB9LCBsb29rQXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG1hdHJpeCA9IG5ldyBwYy5NYXQ0O1xuICAgIHZhciB0YXJnZXQgPSBuZXcgcGMuVmVjMztcbiAgICB2YXIgdXAgPSBuZXcgcGMuVmVjMztcbiAgICB2YXIgcm90YXRpb24gPSBuZXcgcGMuUXVhdDtcbiAgICByZXR1cm4gZnVuY3Rpb24odHgsIHR5LCB0eiwgdXgsIHV5LCB1eikge1xuICAgICAgaWYgKHR4IGluc3RhbmNlb2YgcGMuVmVjMykge1xuICAgICAgICB0YXJnZXQuY29weSh0eCk7XG4gICAgICAgIGlmICh0eSBpbnN0YW5jZW9mIHBjLlZlYzMpIHtcbiAgICAgICAgICB1cC5jb3B5KHR5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB1cC5jb3B5KHBjLlZlYzMuVVApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodHogPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0YXJnZXQuc2V0KHR4LCB0eSwgdHopO1xuICAgICAgICAgIGlmICh1eCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB1cC5zZXQodXgsIHV5LCB1eik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHVwLmNvcHkocGMuVmVjMy5VUCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBtYXRyaXguc2V0TG9va0F0KHRoaXMuZ2V0UG9zaXRpb24oKSwgdGFyZ2V0LCB1cCk7XG4gICAgICByb3RhdGlvbi5zZXRGcm9tTWF0NChtYXRyaXgpO1xuICAgICAgdGhpcy5zZXRSb3RhdGlvbihyb3RhdGlvbik7XG4gICAgfTtcbiAgfSgpLCB0cmFuc2xhdGU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHRyYW5zbGF0aW9uID0gbmV3IHBjLlZlYzM7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHgsIHksIHopIHtcbiAgICAgIGlmICh4IGluc3RhbmNlb2YgcGMuVmVjMykge1xuICAgICAgICB0cmFuc2xhdGlvbi5jb3B5KHgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJhbnNsYXRpb24uc2V0KHgsIHksIHopO1xuICAgICAgfVxuICAgICAgdHJhbnNsYXRpb24uYWRkKHRoaXMuZ2V0UG9zaXRpb24oKSk7XG4gICAgICB0aGlzLnNldFBvc2l0aW9uKHRyYW5zbGF0aW9uKTtcbiAgICB9O1xuICB9KCksIHRyYW5zbGF0ZUxvY2FsOmZ1bmN0aW9uKCkge1xuICAgIHZhciB0cmFuc2xhdGlvbiA9IG5ldyBwYy5WZWMzO1xuICAgIHJldHVybiBmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgICBpZiAoeCBpbnN0YW5jZW9mIHBjLlZlYzMpIHtcbiAgICAgICAgdHJhbnNsYXRpb24uY29weSh4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyYW5zbGF0aW9uLnNldCh4LCB5LCB6KTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYWxSb3RhdGlvbi50cmFuc2Zvcm1WZWN0b3IodHJhbnNsYXRpb24sIHRyYW5zbGF0aW9uKTtcbiAgICAgIHRoaXMubG9jYWxQb3NpdGlvbi5hZGQodHJhbnNsYXRpb24pO1xuICAgICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICAgIHRoaXMuX2RpcnRpZnkodHJ1ZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfSgpLCByb3RhdGU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHF1YXRlcm5pb24gPSBuZXcgcGMuUXVhdDtcbiAgICB2YXIgaW52UGFyZW50Um90ID0gbmV3IHBjLlF1YXQ7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHgsIHksIHopIHtcbiAgICAgIGlmICh4IGluc3RhbmNlb2YgcGMuVmVjMykge1xuICAgICAgICBxdWF0ZXJuaW9uLnNldEZyb21FdWxlckFuZ2xlcyh4LmRhdGFbMF0sIHguZGF0YVsxXSwgeC5kYXRhWzJdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHF1YXRlcm5pb24uc2V0RnJvbUV1bGVyQW5nbGVzKHgsIHksIHopO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX3BhcmVudCA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLmxvY2FsUm90YXRpb24ubXVsMihxdWF0ZXJuaW9uLCB0aGlzLmxvY2FsUm90YXRpb24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHJvdCA9IHRoaXMuZ2V0Um90YXRpb24oKTtcbiAgICAgICAgdmFyIHBhcmVudFJvdCA9IHRoaXMuX3BhcmVudC5nZXRSb3RhdGlvbigpO1xuICAgICAgICBpbnZQYXJlbnRSb3QuY29weShwYXJlbnRSb3QpLmludmVydCgpO1xuICAgICAgICBxdWF0ZXJuaW9uLm11bDIoaW52UGFyZW50Um90LCBxdWF0ZXJuaW9uKTtcbiAgICAgICAgdGhpcy5sb2NhbFJvdGF0aW9uLm11bDIocXVhdGVybmlvbiwgcm90KTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5fZGlydHlMb2NhbCkge1xuICAgICAgICB0aGlzLl9kaXJ0aWZ5KHRydWUpO1xuICAgICAgfVxuICAgIH07XG4gIH0oKSwgcm90YXRlTG9jYWw6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHF1YXRlcm5pb24gPSBuZXcgcGMuUXVhdDtcbiAgICByZXR1cm4gZnVuY3Rpb24oeCwgeSwgeikge1xuICAgICAgaWYgKHggaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICAgIHF1YXRlcm5pb24uc2V0RnJvbUV1bGVyQW5nbGVzKHguZGF0YVswXSwgeC5kYXRhWzFdLCB4LmRhdGFbMl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcXVhdGVybmlvbi5zZXRGcm9tRXVsZXJBbmdsZXMoeCwgeSwgeik7XG4gICAgICB9XG4gICAgICB0aGlzLmxvY2FsUm90YXRpb24ubXVsKHF1YXRlcm5pb24pO1xuICAgICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICAgIHRoaXMuX2RpcnRpZnkodHJ1ZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfSgpfSk7XG4gIHJldHVybiB7R3JhcGhOb2RlOkdyYXBoTm9kZX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIF9kZXZpY2VDb29yZCA9IG5ldyBwYy5WZWMzO1xuICB2YXIgX2ZhciA9IG5ldyBwYy5WZWMzO1xuICB2YXIgX2ZhclcgPSBuZXcgcGMuVmVjMztcbiAgdmFyIF9pbnZWaWV3UHJvak1hdCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgQ2FtZXJhID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fcHJvamVjdGlvbiA9IHBjLlBST0pFQ1RJT05fUEVSU1BFQ1RJVkU7XG4gICAgdGhpcy5fbmVhckNsaXAgPSAwLjE7XG4gICAgdGhpcy5fZmFyQ2xpcCA9IDEwMDAwO1xuICAgIHRoaXMuX2ZvdiA9IDQ1O1xuICAgIHRoaXMuX29ydGhvSGVpZ2h0ID0gMTA7XG4gICAgdGhpcy5fYXNwZWN0ID0gMTYgLyA5O1xuICAgIHRoaXMuX2hvcml6b250YWxGb3YgPSBmYWxzZTtcbiAgICB0aGlzLmZydXN0dW1DdWxsaW5nID0gZmFsc2U7XG4gICAgdGhpcy5jdWxsaW5nTWFzayA9IDQyOTQ5NjcyOTU7XG4gICAgdGhpcy5fcmVuZGVyRGVwdGhSZXF1ZXN0cyA9IDA7XG4gICAgdGhpcy5fcHJvak1hdERpcnR5ID0gdHJ1ZTtcbiAgICB0aGlzLl9wcm9qTWF0ID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5fdmlld01hdCA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMuX3ZpZXdQcm9qTWF0ID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy52ckRpc3BsYXkgPSBudWxsO1xuICAgIHRoaXMuX3JlY3QgPSB7eDowLCB5OjAsIHdpZHRoOjEsIGhlaWdodDoxfTtcbiAgICB0aGlzLl9zY2lzc29yUmVjdCA9IHt4OjAsIHk6MCwgd2lkdGg6MSwgaGVpZ2h0OjF9O1xuICAgIHRoaXMuZnJ1c3R1bSA9IG5ldyBwYy5GcnVzdHVtKHRoaXMuX3Byb2pNYXQsIHRoaXMuX3ZpZXdNYXQpO1xuICAgIHRoaXMucmVuZGVyVGFyZ2V0ID0gbnVsbDtcbiAgICB0aGlzLl9kZXB0aFRhcmdldCA9IG51bGw7XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zID0ge2NvbG9yOlswLjUsIDAuNSwgMC41LCAxLjBdLCBkZXB0aDoxLjAsIHN0ZW5jaWw6MCwgZmxhZ3M6cGMuQ0xFQVJGTEFHX0NPTE9SIHwgcGMuQ0xFQVJGTEFHX0RFUFRIIHwgcGMuQ0xFQVJGTEFHX1NURU5DSUx9O1xuICAgIHRoaXMuX25vZGUgPSBudWxsO1xuICAgIHRoaXMuY2FsY3VsYXRlVHJhbnNmb3JtID0gbnVsbDtcbiAgICB0aGlzLm92ZXJyaWRlQ2FsY3VsYXRlVHJhbnNmb3JtID0gZmFsc2U7XG4gICAgdGhpcy5jYWxjdWxhdGVQcm9qZWN0aW9uID0gbnVsbDtcbiAgICB0aGlzLm92ZXJyaWRlQ2FsY3VsYXRlUHJvamVjdGlvbiA9IGZhbHNlO1xuICAgIHRoaXMuX2N1bGxGYWNlcyA9IHRydWU7XG4gICAgdGhpcy5fZmxpcEZhY2VzID0gZmFsc2U7XG4gIH07XG4gIENhbWVyYS5wcm90b3R5cGUgPSB7Y2xvbmU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNsb25lID0gbmV3IHBjLkNhbWVyYTtcbiAgICBjbG9uZS5wcm9qZWN0aW9uID0gdGhpcy5fcHJvamVjdGlvbjtcbiAgICBjbG9uZS5uZWFyQ2xpcCA9IHRoaXMuX25lYXJDbGlwO1xuICAgIGNsb25lLmZhckNsaXAgPSB0aGlzLl9mYXJDbGlwO1xuICAgIGNsb25lLmZvdiA9IHRoaXMuX2ZvdjtcbiAgICBjbG9uZS5hc3BlY3RSYXRpbyA9IHRoaXMuX2FzcGVjdDtcbiAgICBjbG9uZS5yZW5kZXJUYXJnZXQgPSB0aGlzLnJlbmRlclRhcmdldDtcbiAgICBjbG9uZS5zZXRDbGVhck9wdGlvbnModGhpcy5nZXRDbGVhck9wdGlvbnMoKSk7XG4gICAgY2xvbmUuZnJ1c3R1bUN1bGxpbmcgPSB0aGlzLmZydXN0dW1DdWxsaW5nO1xuICAgIGNsb25lLmN1bGxpbmdNYXNrID0gdGhpcy5jdWxsaW5nTWFzaztcbiAgICByZXR1cm4gY2xvbmU7XG4gIH0sIHdvcmxkVG9TY3JlZW46ZnVuY3Rpb24od29ybGRDb29yZCwgY3csIGNoLCBzY3JlZW5Db29yZCkge1xuICAgIGlmIChzY3JlZW5Db29yZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBzY3JlZW5Db29yZCA9IG5ldyBwYy5WZWMzO1xuICAgIH1cbiAgICB2YXIgcHJvak1hdCA9IHRoaXMuZ2V0UHJvamVjdGlvbk1hdHJpeCgpO1xuICAgIHZhciB3dG0gPSB0aGlzLl9ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgdGhpcy5fdmlld01hdC5jb3B5KHd0bSkuaW52ZXJ0KCk7XG4gICAgdGhpcy5fdmlld1Byb2pNYXQubXVsMihwcm9qTWF0LCB0aGlzLl92aWV3TWF0KTtcbiAgICB0aGlzLl92aWV3UHJvak1hdC50cmFuc2Zvcm1Qb2ludCh3b3JsZENvb3JkLCBzY3JlZW5Db29yZCk7XG4gICAgdmFyIHdwID0gd29ybGRDb29yZC5kYXRhO1xuICAgIHZhciB2cG0gPSB0aGlzLl92aWV3UHJvak1hdC5kYXRhO1xuICAgIHZhciB3ID0gd3BbMF0gKiB2cG1bM10gKyB3cFsxXSAqIHZwbVs3XSArIHdwWzJdICogdnBtWzExXSArIDEgKiB2cG1bMTVdO1xuICAgIHNjcmVlbkNvb3JkLnggPSAoc2NyZWVuQ29vcmQueCAvIHcgKyAxKSAqIDAuNSAqIGN3O1xuICAgIHNjcmVlbkNvb3JkLnkgPSAoMSAtIHNjcmVlbkNvb3JkLnkgLyB3KSAqIDAuNSAqIGNoO1xuICAgIHJldHVybiBzY3JlZW5Db29yZDtcbiAgfSwgc2NyZWVuVG9Xb3JsZDpmdW5jdGlvbih4LCB5LCB6LCBjdywgY2gsIHdvcmxkQ29vcmQpIHtcbiAgICBpZiAod29ybGRDb29yZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB3b3JsZENvb3JkID0gbmV3IHBjLlZlYzM7XG4gICAgfVxuICAgIHZhciBwcm9qTWF0ID0gdGhpcy5nZXRQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgdmFyIHd0bSA9IHRoaXMuX25vZGUuZ2V0V29ybGRUcmFuc2Zvcm0oKTtcbiAgICB0aGlzLl92aWV3TWF0LmNvcHkod3RtKS5pbnZlcnQoKTtcbiAgICB0aGlzLl92aWV3UHJvak1hdC5tdWwyKHByb2pNYXQsIHRoaXMuX3ZpZXdNYXQpO1xuICAgIF9pbnZWaWV3UHJvak1hdC5jb3B5KHRoaXMuX3ZpZXdQcm9qTWF0KS5pbnZlcnQoKTtcbiAgICBpZiAodGhpcy5fcHJvamVjdGlvbiA9PT0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRSkge1xuICAgICAgX2Zhci5zZXQoeCAvIGN3ICogMiAtIDEsIChjaCAtIHkpIC8gY2ggKiAyIC0gMSwgMSk7XG4gICAgICBfaW52Vmlld1Byb2pNYXQudHJhbnNmb3JtUG9pbnQoX2ZhciwgX2ZhclcpO1xuICAgICAgdmFyIHcgPSBfZmFyLnggKiBfaW52Vmlld1Byb2pNYXQuZGF0YVszXSArIF9mYXIueSAqIF9pbnZWaWV3UHJvak1hdC5kYXRhWzddICsgX2Zhci56ICogX2ludlZpZXdQcm9qTWF0LmRhdGFbMTFdICsgX2ludlZpZXdQcm9qTWF0LmRhdGFbMTVdO1xuICAgICAgX2Zhclcuc2NhbGUoMSAvIHcpO1xuICAgICAgdmFyIGFscGhhID0geiAvIHRoaXMuX2ZhckNsaXA7XG4gICAgICB3b3JsZENvb3JkLmxlcnAodGhpcy5fbm9kZS5nZXRQb3NpdGlvbigpLCBfZmFyVywgYWxwaGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgcmFuZ2UgPSB0aGlzLl9mYXJDbGlwIC0gdGhpcy5fbmVhckNsaXA7XG4gICAgICBfZGV2aWNlQ29vcmQuc2V0KHggLyBjdywgKGNoIC0geSkgLyBjaCwgeiAvIHJhbmdlKTtcbiAgICAgIF9kZXZpY2VDb29yZC5zY2FsZSgyKTtcbiAgICAgIF9kZXZpY2VDb29yZC5zdWIocGMuVmVjMy5PTkUpO1xuICAgICAgX2ludlZpZXdQcm9qTWF0LnRyYW5zZm9ybVBvaW50KF9kZXZpY2VDb29yZCwgd29ybGRDb29yZCk7XG4gICAgfVxuICAgIHJldHVybiB3b3JsZENvb3JkO1xuICB9LCBnZXRDbGVhck9wdGlvbnM6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NsZWFyT3B0aW9ucztcbiAgfSwgZ2V0UHJvamVjdGlvbk1hdHJpeDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fcHJvak1hdERpcnR5KSB7XG4gICAgICBpZiAodGhpcy5fcHJvamVjdGlvbiA9PT0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRSkge1xuICAgICAgICB0aGlzLl9wcm9qTWF0LnNldFBlcnNwZWN0aXZlKHRoaXMuX2ZvdiwgdGhpcy5fYXNwZWN0LCB0aGlzLl9uZWFyQ2xpcCwgdGhpcy5fZmFyQ2xpcCwgdGhpcy5faG9yaXpvbnRhbEZvdik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgeSA9IHRoaXMuX29ydGhvSGVpZ2h0O1xuICAgICAgICB2YXIgeCA9IHkgKiB0aGlzLl9hc3BlY3Q7XG4gICAgICAgIHRoaXMuX3Byb2pNYXQuc2V0T3J0aG8oLXgsIHgsIC15LCB5LCB0aGlzLl9uZWFyQ2xpcCwgdGhpcy5fZmFyQ2xpcCk7XG4gICAgICB9XG4gICAgICB0aGlzLl9wcm9qTWF0RGlydHkgPSBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3Byb2pNYXQ7XG4gIH0sIGdldFJlY3Q6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY3Q7XG4gIH0sIHNldENsZWFyT3B0aW9uczpmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zLmNvbG9yWzBdID0gb3B0aW9ucy5jb2xvclswXTtcbiAgICB0aGlzLl9jbGVhck9wdGlvbnMuY29sb3JbMV0gPSBvcHRpb25zLmNvbG9yWzFdO1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5jb2xvclsyXSA9IG9wdGlvbnMuY29sb3JbMl07XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zLmNvbG9yWzNdID0gb3B0aW9ucy5jb2xvclszXTtcbiAgICB0aGlzLl9jbGVhck9wdGlvbnMuZGVwdGggPSBvcHRpb25zLmRlcHRoO1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5zdGVuY2lsID0gb3B0aW9ucy5zdGVuY2lsO1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5mbGFncyA9IG9wdGlvbnMuZmxhZ3M7XG4gIH0sIHNldFJlY3Q6ZnVuY3Rpb24oeCwgeSwgd2lkdGgsIGhlaWdodCkge1xuICAgIHRoaXMuX3JlY3QueCA9IHg7XG4gICAgdGhpcy5fcmVjdC55ID0geTtcbiAgICB0aGlzLl9yZWN0LndpZHRoID0gd2lkdGg7XG4gICAgdGhpcy5fcmVjdC5oZWlnaHQgPSBoZWlnaHQ7XG4gIH0sIHNldFNjaXNzb3JSZWN0OmZ1bmN0aW9uKHgsIHksIHdpZHRoLCBoZWlnaHQpIHtcbiAgICB0aGlzLl9zY2lzc29yUmVjdC54ID0geDtcbiAgICB0aGlzLl9zY2lzc29yUmVjdC55ID0geTtcbiAgICB0aGlzLl9zY2lzc29yUmVjdC53aWR0aCA9IHdpZHRoO1xuICAgIHRoaXMuX3NjaXNzb3JSZWN0LmhlaWdodCA9IGhlaWdodDtcbiAgfSwgcmVxdWVzdERlcHRoTWFwOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3JlbmRlckRlcHRoUmVxdWVzdHMrKztcbiAgfSwgcmVsZWFzZURlcHRoTWFwOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3JlbmRlckRlcHRoUmVxdWVzdHMtLTtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcImFzcGVjdFJhdGlvXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FzcGVjdDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHYpIHtcbiAgICBpZiAodGhpcy5fYXNwZWN0ICE9PSB2KSB7XG4gICAgICB0aGlzLl9hc3BlY3QgPSB2O1xuICAgICAgdGhpcy5fcHJvak1hdERpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENhbWVyYS5wcm90b3R5cGUsIFwicHJvamVjdGlvblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9wcm9qZWN0aW9uO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9wcm9qZWN0aW9uICE9PSB2KSB7XG4gICAgICB0aGlzLl9wcm9qZWN0aW9uID0gdjtcbiAgICAgIHRoaXMuX3Byb2pNYXREaXJ0eSA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcIm5lYXJDbGlwXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX25lYXJDbGlwO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9uZWFyQ2xpcCAhPT0gdikge1xuICAgICAgdGhpcy5fbmVhckNsaXAgPSB2O1xuICAgICAgdGhpcy5fcHJvak1hdERpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENhbWVyYS5wcm90b3R5cGUsIFwiZmFyQ2xpcFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9mYXJDbGlwO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIGlmICh0aGlzLl9mYXJDbGlwICE9PSB2KSB7XG4gICAgICB0aGlzLl9mYXJDbGlwID0gdjtcbiAgICAgIHRoaXMuX3Byb2pNYXREaXJ0eSA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcImZvdlwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9mb3Y7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgaWYgKHRoaXMuX2ZvdiAhPT0gdikge1xuICAgICAgdGhpcy5fZm92ID0gdjtcbiAgICAgIHRoaXMuX3Byb2pNYXREaXJ0eSA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcImhvcml6b250YWxGb3ZcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faG9yaXpvbnRhbEZvdjtcbiAgfSwgc2V0OmZ1bmN0aW9uKHYpIHtcbiAgICBpZiAodGhpcy5faG9yaXpvbnRhbEZvdiAhPT0gdikge1xuICAgICAgdGhpcy5faG9yaXpvbnRhbEZvdiA9IHY7XG4gICAgICB0aGlzLl9wcm9qTWF0RGlydHkgPSB0cnVlO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ2FtZXJhLnByb3RvdHlwZSwgXCJvcnRob0hlaWdodFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9vcnRob0hlaWdodDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHYpIHtcbiAgICBpZiAodGhpcy5fb3J0aG9IZWlnaHQgIT09IHYpIHtcbiAgICAgIHRoaXMuX29ydGhvSGVpZ2h0ID0gdjtcbiAgICAgIHRoaXMuX3Byb2pNYXREaXJ0eSA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcImNsZWFyQ29sb3JcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY2xlYXJPcHRpb25zLmNvbG9yO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5jb2xvclswXSA9IHZbMF07XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zLmNvbG9yWzFdID0gdlsxXTtcbiAgICB0aGlzLl9jbGVhck9wdGlvbnMuY29sb3JbMl0gPSB2WzJdO1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5jb2xvclszXSA9IHZbM107XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENhbWVyYS5wcm90b3R5cGUsIFwiY2xlYXJEZXB0aFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jbGVhck9wdGlvbnMuZGVwdGg7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zLmRlcHRoID0gdjtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ2FtZXJhLnByb3RvdHlwZSwgXCJjbGVhclN0ZW5jaWxcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY2xlYXJPcHRpb25zLnN0ZW5jaWw7XG4gIH0sIHNldDpmdW5jdGlvbih2KSB7XG4gICAgdGhpcy5fY2xlYXJPcHRpb25zLnN0ZW5jaWwgPSB2O1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmEucHJvdG90eXBlLCBcImNsZWFyRmxhZ3NcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY2xlYXJPcHRpb25zLmZsYWdzO1xuICB9LCBzZXQ6ZnVuY3Rpb24odikge1xuICAgIHRoaXMuX2NsZWFyT3B0aW9ucy5mbGFncyA9IHY7XG4gIH19KTtcbiAgcmV0dXJuIHtDYW1lcmE6Q2FtZXJhfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgc3BvdENlbnRlciA9IG5ldyBwYy5WZWMzO1xuICB2YXIgc3BvdEVuZFBvaW50ID0gbmV3IHBjLlZlYzM7XG4gIHZhciB0bXBWZWMgPSBuZXcgcGMuVmVjMztcbiAgdmFyIGNoYW5JZCA9IHtyOjAsIGc6MSwgYjoyLCBhOjN9O1xuICB2YXIgTGlnaHQgPSBmdW5jdGlvbiBMaWdodCgpIHtcbiAgICB0aGlzLl90eXBlID0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMO1xuICAgIHRoaXMuX2NvbG9yID0gbmV3IHBjLkNvbG9yKDAuOCwgMC44LCAwLjgpO1xuICAgIHRoaXMuX2ludGVuc2l0eSA9IDE7XG4gICAgdGhpcy5fY2FzdFNoYWRvd3MgPSBmYWxzZTtcbiAgICB0aGlzLl9lbmFibGVkID0gZmFsc2U7XG4gICAgdGhpcy5fbWFzayA9IDE7XG4gICAgdGhpcy5pc1N0YXRpYyA9IGZhbHNlO1xuICAgIHRoaXMua2V5ID0gMDtcbiAgICB0aGlzLmJha2VEaXIgPSB0cnVlO1xuICAgIHRoaXMuYXR0ZW51YXRpb25TdGFydCA9IDEwO1xuICAgIHRoaXMuYXR0ZW51YXRpb25FbmQgPSAxMDtcbiAgICB0aGlzLl9mYWxsb2ZmTW9kZSA9IDA7XG4gICAgdGhpcy5fc2hhZG93VHlwZSA9IHBjLlNIQURPV19QQ0YzO1xuICAgIHRoaXMuX3ZzbUJsdXJTaXplID0gMTE7XG4gICAgdGhpcy52c21CbHVyTW9kZSA9IHBjLkJMVVJfR0FVU1NJQU47XG4gICAgdGhpcy52c21CaWFzID0gMC4wMSAqIDAuMjU7XG4gICAgdGhpcy5fY29va2llID0gbnVsbDtcbiAgICB0aGlzLmNvb2tpZUludGVuc2l0eSA9IDE7XG4gICAgdGhpcy5fY29va2llRmFsbG9mZiA9IHRydWU7XG4gICAgdGhpcy5fY29va2llQ2hhbm5lbCA9IFwicmdiXCI7XG4gICAgdGhpcy5fY29va2llVHJhbnNmb3JtID0gbnVsbDtcbiAgICB0aGlzLl9jb29raWVPZmZzZXQgPSBudWxsO1xuICAgIHRoaXMuX2Nvb2tpZVRyYW5zZm9ybVNldCA9IGZhbHNlO1xuICAgIHRoaXMuX2Nvb2tpZU9mZnNldFNldCA9IGZhbHNlO1xuICAgIHRoaXMuX2lubmVyQ29uZUFuZ2xlID0gNDA7XG4gICAgdGhpcy5fb3V0ZXJDb25lQW5nbGUgPSA0NTtcbiAgICB0aGlzLl9maW5hbENvbG9yID0gbmV3IHBjLlZlYzMoMC44LCAwLjgsIDAuOCk7XG4gICAgdmFyIGMgPSBNYXRoLnBvdyh0aGlzLl9maW5hbENvbG9yLmRhdGFbMF0sIDIuMik7XG4gICAgdGhpcy5fbGluZWFyRmluYWxDb2xvciA9IG5ldyBwYy5WZWMzKGMsIGMsIGMpO1xuICAgIHRoaXMuX3Bvc2l0aW9uID0gbmV3IHBjLlZlYzMoMCwgMCwgMCk7XG4gICAgdGhpcy5fZGlyZWN0aW9uID0gbmV3IHBjLlZlYzMoMCwgMCwgMCk7XG4gICAgdGhpcy5faW5uZXJDb25lQW5nbGVDb3MgPSBNYXRoLmNvcyh0aGlzLl9pbm5lckNvbmVBbmdsZSAqIE1hdGguUEkgLyAxODApO1xuICAgIHRoaXMuX291dGVyQ29uZUFuZ2xlQ29zID0gTWF0aC5jb3ModGhpcy5fb3V0ZXJDb25lQW5nbGUgKiBNYXRoLlBJIC8gMTgwKTtcbiAgICB0aGlzLl9zaGFkb3dDYW1lcmEgPSBudWxsO1xuICAgIHRoaXMuX3NoYWRvd01hdHJpeCA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMuc2hhZG93RGlzdGFuY2UgPSA0MDtcbiAgICB0aGlzLl9zaGFkb3dSZXNvbHV0aW9uID0gMTAyNDtcbiAgICB0aGlzLnNoYWRvd0JpYXMgPSAtMC4wMDA1O1xuICAgIHRoaXMuX25vcm1hbE9mZnNldEJpYXMgPSAwLjA7XG4gICAgdGhpcy5zaGFkb3dVcGRhdGVNb2RlID0gcGMuU0hBRE9XVVBEQVRFX1JFQUxUSU1FO1xuICAgIHRoaXMuX3NjZW5lID0gbnVsbDtcbiAgICB0aGlzLl9ub2RlID0gbnVsbDtcbiAgICB0aGlzLl9yZW5kZXJlclBhcmFtcyA9IFtdO1xuICAgIHRoaXMuX2lzVnNtID0gZmFsc2U7XG4gICAgdGhpcy5faXNQY2YgPSB0cnVlO1xuICAgIHRoaXMuX2NhY2hlU2hhZG93TWFwID0gZmFsc2U7XG4gICAgdGhpcy5faXNDYWNoZWRTaGFkb3dNYXAgPSBmYWxzZTtcbiAgfTtcbiAgTGlnaHQucHJvdG90eXBlID0ge2Nsb25lOmZ1bmN0aW9uKCkge1xuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5MaWdodDtcbiAgICBjbG9uZS50eXBlID0gdGhpcy5fdHlwZTtcbiAgICBjbG9uZS5zZXRDb2xvcih0aGlzLl9jb2xvcik7XG4gICAgY2xvbmUuaW50ZW5zaXR5ID0gdGhpcy5faW50ZW5zaXR5O1xuICAgIGNsb25lLmNhc3RTaGFkb3dzID0gdGhpcy5jYXN0U2hhZG93cztcbiAgICBjbG9uZS5lbmFibGVkID0gdGhpcy5fZW5hYmxlZDtcbiAgICBjbG9uZS5hdHRlbnVhdGlvblN0YXJ0ID0gdGhpcy5hdHRlbnVhdGlvblN0YXJ0O1xuICAgIGNsb25lLmF0dGVudWF0aW9uRW5kID0gdGhpcy5hdHRlbnVhdGlvbkVuZDtcbiAgICBjbG9uZS5mYWxsb2ZmTW9kZSA9IHRoaXMuX2ZhbGxvZmZNb2RlO1xuICAgIGNsb25lLnNoYWRvd1R5cGUgPSB0aGlzLl9zaGFkb3dUeXBlO1xuICAgIGNsb25lLnZzbUJsdXJTaXplID0gdGhpcy5fdnNtQmx1clNpemU7XG4gICAgY2xvbmUudnNtQmx1ck1vZGUgPSB0aGlzLnZzbUJsdXJNb2RlO1xuICAgIGNsb25lLnZzbUJpYXMgPSB0aGlzLnZzbUJpYXM7XG4gICAgY2xvbmUuc2hhZG93VXBkYXRlTW9kZSA9IHRoaXMuc2hhZG93VXBkYXRlTW9kZTtcbiAgICBjbG9uZS5tYXNrID0gdGhpcy5fbWFzaztcbiAgICBjbG9uZS5pbm5lckNvbmVBbmdsZSA9IHRoaXMuX2lubmVyQ29uZUFuZ2xlO1xuICAgIGNsb25lLm91dGVyQ29uZUFuZ2xlID0gdGhpcy5fb3V0ZXJDb25lQW5nbGU7XG4gICAgY2xvbmUuc2hhZG93QmlhcyA9IHRoaXMuc2hhZG93QmlhcztcbiAgICBjbG9uZS5ub3JtYWxPZmZzZXRCaWFzID0gdGhpcy5fbm9ybWFsT2Zmc2V0QmlhcztcbiAgICBjbG9uZS5zaGFkb3dSZXNvbHV0aW9uID0gdGhpcy5fc2hhZG93UmVzb2x1dGlvbjtcbiAgICBjbG9uZS5zaGFkb3dEaXN0YW5jZSA9IHRoaXMuc2hhZG93RGlzdGFuY2U7XG4gICAgcmV0dXJuIGNsb25lO1xuICB9LCBnZXRDb2xvcjpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY29sb3I7XG4gIH0sIGdldEJvdW5kaW5nU3BoZXJlOmZ1bmN0aW9uKHNwaGVyZSkge1xuICAgIGlmICh0aGlzLl90eXBlID09PSBwYy5MSUdIVFRZUEVfU1BPVCkge1xuICAgICAgdmFyIHJhbmdlID0gdGhpcy5hdHRlbnVhdGlvbkVuZDtcbiAgICAgIHZhciBhbmdsZSA9IHRoaXMuX291dGVyQ29uZUFuZ2xlO1xuICAgICAgdmFyIGYgPSBNYXRoLmNvcyhhbmdsZSAqIHBjLm1hdGguREVHX1RPX1JBRCk7XG4gICAgICB2YXIgbm9kZSA9IHRoaXMuX25vZGU7XG4gICAgICBzcG90Q2VudGVyLmNvcHkobm9kZS51cCk7XG4gICAgICBzcG90Q2VudGVyLnNjYWxlKC1yYW5nZSAqIDAuNSAqIGYpO1xuICAgICAgc3BvdENlbnRlci5hZGQobm9kZS5nZXRQb3NpdGlvbigpKTtcbiAgICAgIHNwaGVyZS5jZW50ZXIgPSBzcG90Q2VudGVyO1xuICAgICAgc3BvdEVuZFBvaW50LmNvcHkobm9kZS51cCk7XG4gICAgICBzcG90RW5kUG9pbnQuc2NhbGUoLXJhbmdlKTtcbiAgICAgIHRtcFZlYy5jb3B5KG5vZGUucmlnaHQpO1xuICAgICAgdG1wVmVjLnNjYWxlKE1hdGguc2luKGFuZ2xlICogcGMubWF0aC5ERUdfVE9fUkFEKSAqIHJhbmdlKTtcbiAgICAgIHNwb3RFbmRQb2ludC5hZGQodG1wVmVjKTtcbiAgICAgIHNwaGVyZS5yYWRpdXMgPSBzcG90RW5kUG9pbnQubGVuZ3RoKCkgKiAwLjU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl90eXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgICAgc3BoZXJlLmNlbnRlciA9IHRoaXMuX25vZGUuZ2V0UG9zaXRpb24oKTtcbiAgICAgICAgc3BoZXJlLnJhZGl1cyA9IHRoaXMuYXR0ZW51YXRpb25FbmQ7XG4gICAgICB9XG4gICAgfVxuICB9LCBnZXRCb3VuZGluZ0JveDpmdW5jdGlvbihib3gpIHtcbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgIHZhciByYW5nZSA9IHRoaXMuYXR0ZW51YXRpb25FbmQ7XG4gICAgICB2YXIgYW5nbGUgPSB0aGlzLl9vdXRlckNvbmVBbmdsZTtcbiAgICAgIHZhciBub2RlID0gdGhpcy5fbm9kZTtcbiAgICAgIHZhciBzY2wgPSBNYXRoLmFicyhNYXRoLnNpbihhbmdsZSAqIHBjLm1hdGguREVHX1RPX1JBRCkgKiByYW5nZSk7XG4gICAgICBib3guY2VudGVyLnNldCgwLCAtcmFuZ2UgKiAwLjUsIDApO1xuICAgICAgYm94LmhhbGZFeHRlbnRzLnNldChzY2wsIHJhbmdlICogMC41LCBzY2wpO1xuICAgICAgYm94LnNldEZyb21UcmFuc2Zvcm1lZEFhYmIoYm94LCBub2RlLmdldFdvcmxkVHJhbnNmb3JtKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICAgIGJveC5jZW50ZXIuY29weSh0aGlzLl9ub2RlLmdldFBvc2l0aW9uKCkpO1xuICAgICAgICBib3guaGFsZkV4dGVudHMuc2V0KHRoaXMuYXR0ZW51YXRpb25FbmQsIHRoaXMuYXR0ZW51YXRpb25FbmQsIHRoaXMuYXR0ZW51YXRpb25FbmQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgc2V0Q29sb3I6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHIsIGcsIGI7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHIgPSBhcmd1bWVudHNbMF0ucjtcbiAgICAgIGcgPSBhcmd1bWVudHNbMF0uZztcbiAgICAgIGIgPSBhcmd1bWVudHNbMF0uYjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHtcbiAgICAgICAgciA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgZyA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgYiA9IGFyZ3VtZW50c1syXTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fY29sb3Iuc2V0KHIsIGcsIGIpO1xuICAgIHZhciBpID0gdGhpcy5faW50ZW5zaXR5O1xuICAgIHRoaXMuX2ZpbmFsQ29sb3Iuc2V0KHIgKiBpLCBnICogaSwgYiAqIGkpO1xuICAgIGZvciAodmFyIGMgPSAwO2MgPCAzO2MrKykge1xuICAgICAgaWYgKGkgPj0gMSkge1xuICAgICAgICB0aGlzLl9saW5lYXJGaW5hbENvbG9yLmRhdGFbY10gPSBNYXRoLnBvdyh0aGlzLl9maW5hbENvbG9yLmRhdGFbY10gLyBpLCAyLjIpICogaTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX2xpbmVhckZpbmFsQ29sb3IuZGF0YVtjXSA9IE1hdGgucG93KHRoaXMuX2ZpbmFsQ29sb3IuZGF0YVtjXSwgMi4yKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9kZXN0cm95U2hhZG93TWFwOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9zaGFkb3dDYW1lcmEpIHtcbiAgICAgIGlmICghdGhpcy5faXNDYWNoZWRTaGFkb3dNYXApIHtcbiAgICAgICAgdmFyIHJ0ID0gdGhpcy5fc2hhZG93Q2FtZXJhLnJlbmRlclRhcmdldDtcbiAgICAgICAgdmFyIGk7XG4gICAgICAgIGlmIChydCkge1xuICAgICAgICAgIGlmIChydC5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IHJ0Lmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgICAgaWYgKHJ0W2ldLmNvbG9yQnVmZmVyKSB7XG4gICAgICAgICAgICAgICAgcnRbaV0uY29sb3JCdWZmZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJ0W2ldLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJ0LmNvbG9yQnVmZmVyKSB7XG4gICAgICAgICAgICAgIHJ0LmNvbG9yQnVmZmVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJ0LmRlc3Ryb3koKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuX3NoYWRvd0NhbWVyYS5yZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgICAgdGhpcy5fc2hhZG93Q2FtZXJhID0gbnVsbDtcbiAgICAgIHRoaXMuX3NoYWRvd0N1YmVNYXAgPSBudWxsO1xuICAgICAgaWYgKHRoaXMuc2hhZG93VXBkYXRlTW9kZSA9PT0gcGMuU0hBRE9XVVBEQVRFX05PTkUpIHtcbiAgICAgICAgdGhpcy5zaGFkb3dVcGRhdGVNb2RlID0gcGMuU0hBRE9XVVBEQVRFX1RISVNGUkFNRTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHVwZGF0ZVNoYWRvdzpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5zaGFkb3dVcGRhdGVNb2RlICE9PSBwYy5TSEFET1dVUERBVEVfUkVBTFRJTUUpIHtcbiAgICAgIHRoaXMuc2hhZG93VXBkYXRlTW9kZSA9IHBjLlNIQURPV1VQREFURV9USElTRlJBTUU7XG4gICAgfVxuICB9LCB1cGRhdGVLZXk6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGtleSA9IHRoaXMuX3R5cGUgPDwgMjkgfCAodGhpcy5fY2FzdFNoYWRvd3MgPyAxIDogMCkgPDwgMjggfCB0aGlzLl9zaGFkb3dUeXBlIDw8IDI1IHwgdGhpcy5fZmFsbG9mZk1vZGUgPDwgMjMgfCAodGhpcy5fbm9ybWFsT2Zmc2V0QmlhcyAhPT0gMC4wID8gMSA6IDApIDw8IDIyIHwgKHRoaXMuX2Nvb2tpZSA/IDEgOiAwKSA8PCAyMSB8ICh0aGlzLl9jb29raWVGYWxsb2ZmID8gMSA6IDApIDw8IDIwIHwgY2hhbklkW3RoaXMuX2Nvb2tpZUNoYW5uZWwuY2hhckF0KDApXSA8PCAxOCB8ICh0aGlzLl9jb29raWVUcmFuc2Zvcm0gPyAxIDogMCkgPDwgMTI7XG4gICAgaWYgKHRoaXMuX2Nvb2tpZUNoYW5uZWwubGVuZ3RoID09PSAzKSB7XG4gICAgICBrZXkgfD0gY2hhbklkW3RoaXMuX2Nvb2tpZUNoYW5uZWwuY2hhckF0KDEpXSA8PCAxNjtcbiAgICAgIGtleSB8PSBjaGFuSWRbdGhpcy5fY29va2llQ2hhbm5lbC5jaGFyQXQoMildIDw8IDE0O1xuICAgIH1cbiAgICB0aGlzLmtleSA9IGtleTtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodC5wcm90b3R5cGUsIFwiZW5hYmxlZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl90eXBlO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fZW5hYmxlZCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9zY2VuZSAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5fc2NlbmUudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodC5wcm90b3R5cGUsIFwidHlwZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl90eXBlO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fdHlwZSA9IHZhbHVlO1xuICAgIHRoaXMuX2Rlc3Ryb3lTaGFkb3dNYXAoKTtcbiAgICBpZiAodGhpcy5fc2NlbmUgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuX3NjZW5lLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUtleSgpO1xuICAgIHZhciBzdHlwZSA9IHRoaXMuX3NoYWRvd1R5cGU7XG4gICAgdGhpcy5fc2hhZG93VHlwZSA9IG51bGw7XG4gICAgdGhpcy5zaGFkb3dUeXBlID0gc3R5cGU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExpZ2h0LnByb3RvdHlwZSwgXCJtYXNrXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX21hc2s7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9tYXNrID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9tYXNrID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3NjZW5lICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExpZ2h0LnByb3RvdHlwZSwgXCJzaGFkb3dUeXBlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NoYWRvd1R5cGU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9zaGFkb3dUeXBlID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZGV2aWNlID0gcGMuQXBwbGljYXRpb24uZ2V0QXBwbGljYXRpb24oKS5ncmFwaGljc0RldmljZTtcbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1BPSU5UKSB7XG4gICAgICB2YWx1ZSA9IHBjLlNIQURPV19QQ0YzO1xuICAgIH1cbiAgICBpZiAodmFsdWUgPT09IHBjLlNIQURPV19QQ0Y1ICYmICFkZXZpY2Uud2ViZ2wyKSB7XG4gICAgICB2YWx1ZSA9IHBjLlNIQURPV19QQ0YzO1xuICAgIH1cbiAgICBpZiAodmFsdWUgPT09IHBjLlNIQURPV19WU00zMiAmJiAhZGV2aWNlLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUpIHtcbiAgICAgIHZhbHVlID0gcGMuU0hBRE9XX1ZTTTE2O1xuICAgIH1cbiAgICBpZiAodmFsdWUgPT09IHBjLlNIQURPV19WU00xNiAmJiAhZGV2aWNlLmV4dFRleHR1cmVIYWxmRmxvYXRSZW5kZXJhYmxlKSB7XG4gICAgICB2YWx1ZSA9IHBjLlNIQURPV19WU004O1xuICAgIH1cbiAgICB0aGlzLl9pc1ZzbSA9IHZhbHVlID49IHBjLlNIQURPV19WU004ICYmIHZhbHVlIDw9IHBjLlNIQURPV19WU00zMjtcbiAgICB0aGlzLl9pc1BjZiA9IHZhbHVlID09PSBwYy5TSEFET1dfUENGNSB8fCB2YWx1ZSA9PT0gcGMuU0hBRE9XX1BDRjM7XG4gICAgdGhpcy5fc2hhZG93VHlwZSA9IHZhbHVlO1xuICAgIHRoaXMuX2Rlc3Ryb3lTaGFkb3dNYXAoKTtcbiAgICBpZiAodGhpcy5fc2NlbmUgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuX3NjZW5lLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUtleSgpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodC5wcm90b3R5cGUsIFwiY2FzdFNoYWRvd3NcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY2FzdFNoYWRvd3MgJiYgdGhpcy5fbWFzayAhPT0gcGMuTUFTS19MSUdIVE1BUCAmJiB0aGlzLl9tYXNrICE9PSAwO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fY2FzdFNoYWRvd3MgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2Nhc3RTaGFkb3dzID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3NjZW5lICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVLZXkoKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcInNoYWRvd1Jlc29sdXRpb25cIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2hhZG93UmVzb2x1dGlvbjtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX3NoYWRvd1Jlc29sdXRpb24gPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBkZXZpY2UgPSBwYy5BcHBsaWNhdGlvbi5nZXRBcHBsaWNhdGlvbigpLmdyYXBoaWNzRGV2aWNlO1xuICAgIGlmICh0aGlzLl90eXBlID09PSBwYy5MSUdIVFRZUEVfUE9JTlQpIHtcbiAgICAgIHZhbHVlID0gTWF0aC5taW4odmFsdWUsIGRldmljZS5tYXhDdWJlTWFwU2l6ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbHVlID0gTWF0aC5taW4odmFsdWUsIGRldmljZS5tYXhUZXh0dXJlU2l6ZSk7XG4gICAgfVxuICAgIHRoaXMuX3NoYWRvd1Jlc29sdXRpb24gPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcInZzbUJsdXJTaXplXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZzbUJsdXJTaXplO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fdnNtQmx1clNpemUgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh2YWx1ZSAlIDIgPT09IDApIHtcbiAgICAgIHZhbHVlKys7XG4gICAgfVxuICAgIHRoaXMuX3ZzbUJsdXJTaXplID0gdmFsdWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExpZ2h0LnByb3RvdHlwZSwgXCJub3JtYWxPZmZzZXRCaWFzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX25vcm1hbE9mZnNldEJpYXM7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9ub3JtYWxPZmZzZXRCaWFzID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuX25vcm1hbE9mZnNldEJpYXMgJiYgdmFsdWUgfHwgdGhpcy5fbm9ybWFsT2Zmc2V0QmlhcyAmJiAhdmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLl9zY2VuZSAhPT0gbnVsbCkge1xuICAgICAgICB0aGlzLl9zY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMudXBkYXRlS2V5KCk7XG4gICAgfVxuICAgIHRoaXMuX25vcm1hbE9mZnNldEJpYXMgPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcImZhbGxvZmZNb2RlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZhbGxvZmZNb2RlO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5fZmFsbG9mZk1vZGUgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2ZhbGxvZmZNb2RlID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3NjZW5lICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVLZXkoKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcImlubmVyQ29uZUFuZ2xlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lubmVyQ29uZUFuZ2xlO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5faW5uZXJDb25lQW5nbGUgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2lubmVyQ29uZUFuZ2xlID0gdmFsdWU7XG4gICAgdGhpcy5faW5uZXJDb25lQW5nbGVDb3MgPSBNYXRoLmNvcyh2YWx1ZSAqIE1hdGguUEkgLyAxODApO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodC5wcm90b3R5cGUsIFwib3V0ZXJDb25lQW5nbGVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fb3V0ZXJDb25lQW5nbGU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9vdXRlckNvbmVBbmdsZSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fb3V0ZXJDb25lQW5nbGUgPSB2YWx1ZTtcbiAgICB0aGlzLl9vdXRlckNvbmVBbmdsZUNvcyA9IE1hdGguY29zKHZhbHVlICogTWF0aC5QSSAvIDE4MCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExpZ2h0LnByb3RvdHlwZSwgXCJpbnRlbnNpdHlcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faW50ZW5zaXR5O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodGhpcy5faW50ZW5zaXR5ID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbnRlbnNpdHkgPSB2YWx1ZTtcbiAgICB2YXIgYyA9IHRoaXMuX2NvbG9yLmRhdGE7XG4gICAgdmFyIHIgPSBjWzBdO1xuICAgIHZhciBnID0gY1sxXTtcbiAgICB2YXIgYiA9IGNbMl07XG4gICAgdmFyIGkgPSB0aGlzLl9pbnRlbnNpdHk7XG4gICAgdGhpcy5fZmluYWxDb2xvci5zZXQociAqIGksIGcgKiBpLCBiICogaSk7XG4gICAgZm9yICh2YXIgaiA9IDA7aiA8IDM7aisrKSB7XG4gICAgICBpZiAoaSA+PSAxKSB7XG4gICAgICAgIHRoaXMuX2xpbmVhckZpbmFsQ29sb3IuZGF0YVtqXSA9IE1hdGgucG93KHRoaXMuX2ZpbmFsQ29sb3IuZGF0YVtqXSAvIGksIDIuMikgKiBpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fbGluZWFyRmluYWxDb2xvci5kYXRhW2pdID0gTWF0aC5wb3codGhpcy5fZmluYWxDb2xvci5kYXRhW2pdLCAyLjIpO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcImNvb2tpZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jb29raWU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9jb29raWUgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2Nvb2tpZSA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9zY2VuZSAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5fc2NlbmUudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlS2V5KCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExpZ2h0LnByb3RvdHlwZSwgXCJjb29raWVGYWxsb2ZmXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Nvb2tpZUZhbGxvZmY7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9jb29raWVGYWxsb2ZmID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jb29raWVGYWxsb2ZmID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3NjZW5lICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVLZXkoKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcImNvb2tpZUNoYW5uZWxcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY29va2llQ2hhbm5lbDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX2Nvb2tpZUNoYW5uZWwgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh2YWx1ZS5sZW5ndGggPCAzKSB7XG4gICAgICB2YXIgY2hyID0gdmFsdWUuY2hhckF0KHZhbHVlLmxlbmd0aCAtIDEpO1xuICAgICAgdmFyIGFkZExlbiA9IDMgLSB2YWx1ZS5sZW5ndGg7XG4gICAgICBmb3IgKHZhciBpID0gMDtpIDwgYWRkTGVuO2krKykge1xuICAgICAgICB2YWx1ZSArPSBjaHI7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2Nvb2tpZUNoYW5uZWwgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5fc2NlbmUgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuX3NjZW5lLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUtleSgpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodC5wcm90b3R5cGUsIFwiY29va2llVHJhbnNmb3JtXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Nvb2tpZVRyYW5zZm9ybTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX2Nvb2tpZVRyYW5zZm9ybSA9PT0gdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHhmb3JtT2xkID0gISEodGhpcy5fY29va2llVHJhbnNmb3JtU2V0IHx8IHRoaXMuX2Nvb2tpZU9mZnNldFNldCk7XG4gICAgdmFyIHhmb3JtTmV3ID0gISEodmFsdWUgfHwgdGhpcy5fY29va2llT2Zmc2V0U2V0KTtcbiAgICBpZiAoeGZvcm1PbGQgIT09IHhmb3JtTmV3KSB7XG4gICAgICBpZiAodGhpcy5fc2NlbmUgIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5fc2NlbmUudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2Nvb2tpZVRyYW5zZm9ybSA9IHZhbHVlO1xuICAgIHRoaXMuX2Nvb2tpZVRyYW5zZm9ybVNldCA9ICEhdmFsdWU7XG4gICAgaWYgKHZhbHVlICYmICF0aGlzLl9jb29raWVPZmZzZXQpIHtcbiAgICAgIHRoaXMuY29va2llT2Zmc2V0ID0gbmV3IHBjLlZlYzI7XG4gICAgICB0aGlzLl9jb29raWVPZmZzZXRTZXQgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVLZXkoKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGlnaHQucHJvdG90eXBlLCBcImNvb2tpZU9mZnNldFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jb29raWVPZmZzZXQ7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9jb29raWVPZmZzZXQgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciB4Zm9ybU9sZCA9ICEhKHRoaXMuX2Nvb2tpZVRyYW5zZm9ybVNldCB8fCB0aGlzLl9jb29raWVPZmZzZXRTZXQpO1xuICAgIHZhciB4Zm9ybU5ldyA9ICEhKHRoaXMuX2Nvb2tpZVRyYW5zZm9ybVNldCB8fCB2YWx1ZSk7XG4gICAgaWYgKHhmb3JtT2xkICE9PSB4Zm9ybU5ldykge1xuICAgICAgaWYgKHRoaXMuX3NjZW5lICE9PSBudWxsKSB7XG4gICAgICAgIHRoaXMuX3NjZW5lLnVwZGF0ZVNoYWRlcnMgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoeGZvcm1OZXcgJiYgIXZhbHVlICYmIHRoaXMuX2Nvb2tpZU9mZnNldCkge1xuICAgICAgdGhpcy5fY29va2llT2Zmc2V0LnNldCgwLCAwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fY29va2llT2Zmc2V0ID0gdmFsdWU7XG4gICAgfVxuICAgIHRoaXMuX2Nvb2tpZU9mZnNldFNldCA9ICEhdmFsdWU7XG4gICAgaWYgKHZhbHVlICYmICF0aGlzLl9jb29raWVUcmFuc2Zvcm0pIHtcbiAgICAgIHRoaXMuY29va2llVHJhbnNmb3JtID0gbmV3IHBjLlZlYzQoMSwgMSwgMCwgMCk7XG4gICAgICB0aGlzLl9jb29raWVUcmFuc2Zvcm1TZXQgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVLZXkoKTtcbiAgfX0pO1xuICByZXR1cm4ge0xpZ2h0OkxpZ2h0fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgaWQgPSAwO1xuICB2YXIgTWF0ZXJpYWwgPSBmdW5jdGlvbiBNYXRlcmlhbCgpIHtcbiAgICB0aGlzLm5hbWUgPSBcIlVudGl0bGVkXCI7XG4gICAgdGhpcy5pZCA9IGlkKys7XG4gICAgdGhpcy5fc2hhZGVyID0gbnVsbDtcbiAgICB0aGlzLnZhcmlhbnRzID0ge307XG4gICAgdGhpcy5wYXJhbWV0ZXJzID0ge307XG4gICAgdGhpcy5hbHBoYVRlc3QgPSAwO1xuICAgIHRoaXMuYWxwaGFUb0NvdmVyYWdlID0gZmFsc2U7XG4gICAgdGhpcy5ibGVuZCA9IGZhbHNlO1xuICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfT05FO1xuICAgIHRoaXMuYmxlbmREc3QgPSBwYy5CTEVORE1PREVfWkVSTztcbiAgICB0aGlzLmJsZW5kRXF1YXRpb24gPSBwYy5CTEVOREVRVUFUSU9OX0FERDtcbiAgICB0aGlzLnNlcGFyYXRlQWxwaGFCbGVuZCA9IGZhbHNlO1xuICAgIHRoaXMuYmxlbmRTcmNBbHBoYSA9IHBjLkJMRU5ETU9ERV9PTkU7XG4gICAgdGhpcy5ibGVuZERzdEFscGhhID0gcGMuQkxFTkRNT0RFX1pFUk87XG4gICAgdGhpcy5ibGVuZEFscGhhRXF1YXRpb24gPSBwYy5CTEVOREVRVUFUSU9OX0FERDtcbiAgICB0aGlzLmN1bGwgPSBwYy5DVUxMRkFDRV9CQUNLO1xuICAgIHRoaXMuZGVwdGhUZXN0ID0gdHJ1ZTtcbiAgICB0aGlzLmRlcHRoV3JpdGUgPSB0cnVlO1xuICAgIHRoaXMuc3RlbmNpbEZyb250ID0gbnVsbDtcbiAgICB0aGlzLnN0ZW5jaWxCYWNrID0gbnVsbDtcbiAgICB0aGlzLnJlZFdyaXRlID0gdHJ1ZTtcbiAgICB0aGlzLmdyZWVuV3JpdGUgPSB0cnVlO1xuICAgIHRoaXMuYmx1ZVdyaXRlID0gdHJ1ZTtcbiAgICB0aGlzLmFscGhhV3JpdGUgPSB0cnVlO1xuICAgIHRoaXMubWVzaEluc3RhbmNlcyA9IFtdO1xuICB9O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWF0ZXJpYWwucHJvdG90eXBlLCBcInNoYWRlclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zaGFkZXI7XG4gIH0sIHNldDpmdW5jdGlvbihzaGFkZXIpIHtcbiAgICB0aGlzLnNldFNoYWRlcihzaGFkZXIpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNYXRlcmlhbC5wcm90b3R5cGUsIFwiYmxlbmRUeXBlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmJsZW5kICYmIHRoaXMuYmxlbmRTcmMgPT09IHBjLkJMRU5ETU9ERV9PTkUgJiYgdGhpcy5ibGVuZERzdCA9PT0gcGMuQkxFTkRNT0RFX1pFUk8gJiYgdGhpcy5ibGVuZEVxdWF0aW9uID09PSBwYy5CTEVOREVRVUFUSU9OX0FERCkge1xuICAgICAgcmV0dXJuIHBjLkJMRU5EX05PTkU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmJsZW5kICYmIHRoaXMuYmxlbmRTcmMgPT09IHBjLkJMRU5ETU9ERV9TUkNfQUxQSEEgJiYgdGhpcy5ibGVuZERzdCA9PT0gcGMuQkxFTkRNT0RFX09ORV9NSU5VU19TUkNfQUxQSEEgJiYgdGhpcy5ibGVuZEVxdWF0aW9uID09PSBwYy5CTEVOREVRVUFUSU9OX0FERCkge1xuICAgICAgICByZXR1cm4gcGMuQkxFTkRfTk9STUFMO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuYmxlbmQgJiYgdGhpcy5ibGVuZFNyYyA9PT0gcGMuQkxFTkRNT0RFX09ORSAmJiB0aGlzLmJsZW5kRHN0ID09PSBwYy5CTEVORE1PREVfT05FICYmIHRoaXMuYmxlbmRFcXVhdGlvbiA9PT0gcGMuQkxFTkRFUVVBVElPTl9BREQpIHtcbiAgICAgICAgICByZXR1cm4gcGMuQkxFTkRfQURESVRJVkU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHRoaXMuYmxlbmQgJiYgdGhpcy5ibGVuZFNyYyA9PT0gcGMuQkxFTkRNT0RFX1NSQ19BTFBIQSAmJiB0aGlzLmJsZW5kRHN0ID09PSBwYy5CTEVORE1PREVfT05FICYmIHRoaXMuYmxlbmRFcXVhdGlvbiA9PT0gcGMuQkxFTkRFUVVBVElPTl9BREQpIHtcbiAgICAgICAgICAgIHJldHVybiBwYy5CTEVORF9BRERJVElWRUFMUEhBO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5ibGVuZCAmJiB0aGlzLmJsZW5kU3JjID09PSBwYy5CTEVORE1PREVfRFNUX0NPTE9SICYmIHRoaXMuYmxlbmREc3QgPT09IHBjLkJMRU5ETU9ERV9TUkNfQ09MT1IgJiYgdGhpcy5ibGVuZEVxdWF0aW9uID09PSBwYy5CTEVOREVRVUFUSU9OX0FERCkge1xuICAgICAgICAgICAgICByZXR1cm4gcGMuQkxFTkRfTVVMVElQTElDQVRJVkUyWDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmICh0aGlzLmJsZW5kICYmIHRoaXMuYmxlbmRTcmMgPT09IHBjLkJMRU5ETU9ERV9PTkVfTUlOVVNfRFNUX0NPTE9SICYmIHRoaXMuYmxlbmREc3QgPT09IHBjLkJMRU5ETU9ERV9PTkUgJiYgdGhpcy5ibGVuZEVxdWF0aW9uID09PSBwYy5CTEVOREVRVUFUSU9OX0FERCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYy5CTEVORF9TQ1JFRU47XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYmxlbmQgJiYgdGhpcy5ibGVuZFNyYyA9PT0gcGMuQkxFTkRNT0RFX09ORSAmJiB0aGlzLmJsZW5kRHN0ID09PSBwYy5CTEVORE1PREVfT05FICYmIHRoaXMuYmxlbmRFcXVhdGlvbiA9PT0gcGMuQkxFTkRFUVVBVElPTl9NSU4pIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBwYy5CTEVORF9NSU47XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmJsZW5kICYmIHRoaXMuYmxlbmRTcmMgPT09IHBjLkJMRU5ETU9ERV9PTkUgJiYgdGhpcy5ibGVuZERzdCA9PT0gcGMuQkxFTkRNT0RFX09ORSAmJiB0aGlzLmJsZW5kRXF1YXRpb24gPT09IHBjLkJMRU5ERVFVQVRJT05fTUFYKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYy5CTEVORF9NQVg7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5ibGVuZCAmJiB0aGlzLmJsZW5kU3JjID09PSBwYy5CTEVORE1PREVfRFNUX0NPTE9SICYmIHRoaXMuYmxlbmREc3QgPT09IHBjLkJMRU5ETU9ERV9aRVJPICYmIHRoaXMuYmxlbmRFcXVhdGlvbiA9PT0gcGMuQkxFTkRFUVVBVElPTl9BREQpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGMuQkxFTkRfTVVMVElQTElDQVRJVkU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmxlbmQgJiYgdGhpcy5ibGVuZFNyYyA9PT0gcGMuQkxFTkRNT0RFX09ORSAmJiB0aGlzLmJsZW5kRHN0ID09PSBwYy5CTEVORE1PREVfT05FX01JTlVTX1NSQ19BTFBIQSAmJiB0aGlzLmJsZW5kRXF1YXRpb24gPT09IHBjLkJMRU5ERVFVQVRJT05fQUREKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGMuQkxFTkRfUFJFTVVMVElQTElFRDtcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBjLkJMRU5EX05PUk1BTDtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIHNldDpmdW5jdGlvbih0eXBlKSB7XG4gICAgc3dpdGNoKHR5cGUpIHtcbiAgICAgIGNhc2UgcGMuQkxFTkRfTk9ORTpcbiAgICAgICAgdGhpcy5ibGVuZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmJsZW5kU3JjID0gcGMuQkxFTkRNT0RFX09ORTtcbiAgICAgICAgdGhpcy5ibGVuZERzdCA9IHBjLkJMRU5ETU9ERV9aRVJPO1xuICAgICAgICB0aGlzLmJsZW5kRXF1YXRpb24gPSBwYy5CTEVOREVRVUFUSU9OX0FERDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLkJMRU5EX05PUk1BTDpcbiAgICAgICAgdGhpcy5ibGVuZCA9IHRydWU7XG4gICAgICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfU1JDX0FMUEhBO1xuICAgICAgICB0aGlzLmJsZW5kRHN0ID0gcGMuQkxFTkRNT0RFX09ORV9NSU5VU19TUkNfQUxQSEE7XG4gICAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IHBjLkJMRU5ERVFVQVRJT05fQUREO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuQkxFTkRfUFJFTVVMVElQTElFRDpcbiAgICAgICAgdGhpcy5ibGVuZCA9IHRydWU7XG4gICAgICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfT05FO1xuICAgICAgICB0aGlzLmJsZW5kRHN0ID0gcGMuQkxFTkRNT0RFX09ORV9NSU5VU19TUkNfQUxQSEE7XG4gICAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IHBjLkJMRU5ERVFVQVRJT05fQUREO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuQkxFTkRfQURESVRJVkU6XG4gICAgICAgIHRoaXMuYmxlbmQgPSB0cnVlO1xuICAgICAgICB0aGlzLmJsZW5kU3JjID0gcGMuQkxFTkRNT0RFX09ORTtcbiAgICAgICAgdGhpcy5ibGVuZERzdCA9IHBjLkJMRU5ETU9ERV9PTkU7XG4gICAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IHBjLkJMRU5ERVFVQVRJT05fQUREO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuQkxFTkRfQURESVRJVkVBTFBIQTpcbiAgICAgICAgdGhpcy5ibGVuZCA9IHRydWU7XG4gICAgICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfU1JDX0FMUEhBO1xuICAgICAgICB0aGlzLmJsZW5kRHN0ID0gcGMuQkxFTkRNT0RFX09ORTtcbiAgICAgICAgdGhpcy5ibGVuZEVxdWF0aW9uID0gcGMuQkxFTkRFUVVBVElPTl9BREQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5CTEVORF9NVUxUSVBMSUNBVElWRTJYOlxuICAgICAgICB0aGlzLmJsZW5kID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5ibGVuZFNyYyA9IHBjLkJMRU5ETU9ERV9EU1RfQ09MT1I7XG4gICAgICAgIHRoaXMuYmxlbmREc3QgPSBwYy5CTEVORE1PREVfU1JDX0NPTE9SO1xuICAgICAgICB0aGlzLmJsZW5kRXF1YXRpb24gPSBwYy5CTEVOREVRVUFUSU9OX0FERDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLkJMRU5EX1NDUkVFTjpcbiAgICAgICAgdGhpcy5ibGVuZCA9IHRydWU7XG4gICAgICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfT05FX01JTlVTX0RTVF9DT0xPUjtcbiAgICAgICAgdGhpcy5ibGVuZERzdCA9IHBjLkJMRU5ETU9ERV9PTkU7XG4gICAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IHBjLkJMRU5ERVFVQVRJT05fQUREO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgcGMuQkxFTkRfTVVMVElQTElDQVRJVkU6XG4gICAgICAgIHRoaXMuYmxlbmQgPSB0cnVlO1xuICAgICAgICB0aGlzLmJsZW5kU3JjID0gcGMuQkxFTkRNT0RFX0RTVF9DT0xPUjtcbiAgICAgICAgdGhpcy5ibGVuZERzdCA9IHBjLkJMRU5ETU9ERV9aRVJPO1xuICAgICAgICB0aGlzLmJsZW5kRXF1YXRpb24gPSBwYy5CTEVOREVRVUFUSU9OX0FERDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHBjLkJMRU5EX01JTjpcbiAgICAgICAgdGhpcy5ibGVuZCA9IHRydWU7XG4gICAgICAgIHRoaXMuYmxlbmRTcmMgPSBwYy5CTEVORE1PREVfT05FO1xuICAgICAgICB0aGlzLmJsZW5kRHN0ID0gcGMuQkxFTkRNT0RFX09ORTtcbiAgICAgICAgdGhpcy5ibGVuZEVxdWF0aW9uID0gcGMuQkxFTkRFUVVBVElPTl9NSU47XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBwYy5CTEVORF9NQVg6XG4gICAgICAgIHRoaXMuYmxlbmQgPSB0cnVlO1xuICAgICAgICB0aGlzLmJsZW5kU3JjID0gcGMuQkxFTkRNT0RFX09ORTtcbiAgICAgICAgdGhpcy5ibGVuZERzdCA9IHBjLkJMRU5ETU9ERV9PTkU7XG4gICAgICAgIHRoaXMuYmxlbmRFcXVhdGlvbiA9IHBjLkJMRU5ERVFVQVRJT05fTUFYO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgdGhpcy5fdXBkYXRlTWVzaEluc3RhbmNlS2V5cygpO1xuICB9fSk7XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5fY2xvbmVJbnRlcm5hbCA9IGZ1bmN0aW9uKGNsb25lKSB7XG4gICAgY2xvbmUubmFtZSA9IHRoaXMubmFtZTtcbiAgICBjbG9uZS5pZCA9IGlkKys7XG4gICAgY2xvbmUudmFyaWFudHMgPSB7fTtcbiAgICBjbG9uZS5zaGFkZXIgPSB0aGlzLnNoYWRlcjtcbiAgICBjbG9uZS5wYXJhbWV0ZXJzID0ge307XG4gICAgZm9yICh2YXIgcGFyYW1ldGVyTmFtZSBpbiB0aGlzLnBhcmFtZXRlcnMpIHtcbiAgICAgIGlmICh0aGlzLnBhcmFtZXRlcnMuaGFzT3duUHJvcGVydHkocGFyYW1ldGVyTmFtZSkpIHtcbiAgICAgICAgY2xvbmUucGFyYW1ldGVyc1twYXJhbWV0ZXJOYW1lXSA9IHtzY29wZUlkOm51bGwsIGRhdGE6dGhpcy5wYXJhbWV0ZXJzW3BhcmFtZXRlck5hbWVdLmRhdGF9O1xuICAgICAgfVxuICAgIH1cbiAgICBjbG9uZS5hbHBoYVRlc3QgPSB0aGlzLmFscGhhVGVzdDtcbiAgICBjbG9uZS5hbHBoYVRvQ292ZXJhZ2UgPSB0aGlzLmFscGhhVG9Db3ZlcmFnZTtcbiAgICBjbG9uZS5ibGVuZCA9IHRoaXMuYmxlbmQ7XG4gICAgY2xvbmUuYmxlbmRTcmMgPSB0aGlzLmJsZW5kU3JjO1xuICAgIGNsb25lLmJsZW5kRHN0ID0gdGhpcy5ibGVuZERzdDtcbiAgICBjbG9uZS5ibGVuZEVxdWF0aW9uID0gdGhpcy5ibGVuZEVxdWF0aW9uO1xuICAgIGNsb25lLnNlcGFyYXRlQWxwaGFCbGVuZCA9IHRoaXMuc2VwYXJhdGVBbHBoYUJsZW5kO1xuICAgIGNsb25lLmJsZW5kU3JjQWxwaGEgPSB0aGlzLmJsZW5kU3JjQWxwaGE7XG4gICAgY2xvbmUuYmxlbmREc3RBbHBoYSA9IHRoaXMuYmxlbmREc3RBbHBoYTtcbiAgICBjbG9uZS5ibGVuZEFscGhhRXF1YXRpb24gPSB0aGlzLmJsZW5kQWxwaGFFcXVhdGlvbjtcbiAgICBjbG9uZS5jdWxsID0gdGhpcy5jdWxsO1xuICAgIGNsb25lLmRlcHRoVGVzdCA9IHRoaXMuZGVwdGhUZXN0O1xuICAgIGNsb25lLmRlcHRoV3JpdGUgPSB0aGlzLmRlcHRoV3JpdGU7XG4gICAgaWYgKHRoaXMuc3RlbmNpbEZyb250KSB7XG4gICAgICBjbG9uZS5zdGVuY2lsRnJvbnQgPSB0aGlzLnN0ZW5jaWxGcm9udC5jbG9uZSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGVuY2lsQmFjaykge1xuICAgICAgaWYgKHRoaXMuc3RlbmNpbEZyb250ID09PSB0aGlzLnN0ZW5jaWxCYWNrKSB7XG4gICAgICAgIGNsb25lLnN0ZW5jaWxCYWNrID0gY2xvbmUuc3RlbmNpbEZyb250O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xvbmUuc3RlbmNpbEJhY2sgPSB0aGlzLnN0ZW5jaWxCYWNrLmNsb25lKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNsb25lLnJlZFdyaXRlID0gdGhpcy5yZWRXcml0ZTtcbiAgICBjbG9uZS5ncmVlbldyaXRlID0gdGhpcy5ncmVlbldyaXRlO1xuICAgIGNsb25lLmJsdWVXcml0ZSA9IHRoaXMuYmx1ZVdyaXRlO1xuICAgIGNsb25lLmFscGhhV3JpdGUgPSB0aGlzLmFscGhhV3JpdGU7XG4gICAgY2xvbmUubWVzaEluc3RhbmNlcyA9IFtdO1xuICB9O1xuICBNYXRlcmlhbC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY2xvbmUgPSBuZXcgcGMuTWF0ZXJpYWw7XG4gICAgdGhpcy5fY2xvbmVJbnRlcm5hbChjbG9uZSk7XG4gICAgcmV0dXJuIGNsb25lO1xuICB9O1xuICBNYXRlcmlhbC5wcm90b3R5cGUuX3VwZGF0ZU1lc2hJbnN0YW5jZUtleXMgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgaSwgbWVzaEluc3RhbmNlcyA9IHRoaXMubWVzaEluc3RhbmNlcztcbiAgICBmb3IgKGkgPSAwO2kgPCBtZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIG1lc2hJbnN0YW5jZXNbaV0udXBkYXRlS2V5KCk7XG4gICAgfVxuICB9O1xuICBNYXRlcmlhbC5wcm90b3R5cGUudXBkYXRlU2hhZGVyID0gZnVuY3Rpb24oZGV2aWNlLCBzY2VuZSwgb2JqRGVmcykge1xuICB9O1xuICBNYXRlcmlhbC5wcm90b3R5cGUuY2xlYXJQYXJhbWV0ZXJzID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5wYXJhbWV0ZXJzID0ge307XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5nZXRQYXJhbWV0ZXJzID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyYW1ldGVycztcbiAgfTtcbiAgTWF0ZXJpYWwucHJvdG90eXBlLmNsZWFyVmFyaWFudHMgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgbWVzaEluc3RhbmNlO1xuICAgIGZvciAodmFyIHMgaW4gdGhpcy52YXJpYW50cykge1xuICAgICAgaWYgKHRoaXMudmFyaWFudHMuaGFzT3duUHJvcGVydHkocykpIHtcbiAgICAgICAgdGhpcy52YXJpYW50c1tzXS5fcmVmQ291bnQtLTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy52YXJpYW50cyA9IHt9O1xuICAgIHZhciBqO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLm1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgbWVzaEluc3RhbmNlID0gdGhpcy5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgZm9yIChqID0gMDtqIDwgbWVzaEluc3RhbmNlLl9zaGFkZXIubGVuZ3RoO2orKykge1xuICAgICAgICBtZXNoSW5zdGFuY2UuX3NoYWRlcltqXSA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBNYXRlcmlhbC5wcm90b3R5cGUuZ2V0UGFyYW1ldGVyID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHJldHVybiB0aGlzLnBhcmFtZXRlcnNbbmFtZV07XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5zZXRQYXJhbWV0ZXIgPSBmdW5jdGlvbihhcmcsIGRhdGEsIHBhc3NGbGFncykge1xuICAgIGlmIChwYXNzRmxhZ3MgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcGFzc0ZsYWdzID0gMSA8PCBwYy5TSEFERVJfRk9SV0FSRCB8IDEgPDwgcGMuU0hBREVSX0ZPUldBUkRIRFI7XG4gICAgfVxuICAgIHZhciBuYW1lO1xuICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIGFyZyA9PT0gXCJvYmplY3RcIikge1xuICAgICAgdmFyIHVuaWZvcm1PYmplY3QgPSBhcmc7XG4gICAgICBpZiAodW5pZm9ybU9iamVjdC5sZW5ndGgpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IHVuaWZvcm1PYmplY3QubGVuZ3RoO2krKykge1xuICAgICAgICAgIHRoaXMuc2V0UGFyYW1ldGVyKHVuaWZvcm1PYmplY3RbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5hbWUgPSB1bmlmb3JtT2JqZWN0Lm5hbWU7XG4gICAgICAgIGRhdGEgPSB1bmlmb3JtT2JqZWN0LnZhbHVlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBuYW1lID0gYXJnO1xuICAgIH1cbiAgICB2YXIgcGFyYW0gPSB0aGlzLnBhcmFtZXRlcnNbbmFtZV07XG4gICAgaWYgKHBhcmFtKSB7XG4gICAgICBwYXJhbS5kYXRhID0gZGF0YTtcbiAgICAgIHBhcmFtLnBhc3NGbGFncyA9IHBhc3NGbGFncztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wYXJhbWV0ZXJzW25hbWVdID0ge3Njb3BlSWQ6bnVsbCwgZGF0YTpkYXRhLCBwYXNzRmxhZ3M6cGFzc0ZsYWdzfTtcbiAgICB9XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5kZWxldGVQYXJhbWV0ZXIgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgaWYgKHRoaXMucGFyYW1ldGVyc1tuYW1lXSkge1xuICAgICAgZGVsZXRlIHRoaXMucGFyYW1ldGVyc1tuYW1lXTtcbiAgICB9XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5zZXRQYXJhbWV0ZXJzID0gZnVuY3Rpb24oKSB7XG4gICAgZm9yICh2YXIgcGFyYW1OYW1lIGluIHRoaXMucGFyYW1ldGVycykge1xuICAgICAgdmFyIHBhcmFtZXRlciA9IHRoaXMucGFyYW1ldGVyc1twYXJhbU5hbWVdO1xuICAgICAgcGFyYW1ldGVyLnNjb3BlSWQuc2V0VmFsdWUocGFyYW1ldGVyLmRhdGEpO1xuICAgIH1cbiAgfTtcbiAgTWF0ZXJpYWwucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHRocm93IEVycm9yKFwiTm90IEltcGxlbWVudGVkIGluIGJhc2UgY2xhc3NcIik7XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oZGF0YSkge1xuICAgIHRocm93IEVycm9yKFwiTm90IEltcGxlbWVudGVkIGluIGJhc2UgY2xhc3NcIik7XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5nZXROYW1lID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubmFtZTtcbiAgfTtcbiAgTWF0ZXJpYWwucHJvdG90eXBlLnNldE5hbWUgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfTtcbiAgTWF0ZXJpYWwucHJvdG90eXBlLmdldFNoYWRlciA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnNoYWRlcjtcbiAgfTtcbiAgTWF0ZXJpYWwucHJvdG90eXBlLnNldFNoYWRlciA9IGZ1bmN0aW9uKHNoYWRlcikge1xuICAgIGlmICh0aGlzLl9zaGFkZXIpIHtcbiAgICAgIHRoaXMuX3NoYWRlci5fcmVmQ291bnQtLTtcbiAgICB9XG4gICAgdGhpcy5fc2hhZGVyID0gc2hhZGVyO1xuICAgIGlmIChzaGFkZXIpIHtcbiAgICAgIHNoYWRlci5fcmVmQ291bnQrKztcbiAgICB9XG4gIH07XG4gIE1hdGVyaWFsLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuc2hhZGVyKSB7XG4gICAgICB0aGlzLnNoYWRlci5fcmVmQ291bnQtLTtcbiAgICAgIGlmICh0aGlzLnNoYWRlci5fcmVmQ291bnQgPCAxKSB7XG4gICAgICAgIHRoaXMuc2hhZGVyLmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIHZhcmlhbnQ7XG4gICAgZm9yICh2YXIgcyBpbiB0aGlzLnZhcmlhbnRzKSB7XG4gICAgICBpZiAodGhpcy52YXJpYW50cy5oYXNPd25Qcm9wZXJ0eShzKSkge1xuICAgICAgICB2YXJpYW50ID0gdGhpcy52YXJpYW50c1tzXTtcbiAgICAgICAgaWYgKHZhcmlhbnQgPT09IHRoaXMuc2hhZGVyKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyaWFudC5fcmVmQ291bnQtLTtcbiAgICAgICAgaWYgKHZhcmlhbnQuX3JlZkNvdW50IDwgMSkge1xuICAgICAgICAgIHZhcmlhbnQuZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMudmFyaWFudHMgPSB7fTtcbiAgICB0aGlzLnNoYWRlciA9IG51bGw7XG4gICAgdmFyIG1lc2hJbnN0YW5jZSwgajtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5tZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIG1lc2hJbnN0YW5jZSA9IHRoaXMubWVzaEluc3RhbmNlc1tpXTtcbiAgICAgIGZvciAoaiA9IDA7aiA8IG1lc2hJbnN0YW5jZS5fc2hhZGVyLmxlbmd0aDtqKyspIHtcbiAgICAgICAgbWVzaEluc3RhbmNlLl9zaGFkZXJbal0gPSBudWxsO1xuICAgICAgfVxuICAgICAgbWVzaEluc3RhbmNlLl9tYXRlcmlhbCA9IG51bGw7XG4gICAgICBpZiAodGhpcyAhPT0gcGMuU2NlbmUuZGVmYXVsdE1hdGVyaWFsKSB7XG4gICAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IHBjLlNjZW5lLmRlZmF1bHRNYXRlcmlhbDtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIHZhciBTdGVuY2lsUGFyYW1ldGVycyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICB0aGlzLmZ1bmMgPSBvcHRpb25zLmZ1bmMgPT09IHVuZGVmaW5lZCA/IHBjLkZVTkNfQUxXQVlTIDogb3B0aW9ucy5mdW5jO1xuICAgIHRoaXMucmVmID0gb3B0aW9ucy5yZWYgfHwgMDtcbiAgICB0aGlzLnJlYWRNYXNrID0gb3B0aW9ucy5yZWFkTWFzayA9PT0gdW5kZWZpbmVkID8gMjU1IDogb3B0aW9ucy5yZWFkTWFzaztcbiAgICB0aGlzLndyaXRlTWFzayA9IG9wdGlvbnMud3JpdGVNYXNrID09PSB1bmRlZmluZWQgPyAyNTUgOiBvcHRpb25zLndyaXRlTWFzaztcbiAgICB0aGlzLmZhaWwgPSBvcHRpb25zLmZhaWwgfHwgcGMuU1RFTkNJTE9QX0tFRVA7XG4gICAgdGhpcy56ZmFpbCA9IG9wdGlvbnMuemZhaWwgfHwgcGMuU1RFTkNJTE9QX0tFRVA7XG4gICAgdGhpcy56cGFzcyA9IG9wdGlvbnMuenBhc3MgfHwgcGMuU1RFTkNJTE9QX0tFRVA7XG4gIH07XG4gIFN0ZW5jaWxQYXJhbWV0ZXJzLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5TdGVuY2lsUGFyYW1ldGVycyh7ZnVuYzp0aGlzLmZ1bmMsIHJlZjp0aGlzLnJlZiwgcmVhZE1hc2s6dGhpcy5yZWFkTWFzaywgd3JpdGVNYXNrOnRoaXMud3JpdGVNYXNrLCBmYWlsOnRoaXMuZmFpbCwgemZhaWw6dGhpcy56ZmFpbCwgenBhc3M6dGhpcy56cGFzc30pO1xuICAgIHJldHVybiBjbG9uZTtcbiAgfTtcbiAgcmV0dXJuIHtNYXRlcmlhbDpNYXRlcmlhbCwgU3RlbmNpbFBhcmFtZXRlcnM6U3RlbmNpbFBhcmFtZXRlcnN9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBCYXNpY01hdGVyaWFsID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jb2xvciA9IG5ldyBwYy5Db2xvcigxLCAxLCAxLCAxKTtcbiAgICB0aGlzLmNvbG9yTWFwID0gbnVsbDtcbiAgICB0aGlzLnZlcnRleENvbG9ycyA9IGZhbHNlO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH07XG4gIEJhc2ljTWF0ZXJpYWwgPSBwYy5pbmhlcml0cyhCYXNpY01hdGVyaWFsLCBwYy5NYXRlcmlhbCk7XG4gIHBjLmV4dGVuZChCYXNpY01hdGVyaWFsLnByb3RvdHlwZSwge2Nsb25lOmZ1bmN0aW9uKCkge1xuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5CYXNpY01hdGVyaWFsO1xuICAgIHBjLk1hdGVyaWFsLnByb3RvdHlwZS5fY2xvbmVJbnRlcm5hbC5jYWxsKHRoaXMsIGNsb25lKTtcbiAgICBjbG9uZS5jb2xvci5jb3B5KHRoaXMuY29sb3IpO1xuICAgIGNsb25lLmNvbG9yTWFwID0gdGhpcy5jb2xvck1hcDtcbiAgICBjbG9uZS52ZXJ0ZXhDb2xvcnMgPSB0aGlzLnZlcnRleENvbG9ycztcbiAgICBjbG9uZS51cGRhdGUoKTtcbiAgICByZXR1cm4gY2xvbmU7XG4gIH0sIHVwZGF0ZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNsZWFyUGFyYW1ldGVycygpO1xuICAgIHRoaXMuc2V0UGFyYW1ldGVyKFwidUNvbG9yXCIsIHRoaXMuY29sb3IuZGF0YSk7XG4gICAgaWYgKHRoaXMuY29sb3JNYXApIHtcbiAgICAgIHRoaXMuc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9kaWZmdXNlTWFwXCIsIHRoaXMuY29sb3JNYXApO1xuICAgIH1cbiAgfSwgdXBkYXRlU2hhZGVyOmZ1bmN0aW9uKGRldmljZSkge1xuICAgIHZhciBvcHRpb25zID0ge3NraW46ISF0aGlzLm1lc2hJbnN0YW5jZXNbMF0uc2tpbkluc3RhbmNlLCB2ZXJ0ZXhDb2xvcnM6dGhpcy52ZXJ0ZXhDb2xvcnMsIGRpZmZ1c2VNYXA6dGhpcy5jb2xvck1hcH07XG4gICAgdmFyIGxpYnJhcnkgPSBkZXZpY2UuZ2V0UHJvZ3JhbUxpYnJhcnkoKTtcbiAgICB0aGlzLnNoYWRlciA9IGxpYnJhcnkuZ2V0UHJvZ3JhbShcImJhc2ljXCIsIG9wdGlvbnMpO1xuICB9fSk7XG4gIHJldHVybiB7QmFzaWNNYXRlcmlhbDpCYXNpY01hdGVyaWFsfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgRGVwdGhNYXRlcmlhbCA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBEZXB0aE1hdGVyaWFsID0gcGMuaW5oZXJpdHMoRGVwdGhNYXRlcmlhbCwgcGMuTWF0ZXJpYWwpO1xuICBwYy5leHRlbmQoRGVwdGhNYXRlcmlhbC5wcm90b3R5cGUsIHtjbG9uZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgY2xvbmUgPSBuZXcgcGMuRGVwdGhNYXRlcmlhbDtcbiAgICBwYy5NYXRlcmlhbC5wcm90b3R5cGUuX2Nsb25lSW50ZXJuYWwuY2FsbCh0aGlzLCBjbG9uZSk7XG4gICAgY2xvbmUudXBkYXRlKCk7XG4gICAgcmV0dXJuIGNsb25lO1xuICB9LCB1cGRhdGU6ZnVuY3Rpb24oKSB7XG4gIH0sIHVwZGF0ZVNoYWRlcjpmdW5jdGlvbihkZXZpY2UpIHtcbiAgICB2YXIgb3B0aW9ucyA9IHtza2luOiEhdGhpcy5tZXNoSW5zdGFuY2VzWzBdLnNraW5JbnN0YW5jZX07XG4gICAgdmFyIGxpYnJhcnkgPSBkZXZpY2UuZ2V0UHJvZ3JhbUxpYnJhcnkoKTtcbiAgICB0aGlzLnNoYWRlciA9IGxpYnJhcnkuZ2V0UHJvZ3JhbShcImRlcHRoXCIsIG9wdGlvbnMpO1xuICB9fSk7XG4gIHJldHVybiB7RGVwdGhNYXRlcmlhbDpEZXB0aE1hdGVyaWFsfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3RlbXBUaWxpbmcgPSBuZXcgcGMuVmVjMztcbiAgdmFyIF90ZW1wT2Zmc2V0ID0gbmV3IHBjLlZlYzM7XG4gIHZhciBsaWdodEJvdW5kcyA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgdmFyIHRlbXBTcGhlcmUgPSB7Y2VudGVyOm51bGwsIHJhZGl1czowfTtcbiAgdmFyIFN0YW5kYXJkTWF0ZXJpYWwgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnJlc2V0KCk7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfTtcbiAgdmFyIF9jcmVhdGVUZXh0dXJlID0gZnVuY3Rpb24ocGFyYW0pIHtcbiAgICBpZiAocGFyYW0uZGF0YSkge1xuICAgICAgaWYgKHBhcmFtLmRhdGEgaW5zdGFuY2VvZiBwYy5UZXh0dXJlKSB7XG4gICAgICAgIHJldHVybiBwYXJhbS5kYXRhO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfTtcbiAgdmFyIF9jcmVhdGVDdWJlbWFwID0gZnVuY3Rpb24ocGFyYW0pIHtcbiAgICBpZiAocGFyYW0uZGF0YSkge1xuICAgICAgaWYgKHBhcmFtLmRhdGEgaW5zdGFuY2VvZiBwYy5UZXh0dXJlKSB7XG4gICAgICAgIHJldHVybiBwYXJhbS5kYXRhO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfTtcbiAgdmFyIF9jcmVhdGVWZWMyID0gZnVuY3Rpb24ocGFyYW0pIHtcbiAgICByZXR1cm4gbmV3IHBjLlZlYzIocGFyYW0uZGF0YVswXSwgcGFyYW0uZGF0YVsxXSk7XG4gIH07XG4gIHZhciBfY3JlYXRlVmVjMyA9IGZ1bmN0aW9uKHBhcmFtKSB7XG4gICAgcmV0dXJuIG5ldyBwYy5WZWMzKHBhcmFtLmRhdGFbMF0sIHBhcmFtLmRhdGFbMV0sIHBhcmFtLmRhdGFbMl0pO1xuICB9O1xuICB2YXIgX2NyZWF0ZUJvdW5kaW5nQm94ID0gZnVuY3Rpb24ocGFyYW0pIHtcbiAgICB2YXIgY2VudGVyLCBoYWxmRXh0ZW50cztcbiAgICBpZiAocGFyYW0uZGF0YSAmJiBwYXJhbS5kYXRhLmNlbnRlcikge1xuICAgICAgY2VudGVyID0gbmV3IHBjLlZlYzMocGFyYW0uZGF0YS5jZW50ZXJbMF0sIHBhcmFtLmRhdGEuY2VudGVyWzFdLCBwYXJhbS5kYXRhLmNlbnRlclsyXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNlbnRlciA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIH1cbiAgICBpZiAocGFyYW0uZGF0YSAmJiBwYXJhbS5kYXRhLmhhbGZFeHRlbnRzKSB7XG4gICAgICBoYWxmRXh0ZW50cyA9IG5ldyBwYy5WZWMzKHBhcmFtLmRhdGEuaGFsZkV4dGVudHNbMF0sIHBhcmFtLmRhdGEuaGFsZkV4dGVudHNbMV0sIHBhcmFtLmRhdGEuaGFsZkV4dGVudHNbMl0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBoYWxmRXh0ZW50cyA9IG5ldyBwYy5WZWMzKDAuNSwgMC41LCAwLjUpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IHBjLkJvdW5kaW5nQm94KGNlbnRlciwgaGFsZkV4dGVudHMpO1xuICB9O1xuICB2YXIgX2NyZWF0ZVJnYiA9IGZ1bmN0aW9uKHBhcmFtKSB7XG4gICAgcmV0dXJuIG5ldyBwYy5Db2xvcihwYXJhbS5kYXRhWzBdLCBwYXJhbS5kYXRhWzFdLCBwYXJhbS5kYXRhWzJdKTtcbiAgfTtcbiAgdmFyIF9wcm9wc1NlcmlhbCA9IFtdO1xuICB2YXIgX3Byb3BzU2VyaWFsRGVmYXVsdFZhbCA9IFtdO1xuICB2YXIgX3Byb3BzSW50ZXJuYWxOdWxsID0gW107XG4gIHZhciBfcHJvcHNJbnRlcm5hbFZlYzMgPSBbXTtcbiAgdmFyIF9wcm9wMlVuaWZvcm0gPSB7fTtcbiAgdmFyIF9kZWZpbmVUZXgyRCA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgdXYsIGNoYW5uZWxzKSB7XG4gICAgdmFyIHByaXZNYXAgPSBcIl9cIiArIG5hbWUgKyBcIk1hcFwiO1xuICAgIHZhciBwcml2TWFwVGlsaW5nID0gcHJpdk1hcCArIFwiVGlsaW5nXCI7XG4gICAgdmFyIHByaXZNYXBPZmZzZXQgPSBwcml2TWFwICsgXCJPZmZzZXRcIjtcbiAgICB2YXIgbWFwVHJhbnNmb3JtID0gcHJpdk1hcC5zdWJzdHJpbmcoMSkgKyBcIlRyYW5zZm9ybVwiO1xuICAgIHZhciBwcml2TWFwVXYgPSBwcml2TWFwICsgXCJVdlwiO1xuICAgIHZhciBwcml2TWFwQ2hhbm5lbCA9IHByaXZNYXAgKyBcIkNoYW5uZWxcIjtcbiAgICB2YXIgcHJpdk1hcFZlcnRleENvbG9yID0gcHJpdk1hcCArIFwiVmVydGV4Q29sb3JcIjtcbiAgICBvYmpbcHJpdk1hcF0gPSBudWxsO1xuICAgIG9ialtwcml2TWFwVGlsaW5nXSA9IG5ldyBwYy5WZWMyKDEsIDEpO1xuICAgIG9ialtwcml2TWFwT2Zmc2V0XSA9IG5ldyBwYy5WZWMyKDAsIDApO1xuICAgIG9ialttYXBUcmFuc2Zvcm1dID0gbnVsbDtcbiAgICBvYmpbcHJpdk1hcFV2XSA9IHV2O1xuICAgIGlmIChjaGFubmVscyA+IDApIHtcbiAgICAgIG9ialtwcml2TWFwQ2hhbm5lbF0gPSBjaGFubmVscyA+IDEgPyBcInJnYlwiIDogXCJnXCI7XG4gICAgfVxuICAgIG9ialtwcml2TWFwVmVydGV4Q29sb3JdID0gZmFsc2U7XG4gICAgaWYgKCFwYy5fbWF0VGV4MkQpIHtcbiAgICAgIHBjLl9tYXRUZXgyRCA9IFtdO1xuICAgIH1cbiAgICBwYy5fbWF0VGV4MkRbbmFtZV0gPSBjaGFubmVscztcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIHByaXZNYXAuc3Vic3RyaW5nKDEpLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXNbcHJpdk1hcF07XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICB2YXIgb2xkVmFsID0gdGhpc1twcml2TWFwXTtcbiAgICAgIGlmICghIW9sZFZhbCBeICEhdmFsdWUpIHtcbiAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAob2xkVmFsICYmIHZhbHVlKSB7XG4gICAgICAgIGlmIChvbGRWYWwucmdibSAhPT0gdmFsdWUucmdibSB8fCBvbGRWYWwuZml4Q3ViZW1hcFNlYW1zICE9PSB2YWx1ZS5maXhDdWJlbWFwU2VhbXMgfHwgb2xkVmFsLmZvcm1hdCAhPT0gdmFsdWUuZm9ybWF0KSB7XG4gICAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXNbcHJpdk1hcF0gPSB2YWx1ZTtcbiAgICB9fSk7XG4gICAgdmFyIG1hcFRpbGluZyA9IHByaXZNYXBUaWxpbmcuc3Vic3RyaW5nKDEpO1xuICAgIHZhciBtYXBPZmZzZXQgPSBwcml2TWFwT2Zmc2V0LnN1YnN0cmluZygxKTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIG1hcFRpbGluZywge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzW3ByaXZNYXBUaWxpbmddO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB0aGlzW3ByaXZNYXBUaWxpbmddID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIF9wcm9wMlVuaWZvcm1bbWFwVGlsaW5nXSA9IGZ1bmN0aW9uKG1hdCwgdmFsLCBjaGFuZ2VNYXQpIHtcbiAgICAgIHZhciB0Zm9ybSA9IG1hdC5fdXBkYXRlTWFwVHJhbnNmb3JtKGNoYW5nZU1hdCA/IG1hdFttYXBUcmFuc2Zvcm1dIDogbnVsbCwgdmFsLCBtYXRbcHJpdk1hcE9mZnNldF0pO1xuICAgICAgcmV0dXJuIHtuYW1lOlwidGV4dHVyZV9cIiArIG1hcFRyYW5zZm9ybSwgdmFsdWU6dGZvcm0uZGF0YX07XG4gICAgfTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIG1hcE9mZnNldCwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzW3ByaXZNYXBPZmZzZXRdO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB0aGlzW3ByaXZNYXBPZmZzZXRdID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIF9wcm9wMlVuaWZvcm1bbWFwT2Zmc2V0XSA9IGZ1bmN0aW9uKG1hdCwgdmFsLCBjaGFuZ2VNYXQpIHtcbiAgICAgIHZhciB0Zm9ybSA9IG1hdC5fdXBkYXRlTWFwVHJhbnNmb3JtKGNoYW5nZU1hdCA/IG1hdFttYXBUcmFuc2Zvcm1dIDogbnVsbCwgbWF0W3ByaXZNYXBUaWxpbmddLCB2YWwpO1xuICAgICAgcmV0dXJuIHtuYW1lOlwidGV4dHVyZV9cIiArIG1hcFRyYW5zZm9ybSwgdmFsdWU6dGZvcm0uZGF0YX07XG4gICAgfTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIHByaXZNYXBVdi5zdWJzdHJpbmcoMSksIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpc1twcml2TWFwVXZdO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHRoaXNbcHJpdk1hcFV2XSAhPT0gdmFsdWUpIHtcbiAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzW3ByaXZNYXBVdl0gPSB2YWx1ZTtcbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0YW5kYXJkTWF0ZXJpYWwucHJvdG90eXBlLCBwcml2TWFwQ2hhbm5lbC5zdWJzdHJpbmcoMSksIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpc1twcml2TWFwQ2hhbm5lbF07XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICBpZiAodGhpc1twcml2TWFwQ2hhbm5lbF0gIT09IHZhbHVlKSB7XG4gICAgICAgIHRoaXMuZGlydHlTaGFkZXIgPSB0cnVlO1xuICAgICAgfVxuICAgICAgdGhpc1twcml2TWFwQ2hhbm5lbF0gPSB2YWx1ZTtcbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0YW5kYXJkTWF0ZXJpYWwucHJvdG90eXBlLCBwcml2TWFwVmVydGV4Q29sb3Iuc3Vic3RyaW5nKDEpLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXNbcHJpdk1hcFZlcnRleENvbG9yXTtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHRoaXMuZGlydHlTaGFkZXIgPSB0cnVlO1xuICAgICAgdGhpc1twcml2TWFwVmVydGV4Q29sb3JdID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIF9wcm9wc1NlcmlhbC5wdXNoKHByaXZNYXAuc3Vic3RyaW5nKDEpKTtcbiAgICBfcHJvcHNTZXJpYWwucHVzaChwcml2TWFwVGlsaW5nLnN1YnN0cmluZygxKSk7XG4gICAgX3Byb3BzU2VyaWFsLnB1c2gocHJpdk1hcE9mZnNldC5zdWJzdHJpbmcoMSkpO1xuICAgIF9wcm9wc1NlcmlhbC5wdXNoKHByaXZNYXBVdi5zdWJzdHJpbmcoMSkpO1xuICAgIF9wcm9wc1NlcmlhbC5wdXNoKHByaXZNYXBDaGFubmVsLnN1YnN0cmluZygxKSk7XG4gICAgX3Byb3BzU2VyaWFsLnB1c2gocHJpdk1hcFZlcnRleENvbG9yLnN1YnN0cmluZygxKSk7XG4gICAgX3Byb3BzSW50ZXJuYWxOdWxsLnB1c2gobWFwVHJhbnNmb3JtKTtcbiAgfTtcbiAgdmFyIF9wcm9wc0NvbG9yID0gW107XG4gIHZhciBfZGVmaW5lQ29sb3IgPSBmdW5jdGlvbihvYmosIG5hbWUsIGRlZmF1bHRWYWx1ZSwgaGFzTXVsdGlwbGllcikge1xuICAgIHZhciBwcml2ID0gXCJfXCIgKyBuYW1lO1xuICAgIHZhciB1Zm9ybSA9IG5hbWUgKyBcIlVuaWZvcm1cIjtcbiAgICB2YXIgbXVsdCA9IG5hbWUgKyBcIkludGVuc2l0eVwiO1xuICAgIHZhciBwbXVsdCA9IFwiX1wiICsgbXVsdDtcbiAgICBvYmpbcHJpdl0gPSBkZWZhdWx0VmFsdWU7XG4gICAgb2JqW3Vmb3JtXSA9IG5ldyBGbG9hdDMyQXJyYXkoMyk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0YW5kYXJkTWF0ZXJpYWwucHJvdG90eXBlLCBuYW1lLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5kaXJ0eUNvbG9yID0gdHJ1ZTtcbiAgICAgIHRoaXMuZGlydHlTaGFkZXIgPSB0cnVlO1xuICAgICAgcmV0dXJuIHRoaXNbcHJpdl07XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICB2YXIgb2xkVmFsID0gdGhpc1twcml2XTtcbiAgICAgIHZhciB3YXNCdyA9IG9sZFZhbC5kYXRhWzBdID09PSAwICYmIG9sZFZhbC5kYXRhWzFdID09PSAwICYmIG9sZFZhbC5kYXRhWzJdID09PSAwIHx8IG9sZFZhbC5kYXRhWzBdID09PSAxICYmIG9sZFZhbC5kYXRhWzFdID09PSAxICYmIG9sZFZhbC5kYXRhWzJdID09PSAxO1xuICAgICAgdmFyIGlzQncgPSB2YWx1ZS5kYXRhWzBdID09PSAwICYmIHZhbHVlLmRhdGFbMV0gPT09IDAgJiYgdmFsdWUuZGF0YVsyXSA9PT0gMCB8fCB2YWx1ZS5kYXRhWzBdID09PSAxICYmIHZhbHVlLmRhdGFbMV0gPT09IDEgJiYgdmFsdWUuZGF0YVsyXSA9PT0gMTtcbiAgICAgIGlmICh3YXNCdyBeIGlzQncpIHtcbiAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzLmRpcnR5Q29sb3IgPSB0cnVlO1xuICAgICAgdGhpc1twcml2XSA9IHZhbHVlO1xuICAgIH19KTtcbiAgICBfcHJvcHNTZXJpYWwucHVzaChuYW1lKTtcbiAgICBfcHJvcHNJbnRlcm5hbFZlYzMucHVzaCh1Zm9ybSk7XG4gICAgX3Byb3BzQ29sb3IucHVzaChuYW1lKTtcbiAgICBfcHJvcDJVbmlmb3JtW25hbWVdID0gZnVuY3Rpb24obWF0LCB2YWwsIGNoYW5nZU1hdCkge1xuICAgICAgdmFyIGFyciA9IGNoYW5nZU1hdCA/IG1hdFt1Zm9ybV0gOiBuZXcgRmxvYXQzMkFycmF5KDMpO1xuICAgICAgdmFyIGdhbW1hQ29ycmVjdGlvbiA9IGZhbHNlO1xuICAgICAgaWYgKG1hdC51c2VHYW1tYVRvbmVtYXApIHtcbiAgICAgICAgdmFyIHNjZW5lID0gbWF0Ll9zY2VuZSB8fCBwYy5BcHBsaWNhdGlvbi5nZXRBcHBsaWNhdGlvbigpLnNjZW5lO1xuICAgICAgICBnYW1tYUNvcnJlY3Rpb24gPSBzY2VuZS5nYW1tYUNvcnJlY3Rpb247XG4gICAgICB9XG4gICAgICBmb3IgKHZhciBjID0gMDtjIDwgMztjKyspIHtcbiAgICAgICAgaWYgKGdhbW1hQ29ycmVjdGlvbikge1xuICAgICAgICAgIGFycltjXSA9IE1hdGgucG93KHZhbC5kYXRhW2NdLCAyLjIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFycltjXSA9IHZhbC5kYXRhW2NdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChoYXNNdWx0aXBsaWVyKSB7XG4gICAgICAgICAgYXJyW2NdICo9IG1hdFtwbXVsdF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB7bmFtZTpcIm1hdGVyaWFsX1wiICsgbmFtZSwgdmFsdWU6YXJyfTtcbiAgICB9O1xuICAgIGlmIChoYXNNdWx0aXBsaWVyKSB7XG4gICAgICBvYmpbcG11bHRdID0gMTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTdGFuZGFyZE1hdGVyaWFsLnByb3RvdHlwZSwgbXVsdCwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXNbcG11bHRdO1xuICAgICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIHZhciBvbGRWYWwgPSB0aGlzW3BtdWx0XTtcbiAgICAgICAgdmFyIHdhc0J3ID0gb2xkVmFsID09PSAwIHx8IG9sZFZhbCA9PT0gMTtcbiAgICAgICAgdmFyIGlzQncgPSB2YWx1ZSA9PT0gMCB8fCB2YWx1ZSA9PT0gMTtcbiAgICAgICAgaWYgKHdhc0J3IF4gaXNCdykge1xuICAgICAgICAgIHRoaXMuZGlydHlTaGFkZXIgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGlydHlDb2xvciA9IHRydWU7XG4gICAgICAgIHRoaXNbcG11bHRdID0gdmFsdWU7XG4gICAgICB9fSk7XG4gICAgICBfcHJvcHNTZXJpYWwucHVzaChtdWx0KTtcbiAgICAgIF9wcm9wMlVuaWZvcm1bbXVsdF0gPSBmdW5jdGlvbihtYXQsIHZhbCwgY2hhbmdlTWF0KSB7XG4gICAgICAgIHZhciBhcnIgPSBjaGFuZ2VNYXQgPyBtYXRbdWZvcm1dIDogbmV3IEZsb2F0MzJBcnJheSgzKTtcbiAgICAgICAgdmFyIGdhbW1hQ29ycmVjdGlvbiA9IGZhbHNlO1xuICAgICAgICBpZiAobWF0LnVzZUdhbW1hVG9uZW1hcCkge1xuICAgICAgICAgIHZhciBzY2VuZSA9IG1hdC5fc2NlbmUgfHwgcGMuQXBwbGljYXRpb24uZ2V0QXBwbGljYXRpb24oKS5zY2VuZTtcbiAgICAgICAgICBnYW1tYUNvcnJlY3Rpb24gPSBzY2VuZS5nYW1tYUNvcnJlY3Rpb247XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgYyA9IDA7YyA8IDM7YysrKSB7XG4gICAgICAgICAgaWYgKGdhbW1hQ29ycmVjdGlvbikge1xuICAgICAgICAgICAgYXJyW2NdID0gTWF0aC5wb3cobWF0W3ByaXZdLmRhdGFbY10sIDIuMik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFycltjXSA9IG1hdFtwcml2XS5kYXRhW2NdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBhcnJbY10gKj0gbWF0W3BtdWx0XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge25hbWU6XCJtYXRlcmlhbF9cIiArIG5hbWUsIHZhbHVlOmFycn07XG4gICAgICB9O1xuICAgIH1cbiAgfTtcbiAgdmFyIF9kZWZpbmVGbG9hdCA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgZGVmYXVsdFZhbHVlLCBmdW5jKSB7XG4gICAgdmFyIHByaXYgPSBcIl9cIiArIG5hbWU7XG4gICAgb2JqW3ByaXZdID0gZGVmYXVsdFZhbHVlO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTdGFuZGFyZE1hdGVyaWFsLnByb3RvdHlwZSwgbmFtZSwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzW3ByaXZdO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgdmFyIG9sZFZhbCA9IHRoaXNbcHJpdl07XG4gICAgICB2YXIgd2FzQncgPSBvbGRWYWwgPT09IDAgfHwgb2xkVmFsID09PSAxO1xuICAgICAgdmFyIGlzQncgPSB2YWx1ZSA9PT0gMCB8fCB2YWx1ZSA9PT0gMTtcbiAgICAgIGlmICh3YXNCdyBeIGlzQncpIHtcbiAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzW3ByaXZdID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIF9wcm9wc1NlcmlhbC5wdXNoKG5hbWUpO1xuICAgIF9wcm9wMlVuaWZvcm1bbmFtZV0gPSBmdW5jICE9PSB1bmRlZmluZWQgPyBmdW5jIDogZnVuY3Rpb24obWF0LCB2YWwsIGNoYW5nZU1hdCkge1xuICAgICAgcmV0dXJuIHtuYW1lOlwibWF0ZXJpYWxfXCIgKyBuYW1lLCB2YWx1ZTp2YWx9O1xuICAgIH07XG4gIH07XG4gIHZhciBfZGVmaW5lT2JqZWN0ID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBmdW5jKSB7XG4gICAgdmFyIHByaXYgPSBcIl9cIiArIG5hbWU7XG4gICAgb2JqW3ByaXZdID0gbnVsbDtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIG5hbWUsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpc1twcml2XTtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHZhciBvbGRWYWwgPSB0aGlzW3ByaXZdO1xuICAgICAgaWYgKCEhb2xkVmFsIF4gISF2YWx1ZSkge1xuICAgICAgICB0aGlzLmRpcnR5U2hhZGVyID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcHJpdl0gPSB2YWx1ZTtcbiAgICB9fSk7XG4gICAgX3Byb3BzU2VyaWFsLnB1c2gobmFtZSk7XG4gICAgX3Byb3AyVW5pZm9ybVtuYW1lXSA9IGZ1bmM7XG4gIH07XG4gIHZhciBfZGVmaW5lQ2h1bmtzID0gZnVuY3Rpb24ob2JqKSB7XG4gICAgdGhpcy5fY2h1bmtzID0gbnVsbDtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RhbmRhcmRNYXRlcmlhbC5wcm90b3R5cGUsIFwiY2h1bmtzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLmRpcnR5U2hhZGVyID0gdHJ1ZTtcbiAgICAgIHJldHVybiB0aGlzLl9jaHVua3M7XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICB0aGlzLmRpcnR5U2hhZGVyID0gdHJ1ZTtcbiAgICAgIHRoaXMuX2NodW5rcyA9IHZhbHVlO1xuICAgIH19KTtcbiAgICBfcHJvcHNTZXJpYWwucHVzaChcImNodW5rc1wiKTtcbiAgfTtcbiAgdmFyIF9kZWZpbmVGbGFnID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBkZWZhdWx0VmFsdWUpIHtcbiAgICB2YXIgcHJpdiA9IFwiX1wiICsgbmFtZTtcbiAgICBvYmpbcHJpdl0gPSBkZWZhdWx0VmFsdWU7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0YW5kYXJkTWF0ZXJpYWwucHJvdG90eXBlLCBuYW1lLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXNbcHJpdl07XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICBpZiAodGhpc1twcml2XSAhPT0gdmFsdWUpIHtcbiAgICAgICAgdGhpcy5kaXJ0eVNoYWRlciA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzW3ByaXZdID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIF9wcm9wc1NlcmlhbC5wdXNoKG5hbWUpO1xuICB9O1xuICB2YXIgQ2h1bmtzID0gZnVuY3Rpb24oKSB7XG4gIH07XG4gIENodW5rcy5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKGZyb20pIHtcbiAgICBmb3IgKHZhciBwIGluIGZyb20pIHtcbiAgICAgIGlmIChmcm9tLmhhc093blByb3BlcnR5KHApICYmIHAgIT09IFwiY29weVwiKSB7XG4gICAgICAgIHRoaXNbcF0gPSBmcm9tW3BdO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgU3RhbmRhcmRNYXRlcmlhbCA9IHBjLmluaGVyaXRzKFN0YW5kYXJkTWF0ZXJpYWwsIHBjLk1hdGVyaWFsKTtcbiAgcGMuZXh0ZW5kKFN0YW5kYXJkTWF0ZXJpYWwucHJvdG90eXBlLCB7cmVzZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5ibGVuZFR5cGUgPSBwYy5CTEVORF9OT05FO1xuICAgIHZhciBpO1xuICAgIGZvciAoaSA9IDA7aSA8IF9wcm9wc1NlcmlhbC5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgZGVmVmFsID0gX3Byb3BzU2VyaWFsRGVmYXVsdFZhbFtpXTtcbiAgICAgIHRoaXNbX3Byb3BzU2VyaWFsW2ldXSA9IGRlZlZhbCA/IGRlZlZhbC5jbG9uZSA/IGRlZlZhbC5jbG9uZSgpIDogZGVmVmFsIDogZGVmVmFsO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBfcHJvcHNJbnRlcm5hbE51bGwubGVuZ3RoO2krKykge1xuICAgICAgdGhpc1tfcHJvcHNJbnRlcm5hbE51bGxbaV1dID0gbnVsbDtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgX3Byb3BzSW50ZXJuYWxWZWMzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXNbX3Byb3BzSW50ZXJuYWxWZWMzW2ldXSA9IG5ldyBGbG9hdDMyQXJyYXkoMyk7XG4gICAgfVxuICAgIHRoaXMuX2NodW5rcyA9IG5ldyBDaHVua3M7XG4gICAgdGhpcy5jdWJlTWFwTWluVW5pZm9ybSA9IG5ldyBGbG9hdDMyQXJyYXkoMyk7XG4gICAgdGhpcy5jdWJlTWFwTWF4VW5pZm9ybSA9IG5ldyBGbG9hdDMyQXJyYXkoMyk7XG4gIH0sIGNsb25lOmZ1bmN0aW9uKCkge1xuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xuICAgIHBjLk1hdGVyaWFsLnByb3RvdHlwZS5fY2xvbmVJbnRlcm5hbC5jYWxsKHRoaXMsIGNsb25lKTtcbiAgICB2YXIgcG5hbWU7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IF9wcm9wc1NlcmlhbC5sZW5ndGg7aSsrKSB7XG4gICAgICBwbmFtZSA9IF9wcm9wc1NlcmlhbFtpXTtcbiAgICAgIGlmICh0aGlzW3BuYW1lXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmICh0aGlzW3BuYW1lXSAmJiB0aGlzW3BuYW1lXS5jb3B5KSB7XG4gICAgICAgICAgaWYgKGNsb25lW3BuYW1lXSkge1xuICAgICAgICAgICAgY2xvbmVbcG5hbWVdLmNvcHkodGhpc1twbmFtZV0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjbG9uZVtwbmFtZV0gPSB0aGlzW3BuYW1lXS5jbG9uZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjbG9uZVtwbmFtZV0gPSB0aGlzW3BuYW1lXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWNsb25lLnNoYWRlcikge1xuICAgICAgY2xvbmUudXBkYXRlKCk7XG4gICAgfVxuICAgIHJldHVybiBjbG9uZTtcbiAgfSwgaW5pdDpmdW5jdGlvbihkYXRhKSB7XG4gICAgdGhpcy5yZXNldCgpO1xuICAgIHRoaXMubmFtZSA9IGRhdGEubmFtZTtcbiAgICBpZiAoZGF0YS5jaHVua3MpIHtcbiAgICAgIHRoaXMuY2h1bmtzLmNvcHkoZGF0YS5jaHVua3MpO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgZGF0YS5wYXJhbWV0ZXJzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBwYXJhbSA9IGRhdGEucGFyYW1ldGVyc1tpXTtcbiAgICAgIGlmIChwYXJhbS50eXBlID09PSBcInZlYzNcIikge1xuICAgICAgICB0aGlzW3BhcmFtLm5hbWVdID0gX2NyZWF0ZVJnYihwYXJhbSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAocGFyYW0udHlwZSA9PT0gXCJ2ZWMyXCIpIHtcbiAgICAgICAgICB0aGlzW3BhcmFtLm5hbWVdID0gX2NyZWF0ZVZlYzIocGFyYW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChwYXJhbS50eXBlID09PSBcInRleHR1cmVcIikge1xuICAgICAgICAgICAgdGhpc1twYXJhbS5uYW1lXSA9IF9jcmVhdGVUZXh0dXJlKHBhcmFtKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHBhcmFtLnR5cGUgPT09IFwiY3ViZW1hcFwiKSB7XG4gICAgICAgICAgICAgIHRoaXNbcGFyYW0ubmFtZV0gPSBfY3JlYXRlQ3ViZW1hcChwYXJhbSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAocGFyYW0ubmFtZSA9PT0gXCJidW1wTWFwRmFjdG9yXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJ1bXBpbmVzcyA9IHBhcmFtLmRhdGE7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtLnR5cGUgPT09IFwiYm91bmRpbmdib3hcIikge1xuICAgICAgICAgICAgICAgICAgdGhpc1twYXJhbS5uYW1lXSA9IF9jcmVhdGVCb3VuZGluZ0JveChwYXJhbSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHRoaXNbcGFyYW0ubmFtZV0gPSBwYXJhbS5kYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9LCBfdXBkYXRlTWFwVHJhbnNmb3JtOmZ1bmN0aW9uKHRyYW5zZm9ybSwgdGlsaW5nLCBvZmZzZXQpIHtcbiAgICB0cmFuc2Zvcm0gPSB0cmFuc2Zvcm0gfHwgbmV3IHBjLlZlYzQ7XG4gICAgdHJhbnNmb3JtLnNldCh0aWxpbmcueCwgdGlsaW5nLnksIG9mZnNldC54LCBvZmZzZXQueSk7XG4gICAgaWYgKHRyYW5zZm9ybS54ID09PSAxICYmIHRyYW5zZm9ybS55ID09PSAxICYmIHRyYW5zZm9ybS56ID09PSAwICYmIHRyYW5zZm9ybS53ID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRyYW5zZm9ybTtcbiAgfSwgX2NvbGxlY3RMaWdodHM6ZnVuY3Rpb24obFR5cGUsIGxpZ2h0cywgbGlnaHRzU29ydGVkLCBtYXNrLCBzdGF0aWNMaWdodExpc3QpIHtcbiAgICB2YXIgbGlnaHQ7XG4gICAgdmFyIGk7XG4gICAgZm9yIChpID0gMDtpIDwgbGlnaHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIGxpZ2h0ID0gbGlnaHRzW2ldO1xuICAgICAgaWYgKGxpZ2h0Ll9lbmFibGVkKSB7XG4gICAgICAgIGlmIChsaWdodC5fbWFzayAmIG1hc2spIHtcbiAgICAgICAgICBpZiAobGlnaHQuX3R5cGUgPT09IGxUeXBlKSB7XG4gICAgICAgICAgICBpZiAobFR5cGUgIT09IHBjLkxJR0hUVFlQRV9ESVJFQ1RJT05BTCkge1xuICAgICAgICAgICAgICBpZiAobGlnaHQuaXNTdGF0aWMpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGlnaHRzU29ydGVkLnB1c2gobGlnaHQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3RhdGljTGlnaHRMaXN0KSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBzdGF0aWNMaWdodExpc3QubGVuZ3RoO2krKykge1xuICAgICAgICBsaWdodCA9IHN0YXRpY0xpZ2h0TGlzdFtpXTtcbiAgICAgICAgaWYgKGxpZ2h0Ll90eXBlID09PSBsVHlwZSkge1xuICAgICAgICAgIGxpZ2h0c1NvcnRlZC5wdXNoKGxpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgX3NldFBhcmFtZXRlcjpmdW5jdGlvbihuYW1lLCB2YWx1ZSkge1xuICAgIHRoaXMuc2V0UGFyYW1ldGVyKG5hbWUsIHZhbHVlKTtcbiAgICB0aGlzLl9wcm9wc1NldC5wdXNoKG5hbWUpO1xuICB9LCBfY2xlYXJQYXJhbWV0ZXJzOmZ1bmN0aW9uKCkge1xuICAgIHZhciBwcm9wcyA9IHRoaXMuX3Byb3BzU2V0O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBwcm9wcy5sZW5ndGg7aSsrKSB7XG4gICAgICBkZWxldGUgdGhpcy5wYXJhbWV0ZXJzW3Byb3BzW2ldXTtcbiAgICB9XG4gICAgdGhpcy5fcHJvcHNTZXQgPSBbXTtcbiAgfSwgX3VwZGF0ZU1hcDpmdW5jdGlvbihwKSB7XG4gICAgdmFyIG1uYW1lID0gcCArIFwiTWFwXCI7XG4gICAgaWYgKHRoaXNbbW5hbWVdKSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX1wiICsgbW5hbWUsIHRoaXNbbW5hbWVdKTtcbiAgICAgIHZhciB0bmFtZSA9IG1uYW1lICsgXCJUcmFuc2Zvcm1cIjtcbiAgICAgIHRoaXNbdG5hbWVdID0gdGhpcy5fdXBkYXRlTWFwVHJhbnNmb3JtKHRoaXNbdG5hbWVdLCB0aGlzW21uYW1lICsgXCJUaWxpbmdcIl0sIHRoaXNbbW5hbWUgKyBcIk9mZnNldFwiXSk7XG4gICAgICBpZiAodGhpc1t0bmFtZV0pIHtcbiAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9cIiArIHRuYW1lLCB0aGlzW3RuYW1lXS5kYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGdldFVuaWZvcm06ZnVuY3Rpb24odmFyTmFtZSwgdmFsdWUsIGNoYW5nZU1hdCkge1xuICAgIHZhciBmdW5jID0gX3Byb3AyVW5pZm9ybVt2YXJOYW1lXTtcbiAgICBpZiAoZnVuYykge1xuICAgICAgcmV0dXJuIGZ1bmModGhpcywgdmFsdWUsIGNoYW5nZU1hdCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9LCB1cGRhdGU6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fY2xlYXJQYXJhbWV0ZXJzKCk7XG4gICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfYW1iaWVudFwiLCB0aGlzLmFtYmllbnRVbmlmb3JtKTtcbiAgICBpZiAoIXRoaXMuZGlmZnVzZU1hcCB8fCB0aGlzLmRpZmZ1c2VNYXBUaW50KSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9kaWZmdXNlXCIsIHRoaXMuZGlmZnVzZVVuaWZvcm0pO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudXNlTWV0YWxuZXNzKSB7XG4gICAgICBpZiAoIXRoaXMuc3BlY3VsYXJNYXAgfHwgdGhpcy5zcGVjdWxhck1hcFRpbnQpIHtcbiAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfc3BlY3VsYXJcIiwgdGhpcy5zcGVjdWxhclVuaWZvcm0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMubWV0YWxuZXNzTWFwIHx8IHRoaXMubWV0YWxuZXNzIDwgMSkge1xuICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9tZXRhbG5lc3NcIiwgdGhpcy5tZXRhbG5lc3MpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9zZXRQYXJhbWV0ZXIodGhpcy5nZXRVbmlmb3JtKFwic2hpbmluZXNzXCIsIHRoaXMuc2hpbmluZXNzLCB0cnVlKSk7XG4gICAgaWYgKCF0aGlzLmVtaXNzaXZlTWFwIHx8IHRoaXMuZW1pc3NpdmVNYXBUaW50KSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9lbWlzc2l2ZVwiLCB0aGlzLmVtaXNzaXZlVW5pZm9ybSk7XG4gICAgfVxuICAgIGlmICh0aGlzLmVtaXNzaXZlTWFwKSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9lbWlzc2l2ZUludGVuc2l0eVwiLCB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5KTtcbiAgICB9XG4gICAgaWYgKHRoaXMucmVmcmFjdGlvbiA+IDApIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcIm1hdGVyaWFsX3JlZnJhY3Rpb25cIiwgdGhpcy5yZWZyYWN0aW9uKTtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcIm1hdGVyaWFsX3JlZnJhY3Rpb25JbmRleFwiLCB0aGlzLnJlZnJhY3Rpb25JbmRleCk7XG4gICAgfVxuICAgIHRoaXMuX3NldFBhcmFtZXRlcihcIm1hdGVyaWFsX29wYWNpdHlcIiwgdGhpcy5vcGFjaXR5KTtcbiAgICBpZiAodGhpcy5vY2NsdWRlU3BlY3VsYXIpIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcIm1hdGVyaWFsX29jY2x1ZGVTcGVjdWxhckludGVuc2l0eVwiLCB0aGlzLm9jY2x1ZGVTcGVjdWxhckludGVuc2l0eSk7XG4gICAgfVxuICAgIGlmICh0aGlzLmN1YmVNYXBQcm9qZWN0aW9uID09PSBwYy5DVUJFUFJPSl9CT1gpIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcih0aGlzLmdldFVuaWZvcm0oXCJjdWJlTWFwUHJvamVjdGlvbkJveFwiLCB0aGlzLmN1YmVNYXBQcm9qZWN0aW9uQm94LCB0cnVlKSk7XG4gICAgfVxuICAgIGZvciAodmFyIHAgaW4gcGMuX21hdFRleDJEKSB7XG4gICAgICB0aGlzLl91cGRhdGVNYXAocCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmFtYmllbnRTSCkge1xuICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwiYW1iaWVudFNIWzBdXCIsIHRoaXMuYW1iaWVudFNIKTtcbiAgICB9XG4gICAgaWYgKHRoaXMubm9ybWFsTWFwKSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9idW1waW5lc3NcIiwgdGhpcy5idW1waW5lc3MpO1xuICAgIH1cbiAgICBpZiAodGhpcy5oZWlnaHRNYXApIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcih0aGlzLmdldFVuaWZvcm0oXCJoZWlnaHRNYXBGYWN0b3JcIiwgdGhpcy5oZWlnaHRNYXBGYWN0b3IsIHRydWUpKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuY3ViZU1hcCkge1xuICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9jdWJlTWFwXCIsIHRoaXMuY3ViZU1hcCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDEyOCkge1xuICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAxMjhcIiwgdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXAxMjgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fc2NlbmUgJiYgdGhpcy5fc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzBdKSB7XG4gICAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTI4XCIsIHRoaXMuX3NjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFswXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDY0KSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDY0XCIsIHRoaXMucHJlZmlsdGVyZWRDdWJlTWFwNjQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fc2NlbmUgJiYgdGhpcy5fc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzFdKSB7XG4gICAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwNjRcIiwgdGhpcy5fc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzFdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMucHJlZmlsdGVyZWRDdWJlTWFwMzIpIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMzJcIiwgdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXAzMik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl9zY2VuZSAmJiB0aGlzLl9zY2VuZS5fc2t5Ym94UHJlZmlsdGVyZWRbMl0pIHtcbiAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAzMlwiLCB0aGlzLl9zY2VuZS5fc2t5Ym94UHJlZmlsdGVyZWRbMl0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXAxNikge1xuICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAxNlwiLCB0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDE2KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX3NjZW5lICYmIHRoaXMuX3NjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFszXSkge1xuICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDE2XCIsIHRoaXMuX3NjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFszXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDgpIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwOFwiLCB0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fc2NlbmUgJiYgdGhpcy5fc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzRdKSB7XG4gICAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwOFwiLCB0aGlzLl9zY2VuZS5fc2t5Ym94UHJlZmlsdGVyZWRbNF0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXA0KSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDRcIiwgdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXA0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX3NjZW5lICYmIHRoaXMuX3NjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFs1XSkge1xuICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDRcIiwgdGhpcy5fc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzVdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuc3BoZXJlTWFwKSB7XG4gICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3NwaGVyZU1hcFwiLCB0aGlzLnNwaGVyZU1hcCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmRwQXRsYXMpIHtcbiAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfc3BoZXJlTWFwXCIsIHRoaXMuZHBBdGxhcyk7XG4gICAgfVxuICAgIHRoaXMuX3NldFBhcmFtZXRlcihcIm1hdGVyaWFsX3JlZmxlY3Rpdml0eVwiLCB0aGlzLnJlZmxlY3Rpdml0eSk7XG4gICAgaWYgKHRoaXMuZGlydHlTaGFkZXIgfHwgIXRoaXMuX3NjZW5lKSB7XG4gICAgICB0aGlzLnNoYWRlciA9IG51bGw7XG4gICAgICB0aGlzLmNsZWFyVmFyaWFudHMoKTtcbiAgICB9XG4gICAgdGhpcy5fcHJvY2Vzc0NvbG9yKCk7XG4gIH0sIF9wcm9jZXNzQ29sb3I6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGMsIGk7XG4gICAgaWYgKCF0aGlzLmRpcnR5Q29sb3IpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9zY2VuZSAmJiB0aGlzLnVzZUdhbW1hVG9uZW1hcCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZ2FtbWFDb3JyZWN0aW9uID0gZmFsc2U7XG4gICAgaWYgKHRoaXMudXNlR2FtbWFUb25lbWFwKSB7XG4gICAgICBnYW1tYUNvcnJlY3Rpb24gPSB0aGlzLl9zY2VuZS5nYW1tYUNvcnJlY3Rpb247XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IF9wcm9wc0NvbG9yLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBjbHIgPSB0aGlzW1wiX1wiICsgX3Byb3BzQ29sb3JbaV1dO1xuICAgICAgdmFyIGFyciA9IHRoaXNbX3Byb3BzQ29sb3JbaV0gKyBcIlVuaWZvcm1cIl07XG4gICAgICBmb3IgKGMgPSAwO2MgPCAzO2MrKykge1xuICAgICAgICBpZiAoZ2FtbWFDb3JyZWN0aW9uKSB7XG4gICAgICAgICAgYXJyW2NdID0gTWF0aC5wb3coY2xyLmRhdGFbY10sIDIuMik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXJyW2NdID0gY2xyLmRhdGFbY107XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjID0gMDtjIDwgMztjKyspIHtcbiAgICAgIHRoaXMuZW1pc3NpdmVVbmlmb3JtW2NdICo9IHRoaXMuZW1pc3NpdmVJbnRlbnNpdHk7XG4gICAgfVxuICAgIHRoaXMuZGlydHlDb2xvciA9IGZhbHNlO1xuICB9LCBfZ2V0TWFwVHJhbnNmb3JtSUQ6ZnVuY3Rpb24oeGZvcm0sIHV2KSB7XG4gICAgaWYgKCF4Zm9ybSkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGlmICghdGhpcy5fbWFwWEZvcm1zW3V2XSkge1xuICAgICAgdGhpcy5fbWFwWEZvcm1zW3V2XSA9IFtdO1xuICAgIH1cbiAgICB2YXIgaSwgaiwgc2FtZTtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl9tYXBYRm9ybXNbdXZdLmxlbmd0aDtpKyspIHtcbiAgICAgIHNhbWUgPSB0cnVlO1xuICAgICAgZm9yIChqID0gMDtqIDwgeGZvcm0uZGF0YS5sZW5ndGg7aisrKSB7XG4gICAgICAgIGlmICh0aGlzLl9tYXBYRm9ybXNbdXZdW2ldW2pdICE9IHhmb3JtLmRhdGFbal0pIHtcbiAgICAgICAgICBzYW1lID0gZmFsc2U7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzYW1lKSB7XG4gICAgICAgIHJldHVybiBpICsgMTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIG5ld0lEID0gdGhpcy5fbWFwWEZvcm1zW3V2XS5sZW5ndGg7XG4gICAgdGhpcy5fbWFwWEZvcm1zW3V2XVtuZXdJRF0gPSBbXTtcbiAgICBmb3IgKGogPSAwO2ogPCB4Zm9ybS5kYXRhLmxlbmd0aDtqKyspIHtcbiAgICAgIHRoaXMuX21hcFhGb3Jtc1t1dl1bbmV3SURdW2pdID0geGZvcm0uZGF0YVtqXTtcbiAgICB9XG4gICAgcmV0dXJuIG5ld0lEICsgMTtcbiAgfSwgdXBkYXRlU2hhZGVyOmZ1bmN0aW9uKGRldmljZSwgc2NlbmUsIG9iakRlZnMsIHN0YXRpY0xpZ2h0TGlzdCwgcGFzcykge1xuICAgIHZhciBpLCBjO1xuICAgIGlmICghdGhpcy5fc2NlbmUpIHtcbiAgICAgIHRoaXMuX3NjZW5lID0gc2NlbmU7XG4gICAgICB0aGlzLl9wcm9jZXNzQ29sb3IoKTtcbiAgICB9XG4gICAgdmFyIGxpZ2h0cyA9IHNjZW5lLl9saWdodHM7XG4gICAgdGhpcy5fbWFwWEZvcm1zID0gW107XG4gICAgdmFyIHVzZVRleEN1YmVMb2QgPSBkZXZpY2UudXNlVGV4Q3ViZUxvZDtcbiAgICB2YXIgdXNlRHAgPSAhZGV2aWNlLmV4dFRleHR1cmVMb2Q7XG4gICAgdmFyIGdsb2JhbFNreTEyOCwgZ2xvYmFsU2t5NjQsIGdsb2JhbFNreTMyLCBnbG9iYWxTa3kxNiwgZ2xvYmFsU2t5OCwgZ2xvYmFsU2t5NDtcbiAgICBpZiAodGhpcy51c2VTa3lib3gpIHtcbiAgICAgIGdsb2JhbFNreTEyOCA9IHNjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFswXTtcbiAgICAgIGdsb2JhbFNreTY0ID0gc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzFdO1xuICAgICAgZ2xvYmFsU2t5MzIgPSBzY2VuZS5fc2t5Ym94UHJlZmlsdGVyZWRbMl07XG4gICAgICBnbG9iYWxTa3kxNiA9IHNjZW5lLl9za3lib3hQcmVmaWx0ZXJlZFszXTtcbiAgICAgIGdsb2JhbFNreTggPSBzY2VuZS5fc2t5Ym94UHJlZmlsdGVyZWRbNF07XG4gICAgICBnbG9iYWxTa3k0ID0gc2NlbmUuX3NreWJveFByZWZpbHRlcmVkWzVdO1xuICAgIH1cbiAgICB2YXIgcHJlZmlsdGVyZWRDdWJlTWFwMTI4ID0gdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXAxMjggfHwgZ2xvYmFsU2t5MTI4O1xuICAgIHZhciBwcmVmaWx0ZXJlZEN1YmVNYXA2NCA9IHRoaXMucHJlZmlsdGVyZWRDdWJlTWFwNjQgfHwgZ2xvYmFsU2t5NjQ7XG4gICAgdmFyIHByZWZpbHRlcmVkQ3ViZU1hcDMyID0gdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXAzMiB8fCBnbG9iYWxTa3kzMjtcbiAgICB2YXIgcHJlZmlsdGVyZWRDdWJlTWFwMTYgPSB0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDE2IHx8IGdsb2JhbFNreTE2O1xuICAgIHZhciBwcmVmaWx0ZXJlZEN1YmVNYXA4ID0gdGhpcy5wcmVmaWx0ZXJlZEN1YmVNYXA4IHx8IGdsb2JhbFNreTg7XG4gICAgdmFyIHByZWZpbHRlcmVkQ3ViZU1hcDQgPSB0aGlzLnByZWZpbHRlcmVkQ3ViZU1hcDQgfHwgZ2xvYmFsU2t5NDtcbiAgICBpZiAocHJlZmlsdGVyZWRDdWJlTWFwMTI4KSB7XG4gICAgICB2YXIgYWxsTWlwcyA9IHByZWZpbHRlcmVkQ3ViZU1hcDEyOCAmJiBwcmVmaWx0ZXJlZEN1YmVNYXA2NCAmJiBwcmVmaWx0ZXJlZEN1YmVNYXAzMiAmJiBwcmVmaWx0ZXJlZEN1YmVNYXAxNiAmJiBwcmVmaWx0ZXJlZEN1YmVNYXA4ICYmIHByZWZpbHRlcmVkQ3ViZU1hcDQ7XG4gICAgICBpZiAodXNlRHAgJiYgYWxsTWlwcykge1xuICAgICAgICBpZiAoIXByZWZpbHRlcmVkQ3ViZU1hcDEyOC5kcEF0bGFzKSB7XG4gICAgICAgICAgcHJlZmlsdGVyZWRDdWJlTWFwMTI4LmRwQXRsYXMgPSBwYy5nZW5lcmF0ZURwQXRsYXMoZGV2aWNlLCBbcHJlZmlsdGVyZWRDdWJlTWFwMTI4LCBwcmVmaWx0ZXJlZEN1YmVNYXA2NCwgcHJlZmlsdGVyZWRDdWJlTWFwMzIsIHByZWZpbHRlcmVkQ3ViZU1hcDE2LCBwcmVmaWx0ZXJlZEN1YmVNYXA4LCBwcmVmaWx0ZXJlZEN1YmVNYXA0XSk7XG4gICAgICAgICAgcHJlZmlsdGVyZWRDdWJlTWFwMTI4LnNoID0gcGMuc2hGcm9tQ3ViZW1hcChwcmVmaWx0ZXJlZEN1YmVNYXAxNik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kcEF0bGFzID0gcHJlZmlsdGVyZWRDdWJlTWFwMTI4LmRwQXRsYXM7XG4gICAgICAgIHRoaXMuYW1iaWVudFNIID0gcHJlZmlsdGVyZWRDdWJlTWFwMTI4LnNoO1xuICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJhbWJpZW50U0hbMF1cIiwgdGhpcy5hbWJpZW50U0gpO1xuICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3NwaGVyZU1hcFwiLCB0aGlzLmRwQXRsYXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHVzZVRleEN1YmVMb2QpIHtcbiAgICAgICAgICBpZiAocHJlZmlsdGVyZWRDdWJlTWFwMTI4Ll9sZXZlbHMubGVuZ3RoIDwgNikge1xuICAgICAgICAgICAgaWYgKGFsbE1pcHMpIHtcbiAgICAgICAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXAxMjhcIiwgcHJlZmlsdGVyZWRDdWJlTWFwMTI4KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ2FuJ3QgdXNlIHByZWZpbHRlcmVkIGN1YmVtYXA6IFwiICsgYWxsTWlwcyArIFwiLCBcIiArIHVzZVRleEN1YmVMb2QgKyBcIiwgXCIgKyBwcmVmaWx0ZXJlZEN1YmVNYXAxMjguX2xldmVscyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTI4XCIsIHByZWZpbHRlcmVkQ3ViZU1hcDEyOCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChhbGxNaXBzKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDEyOFwiLCBwcmVmaWx0ZXJlZEN1YmVNYXAxMjgpO1xuICAgICAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXA2NFwiLCBwcmVmaWx0ZXJlZEN1YmVNYXA2NCk7XG4gICAgICAgICAgICB0aGlzLl9zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX3ByZWZpbHRlcmVkQ3ViZU1hcDMyXCIsIHByZWZpbHRlcmVkQ3ViZU1hcDMyKTtcbiAgICAgICAgICAgIHRoaXMuX3NldFBhcmFtZXRlcihcInRleHR1cmVfcHJlZmlsdGVyZWRDdWJlTWFwMTZcIiwgcHJlZmlsdGVyZWRDdWJlTWFwMTYpO1xuICAgICAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXA4XCIsIHByZWZpbHRlcmVkQ3ViZU1hcDgpO1xuICAgICAgICAgICAgdGhpcy5fc2V0UGFyYW1ldGVyKFwidGV4dHVyZV9wcmVmaWx0ZXJlZEN1YmVNYXA0XCIsIHByZWZpbHRlcmVkQ3ViZU1hcDQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNhbid0IHVzZSBwcmVmaWx0ZXJlZCBjdWJlbWFwOiBcIiArIGFsbE1pcHMgKyBcIiwgXCIgKyB1c2VUZXhDdWJlTG9kICsgXCIsIFwiICsgcHJlZmlsdGVyZWRDdWJlTWFwMTI4Ll9sZXZlbHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB2YXIgc3BlY3VsYXJUaW50ID0gZmFsc2U7XG4gICAgdmFyIHVzZVNwZWN1bGFyID0gKHRoaXMudXNlTWV0YWxuZXNzID8gdHJ1ZSA6ICEhdGhpcy5zcGVjdWxhck1hcCkgfHwgISF0aGlzLnNwaGVyZU1hcCB8fCAhIXRoaXMuY3ViZU1hcCB8fCAhIXRoaXMuZHBBdGxhcztcbiAgICB1c2VTcGVjdWxhciA9IHVzZVNwZWN1bGFyIHx8ICh0aGlzLnVzZU1ldGFsbmVzcyA/IHRydWUgOiAhKHRoaXMuc3BlY3VsYXIuZGF0YVswXSA9PT0gMCAmJiB0aGlzLnNwZWN1bGFyLmRhdGFbMV0gPT09IDAgJiYgdGhpcy5zcGVjdWxhci5kYXRhWzJdID09PSAwKSk7XG4gICAgaWYgKHVzZVNwZWN1bGFyKSB7XG4gICAgICBpZiAodGhpcy5zcGVjdWxhck1hcFRpbnQgJiYgIXRoaXMudXNlTWV0YWxuZXNzKSB7XG4gICAgICAgIHNwZWN1bGFyVGludCA9IHRoaXMuc3BlY3VsYXIuZGF0YVswXSAhPT0gMSB8fCB0aGlzLnNwZWN1bGFyLmRhdGFbMV0gIT09IDEgfHwgdGhpcy5zcGVjdWxhci5kYXRhWzJdICE9PSAxO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmdibVJlZmxlY3Rpb24gPSAocHJlZmlsdGVyZWRDdWJlTWFwMTI4ID8gcHJlZmlsdGVyZWRDdWJlTWFwMTI4LnJnYm0gOiBmYWxzZSkgfHwgKHRoaXMuY3ViZU1hcCA/IHRoaXMuY3ViZU1hcC5yZ2JtIDogZmFsc2UpIHx8ICh0aGlzLnNwaGVyZU1hcCA/IHRoaXMuc3BoZXJlTWFwLnJnYm0gOiBmYWxzZSkgfHwgKHRoaXMuZHBBdGxhcyA/IHRoaXMuZHBBdGxhcy5yZ2JtIDogZmFsc2UpO1xuICAgIHZhciBoZHJSZWZsZWN0aW9uID0gKHByZWZpbHRlcmVkQ3ViZU1hcDEyOCA/IHByZWZpbHRlcmVkQ3ViZU1hcDEyOC5yZ2JtIHx8IHByZWZpbHRlcmVkQ3ViZU1hcDEyOC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgOiBmYWxzZSkgfHwgKHRoaXMuY3ViZU1hcCA/IHRoaXMuY3ViZU1hcC5yZ2JtIHx8IHRoaXMuY3ViZU1hcC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgOiBmYWxzZSkgfHwgKHRoaXMuc3BoZXJlTWFwID8gdGhpcy5zcGhlcmVNYXAucmdibSB8fCB0aGlzLnNwaGVyZU1hcC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgOiBmYWxzZSkgfHwgKHRoaXMuZHBBdGxhcyA/IHRoaXMuZHBBdGxhcy5yZ2JtIHx8IHRoaXMuZHBBdGxhcy5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgOiBmYWxzZSk7XG4gICAgdmFyIGVtaXNzaXZlVGludCA9ICh0aGlzLmVtaXNzaXZlLmRhdGFbMF0gIT09IDEgfHwgdGhpcy5lbWlzc2l2ZS5kYXRhWzFdICE9PSAxIHx8IHRoaXMuZW1pc3NpdmUuZGF0YVsyXSAhPT0gMSB8fCB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ICE9PSAxKSAmJiB0aGlzLmVtaXNzaXZlTWFwVGludDtcbiAgICBlbWlzc2l2ZVRpbnQgPSBlbWlzc2l2ZVRpbnQgPyAzIDogdGhpcy5lbWlzc2l2ZUludGVuc2l0eSAhPT0gMSA/IDEgOiAwO1xuICAgIHZhciBvcHRpb25zID0ge2ZvZzp0aGlzLnVzZUZvZyA/IHNjZW5lLmZvZyA6IFwibm9uZVwiLCBnYW1tYTp0aGlzLnVzZUdhbW1hVG9uZW1hcCA/IHNjZW5lLmdhbW1hQ29ycmVjdGlvbiA6IHBjLkdBTU1BX05PTkUsIHRvbmVNYXA6dGhpcy51c2VHYW1tYVRvbmVtYXAgPyBzY2VuZS50b25lTWFwcGluZyA6IC0xLCBibGVuZE1hcHNXaXRoQ29sb3JzOnRydWUsIG1vZHVsYXRlQW1iaWVudDp0aGlzLmFtYmllbnRUaW50LCBkaWZmdXNlVGludDoodGhpcy5kaWZmdXNlLmRhdGFbMF0gIT09IDEgfHwgdGhpcy5kaWZmdXNlLmRhdGFbMV0gIT09IDEgfHwgdGhpcy5kaWZmdXNlLmRhdGFbMl0gIT09IDEpICYmIHRoaXMuZGlmZnVzZU1hcFRpbnQsIHNwZWN1bGFyVGludDpzcGVjdWxhclRpbnQsIG1ldGFsbmVzc1RpbnQ6dGhpcy51c2VNZXRhbG5lc3MgJiYgdGhpcy5tZXRhbG5lc3MgPCAxLCBnbG9zc1RpbnQ6dHJ1ZSwgZW1pc3NpdmVUaW50OmVtaXNzaXZlVGludCwgb3BhY2l0eVRpbnQ6dGhpcy5vcGFjaXR5ICE9PVxuICAgIDEgJiYgdGhpcy5ibGVuZFR5cGUgIT09IHBjLkJMRU5EX05PTkUsIGFscGhhVGVzdDp0aGlzLmFscGhhVGVzdCA+IDAsIGFscGhhVG9Db3ZlcmFnZTp0aGlzLmFscGhhVG9Db3ZlcmFnZSwgbmVlZHNOb3JtYWxGbG9hdDp0aGlzLm5vcm1hbGl6ZU5vcm1hbE1hcCwgc3BoZXJlTWFwOiEhdGhpcy5zcGhlcmVNYXAsIGN1YmVNYXA6ISF0aGlzLmN1YmVNYXAsIGRwQXRsYXM6ISF0aGlzLmRwQXRsYXMsIGFtYmllbnRTSDohIXRoaXMuYW1iaWVudFNILCB1c2VTcGVjdWxhcjp1c2VTcGVjdWxhciwgcmdibVJlZmxlY3Rpb246cmdibVJlZmxlY3Rpb24sIGhkclJlZmxlY3Rpb246aGRyUmVmbGVjdGlvbiwgZml4U2VhbXM6cHJlZmlsdGVyZWRDdWJlTWFwMTI4ID8gcHJlZmlsdGVyZWRDdWJlTWFwMTI4LmZpeEN1YmVtYXBTZWFtcyA6IHRoaXMuY3ViZU1hcCA/IHRoaXMuY3ViZU1hcC5maXhDdWJlbWFwU2VhbXMgOiBmYWxzZSwgcHJlZmlsdGVyZWRDdWJlbWFwOiEhcHJlZmlsdGVyZWRDdWJlTWFwMTI4LFxuICAgIGVtaXNzaXZlRm9ybWF0OnRoaXMuZW1pc3NpdmVNYXAgPyB0aGlzLmVtaXNzaXZlTWFwLnJnYm0gPyAxIDogdGhpcy5lbWlzc2l2ZU1hcC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgPyAyIDogMCA6IG51bGwsIGxpZ2h0TWFwRm9ybWF0OnRoaXMubGlnaHRNYXAgPyB0aGlzLmxpZ2h0TWFwLnJnYm0gPyAxIDogdGhpcy5saWdodE1hcC5mb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1JHQkEzMkYgPyAyIDogMCA6IG51bGwsIHVzZVJnYm06cmdibVJlZmxlY3Rpb24gfHwgKHRoaXMuZW1pc3NpdmVNYXAgPyB0aGlzLmVtaXNzaXZlTWFwLnJnYm0gOiAwKSB8fCAodGhpcy5saWdodE1hcCA/IHRoaXMubGlnaHRNYXAucmdibSA6IDApLCBzcGVjdWxhckFBOnRoaXMuc3BlY3VsYXJBbnRpYWxpYXMsIGNvbnNlcnZlRW5lcmd5OnRoaXMuY29uc2VydmVFbmVyZ3ksIG9jY2x1ZGVTcGVjdWxhcjp0aGlzLm9jY2x1ZGVTcGVjdWxhciwgb2NjbHVkZVNwZWN1bGFyRmxvYXQ6dGhpcy5vY2NsdWRlU3BlY3VsYXJJbnRlbnNpdHkgIT09XG4gICAgMS4wLCBvY2NsdWRlRGlyZWN0OnRoaXMub2NjbHVkZURpcmVjdCwgc2hhZGluZ01vZGVsOnRoaXMuc2hhZGluZ01vZGVsLCBmcmVzbmVsTW9kZWw6dGhpcy5mcmVzbmVsTW9kZWwsIHBhY2tlZE5vcm1hbDp0aGlzLm5vcm1hbE1hcCA/IHRoaXMubm9ybWFsTWFwLmZvcm1hdCA9PT0gcGMuUElYRUxGT1JNQVRfRFhUNSA6IGZhbHNlLCBmb3JjZUZyYWdtZW50UHJlY2lzaW9uOnRoaXMuZm9yY2VGcmFnbWVudFByZWNpc2lvbiwgZmFzdFRibjp0aGlzLmZhc3RUYm4sIGN1YmVNYXBQcm9qZWN0aW9uOnRoaXMuY3ViZU1hcFByb2plY3Rpb24sIGNodW5rczp0aGlzLmNodW5rcywgY3VzdG9tRnJhZ21lbnRTaGFkZXI6dGhpcy5jdXN0b21GcmFnbWVudFNoYWRlciwgcmVmcmFjdGlvbjohIXRoaXMucmVmcmFjdGlvbiwgdXNlTWV0YWxuZXNzOnRoaXMudXNlTWV0YWxuZXNzLCBibGVuZFR5cGU6dGhpcy5ibGVuZFR5cGUsIHNreWJveEludGVuc2l0eTpwcmVmaWx0ZXJlZEN1YmVNYXAxMjggPT09XG4gICAgZ2xvYmFsU2t5MTI4ICYmIHByZWZpbHRlcmVkQ3ViZU1hcDEyOCAmJiBzY2VuZS5za3lib3hJbnRlbnNpdHkgIT09IDEsIGZvcmNlVXYxOnRoaXMuZm9yY2VVdjEsIHVzZVRleEN1YmVMb2Q6dXNlVGV4Q3ViZUxvZCwgbXNkZjohIXRoaXMubXNkZk1hcCwgdHdvU2lkZWRMaWdodGluZzp0aGlzLnR3b1NpZGVkTGlnaHRpbmd9O1xuICAgIGlmIChwYXNzID09PSBwYy5TSEFERVJfRk9SV0FSREhEUikge1xuICAgICAgaWYgKG9wdGlvbnMuZ2FtbWEpIHtcbiAgICAgICAgb3B0aW9ucy5nYW1tYSA9IHBjLkdBTU1BX1NSR0JIRFI7XG4gICAgICB9XG4gICAgICBvcHRpb25zLnRvbmVNYXAgPSBwYy5UT05FTUFQX0xJTkVBUjtcbiAgICB9XG4gICAgdmFyIGhhc1V2MCA9IGZhbHNlO1xuICAgIHZhciBoYXNVdjEgPSBmYWxzZTtcbiAgICB2YXIgaGFzVmNvbG9yID0gZmFsc2U7XG4gICAgaWYgKG9iakRlZnMpIHtcbiAgICAgIG9wdGlvbnMubm9TaGFkb3cgPSAob2JqRGVmcyAmIHBjLlNIQURFUkRFRl9OT1NIQURPVykgIT09IDA7XG4gICAgICBvcHRpb25zLnNjcmVlblNwYWNlID0gKG9iakRlZnMgJiBwYy5TSEFERVJERUZfU0NSRUVOU1BBQ0UpICE9PSAwO1xuICAgICAgb3B0aW9ucy5za2luID0gKG9iakRlZnMgJiBwYy5TSEFERVJERUZfU0tJTikgIT09IDA7XG4gICAgICBvcHRpb25zLnVzZUluc3RhbmNpbmcgPSAob2JqRGVmcyAmIHBjLlNIQURFUkRFRl9JTlNUQU5DSU5HKSAhPT0gMDtcbiAgICAgIGlmICgob2JqRGVmcyAmIHBjLlNIQURFUkRFRl9MTSkgIT09IDApIHtcbiAgICAgICAgb3B0aW9ucy5saWdodE1hcEZvcm1hdCA9IDE7XG4gICAgICAgIG9wdGlvbnMubGlnaHRNYXAgPSB0cnVlO1xuICAgICAgICBvcHRpb25zLmxpZ2h0TWFwQ2hhbm5lbCA9IFwicmdiXCI7XG4gICAgICAgIG9wdGlvbnMubGlnaHRNYXBVdiA9IDE7XG4gICAgICAgIG9wdGlvbnMubGlnaHRNYXBUcmFuc2Zvcm0gPSAwO1xuICAgICAgICBvcHRpb25zLmxpZ2h0TWFwV2l0aG91dEFtYmllbnQgPSAhdGhpcy5saWdodE1hcDtcbiAgICAgICAgb3B0aW9ucy51c2VSZ2JtID0gdHJ1ZTtcbiAgICAgICAgaWYgKChvYmpEZWZzICYgcGMuU0hBREVSREVGX0RJUkxNKSAhPT0gMCkge1xuICAgICAgICAgIG9wdGlvbnMuZGlyTGlnaHRNYXAgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBoYXNVdjAgPSAob2JqRGVmcyAmIHBjLlNIQURFUkRFRl9VVjApICE9PSAwO1xuICAgICAgaGFzVXYxID0gKG9iakRlZnMgJiBwYy5TSEFERVJERUZfVVYxKSAhPT0gMDtcbiAgICAgIGhhc1Zjb2xvciA9IChvYmpEZWZzICYgcGMuU0hBREVSREVGX1ZDT0xPUikgIT09IDA7XG4gICAgfVxuICAgIGZvciAodmFyIHAgaW4gcGMuX21hdFRleDJEKSB7XG4gICAgICBpZiAocCA9PT0gXCJvcGFjaXR5XCIgJiYgdGhpcy5ibGVuZFR5cGUgPT09IHBjLkJMRU5EX05PTkUgJiYgdGhpcy5hbHBoYVRlc3QgPT09IDAuMCAmJiAhdGhpcy5hbHBoYVRvQ292ZXJhZ2UpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB2YXIgY25hbWU7XG4gICAgICB2YXIgbW5hbWUgPSBwICsgXCJNYXBcIjtcbiAgICAgIHZhciB2bmFtZSA9IG1uYW1lICsgXCJWZXJ0ZXhDb2xvclwiO1xuICAgICAgaWYgKHAgIT09IFwiaGVpZ2h0XCIgJiYgdGhpc1t2bmFtZV0pIHtcbiAgICAgICAgaWYgKGhhc1Zjb2xvcikge1xuICAgICAgICAgIGNuYW1lID0gbW5hbWUgKyBcIkNoYW5uZWxcIjtcbiAgICAgICAgICBvcHRpb25zW3ZuYW1lXSA9IHRoaXNbdm5hbWVdO1xuICAgICAgICAgIG9wdGlvbnNbY25hbWVdID0gdGhpc1tjbmFtZV07XG4gICAgICAgICAgb3B0aW9ucy52ZXJ0ZXhDb2xvcnMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpc1ttbmFtZV0pIHtcbiAgICAgICAgICB2YXIgdW5hbWUgPSBtbmFtZSArIFwiVXZcIjtcbiAgICAgICAgICB2YXIgYWxsb3cgPSB0cnVlO1xuICAgICAgICAgIGlmICh0aGlzW3VuYW1lXSA9PT0gMCAmJiAhaGFzVXYwKSB7XG4gICAgICAgICAgICBhbGxvdyA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodGhpc1t1bmFtZV0gPT09IDEgJiYgIWhhc1V2MSkge1xuICAgICAgICAgICAgYWxsb3cgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFsbG93KSB7XG4gICAgICAgICAgICBvcHRpb25zW21uYW1lXSA9ICEhdGhpc1ttbmFtZV07XG4gICAgICAgICAgICB2YXIgdG5hbWUgPSBtbmFtZSArIFwiVHJhbnNmb3JtXCI7XG4gICAgICAgICAgICBjbmFtZSA9IG1uYW1lICsgXCJDaGFubmVsXCI7XG4gICAgICAgICAgICBvcHRpb25zW3RuYW1lXSA9IHRoaXMuX2dldE1hcFRyYW5zZm9ybUlEKHRoaXNbdG5hbWVdLCB0aGlzW3VuYW1lXSk7XG4gICAgICAgICAgICBvcHRpb25zW2NuYW1lXSA9IHRoaXNbY25hbWVdO1xuICAgICAgICAgICAgb3B0aW9uc1t1bmFtZV0gPSB0aGlzW3VuYW1lXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgb3B0aW9ucy5hb01hcFV2ID0gb3B0aW9ucy5hb01hcFV2IHx8IHRoaXMuYW9VdlNldDtcbiAgICB0aGlzLl9tYXBYRm9ybXMgPSBudWxsO1xuICAgIGlmICh0aGlzLnVzZUxpZ2h0aW5nKSB7XG4gICAgICB2YXIgbGlnaHRzU29ydGVkID0gW107XG4gICAgICB2YXIgbWFzayA9IG9iakRlZnMgPyBvYmpEZWZzID4+IDE2IDogMTtcbiAgICAgIHRoaXMuX2NvbGxlY3RMaWdodHMocGMuTElHSFRUWVBFX0RJUkVDVElPTkFMLCBsaWdodHMsIGxpZ2h0c1NvcnRlZCwgbWFzayk7XG4gICAgICB0aGlzLl9jb2xsZWN0TGlnaHRzKHBjLkxJR0hUVFlQRV9QT0lOVCwgbGlnaHRzLCBsaWdodHNTb3J0ZWQsIG1hc2ssIHN0YXRpY0xpZ2h0TGlzdCk7XG4gICAgICB0aGlzLl9jb2xsZWN0TGlnaHRzKHBjLkxJR0hUVFlQRV9TUE9ULCBsaWdodHMsIGxpZ2h0c1NvcnRlZCwgbWFzaywgc3RhdGljTGlnaHRMaXN0KTtcbiAgICAgIG9wdGlvbnMubGlnaHRzID0gbGlnaHRzU29ydGVkO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcHRpb25zLmxpZ2h0cyA9IFtdO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5saWdodHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBvcHRpb25zLm5vU2hhZG93ID0gZmFsc2U7XG4gICAgfVxuICAgIHZhciBsaWJyYXJ5ID0gZGV2aWNlLmdldFByb2dyYW1MaWJyYXJ5KCk7XG4gICAgdGhpcy5zaGFkZXIgPSBsaWJyYXJ5LmdldFByb2dyYW0oXCJzdGFuZGFyZFwiLCBvcHRpb25zKTtcbiAgICBpZiAoIW9iakRlZnMpIHtcbiAgICAgIHRoaXMuY2xlYXJWYXJpYW50cygpO1xuICAgICAgdGhpcy52YXJpYW50c1swXSA9IHRoaXMuc2hhZGVyO1xuICAgIH1cbiAgICB0aGlzLmRpcnR5U2hhZGVyID0gZmFsc2U7XG4gIH19KTtcbiAgdmFyIF9kZWZpbmVNYXRlcmlhbFByb3BzID0gZnVuY3Rpb24ob2JqKSB7XG4gICAgb2JqLmRpcnR5U2hhZGVyID0gdHJ1ZTtcbiAgICBvYmouZGlydHlDb2xvciA9IHRydWU7XG4gICAgb2JqLl9zY2VuZSA9IG51bGw7XG4gICAgX2RlZmluZUNvbG9yKG9iaiwgXCJhbWJpZW50XCIsIG5ldyBwYy5Db2xvcigwLjcsIDAuNywgMC43KSk7XG4gICAgX2RlZmluZUNvbG9yKG9iaiwgXCJkaWZmdXNlXCIsIG5ldyBwYy5Db2xvcigxLCAxLCAxKSk7XG4gICAgX2RlZmluZUNvbG9yKG9iaiwgXCJzcGVjdWxhclwiLCBuZXcgcGMuQ29sb3IoMCwgMCwgMCkpO1xuICAgIF9kZWZpbmVDb2xvcihvYmosIFwiZW1pc3NpdmVcIiwgbmV3IHBjLkNvbG9yKDAsIDAsIDApLCB0cnVlKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcInNoaW5pbmVzc1wiLCAyNSwgZnVuY3Rpb24obWF0LCBzaGluaW5lc3MpIHtcbiAgICAgIHZhciB2YWx1ZTtcbiAgICAgIGlmIChtYXQuc2hhZGluZ01vZGVsID09PSBwYy5TUEVDVUxBUl9QSE9ORykge1xuICAgICAgICB2YWx1ZSA9IE1hdGgucG93KDIsIHNoaW5pbmVzcyAqIDAuMDEgKiAxMSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YWx1ZSA9IHNoaW5pbmVzcyAqIDAuMDE7XG4gICAgICB9XG4gICAgICByZXR1cm4ge25hbWU6XCJtYXRlcmlhbF9zaGluaW5lc3NcIiwgdmFsdWU6dmFsdWV9O1xuICAgIH0pO1xuICAgIF9kZWZpbmVGbG9hdChvYmosIFwiaGVpZ2h0TWFwRmFjdG9yXCIsIDEsIGZ1bmN0aW9uKG1hdCwgaGVpZ2h0KSB7XG4gICAgICByZXR1cm4ge25hbWU6XCJtYXRlcmlhbF9oZWlnaHRNYXBGYWN0b3JcIiwgdmFsdWU6aGVpZ2h0ICogMC4wMjV9O1xuICAgIH0pO1xuICAgIF9kZWZpbmVGbG9hdChvYmosIFwib3BhY2l0eVwiLCAxKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcImFscGhhVGVzdFwiLCAwKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcImJ1bXBpbmVzc1wiLCAxKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcInJlZmxlY3Rpdml0eVwiLCAxKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcIm9jY2x1ZGVTcGVjdWxhckludGVuc2l0eVwiLCAxKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcInJlZnJhY3Rpb25cIiwgMCk7XG4gICAgX2RlZmluZUZsb2F0KG9iaiwgXCJyZWZyYWN0aW9uSW5kZXhcIiwgMS4wIC8gMS41KTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcIm1ldGFsbmVzc1wiLCAxKTtcbiAgICBfZGVmaW5lRmxvYXQob2JqLCBcImFvVXZTZXRcIiwgMCwgbnVsbCk7XG4gICAgX2RlZmluZU9iamVjdChvYmosIFwiYW1iaWVudFNIXCIsIGZ1bmN0aW9uKG1hdCwgdmFsLCBjaGFuZ2VNYXQpIHtcbiAgICAgIHJldHVybiB7bmFtZTpcImFtYmllbnRTSFswXVwiLCB2YWx1ZTp2YWx9O1xuICAgIH0pO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcImN1YmVNYXBQcm9qZWN0aW9uQm94XCIsIGZ1bmN0aW9uKG1hdCwgdmFsLCBjaGFuZ2VNYXQpIHtcbiAgICAgIHZhciBibWluID0gY2hhbmdlTWF0ID8gbWF0LmN1YmVNYXBNaW5Vbmlmb3JtIDogbmV3IEZsb2F0MzJBcnJheSgzKTtcbiAgICAgIHZhciBibWF4ID0gY2hhbmdlTWF0ID8gbWF0LmN1YmVNYXBNYXhVbmlmb3JtIDogbmV3IEZsb2F0MzJBcnJheSgzKTtcbiAgICAgIGJtaW5bMF0gPSB2YWwuY2VudGVyLnggLSB2YWwuaGFsZkV4dGVudHMueDtcbiAgICAgIGJtaW5bMV0gPSB2YWwuY2VudGVyLnkgLSB2YWwuaGFsZkV4dGVudHMueTtcbiAgICAgIGJtaW5bMl0gPSB2YWwuY2VudGVyLnogLSB2YWwuaGFsZkV4dGVudHMuejtcbiAgICAgIGJtYXhbMF0gPSB2YWwuY2VudGVyLnggKyB2YWwuaGFsZkV4dGVudHMueDtcbiAgICAgIGJtYXhbMV0gPSB2YWwuY2VudGVyLnkgKyB2YWwuaGFsZkV4dGVudHMueTtcbiAgICAgIGJtYXhbMl0gPSB2YWwuY2VudGVyLnogKyB2YWwuaGFsZkV4dGVudHMuejtcbiAgICAgIHJldHVybiBbe25hbWU6XCJlbnZCb3hNaW5cIiwgdmFsdWU6Ym1pbn0sIHtuYW1lOlwiZW52Qm94TWF4XCIsIHZhbHVlOmJtYXh9XTtcbiAgICB9KTtcbiAgICBfZGVmaW5lQ2h1bmtzKG9iaik7XG4gICAgX2RlZmluZUZsYWcob2JqLCBcImFtYmllbnRUaW50XCIsIGZhbHNlKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwiZGlmZnVzZU1hcFRpbnRcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJzcGVjdWxhck1hcFRpbnRcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJlbWlzc2l2ZU1hcFRpbnRcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJmYXN0VGJuXCIsIGZhbHNlKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwic3BlY3VsYXJBbnRpYWxpYXNcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJ1c2VNZXRhbG5lc3NcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJvY2NsdWRlRGlyZWN0XCIsIGZhbHNlKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwibm9ybWFsaXplTm9ybWFsTWFwXCIsIHRydWUpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJjb25zZXJ2ZUVuZXJneVwiLCB0cnVlKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwib2NjbHVkZVNwZWN1bGFyXCIsIHBjLlNQRUNPQ0NfQU8pO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJzaGFkaW5nTW9kZWxcIiwgcGMuU1BFQ1VMQVJfQkxJTk4pO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJmcmVzbmVsTW9kZWxcIiwgcGMuRlJFU05FTF9OT05FKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwiY3ViZU1hcFByb2plY3Rpb25cIiwgcGMuQ1VCRVBST0pfTk9ORSk7XG4gICAgX2RlZmluZUZsYWcob2JqLCBcImN1c3RvbUZyYWdtZW50U2hhZGVyXCIsIG51bGwpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJmb3JjZUZyYWdtZW50UHJlY2lzaW9uXCIsIG51bGwpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJ1c2VGb2dcIiwgdHJ1ZSk7XG4gICAgX2RlZmluZUZsYWcob2JqLCBcInVzZUxpZ2h0aW5nXCIsIHRydWUpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJ1c2VHYW1tYVRvbmVtYXBcIiwgdHJ1ZSk7XG4gICAgX2RlZmluZUZsYWcob2JqLCBcInVzZVNreWJveFwiLCB0cnVlKTtcbiAgICBfZGVmaW5lRmxhZyhvYmosIFwiZm9yY2VVdjFcIiwgZmFsc2UpO1xuICAgIF9kZWZpbmVGbGFnKG9iaiwgXCJ0d29TaWRlZExpZ2h0aW5nXCIsIGZhbHNlKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcImRpZmZ1c2VcIiwgMCwgMyk7XG4gICAgX2RlZmluZVRleDJEKG9iaiwgXCJzcGVjdWxhclwiLCAwLCAzKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcImVtaXNzaXZlXCIsIDAsIDMpO1xuICAgIF9kZWZpbmVUZXgyRChvYmosIFwibm9ybWFsXCIsIDAsIC0xKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcIm1ldGFsbmVzc1wiLCAwLCAxKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcImdsb3NzXCIsIDAsIDEpO1xuICAgIF9kZWZpbmVUZXgyRChvYmosIFwib3BhY2l0eVwiLCAwLCAxKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcImhlaWdodFwiLCAwLCAxKTtcbiAgICBfZGVmaW5lVGV4MkQob2JqLCBcImFvXCIsIDAsIDEpO1xuICAgIF9kZWZpbmVUZXgyRChvYmosIFwibGlnaHRcIiwgMSwgMyk7XG4gICAgX2RlZmluZVRleDJEKG9iaiwgXCJtc2RmXCIsIDAsIDMpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcImN1YmVNYXBcIik7XG4gICAgX2RlZmluZU9iamVjdChvYmosIFwic3BoZXJlTWFwXCIpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcImRwQXRsYXNcIik7XG4gICAgX2RlZmluZU9iamVjdChvYmosIFwicHJlZmlsdGVyZWRDdWJlTWFwMTI4XCIpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcInByZWZpbHRlcmVkQ3ViZU1hcDY0XCIpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcInByZWZpbHRlcmVkQ3ViZU1hcDMyXCIpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcInByZWZpbHRlcmVkQ3ViZU1hcDE2XCIpO1xuICAgIF9kZWZpbmVPYmplY3Qob2JqLCBcInByZWZpbHRlcmVkQ3ViZU1hcDhcIik7XG4gICAgX2RlZmluZU9iamVjdChvYmosIFwicHJlZmlsdGVyZWRDdWJlTWFwNFwiKTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgX3Byb3BzU2VyaWFsLmxlbmd0aDtpKyspIHtcbiAgICAgIF9wcm9wc1NlcmlhbERlZmF1bHRWYWxbaV0gPSBvYmpbX3Byb3BzU2VyaWFsW2ldXTtcbiAgICB9XG4gICAgb2JqLl9wcm9wc1NldCA9IFtdO1xuICB9O1xuICBfZGVmaW5lTWF0ZXJpYWxQcm9wcyhTdGFuZGFyZE1hdGVyaWFsLnByb3RvdHlwZSk7XG4gIHJldHVybiB7U3RhbmRhcmRNYXRlcmlhbDpTdGFuZGFyZE1hdGVyaWFsfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgaWQgPSAwO1xuICB2YXIgTWVzaCA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3JlZkNvdW50ID0gMDtcbiAgICB0aGlzLmlkID0gaWQrKztcbiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5pbmRleEJ1ZmZlciA9IFtudWxsXTtcbiAgICB0aGlzLnByaW1pdGl2ZSA9IFt7dHlwZTowLCBiYXNlOjAsIGNvdW50OjB9XTtcbiAgICB0aGlzLnNraW4gPSBudWxsO1xuICAgIHRoaXMubW9ycGggPSBudWxsO1xuICAgIHRoaXMuX2FhYmIgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgdGhpcy5ib25lQWFiYiA9IG51bGw7XG4gIH07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNZXNoLnByb3RvdHlwZSwgXCJhYWJiXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubW9ycGggPyB0aGlzLm1vcnBoLmFhYmIgOiB0aGlzLl9hYWJiO1xuICB9LCBzZXQ6ZnVuY3Rpb24oYWFiYikge1xuICAgIGlmICh0aGlzLm1vcnBoKSB7XG4gICAgICB0aGlzLl9hYWJiID0gdGhpcy5tb3JwaC5fYmFzZUFhYmIgPSBhYWJiO1xuICAgICAgdGhpcy5tb3JwaC5fY2FsY3VsYXRlQWFiYigpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hYWJiID0gYWFiYjtcbiAgICB9XG4gIH19KTtcbiAgdmFyIE1lc2hJbnN0YW5jZSA9IGZ1bmN0aW9uIE1lc2hJbnN0YW5jZShub2RlLCBtZXNoLCBtYXRlcmlhbCkge1xuICAgIHRoaXMuX2tleSA9IFswLCAwXTtcbiAgICB0aGlzLl9zaGFkZXIgPSBbbnVsbCwgbnVsbCwgbnVsbF07XG4gICAgdGhpcy5pc1N0YXRpYyA9IGZhbHNlO1xuICAgIHRoaXMuX3N0YXRpY0xpZ2h0TGlzdCA9IG51bGw7XG4gICAgdGhpcy5fc3RhdGljU291cmNlID0gbnVsbDtcbiAgICB0aGlzLm5vZGUgPSBub2RlO1xuICAgIHRoaXMuX21lc2ggPSBtZXNoO1xuICAgIG1lc2guX3JlZkNvdW50Kys7XG4gICAgdGhpcy5tYXRlcmlhbCA9IG1hdGVyaWFsO1xuICAgIHRoaXMuX3NoYWRlckRlZnMgPSAxIDw8IDE2O1xuICAgIHRoaXMuX3NoYWRlckRlZnMgfD0gbWVzaC52ZXJ0ZXhCdWZmZXIuZm9ybWF0Lmhhc1V2MCA/IHBjLlNIQURFUkRFRl9VVjAgOiAwO1xuICAgIHRoaXMuX3NoYWRlckRlZnMgfD0gbWVzaC52ZXJ0ZXhCdWZmZXIuZm9ybWF0Lmhhc1V2MSA/IHBjLlNIQURFUkRFRl9VVjEgOiAwO1xuICAgIHRoaXMuX3NoYWRlckRlZnMgfD0gbWVzaC52ZXJ0ZXhCdWZmZXIuZm9ybWF0Lmhhc0NvbG9yID8gcGMuU0hBREVSREVGX1ZDT0xPUiA6IDA7XG4gICAgdGhpcy52aXNpYmxlID0gdHJ1ZTtcbiAgICB0aGlzLmxheWVyID0gcGMuTEFZRVJfV09STEQ7XG4gICAgdGhpcy5yZW5kZXJTdHlsZSA9IHBjLlJFTkRFUlNUWUxFX1NPTElEO1xuICAgIHRoaXMuY2FzdFNoYWRvdyA9IGZhbHNlO1xuICAgIHRoaXMuX3JlY2VpdmVTaGFkb3cgPSB0cnVlO1xuICAgIHRoaXMuX3NjcmVlblNwYWNlID0gZmFsc2U7XG4gICAgdGhpcy5kcmF3VG9EZXB0aCA9IHRydWU7XG4gICAgdGhpcy5jdWxsID0gdHJ1ZTtcbiAgICB0aGlzLnBpY2sgPSB0cnVlO1xuICAgIHRoaXMuX3VwZGF0ZUFhYmIgPSB0cnVlO1xuICAgIHRoaXMudXBkYXRlS2V5KCk7XG4gICAgdGhpcy5fc2tpbkluc3RhbmNlID0gbnVsbDtcbiAgICB0aGlzLm1vcnBoSW5zdGFuY2UgPSBudWxsO1xuICAgIHRoaXMuaW5zdGFuY2luZ0RhdGEgPSBudWxsO1xuICAgIHRoaXMuYWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICB0aGlzLl9ib25lQWFiYiA9IG51bGw7XG4gICAgdGhpcy5fYWFiYlZlciA9IC0xO1xuICAgIHRoaXMucGFyYW1ldGVycyA9IHt9O1xuICB9O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVzaEluc3RhbmNlLnByb3RvdHlwZSwgXCJtZXNoXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX21lc2g7XG4gIH0sIHNldDpmdW5jdGlvbihtZXNoKSB7XG4gICAgaWYgKHRoaXMuX21lc2gpIHtcbiAgICAgIHRoaXMuX21lc2guX3JlZkNvdW50LS07XG4gICAgfVxuICAgIHRoaXMuX21lc2ggPSBtZXNoO1xuICAgIGlmIChtZXNoKSB7XG4gICAgICBtZXNoLl9yZWZDb3VudCsrO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVzaEluc3RhbmNlLnByb3RvdHlwZSwgXCJhYWJiXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLl91cGRhdGVBYWJiKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWFiYjtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2tpbkluc3RhbmNlKSB7XG4gICAgICB2YXIgbnVtQm9uZXMgPSB0aGlzLm1lc2guc2tpbi5ib25lTmFtZXMubGVuZ3RoO1xuICAgICAgdmFyIGJvbmVVc2VkLCBpO1xuICAgICAgaWYgKCF0aGlzLm1lc2guYm9uZUFhYmIpIHtcbiAgICAgICAgdGhpcy5tZXNoLmJvbmVBYWJiID0gW107XG4gICAgICAgIHRoaXMubWVzaC5ib25lVXNlZCA9IFtdO1xuICAgICAgICB2YXIgZWxlbXMgPSB0aGlzLm1lc2gudmVydGV4QnVmZmVyLmZvcm1hdC5lbGVtZW50cztcbiAgICAgICAgdmFyIG51bVZlcnRzID0gdGhpcy5tZXNoLnZlcnRleEJ1ZmZlci5udW1WZXJ0aWNlcztcbiAgICAgICAgdmFyIHZlcnRTaXplID0gdGhpcy5tZXNoLnZlcnRleEJ1ZmZlci5mb3JtYXQuc2l6ZTtcbiAgICAgICAgdmFyIGluZGV4O1xuICAgICAgICB2YXIgb2Zmc2V0UCwgb2Zmc2V0SSwgb2Zmc2V0VztcbiAgICAgICAgdmFyIGosIGssIGwsIHA7XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IGVsZW1zLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICBpZiAoZWxlbXNbaV0ubmFtZSA9PT0gcGMuU0VNQU5USUNfUE9TSVRJT04pIHtcbiAgICAgICAgICAgIG9mZnNldFAgPSBlbGVtc1tpXS5vZmZzZXQ7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChlbGVtc1tpXS5uYW1lID09PSBwYy5TRU1BTlRJQ19CTEVORElORElDRVMpIHtcbiAgICAgICAgICAgICAgb2Zmc2V0SSA9IGVsZW1zW2ldLm9mZnNldDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChlbGVtc1tpXS5uYW1lID09PSBwYy5TRU1BTlRJQ19CTEVORFdFSUdIVCkge1xuICAgICAgICAgICAgICAgIG9mZnNldFcgPSBlbGVtc1tpXS5vZmZzZXQ7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGRhdGE4ID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5tZXNoLnZlcnRleEJ1ZmZlci5zdG9yYWdlKTtcbiAgICAgICAgdmFyIGRhdGFGID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLm1lc2gudmVydGV4QnVmZmVyLnN0b3JhZ2UpO1xuICAgICAgICB2YXIgb2Zmc2V0UEYgPSBvZmZzZXRQIC8gNDtcbiAgICAgICAgdmFyIG9mZnNldFdGID0gb2Zmc2V0VyAvIDQ7XG4gICAgICAgIHZhciB2ZXJ0U2l6ZUYgPSB2ZXJ0U2l6ZSAvIDQ7XG4gICAgICAgIHZhciBiTWF4LCBiTWluO1xuICAgICAgICB2YXIgeCwgeSwgejtcbiAgICAgICAgdmFyIGJvbmVNaW4gPSBbXTtcbiAgICAgICAgdmFyIGJvbmVNYXggPSBbXTtcbiAgICAgICAgYm9uZVVzZWQgPSB0aGlzLm1lc2guYm9uZVVzZWQ7XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IG51bUJvbmVzO2krKykge1xuICAgICAgICAgIGJvbmVNaW5baV0gPSBuZXcgcGMuVmVjMyhOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTtcbiAgICAgICAgICBib25lTWF4W2ldID0gbmV3IHBjLlZlYzMoLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFLCAtTnVtYmVyLk1BWF9WQUxVRSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChqID0gMDtqIDwgbnVtVmVydHM7aisrKSB7XG4gICAgICAgICAgZm9yIChrID0gMDtrIDwgNDtrKyspIHtcbiAgICAgICAgICAgIGlmIChkYXRhRltqICogdmVydFNpemVGICsgb2Zmc2V0V0YgKyBrXSA+IDApIHtcbiAgICAgICAgICAgICAgaW5kZXggPSBkYXRhOFtqICogdmVydFNpemUgKyBvZmZzZXRJICsga107XG4gICAgICAgICAgICAgIHggPSBkYXRhRltqICogdmVydFNpemVGICsgb2Zmc2V0UEZdO1xuICAgICAgICAgICAgICB5ID0gZGF0YUZbaiAqIHZlcnRTaXplRiArIG9mZnNldFBGICsgMV07XG4gICAgICAgICAgICAgIHogPSBkYXRhRltqICogdmVydFNpemVGICsgb2Zmc2V0UEYgKyAyXTtcbiAgICAgICAgICAgICAgYk1heCA9IGJvbmVNYXhbaW5kZXhdO1xuICAgICAgICAgICAgICBiTWluID0gYm9uZU1pbltpbmRleF07XG4gICAgICAgICAgICAgIGlmIChiTWluLnggPiB4KSB7XG4gICAgICAgICAgICAgICAgYk1pbi54ID0geDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoYk1pbi55ID4geSkge1xuICAgICAgICAgICAgICAgIGJNaW4ueSA9IHk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKGJNaW4ueiA+IHopIHtcbiAgICAgICAgICAgICAgICBiTWluLnogPSB6O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChiTWF4LnggPCB4KSB7XG4gICAgICAgICAgICAgICAgYk1heC54ID0geDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoYk1heC55IDwgeSkge1xuICAgICAgICAgICAgICAgIGJNYXgueSA9IHk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKGJNYXgueiA8IHopIHtcbiAgICAgICAgICAgICAgICBiTWF4LnogPSB6O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJvbmVVc2VkW2luZGV4XSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm1vcnBoSW5zdGFuY2UpIHtcbiAgICAgICAgICB2YXIgdmVydEluZGV4O1xuICAgICAgICAgIHZhciB0YXJnZXRzID0gdGhpcy5tb3JwaEluc3RhbmNlLm1vcnBoLl90YXJnZXRzO1xuICAgICAgICAgIHZhciBtaW5Nb3JwaGVkUG9zID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0cyAqIDMpO1xuICAgICAgICAgIHZhciBtYXhNb3JwaGVkUG9zID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0cyAqIDMpO1xuICAgICAgICAgIHZhciBtLCBkeCwgZHksIGR6O1xuICAgICAgICAgIHZhciB0YXJnZXQsIG10SW5kaWNlcywgbXRJbmRpY2VzTGVuZ3RoLCBkZWx0YVBvcztcbiAgICAgICAgICBmb3IgKGogPSAwO2ogPCBudW1WZXJ0cztqKyspIHtcbiAgICAgICAgICAgIG1pbk1vcnBoZWRQb3NbaiAqIDNdID0gbWF4TW9ycGhlZFBvc1tqICogM10gPSBkYXRhRltqICogdmVydFNpemVGICsgb2Zmc2V0UEZdO1xuICAgICAgICAgICAgbWluTW9ycGhlZFBvc1tqICogMyArIDFdID0gbWF4TW9ycGhlZFBvc1tqICogMyArIDFdID0gZGF0YUZbaiAqIHZlcnRTaXplRiArIG9mZnNldFBGICsgMV07XG4gICAgICAgICAgICBtaW5Nb3JwaGVkUG9zW2ogKiAzICsgMl0gPSBtYXhNb3JwaGVkUG9zW2ogKiAzICsgMl0gPSBkYXRhRltqICogdmVydFNpemVGICsgb2Zmc2V0UEYgKyAyXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZm9yIChsID0gMDtsIDwgdGFyZ2V0cy5sZW5ndGg7bCsrKSB7XG4gICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXRzW2xdO1xuICAgICAgICAgICAgbXRJbmRpY2VzID0gdGFyZ2V0LmluZGljZXM7XG4gICAgICAgICAgICBtdEluZGljZXNMZW5ndGggPSBtdEluZGljZXMubGVuZ3RoO1xuICAgICAgICAgICAgZGVsdGFQb3MgPSB0YXJnZXQuZGVsdGFQb3NpdGlvbnM7XG4gICAgICAgICAgICBmb3IgKGsgPSAwO2sgPCBtdEluZGljZXNMZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIHZlcnRJbmRleCA9IG10SW5kaWNlc1trXTtcbiAgICAgICAgICAgICAgZHggPSBkZWx0YVBvc1trICogM107XG4gICAgICAgICAgICAgIGR5ID0gZGVsdGFQb3NbayAqIDMgKyAxXTtcbiAgICAgICAgICAgICAgZHogPSBkZWx0YVBvc1trICogMyArIDJdO1xuICAgICAgICAgICAgICBpZiAoZHggPCAwKSB7XG4gICAgICAgICAgICAgICAgbWluTW9ycGhlZFBvc1t2ZXJ0SW5kZXggKiAzXSArPSBkeDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtYXhNb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDNdICs9IGR4O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChkeSA8IDApIHtcbiAgICAgICAgICAgICAgICBtaW5Nb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDMgKyAxXSArPSBkeTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtYXhNb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDMgKyAxXSArPSBkeTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoZHogPCAwKSB7XG4gICAgICAgICAgICAgICAgbWluTW9ycGhlZFBvc1t2ZXJ0SW5kZXggKiAzICsgMl0gKz0gZHo7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWF4TW9ycGhlZFBvc1t2ZXJ0SW5kZXggKiAzICsgMl0gKz0gZHo7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgZm9yIChsID0gMDtsIDwgdGFyZ2V0cy5sZW5ndGg7bCsrKSB7XG4gICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXRzW2xdO1xuICAgICAgICAgICAgbXRJbmRpY2VzID0gdGFyZ2V0LmluZGljZXM7XG4gICAgICAgICAgICBtdEluZGljZXNMZW5ndGggPSBtdEluZGljZXMubGVuZ3RoO1xuICAgICAgICAgICAgZGVsdGFQb3MgPSB0YXJnZXQuZGVsdGFQb3NpdGlvbnM7XG4gICAgICAgICAgICBmb3IgKGsgPSAwO2sgPCBtdEluZGljZXNMZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIHZlcnRJbmRleCA9IG10SW5kaWNlc1trXTtcbiAgICAgICAgICAgICAgZm9yIChtID0gMDttIDwgNDttKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YUZbdmVydEluZGV4ICogdmVydFNpemVGICsgb2Zmc2V0V0YgKyBtXSA+IDApIHtcbiAgICAgICAgICAgICAgICAgIGluZGV4ID0gZGF0YThbdmVydEluZGV4ICogdmVydFNpemUgKyBvZmZzZXRJICsgbV07XG4gICAgICAgICAgICAgICAgICBiTWF4ID0gYm9uZU1heFtpbmRleF07XG4gICAgICAgICAgICAgICAgICBiTWluID0gYm9uZU1pbltpbmRleF07XG4gICAgICAgICAgICAgICAgICB4ID0gbWluTW9ycGhlZFBvc1t2ZXJ0SW5kZXggKiAzXTtcbiAgICAgICAgICAgICAgICAgIHkgPSBtaW5Nb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDMgKyAxXTtcbiAgICAgICAgICAgICAgICAgIHogPSBtaW5Nb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDMgKyAyXTtcbiAgICAgICAgICAgICAgICAgIGlmIChiTWluLnggPiB4KSB7XG4gICAgICAgICAgICAgICAgICAgIGJNaW4ueCA9IHg7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBpZiAoYk1pbi55ID4geSkge1xuICAgICAgICAgICAgICAgICAgICBiTWluLnkgPSB5O1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKGJNaW4ueiA+IHopIHtcbiAgICAgICAgICAgICAgICAgICAgYk1pbi56ID0gejtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHggPSBtYXhNb3JwaGVkUG9zW3ZlcnRJbmRleCAqIDNdO1xuICAgICAgICAgICAgICAgICAgeSA9IG1heE1vcnBoZWRQb3NbdmVydEluZGV4ICogMyArIDFdO1xuICAgICAgICAgICAgICAgICAgeiA9IG1heE1vcnBoZWRQb3NbdmVydEluZGV4ICogMyArIDJdO1xuICAgICAgICAgICAgICAgICAgaWYgKGJNYXgueCA8IHgpIHtcbiAgICAgICAgICAgICAgICAgICAgYk1heC54ID0geDtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGlmIChiTWF4LnkgPCB5KSB7XG4gICAgICAgICAgICAgICAgICAgIGJNYXgueSA9IHk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBpZiAoYk1heC56IDwgeikge1xuICAgICAgICAgICAgICAgICAgICBiTWF4LnogPSB6O1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgYWFiYjtcbiAgICAgICAgZm9yIChpID0gMDtpIDwgbnVtQm9uZXM7aSsrKSB7XG4gICAgICAgICAgYWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICAgICAgICBhYWJiLnNldE1pbk1heChib25lTWluW2ldLCBib25lTWF4W2ldKTtcbiAgICAgICAgICB0aGlzLm1lc2guYm9uZUFhYmIucHVzaChhYWJiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLl9ib25lQWFiYikge1xuICAgICAgICB0aGlzLl9ib25lQWFiYiA9IFtdO1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLm1lc2guYm9uZUFhYmIubGVuZ3RoO2krKykge1xuICAgICAgICAgIHRoaXMuX2JvbmVBYWJiW2ldID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBib25lVXNlZCA9IHRoaXMubWVzaC5ib25lVXNlZDtcbiAgICAgIGZvciAoaSA9IDA7aSA8IHRoaXMubWVzaC5ib25lQWFiYi5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmICghYm9uZVVzZWRbaV0pIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9ib25lQWFiYltpXS5zZXRGcm9tVHJhbnNmb3JtZWRBYWJiKHRoaXMubWVzaC5ib25lQWFiYltpXSwgdGhpcy5za2luSW5zdGFuY2UubWF0cmljZXNbaV0pO1xuICAgICAgICB0aGlzLl9ib25lQWFiYltpXS5jZW50ZXIuYWRkKHRoaXMuc2tpbkluc3RhbmNlLnJvb3ROb2RlLmdldFBvc2l0aW9uKCkpO1xuICAgICAgfVxuICAgICAgdmFyIGZpcnN0ID0gdHJ1ZTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IHRoaXMubWVzaC5ib25lQWFiYi5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmICghYm9uZVVzZWRbaV0pIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlyc3QpIHtcbiAgICAgICAgICB0aGlzLl9hYWJiLmNlbnRlci5jb3B5KHRoaXMuX2JvbmVBYWJiW2ldLmNlbnRlcik7XG4gICAgICAgICAgdGhpcy5fYWFiYi5oYWxmRXh0ZW50cy5jb3B5KHRoaXMuX2JvbmVBYWJiW2ldLmhhbGZFeHRlbnRzKTtcbiAgICAgICAgICBmaXJzdCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2FhYmIuYWRkKHRoaXMuX2JvbmVBYWJiW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5ub2RlLl9hYWJiVmVyICE9PSB0aGlzLl9hYWJiVmVyKSB7XG4gICAgICAgIHRoaXMuX2FhYmIuc2V0RnJvbVRyYW5zZm9ybWVkQWFiYih0aGlzLm1lc2guYWFiYiwgdGhpcy5ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCkpO1xuICAgICAgICB0aGlzLl9hYWJiVmVyID0gdGhpcy5ub2RlLl9hYWJiVmVyO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fYWFiYjtcbiAgfSwgc2V0OmZ1bmN0aW9uKGFhYmIpIHtcbiAgICB0aGlzLl9hYWJiID0gYWFiYjtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVzaEluc3RhbmNlLnByb3RvdHlwZSwgXCJtYXRlcmlhbFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9tYXRlcmlhbDtcbiAgfSwgc2V0OmZ1bmN0aW9uKG1hdGVyaWFsKSB7XG4gICAgdmFyIGk7XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5fc2hhZGVyLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMuX3NoYWRlcltpXSA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLl9tYXRlcmlhbCkge1xuICAgICAgdmFyIG1lc2hJbnN0YW5jZXMgPSB0aGlzLl9tYXRlcmlhbC5tZXNoSW5zdGFuY2VzO1xuICAgICAgaSA9IG1lc2hJbnN0YW5jZXMuaW5kZXhPZih0aGlzKTtcbiAgICAgIGlmIChpICE9PSAtMSkge1xuICAgICAgICBtZXNoSW5zdGFuY2VzLnNwbGljZShpLCAxKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fbWF0ZXJpYWwgPSBtYXRlcmlhbDtcbiAgICBpZiAodGhpcy5fbWF0ZXJpYWwpIHtcbiAgICAgIHRoaXMuX21hdGVyaWFsLm1lc2hJbnN0YW5jZXMucHVzaCh0aGlzKTtcbiAgICAgIHRoaXMudXBkYXRlS2V5KCk7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNZXNoSW5zdGFuY2UucHJvdG90eXBlLCBcImxheWVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xheWVyO1xuICB9LCBzZXQ6ZnVuY3Rpb24obGF5ZXIpIHtcbiAgICB0aGlzLl9sYXllciA9IGxheWVyO1xuICAgIHRoaXMudXBkYXRlS2V5KCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1lc2hJbnN0YW5jZS5wcm90b3R5cGUsIFwicmVjZWl2ZVNoYWRvd1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNlaXZlU2hhZG93O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsKSB7XG4gICAgdGhpcy5fcmVjZWl2ZVNoYWRvdyA9IHZhbDtcbiAgICB0aGlzLl9zaGFkZXJEZWZzID0gdmFsID8gdGhpcy5fc2hhZGVyRGVmcyAmIH5wYy5TSEFERVJERUZfTk9TSEFET1cgOiB0aGlzLl9zaGFkZXJEZWZzIHwgcGMuU0hBREVSREVGX05PU0hBRE9XO1xuICAgIHRoaXMuX3NoYWRlcltwYy5TSEFERVJfRk9SV0FSRF0gPSBudWxsO1xuICAgIHRoaXMuX3NoYWRlcltwYy5TSEFERVJfRk9SV0FSREhEUl0gPSBudWxsO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNZXNoSW5zdGFuY2UucHJvdG90eXBlLCBcInNraW5JbnN0YW5jZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9za2luSW5zdGFuY2U7XG4gIH0sIHNldDpmdW5jdGlvbih2YWwpIHtcbiAgICB0aGlzLl9za2luSW5zdGFuY2UgPSB2YWw7XG4gICAgdGhpcy5fc2hhZGVyRGVmcyA9IHZhbCA/IHRoaXMuX3NoYWRlckRlZnMgfCBwYy5TSEFERVJERUZfU0tJTiA6IHRoaXMuX3NoYWRlckRlZnMgJiB+cGMuU0hBREVSREVGX1NLSU47XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX3NoYWRlci5sZW5ndGg7aSsrKSB7XG4gICAgICB0aGlzLl9zaGFkZXJbaV0gPSBudWxsO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVzaEluc3RhbmNlLnByb3RvdHlwZSwgXCJzY3JlZW5TcGFjZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zY3JlZW5TcGFjZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbCkge1xuICAgIHRoaXMuX3NjcmVlblNwYWNlID0gdmFsO1xuICAgIHRoaXMuX3NoYWRlckRlZnMgPSB2YWwgPyB0aGlzLl9zaGFkZXJEZWZzIHwgcGMuU0hBREVSREVGX1NDUkVFTlNQQUNFIDogdGhpcy5fc2hhZGVyRGVmcyAmIH5wYy5TSEFERVJERUZfU0NSRUVOU1BBQ0U7XG4gICAgdGhpcy5fc2hhZGVyW3BjLlNIQURFUl9GT1JXQVJEXSA9IG51bGw7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1lc2hJbnN0YW5jZS5wcm90b3R5cGUsIFwia2V5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2tleVtwYy5TT1JUS0VZX0ZPUldBUkRdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsKSB7XG4gICAgdGhpcy5fa2V5W3BjLlNPUlRLRVlfRk9SV0FSRF0gPSB2YWw7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1lc2hJbnN0YW5jZS5wcm90b3R5cGUsIFwibWFza1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zaGFkZXJEZWZzID4+IDE2O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsKSB7XG4gICAgdmFyIHRvZ2dsZXMgPSB0aGlzLl9zaGFkZXJEZWZzICYgNjU1MzU7XG4gICAgdGhpcy5fc2hhZGVyRGVmcyA9IHRvZ2dsZXMgfCB2YWwgPDwgMTY7XG4gICAgdGhpcy5fc2hhZGVyW3BjLlNIQURFUl9GT1JXQVJEXSA9IG51bGw7XG4gICAgdGhpcy5fc2hhZGVyW3BjLlNIQURFUl9GT1JXQVJESERSXSA9IG51bGw7XG4gIH19KTtcbiAgcGMuZXh0ZW5kKE1lc2hJbnN0YW5jZS5wcm90b3R5cGUsIHtzeW5jQWFiYjpmdW5jdGlvbigpIHtcbiAgfSwgdXBkYXRlS2V5OmZ1bmN0aW9uKCkge1xuICAgIHZhciBtYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7XG4gICAgdGhpcy5fa2V5W3BjLlNPUlRLRVlfRk9SV0FSRF0gPSBnZXRLZXkodGhpcy5sYXllciwgbWF0ZXJpYWwuYWxwaGFUb0NvdmVyYWdlIHx8IG1hdGVyaWFsLmFscGhhVGVzdCA/IHBjLkJMRU5EX05PUk1BTCA6IG1hdGVyaWFsLmJsZW5kVHlwZSwgZmFsc2UsIG1hdGVyaWFsLmlkKTtcbiAgfSwgc2V0UGFyYW1ldGVyOnBjLk1hdGVyaWFsLnByb3RvdHlwZS5zZXRQYXJhbWV0ZXIsIHNldFBhcmFtZXRlcnM6cGMuTWF0ZXJpYWwucHJvdG90eXBlLnNldFBhcmFtZXRlcnMsIGRlbGV0ZVBhcmFtZXRlcjpwYy5NYXRlcmlhbC5wcm90b3R5cGUuZGVsZXRlUGFyYW1ldGVyLCBnZXRQYXJhbWV0ZXI6cGMuTWF0ZXJpYWwucHJvdG90eXBlLmdldFBhcmFtZXRlciwgZ2V0UGFyYW1ldGVyczpwYy5NYXRlcmlhbC5wcm90b3R5cGUuZ2V0UGFyYW1ldGVycywgY2xlYXJQYXJhbWV0ZXJzOnBjLk1hdGVyaWFsLnByb3RvdHlwZS5jbGVhclBhcmFtZXRlcnN9KTtcbiAgdmFyIENvbW1hbmQgPSBmdW5jdGlvbihsYXllciwgYmxlbmRUeXBlLCBjb21tYW5kKSB7XG4gICAgdGhpcy5fa2V5ID0gW107XG4gICAgdGhpcy5fa2V5W3BjLlNPUlRLRVlfRk9SV0FSRF0gPSBnZXRLZXkobGF5ZXIsIGJsZW5kVHlwZSwgdHJ1ZSwgMCk7XG4gICAgdGhpcy5jb21tYW5kID0gY29tbWFuZDtcbiAgfTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENvbW1hbmQucHJvdG90eXBlLCBcImtleVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9rZXlbcGMuU09SVEtFWV9GT1JXQVJEXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbCkge1xuICAgIHRoaXMuX2tleVtwYy5TT1JUS0VZX0ZPUldBUkRdID0gdmFsO1xuICB9fSk7XG4gIHZhciBJbnN0YW5jaW5nRGF0YSA9IGZ1bmN0aW9uKG51bU9iamVjdHMsIGR5bmFtaWMsIGluc3RhbmNlU2l6ZSkge1xuICAgIGluc3RhbmNlU2l6ZSA9IGluc3RhbmNlU2l6ZSB8fCAxNjtcbiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkobnVtT2JqZWN0cyAqIGluc3RhbmNlU2l6ZSk7XG4gICAgdGhpcy5jb3VudCA9IG51bU9iamVjdHM7XG4gICAgdGhpcy5vZmZzZXQgPSAwO1xuICAgIHRoaXMudXNhZ2UgPSBkeW5hbWljID8gcGMuQlVGRkVSX0RZTkFNSUMgOiBwYy5CVUZGRVJfU1RBVElDO1xuICAgIHRoaXMuX2J1ZmZlciA9IG51bGw7XG4gIH07XG4gIEluc3RhbmNpbmdEYXRhLnByb3RvdHlwZSA9IHt1cGRhdGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2J1ZmZlcikge1xuICAgICAgdGhpcy5fYnVmZmVyLnNldERhdGEodGhpcy5idWZmZXIpO1xuICAgIH1cbiAgfX07XG4gIGZ1bmN0aW9uIGdldEtleShsYXllciwgYmxlbmRUeXBlLCBpc0NvbW1hbmQsIG1hdGVyaWFsSWQpIHtcbiAgICByZXR1cm4gKGxheWVyICYgMTUpIDw8IDI3IHwgKGJsZW5kVHlwZSA9PT0gcGMuQkxFTkRfTk9ORSA/IDEgOiAwKSA8PCAyNiB8IChpc0NvbW1hbmQgPyAxIDogMCkgPDwgMjUgfCAobWF0ZXJpYWxJZCAmIDMzNTU0NDMxKSA8PCAwO1xuICB9XG4gIHJldHVybiB7Q29tbWFuZDpDb21tYW5kLCBNZXNoOk1lc2gsIE1lc2hJbnN0YW5jZTpNZXNoSW5zdGFuY2UsIEluc3RhbmNpbmdEYXRhOkluc3RhbmNpbmdEYXRhLCBfZ2V0RHJhd2NhbGxTb3J0S2V5OmdldEtleX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNraW4gPSBmdW5jdGlvbihncmFwaGljc0RldmljZSwgaWJwLCBib25lTmFtZXMpIHtcbiAgICB0aGlzLmRldmljZSA9IGdyYXBoaWNzRGV2aWNlO1xuICAgIHRoaXMuaW52ZXJzZUJpbmRQb3NlID0gaWJwO1xuICAgIHRoaXMuYm9uZU5hbWVzID0gYm9uZU5hbWVzO1xuICB9O1xuICB2YXIgU2tpbkluc3RhbmNlID0gZnVuY3Rpb24oc2tpbiwgbm9kZSkge1xuICAgIHRoaXMuc2tpbiA9IHNraW47XG4gICAgdGhpcy5yb290Tm9kZSA9IG5vZGU7XG4gICAgdGhpcy5fZGlydHkgPSB0cnVlO1xuICAgIHRoaXMuYm9uZXMgPSBbXTtcbiAgICB2YXIgbnVtQm9uZXMgPSBza2luLmludmVyc2VCaW5kUG9zZS5sZW5ndGg7XG4gICAgdmFyIGRldmljZSA9IHNraW4uZGV2aWNlO1xuICAgIGlmIChkZXZpY2Uuc3VwcG9ydHNCb25lVGV4dHVyZXMpIHtcbiAgICAgIHZhciBzaXplO1xuICAgICAgaWYgKG51bUJvbmVzID4gMjU2KSB7XG4gICAgICAgIHNpemUgPSA2NDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChudW1Cb25lcyA+IDY0KSB7XG4gICAgICAgICAgc2l6ZSA9IDMyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChudW1Cb25lcyA+IDE2KSB7XG4gICAgICAgICAgICBzaXplID0gMTY7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNpemUgPSA4O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5ib25lVGV4dHVyZSA9IG5ldyBwYy5UZXh0dXJlKGRldmljZSwge3dpZHRoOnNpemUsIGhlaWdodDpzaXplLCBmb3JtYXQ6cGMuUElYRUxGT1JNQVRfUkdCQTMyRiwgbWlwbWFwczpmYWxzZSwgbWluRmlsdGVyOnBjLkZJTFRFUl9ORUFSRVNULCBtYWdGaWx0ZXI6cGMuRklMVEVSX05FQVJFU1R9KTtcbiAgICAgIHRoaXMubWF0cml4UGFsZXR0ZSA9IHRoaXMuYm9uZVRleHR1cmUubG9jaygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1hdHJpeFBhbGV0dGUgPSBuZXcgRmxvYXQzMkFycmF5KG51bUJvbmVzICogMTYpO1xuICAgIH1cbiAgICB0aGlzLm1hdHJpY2VzID0gW107XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG51bUJvbmVzO2krKykge1xuICAgICAgdGhpcy5tYXRyaWNlc1tpXSA9IG5ldyBwYy5NYXQ0O1xuICAgIH1cbiAgfTtcbiAgU2tpbkluc3RhbmNlLnByb3RvdHlwZSA9IHt1cGRhdGVNYXRyaWNlczpmdW5jdGlvbigpIHtcbiAgICB2YXIgcG9zID0gdGhpcy5yb290Tm9kZS5nZXRQb3NpdGlvbigpO1xuICAgIGZvciAodmFyIGkgPSB0aGlzLmJvbmVzLmxlbmd0aCAtIDE7aSA+PSAwO2ktLSkge1xuICAgICAgdGhpcy5tYXRyaWNlc1tpXS5tdWwyKHRoaXMuYm9uZXNbaV0uZ2V0V29ybGRUcmFuc2Zvcm0oKSwgdGhpcy5za2luLmludmVyc2VCaW5kUG9zZVtpXSk7XG4gICAgICB0aGlzLm1hdHJpY2VzW2ldLmRhdGFbMTJdIC09IHBvcy54O1xuICAgICAgdGhpcy5tYXRyaWNlc1tpXS5kYXRhWzEzXSAtPSBwb3MueTtcbiAgICAgIHRoaXMubWF0cmljZXNbaV0uZGF0YVsxNF0gLT0gcG9zLno7XG4gICAgfVxuICB9LCB1cGRhdGVNYXRyaXhQYWxldHRlOmZ1bmN0aW9uKCkge1xuICAgIHZhciBwZTtcbiAgICB2YXIgbXAgPSB0aGlzLm1hdHJpeFBhbGV0dGU7XG4gICAgdmFyIGJhc2U7XG4gICAgZm9yICh2YXIgaSA9IHRoaXMuYm9uZXMubGVuZ3RoIC0gMTtpID49IDA7aS0tKSB7XG4gICAgICBwZSA9IHRoaXMubWF0cmljZXNbaV0uZGF0YTtcbiAgICAgIGJhc2UgPSBpICogMTY7XG4gICAgICBtcFtiYXNlXSA9IHBlWzBdO1xuICAgICAgbXBbYmFzZSArIDFdID0gcGVbMV07XG4gICAgICBtcFtiYXNlICsgMl0gPSBwZVsyXTtcbiAgICAgIG1wW2Jhc2UgKyAzXSA9IHBlWzNdO1xuICAgICAgbXBbYmFzZSArIDRdID0gcGVbNF07XG4gICAgICBtcFtiYXNlICsgNV0gPSBwZVs1XTtcbiAgICAgIG1wW2Jhc2UgKyA2XSA9IHBlWzZdO1xuICAgICAgbXBbYmFzZSArIDddID0gcGVbN107XG4gICAgICBtcFtiYXNlICsgOF0gPSBwZVs4XTtcbiAgICAgIG1wW2Jhc2UgKyA5XSA9IHBlWzldO1xuICAgICAgbXBbYmFzZSArIDEwXSA9IHBlWzEwXTtcbiAgICAgIG1wW2Jhc2UgKyAxMV0gPSBwZVsxMV07XG4gICAgICBtcFtiYXNlICsgMTJdID0gcGVbMTJdO1xuICAgICAgbXBbYmFzZSArIDEzXSA9IHBlWzEzXTtcbiAgICAgIG1wW2Jhc2UgKyAxNF0gPSBwZVsxNF07XG4gICAgICBtcFtiYXNlICsgMTVdID0gcGVbMTVdO1xuICAgIH1cbiAgICBpZiAodGhpcy5za2luLmRldmljZS5zdXBwb3J0c0JvbmVUZXh0dXJlcykge1xuICAgICAgdGhpcy5ib25lVGV4dHVyZS5sb2NrKCk7XG4gICAgICB0aGlzLmJvbmVUZXh0dXJlLnVubG9jaygpO1xuICAgIH1cbiAgfX07XG4gIHJldHVybiB7U2tpbjpTa2luLCBTa2luSW5zdGFuY2U6U2tpbkluc3RhbmNlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICBmdW5jdGlvbiBQYXJ0aXRpb25lZFZlcnRleCgpIHtcbiAgICB0aGlzLmluZGV4ID0gMDtcbiAgICB0aGlzLmJvbmVJbmRpY2VzID0gWzAsIDAsIDAsIDBdO1xuICB9XG4gIGZ1bmN0aW9uIFNraW5QYXJ0aXRpb24oKSB7XG4gICAgdGhpcy5wYXJ0aXRpb24gPSAwO1xuICAgIHRoaXMudmVydGV4U3RhcnQgPSAwO1xuICAgIHRoaXMudmVydGV4Q291bnQgPSAwO1xuICAgIHRoaXMuaW5kZXhTdGFydCA9IDA7XG4gICAgdGhpcy5pbmRleENvdW50ID0gMDtcbiAgICB0aGlzLmJvbmVJbmRpY2VzID0gW107XG4gICAgdGhpcy52ZXJ0aWNlcyA9IFtdO1xuICAgIHRoaXMuaW5kaWNlcyA9IFtdO1xuICAgIHRoaXMuaW5kZXhNYXAgPSB7fTtcbiAgfVxuICBTa2luUGFydGl0aW9uLnByb3RvdHlwZSA9IHthZGRWZXJ0ZXg6ZnVuY3Rpb24odmVydGV4LCBpZHgsIHZlcnRleEFycmF5KSB7XG4gICAgdmFyIHJlbWFwcGVkSW5kZXggPSAtMTtcbiAgICBpZiAodGhpcy5pbmRleE1hcFtpZHhdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlbWFwcGVkSW5kZXggPSB0aGlzLmluZGV4TWFwW2lkeF07XG4gICAgICB0aGlzLmluZGljZXMucHVzaChyZW1hcHBlZEluZGV4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yICh2YXIgaW5mbHVlbmNlID0gMDtpbmZsdWVuY2UgPCA0O2luZmx1ZW5jZSsrKSB7XG4gICAgICAgIGlmICh2ZXJ0ZXhBcnJheS5ibGVuZFdlaWdodC5kYXRhW2lkeCAqIDQgKyBpbmZsdWVuY2VdID09PSAwKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG9yaWdpbmFsQm9uZUluZGV4ID0gdmVydGV4QXJyYXkuYmxlbmRJbmRpY2VzLmRhdGFbdmVydGV4LmluZGV4ICogNCArIGluZmx1ZW5jZV07XG4gICAgICAgIHZlcnRleC5ib25lSW5kaWNlc1tpbmZsdWVuY2VdID0gdGhpcy5nZXRCb25lUmVtYXAob3JpZ2luYWxCb25lSW5kZXgpO1xuICAgICAgfVxuICAgICAgcmVtYXBwZWRJbmRleCA9IHRoaXMudmVydGljZXMubGVuZ3RoO1xuICAgICAgdGhpcy5pbmRpY2VzLnB1c2gocmVtYXBwZWRJbmRleCk7XG4gICAgICB0aGlzLnZlcnRpY2VzLnB1c2godmVydGV4KTtcbiAgICAgIHRoaXMuaW5kZXhNYXBbaWR4XSA9IHJlbWFwcGVkSW5kZXg7XG4gICAgfVxuICB9LCBhZGRQcmltaXRpdmU6ZnVuY3Rpb24odmVydGljZXMsIHZlcnRleEluZGljZXMsIHZlcnRleEFycmF5LCBib25lTGltaXQpIHtcbiAgICB2YXIgaSwgajtcbiAgICB2YXIgYm9uZXNUb0FkZCA9IFtdO1xuICAgIHZhciBib25lc1RvQWRkQ291bnQgPSAwO1xuICAgIHZhciB2ZXJ0ZXhDb3VudCA9IHZlcnRpY2VzLmxlbmd0aDtcbiAgICBmb3IgKGkgPSAwO2kgPCB2ZXJ0ZXhDb3VudDtpKyspIHtcbiAgICAgIHZhciB2ZXJ0ZXggPSB2ZXJ0aWNlc1tpXTtcbiAgICAgIHZhciBpZHggPSB2ZXJ0ZXguaW5kZXg7XG4gICAgICBmb3IgKHZhciBpbmZsdWVuY2UgPSAwO2luZmx1ZW5jZSA8IDQ7aW5mbHVlbmNlKyspIHtcbiAgICAgICAgaWYgKHZlcnRleEFycmF5LmJsZW5kV2VpZ2h0LmRhdGFbaWR4ICogNCArIGluZmx1ZW5jZV0gPiAwKSB7XG4gICAgICAgICAgdmFyIGJvbmVJbmRleCA9IHZlcnRleEFycmF5LmJsZW5kSW5kaWNlcy5kYXRhW2lkeCAqIDQgKyBpbmZsdWVuY2VdO1xuICAgICAgICAgIHZhciBuZWVkVG9BZGQgPSB0cnVlO1xuICAgICAgICAgIGZvciAoaiA9IDA7aiA8IGJvbmVzVG9BZGRDb3VudDtqKyspIHtcbiAgICAgICAgICAgIGlmIChib25lc1RvQWRkW2pdID09IGJvbmVJbmRleCkge1xuICAgICAgICAgICAgICBuZWVkVG9BZGQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChuZWVkVG9BZGQpIHtcbiAgICAgICAgICAgIGJvbmVzVG9BZGRbYm9uZXNUb0FkZENvdW50XSA9IGJvbmVJbmRleDtcbiAgICAgICAgICAgIHZhciBib25lUmVtYXAgPSB0aGlzLmdldEJvbmVSZW1hcChib25lSW5kZXgpO1xuICAgICAgICAgICAgYm9uZXNUb0FkZENvdW50ICs9IGJvbmVSZW1hcCA9PT0gLTEgPyAxIDogMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuYm9uZUluZGljZXMubGVuZ3RoICsgYm9uZXNUb0FkZENvdW50ID4gYm9uZUxpbWl0KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IGJvbmVzVG9BZGRDb3VudDtpKyspIHtcbiAgICAgIHRoaXMuYm9uZUluZGljZXMucHVzaChib25lc1RvQWRkW2ldKTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgdmVydGV4Q291bnQ7aSsrKSB7XG4gICAgICB0aGlzLmFkZFZlcnRleCh2ZXJ0aWNlc1tpXSwgdmVydGV4SW5kaWNlc1tpXSwgdmVydGV4QXJyYXkpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSwgZ2V0Qm9uZVJlbWFwOmZ1bmN0aW9uKGJvbmVJbmRleCkge1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLmJvbmVJbmRpY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmICh0aGlzLmJvbmVJbmRpY2VzW2ldID09PSBib25lSW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIGk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAtMTtcbiAgfX07XG4gIGZ1bmN0aW9uIGluZGljZXNUb1JlZmVyZW5jZXMobW9kZWwpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgdmVydGljZXMgPSBtb2RlbC52ZXJ0aWNlcztcbiAgICB2YXIgc2tpbnMgPSBtb2RlbC5za2lucztcbiAgICB2YXIgbWVzaGVzID0gbW9kZWwubWVzaGVzO1xuICAgIHZhciBtZXNoSW5zdGFuY2VzID0gbW9kZWwubWVzaEluc3RhbmNlcztcbiAgICBmb3IgKGkgPSAwO2kgPCBtZXNoZXMubGVuZ3RoO2krKykge1xuICAgICAgbWVzaGVzW2ldLnZlcnRpY2VzID0gdmVydGljZXNbbWVzaGVzW2ldLnZlcnRpY2VzXTtcbiAgICAgIGlmIChtZXNoZXNbaV0uc2tpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1lc2hlc1tpXS5za2luID0gc2tpbnNbbWVzaGVzW2ldLnNraW5dO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBtZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIG1lc2hJbnN0YW5jZXNbaV0ubWVzaCA9IG1lc2hlc1ttZXNoSW5zdGFuY2VzW2ldLm1lc2hdO1xuICAgIH1cbiAgfVxuICBmdW5jdGlvbiByZWZlcmVuY2VzVG9JbmRpY2VzKG1vZGVsKSB7XG4gICAgdmFyIGk7XG4gICAgdmFyIHZlcnRpY2VzID0gbW9kZWwudmVydGljZXM7XG4gICAgdmFyIHNraW5zID0gbW9kZWwuc2tpbnM7XG4gICAgdmFyIG1lc2hlcyA9IG1vZGVsLm1lc2hlcztcbiAgICB2YXIgbWVzaEluc3RhbmNlcyA9IG1vZGVsLm1lc2hJbnN0YW5jZXM7XG4gICAgZm9yIChpID0gMDtpIDwgbWVzaGVzLmxlbmd0aDtpKyspIHtcbiAgICAgIG1lc2hlc1tpXS52ZXJ0aWNlcyA9IHZlcnRpY2VzLmluZGV4T2YobWVzaGVzW2ldLnZlcnRpY2VzKTtcbiAgICAgIGlmIChtZXNoZXNbaV0uc2tpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1lc2hlc1tpXS5za2luID0gc2tpbnMuaW5kZXhPZihtZXNoZXNbaV0uc2tpbik7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgbWVzaEluc3RhbmNlc1tpXS5tZXNoID0gbWVzaGVzLmluZGV4T2YobWVzaEluc3RhbmNlc1tpXS5tZXNoKTtcbiAgICB9XG4gIH1cbiAgZnVuY3Rpb24gcGFydGl0aW9uU2tpbihtb2RlbCwgbWF0ZXJpYWxNYXBwaW5ncywgYm9uZUxpbWl0KSB7XG4gICAgdmFyIGksIGosIGssIGluZGV4O1xuICAgIGluZGljZXNUb1JlZmVyZW5jZXMobW9kZWwpO1xuICAgIHZhciB2ZXJ0ZXhBcnJheXMgPSBtb2RlbC52ZXJ0aWNlcztcbiAgICB2YXIgc2tpbnMgPSBtb2RlbC5za2lucztcbiAgICB2YXIgbWVzaDtcbiAgICB2YXIgbWVzaGVzID0gbW9kZWwubWVzaGVzO1xuICAgIHZhciBtZXNoSW5zdGFuY2VzID0gbW9kZWwubWVzaEluc3RhbmNlcztcbiAgICB2YXIgZ2V0VmVydGV4ID0gZnVuY3Rpb24oaWR4KSB7XG4gICAgICB2YXIgdmVydCA9IG5ldyBQYXJ0aXRpb25lZFZlcnRleDtcbiAgICAgIHZlcnQuaW5kZXggPSBpZHg7XG4gICAgICByZXR1cm4gdmVydDtcbiAgICB9O1xuICAgIGZvciAoaSA9IHNraW5zLmxlbmd0aCAtIDE7aSA+PSAwO2ktLSkge1xuICAgICAgaWYgKHNraW5zW2ldLmJvbmVOYW1lcy5sZW5ndGggPiBib25lTGltaXQpIHtcbiAgICAgICAgdmFyIHNraW4gPSBza2lucy5zcGxpY2UoaSwgMSlbMF07XG4gICAgICAgIHZhciBtZXNoZXNUb1NwbGl0ID0gW107XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IG1lc2hlcy5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgaWYgKG1lc2hlc1tqXS5za2luID09PSBza2luKSB7XG4gICAgICAgICAgICBtZXNoZXNUb1NwbGl0LnB1c2gobWVzaGVzW2pdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChqID0gMDtqIDwgbWVzaGVzVG9TcGxpdC5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgaW5kZXggPSBtZXNoZXMuaW5kZXhPZihtZXNoZXNUb1NwbGl0W2pdKTtcbiAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBtZXNoZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc2hlc1RvU3BsaXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGFydGl0aW9uU2tpbjogVGhlcmUgc2hvdWxkIGJlIGF0IGxlYXN0IG9uZSBtZXNoIHRoYXQgcmVmZXJlbmNlcyBhIHNraW5cIik7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHZlcnRleEFycmF5ID0gbWVzaGVzVG9TcGxpdFswXS52ZXJ0aWNlcztcbiAgICAgICAgZm9yIChqID0gMTtqIDwgbWVzaGVzVG9TcGxpdC5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgaWYgKG1lc2hlc1RvU3BsaXRbal0udmVydGljZXMgIT09IHZlcnRleEFycmF5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwYXJ0aXRpb25Ta2luOiBBbGwgbWVzaGVzIHRoYXQgc2hhcmUgYSBza2luIHNob3VsZCBhbHNvIHNoYXJlIHRoZSBzYW1lIHZlcnRleCBidWZmZXJcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBwYXJ0aXRpb247XG4gICAgICAgIHZhciBwYXJ0aXRpb25zID0gW107XG4gICAgICAgIHZhciBwcmltaXRpdmVWZXJ0aWNlcyA9IFtdO1xuICAgICAgICB2YXIgcHJpbWl0aXZlSW5kaWNlcyA9IFtdO1xuICAgICAgICB2YXIgYmFzZVBhcnRpdGlvbiA9IDA7XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IG1lc2hlc1RvU3BsaXQubGVuZ3RoO2orKykge1xuICAgICAgICAgIG1lc2ggPSBtZXNoZXNUb1NwbGl0W2pdO1xuICAgICAgICAgIHZhciBpbmRpY2VzID0gbWVzaC5pbmRpY2VzO1xuICAgICAgICAgIGZvciAodmFyIGlJbmRleCA9IG1lc2guYmFzZTtpSW5kZXggPCBtZXNoLmJhc2UgKyBtZXNoLmNvdW50Oykge1xuICAgICAgICAgICAgaW5kZXggPSBpbmRpY2VzW2lJbmRleCsrXTtcbiAgICAgICAgICAgIHByaW1pdGl2ZVZlcnRpY2VzWzBdID0gZ2V0VmVydGV4KGluZGV4KTtcbiAgICAgICAgICAgIHByaW1pdGl2ZUluZGljZXNbMF0gPSBpbmRleDtcbiAgICAgICAgICAgIGluZGV4ID0gaW5kaWNlc1tpSW5kZXgrK107XG4gICAgICAgICAgICBwcmltaXRpdmVWZXJ0aWNlc1sxXSA9IGdldFZlcnRleChpbmRleCk7XG4gICAgICAgICAgICBwcmltaXRpdmVJbmRpY2VzWzFdID0gaW5kZXg7XG4gICAgICAgICAgICBpbmRleCA9IGluZGljZXNbaUluZGV4KytdO1xuICAgICAgICAgICAgcHJpbWl0aXZlVmVydGljZXNbMl0gPSBnZXRWZXJ0ZXgoaW5kZXgpO1xuICAgICAgICAgICAgcHJpbWl0aXZlSW5kaWNlc1syXSA9IGluZGV4O1xuICAgICAgICAgICAgdmFyIGFkZGVkID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKHZhciBpQm9uZVBhcnRpdGlvbiA9IGJhc2VQYXJ0aXRpb247aUJvbmVQYXJ0aXRpb24gPCBwYXJ0aXRpb25zLmxlbmd0aDtpQm9uZVBhcnRpdGlvbisrKSB7XG4gICAgICAgICAgICAgIHBhcnRpdGlvbiA9IHBhcnRpdGlvbnNbaUJvbmVQYXJ0aXRpb25dO1xuICAgICAgICAgICAgICBpZiAocGFydGl0aW9uLmFkZFByaW1pdGl2ZShwcmltaXRpdmVWZXJ0aWNlcywgcHJpbWl0aXZlSW5kaWNlcywgdmVydGV4QXJyYXksIGJvbmVMaW1pdCkpIHtcbiAgICAgICAgICAgICAgICBhZGRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghYWRkZWQpIHtcbiAgICAgICAgICAgICAgcGFydGl0aW9uID0gbmV3IFNraW5QYXJ0aXRpb247XG4gICAgICAgICAgICAgIHBhcnRpdGlvbi5vcmlnaW5hbE1lc2ggPSBtZXNoO1xuICAgICAgICAgICAgICBwYXJ0aXRpb24uYWRkUHJpbWl0aXZlKHByaW1pdGl2ZVZlcnRpY2VzLCBwcmltaXRpdmVJbmRpY2VzLCB2ZXJ0ZXhBcnJheSwgYm9uZUxpbWl0KTtcbiAgICAgICAgICAgICAgcGFydGl0aW9ucy5wdXNoKHBhcnRpdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJhc2VQYXJ0aXRpb24gPSBwYXJ0aXRpb25zLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcGFydGl0aW9uZWRWZXJ0aWNlcyA9IFtdO1xuICAgICAgICB2YXIgcGFydGl0aW9uZWRJbmRpY2VzID0gW107XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IHBhcnRpdGlvbnMubGVuZ3RoO2orKykge1xuICAgICAgICAgIHBhcnRpdGlvbiA9IHBhcnRpdGlvbnNbal07XG4gICAgICAgICAgaWYgKHBhcnRpdGlvbi52ZXJ0aWNlcy5sZW5ndGggJiYgcGFydGl0aW9uLmluZGljZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgdmVydGV4U3RhcnQgPSBwYXJ0aXRpb25lZFZlcnRpY2VzLmxlbmd0aDtcbiAgICAgICAgICAgIHZhciB2ZXJ0ZXhDb3VudCA9IHBhcnRpdGlvbi52ZXJ0aWNlcy5sZW5ndGg7XG4gICAgICAgICAgICB2YXIgaW5kZXhTdGFydCA9IHBhcnRpdGlvbmVkSW5kaWNlcy5sZW5ndGg7XG4gICAgICAgICAgICB2YXIgaW5kZXhDb3VudCA9IHBhcnRpdGlvbi5pbmRpY2VzLmxlbmd0aDtcbiAgICAgICAgICAgIHBhcnRpdGlvbi5wYXJ0aXRpb24gPSBqO1xuICAgICAgICAgICAgcGFydGl0aW9uLnZlcnRleFN0YXJ0ID0gdmVydGV4U3RhcnQ7XG4gICAgICAgICAgICBwYXJ0aXRpb24udmVydGV4Q291bnQgPSB2ZXJ0ZXhDb3VudDtcbiAgICAgICAgICAgIHBhcnRpdGlvbi5pbmRleFN0YXJ0ID0gaW5kZXhTdGFydDtcbiAgICAgICAgICAgIHBhcnRpdGlvbi5pbmRleENvdW50ID0gaW5kZXhDb3VudDtcbiAgICAgICAgICAgIHZhciBpU291cjtcbiAgICAgICAgICAgIHZhciBpRGVzdDtcbiAgICAgICAgICAgIGlTb3VyID0gMDtcbiAgICAgICAgICAgIGlEZXN0ID0gdmVydGV4U3RhcnQ7XG4gICAgICAgICAgICB3aGlsZSAoaVNvdXIgPCB2ZXJ0ZXhDb3VudCkge1xuICAgICAgICAgICAgICBwYXJ0aXRpb25lZFZlcnRpY2VzW2lEZXN0KytdID0gcGFydGl0aW9uLnZlcnRpY2VzW2lTb3VyKytdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaVNvdXIgPSAwO1xuICAgICAgICAgICAgaURlc3QgPSBpbmRleFN0YXJ0O1xuICAgICAgICAgICAgd2hpbGUgKGlTb3VyIDwgaW5kZXhDb3VudCkge1xuICAgICAgICAgICAgICBwYXJ0aXRpb25lZEluZGljZXNbaURlc3QrK10gPSBwYXJ0aXRpb24uaW5kaWNlc1tpU291cisrXSArIHZlcnRleFN0YXJ0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgc3BsaXRTa2lucyA9IFtdO1xuICAgICAgICBmb3IgKGogPSAwO2ogPCBwYXJ0aXRpb25zLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICBwYXJ0aXRpb24gPSBwYXJ0aXRpb25zW2pdO1xuICAgICAgICAgIHZhciBpYnAgPSBbXTtcbiAgICAgICAgICB2YXIgYm9uZU5hbWVzID0gW107XG4gICAgICAgICAgZm9yIChrID0gMDtrIDwgcGFydGl0aW9uLmJvbmVJbmRpY2VzLmxlbmd0aDtrKyspIHtcbiAgICAgICAgICAgIGlicC5wdXNoKHNraW4uaW52ZXJzZUJpbmRNYXRyaWNlc1twYXJ0aXRpb24uYm9uZUluZGljZXNba11dKTtcbiAgICAgICAgICAgIGJvbmVOYW1lcy5wdXNoKHNraW4uYm9uZU5hbWVzW3BhcnRpdGlvbi5ib25lSW5kaWNlc1trXV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICB2YXIgc3BsaXRTa2luID0ge2ludmVyc2VCaW5kTWF0cmljZXM6aWJwLCBib25lTmFtZXM6Ym9uZU5hbWVzfTtcbiAgICAgICAgICBzcGxpdFNraW5zLnB1c2goc3BsaXRTa2luKTtcbiAgICAgICAgICBza2lucy5wdXNoKHNwbGl0U2tpbik7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGF0dHJpYiwgYXR0cmliTmFtZSwgZGF0YSwgY29tcG9uZW50cztcbiAgICAgICAgdmFyIHNwbGl0VmVydGV4QXJyYXkgPSB7fTtcbiAgICAgICAgZm9yIChhdHRyaWJOYW1lIGluIHZlcnRleEFycmF5KSB7XG4gICAgICAgICAgc3BsaXRWZXJ0ZXhBcnJheVthdHRyaWJOYW1lXSA9IHtjb21wb25lbnRzOnZlcnRleEFycmF5W2F0dHJpYk5hbWVdLmNvbXBvbmVudHMsIGRhdGE6W10sIHR5cGU6dmVydGV4QXJyYXlbYXR0cmliTmFtZV0udHlwZX07XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChhdHRyaWJOYW1lIGluIHZlcnRleEFycmF5KSB7XG4gICAgICAgICAgaWYgKGF0dHJpYk5hbWUgPT09IFwiYmxlbmRJbmRpY2VzXCIpIHtcbiAgICAgICAgICAgIHZhciBkc3RCb25lSW5kaWNlcyA9IHNwbGl0VmVydGV4QXJyYXlbYXR0cmliTmFtZV0uZGF0YTtcbiAgICAgICAgICAgIGZvciAoaiA9IDA7aiA8IHBhcnRpdGlvbmVkVmVydGljZXMubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgICB2YXIgc3JjQm9uZUluZGljZXMgPSBwYXJ0aXRpb25lZFZlcnRpY2VzW2pdLmJvbmVJbmRpY2VzO1xuICAgICAgICAgICAgICBkc3RCb25lSW5kaWNlcy5wdXNoKHNyY0JvbmVJbmRpY2VzWzBdLCBzcmNCb25lSW5kaWNlc1sxXSwgc3JjQm9uZUluZGljZXNbMl0sIHNyY0JvbmVJbmRpY2VzWzNdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXR0cmliID0gdmVydGV4QXJyYXlbYXR0cmliTmFtZV07XG4gICAgICAgICAgICBkYXRhID0gYXR0cmliLmRhdGE7XG4gICAgICAgICAgICBjb21wb25lbnRzID0gYXR0cmliLmNvbXBvbmVudHM7XG4gICAgICAgICAgICBmb3IgKGogPSAwO2ogPCBwYXJ0aXRpb25lZFZlcnRpY2VzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICAgICAgaW5kZXggPSBwYXJ0aXRpb25lZFZlcnRpY2VzW2pdLmluZGV4O1xuICAgICAgICAgICAgICBmb3IgKGsgPSAwO2sgPCBjb21wb25lbnRzO2srKykge1xuICAgICAgICAgICAgICAgIHNwbGl0VmVydGV4QXJyYXlbYXR0cmliTmFtZV0uZGF0YS5wdXNoKGRhdGFbaW5kZXggKiBjb21wb25lbnRzICsga10pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZlcnRleEFycmF5c1t2ZXJ0ZXhBcnJheXMuaW5kZXhPZih2ZXJ0ZXhBcnJheSldID0gc3BsaXRWZXJ0ZXhBcnJheTtcbiAgICAgICAgdmFyIGJhc2UgPSAwO1xuICAgICAgICBmb3IgKGogPSAwO2ogPCBwYXJ0aXRpb25zLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICBwYXJ0aXRpb24gPSBwYXJ0aXRpb25zW2pdO1xuICAgICAgICAgIG1lc2ggPSB7YWFiYjp7bWluOlswLCAwLCAwXSwgbWF4OlswLCAwLCAwXX0sIHZlcnRpY2VzOnNwbGl0VmVydGV4QXJyYXksIHNraW46c3BsaXRTa2luc1tqXSwgaW5kaWNlczpwYXJ0aXRpb25lZEluZGljZXMuc3BsaWNlKDAsIHBhcnRpdGlvbi5pbmRleENvdW50KSwgdHlwZTpcInRyaWFuZ2xlc1wiLCBiYXNlOjAsIGNvdW50OnBhcnRpdGlvbi5pbmRleENvdW50fTtcbiAgICAgICAgICBtZXNoZXMucHVzaChtZXNoKTtcbiAgICAgICAgICBmb3IgKGsgPSBtZXNoSW5zdGFuY2VzLmxlbmd0aCAtIDE7ayA+PSAwO2stLSkge1xuICAgICAgICAgICAgaWYgKG1lc2hJbnN0YW5jZXNba10ubWVzaCA9PT0gcGFydGl0aW9uLm9yaWdpbmFsTWVzaCkge1xuICAgICAgICAgICAgICBtZXNoSW5zdGFuY2VzLnB1c2goe21lc2g6bWVzaCwgbm9kZTptZXNoSW5zdGFuY2VzW2tdLm5vZGV9KTtcbiAgICAgICAgICAgICAgaWYgKG1hdGVyaWFsTWFwcGluZ3MpIHtcbiAgICAgICAgICAgICAgICBtYXRlcmlhbE1hcHBpbmdzLnB1c2goe21hdGVyaWFsOm1hdGVyaWFsTWFwcGluZ3Nba10ubWF0ZXJpYWwsIHBhdGg6bWF0ZXJpYWxNYXBwaW5nc1trXS5wYXRofSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYmFzZSArPSBwYXJ0aXRpb24uaW5kZXhDb3VudDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGogPSAwO2ogPCBwYXJ0aXRpb25zLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICBwYXJ0aXRpb24gPSBwYXJ0aXRpb25zW2pdO1xuICAgICAgICAgIGZvciAoayA9IG1lc2hJbnN0YW5jZXMubGVuZ3RoIC0gMTtrID49IDA7ay0tKSB7XG4gICAgICAgICAgICBpZiAobWVzaEluc3RhbmNlc1trXS5tZXNoID09PSBwYXJ0aXRpb24ub3JpZ2luYWxNZXNoKSB7XG4gICAgICAgICAgICAgIG1lc2hJbnN0YW5jZXMuc3BsaWNlKGssIDEpO1xuICAgICAgICAgICAgICBpZiAobWF0ZXJpYWxNYXBwaW5ncykge1xuICAgICAgICAgICAgICAgIG1hdGVyaWFsTWFwcGluZ3Muc3BsaWNlKGssIDEpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJlZmVyZW5jZXNUb0luZGljZXMobW9kZWwpO1xuICB9XG4gIHJldHVybiB7cGFydGl0aW9uU2tpbjpwYXJ0aXRpb25Ta2lufTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX21vcnBoTWluID0gbmV3IHBjLlZlYzM7XG4gIHZhciBfbW9ycGhNYXggPSBuZXcgcGMuVmVjMztcbiAgdmFyIE1vcnBoVGFyZ2V0ID0gZnVuY3Rpb24ob3B0aW9ucykge1xuICAgIGlmIChvcHRpb25zLmluZGljZXMpIHtcbiAgICAgIHRoaXMuaW5kaWNlcyA9IG9wdGlvbnMuaW5kaWNlcztcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIGFyciA9IG9wdGlvbnMuZGVsdGFQb3NpdGlvbnM7XG4gICAgICB0aGlzLmluZGljZXMgPSBbXTtcbiAgICAgIHRoaXMuaW5kaWNlcy5sZW5ndGggPSBhcnIubGVuZ3RoO1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IGFyci5sZW5ndGg7aSsrKSB7XG4gICAgICAgIHRoaXMuaW5kaWNlc1tpXSA9IGk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZGVsdGFQb3NpdGlvbnMgPSBvcHRpb25zLmRlbHRhUG9zaXRpb25zO1xuICAgIHRoaXMuZGVsdGFOb3JtYWxzID0gb3B0aW9ucy5kZWx0YU5vcm1hbHM7XG4gICAgdGhpcy5kZWx0YVRhbmdlbnRzID0gb3B0aW9ucy5kZWx0YVRhbmdlbnRzO1xuICAgIHRoaXMubmFtZSA9IG9wdGlvbnMubmFtZTtcbiAgICB0aGlzLmFhYmIgPSBvcHRpb25zLmFhYmI7XG4gIH07XG4gIHZhciBNb3JwaCA9IGZ1bmN0aW9uKHRhcmdldHMpIHtcbiAgICB0aGlzLmFhYmIgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgdGhpcy5fYmFzZUJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5fYmFzZUFhYmIgPSBudWxsO1xuICAgIHRoaXMuX3RhcmdldHMgPSB0YXJnZXRzO1xuICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTtcbiAgICB0aGlzLl9hYWJiRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2Jhc2VEYXRhID0gbnVsbDtcbiAgICB0aGlzLl9vZmZzZXRQRiA9IDA7XG4gICAgdGhpcy5fb2Zmc2V0TkYgPSAwO1xuICAgIHRoaXMuX29mZnNldFRGID0gMDtcbiAgICB0aGlzLl92ZXJ0U2l6ZUYgPSAwO1xuICB9O1xuICBwYy5leHRlbmQoTW9ycGgucHJvdG90eXBlLCB7X3NldEJhc2VNZXNoOmZ1bmN0aW9uKGJhc2VNZXNoKSB7XG4gICAgdGhpcy5fYmFzZUJ1ZmZlciA9IGJhc2VNZXNoLnZlcnRleEJ1ZmZlcjtcbiAgICB0aGlzLl9iYXNlQWFiYiA9IGJhc2VNZXNoLl9hYWJiO1xuICAgIHRoaXMuX2Jhc2VEYXRhID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLl9iYXNlQnVmZmVyLnN0b3JhZ2UpO1xuICAgIHZhciBvZmZzZXRQID0gLTE7XG4gICAgdmFyIG9mZnNldE4gPSAtMTtcbiAgICB2YXIgb2Zmc2V0VCA9IC0xO1xuICAgIHZhciBlbGVtcyA9IHRoaXMuX2Jhc2VCdWZmZXIuZm9ybWF0LmVsZW1lbnRzO1xuICAgIHZhciB2ZXJ0U2l6ZSA9IHRoaXMuX2Jhc2VCdWZmZXIuZm9ybWF0LnNpemU7XG4gICAgZm9yICh2YXIgaiA9IDA7aiA8IGVsZW1zLmxlbmd0aDtqKyspIHtcbiAgICAgIGlmIChlbGVtc1tqXS5uYW1lID09PSBwYy5TRU1BTlRJQ19QT1NJVElPTikge1xuICAgICAgICBvZmZzZXRQID0gZWxlbXNbal0ub2Zmc2V0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX05PUk1BTCkge1xuICAgICAgICAgIG9mZnNldE4gPSBlbGVtc1tqXS5vZmZzZXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX1RBTkdFTlQpIHtcbiAgICAgICAgICAgIG9mZnNldFQgPSBlbGVtc1tqXS5vZmZzZXQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX29mZnNldFBGID0gb2Zmc2V0UCAvIDQ7XG4gICAgdGhpcy5fb2Zmc2V0TkYgPSBvZmZzZXROIC8gNDtcbiAgICB0aGlzLl9vZmZzZXRURiA9IG9mZnNldFQgLyA0O1xuICAgIHRoaXMuX3ZlcnRTaXplRiA9IHZlcnRTaXplIC8gNDtcbiAgICB0aGlzLl9kaXJ0eSA9IHRydWU7XG4gIH0sIF9jYWxjdWxhdGVBYWJiOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fYmFzZUJ1ZmZlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFhYmIuY29weSh0aGlzLl9iYXNlQWFiYik7XG4gICAgdmFyIG51bVZlcnRzID0gdGhpcy5fYmFzZUJ1ZmZlci5udW1WZXJ0aWNlcztcbiAgICB2YXIgbnVtSW5kaWNlcztcbiAgICB2YXIgaSwgaiwgaywgdGFyZ2V0LCBpbmRleCwgaWQ7XG4gICAgdmFyIHgsIHksIHo7XG4gICAgdmFyIHZlcnRTaXplRiA9IHRoaXMuX3ZlcnRTaXplRjtcbiAgICB2YXIgb2Zmc2V0UEYgPSB0aGlzLl9vZmZzZXRQRjtcbiAgICB2YXIgYmFzZURhdGEgPSB0aGlzLl9iYXNlRGF0YTtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl90YXJnZXRzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRhcmdldCA9IHRoaXMuX3RhcmdldHNbaV07XG4gICAgICBpZiAoIXRhcmdldC5hYWJiICYmIHRhcmdldC5pbmRpY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGFyZ2V0LmFhYmIgPSB0aGlzLmFhYmIuY2xvbmUoKTtcbiAgICAgICAgX21vcnBoTWluLnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTtcbiAgICAgICAgX21vcnBoTWF4LnNldCgtTnVtYmVyLk1BWF9WQUxVRSwgLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFKTtcbiAgICAgICAgbnVtSW5kaWNlcyA9IHRhcmdldC5pbmRpY2VzLmxlbmd0aDtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbnVtSW5kaWNlcztqKyspIHtcbiAgICAgICAgICBpbmRleCA9IHRhcmdldC5pbmRpY2VzW2pdO1xuICAgICAgICAgIGlkID0gaW5kZXggKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRQRjtcbiAgICAgICAgICB4ID0gYmFzZURhdGFbaWRdICsgdGFyZ2V0LmRlbHRhUG9zaXRpb25zW2ogKiAzXTtcbiAgICAgICAgICB5ID0gYmFzZURhdGFbaWQgKyAxXSArIHRhcmdldC5kZWx0YVBvc2l0aW9uc1tqICogMyArIDFdO1xuICAgICAgICAgIHogPSBiYXNlRGF0YVtpZCArIDJdICsgdGFyZ2V0LmRlbHRhUG9zaXRpb25zW2ogKiAzICsgMl07XG4gICAgICAgICAgaWYgKF9tb3JwaE1pbi54ID4geCkge1xuICAgICAgICAgICAgX21vcnBoTWluLnggPSB4O1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoX21vcnBoTWluLnkgPiB5KSB7XG4gICAgICAgICAgICBfbW9ycGhNaW4ueSA9IHk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChfbW9ycGhNaW4ueiA+IHopIHtcbiAgICAgICAgICAgIF9tb3JwaE1pbi56ID0gejtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKF9tb3JwaE1heC54IDwgeCkge1xuICAgICAgICAgICAgX21vcnBoTWF4LnggPSB4O1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoX21vcnBoTWF4LnkgPCB5KSB7XG4gICAgICAgICAgICBfbW9ycGhNYXgueSA9IHk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChfbW9ycGhNYXgueiA8IHopIHtcbiAgICAgICAgICAgIF9tb3JwaE1heC56ID0gejtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LmFhYmIuc2V0TWluTWF4KF9tb3JwaE1pbiwgX21vcnBoTWF4KTtcbiAgICAgIH1cbiAgICAgIGlmICh0YXJnZXQuYWFiYikge1xuICAgICAgICB0aGlzLmFhYmIuYWRkKHRhcmdldC5hYWJiKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fYWFiYkRpcnR5ID0gZmFsc2U7XG4gIH0sIGFkZFRhcmdldDpmdW5jdGlvbih0YXJnZXQpIHtcbiAgICB0aGlzLl90YXJnZXRzLnB1c2godGFyZ2V0KTtcbiAgICB0aGlzLl9hYWJiRGlydHkgPSB0cnVlO1xuICB9LCByZW1vdmVUYXJnZXQ6ZnVuY3Rpb24odGFyZ2V0KSB7XG4gICAgdmFyIGluZGV4ID0gdGhpcy5fdGFyZ2V0cy5pbmRleE9mKHRhcmdldCk7XG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgdGhpcy5fdGFyZ2V0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgdGhpcy5fYWFiYkRpcnR5ID0gdHJ1ZTtcbiAgICB9XG4gIH0sIGdldFRhcmdldDpmdW5jdGlvbihpbmRleCkge1xuICAgIHJldHVybiB0aGlzLl90YXJnZXRzW2luZGV4XTtcbiAgfX0pO1xuICB2YXIgTW9ycGhJbnN0YW5jZSA9IGZ1bmN0aW9uKG1vcnBoKSB7XG4gICAgdGhpcy5tb3JwaCA9IG1vcnBoO1xuICAgIHRoaXMuX3ZlcnRleEJ1ZmZlciA9IG51bGw7XG4gICAgdGhpcy5fdmVydGV4RGF0YSA9IG51bGw7XG4gICAgdGhpcy5fd2VpZ2h0cyA9IFtdO1xuICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTtcbiAgfTtcbiAgTW9ycGhJbnN0YW5jZS5wcm90b3R5cGUgPSB7X3NldEJhc2VNZXNoOmZ1bmN0aW9uKGJhc2VNZXNoKSB7XG4gICAgdGhpcy5kZXN0cm95KCk7XG4gICAgdGhpcy5fdmVydGV4QnVmZmVyID0gbmV3IHBjLlZlcnRleEJ1ZmZlcih0aGlzLm1vcnBoLl9iYXNlQnVmZmVyLmRldmljZSwgdGhpcy5tb3JwaC5fYmFzZUJ1ZmZlci5mb3JtYXQsIHRoaXMubW9ycGguX2Jhc2VCdWZmZXIubnVtVmVydGljZXMsIHBjLkJVRkZFUl9EWU5BTUlDLCB0aGlzLm1vcnBoLl9iYXNlQnVmZmVyLnN0b3JhZ2Uuc2xpY2UoMCkpO1xuICAgIHRoaXMuX3ZlcnRleERhdGEgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuX3ZlcnRleEJ1ZmZlci5zdG9yYWdlKTtcbiAgICB0aGlzLl93ZWlnaHRzID0gW107XG4gICAgdGhpcy5fd2VpZ2h0cy5sZW5ndGggPSB0aGlzLm1vcnBoLl90YXJnZXRzLmxlbmd0aDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5tb3JwaC5fdGFyZ2V0cy5sZW5ndGg7aSsrKSB7XG4gICAgICB0aGlzLl93ZWlnaHRzW2ldID0gMDtcbiAgICB9XG4gICAgdGhpcy5fZGlydHkgPSB0cnVlO1xuICB9LCBkZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl92ZXJ0ZXhCdWZmZXIpIHtcbiAgICAgIHRoaXMuX3ZlcnRleEJ1ZmZlci5kZXN0cm95KCk7XG4gICAgICB0aGlzLl92ZXJ0ZXhCdWZmZXIgPSBudWxsO1xuICAgIH1cbiAgfSwgZ2V0V2VpZ2h0OmZ1bmN0aW9uKGluZGV4KSB7XG4gICAgcmV0dXJuIHRoaXMuX3dlaWdodHNbaW5kZXhdO1xuICB9LCBzZXRXZWlnaHQ6ZnVuY3Rpb24oaW5kZXgsIHdlaWdodCkge1xuICAgIHRoaXMuX3dlaWdodHNbaW5kZXhdID0gd2VpZ2h0O1xuICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTtcbiAgfSwgdXBkYXRlQm91bmRzOmZ1bmN0aW9uKG1lc2gpIHtcbiAgICBpZiAodGhpcy5tb3JwaC5fYmFzZUJ1ZmZlciAhPT0gbWVzaC52ZXJ0ZXhCdWZmZXIpIHtcbiAgICAgIHRoaXMubW9ycGguX3NldEJhc2VNZXNoKG1lc2gpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuX3ZlcnRleERhdGEpIHtcbiAgICAgIHRoaXMuX3NldEJhc2VNZXNoKG1lc2gpO1xuICAgIH1cbiAgICBpZiAodGhpcy5tb3JwaC5fYWFiYkRpcnR5KSB7XG4gICAgICB0aGlzLm1vcnBoLl9jYWxjdWxhdGVBYWJiKCk7XG4gICAgfVxuICB9LCB1cGRhdGU6ZnVuY3Rpb24obWVzaCkge1xuICAgIGlmICh0aGlzLm1vcnBoLl9iYXNlQnVmZmVyICE9PSBtZXNoLnZlcnRleEJ1ZmZlcikge1xuICAgICAgdGhpcy5tb3JwaC5fc2V0QmFzZU1lc2gobWVzaCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5fdmVydGV4RGF0YSkge1xuICAgICAgdGhpcy5fc2V0QmFzZU1lc2gobWVzaCk7XG4gICAgfVxuICAgIHZhciBudW1WZXJ0cyA9IHRoaXMubW9ycGguX2Jhc2VCdWZmZXIubnVtVmVydGljZXM7XG4gICAgdmFyIG51bUluZGljZXMsIGluZGV4O1xuICAgIHZhciB0YXJnZXRzID0gdGhpcy5tb3JwaC5fdGFyZ2V0cztcbiAgICB2YXIgd2VpZ2h0cyA9IHRoaXMuX3dlaWdodHM7XG4gICAgdmFyIHRhcmdldCwgd2VpZ2h0LCBqLCBpZCwgajMsIGo0O1xuICAgIHZhciB2ZXJ0U2l6ZUYgPSB0aGlzLm1vcnBoLl92ZXJ0U2l6ZUY7XG4gICAgdmFyIG9mZnNldFBGID0gdGhpcy5tb3JwaC5fb2Zmc2V0UEY7XG4gICAgdmFyIG9mZnNldE5GID0gdGhpcy5tb3JwaC5fb2Zmc2V0TkY7XG4gICAgdmFyIG9mZnNldFRGID0gdGhpcy5tb3JwaC5fb2Zmc2V0VEY7XG4gICAgdmFyIGJhc2VEYXRhID0gdGhpcy5tb3JwaC5fYmFzZURhdGE7XG4gICAgdmFyIHZkYXRhID0gdGhpcy5fdmVydGV4RGF0YTtcbiAgICB2ZGF0YS5zZXQodGhpcy5tb3JwaC5fYmFzZURhdGEpO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0YXJnZXRzLmxlbmd0aDtpKyspIHtcbiAgICAgIHdlaWdodCA9IHdlaWdodHNbaV07XG4gICAgICBpZiAod2VpZ2h0ID09PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdGFyZ2V0ID0gdGFyZ2V0c1tpXTtcbiAgICAgIG51bUluZGljZXMgPSB0YXJnZXQuaW5kaWNlcy5sZW5ndGg7XG4gICAgICBmb3IgKGogPSAwO2ogPCBudW1JbmRpY2VzO2orKykge1xuICAgICAgICBqMyA9IGogKiAzO1xuICAgICAgICBpbmRleCA9IHRhcmdldC5pbmRpY2VzW2pdO1xuICAgICAgICBpZCA9IGluZGV4ICogdmVydFNpemVGICsgb2Zmc2V0UEY7XG4gICAgICAgIHZkYXRhW2lkXSArPSB0YXJnZXQuZGVsdGFQb3NpdGlvbnNbajNdICogd2VpZ2h0O1xuICAgICAgICB2ZGF0YVtpZCArIDFdICs9IHRhcmdldC5kZWx0YVBvc2l0aW9uc1tqMyArIDFdICogd2VpZ2h0O1xuICAgICAgICB2ZGF0YVtpZCArIDJdICs9IHRhcmdldC5kZWx0YVBvc2l0aW9uc1tqMyArIDJdICogd2VpZ2h0O1xuICAgICAgICBpZiAodGFyZ2V0LmRlbHRhTm9ybWFscykge1xuICAgICAgICAgIGlkID0gaW5kZXggKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRORjtcbiAgICAgICAgICB2ZGF0YVtpZF0gKz0gdGFyZ2V0LmRlbHRhTm9ybWFsc1tqM10gKiB3ZWlnaHQ7XG4gICAgICAgICAgdmRhdGFbaWQgKyAxXSArPSB0YXJnZXQuZGVsdGFOb3JtYWxzW2ozICsgMV0gKiB3ZWlnaHQ7XG4gICAgICAgICAgdmRhdGFbaWQgKyAyXSArPSB0YXJnZXQuZGVsdGFOb3JtYWxzW2ozICsgMl0gKiB3ZWlnaHQ7XG4gICAgICAgICAgaWYgKHRhcmdldC5kZWx0YVRhbmdlbnRzKSB7XG4gICAgICAgICAgICBqNCA9IGogKiA0O1xuICAgICAgICAgICAgaWQgPSBpbmRleCAqIHZlcnRTaXplRiArIG9mZnNldFRGO1xuICAgICAgICAgICAgdmRhdGFbaWRdICs9IHRhcmdldC5kZWx0YVRhbmdlbnRzW2o0XSAqIHdlaWdodDtcbiAgICAgICAgICAgIHZkYXRhW2lkICsgMV0gKz0gdGFyZ2V0LmRlbHRhVGFuZ2VudHNbajQgKyAxXSAqIHdlaWdodDtcbiAgICAgICAgICAgIHZkYXRhW2lkICsgMl0gKz0gdGFyZ2V0LmRlbHRhVGFuZ2VudHNbajQgKyAyXSAqIHdlaWdodDtcbiAgICAgICAgICAgIHZkYXRhW2lkICsgM10gKz0gdGFyZ2V0LmRlbHRhVGFuZ2VudHNbajQgKyAzXSAqIHdlaWdodDtcbiAgICAgICAgICAgIHZkYXRhW2lkICsgM10gPSB2ZGF0YVtpZCArIDNdID4gMCA/IDEgOiAtMTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fdmVydGV4QnVmZmVyLnVubG9jaygpO1xuICB9fTtcbiAgcmV0dXJuIHtNb3JwaFRhcmdldDpNb3JwaFRhcmdldCwgTW9ycGg6TW9ycGgsIE1vcnBoSW5zdGFuY2U6TW9ycGhJbnN0YW5jZX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIE1vZGVsID0gZnVuY3Rpb24gTW9kZWwoKSB7XG4gICAgdGhpcy5ncmFwaCA9IG51bGw7XG4gICAgdGhpcy5tZXNoSW5zdGFuY2VzID0gW107XG4gICAgdGhpcy5za2luSW5zdGFuY2VzID0gW107XG4gICAgdGhpcy5tb3JwaEluc3RhbmNlcyA9IFtdO1xuICAgIHRoaXMuY2FtZXJhcyA9IFtdO1xuICAgIHRoaXMubGlnaHRzID0gW107XG4gICAgdGhpcy5fc2hhZGVyc1ZlcnNpb24gPSAwO1xuICB9O1xuICBNb2RlbC5wcm90b3R5cGUgPSB7Z2V0R3JhcGg6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZ3JhcGg7XG4gIH0sIHNldEdyYXBoOmZ1bmN0aW9uKGdyYXBoKSB7XG4gICAgdGhpcy5ncmFwaCA9IGdyYXBoO1xuICB9LCBnZXRDYW1lcmFzOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmNhbWVyYXM7XG4gIH0sIHNldENhbWVyYXM6ZnVuY3Rpb24oY2FtZXJhcykge1xuICAgIHRoaXMuY2FtZXJhcyA9IGNhbWVyYXM7XG4gIH0sIGdldExpZ2h0czpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5saWdodHM7XG4gIH0sIHNldExpZ2h0czpmdW5jdGlvbihsaWdodHMpIHtcbiAgICB0aGlzLmxpZ2h0cyA9IGxpZ2h0cztcbiAgfSwgZ2V0TWF0ZXJpYWxzOmZ1bmN0aW9uKCkge1xuICAgIHZhciBpO1xuICAgIHZhciBtYXRlcmlhbHMgPSBbXTtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLm1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIG1lc2hJbnN0YW5jZSA9IHRoaXMubWVzaEluc3RhbmNlc1tpXTtcbiAgICAgIGlmIChtYXRlcmlhbHMuaW5kZXhPZihtZXNoSW5zdGFuY2UubWF0ZXJpYWwpID09PSAtMSkge1xuICAgICAgICBtYXRlcmlhbHMucHVzaChtZXNoSW5zdGFuY2UubWF0ZXJpYWwpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbWF0ZXJpYWxzO1xuICB9LCBjbG9uZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgaSwgajtcbiAgICB2YXIgc3JjTm9kZXMgPSBbXTtcbiAgICB2YXIgY2xvbmVOb2RlcyA9IFtdO1xuICAgIHZhciBfZHVwbGljYXRlID0gZnVuY3Rpb24obm9kZSkge1xuICAgICAgdmFyIG5ld05vZGUgPSBub2RlLmNsb25lKCk7XG4gICAgICBzcmNOb2Rlcy5wdXNoKG5vZGUpO1xuICAgICAgY2xvbmVOb2Rlcy5wdXNoKG5ld05vZGUpO1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDtpKyspIHtcbiAgICAgICAgbmV3Tm9kZS5hZGRDaGlsZChfZHVwbGljYXRlKG5vZGUuX2NoaWxkcmVuW2ldKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV3Tm9kZTtcbiAgICB9O1xuICAgIHZhciBjbG9uZUdyYXBoID0gX2R1cGxpY2F0ZSh0aGlzLmdyYXBoKTtcbiAgICB2YXIgY2xvbmVNZXNoSW5zdGFuY2VzID0gW107XG4gICAgdmFyIGNsb25lU2tpbkluc3RhbmNlcyA9IFtdO1xuICAgIHZhciBjbG9uZU1vcnBoSW5zdGFuY2VzID0gW107XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5za2luSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBza2luID0gdGhpcy5za2luSW5zdGFuY2VzW2ldLnNraW47XG4gICAgICB2YXIgY2xvbmVTa2luSW5zdGFuY2UgPSBuZXcgcGMuU2tpbkluc3RhbmNlKHNraW4sIGNsb25lR3JhcGgpO1xuICAgICAgdmFyIGJvbmVzID0gW107XG4gICAgICBmb3IgKGogPSAwO2ogPCBza2luLmJvbmVOYW1lcy5sZW5ndGg7aisrKSB7XG4gICAgICAgIHZhciBib25lTmFtZSA9IHNraW4uYm9uZU5hbWVzW2pdO1xuICAgICAgICB2YXIgYm9uZSA9IGNsb25lR3JhcGguZmluZEJ5TmFtZShib25lTmFtZSk7XG4gICAgICAgIGJvbmVzLnB1c2goYm9uZSk7XG4gICAgICB9XG4gICAgICBjbG9uZVNraW5JbnN0YW5jZS5ib25lcyA9IGJvbmVzO1xuICAgICAgY2xvbmVTa2luSW5zdGFuY2VzLnB1c2goY2xvbmVTa2luSW5zdGFuY2UpO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLm1vcnBoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBtb3JwaCA9IHRoaXMubW9ycGhJbnN0YW5jZXNbaV0ubW9ycGg7XG4gICAgICB2YXIgY2xvbmVNb3JwaEluc3RhbmNlID0gbmV3IHBjLk1vcnBoSW5zdGFuY2UobW9ycGgpO1xuICAgICAgY2xvbmVNb3JwaEluc3RhbmNlcy5wdXNoKGNsb25lTW9ycGhJbnN0YW5jZSk7XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IHRoaXMubWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgbWVzaEluc3RhbmNlID0gdGhpcy5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgdmFyIG5vZGVJbmRleCA9IHNyY05vZGVzLmluZGV4T2YobWVzaEluc3RhbmNlLm5vZGUpO1xuICAgICAgdmFyIGNsb25lTWVzaEluc3RhbmNlID0gbmV3IHBjLk1lc2hJbnN0YW5jZShjbG9uZU5vZGVzW25vZGVJbmRleF0sIG1lc2hJbnN0YW5jZS5tZXNoLCBtZXNoSW5zdGFuY2UubWF0ZXJpYWwpO1xuICAgICAgaWYgKG1lc2hJbnN0YW5jZS5za2luSW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIHNraW5JbnN0YW5jZUluZGV4ID0gdGhpcy5za2luSW5zdGFuY2VzLmluZGV4T2YobWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSk7XG4gICAgICAgIGNsb25lTWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSA9IGNsb25lU2tpbkluc3RhbmNlc1tza2luSW5zdGFuY2VJbmRleF07XG4gICAgICB9XG4gICAgICBpZiAobWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIG1vcnBoSW5zdGFuY2VJbmRleCA9IHRoaXMubW9ycGhJbnN0YW5jZXMuaW5kZXhPZihtZXNoSW5zdGFuY2UubW9ycGhJbnN0YW5jZSk7XG4gICAgICAgIGNsb25lTWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UgPSBjbG9uZU1vcnBoSW5zdGFuY2VzW21vcnBoSW5zdGFuY2VJbmRleF07XG4gICAgICB9XG4gICAgICBjbG9uZU1lc2hJbnN0YW5jZXMucHVzaChjbG9uZU1lc2hJbnN0YW5jZSk7XG4gICAgfVxuICAgIHZhciBjbG9uZSA9IG5ldyBwYy5Nb2RlbDtcbiAgICBjbG9uZS5ncmFwaCA9IGNsb25lR3JhcGg7XG4gICAgY2xvbmUubWVzaEluc3RhbmNlcyA9IGNsb25lTWVzaEluc3RhbmNlcztcbiAgICBjbG9uZS5za2luSW5zdGFuY2VzID0gY2xvbmVTa2luSW5zdGFuY2VzO1xuICAgIGNsb25lLm1vcnBoSW5zdGFuY2VzID0gY2xvbmVNb3JwaEluc3RhbmNlcztcbiAgICBjbG9uZS5nZXRHcmFwaCgpLnN5bmNIaWVyYXJjaHkoKTtcbiAgICByZXR1cm4gY2xvbmU7XG4gIH0sIGRlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG1lc2hJbnN0YW5jZXMgPSB0aGlzLm1lc2hJbnN0YW5jZXM7XG4gICAgdmFyIG1lc2hJbnN0YW5jZSwgbWVzaCwgc2tpbiwgbW9ycGgsIGliLCBib25lVGV4LCBqO1xuICAgIHZhciBkZXZpY2U7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgbWVzaEluc3RhbmNlID0gbWVzaEluc3RhbmNlc1tpXTtcbiAgICAgIG1lc2ggPSBtZXNoSW5zdGFuY2UubWVzaDtcbiAgICAgIGlmIChtZXNoKSB7XG4gICAgICAgIG1lc2guX3JlZkNvdW50LS07XG4gICAgICAgIGlmIChtZXNoLl9yZWZDb3VudCA8IDEpIHtcbiAgICAgICAgICBpZiAobWVzaC52ZXJ0ZXhCdWZmZXIpIHtcbiAgICAgICAgICAgIGRldmljZSA9IGRldmljZSB8fCBtZXNoLnZlcnRleEJ1ZmZlci5kZXZpY2U7XG4gICAgICAgICAgICBtZXNoLnZlcnRleEJ1ZmZlci5kZXN0cm95KCk7XG4gICAgICAgICAgICBtZXNoLnZlcnRleEJ1ZmZlciA9IG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZvciAoaiA9IDA7aiA8IG1lc2guaW5kZXhCdWZmZXIubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgZGV2aWNlID0gZGV2aWNlIHx8IG1lc2guaW5kZXhCdWZmZXIuZGV2aWNlO1xuICAgICAgICAgICAgaWIgPSBtZXNoLmluZGV4QnVmZmVyW2pdO1xuICAgICAgICAgICAgaWYgKCFpYikge1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGliLmRlc3Ryb3koKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbWVzaC5pbmRleEJ1ZmZlci5sZW5ndGggPSAwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBza2luID0gbWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZTtcbiAgICAgIGlmIChza2luKSB7XG4gICAgICAgIGJvbmVUZXggPSBza2luLmJvbmVUZXh0dXJlO1xuICAgICAgICBpZiAoYm9uZVRleCkge1xuICAgICAgICAgIGJvbmVUZXguZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlID0gbnVsbDtcbiAgICAgIG1vcnBoID0gbWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2U7XG4gICAgICBpZiAobW9ycGgpIHtcbiAgICAgICAgbW9ycGguZGVzdHJveSgpO1xuICAgICAgfVxuICAgICAgbWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UgPSBudWxsO1xuICAgICAgbWVzaEluc3RhbmNlLm1hdGVyaWFsID0gbnVsbDtcbiAgICB9XG4gIH0sIGdlbmVyYXRlV2lyZWZyYW1lOmZ1bmN0aW9uKCkge1xuICAgIHZhciBpLCBqLCBrO1xuICAgIHZhciBpMSwgaTI7XG4gICAgdmFyIG1lc2gsIGJhc2UsIGNvdW50LCBpbmRleEJ1ZmZlciwgd2lyZUJ1ZmZlcjtcbiAgICB2YXIgc3JjSW5kaWNlcywgZHN0SW5kaWNlcztcbiAgICB2YXIgbWVzaGVzID0gW107XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5tZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIG1lc2ggPSB0aGlzLm1lc2hJbnN0YW5jZXNbaV0ubWVzaDtcbiAgICAgIGlmIChtZXNoZXMuaW5kZXhPZihtZXNoKSA9PT0gLTEpIHtcbiAgICAgICAgbWVzaGVzLnB1c2gobWVzaCk7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBvZmZzZXRzID0gW1swLCAxXSwgWzEsIDJdLCBbMiwgMF1dO1xuICAgIGZvciAoaSA9IDA7aSA8IG1lc2hlcy5sZW5ndGg7aSsrKSB7XG4gICAgICBtZXNoID0gbWVzaGVzW2ldO1xuICAgICAgYmFzZSA9IG1lc2gucHJpbWl0aXZlW3BjLlJFTkRFUlNUWUxFX1NPTElEXS5iYXNlO1xuICAgICAgY291bnQgPSBtZXNoLnByaW1pdGl2ZVtwYy5SRU5ERVJTVFlMRV9TT0xJRF0uY291bnQ7XG4gICAgICBpbmRleEJ1ZmZlciA9IG1lc2guaW5kZXhCdWZmZXJbcGMuUkVOREVSU1RZTEVfU09MSURdO1xuICAgICAgc3JjSW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheShpbmRleEJ1ZmZlci5sb2NrKCkpO1xuICAgICAgdmFyIHVuaXF1ZUxpbmVJbmRpY2VzID0ge307XG4gICAgICB2YXIgbGluZXMgPSBbXTtcbiAgICAgIGZvciAoaiA9IGJhc2U7aiA8IGJhc2UgKyBjb3VudDtqICs9IDMpIHtcbiAgICAgICAgZm9yIChrID0gMDtrIDwgMztrKyspIHtcbiAgICAgICAgICBpMSA9IHNyY0luZGljZXNbaiArIG9mZnNldHNba11bMF1dO1xuICAgICAgICAgIGkyID0gc3JjSW5kaWNlc1tqICsgb2Zmc2V0c1trXVsxXV07XG4gICAgICAgICAgdmFyIGxpbmUgPSBpMSA+IGkyID8gaTIgPDwgMTYgfCBpMSA6IGkxIDw8IDE2IHwgaTI7XG4gICAgICAgICAgaWYgKHVuaXF1ZUxpbmVJbmRpY2VzW2xpbmVdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHVuaXF1ZUxpbmVJbmRpY2VzW2xpbmVdID0gMDtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goaTEsIGkyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGluZGV4QnVmZmVyLnVubG9jaygpO1xuICAgICAgd2lyZUJ1ZmZlciA9IG5ldyBwYy5JbmRleEJ1ZmZlcihpbmRleEJ1ZmZlci5kZXZpY2UsIHBjLklOREVYRk9STUFUX1VJTlQxNiwgbGluZXMubGVuZ3RoKTtcbiAgICAgIGRzdEluZGljZXMgPSBuZXcgVWludDE2QXJyYXkod2lyZUJ1ZmZlci5sb2NrKCkpO1xuICAgICAgZHN0SW5kaWNlcy5zZXQobGluZXMpO1xuICAgICAgd2lyZUJ1ZmZlci51bmxvY2soKTtcbiAgICAgIG1lc2gucHJpbWl0aXZlW3BjLlJFTkRFUlNUWUxFX1dJUkVGUkFNRV0gPSB7dHlwZTpwYy5QUklNSVRJVkVfTElORVMsIGJhc2U6MCwgY291bnQ6bGluZXMubGVuZ3RoLCBpbmRleGVkOnRydWV9O1xuICAgICAgbWVzaC5pbmRleEJ1ZmZlcltwYy5SRU5ERVJTVFlMRV9XSVJFRlJBTUVdID0gd2lyZUJ1ZmZlcjtcbiAgICB9XG4gIH19O1xuICByZXR1cm4ge01vZGVsOk1vZGVsfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgcGFydGljbGVWZXJ0cyA9IFtbLTEsIC0xXSwgWzEsIC0xXSwgWzEsIDFdLCBbLTEsIDFdXTtcbiAgdmFyIF9jcmVhdGVUZXh0dXJlID0gZnVuY3Rpb24oZGV2aWNlLCB3aWR0aCwgaGVpZ2h0LCBwaXhlbERhdGEsIGZvcm1hdCwgbXVsdDhCaXQsIGZpbHRlcikge1xuICAgIGlmICghZm9ybWF0KSB7XG4gICAgICBmb3JtYXQgPSBwYy5QSVhFTEZPUk1BVF9SR0JBMzJGO1xuICAgIH1cbiAgICB2YXIgbWlwRmlsdGVyID0gcGMuRklMVEVSX05FQVJFU1Q7XG4gICAgaWYgKGZpbHRlciAmJiBmb3JtYXQgPT09IHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4KSB7XG4gICAgICBtaXBGaWx0ZXIgPSBwYy5GSUxURVJfTElORUFSO1xuICAgIH1cbiAgICB2YXIgdGV4dHVyZSA9IG5ldyBwYy5UZXh0dXJlKGRldmljZSwge3dpZHRoOndpZHRoLCBoZWlnaHQ6aGVpZ2h0LCBmb3JtYXQ6Zm9ybWF0LCBjdWJlbWFwOmZhbHNlLCBtaXBtYXBzOmZhbHNlLCBtaW5GaWx0ZXI6bWlwRmlsdGVyLCBtYWdGaWx0ZXI6bWlwRmlsdGVyLCBhZGRyZXNzVTpwYy5BRERSRVNTX0NMQU1QX1RPX0VER0UsIGFkZHJlc3NWOnBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRX0pO1xuICAgIHZhciBwaXhlbHMgPSB0ZXh0dXJlLmxvY2soKTtcbiAgICBpZiAoZm9ybWF0ID09PSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCkge1xuICAgICAgdmFyIHRlbXAgPSBuZXcgVWludDhBcnJheShwaXhlbERhdGEubGVuZ3RoKTtcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBwaXhlbERhdGEubGVuZ3RoO2krKykge1xuICAgICAgICB0ZW1wW2ldID0gcGl4ZWxEYXRhW2ldICogbXVsdDhCaXQgKiAyNTU7XG4gICAgICB9XG4gICAgICBwaXhlbERhdGEgPSB0ZW1wO1xuICAgIH1cbiAgICBwaXhlbHMuc2V0KHBpeGVsRGF0YSk7XG4gICAgdGV4dHVyZS51bmxvY2soKTtcbiAgICByZXR1cm4gdGV4dHVyZTtcbiAgfTtcbiAgZnVuY3Rpb24gc2F0dXJhdGUoeCkge1xuICAgIHJldHVybiBNYXRoLm1heChNYXRoLm1pbih4LCAxKSwgMCk7XG4gIH1cbiAgZnVuY3Rpb24gZ2xNb2QoeCwgeSkge1xuICAgIHJldHVybiB4IC0geSAqIE1hdGguZmxvb3IoeCAvIHkpO1xuICB9XG4gIHZhciBkZWZhdWx0MEN1cnZlID0gbmV3IHBjLkN1cnZlKFswLCAwLCAxLCAwXSk7XG4gIHZhciBkZWZhdWx0MUN1cnZlID0gbmV3IHBjLkN1cnZlKFswLCAxLCAxLCAxXSk7XG4gIHZhciBkZWZhdWx0MEN1cnZlMyA9IG5ldyBwYy5DdXJ2ZVNldChbMCwgMCwgMSwgMF0sIFswLCAwLCAxLCAwXSwgWzAsIDAsIDEsIDBdKTtcbiAgdmFyIGRlZmF1bHQxQ3VydmUzID0gbmV3IHBjLkN1cnZlU2V0KFswLCAxLCAxLCAxXSwgWzAsIDEsIDEsIDFdLCBbMCwgMSwgMSwgMV0pO1xuICB2YXIgcGFydGljbGVUZXhIZWlnaHQgPSAyO1xuICB2YXIgcGFydGljbGVUZXhDaGFubmVscyA9IDQ7XG4gIHZhciB2ZWxvY2l0eVZlYyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgbG9jYWxWZWxvY2l0eVZlYyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdmVsb2NpdHlWZWMyID0gbmV3IHBjLlZlYzM7XG4gIHZhciBsb2NhbFZlbG9jaXR5VmVjMiA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcm5kRmFjdG9yM1ZlYyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcGFydGljbGVQb3NQcmV2ID0gbmV3IHBjLlZlYzM7XG4gIHZhciBwYXJ0aWNsZVBvcyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcGFydGljbGVGaW5hbFBvcyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgbW92ZURpclZlYyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcm90TWF0ID0gbmV3IHBjLk1hdDQ7XG4gIHZhciBzcGF3bk1hdHJpeDMgPSBuZXcgcGMuTWF0MztcbiAgdmFyIGVtaXR0ZXJNYXRyaXgzID0gbmV3IHBjLk1hdDM7XG4gIHZhciB1bmlmb3JtU2NhbGUgPSAxO1xuICB2YXIgbm9uVW5pZm9ybVNjYWxlO1xuICB2YXIgc3Bhd25NYXRyaXggPSBuZXcgcGMuTWF0NDtcbiAgdmFyIHJhbmRvbVBvcyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcmFuZG9tUG9zVGZvcm1lZCA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdG1wVmVjMyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdmVsb2NpdHlWID0gbmV3IHBjLlZlYzM7XG4gIHZhciBiTWluID0gbmV3IHBjLlZlYzM7XG4gIHZhciBiTWF4ID0gbmV3IHBjLlZlYzM7XG4gIHZhciBzZXRQcm9wZXJ0eVRhcmdldDtcbiAgdmFyIHNldFByb3BlcnR5T3B0aW9ucztcbiAgZnVuY3Rpb24gc2V0UHJvcGVydHkocE5hbWUsIGRlZmF1bHRWYWwpIHtcbiAgICBpZiAoc2V0UHJvcGVydHlPcHRpb25zW3BOYW1lXSAhPT0gdW5kZWZpbmVkICYmIHNldFByb3BlcnR5T3B0aW9uc1twTmFtZV0gIT09IG51bGwpIHtcbiAgICAgIHNldFByb3BlcnR5VGFyZ2V0W3BOYW1lXSA9IHNldFByb3BlcnR5T3B0aW9uc1twTmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHNldFByb3BlcnR5VGFyZ2V0W3BOYW1lXSA9IGRlZmF1bHRWYWw7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHBhY2szTkZsb2F0cyhhLCBiLCBjKSB7XG4gICAgdmFyIHBhY2tlZCA9IGEgKiAyNTUgPDwgMTYgfCBiICogMjU1IDw8IDggfCBjICogMjU1O1xuICAgIHJldHVybiBwYWNrZWQgLyAoMSA8PCAyNCk7XG4gIH1cbiAgZnVuY3Rpb24gcGFja1RleHR1cmVYWVpfTlhZWihxWFlaLCBxWFlaMikge1xuICAgIHZhciBudW0gPSBxWFlaLmxlbmd0aCAvIDM7XG4gICAgdmFyIGNvbG9ycyA9IG5ldyBBcnJheShudW0gKiA0KTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgbnVtO2krKykge1xuICAgICAgY29sb3JzW2kgKiA0XSA9IHFYWVpbaSAqIDNdO1xuICAgICAgY29sb3JzW2kgKiA0ICsgMV0gPSBxWFlaW2kgKiAzICsgMV07XG4gICAgICBjb2xvcnNbaSAqIDQgKyAyXSA9IHFYWVpbaSAqIDMgKyAyXTtcbiAgICAgIGNvbG9yc1tpICogNCArIDNdID0gcGFjazNORmxvYXRzKHFYWVoyW2kgKiAzXSwgcVhZWjJbaSAqIDMgKyAxXSwgcVhZWjJbaSAqIDMgKyAyXSk7XG4gICAgfVxuICAgIHJldHVybiBjb2xvcnM7XG4gIH1cbiAgZnVuY3Rpb24gcGFja1RleHR1cmVSR0JBKHFSR0IsIHFBKSB7XG4gICAgdmFyIGNvbG9ycyA9IG5ldyBBcnJheShxQS5sZW5ndGggKiA0KTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgcUEubGVuZ3RoO2krKykge1xuICAgICAgY29sb3JzW2kgKiA0XSA9IHFSR0JbaSAqIDNdO1xuICAgICAgY29sb3JzW2kgKiA0ICsgMV0gPSBxUkdCW2kgKiAzICsgMV07XG4gICAgICBjb2xvcnNbaSAqIDQgKyAyXSA9IHFSR0JbaSAqIDMgKyAyXTtcbiAgICAgIGNvbG9yc1tpICogNCArIDNdID0gcUFbaV07XG4gICAgfVxuICAgIHJldHVybiBjb2xvcnM7XG4gIH1cbiAgZnVuY3Rpb24gcGFja1RleHR1cmU1RmxvYXRzKHFBLCBxQiwgcUMsIHFELCBxRSkge1xuICAgIHZhciBjb2xvcnMgPSBuZXcgQXJyYXkocUEubGVuZ3RoICogNCk7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHFBLmxlbmd0aDtpKyspIHtcbiAgICAgIGNvbG9yc1tpICogNF0gPSBxQVtpXTtcbiAgICAgIGNvbG9yc1tpICogNCArIDFdID0gcUJbaV07XG4gICAgICBjb2xvcnNbaSAqIDQgKyAyXSA9IDA7XG4gICAgICBjb2xvcnNbaSAqIDQgKyAzXSA9IHBhY2szTkZsb2F0cyhxQ1tpXSwgcURbaV0sIHFFW2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbG9ycztcbiAgfVxuICBmdW5jdGlvbiBzeW5jVG9DcHUoZGV2aWNlLCB0YXJnKSB7XG4gICAgdmFyIHRleCA9IHRhcmcuX2NvbG9yQnVmZmVyO1xuICAgIHZhciBwaXhlbHMgPSBuZXcgVWludDhBcnJheSh0ZXgud2lkdGggKiB0ZXguaGVpZ2h0ICogNCk7XG4gICAgdmFyIGdsID0gZGV2aWNlLmdsO1xuICAgIGRldmljZS5zZXRGcmFtZWJ1ZmZlcih0YXJnLl9nbEZyYW1lQnVmZmVyKTtcbiAgICBnbC5yZWFkUGl4ZWxzKDAsIDAsIHRleC53aWR0aCwgdGV4LmhlaWdodCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgcGl4ZWxzKTtcbiAgICBpZiAoIXRleC5fbGV2ZWxzKSB7XG4gICAgICB0ZXguX2xldmVscyA9IFtdO1xuICAgIH1cbiAgICB0ZXguX2xldmVsc1swXSA9IHBpeGVscztcbiAgfVxuICB2YXIgUGFydGljbGVFbWl0dGVyID0gZnVuY3Rpb24oZ3JhcGhpY3NEZXZpY2UsIG9wdGlvbnMpIHtcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlID0gZ3JhcGhpY3NEZXZpY2U7XG4gICAgdmFyIGdkID0gZ3JhcGhpY3NEZXZpY2U7XG4gICAgdmFyIHByZWNpc2lvbiA9IDMyO1xuICAgIHRoaXMucHJlY2lzaW9uID0gcHJlY2lzaW9uO1xuICAgIHRoaXMuX2FkZFRpbWVUaW1lID0gMDtcbiAgICBpZiAoIVBhcnRpY2xlRW1pdHRlci5ERUZBVUxUX1BBUkFNX1RFWFRVUkUpIHtcbiAgICAgIHZhciByZXNvbHV0aW9uID0gMTY7XG4gICAgICB2YXIgY2VudGVyUG9pbnQgPSByZXNvbHV0aW9uICogMC41ICsgMC41O1xuICAgICAgdmFyIGR0ZXggPSBuZXcgRmxvYXQzMkFycmF5KHJlc29sdXRpb24gKiByZXNvbHV0aW9uICogNCk7XG4gICAgICB2YXIgeCwgeSwgeGdyYWQsIHlncmFkLCBwLCBjO1xuICAgICAgZm9yICh5ID0gMDt5IDwgcmVzb2x1dGlvbjt5KyspIHtcbiAgICAgICAgZm9yICh4ID0gMDt4IDwgcmVzb2x1dGlvbjt4KyspIHtcbiAgICAgICAgICB4Z3JhZCA9IHggKyAxIC0gY2VudGVyUG9pbnQ7XG4gICAgICAgICAgeWdyYWQgPSB5ICsgMSAtIGNlbnRlclBvaW50O1xuICAgICAgICAgIGMgPSBzYXR1cmF0ZSgxIC0gc2F0dXJhdGUoTWF0aC5zcXJ0KHhncmFkICogeGdyYWQgKyB5Z3JhZCAqIHlncmFkKSAvIHJlc29sdXRpb24pIC0gMC41KTtcbiAgICAgICAgICBwID0geSAqIHJlc29sdXRpb24gKyB4O1xuICAgICAgICAgIGR0ZXhbcCAqIDRdID0gMTtcbiAgICAgICAgICBkdGV4W3AgKiA0ICsgMV0gPSAxO1xuICAgICAgICAgIGR0ZXhbcCAqIDQgKyAyXSA9IDE7XG4gICAgICAgICAgZHRleFtwICogNCArIDNdID0gYztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgUGFydGljbGVFbWl0dGVyLkRFRkFVTFRfUEFSQU1fVEVYVFVSRSA9IF9jcmVhdGVUZXh0dXJlKGdkLCByZXNvbHV0aW9uLCByZXNvbHV0aW9uLCBkdGV4LCBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgMS4wLCB0cnVlKTtcbiAgICAgIFBhcnRpY2xlRW1pdHRlci5ERUZBVUxUX1BBUkFNX1RFWFRVUkUubWluRmlsdGVyID0gcGMuRklMVEVSX0xJTkVBUjtcbiAgICAgIFBhcnRpY2xlRW1pdHRlci5ERUZBVUxUX1BBUkFNX1RFWFRVUkUubWFnRmlsdGVyID0gcGMuRklMVEVSX0xJTkVBUjtcbiAgICB9XG4gICAgc2V0UHJvcGVydHlUYXJnZXQgPSB0aGlzO1xuICAgIHNldFByb3BlcnR5T3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgc2V0UHJvcGVydHkoXCJudW1QYXJ0aWNsZXNcIiwgMSk7XG4gICAgaWYgKHRoaXMubnVtUGFydGljbGVzID4gZ3JhcGhpY3NEZXZpY2UubWF4VGV4dHVyZVNpemUpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IGNhbid0IGNyZWF0ZSBtb3JlIHRoYW4gXCIgKyBncmFwaGljc0RldmljZS5tYXhUZXh0dXJlU2l6ZSArIFwiIHBhcnRpY2xlcyBvbiB0aGlzIGRldmljZS5cIik7XG4gICAgICB0aGlzLm51bVBhcnRpY2xlcyA9IGdyYXBoaWNzRGV2aWNlLm1heFRleHR1cmVTaXplO1xuICAgIH1cbiAgICBzZXRQcm9wZXJ0eShcInJhdGVcIiwgMSk7XG4gICAgc2V0UHJvcGVydHkoXCJyYXRlMlwiLCB0aGlzLnJhdGUpO1xuICAgIHNldFByb3BlcnR5KFwibGlmZXRpbWVcIiwgNTApO1xuICAgIHNldFByb3BlcnR5KFwiZW1pdHRlckV4dGVudHNcIiwgbmV3IHBjLlZlYzMoMCwgMCwgMCkpO1xuICAgIHNldFByb3BlcnR5KFwiZW1pdHRlclJhZGl1c1wiLCAwKTtcbiAgICBzZXRQcm9wZXJ0eShcImVtaXR0ZXJTaGFwZVwiLCBwYy5FTUlUVEVSU0hBUEVfQk9YKTtcbiAgICBzZXRQcm9wZXJ0eShcImluaXRpYWxWZWxvY2l0eVwiLCAxKTtcbiAgICBzZXRQcm9wZXJ0eShcIndyYXBcIiwgZmFsc2UpO1xuICAgIHNldFByb3BlcnR5KFwibG9jYWxTcGFjZVwiLCBmYWxzZSk7XG4gICAgc2V0UHJvcGVydHkoXCJ3cmFwQm91bmRzXCIsIG51bGwpO1xuICAgIHNldFByb3BlcnR5KFwiY29sb3JNYXBcIiwgUGFydGljbGVFbWl0dGVyLkRFRkFVTFRfUEFSQU1fVEVYVFVSRSk7XG4gICAgc2V0UHJvcGVydHkoXCJub3JtYWxNYXBcIiwgbnVsbCk7XG4gICAgc2V0UHJvcGVydHkoXCJsb29wXCIsIHRydWUpO1xuICAgIHNldFByb3BlcnR5KFwicHJlV2FybVwiLCBmYWxzZSk7XG4gICAgc2V0UHJvcGVydHkoXCJzb3J0XCIsIHBjLlBBUlRJQ0xFU09SVF9OT05FKTtcbiAgICBzZXRQcm9wZXJ0eShcIm1vZGVcIiwgcGMuUEFSVElDTEVNT0RFX0dQVSk7XG4gICAgc2V0UHJvcGVydHkoXCJzY2VuZVwiLCBudWxsKTtcbiAgICBzZXRQcm9wZXJ0eShcImxpZ2h0aW5nXCIsIGZhbHNlKTtcbiAgICBzZXRQcm9wZXJ0eShcImhhbGZMYW1iZXJ0XCIsIGZhbHNlKTtcbiAgICBzZXRQcm9wZXJ0eShcImludGVuc2l0eVwiLCAxLjApO1xuICAgIHNldFByb3BlcnR5KFwic3RyZXRjaFwiLCAwLjApO1xuICAgIHNldFByb3BlcnR5KFwiYWxpZ25Ub01vdGlvblwiLCBmYWxzZSk7XG4gICAgc2V0UHJvcGVydHkoXCJkZXB0aFNvZnRlbmluZ1wiLCAwKTtcbiAgICBzZXRQcm9wZXJ0eShcIm1lc2hcIiwgbnVsbCk7XG4gICAgc2V0UHJvcGVydHkoXCJkZXB0aFdyaXRlXCIsIGZhbHNlKTtcbiAgICBzZXRQcm9wZXJ0eShcIm5vRm9nXCIsIGZhbHNlKTtcbiAgICBzZXRQcm9wZXJ0eShcImJsZW5kVHlwZVwiLCBwYy5CTEVORF9OT1JNQUwpO1xuICAgIHNldFByb3BlcnR5KFwibm9kZVwiLCBudWxsKTtcbiAgICBzZXRQcm9wZXJ0eShcInN0YXJ0QW5nbGVcIiwgMCk7XG4gICAgc2V0UHJvcGVydHkoXCJzdGFydEFuZ2xlMlwiLCB0aGlzLnN0YXJ0QW5nbGUpO1xuICAgIHNldFByb3BlcnR5KFwiYW5pbVRpbGVzWFwiLCAxKTtcbiAgICBzZXRQcm9wZXJ0eShcImFuaW1UaWxlc1lcIiwgMSk7XG4gICAgc2V0UHJvcGVydHkoXCJhbmltTnVtRnJhbWVzXCIsIDEpO1xuICAgIHNldFByb3BlcnR5KFwiYW5pbVNwZWVkXCIsIDEpO1xuICAgIHNldFByb3BlcnR5KFwiYW5pbUxvb3BcIiwgdHJ1ZSk7XG4gICAgdGhpcy5mcmFtZVJhbmRvbSA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHNldFByb3BlcnR5KFwiY29sb3JHcmFwaFwiLCBkZWZhdWx0MUN1cnZlMyk7XG4gICAgc2V0UHJvcGVydHkoXCJjb2xvckdyYXBoMlwiLCB0aGlzLmNvbG9yR3JhcGgpO1xuICAgIHNldFByb3BlcnR5KFwic2NhbGVHcmFwaFwiLCBkZWZhdWx0MUN1cnZlKTtcbiAgICBzZXRQcm9wZXJ0eShcInNjYWxlR3JhcGgyXCIsIHRoaXMuc2NhbGVHcmFwaCk7XG4gICAgc2V0UHJvcGVydHkoXCJhbHBoYUdyYXBoXCIsIGRlZmF1bHQxQ3VydmUpO1xuICAgIHNldFByb3BlcnR5KFwiYWxwaGFHcmFwaDJcIiwgdGhpcy5hbHBoYUdyYXBoKTtcbiAgICBzZXRQcm9wZXJ0eShcImxvY2FsVmVsb2NpdHlHcmFwaFwiLCBkZWZhdWx0MEN1cnZlMyk7XG4gICAgc2V0UHJvcGVydHkoXCJsb2NhbFZlbG9jaXR5R3JhcGgyXCIsIHRoaXMubG9jYWxWZWxvY2l0eUdyYXBoKTtcbiAgICBzZXRQcm9wZXJ0eShcInZlbG9jaXR5R3JhcGhcIiwgZGVmYXVsdDBDdXJ2ZTMpO1xuICAgIHNldFByb3BlcnR5KFwidmVsb2NpdHlHcmFwaDJcIiwgdGhpcy52ZWxvY2l0eUdyYXBoKTtcbiAgICBzZXRQcm9wZXJ0eShcInJvdGF0aW9uU3BlZWRHcmFwaFwiLCBkZWZhdWx0MEN1cnZlKTtcbiAgICBzZXRQcm9wZXJ0eShcInJvdGF0aW9uU3BlZWRHcmFwaDJcIiwgdGhpcy5yb3RhdGlvblNwZWVkR3JhcGgpO1xuICAgIHRoaXMuY29uc3RhbnRQYXJ0aWNsZVRleElOID0gZ2Quc2NvcGUucmVzb2x2ZShcInBhcnRpY2xlVGV4SU5cIik7XG4gICAgdGhpcy5jb25zdGFudFBhcnRpY2xlVGV4T1VUID0gZ2Quc2NvcGUucmVzb2x2ZShcInBhcnRpY2xlVGV4T1VUXCIpO1xuICAgIHRoaXMuY29uc3RhbnRFbWl0dGVyUG9zID0gZ2Quc2NvcGUucmVzb2x2ZShcImVtaXR0ZXJQb3NcIik7XG4gICAgdGhpcy5jb25zdGFudEVtaXR0ZXJTY2FsZSA9IGdkLnNjb3BlLnJlc29sdmUoXCJlbWl0dGVyU2NhbGVcIik7XG4gICAgdGhpcy5jb25zdGFudFNwYXduQm91bmRzID0gZ2Quc2NvcGUucmVzb2x2ZShcInNwYXduQm91bmRzXCIpO1xuICAgIHRoaXMuY29uc3RhbnRTcGF3bkJvdW5kc1NwaGVyZSA9IGdkLnNjb3BlLnJlc29sdmUoXCJzcGF3bkJvdW5kc1NwaGVyZVwiKTtcbiAgICB0aGlzLmNvbnN0YW50SW5pdGlhbFZlbG9jaXR5ID0gZ2Quc2NvcGUucmVzb2x2ZShcImluaXRpYWxWZWxvY2l0eVwiKTtcbiAgICB0aGlzLmNvbnN0YW50RnJhbWVSYW5kb20gPSBnZC5zY29wZS5yZXNvbHZlKFwiZnJhbWVSYW5kb21cIik7XG4gICAgdGhpcy5jb25zdGFudERlbHRhID0gZ2Quc2NvcGUucmVzb2x2ZShcImRlbHRhXCIpO1xuICAgIHRoaXMuY29uc3RhbnRSYXRlID0gZ2Quc2NvcGUucmVzb2x2ZShcInJhdGVcIik7XG4gICAgdGhpcy5jb25zdGFudFJhdGVEaXYgPSBnZC5zY29wZS5yZXNvbHZlKFwicmF0ZURpdlwiKTtcbiAgICB0aGlzLmNvbnN0YW50TGlmZXRpbWUgPSBnZC5zY29wZS5yZXNvbHZlKFwibGlmZXRpbWVcIik7XG4gICAgdGhpcy5jb25zdGFudExpZ2h0Q3ViZSA9IGdkLnNjb3BlLnJlc29sdmUoXCJsaWdodEN1YmVbMF1cIik7XG4gICAgdGhpcy5jb25zdGFudEdyYXBoU2FtcGxlU2l6ZSA9IGdkLnNjb3BlLnJlc29sdmUoXCJncmFwaFNhbXBsZVNpemVcIik7XG4gICAgdGhpcy5jb25zdGFudEdyYXBoTnVtU2FtcGxlcyA9IGdkLnNjb3BlLnJlc29sdmUoXCJncmFwaE51bVNhbXBsZXNcIik7XG4gICAgdGhpcy5jb25zdGFudEludGVybmFsVGV4MCA9IGdkLnNjb3BlLnJlc29sdmUoXCJpbnRlcm5hbFRleDBcIik7XG4gICAgdGhpcy5jb25zdGFudEludGVybmFsVGV4MSA9IGdkLnNjb3BlLnJlc29sdmUoXCJpbnRlcm5hbFRleDFcIik7XG4gICAgdGhpcy5jb25zdGFudEludGVybmFsVGV4MiA9IGdkLnNjb3BlLnJlc29sdmUoXCJpbnRlcm5hbFRleDJcIik7XG4gICAgdGhpcy5jb25zdGFudEVtaXR0ZXJNYXRyaXggPSBnZC5zY29wZS5yZXNvbHZlKFwiZW1pdHRlck1hdHJpeFwiKTtcbiAgICB0aGlzLmNvbnN0YW50TnVtUGFydGljbGVzID0gZ2Quc2NvcGUucmVzb2x2ZShcIm51bVBhcnRpY2xlc1wiKTtcbiAgICB0aGlzLmNvbnN0YW50TnVtUGFydGljbGVzUG90ID0gZ2Quc2NvcGUucmVzb2x2ZShcIm51bVBhcnRpY2xlc1BvdFwiKTtcbiAgICB0aGlzLmNvbnN0YW50TG9jYWxWZWxvY2l0eURpdk11bHQgPSBnZC5zY29wZS5yZXNvbHZlKFwibG9jYWxWZWxvY2l0eURpdk11bHRcIik7XG4gICAgdGhpcy5jb25zdGFudFZlbG9jaXR5RGl2TXVsdCA9IGdkLnNjb3BlLnJlc29sdmUoXCJ2ZWxvY2l0eURpdk11bHRcIik7XG4gICAgdGhpcy5jb25zdGFudFJvdFNwZWVkRGl2TXVsdCA9IGdkLnNjb3BlLnJlc29sdmUoXCJyb3RTcGVlZERpdk11bHRcIik7XG4gICAgdGhpcy5jb25zdGFudFNlZWQgPSBnZC5zY29wZS5yZXNvbHZlKFwic2VlZFwiKTtcbiAgICB0aGlzLmNvbnN0YW50U3RhcnRBbmdsZSA9IGdkLnNjb3BlLnJlc29sdmUoXCJzdGFydEFuZ2xlXCIpO1xuICAgIHRoaXMuY29uc3RhbnRTdGFydEFuZ2xlMiA9IGdkLnNjb3BlLnJlc29sdmUoXCJzdGFydEFuZ2xlMlwiKTtcbiAgICB0aGlzLmNvbnN0YW50T3V0Qm91bmRzTXVsID0gZ2Quc2NvcGUucmVzb2x2ZShcIm91dEJvdW5kc011bFwiKTtcbiAgICB0aGlzLmNvbnN0YW50T3V0Qm91bmRzQWRkID0gZ2Quc2NvcGUucmVzb2x2ZShcIm91dEJvdW5kc0FkZFwiKTtcbiAgICB0aGlzLmNvbnN0YW50SW5Cb3VuZHNTaXplID0gZ2Quc2NvcGUucmVzb2x2ZShcImluQm91bmRzU2l6ZVwiKTtcbiAgICB0aGlzLmNvbnN0YW50SW5Cb3VuZHNDZW50ZXIgPSBnZC5zY29wZS5yZXNvbHZlKFwiaW5Cb3VuZHNDZW50ZXJcIik7XG4gICAgdGhpcy5jb25zdGFudE1heFZlbCA9IGdkLnNjb3BlLnJlc29sdmUoXCJtYXhWZWxcIik7XG4gICAgdGhpcy5saWdodEN1YmUgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiAzKTtcbiAgICB0aGlzLmxpZ2h0Q3ViZURpciA9IG5ldyBBcnJheSg2KTtcbiAgICB0aGlzLmxpZ2h0Q3ViZURpclswXSA9IG5ldyBwYy5WZWMzKC0xLCAwLCAwKTtcbiAgICB0aGlzLmxpZ2h0Q3ViZURpclsxXSA9IG5ldyBwYy5WZWMzKDEsIDAsIDApO1xuICAgIHRoaXMubGlnaHRDdWJlRGlyWzJdID0gbmV3IHBjLlZlYzMoMCwgLTEsIDApO1xuICAgIHRoaXMubGlnaHRDdWJlRGlyWzNdID0gbmV3IHBjLlZlYzMoMCwgMSwgMCk7XG4gICAgdGhpcy5saWdodEN1YmVEaXJbNF0gPSBuZXcgcGMuVmVjMygwLCAwLCAtMSk7XG4gICAgdGhpcy5saWdodEN1YmVEaXJbNV0gPSBuZXcgcGMuVmVjMygwLCAwLCAxKTtcbiAgICB0aGlzLmFuaW1QYXJhbXMgPSBuZXcgcGMuVmVjNDtcbiAgICB0aGlzLmludGVybmFsVGV4MCA9IG51bGw7XG4gICAgdGhpcy5pbnRlcm5hbFRleDEgPSBudWxsO1xuICAgIHRoaXMuaW50ZXJuYWxUZXgyID0gbnVsbDtcbiAgICB0aGlzLmludGVybmFsVGV4MyA9IG51bGw7XG4gICAgdGhpcy52YlRvU29ydCA9IG51bGw7XG4gICAgdGhpcy52Yk9sZCA9IG51bGw7XG4gICAgdGhpcy5wYXJ0aWNsZURpc3RhbmNlID0gbnVsbDtcbiAgICB0aGlzLmNhbWVyYSA9IG51bGw7XG4gICAgdGhpcy5zd2FwVGV4ID0gZmFsc2U7XG4gICAgdGhpcy51c2VNZXNoID0gdHJ1ZTtcbiAgICB0aGlzLnVzZUNwdSA9IGZhbHNlO1xuICAgIHRoaXMucGFjazggPSB0cnVlO1xuICAgIHRoaXMubG9jYWxCb3VuZHMgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgdGhpcy53b3JsZEJvdW5kc05vVHJhaWwgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gICAgdGhpcy53b3JsZEJvdW5kc1RyYWlsID0gW25ldyBwYy5Cb3VuZGluZ0JveCwgbmV3IHBjLkJvdW5kaW5nQm94XTtcbiAgICB0aGlzLndvcmxkQm91bmRzID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICAgIHRoaXMud29ybGRCb3VuZHNTaXplID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5wcmV2V29ybGRCb3VuZHNTaXplID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5wcmV2V29ybGRCb3VuZHNDZW50ZXIgPSBuZXcgcGMuVmVjMztcbiAgICB0aGlzLndvcmxkQm91bmRzTXVsID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy53b3JsZEJvdW5kc0FkZCA9IG5ldyBwYy5WZWMzO1xuICAgIHRoaXMudGltZVRvU3dpdGNoQm91bmRzID0gMDtcbiAgICB0aGlzLnNoYWRlclBhcnRpY2xlVXBkYXRlUmVzcGF3biA9IG51bGw7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU5vUmVzcGF3biA9IG51bGw7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU9uU3RvcCA9IG51bGw7XG4gICAgdGhpcy5udW1QYXJ0aWNsZVZlcnRzID0gMDtcbiAgICB0aGlzLm51bVBhcnRpY2xlSW5kaWNlcyA9IDA7XG4gICAgdGhpcy5tYXRlcmlhbCA9IG51bGw7XG4gICAgdGhpcy5tZXNoSW5zdGFuY2UgPSBudWxsO1xuICAgIHRoaXMuc2VlZCA9IDA7XG4gICAgdGhpcy5maXhlZFRpbWVTdGVwID0gMS4wIC8gNjA7XG4gICAgdGhpcy5tYXhTdWJTdGVwcyA9IDEwO1xuICAgIHRoaXMuc2ltVGltZSA9IDA7XG4gICAgdGhpcy5zaW1UaW1lVG90YWwgPSAwO1xuICAgIHRoaXMuYmVlblJlc2V0ID0gZmFsc2U7XG4gICAgdGhpcy5yZWJ1aWxkKCk7XG4gIH07XG4gIGZ1bmN0aW9uIGNhbGNFbmRUaW1lKGVtaXR0ZXIpIHtcbiAgICB2YXIgaW50ZXJ2YWwgPSBNYXRoLm1heChlbWl0dGVyLnJhdGUsIGVtaXR0ZXIucmF0ZTIpICogZW1pdHRlci5udW1QYXJ0aWNsZXMgKyBlbWl0dGVyLmxpZmV0aW1lO1xuICAgIHJldHVybiBEYXRlLm5vdygpICsgaW50ZXJ2YWwgKiAxMDAwO1xuICB9XG4gIGZ1bmN0aW9uIHN1YkdyYXBoKEEsIEIpIHtcbiAgICB2YXIgciA9IG5ldyBGbG9hdDMyQXJyYXkoQS5sZW5ndGgpO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBBLmxlbmd0aDtpKyspIHtcbiAgICAgIHJbaV0gPSBBW2ldIC0gQltpXTtcbiAgICB9XG4gICAgcmV0dXJuIHI7XG4gIH1cbiAgZnVuY3Rpb24gbWF4VW5zaWduZWRHcmFwaFZhbHVlKEEsIG91dFVNYXgpIHtcbiAgICB2YXIgaSwgajtcbiAgICB2YXIgY2hhbnMgPSBvdXRVTWF4Lmxlbmd0aDtcbiAgICB2YXIgdmFsdWVzID0gQS5sZW5ndGggLyBjaGFucztcbiAgICBmb3IgKGkgPSAwO2kgPCB2YWx1ZXM7aSsrKSB7XG4gICAgICBmb3IgKGogPSAwO2ogPCBjaGFucztqKyspIHtcbiAgICAgICAgdmFyIGEgPSBNYXRoLmFicyhBW2kgKiBjaGFucyArIGpdKTtcbiAgICAgICAgb3V0VU1heFtqXSA9IE1hdGgubWF4KG91dFVNYXhbal0sIGEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBmdW5jdGlvbiBub3JtYWxpemVHcmFwaChBLCB1TWF4KSB7XG4gICAgdmFyIGNoYW5zID0gdU1heC5sZW5ndGg7XG4gICAgdmFyIGksIGo7XG4gICAgdmFyIHZhbHVlcyA9IEEubGVuZ3RoIC8gY2hhbnM7XG4gICAgZm9yIChpID0gMDtpIDwgdmFsdWVzO2krKykge1xuICAgICAgZm9yIChqID0gMDtqIDwgY2hhbnM7aisrKSB7XG4gICAgICAgIEFbaSAqIGNoYW5zICsgal0gLz0gdU1heFtqXTtcbiAgICAgICAgQVtpICogY2hhbnMgKyBqXSAqPSAwLjU7XG4gICAgICAgIEFbaSAqIGNoYW5zICsgal0gKz0gMC41O1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBmdW5jdGlvbiBkaXZHcmFwaEZyb20yQ3VydmVzKGN1cnZlMSwgY3VydmUyLCBvdXRVTWF4KSB7XG4gICAgdmFyIHN1YiA9IHN1YkdyYXBoKGN1cnZlMiwgY3VydmUxKTtcbiAgICBtYXhVbnNpZ25lZEdyYXBoVmFsdWUoc3ViLCBvdXRVTWF4KTtcbiAgICBub3JtYWxpemVHcmFwaChzdWIsIG91dFVNYXgpO1xuICAgIHJldHVybiBzdWI7XG4gIH1cbiAgZnVuY3Rpb24gbWF0NFRvTWF0MyhtYXQ0LCBtYXQzKSB7XG4gICAgbWF0My5kYXRhWzBdID0gbWF0NC5kYXRhWzBdO1xuICAgIG1hdDMuZGF0YVsxXSA9IG1hdDQuZGF0YVsxXTtcbiAgICBtYXQzLmRhdGFbMl0gPSBtYXQ0LmRhdGFbMl07XG4gICAgbWF0My5kYXRhWzNdID0gbWF0NC5kYXRhWzRdO1xuICAgIG1hdDMuZGF0YVs0XSA9IG1hdDQuZGF0YVs1XTtcbiAgICBtYXQzLmRhdGFbNV0gPSBtYXQ0LmRhdGFbNl07XG4gICAgbWF0My5kYXRhWzZdID0gbWF0NC5kYXRhWzhdO1xuICAgIG1hdDMuZGF0YVs3XSA9IG1hdDQuZGF0YVs5XTtcbiAgICBtYXQzLmRhdGFbOF0gPSBtYXQ0LmRhdGFbMTBdO1xuICB9XG4gIFBhcnRpY2xlRW1pdHRlci5wcm90b3R5cGUgPSB7b25DaGFuZ2VDYW1lcmE6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuZGVwdGhTb2Z0ZW5pbmcgPiAwKSB7XG4gICAgICBpZiAodGhpcy5jYW1lcmEpIHtcbiAgICAgICAgdGhpcy5jYW1lcmEucmVxdWVzdERlcHRoTWFwKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucmVnZW5TaGFkZXIoKTtcbiAgICB0aGlzLnJlc2V0TWF0ZXJpYWwoKTtcbiAgfSwgY2FsY3VsYXRlQm91bmRzTWFkOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMud29ybGRCb3VuZHNNdWwueCA9IDEuMCAvIHRoaXMud29ybGRCb3VuZHNTaXplLng7XG4gICAgdGhpcy53b3JsZEJvdW5kc011bC55ID0gMS4wIC8gdGhpcy53b3JsZEJvdW5kc1NpemUueTtcbiAgICB0aGlzLndvcmxkQm91bmRzTXVsLnogPSAxLjAgLyB0aGlzLndvcmxkQm91bmRzU2l6ZS56O1xuICAgIHRoaXMud29ybGRCb3VuZHNBZGQuY29weSh0aGlzLndvcmxkQm91bmRzLmNlbnRlcikubXVsKHRoaXMud29ybGRCb3VuZHNNdWwpLnNjYWxlKC0xKTtcbiAgICB0aGlzLndvcmxkQm91bmRzQWRkLnggKz0gMC41O1xuICAgIHRoaXMud29ybGRCb3VuZHNBZGQueSArPSAwLjU7XG4gICAgdGhpcy53b3JsZEJvdW5kc0FkZC56ICs9IDAuNTtcbiAgfSwgY2FsY3VsYXRlV29ybGRCb3VuZHM6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLm5vZGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHBvcyA9IHRoaXMubm9kZS5nZXRQb3NpdGlvbigpO1xuICAgIHRoaXMucHJldldvcmxkQm91bmRzU2l6ZS5jb3B5KHRoaXMud29ybGRCb3VuZHNTaXplKTtcbiAgICB0aGlzLnByZXZXb3JsZEJvdW5kc0NlbnRlci5jb3B5KHRoaXMud29ybGRCb3VuZHMuY2VudGVyKTtcbiAgICB0aGlzLndvcmxkQm91bmRzTm9UcmFpbC5zZXRGcm9tVHJhbnNmb3JtZWRBYWJiKHRoaXMubG9jYWxCb3VuZHMsIHRoaXMubm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpKTtcbiAgICB0aGlzLndvcmxkQm91bmRzVHJhaWxbMF0uYWRkKHRoaXMud29ybGRCb3VuZHNOb1RyYWlsKTtcbiAgICB2YXIgbm93ID0gdGhpcy5zaW1UaW1lVG90YWw7XG4gICAgaWYgKG5vdyA+IHRoaXMudGltZVRvU3dpdGNoQm91bmRzKSB7XG4gICAgICB2YXIgdG1wID0gdGhpcy53b3JsZEJvdW5kc1RyYWlsWzBdO1xuICAgICAgdGhpcy53b3JsZEJvdW5kc1RyYWlsWzBdID0gdGhpcy53b3JsZEJvdW5kc1RyYWlsWzFdO1xuICAgICAgdGhpcy53b3JsZEJvdW5kc1RyYWlsWzFdID0gdG1wO1xuICAgICAgdGhpcy53b3JsZEJvdW5kc1RyYWlsWzBdLmNvcHkodGhpcy53b3JsZEJvdW5kc05vVHJhaWwpO1xuICAgICAgdGhpcy50aW1lVG9Td2l0Y2hCb3VuZHMgPSBub3cgKyB0aGlzLmxpZmV0aW1lO1xuICAgIH1cbiAgICB0aGlzLndvcmxkQm91bmRzLmNvcHkodGhpcy53b3JsZEJvdW5kc1RyYWlsWzBdKTtcbiAgICB0aGlzLndvcmxkQm91bmRzLmFkZCh0aGlzLndvcmxkQm91bmRzVHJhaWxbMV0pO1xuICAgIHRoaXMud29ybGRCb3VuZHNTaXplLmNvcHkodGhpcy53b3JsZEJvdW5kcy5oYWxmRXh0ZW50cykuc2NhbGUoMik7XG4gICAgdGhpcy5tZXNoSW5zdGFuY2UubWVzaC5hYWJiID0gdGhpcy53b3JsZEJvdW5kcztcbiAgICB0aGlzLm1lc2hJbnN0YW5jZS5fYWFiYlZlciA9IDEgLSB0aGlzLm1lc2hJbnN0YW5jZS5fYWFiYlZlcjtcbiAgICBpZiAodGhpcy5wYWNrOCkge1xuICAgICAgdGhpcy5jYWxjdWxhdGVCb3VuZHNNYWQoKTtcbiAgICB9XG4gIH0sIGNhbGN1bGF0ZUxvY2FsQm91bmRzOmZ1bmN0aW9uKCkge1xuICAgIHZhciBtaW54ID0gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB2YXIgbWlueSA9IE51bWJlci5NQVhfVkFMVUU7XG4gICAgdmFyIG1pbnogPSBOdW1iZXIuTUFYX1ZBTFVFO1xuICAgIHZhciBtYXh4ID0gLU51bWJlci5NQVhfVkFMVUU7XG4gICAgdmFyIG1heHkgPSAtTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB2YXIgbWF4eiA9IC1OdW1iZXIuTUFYX1ZBTFVFO1xuICAgIHZhciBtYXhTY2FsZSA9IDA7XG4gICAgdmFyIHN0ZXBXZWlnaHQgPSB0aGlzLmxpZmV0aW1lIC8gdGhpcy5wcmVjaXNpb247XG4gICAgdmFyIHZlbHMgPSBbdGhpcy5xVmVsb2NpdHksIHRoaXMucVZlbG9jaXR5MiwgdGhpcy5xTG9jYWxWZWxvY2l0eSwgdGhpcy5xTG9jYWxWZWxvY2l0eTJdO1xuICAgIHZhciBhY2N1bVggPSBbMCwgMCwgMCwgMF07XG4gICAgdmFyIGFjY3VtWSA9IFswLCAwLCAwLCAwXTtcbiAgICB2YXIgYWNjdW1aID0gWzAsIDAsIDAsIDBdO1xuICAgIHZhciBpLCBqO1xuICAgIHZhciBpbmRleDtcbiAgICB2YXIgeCwgeSwgejtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLnByZWNpc2lvbiArIDE7aSsrKSB7XG4gICAgICBpbmRleCA9IE1hdGgubWluKGksIHRoaXMucHJlY2lzaW9uIC0gMSk7XG4gICAgICBmb3IgKGogPSAwO2ogPCA0O2orKykge1xuICAgICAgICB4ID0gdmVsc1tqXVtpbmRleCAqIDNdICogc3RlcFdlaWdodCArIGFjY3VtWFtqXTtcbiAgICAgICAgeSA9IHZlbHNbal1baW5kZXggKiAzICsgMV0gKiBzdGVwV2VpZ2h0ICsgYWNjdW1ZW2pdO1xuICAgICAgICB6ID0gdmVsc1tqXVtpbmRleCAqIDMgKyAyXSAqIHN0ZXBXZWlnaHQgKyBhY2N1bVpbal07XG4gICAgICAgIGlmIChtaW54ID4geCkge1xuICAgICAgICAgIG1pbnggPSB4O1xuICAgICAgICB9XG4gICAgICAgIGlmIChtaW55ID4geSkge1xuICAgICAgICAgIG1pbnkgPSB5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChtaW56ID4geikge1xuICAgICAgICAgIG1pbnogPSB6O1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXh4IDwgeCkge1xuICAgICAgICAgIG1heHggPSB4O1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXh5IDwgeSkge1xuICAgICAgICAgIG1heHkgPSB5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYXh6IDwgeikge1xuICAgICAgICAgIG1heHogPSB6O1xuICAgICAgICB9XG4gICAgICAgIGFjY3VtWFtqXSA9IHg7XG4gICAgICAgIGFjY3VtWVtqXSA9IHk7XG4gICAgICAgIGFjY3VtWltqXSA9IHo7XG4gICAgICB9XG4gICAgICBtYXhTY2FsZSA9IE1hdGgubWF4KG1heFNjYWxlLCB0aGlzLnFTY2FsZVtpbmRleF0pO1xuICAgIH1cbiAgICBpZiAodGhpcy5lbWl0dGVyU2hhcGUgPT09IHBjLkVNSVRURVJTSEFQRV9CT1gpIHtcbiAgICAgIHggPSB0aGlzLmVtaXR0ZXJFeHRlbnRzLnggKiAwLjU7XG4gICAgICB5ID0gdGhpcy5lbWl0dGVyRXh0ZW50cy55ICogMC41O1xuICAgICAgeiA9IHRoaXMuZW1pdHRlckV4dGVudHMueiAqIDAuNTtcbiAgICAgIGlmIChtYXh4IDwgeCkge1xuICAgICAgICBtYXh4ID0geDtcbiAgICAgIH1cbiAgICAgIGlmIChtYXh5IDwgeSkge1xuICAgICAgICBtYXh5ID0geTtcbiAgICAgIH1cbiAgICAgIGlmIChtYXh6IDwgeikge1xuICAgICAgICBtYXh6ID0gejtcbiAgICAgIH1cbiAgICAgIHggPSAteDtcbiAgICAgIHkgPSAteTtcbiAgICAgIHogPSAtejtcbiAgICAgIGlmIChtaW54ID4geCkge1xuICAgICAgICBtaW54ID0geDtcbiAgICAgIH1cbiAgICAgIGlmIChtaW55ID4geSkge1xuICAgICAgICBtaW55ID0geTtcbiAgICAgIH1cbiAgICAgIGlmIChtaW56ID4geikge1xuICAgICAgICBtaW56ID0gejtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgeCA9IHRoaXMuZW1pdHRlclJhZGl1cztcbiAgICAgIHkgPSB0aGlzLmVtaXR0ZXJSYWRpdXM7XG4gICAgICB6ID0gdGhpcy5lbWl0dGVyUmFkaXVzO1xuICAgICAgaWYgKG1heHggPCB4KSB7XG4gICAgICAgIG1heHggPSB4O1xuICAgICAgfVxuICAgICAgaWYgKG1heHkgPCB5KSB7XG4gICAgICAgIG1heHkgPSB5O1xuICAgICAgfVxuICAgICAgaWYgKG1heHogPCB6KSB7XG4gICAgICAgIG1heHogPSB6O1xuICAgICAgfVxuICAgICAgeCA9IC14O1xuICAgICAgeSA9IC15O1xuICAgICAgeiA9IC16O1xuICAgICAgaWYgKG1pbnggPiB4KSB7XG4gICAgICAgIG1pbnggPSB4O1xuICAgICAgfVxuICAgICAgaWYgKG1pbnkgPiB5KSB7XG4gICAgICAgIG1pbnkgPSB5O1xuICAgICAgfVxuICAgICAgaWYgKG1pbnogPiB6KSB7XG4gICAgICAgIG1pbnogPSB6O1xuICAgICAgfVxuICAgIH1cbiAgICBiTWluLnggPSBtaW54IC0gbWF4U2NhbGU7XG4gICAgYk1pbi55ID0gbWlueSAtIG1heFNjYWxlO1xuICAgIGJNaW4ueiA9IG1pbnogLSBtYXhTY2FsZTtcbiAgICBiTWF4LnggPSBtYXh4ICsgbWF4U2NhbGU7XG4gICAgYk1heC55ID0gbWF4eSArIG1heFNjYWxlO1xuICAgIGJNYXgueiA9IG1heHogKyBtYXhTY2FsZTtcbiAgICB0aGlzLmxvY2FsQm91bmRzLnNldE1pbk1heChiTWluLCBiTWF4KTtcbiAgfSwgcmVidWlsZDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaSwgbGVuO1xuICAgIHZhciBwcmVjaXNpb24gPSB0aGlzLnByZWNpc2lvbjtcbiAgICB2YXIgZ2QgPSB0aGlzLmdyYXBoaWNzRGV2aWNlO1xuICAgIGlmICh0aGlzLmNvbG9yTWFwID09PSBudWxsKSB7XG4gICAgICB0aGlzLmNvbG9yTWFwID0gUGFydGljbGVFbWl0dGVyLkRFRkFVTFRfUEFSQU1fVEVYVFVSRTtcbiAgICB9XG4gICAgdGhpcy5zcGF3bkJvdW5kcyA9IHRoaXMuZW1pdHRlclNoYXBlID09PSBwYy5FTUlUVEVSU0hBUEVfQk9YID8gdGhpcy5lbWl0dGVyRXh0ZW50cyA6IHRoaXMuZW1pdHRlclJhZGl1cztcbiAgICB0aGlzLnVzZUNwdSA9IHRoaXMudXNlQ3B1IHx8IHRoaXMuc29ydCA+IHBjLlBBUlRJQ0xFU09SVF9OT05FIHx8IGdkLm1heFZlcnRleFRleHR1cmVzIDw9IDEgfHwgZ2QuZnJhZ21lbnRVbmlmb3Jtc0NvdW50IDwgNjQgfHwgZ2QuZm9yY2VDcHVQYXJ0aWNsZXMgfHwgIWdkLmV4dFRleHR1cmVGbG9hdDtcbiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnBhY2s4ID0gKHRoaXMucGFjazggfHwgIWdkLmV4dFRleHR1cmVGbG9hdFJlbmRlcmFibGUpICYmICF0aGlzLnVzZUNwdTtcbiAgICBwYXJ0aWNsZVRleEhlaWdodCA9IHRoaXMudXNlQ3B1IHx8IHRoaXMucGFjazggPyA0IDogMjtcbiAgICB0aGlzLnVzZU1lc2ggPSBmYWxzZTtcbiAgICBpZiAodGhpcy5tZXNoKSB7XG4gICAgICB2YXIgdG90YWxWZXJ0Q291bnQgPSB0aGlzLm51bVBhcnRpY2xlcyAqIHRoaXMubWVzaC52ZXJ0ZXhCdWZmZXIubnVtVmVydGljZXM7XG4gICAgICBpZiAodG90YWxWZXJ0Q291bnQgPiA2NTUzNSkge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJXQVJOSU5HOiBwYXJ0aWNsZSBzeXN0ZW0gY2FuJ3QgcmVuZGVyIG1lc2ggcGFydGljbGVzIGJlY2F1c2UgbnVtUGFydGljbGVzICogbnVtVmVydGljZXMgaXMgbW9yZSB0aGFuIDY1ay4gUmV2ZXJ0aW5nIHRvIHF1YWQgcGFydGljbGVzLlwiKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudXNlTWVzaCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMubnVtUGFydGljbGVzUG90ID0gcGMubWF0aC5uZXh0UG93ZXJPZlR3byh0aGlzLm51bVBhcnRpY2xlcyk7XG4gICAgdGhpcy5yZWJ1aWxkR3JhcGhzKCk7XG4gICAgdGhpcy5jYWxjdWxhdGVMb2NhbEJvdW5kcygpO1xuICAgIGlmICh0aGlzLm5vZGUpIHtcbiAgICAgIHRoaXMud29ybGRCb3VuZHMuc2V0RnJvbVRyYW5zZm9ybWVkQWFiYih0aGlzLmxvY2FsQm91bmRzLCB0aGlzLm5vZGUuZ2V0V29ybGRUcmFuc2Zvcm0oKSk7XG4gICAgICB0aGlzLndvcmxkQm91bmRzVHJhaWxbMF0uY29weSh0aGlzLndvcmxkQm91bmRzKTtcbiAgICAgIHRoaXMud29ybGRCb3VuZHNUcmFpbFsxXS5jb3B5KHRoaXMud29ybGRCb3VuZHMpO1xuICAgICAgdGhpcy53b3JsZEJvdW5kc1NpemUuY29weSh0aGlzLndvcmxkQm91bmRzLmhhbGZFeHRlbnRzKS5zY2FsZSgyKTtcbiAgICAgIHRoaXMucHJldldvcmxkQm91bmRzU2l6ZS5jb3B5KHRoaXMud29ybGRCb3VuZHNTaXplKTtcbiAgICAgIHRoaXMucHJldldvcmxkQm91bmRzQ2VudGVyLmNvcHkodGhpcy53b3JsZEJvdW5kcy5jZW50ZXIpO1xuICAgICAgaWYgKHRoaXMucGFjazgpIHtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVCb3VuZHNNYWQoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy52YlRvU29ydCA9IG5ldyBBcnJheSh0aGlzLm51bVBhcnRpY2xlcyk7XG4gICAgdGhpcy5wYXJ0aWNsZURpc3RhbmNlID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLm51bVBhcnRpY2xlcyk7XG4gICAgdGhpcy5mcmFtZVJhbmRvbS54ID0gTWF0aC5yYW5kb20oKTtcbiAgICB0aGlzLmZyYW1lUmFuZG9tLnkgPSBNYXRoLnJhbmRvbSgpO1xuICAgIHRoaXMuZnJhbWVSYW5kb20ueiA9IE1hdGgucmFuZG9tKCk7XG4gICAgdGhpcy5wYXJ0aWNsZVRleCA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5udW1QYXJ0aWNsZXNQb3QgKiBwYXJ0aWNsZVRleEhlaWdodCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMpO1xuICAgIHZhciBlbWl0dGVyUG9zID0gdGhpcy5ub2RlID09PSBudWxsIHx8IHRoaXMubG9jYWxTcGFjZSA/IHBjLlZlYzMuWkVSTyA6IHRoaXMubm9kZS5nZXRQb3NpdGlvbigpO1xuICAgIGlmICh0aGlzLmVtaXR0ZXJTaGFwZSA9PT0gcGMuRU1JVFRFUlNIQVBFX0JPWCkge1xuICAgICAgaWYgKHRoaXMubm9kZSA9PT0gbnVsbCkge1xuICAgICAgICBzcGF3bk1hdHJpeC5zZXRUUlMocGMuVmVjMy5aRVJPLCBwYy5RdWF0LklERU5USVRZLCB0aGlzLnNwYXduQm91bmRzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNwYXduTWF0cml4LnNldFRSUyhwYy5WZWMzLlpFUk8sIHRoaXMubm9kZS5nZXRSb3RhdGlvbigpLCB0bXBWZWMzLmNvcHkodGhpcy5zcGF3bkJvdW5kcykubXVsKHRoaXMubm9kZS5sb2NhbFNjYWxlKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IHRoaXMubnVtUGFydGljbGVzO2krKykge1xuICAgICAgdGhpcy5jYWxjU3Bhd25Qb3NpdGlvbihlbWl0dGVyUG9zLCBpKTtcbiAgICAgIGlmICh0aGlzLnVzZUNwdSkge1xuICAgICAgICB0aGlzLnBhcnRpY2xlVGV4W2kgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gMTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5wYXJ0aWNsZVRleFN0YXJ0ID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4SGVpZ2h0ICogcGFydGljbGVUZXhDaGFubmVscyk7XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5wYXJ0aWNsZVRleFN0YXJ0Lmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMucGFydGljbGVUZXhTdGFydFtpXSA9IHRoaXMucGFydGljbGVUZXhbaV07XG4gICAgfVxuICAgIGlmICghdGhpcy51c2VDcHUpIHtcbiAgICAgIGlmICh0aGlzLnBhY2s4KSB7XG4gICAgICAgIHRoaXMucGFydGljbGVUZXhJTiA9IF9jcmVhdGVUZXh0dXJlKGdkLCB0aGlzLm51bVBhcnRpY2xlc1BvdCwgcGFydGljbGVUZXhIZWlnaHQsIHRoaXMucGFydGljbGVUZXgsIHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCAxLCBmYWxzZSk7XG4gICAgICAgIHRoaXMucGFydGljbGVUZXhPVVQgPSBfY3JlYXRlVGV4dHVyZShnZCwgdGhpcy5udW1QYXJ0aWNsZXNQb3QsIHBhcnRpY2xlVGV4SGVpZ2h0LCB0aGlzLnBhcnRpY2xlVGV4LCBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgMSwgZmFsc2UpO1xuICAgICAgICB0aGlzLnBhcnRpY2xlVGV4U3RhcnQgPSBfY3JlYXRlVGV4dHVyZShnZCwgdGhpcy5udW1QYXJ0aWNsZXNQb3QsIHBhcnRpY2xlVGV4SGVpZ2h0LCB0aGlzLnBhcnRpY2xlVGV4U3RhcnQsIHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCAxLCBmYWxzZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnBhcnRpY2xlVGV4SU4gPSBfY3JlYXRlVGV4dHVyZShnZCwgdGhpcy5udW1QYXJ0aWNsZXNQb3QsIHBhcnRpY2xlVGV4SGVpZ2h0LCB0aGlzLnBhcnRpY2xlVGV4KTtcbiAgICAgICAgdGhpcy5wYXJ0aWNsZVRleE9VVCA9IF9jcmVhdGVUZXh0dXJlKGdkLCB0aGlzLm51bVBhcnRpY2xlc1BvdCwgcGFydGljbGVUZXhIZWlnaHQsIHRoaXMucGFydGljbGVUZXgpO1xuICAgICAgICB0aGlzLnBhcnRpY2xlVGV4U3RhcnQgPSBfY3JlYXRlVGV4dHVyZShnZCwgdGhpcy5udW1QYXJ0aWNsZXNQb3QsIHBhcnRpY2xlVGV4SGVpZ2h0LCB0aGlzLnBhcnRpY2xlVGV4U3RhcnQpO1xuICAgICAgfVxuICAgICAgdGhpcy5ydFBhcnRpY2xlVGV4SU4gPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGdkLCB0aGlzLnBhcnRpY2xlVGV4SU4sIHtkZXB0aDpmYWxzZX0pO1xuICAgICAgdGhpcy5ydFBhcnRpY2xlVGV4T1VUID0gbmV3IHBjLlJlbmRlclRhcmdldChnZCwgdGhpcy5wYXJ0aWNsZVRleE9VVCwge2RlcHRoOmZhbHNlfSk7XG4gICAgICB0aGlzLnN3YXBUZXggPSBmYWxzZTtcbiAgICB9XG4gICAgdmFyIGNodW5rcyA9IHBjLnNoYWRlckNodW5rcztcbiAgICB2YXIgc2hhZGVyQ29kZVN0YXJ0ID0gY2h1bmtzLnBhcnRpY2xlVXBkYXRlckluaXRQUyArICh0aGlzLnBhY2s4ID8gY2h1bmtzLnBhcnRpY2xlSW5wdXRSZ2JhOFBTICsgY2h1bmtzLnBhcnRpY2xlT3V0cHV0UmdiYThQUyA6IGNodW5rcy5wYXJ0aWNsZUlucHV0RmxvYXRQUyArIGNodW5rcy5wYXJ0aWNsZU91dHB1dEZsb2F0UFMpICsgKHRoaXMuZW1pdHRlclNoYXBlID09PSBwYy5FTUlUVEVSU0hBUEVfQk9YID8gY2h1bmtzLnBhcnRpY2xlVXBkYXRlckFBQkJQUyA6IGNodW5rcy5wYXJ0aWNsZVVwZGF0ZXJTcGhlcmVQUykgKyBjaHVua3MucGFydGljbGVVcGRhdGVyU3RhcnRQUztcbiAgICB2YXIgc2hhZGVyQ29kZVJlc3Bhd24gPSBzaGFkZXJDb2RlU3RhcnQgKyBjaHVua3MucGFydGljbGVVcGRhdGVyUmVzcGF3blBTICsgY2h1bmtzLnBhcnRpY2xlVXBkYXRlckVuZFBTO1xuICAgIHZhciBzaGFkZXJDb2RlTm9SZXNwYXduID0gc2hhZGVyQ29kZVN0YXJ0ICsgY2h1bmtzLnBhcnRpY2xlVXBkYXRlck5vUmVzcGF3blBTICsgY2h1bmtzLnBhcnRpY2xlVXBkYXRlckVuZFBTO1xuICAgIHZhciBzaGFkZXJDb2RlT25TdG9wID0gc2hhZGVyQ29kZVN0YXJ0ICsgY2h1bmtzLnBhcnRpY2xlVXBkYXRlck9uU3RvcFBTICsgY2h1bmtzLnBhcnRpY2xlVXBkYXRlckVuZFBTO1xuICAgIHRoaXMuc2hhZGVyUGFydGljbGVVcGRhdGVSZXNwYXduID0gY2h1bmtzLmNyZWF0ZVNoYWRlckZyb21Db2RlKGdkLCBjaHVua3MuZnVsbHNjcmVlblF1YWRWUywgc2hhZGVyQ29kZVJlc3Bhd24sIFwiZnNRdWFkMFwiICsgdGhpcy5lbWl0dGVyU2hhcGUgKyBcIlwiICsgdGhpcy5wYWNrOCk7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU5vUmVzcGF3biA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShnZCwgY2h1bmtzLmZ1bGxzY3JlZW5RdWFkVlMsIHNoYWRlckNvZGVOb1Jlc3Bhd24sIFwiZnNRdWFkMVwiICsgdGhpcy5lbWl0dGVyU2hhcGUgKyBcIlwiICsgdGhpcy5wYWNrOCk7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU9uU3RvcCA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShnZCwgY2h1bmtzLmZ1bGxzY3JlZW5RdWFkVlMsIHNoYWRlckNvZGVPblN0b3AsIFwiZnNRdWFkMlwiICsgdGhpcy5lbWl0dGVyU2hhcGUgKyBcIlwiICsgdGhpcy5wYWNrOCk7XG4gICAgdGhpcy5udW1QYXJ0aWNsZVZlcnRzID0gdGhpcy51c2VNZXNoID8gdGhpcy5tZXNoLnZlcnRleEJ1ZmZlci5udW1WZXJ0aWNlcyA6IDQ7XG4gICAgdGhpcy5udW1QYXJ0aWNsZUluZGljZXMgPSB0aGlzLnVzZU1lc2ggPyB0aGlzLm1lc2guaW5kZXhCdWZmZXJbMF0ubnVtSW5kaWNlcyA6IDY7XG4gICAgdGhpcy5fYWxsb2NhdGUodGhpcy5udW1QYXJ0aWNsZXMpO1xuICAgIHZhciBtZXNoID0gbmV3IHBjLk1lc2g7XG4gICAgbWVzaC52ZXJ0ZXhCdWZmZXIgPSB0aGlzLnZlcnRleEJ1ZmZlcjtcbiAgICBtZXNoLmluZGV4QnVmZmVyWzBdID0gdGhpcy5pbmRleEJ1ZmZlcjtcbiAgICBtZXNoLnByaW1pdGl2ZVswXS50eXBlID0gcGMuUFJJTUlUSVZFX1RSSUFOR0xFUztcbiAgICBtZXNoLnByaW1pdGl2ZVswXS5iYXNlID0gMDtcbiAgICBtZXNoLnByaW1pdGl2ZVswXS5jb3VudCA9IHRoaXMubnVtUGFydGljbGVzICogdGhpcy5udW1QYXJ0aWNsZUluZGljZXM7XG4gICAgbWVzaC5wcmltaXRpdmVbMF0uaW5kZXhlZCA9IHRydWU7XG4gICAgdGhpcy5tYXRlcmlhbCA9IG5ldyBwYy5NYXRlcmlhbDtcbiAgICB0aGlzLm1hdGVyaWFsLmN1bGxNb2RlID0gcGMuQ1VMTEZBQ0VfTk9ORTtcbiAgICB0aGlzLm1hdGVyaWFsLmFscGhhV3JpdGUgPSBmYWxzZTtcbiAgICB0aGlzLm1hdGVyaWFsLmJsZW5kID0gdHJ1ZTtcbiAgICB0aGlzLm1hdGVyaWFsLmJsZW5kVHlwZSA9IHRoaXMuYmxlbmRUeXBlO1xuICAgIHRoaXMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRoaXMuZGVwdGhXcml0ZTtcbiAgICB0aGlzLm1hdGVyaWFsLmVtaXR0ZXIgPSB0aGlzO1xuICAgIHRoaXMucmVnZW5TaGFkZXIoKTtcbiAgICB0aGlzLnJlc2V0TWF0ZXJpYWwoKTtcbiAgICB0aGlzLm1lc2hJbnN0YW5jZSA9IG5ldyBwYy5NZXNoSW5zdGFuY2UodGhpcy5ub2RlLCBtZXNoLCB0aGlzLm1hdGVyaWFsKTtcbiAgICB0aGlzLm1lc2hJbnN0YW5jZS51cGRhdGVLZXkoKTtcbiAgICB0aGlzLm1lc2hJbnN0YW5jZS5kcmF3VG9EZXB0aCA9IGZhbHNlO1xuICAgIHRoaXMubWVzaEluc3RhbmNlLmN1bGwgPSB0cnVlO1xuICAgIHRoaXMubWVzaEluc3RhbmNlLmFhYmIgPSB0aGlzLndvcmxkQm91bmRzO1xuICAgIHRoaXMubWVzaEluc3RhbmNlLl91cGRhdGVBYWJiID0gZmFsc2U7XG4gICAgdGhpcy5faW5pdGlhbGl6ZVRleHR1cmVzKCk7XG4gICAgdGhpcy5hZGRUaW1lKDApO1xuICAgIGlmICh0aGlzLnByZVdhcm0pIHtcbiAgICAgIHRoaXMucHJld2FybSh0aGlzLmxpZmV0aW1lKTtcbiAgICB9XG4gICAgdGhpcy5yZXNldFRpbWUoKTtcbiAgfSwgX2lzQW5pbWF0ZWQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuYW5pbU51bUZyYW1lcyA+PSAxICYmICh0aGlzLmFuaW1UaWxlc1ggPiAxIHx8IHRoaXMuYW5pbVRpbGVzWSA+IDEpICYmICh0aGlzLmNvbG9yTWFwICYmIHRoaXMuY29sb3JNYXAgIT09IFBhcnRpY2xlRW1pdHRlci5ERUZBVUxUX1BBUkFNX1RFWFRVUkUgfHwgdGhpcy5ub3JtYWxNYXApO1xuICB9LCBjYWxjU3Bhd25Qb3NpdGlvbjpmdW5jdGlvbihlbWl0dGVyUG9zLCBpKSB7XG4gICAgdmFyIHJYID0gTWF0aC5yYW5kb20oKTtcbiAgICB2YXIgclkgPSBNYXRoLnJhbmRvbSgpO1xuICAgIHZhciByWiA9IE1hdGgucmFuZG9tKCk7XG4gICAgdmFyIHJXID0gTWF0aC5yYW5kb20oKTtcbiAgICBpZiAodGhpcy51c2VDcHUpIHtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAwICsgdGhpcy5udW1QYXJ0aWNsZXNQb3QgKiAyICogcGFydGljbGVUZXhDaGFubmVsc10gPSByWDtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAxICsgdGhpcy5udW1QYXJ0aWNsZXNQb3QgKiAyICogcGFydGljbGVUZXhDaGFubmVsc10gPSByWTtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAyICsgdGhpcy5udW1QYXJ0aWNsZXNQb3QgKiAyICogcGFydGljbGVUZXhDaGFubmVsc10gPSByWjtcbiAgICB9XG4gICAgcmFuZG9tUG9zLmRhdGFbMF0gPSByWCAtIDAuNTtcbiAgICByYW5kb21Qb3MuZGF0YVsxXSA9IHJZIC0gMC41O1xuICAgIHJhbmRvbVBvcy5kYXRhWzJdID0gclogLSAwLjU7XG4gICAgaWYgKHRoaXMuZW1pdHRlclNoYXBlID09PSBwYy5FTUlUVEVSU0hBUEVfQk9YKSB7XG4gICAgICByYW5kb21Qb3NUZm9ybWVkLmNvcHkoZW1pdHRlclBvcykuYWRkKHNwYXduTWF0cml4LnRyYW5zZm9ybVBvaW50KHJhbmRvbVBvcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByYW5kb21Qb3Mubm9ybWFsaXplKCk7XG4gICAgICByYW5kb21Qb3NUZm9ybWVkLmNvcHkoZW1pdHRlclBvcykuYWRkKHJhbmRvbVBvcy5zY2FsZShyVyAqIHRoaXMuc3Bhd25Cb3VuZHMpKTtcbiAgICB9XG4gICAgdmFyIHBhcnRpY2xlUmF0ZSwgc3RhcnRTcGF3blRpbWU7XG4gICAgaWYgKHRoaXMucGFjazgpIHtcbiAgICAgIHZhciBwYWNrWCA9IChyYW5kb21Qb3NUZm9ybWVkLmRhdGFbMF0gLSB0aGlzLndvcmxkQm91bmRzLmNlbnRlci5kYXRhWzBdKSAvIHRoaXMud29ybGRCb3VuZHNTaXplLmRhdGFbMF0gKyAwLjU7XG4gICAgICB2YXIgcGFja1kgPSAocmFuZG9tUG9zVGZvcm1lZC5kYXRhWzFdIC0gdGhpcy53b3JsZEJvdW5kcy5jZW50ZXIuZGF0YVsxXSkgLyB0aGlzLndvcmxkQm91bmRzU2l6ZS5kYXRhWzFdICsgMC41O1xuICAgICAgdmFyIHBhY2taID0gKHJhbmRvbVBvc1Rmb3JtZWQuZGF0YVsyXSAtIHRoaXMud29ybGRCb3VuZHMuY2VudGVyLmRhdGFbMl0pIC8gdGhpcy53b3JsZEJvdW5kc1NpemUuZGF0YVsyXSArIDAuNTtcbiAgICAgIHZhciBwYWNrQSA9IHBjLm1hdGgubGVycCh0aGlzLnN0YXJ0QW5nbGUgKiBwYy5tYXRoLkRFR19UT19SQUQsIHRoaXMuc3RhcnRBbmdsZTIgKiBwYy5tYXRoLkRFR19UT19SQUQsIHJYKTtcbiAgICAgIHBhY2tBID0gcGFja0EgJSAoTWF0aC5QSSAqIDIpIC8gKE1hdGguUEkgKiAyKTtcbiAgICAgIHZhciByZzAgPSBlbmNvZGVGbG9hdFJHKHBhY2tYKTtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gcmcwWzBdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDFdID0gcmcwWzFdO1xuICAgICAgdmFyIGJhMCA9IGVuY29kZUZsb2F0UkcocGFja1kpO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDJdID0gYmEwWzBdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDNdID0gYmEwWzFdO1xuICAgICAgdmFyIHJnMSA9IGVuY29kZUZsb2F0UkcocGFja1opO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDAgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gcmcxWzBdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDEgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gcmcxWzFdO1xuICAgICAgdmFyIGJhMSA9IGVuY29kZUZsb2F0UkcocGFja0EpO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDIgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gYmExWzBdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDMgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gYmExWzFdO1xuICAgICAgdmFyIGEyID0gMS4wO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDMgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKiAyXSA9IGEyO1xuICAgICAgcGFydGljbGVSYXRlID0gcGMubWF0aC5sZXJwKHRoaXMucmF0ZSwgdGhpcy5yYXRlMiwgclgpO1xuICAgICAgc3RhcnRTcGF3blRpbWUgPSAtcGFydGljbGVSYXRlICogaTtcbiAgICAgIHZhciBtYXhOZWdMaWZlID0gTWF0aC5tYXgodGhpcy5saWZldGltZSwgKHRoaXMubnVtUGFydGljbGVzIC0gMS4wKSAqIE1hdGgubWF4KHRoaXMucmF0ZSwgdGhpcy5yYXRlMikpO1xuICAgICAgdmFyIG1heFBvc0xpZmUgPSB0aGlzLmxpZmV0aW1lICsgMS4wO1xuICAgICAgc3RhcnRTcGF3blRpbWUgPSAoc3RhcnRTcGF3blRpbWUgKyBtYXhOZWdMaWZlKSAvIChtYXhOZWdMaWZlICsgbWF4UG9zTGlmZSk7XG4gICAgICB2YXIgcmdiYTMgPSBlbmNvZGVGbG9hdFJHQkEoc3RhcnRTcGF3blRpbWUpO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDAgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKiAzXSA9IHJnYmEzWzBdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDEgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKiAzXSA9IHJnYmEzWzFdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDIgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKiAzXSA9IHJnYmEzWzJdO1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpICogcGFydGljbGVUZXhDaGFubmVscyArIDMgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKiAzXSA9IHJnYmEzWzNdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBhcnRpY2xlVGV4W2kgKiBwYXJ0aWNsZVRleENoYW5uZWxzXSA9IHJhbmRvbVBvc1Rmb3JtZWQuZGF0YVswXTtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAxXSA9IHJhbmRvbVBvc1Rmb3JtZWQuZGF0YVsxXTtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAyXSA9IHJhbmRvbVBvc1Rmb3JtZWQuZGF0YVsyXTtcbiAgICAgIHRoaXMucGFydGljbGVUZXhbaSAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAzXSA9IHBjLm1hdGgubGVycCh0aGlzLnN0YXJ0QW5nbGUgKiBwYy5tYXRoLkRFR19UT19SQUQsIHRoaXMuc3RhcnRBbmdsZTIgKiBwYy5tYXRoLkRFR19UT19SQUQsIHJYKTtcbiAgICAgIHBhcnRpY2xlUmF0ZSA9IHBjLm1hdGgubGVycCh0aGlzLnJhdGUsIHRoaXMucmF0ZTIsIHJYKTtcbiAgICAgIHN0YXJ0U3Bhd25UaW1lID0gLXBhcnRpY2xlUmF0ZSAqIGk7XG4gICAgICB0aGlzLnBhcnRpY2xlVGV4W2kgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogcGFydGljbGVUZXhDaGFubmVsc10gPSBzdGFydFNwYXduVGltZTtcbiAgICB9XG4gIH0sIHJlYnVpbGRHcmFwaHM6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHByZWNpc2lvbiA9IHRoaXMucHJlY2lzaW9uO1xuICAgIHZhciBnZCA9IHRoaXMuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdmFyIGk7XG4gICAgdGhpcy5xTG9jYWxWZWxvY2l0eSA9IHRoaXMubG9jYWxWZWxvY2l0eUdyYXBoLnF1YW50aXplKHByZWNpc2lvbik7XG4gICAgdGhpcy5xVmVsb2NpdHkgPSB0aGlzLnZlbG9jaXR5R3JhcGgucXVhbnRpemUocHJlY2lzaW9uKTtcbiAgICB0aGlzLnFDb2xvciA9IHRoaXMuY29sb3JHcmFwaC5xdWFudGl6ZShwcmVjaXNpb24pO1xuICAgIHRoaXMucVJvdFNwZWVkID0gdGhpcy5yb3RhdGlvblNwZWVkR3JhcGgucXVhbnRpemUocHJlY2lzaW9uKTtcbiAgICB0aGlzLnFTY2FsZSA9IHRoaXMuc2NhbGVHcmFwaC5xdWFudGl6ZShwcmVjaXNpb24pO1xuICAgIHRoaXMucUFscGhhID0gdGhpcy5hbHBoYUdyYXBoLnF1YW50aXplKHByZWNpc2lvbik7XG4gICAgdGhpcy5xTG9jYWxWZWxvY2l0eTIgPSB0aGlzLmxvY2FsVmVsb2NpdHlHcmFwaDIucXVhbnRpemUocHJlY2lzaW9uKTtcbiAgICB0aGlzLnFWZWxvY2l0eTIgPSB0aGlzLnZlbG9jaXR5R3JhcGgyLnF1YW50aXplKHByZWNpc2lvbik7XG4gICAgdGhpcy5xQ29sb3IyID0gdGhpcy5jb2xvckdyYXBoMi5xdWFudGl6ZShwcmVjaXNpb24pO1xuICAgIHRoaXMucVJvdFNwZWVkMiA9IHRoaXMucm90YXRpb25TcGVlZEdyYXBoMi5xdWFudGl6ZShwcmVjaXNpb24pO1xuICAgIHRoaXMucVNjYWxlMiA9IHRoaXMuc2NhbGVHcmFwaDIucXVhbnRpemUocHJlY2lzaW9uKTtcbiAgICB0aGlzLnFBbHBoYTIgPSB0aGlzLmFscGhhR3JhcGgyLnF1YW50aXplKHByZWNpc2lvbik7XG4gICAgZm9yIChpID0gMDtpIDwgcHJlY2lzaW9uO2krKykge1xuICAgICAgdGhpcy5xUm90U3BlZWRbaV0gKj0gcGMubWF0aC5ERUdfVE9fUkFEO1xuICAgICAgdGhpcy5xUm90U3BlZWQyW2ldICo9IHBjLm1hdGguREVHX1RPX1JBRDtcbiAgICB9XG4gICAgdGhpcy5sb2NhbFZlbG9jaXR5VU1heCA9IG5ldyBwYy5WZWMzKDAsIDAsIDApO1xuICAgIHRoaXMudmVsb2NpdHlVTWF4ID0gbmV3IHBjLlZlYzMoMCwgMCwgMCk7XG4gICAgdGhpcy5jb2xvclVNYXggPSBuZXcgcGMuVmVjMygwLCAwLCAwKTtcbiAgICB0aGlzLnJvdFNwZWVkVU1heCA9IFswXTtcbiAgICB0aGlzLnNjYWxlVU1heCA9IFswXTtcbiAgICB0aGlzLmFscGhhVU1heCA9IFswXTtcbiAgICB0aGlzLnFMb2NhbFZlbG9jaXR5RGl2ID0gZGl2R3JhcGhGcm9tMkN1cnZlcyh0aGlzLnFMb2NhbFZlbG9jaXR5LCB0aGlzLnFMb2NhbFZlbG9jaXR5MiwgdGhpcy5sb2NhbFZlbG9jaXR5VU1heC5kYXRhKTtcbiAgICB0aGlzLnFWZWxvY2l0eURpdiA9IGRpdkdyYXBoRnJvbTJDdXJ2ZXModGhpcy5xVmVsb2NpdHksIHRoaXMucVZlbG9jaXR5MiwgdGhpcy52ZWxvY2l0eVVNYXguZGF0YSk7XG4gICAgdGhpcy5xQ29sb3JEaXYgPSBkaXZHcmFwaEZyb20yQ3VydmVzKHRoaXMucUNvbG9yLCB0aGlzLnFDb2xvcjIsIHRoaXMuY29sb3JVTWF4LmRhdGEpO1xuICAgIHRoaXMucVJvdFNwZWVkRGl2ID0gZGl2R3JhcGhGcm9tMkN1cnZlcyh0aGlzLnFSb3RTcGVlZCwgdGhpcy5xUm90U3BlZWQyLCB0aGlzLnJvdFNwZWVkVU1heCk7XG4gICAgdGhpcy5xU2NhbGVEaXYgPSBkaXZHcmFwaEZyb20yQ3VydmVzKHRoaXMucVNjYWxlLCB0aGlzLnFTY2FsZTIsIHRoaXMuc2NhbGVVTWF4KTtcbiAgICB0aGlzLnFBbHBoYURpdiA9IGRpdkdyYXBoRnJvbTJDdXJ2ZXModGhpcy5xQWxwaGEsIHRoaXMucUFscGhhMiwgdGhpcy5hbHBoYVVNYXgpO1xuICAgIGlmICh0aGlzLnBhY2s4KSB7XG4gICAgICB2YXIgdW1heCA9IFswLCAwLCAwXTtcbiAgICAgIG1heFVuc2lnbmVkR3JhcGhWYWx1ZSh0aGlzLnFWZWxvY2l0eSwgdW1heCk7XG4gICAgICB2YXIgdW1heDIgPSBbMCwgMCwgMF07XG4gICAgICBtYXhVbnNpZ25lZEdyYXBoVmFsdWUodGhpcy5xVmVsb2NpdHkyLCB1bWF4Mik7XG4gICAgICB2YXIgbHVtYXggPSBbMCwgMCwgMF07XG4gICAgICBtYXhVbnNpZ25lZEdyYXBoVmFsdWUodGhpcy5xTG9jYWxWZWxvY2l0eSwgbHVtYXgpO1xuICAgICAgdmFyIGx1bWF4MiA9IFswLCAwLCAwXTtcbiAgICAgIG1heFVuc2lnbmVkR3JhcGhWYWx1ZSh0aGlzLnFMb2NhbFZlbG9jaXR5MiwgbHVtYXgyKTtcbiAgICAgIHZhciBtYXhWZWwgPSBNYXRoLm1heCh1bWF4WzBdLCB1bWF4MlswXSk7XG4gICAgICBtYXhWZWwgPSBNYXRoLm1heChtYXhWZWwsIHVtYXhbMV0pO1xuICAgICAgbWF4VmVsID0gTWF0aC5tYXgobWF4VmVsLCB1bWF4MlsxXSk7XG4gICAgICBtYXhWZWwgPSBNYXRoLm1heChtYXhWZWwsIHVtYXhbMl0pO1xuICAgICAgbWF4VmVsID0gTWF0aC5tYXgobWF4VmVsLCB1bWF4MlsyXSk7XG4gICAgICB2YXIgbG1heFZlbCA9IE1hdGgubWF4KGx1bWF4WzBdLCBsdW1heDJbMF0pO1xuICAgICAgbG1heFZlbCA9IE1hdGgubWF4KGxtYXhWZWwsIGx1bWF4WzFdKTtcbiAgICAgIGxtYXhWZWwgPSBNYXRoLm1heChsbWF4VmVsLCBsdW1heDJbMV0pO1xuICAgICAgbG1heFZlbCA9IE1hdGgubWF4KGxtYXhWZWwsIGx1bWF4WzJdKTtcbiAgICAgIGxtYXhWZWwgPSBNYXRoLm1heChsbWF4VmVsLCBsdW1heDJbMl0pO1xuICAgICAgdGhpcy5tYXhWZWwgPSBtYXhWZWwgKyBsbWF4VmVsO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudXNlQ3B1KSB7XG4gICAgICB0aGlzLmludGVybmFsVGV4MCA9IF9jcmVhdGVUZXh0dXJlKGdkLCBwcmVjaXNpb24sIDEsIHBhY2tUZXh0dXJlWFlaX05YWVoodGhpcy5xTG9jYWxWZWxvY2l0eSwgdGhpcy5xTG9jYWxWZWxvY2l0eURpdikpO1xuICAgICAgdGhpcy5pbnRlcm5hbFRleDEgPSBfY3JlYXRlVGV4dHVyZShnZCwgcHJlY2lzaW9uLCAxLCBwYWNrVGV4dHVyZVhZWl9OWFlaKHRoaXMucVZlbG9jaXR5LCB0aGlzLnFWZWxvY2l0eURpdikpO1xuICAgICAgdGhpcy5pbnRlcm5hbFRleDIgPSBfY3JlYXRlVGV4dHVyZShnZCwgcHJlY2lzaW9uLCAxLCBwYWNrVGV4dHVyZTVGbG9hdHModGhpcy5xUm90U3BlZWQsIHRoaXMucVNjYWxlLCB0aGlzLnFTY2FsZURpdiwgdGhpcy5xUm90U3BlZWREaXYsIHRoaXMucUFscGhhRGl2KSk7XG4gICAgfVxuICAgIHRoaXMuaW50ZXJuYWxUZXgzID0gX2NyZWF0ZVRleHR1cmUoZ2QsIHByZWNpc2lvbiwgMSwgcGFja1RleHR1cmVSR0JBKHRoaXMucUNvbG9yLCB0aGlzLnFBbHBoYSksIHBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCAxLjAsIHRydWUpO1xuICB9LCBfaW5pdGlhbGl6ZVRleHR1cmVzOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmNvbG9yTWFwKSB7XG4gICAgICB0aGlzLm1hdGVyaWFsLnNldFBhcmFtZXRlcihcImNvbG9yTWFwXCIsIHRoaXMuY29sb3JNYXApO1xuICAgICAgaWYgKHRoaXMubGlnaHRpbmcgJiYgdGhpcy5ub3JtYWxNYXApIHtcbiAgICAgICAgdGhpcy5tYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJub3JtYWxNYXBcIiwgdGhpcy5ub3JtYWxNYXApO1xuICAgICAgfVxuICAgIH1cbiAgfSwgcmVnZW5TaGFkZXI6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHByb2dyYW1MaWIgPSB0aGlzLmdyYXBoaWNzRGV2aWNlLmdldFByb2dyYW1MaWJyYXJ5KCk7XG4gICAgdmFyIGhhc05vcm1hbCA9IHRoaXMubm9ybWFsTWFwICE9PSBudWxsO1xuICAgIHRoaXMubm9ybWFsT3B0aW9uID0gMDtcbiAgICBpZiAodGhpcy5saWdodGluZykge1xuICAgICAgdGhpcy5ub3JtYWxPcHRpb24gPSBoYXNOb3JtYWwgPyAyIDogMTtcbiAgICB9XG4gICAgdGhpcy5tYXRlcmlhbC51cGRhdGVTaGFkZXIgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmICh0aGlzLmVtaXR0ZXIuc2NlbmUpIHtcbiAgICAgICAgaWYgKHRoaXMuZW1pdHRlci5jYW1lcmEgIT0gdGhpcy5lbWl0dGVyLnNjZW5lLl9hY3RpdmVDYW1lcmEpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuY2FtZXJhID0gdGhpcy5lbWl0dGVyLnNjZW5lLl9hY3RpdmVDYW1lcmE7XG4gICAgICAgICAgdGhpcy5lbWl0dGVyLm9uQ2hhbmdlQ2FtZXJhKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHZhciBzaGFkZXIgPSBwcm9ncmFtTGliLmdldFByb2dyYW0oXCJwYXJ0aWNsZVwiLCB7dXNlQ3B1OnRoaXMuZW1pdHRlci51c2VDcHUsIG5vcm1hbDp0aGlzLmVtaXR0ZXIubm9ybWFsT3B0aW9uLCBoYWxmbGFtYmVydDp0aGlzLmVtaXR0ZXIuaGFsZkxhbWJlcnQsIHN0cmV0Y2g6dGhpcy5lbWl0dGVyLnN0cmV0Y2gsIGFsaWduVG9Nb3Rpb246dGhpcy5lbWl0dGVyLmFsaWduVG9Nb3Rpb24sIHNvZnQ6dGhpcy5lbWl0dGVyLmRlcHRoU29mdGVuaW5nLCBtZXNoOnRoaXMuZW1pdHRlci51c2VNZXNoLCBnYW1tYTp0aGlzLmVtaXR0ZXIuc2NlbmUgPyB0aGlzLmVtaXR0ZXIuc2NlbmUuZ2FtbWFDb3JyZWN0aW9uIDogMCwgdG9uZU1hcDp0aGlzLmVtaXR0ZXIuc2NlbmUgPyB0aGlzLmVtaXR0ZXIuc2NlbmUudG9uZU1hcHBpbmcgOiAwLCBmb2c6dGhpcy5lbWl0dGVyLnNjZW5lICYmICF0aGlzLmVtaXR0ZXIubm9Gb2cgPyB0aGlzLmVtaXR0ZXIuc2NlbmUuZm9nIDogXCJub25lXCIsIHdyYXA6dGhpcy5lbWl0dGVyLndyYXAgJiZcbiAgICAgIHRoaXMuZW1pdHRlci53cmFwQm91bmRzLCBsb2NhbFNwYWNlOnRoaXMuZW1pdHRlci5sb2NhbFNwYWNlLCBibGVuZDp0aGlzLmJsZW5kVHlwZSwgYW5pbVRleDp0aGlzLmVtaXR0ZXIuX2lzQW5pbWF0ZWQoKSwgYW5pbVRleExvb3A6dGhpcy5lbWl0dGVyLmFuaW1Mb29wLCBwYWNrODp0aGlzLmVtaXR0ZXIucGFjazh9KTtcbiAgICAgIHRoaXMuc2V0U2hhZGVyKHNoYWRlcik7XG4gICAgfTtcbiAgICB0aGlzLm1hdGVyaWFsLnVwZGF0ZVNoYWRlcigpO1xuICB9LCByZXNldE1hdGVyaWFsOmZ1bmN0aW9uKCkge1xuICAgIHZhciBtYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7XG4gICAgdmFyIGdkID0gdGhpcy5ncmFwaGljc0RldmljZTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJzdHJldGNoXCIsIHRoaXMuc3RyZXRjaCk7XG4gICAgaWYgKHRoaXMuX2lzQW5pbWF0ZWQoKSkge1xuICAgICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwiYW5pbVRleFBhcmFtc1wiLCB0aGlzLmFuaW1QYXJhbXMuZGF0YSk7XG4gICAgfVxuICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcImNvbG9yTXVsdFwiLCB0aGlzLmludGVuc2l0eSk7XG4gICAgaWYgKCF0aGlzLnVzZUNwdSkge1xuICAgICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwiaW50ZXJuYWxUZXgwXCIsIHRoaXMuaW50ZXJuYWxUZXgwKTtcbiAgICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcImludGVybmFsVGV4MVwiLCB0aGlzLmludGVybmFsVGV4MSk7XG4gICAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJpbnRlcm5hbFRleDJcIiwgdGhpcy5pbnRlcm5hbFRleDIpO1xuICAgIH1cbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJpbnRlcm5hbFRleDNcIiwgdGhpcy5pbnRlcm5hbFRleDMpO1xuICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcIm51bVBhcnRpY2xlc1wiLCB0aGlzLm51bVBhcnRpY2xlcyk7XG4gICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwibnVtUGFydGljbGVzUG90XCIsIHRoaXMubnVtUGFydGljbGVzUG90KTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJsaWZldGltZVwiLCB0aGlzLmxpZmV0aW1lKTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJyYXRlXCIsIHRoaXMucmF0ZSk7XG4gICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwicmF0ZURpdlwiLCB0aGlzLnJhdGUyIC0gdGhpcy5yYXRlKTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJzZWVkXCIsIHRoaXMuc2VlZCk7XG4gICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwic2NhbGVEaXZNdWx0XCIsIHRoaXMuc2NhbGVVTWF4WzBdKTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJhbHBoYURpdk11bHRcIiwgdGhpcy5hbHBoYVVNYXhbMF0pO1xuICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcImdyYXBoTnVtU2FtcGxlc1wiLCB0aGlzLnByZWNpc2lvbik7XG4gICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwiZ3JhcGhTYW1wbGVTaXplXCIsIDEuMCAvIHRoaXMucHJlY2lzaW9uKTtcbiAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJlbWl0dGVyU2NhbGVcIiwgcGMuVmVjMy5PTkUuZGF0YSk7XG4gICAgaWYgKHRoaXMucGFjazgpIHtcbiAgICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcImluQm91bmRzU2l6ZVwiLCB0aGlzLndvcmxkQm91bmRzU2l6ZS5kYXRhKTtcbiAgICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcImluQm91bmRzQ2VudGVyXCIsIHRoaXMud29ybGRCb3VuZHMuY2VudGVyLmRhdGEpO1xuICAgICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwibWF4VmVsXCIsIHRoaXMubWF4VmVsKTtcbiAgICB9XG4gICAgaWYgKHRoaXMud3JhcCAmJiB0aGlzLndyYXBCb3VuZHMpIHtcbiAgICAgIG1hdGVyaWFsLnNldFBhcmFtZXRlcihcIndyYXBCb3VuZHNcIiwgdGhpcy53cmFwQm91bmRzLmRhdGEpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb2xvck1hcCkge1xuICAgICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwiY29sb3JNYXBcIiwgdGhpcy5jb2xvck1hcCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmxpZ2h0aW5nKSB7XG4gICAgICBpZiAodGhpcy5ub3JtYWxNYXApIHtcbiAgICAgICAgbWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwibm9ybWFsTWFwXCIsIHRoaXMubm9ybWFsTWFwKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuZGVwdGhTb2Z0ZW5pbmcgPiAwKSB7XG4gICAgICBtYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJzb2Z0ZW5pbmdcIiwgMS4wIC8gKHRoaXMuZGVwdGhTb2Z0ZW5pbmcgKiB0aGlzLmRlcHRoU29mdGVuaW5nICogMTAwKSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0cmV0Y2ggPiAwLjApIHtcbiAgICAgIG1hdGVyaWFsLmN1bGwgPSBwYy5DVUxMRkFDRV9OT05FO1xuICAgIH1cbiAgfSwgX2FsbG9jYXRlOmZ1bmN0aW9uKG51bVBhcnRpY2xlcykge1xuICAgIHZhciBwc3lzVmVydENvdW50ID0gbnVtUGFydGljbGVzICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzO1xuICAgIHZhciBwc3lzSW5kZXhDb3VudCA9IG51bVBhcnRpY2xlcyAqIHRoaXMubnVtUGFydGljbGVJbmRpY2VzO1xuICAgIHZhciBlbGVtZW50cywgcGFydGljbGVGb3JtYXQ7XG4gICAgdmFyIGk7XG4gICAgaWYgKHRoaXMudmVydGV4QnVmZmVyID09PSB1bmRlZmluZWQgfHwgdGhpcy52ZXJ0ZXhCdWZmZXIuZ2V0TnVtVmVydGljZXMoKSAhPT0gcHN5c1ZlcnRDb3VudCkge1xuICAgICAgaWYgKCF0aGlzLnVzZUNwdSkge1xuICAgICAgICBlbGVtZW50cyA9IFt7c2VtYW50aWM6cGMuU0VNQU5USUNfQVRUUjAsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XTtcbiAgICAgICAgcGFydGljbGVGb3JtYXQgPSBuZXcgcGMuVmVydGV4Rm9ybWF0KHRoaXMuZ3JhcGhpY3NEZXZpY2UsIGVsZW1lbnRzKTtcbiAgICAgICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKHRoaXMuZ3JhcGhpY3NEZXZpY2UsIHBhcnRpY2xlRm9ybWF0LCBwc3lzVmVydENvdW50LCBwYy5CVUZGRVJfRFlOQU1JQyk7XG4gICAgICAgIHRoaXMuaW5kZXhCdWZmZXIgPSBuZXcgcGMuSW5kZXhCdWZmZXIodGhpcy5ncmFwaGljc0RldmljZSwgcGMuSU5ERVhGT1JNQVRfVUlOVDE2LCBwc3lzSW5kZXhDb3VudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlbGVtZW50cyA9IFt7c2VtYW50aWM6cGMuU0VNQU5USUNfQVRUUjAsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9LCB7c2VtYW50aWM6cGMuU0VNQU5USUNfQVRUUjEsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9LCB7c2VtYW50aWM6cGMuU0VNQU5USUNfQVRUUjIsIGNvbXBvbmVudHM6NCwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9LCB7c2VtYW50aWM6cGMuU0VNQU5USUNfQVRUUjMsIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XTtcbiAgICAgICAgcGFydGljbGVGb3JtYXQgPSBuZXcgcGMuVmVydGV4Rm9ybWF0KHRoaXMuZ3JhcGhpY3NEZXZpY2UsIGVsZW1lbnRzKTtcbiAgICAgICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKHRoaXMuZ3JhcGhpY3NEZXZpY2UsIHBhcnRpY2xlRm9ybWF0LCBwc3lzVmVydENvdW50LCBwYy5CVUZGRVJfRFlOQU1JQyk7XG4gICAgICAgIHRoaXMuaW5kZXhCdWZmZXIgPSBuZXcgcGMuSW5kZXhCdWZmZXIodGhpcy5ncmFwaGljc0RldmljZSwgcGMuSU5ERVhGT1JNQVRfVUlOVDE2LCBwc3lzSW5kZXhDb3VudCk7XG4gICAgICB9XG4gICAgICB2YXIgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy52ZXJ0ZXhCdWZmZXIubG9jaygpKTtcbiAgICAgIHZhciBtZXNoRGF0YSwgc3RyaWRlO1xuICAgICAgaWYgKHRoaXMudXNlTWVzaCkge1xuICAgICAgICBtZXNoRGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5tZXNoLnZlcnRleEJ1ZmZlci5sb2NrKCkpO1xuICAgICAgICBzdHJpZGUgPSBtZXNoRGF0YS5sZW5ndGggLyB0aGlzLm1lc2gudmVydGV4QnVmZmVyLm51bVZlcnRpY2VzO1xuICAgICAgfVxuICAgICAgdmFyIGlkLCBybmQ7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBwc3lzVmVydENvdW50O2krKykge1xuICAgICAgICBpZCA9IE1hdGguZmxvb3IoaSAvIHRoaXMubnVtUGFydGljbGVWZXJ0cyk7XG4gICAgICAgIGlmICh0aGlzLnVzZUNwdSkge1xuICAgICAgICAgIGlmIChpICUgdGhpcy5udW1QYXJ0aWNsZVZlcnRzID09PSAwKSB7XG4gICAgICAgICAgICBybmQgPSB0aGlzLnBhcnRpY2xlVGV4W2kgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMCArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMudXNlTWVzaCkge1xuICAgICAgICAgIHZhciB2ZXJ0SUQgPSBpICUgNDtcbiAgICAgICAgICBkYXRhW2kgKiA0XSA9IHBhcnRpY2xlVmVydHNbdmVydElEXVswXTtcbiAgICAgICAgICBkYXRhW2kgKiA0ICsgMV0gPSBwYXJ0aWNsZVZlcnRzW3ZlcnRJRF1bMV07XG4gICAgICAgICAgZGF0YVtpICogNCArIDJdID0gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB2YXIgdmVydCA9IGkgJSB0aGlzLm51bVBhcnRpY2xlVmVydHM7XG4gICAgICAgICAgZGF0YVtpICogNF0gPSBtZXNoRGF0YVt2ZXJ0ICogc3RyaWRlXTtcbiAgICAgICAgICBkYXRhW2kgKiA0ICsgMV0gPSBtZXNoRGF0YVt2ZXJ0ICogc3RyaWRlICsgMV07XG4gICAgICAgICAgZGF0YVtpICogNCArIDJdID0gbWVzaERhdGFbdmVydCAqIHN0cmlkZSArIDJdO1xuICAgICAgICB9XG4gICAgICAgIGRhdGFbaSAqIDQgKyAzXSA9IGlkO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMudXNlQ3B1KSB7XG4gICAgICAgIHRoaXMudmJDUFUgPSBuZXcgRmxvYXQzMkFycmF5KGRhdGEpO1xuICAgICAgICB0aGlzLnZiT2xkID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLnZiQ1BVLmxlbmd0aCk7XG4gICAgICB9XG4gICAgICB0aGlzLnZlcnRleEJ1ZmZlci51bmxvY2soKTtcbiAgICAgIGlmICh0aGlzLnVzZU1lc2gpIHtcbiAgICAgICAgdGhpcy5tZXNoLnZlcnRleEJ1ZmZlci51bmxvY2soKTtcbiAgICAgIH1cbiAgICAgIHZhciBkc3QgPSAwO1xuICAgICAgdmFyIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkodGhpcy5pbmRleEJ1ZmZlci5sb2NrKCkpO1xuICAgICAgaWYgKHRoaXMudXNlTWVzaCkge1xuICAgICAgICBtZXNoRGF0YSA9IG5ldyBVaW50MTZBcnJheSh0aGlzLm1lc2guaW5kZXhCdWZmZXJbMF0ubG9jaygpKTtcbiAgICAgIH1cbiAgICAgIGZvciAoaSA9IDA7aSA8IG51bVBhcnRpY2xlcztpKyspIHtcbiAgICAgICAgaWYgKCF0aGlzLnVzZU1lc2gpIHtcbiAgICAgICAgICB2YXIgYmFzZUluZGV4ID0gaSAqIDQ7XG4gICAgICAgICAgaW5kaWNlc1tkc3QrK10gPSBiYXNlSW5kZXg7XG4gICAgICAgICAgaW5kaWNlc1tkc3QrK10gPSBiYXNlSW5kZXggKyAxO1xuICAgICAgICAgIGluZGljZXNbZHN0KytdID0gYmFzZUluZGV4ICsgMjtcbiAgICAgICAgICBpbmRpY2VzW2RzdCsrXSA9IGJhc2VJbmRleDtcbiAgICAgICAgICBpbmRpY2VzW2RzdCsrXSA9IGJhc2VJbmRleCArIDI7XG4gICAgICAgICAgaW5kaWNlc1tkc3QrK10gPSBiYXNlSW5kZXggKyAzO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZvciAodmFyIGogPSAwO2ogPCB0aGlzLm51bVBhcnRpY2xlSW5kaWNlcztqKyspIHtcbiAgICAgICAgICAgIGluZGljZXNbaSAqIHRoaXMubnVtUGFydGljbGVJbmRpY2VzICsgal0gPSBtZXNoRGF0YVtqXSArIGkgKiB0aGlzLm51bVBhcnRpY2xlVmVydHM7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmluZGV4QnVmZmVyLnVubG9jaygpO1xuICAgICAgaWYgKHRoaXMudXNlTWVzaCkge1xuICAgICAgICB0aGlzLm1lc2guaW5kZXhCdWZmZXJbMF0udW5sb2NrKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCByZXNldDpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmJlZW5SZXNldCA9IHRydWU7XG4gICAgdGhpcy5zZWVkID0gTWF0aC5yYW5kb20oKTtcbiAgICB0aGlzLm1hdGVyaWFsLnNldFBhcmFtZXRlcihcInNlZWRcIiwgdGhpcy5zZWVkKTtcbiAgICBpZiAodGhpcy51c2VDcHUpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCB0aGlzLnBhcnRpY2xlVGV4U3RhcnQubGVuZ3RoO2krKykge1xuICAgICAgICB0aGlzLnBhcnRpY2xlVGV4W2ldID0gdGhpcy5wYXJ0aWNsZVRleFN0YXJ0W2ldO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbml0aWFsaXplVGV4dHVyZXMoKTtcbiAgICB9XG4gICAgdGhpcy5yZXNldFRpbWUoKTtcbiAgICB2YXIgb3JpZ0xvb3AgPSB0aGlzLmxvb3A7XG4gICAgdGhpcy5sb29wID0gdHJ1ZTtcbiAgICB0aGlzLmFkZFRpbWUoMCk7XG4gICAgdGhpcy5sb29wID0gb3JpZ0xvb3A7XG4gICAgaWYgKHRoaXMucHJlV2FybSkge1xuICAgICAgdGhpcy5wcmV3YXJtKHRoaXMubGlmZXRpbWUpO1xuICAgIH1cbiAgfSwgcHJld2FybTpmdW5jdGlvbih0aW1lKSB7XG4gICAgdmFyIGxpZmV0aW1lRnJhY3Rpb24gPSB0aW1lIC8gdGhpcy5saWZldGltZTtcbiAgICB2YXIgaXRlcmF0aW9ucyA9IE1hdGgubWluKE1hdGguZmxvb3IobGlmZXRpbWVGcmFjdGlvbiAqIHRoaXMucHJlY2lzaW9uKSwgdGhpcy5wcmVjaXNpb24pO1xuICAgIHZhciBzdGVwRGVsdGEgPSB0aW1lIC8gaXRlcmF0aW9ucztcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgaXRlcmF0aW9ucztpKyspIHtcbiAgICAgIHRoaXMuYWRkVGltZShzdGVwRGVsdGEpO1xuICAgIH1cbiAgfSwgcmVzZXRUaW1lOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW5kVGltZSA9IGNhbGNFbmRUaW1lKHRoaXMpO1xuICB9LCBvbkVuYWJsZURlcHRoOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmRlcHRoU29mdGVuaW5nID4gMCAmJiB0aGlzLmNhbWVyYSkge1xuICAgICAgdGhpcy5jYW1lcmEucmVxdWVzdERlcHRoTWFwKCk7XG4gICAgfVxuICB9LCBvbkRpc2FibGVEZXB0aDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5kZXB0aFNvZnRlbmluZyA+IDAgJiYgdGhpcy5jYW1lcmEpIHtcbiAgICAgIHRoaXMuY2FtZXJhLnJlbGVhc2VEZXB0aE1hcCgpO1xuICAgIH1cbiAgfSwgZmluaXNoRnJhbWU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMudXNlQ3B1KSB7XG4gICAgICB0aGlzLnZlcnRleEJ1ZmZlci51bmxvY2soKTtcbiAgICB9XG4gIH0sIGFkZFRpbWU6ZnVuY3Rpb24oZGVsdGEsIGlzT25TdG9wKSB7XG4gICAgdmFyIGEsIGIsIGMsIGksIGo7XG4gICAgdmFyIGRldmljZSA9IHRoaXMuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdGhpcy5zaW1UaW1lVG90YWwgKz0gZGVsdGE7XG4gICAgdGhpcy5jYWxjdWxhdGVXb3JsZEJvdW5kcygpO1xuICAgIGlmICh0aGlzLl9pc0FuaW1hdGVkKCkpIHtcbiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmFuaW1QYXJhbXM7XG4gICAgICBwYXJhbXMueCA9IDEuMCAvIHRoaXMuYW5pbVRpbGVzWDtcbiAgICAgIHBhcmFtcy55ID0gMS4wIC8gdGhpcy5hbmltVGlsZXNZO1xuICAgICAgcGFyYW1zLnogPSB0aGlzLmFuaW1OdW1GcmFtZXMgKiB0aGlzLmFuaW1TcGVlZDtcbiAgICAgIHBhcmFtcy53ID0gdGhpcy5hbmltTnVtRnJhbWVzIC0gMTtcbiAgICB9XG4gICAgaWYgKHRoaXMubGlnaHRpbmcpIHtcbiAgICAgIGlmICghdGhpcy5zY2VuZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiVGhlcmUgaXMgbm8gc2NlbmUgZGVmaW5lZCBmb3IgbGlnaHRpbmcgcGFydGljbGVzXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBmb3IgKGkgPSAwO2kgPCA2O2krKykge1xuICAgICAgICB0aGlzLmxpZ2h0Q3ViZVtpICogM10gPSB0aGlzLnNjZW5lLmFtYmllbnRMaWdodC5kYXRhWzBdO1xuICAgICAgICB0aGlzLmxpZ2h0Q3ViZVtpICogMyArIDFdID0gdGhpcy5zY2VuZS5hbWJpZW50TGlnaHQuZGF0YVsxXTtcbiAgICAgICAgdGhpcy5saWdodEN1YmVbaSAqIDMgKyAyXSA9IHRoaXMuc2NlbmUuYW1iaWVudExpZ2h0LmRhdGFbMl07XG4gICAgICB9XG4gICAgICB2YXIgZGlycyA9IHRoaXMuc2NlbmUuX2dsb2JhbExpZ2h0cztcbiAgICAgIGZvciAoaSA9IDA7aSA8IGRpcnMubGVuZ3RoO2krKykge1xuICAgICAgICBmb3IgKGMgPSAwO2MgPCA2O2MrKykge1xuICAgICAgICAgIHZhciB3ZWlnaHQgPSBNYXRoLm1heCh0aGlzLmxpZ2h0Q3ViZURpcltjXS5kb3QoZGlyc1tpXS5fZGlyZWN0aW9uKSwgMCkgKiBkaXJzW2ldLl9pbnRlbnNpdHk7XG4gICAgICAgICAgdGhpcy5saWdodEN1YmVbYyAqIDNdICs9IGRpcnNbaV0uX2NvbG9yLmRhdGFbMF0gKiB3ZWlnaHQ7XG4gICAgICAgICAgdGhpcy5saWdodEN1YmVbYyAqIDMgKyAxXSArPSBkaXJzW2ldLl9jb2xvci5kYXRhWzFdICogd2VpZ2h0O1xuICAgICAgICAgIHRoaXMubGlnaHRDdWJlW2MgKiAzICsgMl0gKz0gZGlyc1tpXS5fY29sb3IuZGF0YVsyXSAqIHdlaWdodDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5jb25zdGFudExpZ2h0Q3ViZS5zZXRWYWx1ZSh0aGlzLmxpZ2h0Q3ViZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnNjZW5lKSB7XG4gICAgICBpZiAodGhpcy5jYW1lcmEgIT0gdGhpcy5zY2VuZS5fYWN0aXZlQ2FtZXJhKSB7XG4gICAgICAgIHRoaXMuY2FtZXJhID0gdGhpcy5zY2VuZS5fYWN0aXZlQ2FtZXJhO1xuICAgICAgICB0aGlzLm9uQ2hhbmdlQ2FtZXJhKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmVtaXR0ZXJTaGFwZSA9PT0gcGMuRU1JVFRFUlNIQVBFX0JPWCkge1xuICAgICAgaWYgKHRoaXMubWVzaEluc3RhbmNlLm5vZGUgPT09IG51bGwpIHtcbiAgICAgICAgc3Bhd25NYXRyaXguc2V0VFJTKHBjLlZlYzMuWkVSTywgcGMuUXVhdC5JREVOVElUWSwgdGhpcy5lbWl0dGVyRXh0ZW50cyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzcGF3bk1hdHJpeC5zZXRUUlMocGMuVmVjMy5aRVJPLCB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlLmdldFJvdGF0aW9uKCksIHRtcFZlYzMuY29weSh0aGlzLmVtaXR0ZXJFeHRlbnRzKS5tdWwodGhpcy5tZXNoSW5zdGFuY2Uubm9kZS5sb2NhbFNjYWxlKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBlbWl0dGVyUG9zO1xuICAgIHZhciBlbWl0dGVyU2NhbGUgPSB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlID09PSBudWxsID8gcGMuVmVjMy5PTkUuZGF0YSA6IHRoaXMubWVzaEluc3RhbmNlLm5vZGUubG9jYWxTY2FsZS5kYXRhO1xuICAgIHRoaXMubWF0ZXJpYWwuc2V0UGFyYW1ldGVyKFwiZW1pdHRlclNjYWxlXCIsIGVtaXR0ZXJTY2FsZSk7XG4gICAgaWYgKHRoaXMubG9jYWxTcGFjZSAmJiB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlKSB7XG4gICAgICB0aGlzLm1hdGVyaWFsLnNldFBhcmFtZXRlcihcImVtaXR0ZXJQb3NcIiwgdGhpcy5tZXNoSW5zdGFuY2Uubm9kZS5nZXRQb3NpdGlvbigpLmRhdGEpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudXNlQ3B1KSB7XG4gICAgICBkZXZpY2Uuc2V0QmxlbmRpbmcoZmFsc2UpO1xuICAgICAgZGV2aWNlLnNldENvbG9yV3JpdGUodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICBkZXZpY2Uuc2V0Q3VsbE1vZGUocGMuQ1VMTEZBQ0VfTk9ORSk7XG4gICAgICBkZXZpY2Uuc2V0RGVwdGhUZXN0KGZhbHNlKTtcbiAgICAgIGRldmljZS5zZXREZXB0aFdyaXRlKGZhbHNlKTtcbiAgICAgIHRoaXMuZnJhbWVSYW5kb20ueCA9IE1hdGgucmFuZG9tKCk7XG4gICAgICB0aGlzLmZyYW1lUmFuZG9tLnkgPSBNYXRoLnJhbmRvbSgpO1xuICAgICAgdGhpcy5mcmFtZVJhbmRvbS56ID0gTWF0aC5yYW5kb20oKTtcbiAgICAgIHRoaXMuY29uc3RhbnRHcmFwaFNhbXBsZVNpemUuc2V0VmFsdWUoMS4wIC8gdGhpcy5wcmVjaXNpb24pO1xuICAgICAgdGhpcy5jb25zdGFudEdyYXBoTnVtU2FtcGxlcy5zZXRWYWx1ZSh0aGlzLnByZWNpc2lvbik7XG4gICAgICB0aGlzLmNvbnN0YW50TnVtUGFydGljbGVzLnNldFZhbHVlKHRoaXMubnVtUGFydGljbGVzKTtcbiAgICAgIHRoaXMuY29uc3RhbnROdW1QYXJ0aWNsZXNQb3Quc2V0VmFsdWUodGhpcy5udW1QYXJ0aWNsZXNQb3QpO1xuICAgICAgdGhpcy5jb25zdGFudEludGVybmFsVGV4MC5zZXRWYWx1ZSh0aGlzLmludGVybmFsVGV4MCk7XG4gICAgICB0aGlzLmNvbnN0YW50SW50ZXJuYWxUZXgxLnNldFZhbHVlKHRoaXMuaW50ZXJuYWxUZXgxKTtcbiAgICAgIHRoaXMuY29uc3RhbnRJbnRlcm5hbFRleDIuc2V0VmFsdWUodGhpcy5pbnRlcm5hbFRleDIpO1xuICAgICAgaWYgKHRoaXMucGFjazgpIHtcbiAgICAgICAgdGhpcy5jb25zdGFudE91dEJvdW5kc011bC5zZXRWYWx1ZSh0aGlzLndvcmxkQm91bmRzTXVsLmRhdGEpO1xuICAgICAgICB0aGlzLmNvbnN0YW50T3V0Qm91bmRzQWRkLnNldFZhbHVlKHRoaXMud29ybGRCb3VuZHNBZGQuZGF0YSk7XG4gICAgICAgIHRoaXMuY29uc3RhbnRJbkJvdW5kc1NpemUuc2V0VmFsdWUodGhpcy5wcmV2V29ybGRCb3VuZHNTaXplLmRhdGEpO1xuICAgICAgICB0aGlzLmNvbnN0YW50SW5Cb3VuZHNDZW50ZXIuc2V0VmFsdWUodGhpcy5wcmV2V29ybGRCb3VuZHNDZW50ZXIuZGF0YSk7XG4gICAgICAgIHZhciBtYXhWZWwgPSB0aGlzLm1heFZlbCAqIE1hdGgubWF4KE1hdGgubWF4KGVtaXR0ZXJTY2FsZVswXSwgZW1pdHRlclNjYWxlWzFdKSwgZW1pdHRlclNjYWxlWzJdKTtcbiAgICAgICAgbWF4VmVsID0gTWF0aC5tYXgobWF4VmVsLCAxKTtcbiAgICAgICAgdGhpcy5jb25zdGFudE1heFZlbC5zZXRWYWx1ZShtYXhWZWwpO1xuICAgICAgfVxuICAgICAgZW1pdHRlclBvcyA9IHRoaXMubWVzaEluc3RhbmNlLm5vZGUgPT09IG51bGwgfHwgdGhpcy5sb2NhbFNwYWNlID8gcGMuVmVjMy5aRVJPLmRhdGEgOiB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlLmdldFBvc2l0aW9uKCkuZGF0YTtcbiAgICAgIHZhciBlbWl0dGVyTWF0cml4ID0gdGhpcy5tZXNoSW5zdGFuY2Uubm9kZSA9PT0gbnVsbCA/IHBjLk1hdDQuSURFTlRJVFkgOiB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgICBpZiAodGhpcy5lbWl0dGVyU2hhcGUgPT09IHBjLkVNSVRURVJTSEFQRV9CT1gpIHtcbiAgICAgICAgbWF0NFRvTWF0MyhzcGF3bk1hdHJpeCwgc3Bhd25NYXRyaXgzKTtcbiAgICAgICAgdGhpcy5jb25zdGFudFNwYXduQm91bmRzLnNldFZhbHVlKHNwYXduTWF0cml4My5kYXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29uc3RhbnRTcGF3bkJvdW5kc1NwaGVyZS5zZXRWYWx1ZSh0aGlzLmVtaXR0ZXJSYWRpdXMpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb25zdGFudEluaXRpYWxWZWxvY2l0eS5zZXRWYWx1ZSh0aGlzLmluaXRpYWxWZWxvY2l0eSk7XG4gICAgICBtYXQ0VG9NYXQzKGVtaXR0ZXJNYXRyaXgsIGVtaXR0ZXJNYXRyaXgzKTtcbiAgICAgIHRoaXMuY29uc3RhbnRFbWl0dGVyUG9zLnNldFZhbHVlKGVtaXR0ZXJQb3MpO1xuICAgICAgdGhpcy5jb25zdGFudEZyYW1lUmFuZG9tLnNldFZhbHVlKHRoaXMuZnJhbWVSYW5kb20uZGF0YSk7XG4gICAgICB0aGlzLmNvbnN0YW50RGVsdGEuc2V0VmFsdWUoZGVsdGEpO1xuICAgICAgdGhpcy5jb25zdGFudFJhdGUuc2V0VmFsdWUodGhpcy5yYXRlKTtcbiAgICAgIHRoaXMuY29uc3RhbnRSYXRlRGl2LnNldFZhbHVlKHRoaXMucmF0ZTIgLSB0aGlzLnJhdGUpO1xuICAgICAgdGhpcy5jb25zdGFudFN0YXJ0QW5nbGUuc2V0VmFsdWUodGhpcy5zdGFydEFuZ2xlICogcGMubWF0aC5ERUdfVE9fUkFEKTtcbiAgICAgIHRoaXMuY29uc3RhbnRTdGFydEFuZ2xlMi5zZXRWYWx1ZSh0aGlzLnN0YXJ0QW5nbGUyICogcGMubWF0aC5ERUdfVE9fUkFEKTtcbiAgICAgIHRoaXMuY29uc3RhbnRTZWVkLnNldFZhbHVlKHRoaXMuc2VlZCk7XG4gICAgICB0aGlzLmNvbnN0YW50TGlmZXRpbWUuc2V0VmFsdWUodGhpcy5saWZldGltZSk7XG4gICAgICB0aGlzLmNvbnN0YW50RW1pdHRlclNjYWxlLnNldFZhbHVlKGVtaXR0ZXJTY2FsZSk7XG4gICAgICB0aGlzLmNvbnN0YW50RW1pdHRlck1hdHJpeC5zZXRWYWx1ZShlbWl0dGVyTWF0cml4My5kYXRhKTtcbiAgICAgIHRoaXMuY29uc3RhbnRMb2NhbFZlbG9jaXR5RGl2TXVsdC5zZXRWYWx1ZSh0aGlzLmxvY2FsVmVsb2NpdHlVTWF4LmRhdGEpO1xuICAgICAgdGhpcy5jb25zdGFudFZlbG9jaXR5RGl2TXVsdC5zZXRWYWx1ZSh0aGlzLnZlbG9jaXR5VU1heC5kYXRhKTtcbiAgICAgIHRoaXMuY29uc3RhbnRSb3RTcGVlZERpdk11bHQuc2V0VmFsdWUodGhpcy5yb3RTcGVlZFVNYXhbMF0pO1xuICAgICAgdmFyIHRleElOID0gdGhpcy5zd2FwVGV4ID8gdGhpcy5wYXJ0aWNsZVRleE9VVCA6IHRoaXMucGFydGljbGVUZXhJTjtcbiAgICAgIHRleElOID0gdGhpcy5iZWVuUmVzZXQgPyB0aGlzLnBhcnRpY2xlVGV4U3RhcnQgOiB0ZXhJTjtcbiAgICAgIHZhciB0ZXhPVVQgPSB0aGlzLnN3YXBUZXggPyB0aGlzLnBhcnRpY2xlVGV4SU4gOiB0aGlzLnBhcnRpY2xlVGV4T1VUO1xuICAgICAgdGhpcy5jb25zdGFudFBhcnRpY2xlVGV4SU4uc2V0VmFsdWUodGV4SU4pO1xuICAgICAgaWYgKCFpc09uU3RvcCkge1xuICAgICAgICBwYy5kcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0aGlzLnN3YXBUZXggPyB0aGlzLnJ0UGFydGljbGVUZXhJTiA6IHRoaXMucnRQYXJ0aWNsZVRleE9VVCwgdGhpcy5sb29wID8gdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZVJlc3Bhd24gOiB0aGlzLnNoYWRlclBhcnRpY2xlVXBkYXRlTm9SZXNwYXduKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBjLmRyYXdRdWFkV2l0aFNoYWRlcihkZXZpY2UsIHRoaXMuc3dhcFRleCA/IHRoaXMucnRQYXJ0aWNsZVRleElOIDogdGhpcy5ydFBhcnRpY2xlVGV4T1VULCB0aGlzLnNoYWRlclBhcnRpY2xlVXBkYXRlT25TdG9wKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY29uc3RhbnRQYXJ0aWNsZVRleE9VVC5zZXRWYWx1ZSh0ZXhPVVQpO1xuICAgICAgdGhpcy5tYXRlcmlhbC5zZXRQYXJhbWV0ZXIoXCJwYXJ0aWNsZVRleE9VVFwiLCB0ZXhJTik7XG4gICAgICB0aGlzLm1hdGVyaWFsLnNldFBhcmFtZXRlcihcInBhcnRpY2xlVGV4SU5cIiwgdGV4T1VUKTtcbiAgICAgIHRoaXMuYmVlblJlc2V0ID0gZmFsc2U7XG4gICAgICB0aGlzLnN3YXBUZXggPSAhdGhpcy5zd2FwVGV4O1xuICAgICAgZGV2aWNlLnNldERlcHRoVGVzdCh0cnVlKTtcbiAgICAgIGRldmljZS5zZXREZXB0aFdyaXRlKHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy52ZXJ0ZXhCdWZmZXIubG9jaygpKTtcbiAgICAgIGlmICh0aGlzLm1lc2hJbnN0YW5jZS5ub2RlKSB7XG4gICAgICAgIHZhciBmdWxsTWF0ID0gdGhpcy5tZXNoSW5zdGFuY2Uubm9kZS53b3JsZFRyYW5zZm9ybTtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgMTI7aisrKSB7XG4gICAgICAgICAgcm90TWF0LmRhdGFbal0gPSBmdWxsTWF0LmRhdGFbal07XG4gICAgICAgIH1cbiAgICAgICAgbm9uVW5pZm9ybVNjYWxlID0gdGhpcy5tZXNoSW5zdGFuY2Uubm9kZS5sb2NhbFNjYWxlO1xuICAgICAgICB1bmlmb3JtU2NhbGUgPSBNYXRoLm1heChNYXRoLm1heChub25Vbmlmb3JtU2NhbGUueCwgbm9uVW5pZm9ybVNjYWxlLnkpLCBub25Vbmlmb3JtU2NhbGUueik7XG4gICAgICB9XG4gICAgICBlbWl0dGVyUG9zID0gdGhpcy5tZXNoSW5zdGFuY2Uubm9kZSA9PT0gbnVsbCB8fCB0aGlzLmxvY2FsU3BhY2UgPyBwYy5WZWMzLlpFUk8gOiB0aGlzLm1lc2hJbnN0YW5jZS5ub2RlLmdldFBvc2l0aW9uKCk7XG4gICAgICB2YXIgcG9zQ2FtID0gdGhpcy5jYW1lcmEgPyB0aGlzLmNhbWVyYS5fbm9kZS5nZXRQb3NpdGlvbigpIDogcGMuVmVjMy5aRVJPO1xuICAgICAgdmFyIHZlcnRTaXplID0gMTQ7XG4gICAgICB2YXIgY2YsIGNjO1xuICAgICAgdmFyIHJvdFNwZWVkLCByb3RTcGVlZDIsIHNjYWxlMiwgYWxwaGEsIGFscGhhMjtcbiAgICAgIHZhciBwcmVjaXNpb24xID0gdGhpcy5wcmVjaXNpb24gLSAxO1xuICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy5udW1QYXJ0aWNsZXM7aSsrKSB7XG4gICAgICAgIHZhciBpZCA9IE1hdGguZmxvb3IodGhpcy52YkNQVVtpICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzICogNCArIDNdKTtcbiAgICAgICAgdmFyIHJuZEZhY3RvciA9IHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMCArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdO1xuICAgICAgICBybmRGYWN0b3IzVmVjLmRhdGFbMF0gPSBybmRGYWN0b3I7XG4gICAgICAgIHJuZEZhY3RvcjNWZWMuZGF0YVsxXSA9IHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMSArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdO1xuICAgICAgICBybmRGYWN0b3IzVmVjLmRhdGFbMl0gPSB0aGlzLnBhcnRpY2xlVGV4W2lkICogcGFydGljbGVUZXhDaGFubmVscyArIDIgKyB0aGlzLm51bVBhcnRpY2xlc1BvdCAqIDIgKiBwYXJ0aWNsZVRleENoYW5uZWxzXTtcbiAgICAgICAgdmFyIHBhcnRpY2xlUmF0ZSA9IHRoaXMucmF0ZSArICh0aGlzLnJhdGUyIC0gdGhpcy5yYXRlKSAqIHJuZEZhY3RvcjtcbiAgICAgICAgdmFyIHBhcnRpY2xlTGlmZXRpbWUgPSB0aGlzLmxpZmV0aW1lO1xuICAgICAgICB2YXIgc3RhcnRTcGF3blRpbWUgPSAtcGFydGljbGVSYXRlICogaWQ7XG4gICAgICAgIHZhciBsaWZlID0gdGhpcy5wYXJ0aWNsZVRleFtpZCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAzICsgdGhpcy5udW1QYXJ0aWNsZXNQb3QgKiBwYXJ0aWNsZVRleENoYW5uZWxzXSArIGRlbHRhO1xuICAgICAgICB2YXIgbmxpZmUgPSBzYXR1cmF0ZShsaWZlIC8gcGFydGljbGVMaWZldGltZSk7XG4gICAgICAgIHZhciBzY2FsZSA9IDA7XG4gICAgICAgIHZhciBhbHBoYURpdiA9IDA7XG4gICAgICAgIHZhciBhbmdsZSA9IDA7XG4gICAgICAgIHZhciBsZW47XG4gICAgICAgIHZhciBpbnRlcnBvbGF0aW9uO1xuICAgICAgICB2YXIgcGFydGljbGVFbmFibGVkID0gbGlmZSA+IDAuMCAmJiBsaWZlIDwgcGFydGljbGVMaWZldGltZTtcbiAgICAgICAgaWYgKHBhcnRpY2xlRW5hYmxlZCkge1xuICAgICAgICAgIGMgPSBubGlmZSAqIHByZWNpc2lvbjE7XG4gICAgICAgICAgY2YgPSBNYXRoLmZsb29yKGMpO1xuICAgICAgICAgIGNjID0gTWF0aC5jZWlsKGMpO1xuICAgICAgICAgIGMgPSBjICUgMTtcbiAgICAgICAgICBhID0gdGhpcy5xUm90U3BlZWRbY2ZdO1xuICAgICAgICAgIGIgPSB0aGlzLnFSb3RTcGVlZFtjY107XG4gICAgICAgICAgcm90U3BlZWQgPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucVJvdFNwZWVkMltjZl07XG4gICAgICAgICAgYiA9IHRoaXMucVJvdFNwZWVkMltjY107XG4gICAgICAgICAgcm90U3BlZWQyID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGEgPSB0aGlzLnFTY2FsZVtjZl07XG4gICAgICAgICAgYiA9IHRoaXMucVNjYWxlW2NjXTtcbiAgICAgICAgICBzY2FsZSA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBhID0gdGhpcy5xU2NhbGUyW2NmXTtcbiAgICAgICAgICBiID0gdGhpcy5xU2NhbGUyW2NjXTtcbiAgICAgICAgICBzY2FsZTIgPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucUFscGhhW2NmXTtcbiAgICAgICAgICBiID0gdGhpcy5xQWxwaGFbY2NdO1xuICAgICAgICAgIGFscGhhID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGEgPSB0aGlzLnFBbHBoYTJbY2ZdO1xuICAgICAgICAgIGIgPSB0aGlzLnFBbHBoYTJbY2NdO1xuICAgICAgICAgIGFscGhhMiA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBjZiAqPSAzO1xuICAgICAgICAgIGNjICo9IDM7XG4gICAgICAgICAgYSA9IHRoaXMucUxvY2FsVmVsb2NpdHlbY2ZdO1xuICAgICAgICAgIGIgPSB0aGlzLnFMb2NhbFZlbG9jaXR5W2NjXTtcbiAgICAgICAgICBsb2NhbFZlbG9jaXR5VmVjLmRhdGFbMF0gPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucUxvY2FsVmVsb2NpdHlbY2YgKyAxXTtcbiAgICAgICAgICBiID0gdGhpcy5xTG9jYWxWZWxvY2l0eVtjYyArIDFdO1xuICAgICAgICAgIGxvY2FsVmVsb2NpdHlWZWMuZGF0YVsxXSA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBhID0gdGhpcy5xTG9jYWxWZWxvY2l0eVtjZiArIDJdO1xuICAgICAgICAgIGIgPSB0aGlzLnFMb2NhbFZlbG9jaXR5W2NjICsgMl07XG4gICAgICAgICAgbG9jYWxWZWxvY2l0eVZlYy5kYXRhWzJdID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGEgPSB0aGlzLnFMb2NhbFZlbG9jaXR5MltjZl07XG4gICAgICAgICAgYiA9IHRoaXMucUxvY2FsVmVsb2NpdHkyW2NjXTtcbiAgICAgICAgICBsb2NhbFZlbG9jaXR5VmVjMi5kYXRhWzBdID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGEgPSB0aGlzLnFMb2NhbFZlbG9jaXR5MltjZiArIDFdO1xuICAgICAgICAgIGIgPSB0aGlzLnFMb2NhbFZlbG9jaXR5MltjYyArIDFdO1xuICAgICAgICAgIGxvY2FsVmVsb2NpdHlWZWMyLmRhdGFbMV0gPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucUxvY2FsVmVsb2NpdHkyW2NmICsgMl07XG4gICAgICAgICAgYiA9IHRoaXMucUxvY2FsVmVsb2NpdHkyW2NjICsgMl07XG4gICAgICAgICAgbG9jYWxWZWxvY2l0eVZlYzIuZGF0YVsyXSA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBhID0gdGhpcy5xVmVsb2NpdHlbY2ZdO1xuICAgICAgICAgIGIgPSB0aGlzLnFWZWxvY2l0eVtjY107XG4gICAgICAgICAgdmVsb2NpdHlWZWMuZGF0YVswXSA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBhID0gdGhpcy5xVmVsb2NpdHlbY2YgKyAxXTtcbiAgICAgICAgICBiID0gdGhpcy5xVmVsb2NpdHlbY2MgKyAxXTtcbiAgICAgICAgICB2ZWxvY2l0eVZlYy5kYXRhWzFdID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGEgPSB0aGlzLnFWZWxvY2l0eVtjZiArIDJdO1xuICAgICAgICAgIGIgPSB0aGlzLnFWZWxvY2l0eVtjYyArIDJdO1xuICAgICAgICAgIHZlbG9jaXR5VmVjLmRhdGFbMl0gPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucVZlbG9jaXR5MltjZl07XG4gICAgICAgICAgYiA9IHRoaXMucVZlbG9jaXR5MltjY107XG4gICAgICAgICAgdmVsb2NpdHlWZWMyLmRhdGFbMF0gPSBhICsgKGIgLSBhKSAqIGM7XG4gICAgICAgICAgYSA9IHRoaXMucVZlbG9jaXR5MltjZiArIDFdO1xuICAgICAgICAgIGIgPSB0aGlzLnFWZWxvY2l0eTJbY2MgKyAxXTtcbiAgICAgICAgICB2ZWxvY2l0eVZlYzIuZGF0YVsxXSA9IGEgKyAoYiAtIGEpICogYztcbiAgICAgICAgICBhID0gdGhpcy5xVmVsb2NpdHkyW2NmICsgMl07XG4gICAgICAgICAgYiA9IHRoaXMucVZlbG9jaXR5MltjYyArIDJdO1xuICAgICAgICAgIHZlbG9jaXR5VmVjMi5kYXRhWzJdID0gYSArIChiIC0gYSkgKiBjO1xuICAgICAgICAgIGxvY2FsVmVsb2NpdHlWZWMuZGF0YVswXSA9IGxvY2FsVmVsb2NpdHlWZWMuZGF0YVswXSArIChsb2NhbFZlbG9jaXR5VmVjMi5kYXRhWzBdIC0gbG9jYWxWZWxvY2l0eVZlYy5kYXRhWzBdKSAqIHJuZEZhY3RvcjNWZWMuZGF0YVswXTtcbiAgICAgICAgICBsb2NhbFZlbG9jaXR5VmVjLmRhdGFbMV0gPSBsb2NhbFZlbG9jaXR5VmVjLmRhdGFbMV0gKyAobG9jYWxWZWxvY2l0eVZlYzIuZGF0YVsxXSAtIGxvY2FsVmVsb2NpdHlWZWMuZGF0YVsxXSkgKiBybmRGYWN0b3IzVmVjLmRhdGFbMV07XG4gICAgICAgICAgbG9jYWxWZWxvY2l0eVZlYy5kYXRhWzJdID0gbG9jYWxWZWxvY2l0eVZlYy5kYXRhWzJdICsgKGxvY2FsVmVsb2NpdHlWZWMyLmRhdGFbMl0gLSBsb2NhbFZlbG9jaXR5VmVjLmRhdGFbMl0pICogcm5kRmFjdG9yM1ZlYy5kYXRhWzJdO1xuICAgICAgICAgIGlmICh0aGlzLmluaXRpYWxWZWxvY2l0eSA+IDApIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVtaXR0ZXJTaGFwZSA9PT0gcGMuRU1JVFRFUlNIQVBFX1NQSEVSRSkge1xuICAgICAgICAgICAgICByYW5kb21Qb3MuY29weShybmRGYWN0b3IzVmVjKS5zY2FsZSgyKS5zdWIocGMuVmVjMy5PTkUpLm5vcm1hbGl6ZSgpO1xuICAgICAgICAgICAgICBsb2NhbFZlbG9jaXR5VmVjLmFkZChyYW5kb21Qb3Muc2NhbGUodGhpcy5pbml0aWFsVmVsb2NpdHkpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGxvY2FsVmVsb2NpdHlWZWMuYWRkKHBjLlZlYzMuRk9SV0FSRC5zY2FsZSh0aGlzLmluaXRpYWxWZWxvY2l0eSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICB2ZWxvY2l0eVZlYy5kYXRhWzBdID0gdmVsb2NpdHlWZWMuZGF0YVswXSArICh2ZWxvY2l0eVZlYzIuZGF0YVswXSAtIHZlbG9jaXR5VmVjLmRhdGFbMF0pICogcm5kRmFjdG9yM1ZlYy5kYXRhWzBdO1xuICAgICAgICAgIHZlbG9jaXR5VmVjLmRhdGFbMV0gPSB2ZWxvY2l0eVZlYy5kYXRhWzFdICsgKHZlbG9jaXR5VmVjMi5kYXRhWzFdIC0gdmVsb2NpdHlWZWMuZGF0YVsxXSkgKiBybmRGYWN0b3IzVmVjLmRhdGFbMV07XG4gICAgICAgICAgdmVsb2NpdHlWZWMuZGF0YVsyXSA9IHZlbG9jaXR5VmVjLmRhdGFbMl0gKyAodmVsb2NpdHlWZWMyLmRhdGFbMl0gLSB2ZWxvY2l0eVZlYy5kYXRhWzJdKSAqIHJuZEZhY3RvcjNWZWMuZGF0YVsyXTtcbiAgICAgICAgICByb3RTcGVlZCA9IHJvdFNwZWVkICsgKHJvdFNwZWVkMiAtIHJvdFNwZWVkKSAqIHJuZEZhY3RvcjNWZWMuZGF0YVsxXTtcbiAgICAgICAgICBzY2FsZSA9IChzY2FsZSArIChzY2FsZTIgLSBzY2FsZSkgKiAocm5kRmFjdG9yICogMTAwMDAuMCAlIDEuMCkpICogdW5pZm9ybVNjYWxlO1xuICAgICAgICAgIGFscGhhRGl2ID0gKGFscGhhMiAtIGFscGhhKSAqIChybmRGYWN0b3IgKiAxMDAwLjAgJSAxLjApO1xuICAgICAgICAgIGlmICh0aGlzLm1lc2hJbnN0YW5jZS5ub2RlKSB7XG4gICAgICAgICAgICByb3RNYXQudHJhbnNmb3JtUG9pbnQobG9jYWxWZWxvY2l0eVZlYywgbG9jYWxWZWxvY2l0eVZlYyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvY2FsVmVsb2NpdHlWZWMuYWRkKHZlbG9jaXR5VmVjLm11bChub25Vbmlmb3JtU2NhbGUpKTtcbiAgICAgICAgICBtb3ZlRGlyVmVjLmNvcHkobG9jYWxWZWxvY2l0eVZlYyk7XG4gICAgICAgICAgcGFydGljbGVQb3NQcmV2LmRhdGFbMF0gPSB0aGlzLnBhcnRpY2xlVGV4W2lkICogcGFydGljbGVUZXhDaGFubmVsc107XG4gICAgICAgICAgcGFydGljbGVQb3NQcmV2LmRhdGFbMV0gPSB0aGlzLnBhcnRpY2xlVGV4W2lkICogcGFydGljbGVUZXhDaGFubmVscyArIDFdO1xuICAgICAgICAgIHBhcnRpY2xlUG9zUHJldi5kYXRhWzJdID0gdGhpcy5wYXJ0aWNsZVRleFtpZCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAyXTtcbiAgICAgICAgICBwYXJ0aWNsZVBvcy5jb3B5KHBhcnRpY2xlUG9zUHJldikuYWRkKGxvY2FsVmVsb2NpdHlWZWMuc2NhbGUoZGVsdGEpKTtcbiAgICAgICAgICBwYXJ0aWNsZUZpbmFsUG9zLmNvcHkocGFydGljbGVQb3MpO1xuICAgICAgICAgIHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzXSA9IHBhcnRpY2xlRmluYWxQb3MuZGF0YVswXTtcbiAgICAgICAgICB0aGlzLnBhcnRpY2xlVGV4W2lkICogcGFydGljbGVUZXhDaGFubmVscyArIDFdID0gcGFydGljbGVGaW5hbFBvcy5kYXRhWzFdO1xuICAgICAgICAgIHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMl0gPSBwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMl07XG4gICAgICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpZCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAzXSArPSByb3RTcGVlZCAqIGRlbHRhO1xuICAgICAgICAgIGlmICh0aGlzLndyYXAgJiYgdGhpcy53cmFwQm91bmRzKSB7XG4gICAgICAgICAgICBwYXJ0aWNsZUZpbmFsUG9zLnN1YihlbWl0dGVyUG9zKTtcbiAgICAgICAgICAgIHBhcnRpY2xlRmluYWxQb3MuZGF0YVswXSA9IGdsTW9kKHBhcnRpY2xlRmluYWxQb3MuZGF0YVswXSwgdGhpcy53cmFwQm91bmRzLmRhdGFbMF0pIC0gdGhpcy53cmFwQm91bmRzLmRhdGFbMF0gKiAwLjU7XG4gICAgICAgICAgICBwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMV0gPSBnbE1vZChwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMV0sIHRoaXMud3JhcEJvdW5kcy5kYXRhWzFdKSAtIHRoaXMud3JhcEJvdW5kcy5kYXRhWzFdICogMC41O1xuICAgICAgICAgICAgcGFydGljbGVGaW5hbFBvcy5kYXRhWzJdID0gZ2xNb2QocGFydGljbGVGaW5hbFBvcy5kYXRhWzJdLCB0aGlzLndyYXBCb3VuZHMuZGF0YVsyXSkgLSB0aGlzLndyYXBCb3VuZHMuZGF0YVsyXSAqIDAuNTtcbiAgICAgICAgICAgIHBhcnRpY2xlRmluYWxQb3MuYWRkKGVtaXR0ZXJQb3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodGhpcy5zb3J0ID4gMCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuc29ydCA9PT0gMSkge1xuICAgICAgICAgICAgICB0bXBWZWMzLmNvcHkocGFydGljbGVGaW5hbFBvcykuc3ViKHBvc0NhbSk7XG4gICAgICAgICAgICAgIHRoaXMucGFydGljbGVEaXN0YW5jZVtpZF0gPSAtKHRtcFZlYzMuZGF0YVswXSAqIHRtcFZlYzMuZGF0YVswXSArIHRtcFZlYzMuZGF0YVsxXSAqIHRtcFZlYzMuZGF0YVsxXSArIHRtcFZlYzMuZGF0YVsyXSAqIHRtcFZlYzMuZGF0YVsyXSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0ID09PSAyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZURpc3RhbmNlW2lkXSA9IGxpZmU7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc29ydCA9PT0gMykge1xuICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZURpc3RhbmNlW2lkXSA9IC1saWZlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNhbGNTcGF3blBvc2l0aW9uKGVtaXR0ZXJQb3MsIGlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNPblN0b3ApIHtcbiAgICAgICAgICBpZiAobGlmZSA8IDApIHtcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gLTE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChsaWZlID49IHBhcnRpY2xlTGlmZXRpbWUpIHtcbiAgICAgICAgICAgIGxpZmUgLT0gTWF0aC5tYXgocGFydGljbGVMaWZldGltZSwgKHRoaXMubnVtUGFydGljbGVzIC0gMSkgKiBwYXJ0aWNsZVJhdGUpO1xuICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZVRleFtpZCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAzICsgdGhpcy5udW1QYXJ0aWNsZXNQb3QgKiAyICogcGFydGljbGVUZXhDaGFubmVsc10gPSB0aGlzLmxvb3AgPyAxIDogLTE7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChsaWZlIDwgMCAmJiB0aGlzLmxvb3ApIHtcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdID0gMTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogMiAqIHBhcnRpY2xlVGV4Q2hhbm5lbHNdIDwgMCkge1xuICAgICAgICAgIHBhcnRpY2xlRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGFydGljbGVUZXhbaWQgKiBwYXJ0aWNsZVRleENoYW5uZWxzICsgMyArIHRoaXMubnVtUGFydGljbGVzUG90ICogcGFydGljbGVUZXhDaGFubmVsc10gPSBsaWZlO1xuICAgICAgICBmb3IgKHZhciB2ID0gMDt2IDwgdGhpcy5udW1QYXJ0aWNsZVZlcnRzO3YrKykge1xuICAgICAgICAgIHZhciBxdWFkWCA9IHRoaXMudmJDUFVbaSAqIHRoaXMubnVtUGFydGljbGVWZXJ0cyAqIDQgKyB2ICogNF07XG4gICAgICAgICAgdmFyIHF1YWRZID0gdGhpcy52YkNQVVtpICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzICogNCArIHYgKiA0ICsgMV07XG4gICAgICAgICAgdmFyIHF1YWRaID0gdGhpcy52YkNQVVtpICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzICogNCArIHYgKiA0ICsgMl07XG4gICAgICAgICAgaWYgKCFwYXJ0aWNsZUVuYWJsZWQpIHtcbiAgICAgICAgICAgIHF1YWRYID0gcXVhZFkgPSBxdWFkWiA9IDA7XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciB3ID0gaSAqIHRoaXMubnVtUGFydGljbGVWZXJ0cyAqIHZlcnRTaXplICsgdiAqIHZlcnRTaXplO1xuICAgICAgICAgIGRhdGFbd10gPSBwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMF07XG4gICAgICAgICAgZGF0YVt3ICsgMV0gPSBwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMV07XG4gICAgICAgICAgZGF0YVt3ICsgMl0gPSBwYXJ0aWNsZUZpbmFsUG9zLmRhdGFbMl07XG4gICAgICAgICAgZGF0YVt3ICsgM10gPSBubGlmZTtcbiAgICAgICAgICBkYXRhW3cgKyA0XSA9IHRoaXMuYWxpZ25Ub01vdGlvbiA/IGFuZ2xlIDogdGhpcy5wYXJ0aWNsZVRleFtpZCAqIHBhcnRpY2xlVGV4Q2hhbm5lbHMgKyAzXTtcbiAgICAgICAgICBkYXRhW3cgKyA1XSA9IHNjYWxlO1xuICAgICAgICAgIGRhdGFbdyArIDZdID0gYWxwaGFEaXY7XG4gICAgICAgICAgZGF0YVt3ICsgN10gPSBtb3ZlRGlyVmVjLmRhdGFbMF07XG4gICAgICAgICAgZGF0YVt3ICsgOF0gPSBxdWFkWDtcbiAgICAgICAgICBkYXRhW3cgKyA5XSA9IHF1YWRZO1xuICAgICAgICAgIGRhdGFbdyArIDEwXSA9IHF1YWRaO1xuICAgICAgICAgIGRhdGFbdyArIDExXSA9IG1vdmVEaXJWZWMuZGF0YVsxXTtcbiAgICAgICAgICBkYXRhW3cgKyAxMl0gPSBtb3ZlRGlyVmVjLmRhdGFbMl07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnNvcnQgPiBwYy5QQVJUSUNMRVNPUlRfTk9ORSAmJiB0aGlzLmNhbWVyYSkge1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLm51bVBhcnRpY2xlcztpKyspIHtcbiAgICAgICAgICB0aGlzLnZiVG9Tb3J0W2ldID0gW2ksIE1hdGguZmxvb3IodGhpcy52YkNQVVtpICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzICogNCArIDNdKV07XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy52YkNQVS5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgdGhpcy52Yk9sZFtpXSA9IHRoaXMudmJDUFVbaV07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHBhcnRpY2xlRGlzdGFuY2UgPSB0aGlzLnBhcnRpY2xlRGlzdGFuY2U7XG4gICAgICAgIHRoaXMudmJUb1NvcnQuc29ydChmdW5jdGlvbihhLCBiKSB7XG4gICAgICAgICAgcmV0dXJuIHBhcnRpY2xlRGlzdGFuY2VbYVsxXV0gLSBwYXJ0aWNsZURpc3RhbmNlW2JbMV1dO1xuICAgICAgICB9KTtcbiAgICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy5udW1QYXJ0aWNsZXM7aSsrKSB7XG4gICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy52YlRvU29ydFtpXVswXTtcbiAgICAgICAgICBmb3IgKHZhciBjb3JuZXIgPSAwO2Nvcm5lciA8IHRoaXMubnVtUGFydGljbGVWZXJ0cztjb3JuZXIrKykge1xuICAgICAgICAgICAgZm9yIChqID0gMDtqIDwgNDtqKyspIHtcbiAgICAgICAgICAgICAgdGhpcy52YkNQVVtpICogdGhpcy5udW1QYXJ0aWNsZVZlcnRzICogNCArIGNvcm5lciAqIDQgKyBqXSA9IHRoaXMudmJPbGRbc3RhcnQgKiB0aGlzLm51bVBhcnRpY2xlVmVydHMgKiA0ICsgY29ybmVyICogNCArIGpdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMubG9vcCkge1xuICAgICAgaWYgKERhdGUubm93KCkgPiB0aGlzLmVuZFRpbWUpIHtcbiAgICAgICAgaWYgKHRoaXMub25GaW5pc2hlZCkge1xuICAgICAgICAgIHRoaXMub25GaW5pc2hlZCgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubWVzaEluc3RhbmNlLnZpc2libGUgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGRlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMucGFydGljbGVUZXhJTikge1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleElOLmRlc3Ryb3koKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucGFydGljbGVUZXhPVVQpIHtcbiAgICAgIHRoaXMucGFydGljbGVUZXhPVVQuZGVzdHJveSgpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudXNlQ3B1ICYmIHRoaXMucGFydGljbGVUZXhTdGFydCkge1xuICAgICAgdGhpcy5wYXJ0aWNsZVRleFN0YXJ0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucnRQYXJ0aWNsZVRleElOKSB7XG4gICAgICB0aGlzLnJ0UGFydGljbGVUZXhJTi5kZXN0cm95KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnJ0UGFydGljbGVUZXhPVVQpIHtcbiAgICAgIHRoaXMucnRQYXJ0aWNsZVRleE9VVC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMucGFydGljbGVUZXhJTiA9IG51bGw7XG4gICAgdGhpcy5wYXJ0aWNsZVRleE9VVCA9IG51bGw7XG4gICAgdGhpcy5wYXJ0aWNsZVRleFN0YXJ0ID0gbnVsbDtcbiAgICB0aGlzLnJ0UGFydGljbGVUZXhJTiA9IG51bGw7XG4gICAgdGhpcy5ydFBhcnRpY2xlVGV4T1VUID0gbnVsbDtcbiAgICB0aGlzLnNoYWRlclBhcnRpY2xlVXBkYXRlUmVzcGF3biA9IG51bGw7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU5vUmVzcGF3biA9IG51bGw7XG4gICAgdGhpcy5zaGFkZXJQYXJ0aWNsZVVwZGF0ZU9uU3RvcCA9IG51bGw7XG4gIH19O1xuICByZXR1cm4ge1BhcnRpY2xlRW1pdHRlcjpQYXJ0aWNsZUVtaXR0ZXJ9O1xufSgpKTtcbmZ1bmN0aW9uIGZyYWMoZikge1xuICByZXR1cm4gZiAtIE1hdGguZmxvb3IoZik7XG59XG5mdW5jdGlvbiBlbmNvZGVGbG9hdFJHQkEodikge1xuICB2YXIgZW5jWCA9IGZyYWModik7XG4gIHZhciBlbmNZID0gZnJhYygyNTUuMCAqIHYpO1xuICB2YXIgZW5jWiA9IGZyYWMoNjUwMjUuMCAqIHYpO1xuICB2YXIgZW5jVyA9IGZyYWMoMTYwNTgxMzc1LjAgKiB2KTtcbiAgZW5jWCAtPSBlbmNZIC8gMjU1LjA7XG4gIGVuY1kgLT0gZW5jWiAvIDI1NS4wO1xuICBlbmNaIC09IGVuY1cgLyAyNTUuMDtcbiAgZW5jVyAtPSBlbmNXIC8gMjU1LjA7XG4gIHJldHVybiBbZW5jWCwgZW5jWSwgZW5jWiwgZW5jV107XG59XG5mdW5jdGlvbiBlbmNvZGVGbG9hdFJHKHYpIHtcbiAgdmFyIGVuY1ggPSBmcmFjKHYpO1xuICB2YXIgZW5jWSA9IGZyYWMoMjU1LjAgKiB2KTtcbiAgZW5jWCAtPSBlbmNZIC8gMjU1LjA7XG4gIGVuY1kgLT0gZW5jWSAvIDI1NS4wO1xuICByZXR1cm4gW2VuY1gsIGVuY1ldO1xufVxuO3BjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIHNvcnREcmF3Q2FsbHMoZHJhd0NhbGxBLCBkcmF3Q2FsbEIpIHtcbiAgICBpZiAoZHJhd0NhbGxBLmxheWVyID09PSBkcmF3Q2FsbEIubGF5ZXIpIHtcbiAgICAgIGlmIChkcmF3Q2FsbEEuZHJhd09yZGVyICYmIGRyYXdDYWxsQi5kcmF3T3JkZXIpIHtcbiAgICAgICAgcmV0dXJuIGRyYXdDYWxsQS5kcmF3T3JkZXIgLSBkcmF3Q2FsbEIuZHJhd09yZGVyO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZHJhd0NhbGxCLmtleSAtIGRyYXdDYWxsQS5rZXk7XG4gIH1cbiAgdmFyIFBpY2tlciA9IGZ1bmN0aW9uKGRldmljZSwgd2lkdGgsIGhlaWdodCkge1xuICAgIHRoaXMuZGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMubGlicmFyeSA9IGRldmljZS5nZXRQcm9ncmFtTGlicmFyeSgpO1xuICAgIHRoaXMucGlja0NvbG9yID0gbmV3IEZsb2F0MzJBcnJheSg0KTtcbiAgICB0aGlzLnNjZW5lID0gbnVsbDtcbiAgICB0aGlzLmRyYXdDYWxscyA9IFtdO1xuICAgIHRoaXMuY2xlYXJPcHRpb25zID0ge2NvbG9yOlsxLCAxLCAxLCAxXSwgZGVwdGg6MSwgZmxhZ3M6cGMuQ0xFQVJGTEFHX0NPTE9SIHwgcGMuQ0xFQVJGTEFHX0RFUFRIfTtcbiAgICB0aGlzLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgICB0aGlzLl9pZ25vcmVPcGFjaXR5Rm9yID0gbnVsbDtcbiAgfTtcbiAgUGlja2VyLnByb3RvdHlwZS5nZXRTZWxlY3Rpb24gPSBmdW5jdGlvbih4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7XG4gICAgdmFyIGRldmljZSA9IHRoaXMuZGV2aWNlO1xuICAgIGlmICh0eXBlb2YgeCA9PT0gXCJvYmplY3RcIikge1xuICAgICAgdmFyIHJlY3QgPSB4O1xuICAgICAgeCA9IHJlY3QueDtcbiAgICAgIHkgPSByZWN0Lnk7XG4gICAgICB3aWR0aCA9IHJlY3Qud2lkdGg7XG4gICAgICBoZWlnaHQgPSByZWN0LmhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgeSA9IHRoaXMuX3BpY2tCdWZmZXJUYXJnZXQuaGVpZ2h0IC0gKHkgKyAoaGVpZ2h0IHx8IDEpKTtcbiAgICB9XG4gICAgd2lkdGggPSB3aWR0aCB8fCAxO1xuICAgIGhlaWdodCA9IGhlaWdodCB8fCAxO1xuICAgIHZhciBwcmV2UmVuZGVyVGFyZ2V0ID0gZGV2aWNlLnJlbmRlclRhcmdldDtcbiAgICBkZXZpY2Uuc2V0UmVuZGVyVGFyZ2V0KHRoaXMuX3BpY2tCdWZmZXJUYXJnZXQpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICAgIHZhciBwaXhlbHMgPSBuZXcgVWludDhBcnJheSg0ICogd2lkdGggKiBoZWlnaHQpO1xuICAgIGRldmljZS5yZWFkUGl4ZWxzKHgsIHksIHdpZHRoLCBoZWlnaHQsIHBpeGVscyk7XG4gICAgZGV2aWNlLnVwZGF0ZUVuZCgpO1xuICAgIGRldmljZS5zZXRSZW5kZXJUYXJnZXQocHJldlJlbmRlclRhcmdldCk7XG4gICAgdmFyIHNlbGVjdGlvbiA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB3aWR0aCAqIGhlaWdodDtpKyspIHtcbiAgICAgIHZhciByID0gcGl4ZWxzWzQgKiBpICsgMF07XG4gICAgICB2YXIgZyA9IHBpeGVsc1s0ICogaSArIDFdO1xuICAgICAgdmFyIGIgPSBwaXhlbHNbNCAqIGkgKyAyXTtcbiAgICAgIHZhciBpbmRleCA9IHIgPDwgMTYgfCBnIDw8IDggfCBiO1xuICAgICAgaWYgKGluZGV4ICE9PSAxNjc3NzIxNSkge1xuICAgICAgICB2YXIgc2VsZWN0ZWRNZXNoSW5zdGFuY2UgPSB0aGlzLmRyYXdDYWxsc1tpbmRleF07XG4gICAgICAgIGlmIChzZWxlY3Rpb24uaW5kZXhPZihzZWxlY3RlZE1lc2hJbnN0YW5jZSkgPT09IC0xKSB7XG4gICAgICAgICAgc2VsZWN0aW9uLnB1c2goc2VsZWN0ZWRNZXNoSW5zdGFuY2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzZWxlY3Rpb247XG4gIH07XG4gIFBpY2tlci5wcm90b3R5cGUucHJlcGFyZSA9IGZ1bmN0aW9uKGNhbWVyYSwgc2NlbmUpIHtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5kZXZpY2U7XG4gICAgdGhpcy5zY2VuZSA9IHNjZW5lO1xuICAgIHZhciBwcmV2UmVuZGVyVGFyZ2V0ID0gZGV2aWNlLnJlbmRlclRhcmdldDtcbiAgICBkZXZpY2Uuc2V0UmVuZGVyVGFyZ2V0KHRoaXMuX3BpY2tCdWZmZXJUYXJnZXQpO1xuICAgIGRldmljZS51cGRhdGVCZWdpbigpO1xuICAgIGRldmljZS5zZXRWaWV3cG9ydCgwLCAwLCB0aGlzLl9waWNrQnVmZmVyVGFyZ2V0LndpZHRoLCB0aGlzLl9waWNrQnVmZmVyVGFyZ2V0LmhlaWdodCk7XG4gICAgZGV2aWNlLnNldFNjaXNzb3IoMCwgMCwgdGhpcy5fcGlja0J1ZmZlclRhcmdldC53aWR0aCwgdGhpcy5fcGlja0J1ZmZlclRhcmdldC5oZWlnaHQpO1xuICAgIGRldmljZS5jbGVhcih0aGlzLmNsZWFyT3B0aW9ucyk7XG4gICAgdmFyIGk7XG4gICAgdmFyIG1lc2gsIG1lc2hJbnN0YW5jZSwgbWF0ZXJpYWw7XG4gICAgdmFyIHR5cGU7XG4gICAgdmFyIHNoYWRlciwgaXNMYXN0U2VsZWN0ZWQ7XG4gICAgdmFyIHNjb3BlID0gZGV2aWNlLnNjb3BlO1xuICAgIHZhciBtb2RlbE1hdHJpeElkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF9tb2RlbFwiKTtcbiAgICB2YXIgYm9uZVRleHR1cmVJZCA9IHNjb3BlLnJlc29sdmUoXCJ0ZXh0dXJlX3Bvc2VNYXBcIik7XG4gICAgdmFyIGJvbmVUZXh0dXJlU2l6ZUlkID0gc2NvcGUucmVzb2x2ZShcInRleHR1cmVfcG9zZU1hcFNpemVcIik7XG4gICAgdmFyIHNraW5Qb3NPZmZzZXRJZCA9IHNjb3BlLnJlc29sdmUoXCJza2luUG9zT2Zmc2V0XCIpO1xuICAgIHZhciBwb3NlTWF0cml4SWQgPSBzY29wZS5yZXNvbHZlKFwibWF0cml4X3Bvc2VbMF1cIik7XG4gICAgdmFyIHBpY2tDb2xvcklkID0gc2NvcGUucmVzb2x2ZShcInVDb2xvclwiKTtcbiAgICB2YXIgcHJvaklkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF9wcm9qZWN0aW9uXCIpO1xuICAgIHZhciB2aWV3UHJvaklkID0gc2NvcGUucmVzb2x2ZShcIm1hdHJpeF92aWV3UHJvamVjdGlvblwiKTtcbiAgICB2YXIgb3BhY2l0eU1hcElkID0gc2NvcGUucmVzb2x2ZShcInRleHR1cmVfb3BhY2l0eU1hcFwiKTtcbiAgICB2YXIgYWxwaGFUZXN0SWQgPSBzY29wZS5yZXNvbHZlKFwiYWxwaGFfcmVmXCIpO1xuICAgIHZhciB3dG0gPSBjYW1lcmEuX25vZGUuZ2V0V29ybGRUcmFuc2Zvcm0oKTtcbiAgICB2YXIgcHJvak1hdCA9IGNhbWVyYS5nZXRQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgdmFyIHZpZXdNYXQgPSB3dG0uY2xvbmUoKS5pbnZlcnQoKTtcbiAgICB2YXIgdmlld1Byb2pNYXQgPSBuZXcgcGMuTWF0NDtcbiAgICB2aWV3UHJvak1hdC5tdWwyKHByb2pNYXQsIHZpZXdNYXQpO1xuICAgIHByb2pJZC5zZXRWYWx1ZShwcm9qTWF0LmRhdGEpO1xuICAgIHZpZXdQcm9qSWQuc2V0VmFsdWUodmlld1Byb2pNYXQuZGF0YSk7XG4gICAgdGhpcy5kcmF3Q2FsbHMgPSBzY2VuZS5kcmF3Q2FsbHMuc2xpY2UoMCk7XG4gICAgdGhpcy5kcmF3Q2FsbHMuc29ydChzb3J0RHJhd0NhbGxzKTtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLmRyYXdDYWxscy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAodGhpcy5kcmF3Q2FsbHNbaV0uY29tbWFuZCkge1xuICAgICAgICB0aGlzLmRyYXdDYWxsc1tpXS5jb21tYW5kKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXRoaXMuZHJhd0NhbGxzW2ldLnBpY2spIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBtZXNoSW5zdGFuY2UgPSB0aGlzLmRyYXdDYWxsc1tpXTtcbiAgICAgICAgbWVzaCA9IG1lc2hJbnN0YW5jZS5tZXNoO1xuICAgICAgICBtYXRlcmlhbCA9IG1lc2hJbnN0YW5jZS5tYXRlcmlhbDtcbiAgICAgICAgdHlwZSA9IG1lc2gucHJpbWl0aXZlW3BjLlJFTkRFUlNUWUxFX1NPTElEXS50eXBlO1xuICAgICAgICB2YXIgaXNTb2xpZCA9IHR5cGUgPT09IHBjLlBSSU1JVElWRV9UUklBTkdMRVMgfHwgdHlwZSA9PT0gcGMuUFJJTUlUSVZFX1RSSVNUUklQIHx8IHR5cGUgPT09IHBjLlBSSU1JVElWRV9UUklGQU47XG4gICAgICAgIHZhciBpc1BpY2thYmxlID0gbWF0ZXJpYWwgaW5zdGFuY2VvZiBwYy5TdGFuZGFyZE1hdGVyaWFsIHx8IG1hdGVyaWFsIGluc3RhbmNlb2YgcGMuQmFzaWNNYXRlcmlhbDtcbiAgICAgICAgaWYgKGlzU29saWQgJiYgaXNQaWNrYWJsZSkge1xuICAgICAgICAgIGRldmljZS5zZXRCbGVuZGluZyhmYWxzZSk7XG4gICAgICAgICAgZGV2aWNlLnNldEN1bGxNb2RlKG1hdGVyaWFsLmN1bGwpO1xuICAgICAgICAgIGRldmljZS5zZXREZXB0aFdyaXRlKG1hdGVyaWFsLmRlcHRoV3JpdGUpO1xuICAgICAgICAgIGRldmljZS5zZXREZXB0aFRlc3QobWF0ZXJpYWwuZGVwdGhUZXN0KTtcbiAgICAgICAgICBtb2RlbE1hdHJpeElkLnNldFZhbHVlKG1lc2hJbnN0YW5jZS5ub2RlLndvcmxkVHJhbnNmb3JtLmRhdGEpO1xuICAgICAgICAgIGlmIChtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlKSB7XG4gICAgICAgICAgICBza2luUG9zT2Zmc2V0SWQuc2V0VmFsdWUobWVzaEluc3RhbmNlLm5vZGUuZ2V0UG9zaXRpb24oKS5kYXRhKTtcbiAgICAgICAgICAgIGlmIChkZXZpY2Uuc3VwcG9ydHNCb25lVGV4dHVyZXMpIHtcbiAgICAgICAgICAgICAgYm9uZVRleHR1cmVJZC5zZXRWYWx1ZShtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlLmJvbmVUZXh0dXJlKTtcbiAgICAgICAgICAgICAgdmFyIHcgPSBtZXNoSW5zdGFuY2Uuc2tpbkluc3RhbmNlLmJvbmVUZXh0dXJlLndpZHRoO1xuICAgICAgICAgICAgICB2YXIgaCA9IG1lc2hJbnN0YW5jZS5za2luSW5zdGFuY2UuYm9uZVRleHR1cmUuaGVpZ2h0O1xuICAgICAgICAgICAgICBib25lVGV4dHVyZVNpemVJZC5zZXRWYWx1ZShbdywgaF0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcG9zZU1hdHJpeElkLnNldFZhbHVlKG1lc2hJbnN0YW5jZS5za2luSW5zdGFuY2UubWF0cml4UGFsZXR0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChtYXRlcmlhbC5vcGFjaXR5TWFwKSB7XG4gICAgICAgICAgICBvcGFjaXR5TWFwSWQuc2V0VmFsdWUobWF0ZXJpYWwub3BhY2l0eU1hcCk7XG4gICAgICAgICAgICBhbHBoYVRlc3RJZC5zZXRWYWx1ZShtZXNoSW5zdGFuY2UgPT09IHRoaXMuX2lnbm9yZU9wYWNpdHlGb3IgPyAwIDogbWF0ZXJpYWwuYWxwaGFUZXN0KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5waWNrQ29sb3JbMF0gPSAoaSA+PiAxNiAmIDI1NSkgLyAyNTU7XG4gICAgICAgICAgdGhpcy5waWNrQ29sb3JbMV0gPSAoaSA+PiA4ICYgMjU1KSAvIDI1NTtcbiAgICAgICAgICB0aGlzLnBpY2tDb2xvclsyXSA9IChpICYgMjU1KSAvIDI1NTtcbiAgICAgICAgICB0aGlzLnBpY2tDb2xvclszXSA9IDE7XG4gICAgICAgICAgcGlja0NvbG9ySWQuc2V0VmFsdWUodGhpcy5waWNrQ29sb3IpO1xuICAgICAgICAgIHNoYWRlciA9IG1lc2hJbnN0YW5jZS5fc2hhZGVyW3BjLlNIQURFUl9QSUNLXTtcbiAgICAgICAgICBpZiAoIXNoYWRlcikge1xuICAgICAgICAgICAgc2hhZGVyID0gdGhpcy5saWJyYXJ5LmdldFByb2dyYW0oXCJwaWNrXCIsIHtza2luOiEhbWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSwgc2NyZWVuU3BhY2U6bWVzaEluc3RhbmNlLnNjcmVlblNwYWNlLCBvcGFjaXR5TWFwOiEhbWF0ZXJpYWwub3BhY2l0eU1hcCwgb3BhY2l0eUNoYW5uZWw6bWF0ZXJpYWwub3BhY2l0eU1hcCA/IG1hdGVyaWFsLm9wYWNpdHlNYXBDaGFubmVsIHx8IFwiclwiIDogbnVsbH0pO1xuICAgICAgICAgICAgbWVzaEluc3RhbmNlLl9zaGFkZXJbcGMuU0hBREVSX1BJQ0tdID0gc2hhZGVyO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkZXZpY2Uuc2V0U2hhZGVyKHNoYWRlcik7XG4gICAgICAgICAgZGV2aWNlLnNldFZlcnRleEJ1ZmZlcihtZXNoSW5zdGFuY2UubW9ycGhJbnN0YW5jZSAmJiBtZXNoSW5zdGFuY2UubW9ycGhJbnN0YW5jZS5fdmVydGV4QnVmZmVyID8gbWVzaEluc3RhbmNlLm1vcnBoSW5zdGFuY2UuX3ZlcnRleEJ1ZmZlciA6IG1lc2gudmVydGV4QnVmZmVyLCAwKTtcbiAgICAgICAgICBkZXZpY2Uuc2V0SW5kZXhCdWZmZXIobWVzaC5pbmRleEJ1ZmZlcltwYy5SRU5ERVJTVFlMRV9TT0xJRF0pO1xuICAgICAgICAgIGRldmljZS5kcmF3KG1lc2gucHJpbWl0aXZlW3BjLlJFTkRFUlNUWUxFX1NPTElEXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZGV2aWNlLnNldFZpZXdwb3J0KDAsIDAsIGRldmljZS53aWR0aCwgZGV2aWNlLmhlaWdodCk7XG4gICAgZGV2aWNlLnNldFNjaXNzb3IoMCwgMCwgZGV2aWNlLndpZHRoLCBkZXZpY2UuaGVpZ2h0KTtcbiAgICBkZXZpY2UudXBkYXRlRW5kKCk7XG4gICAgZGV2aWNlLnNldFJlbmRlclRhcmdldChwcmV2UmVuZGVyVGFyZ2V0KTtcbiAgfTtcbiAgUGlja2VyLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7XG4gICAgdmFyIGNvbG9yQnVmZmVyID0gbmV3IHBjLlRleHR1cmUodGhpcy5kZXZpY2UsIHtmb3JtYXQ6cGMuUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgsIHdpZHRoOndpZHRoLCBoZWlnaHQ6aGVpZ2h0LCBtaXBtYXBzOmZhbHNlLCBtaW5GaWx0ZXI6cGMuRklMVEVSX05FQVJFU1QsIG1hZ0ZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVH0pO1xuICAgIHRoaXMuX3BpY2tCdWZmZXJUYXJnZXQgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KHRoaXMuZGV2aWNlLCBjb2xvckJ1ZmZlciwge2RlcHRoOnRydWV9KTtcbiAgfTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFBpY2tlci5wcm90b3R5cGUsIFwicmVuZGVyVGFyZ2V0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3BpY2tCdWZmZXJUYXJnZXQ7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFBpY2tlci5wcm90b3R5cGUsIFwid2lkdGhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fcGlja0J1ZmZlclRhcmdldC53aWR0aDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUGlja2VyLnByb3RvdHlwZSwgXCJoZWlnaHRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fcGlja0J1ZmZlclRhcmdldC5oZWlnaHQ7XG4gIH19KTtcbiAgcmV0dXJuIHtQaWNrZXI6UGlja2VyfTtcbn0oKSk7XG52YXIgcHJpbWl0aXZlVXYxUGFkZGluZyA9IDQuMCAvIDY0O1xudmFyIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSA9IDEuMCAtIHByaW1pdGl2ZVV2MVBhZGRpbmcgKiAyO1xucGMuY2FsY3VsYXRlTm9ybWFscyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgaW5kaWNlcykge1xuICB2YXIgdHJpYW5nbGVDb3VudCA9IGluZGljZXMubGVuZ3RoIC8gMztcbiAgdmFyIHZlcnRleENvdW50ID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7XG4gIHZhciBpMSwgaTIsIGkzO1xuICB2YXIgaTtcbiAgdmFyIHAxID0gbmV3IHBjLlZlYzM7XG4gIHZhciBwMiA9IG5ldyBwYy5WZWMzO1xuICB2YXIgcDMgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHAxcDIgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHAxcDMgPSBuZXcgcGMuVmVjMztcbiAgdmFyIGZhY2VOb3JtYWwgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHZlcnRleE5vcm1hbCA9IG5ldyBwYy5WZWMzO1xuICB2YXIgbm9ybWFscyA9IFtdO1xuICBmb3IgKGkgPSAwO2kgPCBwb3NpdGlvbnMubGVuZ3RoO2krKykge1xuICAgIG5vcm1hbHNbaV0gPSAwO1xuICB9XG4gIGZvciAoaSA9IDA7aSA8IHRyaWFuZ2xlQ291bnQ7aSsrKSB7XG4gICAgaTEgPSBpbmRpY2VzW2kgKiAzXTtcbiAgICBpMiA9IGluZGljZXNbaSAqIDMgKyAxXTtcbiAgICBpMyA9IGluZGljZXNbaSAqIDMgKyAyXTtcbiAgICBwMS5zZXQocG9zaXRpb25zW2kxICogM10sIHBvc2l0aW9uc1tpMSAqIDMgKyAxXSwgcG9zaXRpb25zW2kxICogMyArIDJdKTtcbiAgICBwMi5zZXQocG9zaXRpb25zW2kyICogM10sIHBvc2l0aW9uc1tpMiAqIDMgKyAxXSwgcG9zaXRpb25zW2kyICogMyArIDJdKTtcbiAgICBwMy5zZXQocG9zaXRpb25zW2kzICogM10sIHBvc2l0aW9uc1tpMyAqIDMgKyAxXSwgcG9zaXRpb25zW2kzICogMyArIDJdKTtcbiAgICBwMXAyLnN1YjIocDIsIHAxKTtcbiAgICBwMXAzLnN1YjIocDMsIHAxKTtcbiAgICBmYWNlTm9ybWFsLmNyb3NzKHAxcDIsIHAxcDMpLm5vcm1hbGl6ZSgpO1xuICAgIG5vcm1hbHNbaTEgKiAzXSArPSBmYWNlTm9ybWFsLng7XG4gICAgbm9ybWFsc1tpMSAqIDMgKyAxXSArPSBmYWNlTm9ybWFsLnk7XG4gICAgbm9ybWFsc1tpMSAqIDMgKyAyXSArPSBmYWNlTm9ybWFsLno7XG4gICAgbm9ybWFsc1tpMiAqIDNdICs9IGZhY2VOb3JtYWwueDtcbiAgICBub3JtYWxzW2kyICogMyArIDFdICs9IGZhY2VOb3JtYWwueTtcbiAgICBub3JtYWxzW2kyICogMyArIDJdICs9IGZhY2VOb3JtYWwuejtcbiAgICBub3JtYWxzW2kzICogM10gKz0gZmFjZU5vcm1hbC54O1xuICAgIG5vcm1hbHNbaTMgKiAzICsgMV0gKz0gZmFjZU5vcm1hbC55O1xuICAgIG5vcm1hbHNbaTMgKiAzICsgMl0gKz0gZmFjZU5vcm1hbC56O1xuICB9XG4gIGZvciAoaSA9IDA7aSA8IHZlcnRleENvdW50O2krKykge1xuICAgIHZhciBueCA9IG5vcm1hbHNbaSAqIDNdO1xuICAgIHZhciBueSA9IG5vcm1hbHNbaSAqIDMgKyAxXTtcbiAgICB2YXIgbnogPSBub3JtYWxzW2kgKiAzICsgMl07XG4gICAgdmFyIGludkxlbiA9IDEgLyBNYXRoLnNxcnQobnggKiBueCArIG55ICogbnkgKyBueiAqIG56KTtcbiAgICBub3JtYWxzW2kgKiAzXSAqPSBpbnZMZW47XG4gICAgbm9ybWFsc1tpICogMyArIDFdICo9IGludkxlbjtcbiAgICBub3JtYWxzW2kgKiAzICsgMl0gKj0gaW52TGVuO1xuICB9XG4gIHJldHVybiBub3JtYWxzO1xufTtcbnBjLmNhbGN1bGF0ZVRhbmdlbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCBub3JtYWxzLCB1dnMsIGluZGljZXMpIHtcbiAgdmFyIHRyaWFuZ2xlQ291bnQgPSBpbmRpY2VzLmxlbmd0aCAvIDM7XG4gIHZhciB2ZXJ0ZXhDb3VudCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzO1xuICB2YXIgaTEsIGkyLCBpMztcbiAgdmFyIHgxLCB4MiwgeTEsIHkyLCB6MSwgejIsIHMxLCBzMiwgdDEsIHQyLCByO1xuICB2YXIgc2RpciA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdGRpciA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdjEgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHYyID0gbmV3IHBjLlZlYzM7XG4gIHZhciB2MyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdzEgPSBuZXcgcGMuVmVjMjtcbiAgdmFyIHcyID0gbmV3IHBjLlZlYzI7XG4gIHZhciB3MyA9IG5ldyBwYy5WZWMyO1xuICB2YXIgaTtcbiAgdmFyIHRhbjEgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMyk7XG4gIHZhciB0YW4yID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpO1xuICB2YXIgdGFuZ2VudHMgPSBbXTtcbiAgdmFyIGFyZWEgPSAwLjA7XG4gIGZvciAoaSA9IDA7aSA8IHRyaWFuZ2xlQ291bnQ7aSsrKSB7XG4gICAgaTEgPSBpbmRpY2VzW2kgKiAzXTtcbiAgICBpMiA9IGluZGljZXNbaSAqIDMgKyAxXTtcbiAgICBpMyA9IGluZGljZXNbaSAqIDMgKyAyXTtcbiAgICB2MS5zZXQocG9zaXRpb25zW2kxICogM10sIHBvc2l0aW9uc1tpMSAqIDMgKyAxXSwgcG9zaXRpb25zW2kxICogMyArIDJdKTtcbiAgICB2Mi5zZXQocG9zaXRpb25zW2kyICogM10sIHBvc2l0aW9uc1tpMiAqIDMgKyAxXSwgcG9zaXRpb25zW2kyICogMyArIDJdKTtcbiAgICB2My5zZXQocG9zaXRpb25zW2kzICogM10sIHBvc2l0aW9uc1tpMyAqIDMgKyAxXSwgcG9zaXRpb25zW2kzICogMyArIDJdKTtcbiAgICB3MS5zZXQodXZzW2kxICogMl0sIHV2c1tpMSAqIDIgKyAxXSk7XG4gICAgdzIuc2V0KHV2c1tpMiAqIDJdLCB1dnNbaTIgKiAyICsgMV0pO1xuICAgIHczLnNldCh1dnNbaTMgKiAyXSwgdXZzW2kzICogMiArIDFdKTtcbiAgICB4MSA9IHYyLnggLSB2MS54O1xuICAgIHgyID0gdjMueCAtIHYxLng7XG4gICAgeTEgPSB2Mi55IC0gdjEueTtcbiAgICB5MiA9IHYzLnkgLSB2MS55O1xuICAgIHoxID0gdjIueiAtIHYxLno7XG4gICAgejIgPSB2My56IC0gdjEuejtcbiAgICBzMSA9IHcyLnggLSB3MS54O1xuICAgIHMyID0gdzMueCAtIHcxLng7XG4gICAgdDEgPSB3Mi55IC0gdzEueTtcbiAgICB0MiA9IHczLnkgLSB3MS55O1xuICAgIGFyZWEgPSBzMSAqIHQyIC0gczIgKiB0MTtcbiAgICBpZiAoYXJlYSA9PSAwLjApIHtcbiAgICAgIHNkaXIuc2V0KDAuMCwgMS4wLCAwLjApO1xuICAgICAgdGRpci5zZXQoMS4wLCAwLjAsIDAuMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHIgPSAxLjAgLyBhcmVhO1xuICAgICAgc2Rpci5zZXQoKHQyICogeDEgLSB0MSAqIHgyKSAqIHIsICh0MiAqIHkxIC0gdDEgKiB5MikgKiByLCAodDIgKiB6MSAtIHQxICogejIpICogcik7XG4gICAgICB0ZGlyLnNldCgoczEgKiB4MiAtIHMyICogeDEpICogciwgKHMxICogeTIgLSBzMiAqIHkxKSAqIHIsIChzMSAqIHoyIC0gczIgKiB6MSkgKiByKTtcbiAgICB9XG4gICAgdGFuMVtpMSAqIDMgKyAwXSArPSBzZGlyLng7XG4gICAgdGFuMVtpMSAqIDMgKyAxXSArPSBzZGlyLnk7XG4gICAgdGFuMVtpMSAqIDMgKyAyXSArPSBzZGlyLno7XG4gICAgdGFuMVtpMiAqIDMgKyAwXSArPSBzZGlyLng7XG4gICAgdGFuMVtpMiAqIDMgKyAxXSArPSBzZGlyLnk7XG4gICAgdGFuMVtpMiAqIDMgKyAyXSArPSBzZGlyLno7XG4gICAgdGFuMVtpMyAqIDMgKyAwXSArPSBzZGlyLng7XG4gICAgdGFuMVtpMyAqIDMgKyAxXSArPSBzZGlyLnk7XG4gICAgdGFuMVtpMyAqIDMgKyAyXSArPSBzZGlyLno7XG4gICAgdGFuMltpMSAqIDMgKyAwXSArPSB0ZGlyLng7XG4gICAgdGFuMltpMSAqIDMgKyAxXSArPSB0ZGlyLnk7XG4gICAgdGFuMltpMSAqIDMgKyAyXSArPSB0ZGlyLno7XG4gICAgdGFuMltpMiAqIDMgKyAwXSArPSB0ZGlyLng7XG4gICAgdGFuMltpMiAqIDMgKyAxXSArPSB0ZGlyLnk7XG4gICAgdGFuMltpMiAqIDMgKyAyXSArPSB0ZGlyLno7XG4gICAgdGFuMltpMyAqIDMgKyAwXSArPSB0ZGlyLng7XG4gICAgdGFuMltpMyAqIDMgKyAxXSArPSB0ZGlyLnk7XG4gICAgdGFuMltpMyAqIDMgKyAyXSArPSB0ZGlyLno7XG4gIH1cbiAgdDEgPSBuZXcgcGMuVmVjMztcbiAgdDIgPSBuZXcgcGMuVmVjMztcbiAgdmFyIG4gPSBuZXcgcGMuVmVjMztcbiAgdmFyIHRlbXAgPSBuZXcgcGMuVmVjMztcbiAgZm9yIChpID0gMDtpIDwgdmVydGV4Q291bnQ7aSsrKSB7XG4gICAgbi5zZXQobm9ybWFsc1tpICogM10sIG5vcm1hbHNbaSAqIDMgKyAxXSwgbm9ybWFsc1tpICogMyArIDJdKTtcbiAgICB0MS5zZXQodGFuMVtpICogM10sIHRhbjFbaSAqIDMgKyAxXSwgdGFuMVtpICogMyArIDJdKTtcbiAgICB0Mi5zZXQodGFuMltpICogM10sIHRhbjJbaSAqIDMgKyAxXSwgdGFuMltpICogMyArIDJdKTtcbiAgICB2YXIgbmRvdHQgPSBuLmRvdCh0MSk7XG4gICAgdGVtcC5jb3B5KG4pLnNjYWxlKG5kb3R0KTtcbiAgICB0ZW1wLnN1YjIodDEsIHRlbXApLm5vcm1hbGl6ZSgpO1xuICAgIHRhbmdlbnRzW2kgKiA0XSA9IHRlbXAueDtcbiAgICB0YW5nZW50c1tpICogNCArIDFdID0gdGVtcC55O1xuICAgIHRhbmdlbnRzW2kgKiA0ICsgMl0gPSB0ZW1wLno7XG4gICAgdGVtcC5jcm9zcyhuLCB0MSk7XG4gICAgdGFuZ2VudHNbaSAqIDQgKyAzXSA9IHRlbXAuZG90KHQyKSA8IDAuMCA/IC0xLjAgOiAxLjA7XG4gIH1cbiAgcmV0dXJuIHRhbmdlbnRzO1xufTtcbnBjLmNyZWF0ZU1lc2ggPSBmdW5jdGlvbihkZXZpY2UsIHBvc2l0aW9ucywgb3B0cykge1xuICB2YXIgbm9ybWFscyA9IG9wdHMgJiYgb3B0cy5ub3JtYWxzICE9PSB1bmRlZmluZWQgPyBvcHRzLm5vcm1hbHMgOiBudWxsO1xuICB2YXIgdGFuZ2VudHMgPSBvcHRzICYmIG9wdHMudGFuZ2VudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMudGFuZ2VudHMgOiBudWxsO1xuICB2YXIgY29sb3JzID0gb3B0cyAmJiBvcHRzLmNvbG9ycyAhPT0gdW5kZWZpbmVkID8gb3B0cy5jb2xvcnMgOiBudWxsO1xuICB2YXIgdXZzID0gb3B0cyAmJiBvcHRzLnV2cyAhPT0gdW5kZWZpbmVkID8gb3B0cy51dnMgOiBudWxsO1xuICB2YXIgdXZzMSA9IG9wdHMgJiYgb3B0cy51dnMxICE9PSB1bmRlZmluZWQgPyBvcHRzLnV2czEgOiBudWxsO1xuICB2YXIgaW5kaWNlcyA9IG9wdHMgJiYgb3B0cy5pbmRpY2VzICE9PSB1bmRlZmluZWQgPyBvcHRzLmluZGljZXMgOiBudWxsO1xuICB2YXIgYmxlbmRJbmRpY2VzID0gb3B0cyAmJiBvcHRzLmJsZW5kSW5kaWNlcyAhPT0gdW5kZWZpbmVkID8gb3B0cy5ibGVuZEluZGljZXMgOiBudWxsO1xuICB2YXIgYmxlbmRXZWlnaHRzID0gb3B0cyAmJiBvcHRzLmJsZW5kV2VpZ2h0cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5ibGVuZFdlaWdodHMgOiBudWxsO1xuICB2YXIgdmVydGV4RGVzYyA9IFt7c2VtYW50aWM6cGMuU0VNQU5USUNfUE9TSVRJT04sIGNvbXBvbmVudHM6MywgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XTtcbiAgaWYgKG5vcm1hbHMgIT09IG51bGwpIHtcbiAgICB2ZXJ0ZXhEZXNjLnB1c2goe3NlbWFudGljOnBjLlNFTUFOVElDX05PUk1BTCwgY29tcG9uZW50czozLCB0eXBlOnBjLlRZUEVfRkxPQVQzMn0pO1xuICB9XG4gIGlmICh0YW5nZW50cyAhPT0gbnVsbCkge1xuICAgIHZlcnRleERlc2MucHVzaCh7c2VtYW50aWM6cGMuU0VNQU5USUNfVEFOR0VOVCwgY29tcG9uZW50czo0LCB0eXBlOnBjLlRZUEVfRkxPQVQzMn0pO1xuICB9XG4gIGlmIChjb2xvcnMgIT09IG51bGwpIHtcbiAgICB2ZXJ0ZXhEZXNjLnB1c2goe3NlbWFudGljOnBjLlNFTUFOVElDX0NPTE9SLCBjb21wb25lbnRzOjQsIHR5cGU6cGMuVFlQRV9VSU5UOCwgbm9ybWFsaXplOnRydWV9KTtcbiAgfVxuICBpZiAodXZzICE9PSBudWxsKSB7XG4gICAgdmVydGV4RGVzYy5wdXNoKHtzZW1hbnRpYzpwYy5TRU1BTlRJQ19URVhDT09SRDAsIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9KTtcbiAgfVxuICBpZiAodXZzMSAhPT0gbnVsbCkge1xuICAgIHZlcnRleERlc2MucHVzaCh7c2VtYW50aWM6cGMuU0VNQU5USUNfVEVYQ09PUkQxLCBjb21wb25lbnRzOjIsIHR5cGU6cGMuVFlQRV9GTE9BVDMyfSk7XG4gIH1cbiAgaWYgKGJsZW5kSW5kaWNlcyAhPT0gbnVsbCkge1xuICAgIHZlcnRleERlc2MucHVzaCh7c2VtYW50aWM6cGMuU0VNQU5USUNfQkxFTkRJTkRJQ0VTLCBjb21wb25lbnRzOjIsIHR5cGU6cGMuVFlQRV9VSU5UOH0pO1xuICB9XG4gIGlmIChibGVuZFdlaWdodHMgIT09IG51bGwpIHtcbiAgICB2ZXJ0ZXhEZXNjLnB1c2goe3NlbWFudGljOnBjLlNFTUFOVElDX0JMRU5EV0VJR0hULCBjb21wb25lbnRzOjIsIHR5cGU6cGMuVFlQRV9GTE9BVDMyfSk7XG4gIH1cbiAgdmFyIHZlcnRleEZvcm1hdCA9IG5ldyBwYy5WZXJ0ZXhGb3JtYXQoZGV2aWNlLCB2ZXJ0ZXhEZXNjKTtcbiAgdmFyIG51bVZlcnRpY2VzID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7XG4gIHZhciB2ZXJ0ZXhCdWZmZXIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKGRldmljZSwgdmVydGV4Rm9ybWF0LCBudW1WZXJ0aWNlcyk7XG4gIHZhciBpdGVyYXRvciA9IG5ldyBwYy5WZXJ0ZXhJdGVyYXRvcih2ZXJ0ZXhCdWZmZXIpO1xuICBmb3IgKHZhciBpID0gMDtpIDwgbnVtVmVydGljZXM7aSsrKSB7XG4gICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19QT1NJVElPTl0uc2V0KHBvc2l0aW9uc1tpICogM10sIHBvc2l0aW9uc1tpICogMyArIDFdLCBwb3NpdGlvbnNbaSAqIDMgKyAyXSk7XG4gICAgaWYgKG5vcm1hbHMgIT09IG51bGwpIHtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfTk9STUFMXS5zZXQobm9ybWFsc1tpICogM10sIG5vcm1hbHNbaSAqIDMgKyAxXSwgbm9ybWFsc1tpICogMyArIDJdKTtcbiAgICB9XG4gICAgaWYgKHRhbmdlbnRzICE9PSBudWxsKSB7XG4gICAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX1RBTkdFTlRdLnNldCh0YW5nZW50c1tpICogNF0sIHRhbmdlbnRzW2kgKiA0ICsgMV0sIHRhbmdlbnRzW2kgKiA0ICsgMl0sIHRhbmdlbnRzW2kgKiA0ICsgM10pO1xuICAgIH1cbiAgICBpZiAoY29sb3JzICE9PSBudWxsKSB7XG4gICAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX0NPTE9SXS5zZXQoY29sb3JzW2kgKiA0XSwgY29sb3JzW2kgKiA0ICsgMV0sIGNvbG9yc1tpICogNCArIDJdLCBjb2xvcnNbaSAqIDQgKyAzXSk7XG4gICAgfVxuICAgIGlmICh1dnMgIT09IG51bGwpIHtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfVEVYQ09PUkQwXS5zZXQodXZzW2kgKiAyXSwgdXZzW2kgKiAyICsgMV0pO1xuICAgIH1cbiAgICBpZiAodXZzMSAhPT0gbnVsbCkge1xuICAgICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19URVhDT09SRDFdLnNldCh1dnMxW2kgKiAyXSwgdXZzMVtpICogMiArIDFdKTtcbiAgICB9XG4gICAgaWYgKGJsZW5kSW5kaWNlcyAhPT0gbnVsbCkge1xuICAgICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19CTEVORElORElDRVNdLnNldChibGVuZEluZGljZXNbaSAqIDJdLCBibGVuZEluZGljZXNbaSAqIDIgKyAxXSk7XG4gICAgfVxuICAgIGlmIChibGVuZFdlaWdodHMgIT09IG51bGwpIHtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfQkxFTkRXRUlHSFRdLnNldChibGVuZFdlaWdodHNbaSAqIDJdLCBibGVuZFdlaWdodHNbaSAqIDIgKyAxXSk7XG4gICAgfVxuICAgIGl0ZXJhdG9yLm5leHQoKTtcbiAgfVxuICBpdGVyYXRvci5lbmQoKTtcbiAgdmFyIGluZGV4QnVmZmVyID0gbnVsbDtcbiAgdmFyIGluZGV4ZWQgPSBpbmRpY2VzICE9PSBudWxsO1xuICBpZiAoaW5kZXhlZCkge1xuICAgIGluZGV4QnVmZmVyID0gbmV3IHBjLkluZGV4QnVmZmVyKGRldmljZSwgcGMuSU5ERVhGT1JNQVRfVUlOVDE2LCBpbmRpY2VzLmxlbmd0aCk7XG4gICAgdmFyIGRzdCA9IG5ldyBVaW50MTZBcnJheShpbmRleEJ1ZmZlci5sb2NrKCkpO1xuICAgIGRzdC5zZXQoaW5kaWNlcyk7XG4gICAgaW5kZXhCdWZmZXIudW5sb2NrKCk7XG4gIH1cbiAgdmFyIGFhYmIgPSBuZXcgcGMuQm91bmRpbmdCb3g7XG4gIGFhYmIuY29tcHV0ZShwb3NpdGlvbnMpO1xuICB2YXIgbWVzaCA9IG5ldyBwYy5NZXNoO1xuICBtZXNoLnZlcnRleEJ1ZmZlciA9IHZlcnRleEJ1ZmZlcjtcbiAgbWVzaC5pbmRleEJ1ZmZlclswXSA9IGluZGV4QnVmZmVyO1xuICBtZXNoLnByaW1pdGl2ZVswXS50eXBlID0gcGMuUFJJTUlUSVZFX1RSSUFOR0xFUztcbiAgbWVzaC5wcmltaXRpdmVbMF0uYmFzZSA9IDA7XG4gIG1lc2gucHJpbWl0aXZlWzBdLmNvdW50ID0gaW5kZXhlZCA/IGluZGljZXMubGVuZ3RoIDogbnVtVmVydGljZXM7XG4gIG1lc2gucHJpbWl0aXZlWzBdLmluZGV4ZWQgPSBpbmRleGVkO1xuICBtZXNoLmFhYmIgPSBhYWJiO1xuICByZXR1cm4gbWVzaDtcbn07XG5wYy5jcmVhdGVUb3J1cyA9IGZ1bmN0aW9uKGRldmljZSwgb3B0cykge1xuICB2YXIgcmMgPSBvcHRzICYmIG9wdHMudHViZVJhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy50dWJlUmFkaXVzIDogMC4yO1xuICB2YXIgcnQgPSBvcHRzICYmIG9wdHMucmluZ1JhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5yaW5nUmFkaXVzIDogMC4zO1xuICB2YXIgc2VnbWVudHMgPSBvcHRzICYmIG9wdHMuc2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMuc2VnbWVudHMgOiAzMDtcbiAgdmFyIHNpZGVzID0gb3B0cyAmJiBvcHRzLnNpZGVzICE9PSB1bmRlZmluZWQgPyBvcHRzLnNpZGVzIDogMjA7XG4gIHZhciBpLCBqO1xuICB2YXIgeCwgeSwgeiwgbngsIG55LCBueiwgdSwgdjtcbiAgdmFyIHBvc2l0aW9ucyA9IFtdO1xuICB2YXIgbm9ybWFscyA9IFtdO1xuICB2YXIgdXZzID0gW107XG4gIHZhciBpbmRpY2VzID0gW107XG4gIGZvciAoaSA9IDA7aSA8PSBzaWRlcztpKyspIHtcbiAgICBmb3IgKGogPSAwO2ogPD0gc2VnbWVudHM7aisrKSB7XG4gICAgICB4ID0gTWF0aC5jb3MoMi4wICogTWF0aC5QSSAqIGogLyBzZWdtZW50cykgKiAocnQgKyByYyAqIE1hdGguY29zKDIuMCAqIE1hdGguUEkgKiBpIC8gc2lkZXMpKTtcbiAgICAgIHkgPSBNYXRoLnNpbigyLjAgKiBNYXRoLlBJICogaSAvIHNpZGVzKSAqIHJjO1xuICAgICAgeiA9IE1hdGguc2luKDIuMCAqIE1hdGguUEkgKiBqIC8gc2VnbWVudHMpICogKHJ0ICsgcmMgKiBNYXRoLmNvcygyLjAgKiBNYXRoLlBJICogaSAvIHNpZGVzKSk7XG4gICAgICBueCA9IE1hdGguY29zKDIuMCAqIE1hdGguUEkgKiBqIC8gc2VnbWVudHMpICogTWF0aC5jb3MoMi4wICogTWF0aC5QSSAqIGkgLyBzaWRlcyk7XG4gICAgICBueSA9IE1hdGguc2luKDIuMCAqIE1hdGguUEkgKiBpIC8gc2lkZXMpO1xuICAgICAgbnogPSBNYXRoLnNpbigyLjAgKiBNYXRoLlBJICogaiAvIHNlZ21lbnRzKSAqIE1hdGguY29zKDIuMCAqIE1hdGguUEkgKiBpIC8gc2lkZXMpO1xuICAgICAgdSA9IGkgLyBzaWRlcztcbiAgICAgIHYgPSAxLjAgLSBqIC8gc2VnbWVudHM7XG4gICAgICBwb3NpdGlvbnMucHVzaCh4LCB5LCB6KTtcbiAgICAgIG5vcm1hbHMucHVzaChueCwgbnksIG56KTtcbiAgICAgIHV2cy5wdXNoKHUsIHYpO1xuICAgICAgaWYgKGkgPCBzaWRlcyAmJiBqIDwgc2VnbWVudHMpIHtcbiAgICAgICAgdmFyIGZpcnN0LCBzZWNvbmQsIHRoaXJkLCBmb3VydGg7XG4gICAgICAgIGZpcnN0ID0gaSAqIChzZWdtZW50cyArIDEpICsgajtcbiAgICAgICAgc2Vjb25kID0gKGkgKyAxKSAqIChzZWdtZW50cyArIDEpICsgajtcbiAgICAgICAgdGhpcmQgPSBpICogKHNlZ21lbnRzICsgMSkgKyAoaiArIDEpO1xuICAgICAgICBmb3VydGggPSAoaSArIDEpICogKHNlZ21lbnRzICsgMSkgKyAoaiArIDEpO1xuICAgICAgICBpbmRpY2VzLnB1c2goZmlyc3QsIHNlY29uZCwgdGhpcmQpO1xuICAgICAgICBpbmRpY2VzLnB1c2goc2Vjb25kLCBmb3VydGgsIHRoaXJkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgdmFyIG9wdGlvbnMgPSB7bm9ybWFsczpub3JtYWxzLCB1dnM6dXZzLCBpbmRpY2VzOmluZGljZXN9O1xuICBpZiAocGMucHJlY2FsY3VsYXRlZFRhbmdlbnRzKSB7XG4gICAgb3B0aW9ucy50YW5nZW50cyA9IHBjLmNhbGN1bGF0ZVRhbmdlbnRzKHBvc2l0aW9ucywgbm9ybWFscywgdXZzLCBpbmRpY2VzKTtcbiAgfVxuICByZXR1cm4gcGMuY3JlYXRlTWVzaChkZXZpY2UsIHBvc2l0aW9ucywgb3B0aW9ucyk7XG59O1xucGMuX2NyZWF0ZUNvbmVEYXRhID0gZnVuY3Rpb24oYmFzZVJhZGl1cywgcGVha1JhZGl1cywgaGVpZ2h0LCBoZWlnaHRTZWdtZW50cywgY2FwU2VnbWVudHMsIHJvdW5kZWRDYXBzKSB7XG4gIHZhciBpLCBqO1xuICB2YXIgeCwgeSwgeiwgdSwgdjtcbiAgdmFyIHBvcyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgYm90dG9tVG9Ub3AgPSBuZXcgcGMuVmVjMztcbiAgdmFyIG5vcm0gPSBuZXcgcGMuVmVjMztcbiAgdmFyIHRvcCwgYm90dG9tLCB0YW5nZW50O1xuICB2YXIgcG9zaXRpb25zID0gW107XG4gIHZhciBub3JtYWxzID0gW107XG4gIHZhciB1dnMgPSBbXTtcbiAgdmFyIHV2czEgPSBbXTtcbiAgdmFyIGluZGljZXMgPSBbXTtcbiAgdmFyIHRoZXRhLCBjb3NUaGV0YSwgc2luVGhldGE7XG4gIHZhciBwaGksIHNpblBoaSwgY29zUGhpO1xuICB2YXIgZmlyc3QsIHNlY29uZCwgdGhpcmQsIGZvdXJ0aDtcbiAgdmFyIG9mZnNldDtcbiAgaWYgKGhlaWdodCA+IDApIHtcbiAgICBmb3IgKGkgPSAwO2kgPD0gaGVpZ2h0U2VnbWVudHM7aSsrKSB7XG4gICAgICBmb3IgKGogPSAwO2ogPD0gY2FwU2VnbWVudHM7aisrKSB7XG4gICAgICAgIHRoZXRhID0gaiAvIGNhcFNlZ21lbnRzICogMi4wICogTWF0aC5QSSAtIE1hdGguUEk7XG4gICAgICAgIHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpO1xuICAgICAgICBjb3NUaGV0YSA9IE1hdGguY29zKHRoZXRhKTtcbiAgICAgICAgYm90dG9tID0gbmV3IHBjLlZlYzMoc2luVGhldGEgKiBiYXNlUmFkaXVzLCAtaGVpZ2h0IC8gMi4wLCBjb3NUaGV0YSAqIGJhc2VSYWRpdXMpO1xuICAgICAgICB0b3AgPSBuZXcgcGMuVmVjMyhzaW5UaGV0YSAqIHBlYWtSYWRpdXMsIGhlaWdodCAvIDIuMCwgY29zVGhldGEgKiBwZWFrUmFkaXVzKTtcbiAgICAgICAgcG9zLmxlcnAoYm90dG9tLCB0b3AsIGkgLyBoZWlnaHRTZWdtZW50cyk7XG4gICAgICAgIGJvdHRvbVRvVG9wLnN1YjIodG9wLCBib3R0b20pLm5vcm1hbGl6ZSgpO1xuICAgICAgICB0YW5nZW50ID0gbmV3IHBjLlZlYzMoY29zVGhldGEsIDAuMCwgLXNpblRoZXRhKTtcbiAgICAgICAgbm9ybS5jcm9zcyh0YW5nZW50LCBib3R0b21Ub1RvcCkubm9ybWFsaXplKCk7XG4gICAgICAgIHBvc2l0aW9ucy5wdXNoKHBvcy54LCBwb3MueSwgcG9zLnopO1xuICAgICAgICBub3JtYWxzLnB1c2gobm9ybS54LCBub3JtLnksIG5vcm0ueik7XG4gICAgICAgIHUgPSBqIC8gY2FwU2VnbWVudHM7XG4gICAgICAgIHYgPSBpIC8gaGVpZ2h0U2VnbWVudHM7XG4gICAgICAgIHV2cy5wdXNoKHUsIHYpO1xuICAgICAgICB2YXIgX3YgPSB2O1xuICAgICAgICB2ID0gdTtcbiAgICAgICAgdSA9IF92O1xuICAgICAgICB1IC89IDM7XG4gICAgICAgIHUgPSB1ICogcHJpbWl0aXZlVXYxUGFkZGluZ1NjYWxlICsgcHJpbWl0aXZlVXYxUGFkZGluZztcbiAgICAgICAgdiA9IHYgKiBwcmltaXRpdmVVdjFQYWRkaW5nU2NhbGUgKyBwcmltaXRpdmVVdjFQYWRkaW5nO1xuICAgICAgICB1dnMxLnB1c2godSwgdik7XG4gICAgICAgIGlmIChpIDwgaGVpZ2h0U2VnbWVudHMgJiYgaiA8IGNhcFNlZ21lbnRzKSB7XG4gICAgICAgICAgZmlyc3QgPSBpICogKGNhcFNlZ21lbnRzICsgMSkgKyBqO1xuICAgICAgICAgIHNlY29uZCA9IGkgKiAoY2FwU2VnbWVudHMgKyAxKSArIChqICsgMSk7XG4gICAgICAgICAgdGhpcmQgPSAoaSArIDEpICogKGNhcFNlZ21lbnRzICsgMSkgKyBqO1xuICAgICAgICAgIGZvdXJ0aCA9IChpICsgMSkgKiAoY2FwU2VnbWVudHMgKyAxKSArIChqICsgMSk7XG4gICAgICAgICAgaW5kaWNlcy5wdXNoKGZpcnN0LCBzZWNvbmQsIHRoaXJkKTtcbiAgICAgICAgICBpbmRpY2VzLnB1c2goc2Vjb25kLCBmb3VydGgsIHRoaXJkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAocm91bmRlZENhcHMpIHtcbiAgICB2YXIgbGF0LCBsb247XG4gICAgdmFyIGxhdGl0dWRlQmFuZHMgPSBNYXRoLmZsb29yKGNhcFNlZ21lbnRzIC8gMik7XG4gICAgdmFyIGxvbmdpdHVkZUJhbmRzID0gY2FwU2VnbWVudHM7XG4gICAgdmFyIGNhcE9mZnNldCA9IGhlaWdodCAvIDI7XG4gICAgZm9yIChsYXQgPSAwO2xhdCA8PSBsYXRpdHVkZUJhbmRzO2xhdCsrKSB7XG4gICAgICB0aGV0YSA9IGxhdCAqIE1hdGguUEkgKiAwLjUgLyBsYXRpdHVkZUJhbmRzO1xuICAgICAgc2luVGhldGEgPSBNYXRoLnNpbih0aGV0YSk7XG4gICAgICBjb3NUaGV0YSA9IE1hdGguY29zKHRoZXRhKTtcbiAgICAgIGZvciAobG9uID0gMDtsb24gPD0gbG9uZ2l0dWRlQmFuZHM7bG9uKyspIHtcbiAgICAgICAgcGhpID0gbG9uICogMiAqIE1hdGguUEkgLyBsb25naXR1ZGVCYW5kcyAtIE1hdGguUEkgLyAyLjA7XG4gICAgICAgIHNpblBoaSA9IE1hdGguc2luKHBoaSk7XG4gICAgICAgIGNvc1BoaSA9IE1hdGguY29zKHBoaSk7XG4gICAgICAgIHggPSBjb3NQaGkgKiBzaW5UaGV0YTtcbiAgICAgICAgeSA9IGNvc1RoZXRhO1xuICAgICAgICB6ID0gc2luUGhpICogc2luVGhldGE7XG4gICAgICAgIHUgPSAxLjAgLSBsb24gLyBsb25naXR1ZGVCYW5kcztcbiAgICAgICAgdiA9IDEuMCAtIGxhdCAvIGxhdGl0dWRlQmFuZHM7XG4gICAgICAgIHBvc2l0aW9ucy5wdXNoKHggKiBwZWFrUmFkaXVzLCB5ICogcGVha1JhZGl1cyArIGNhcE9mZnNldCwgeiAqIHBlYWtSYWRpdXMpO1xuICAgICAgICBub3JtYWxzLnB1c2goeCwgeSwgeik7XG4gICAgICAgIHV2cy5wdXNoKHUsIHYpO1xuICAgICAgICB1IC89IDM7XG4gICAgICAgIHYgLz0gMztcbiAgICAgICAgdSA9IHUgKiBwcmltaXRpdmVVdjFQYWRkaW5nU2NhbGUgKyBwcmltaXRpdmVVdjFQYWRkaW5nO1xuICAgICAgICB2ID0gdiAqIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSArIHByaW1pdGl2ZVV2MVBhZGRpbmc7XG4gICAgICAgIHUgKz0gMS4wIC8gMztcbiAgICAgICAgdXZzMS5wdXNoKHUsIHYpO1xuICAgICAgfVxuICAgIH1cbiAgICBvZmZzZXQgPSAoaGVpZ2h0U2VnbWVudHMgKyAxKSAqIChjYXBTZWdtZW50cyArIDEpO1xuICAgIGZvciAobGF0ID0gMDtsYXQgPCBsYXRpdHVkZUJhbmRzOysrbGF0KSB7XG4gICAgICBmb3IgKGxvbiA9IDA7bG9uIDwgbG9uZ2l0dWRlQmFuZHM7Kytsb24pIHtcbiAgICAgICAgZmlyc3QgPSBsYXQgKiAobG9uZ2l0dWRlQmFuZHMgKyAxKSArIGxvbjtcbiAgICAgICAgc2Vjb25kID0gZmlyc3QgKyBsb25naXR1ZGVCYW5kcyArIDE7XG4gICAgICAgIGluZGljZXMucHVzaChvZmZzZXQgKyBmaXJzdCArIDEsIG9mZnNldCArIHNlY29uZCwgb2Zmc2V0ICsgZmlyc3QpO1xuICAgICAgICBpbmRpY2VzLnB1c2gob2Zmc2V0ICsgZmlyc3QgKyAxLCBvZmZzZXQgKyBzZWNvbmQgKyAxLCBvZmZzZXQgKyBzZWNvbmQpO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxhdCA9IDA7bGF0IDw9IGxhdGl0dWRlQmFuZHM7bGF0KyspIHtcbiAgICAgIHRoZXRhID0gTWF0aC5QSSAqIDAuNSArIGxhdCAqIE1hdGguUEkgKiAwLjUgLyBsYXRpdHVkZUJhbmRzO1xuICAgICAgc2luVGhldGEgPSBNYXRoLnNpbih0aGV0YSk7XG4gICAgICBjb3NUaGV0YSA9IE1hdGguY29zKHRoZXRhKTtcbiAgICAgIGZvciAobG9uID0gMDtsb24gPD0gbG9uZ2l0dWRlQmFuZHM7bG9uKyspIHtcbiAgICAgICAgcGhpID0gbG9uICogMiAqIE1hdGguUEkgLyBsb25naXR1ZGVCYW5kcyAtIE1hdGguUEkgLyAyLjA7XG4gICAgICAgIHNpblBoaSA9IE1hdGguc2luKHBoaSk7XG4gICAgICAgIGNvc1BoaSA9IE1hdGguY29zKHBoaSk7XG4gICAgICAgIHggPSBjb3NQaGkgKiBzaW5UaGV0YTtcbiAgICAgICAgeSA9IGNvc1RoZXRhO1xuICAgICAgICB6ID0gc2luUGhpICogc2luVGhldGE7XG4gICAgICAgIHUgPSAxLjAgLSBsb24gLyBsb25naXR1ZGVCYW5kcztcbiAgICAgICAgdiA9IDEuMCAtIGxhdCAvIGxhdGl0dWRlQmFuZHM7XG4gICAgICAgIHBvc2l0aW9ucy5wdXNoKHggKiBwZWFrUmFkaXVzLCB5ICogcGVha1JhZGl1cyAtIGNhcE9mZnNldCwgeiAqIHBlYWtSYWRpdXMpO1xuICAgICAgICBub3JtYWxzLnB1c2goeCwgeSwgeik7XG4gICAgICAgIHV2cy5wdXNoKHUsIHYpO1xuICAgICAgICB1IC89IDM7XG4gICAgICAgIHYgLz0gMztcbiAgICAgICAgdSA9IHUgKiBwcmltaXRpdmVVdjFQYWRkaW5nU2NhbGUgKyBwcmltaXRpdmVVdjFQYWRkaW5nO1xuICAgICAgICB2ID0gdiAqIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSArIHByaW1pdGl2ZVV2MVBhZGRpbmc7XG4gICAgICAgIHUgKz0gMi4wIC8gMztcbiAgICAgICAgdXZzMS5wdXNoKHUsIHYpO1xuICAgICAgfVxuICAgIH1cbiAgICBvZmZzZXQgPSAoaGVpZ2h0U2VnbWVudHMgKyAxKSAqIChjYXBTZWdtZW50cyArIDEpICsgKGxvbmdpdHVkZUJhbmRzICsgMSkgKiAobGF0aXR1ZGVCYW5kcyArIDEpO1xuICAgIGZvciAobGF0ID0gMDtsYXQgPCBsYXRpdHVkZUJhbmRzOysrbGF0KSB7XG4gICAgICBmb3IgKGxvbiA9IDA7bG9uIDwgbG9uZ2l0dWRlQmFuZHM7Kytsb24pIHtcbiAgICAgICAgZmlyc3QgPSBsYXQgKiAobG9uZ2l0dWRlQmFuZHMgKyAxKSArIGxvbjtcbiAgICAgICAgc2Vjb25kID0gZmlyc3QgKyBsb25naXR1ZGVCYW5kcyArIDE7XG4gICAgICAgIGluZGljZXMucHVzaChvZmZzZXQgKyBmaXJzdCArIDEsIG9mZnNldCArIHNlY29uZCwgb2Zmc2V0ICsgZmlyc3QpO1xuICAgICAgICBpbmRpY2VzLnB1c2gob2Zmc2V0ICsgZmlyc3QgKyAxLCBvZmZzZXQgKyBzZWNvbmQgKyAxLCBvZmZzZXQgKyBzZWNvbmQpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBvZmZzZXQgPSAoaGVpZ2h0U2VnbWVudHMgKyAxKSAqIChjYXBTZWdtZW50cyArIDEpO1xuICAgIGlmIChiYXNlUmFkaXVzID4gMC4wKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBjYXBTZWdtZW50cztpKyspIHtcbiAgICAgICAgdGhldGEgPSBpIC8gY2FwU2VnbWVudHMgKiAyLjAgKiBNYXRoLlBJO1xuICAgICAgICB4ID0gTWF0aC5zaW4odGhldGEpO1xuICAgICAgICB5ID0gLWhlaWdodCAvIDIuMDtcbiAgICAgICAgeiA9IE1hdGguY29zKHRoZXRhKTtcbiAgICAgICAgdSA9IDEuMCAtICh4ICsgMS4wKSAvIDIuMDtcbiAgICAgICAgdiA9ICh6ICsgMS4wKSAvIDIuMDtcbiAgICAgICAgcG9zaXRpb25zLnB1c2goeCAqIGJhc2VSYWRpdXMsIHksIHogKiBiYXNlUmFkaXVzKTtcbiAgICAgICAgbm9ybWFscy5wdXNoKDAuMCwgLTEuMCwgMC4wKTtcbiAgICAgICAgdXZzLnB1c2godSwgdik7XG4gICAgICAgIHUgLz0gMztcbiAgICAgICAgdiAvPSAzO1xuICAgICAgICB1ID0gdSAqIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSArIHByaW1pdGl2ZVV2MVBhZGRpbmc7XG4gICAgICAgIHYgPSB2ICogcHJpbWl0aXZlVXYxUGFkZGluZ1NjYWxlICsgcHJpbWl0aXZlVXYxUGFkZGluZztcbiAgICAgICAgdSArPSAxLjAgLyAzO1xuICAgICAgICB1dnMxLnB1c2godSwgdik7XG4gICAgICAgIGlmIChpID4gMSkge1xuICAgICAgICAgIGluZGljZXMucHVzaChvZmZzZXQsIG9mZnNldCArIGksIG9mZnNldCArIGkgLSAxKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBvZmZzZXQgKz0gY2FwU2VnbWVudHM7XG4gICAgaWYgKHBlYWtSYWRpdXMgPiAwLjApIHtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGNhcFNlZ21lbnRzO2krKykge1xuICAgICAgICB0aGV0YSA9IGkgLyBjYXBTZWdtZW50cyAqIDIuMCAqIE1hdGguUEk7XG4gICAgICAgIHggPSBNYXRoLnNpbih0aGV0YSk7XG4gICAgICAgIHkgPSBoZWlnaHQgLyAyLjA7XG4gICAgICAgIHogPSBNYXRoLmNvcyh0aGV0YSk7XG4gICAgICAgIHUgPSAxLjAgLSAoeCArIDEuMCkgLyAyLjA7XG4gICAgICAgIHYgPSAoeiArIDEuMCkgLyAyLjA7XG4gICAgICAgIHBvc2l0aW9ucy5wdXNoKHggKiBwZWFrUmFkaXVzLCB5LCB6ICogcGVha1JhZGl1cyk7XG4gICAgICAgIG5vcm1hbHMucHVzaCgwLjAsIDEuMCwgMC4wKTtcbiAgICAgICAgdXZzLnB1c2godSwgdik7XG4gICAgICAgIHUgLz0gMztcbiAgICAgICAgdiAvPSAzO1xuICAgICAgICB1ID0gdSAqIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSArIHByaW1pdGl2ZVV2MVBhZGRpbmc7XG4gICAgICAgIHYgPSB2ICogcHJpbWl0aXZlVXYxUGFkZGluZ1NjYWxlICsgcHJpbWl0aXZlVXYxUGFkZGluZztcbiAgICAgICAgdSArPSAyLjAgLyAzO1xuICAgICAgICB1dnMxLnB1c2godSwgdik7XG4gICAgICAgIGlmIChpID4gMSkge1xuICAgICAgICAgIGluZGljZXMucHVzaChvZmZzZXQsIG9mZnNldCArIGkgLSAxLCBvZmZzZXQgKyBpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4ge3Bvc2l0aW9uczpwb3NpdGlvbnMsIG5vcm1hbHM6bm9ybWFscywgdXZzOnV2cywgdXZzMTp1dnMxLCBpbmRpY2VzOmluZGljZXN9O1xufTtcbnBjLmNyZWF0ZUN5bGluZGVyID0gZnVuY3Rpb24oZGV2aWNlLCBvcHRzKSB7XG4gIHZhciByYWRpdXMgPSBvcHRzICYmIChvcHRzLnJhZGl1cyB8fCBvcHRzLmJhc2VSYWRpdXMpO1xuICByYWRpdXMgPSByYWRpdXMgIT09IHVuZGVmaW5lZCA/IHJhZGl1cyA6IDAuNTtcbiAgdmFyIGhlaWdodCA9IG9wdHMgJiYgb3B0cy5oZWlnaHQgIT09IHVuZGVmaW5lZCA/IG9wdHMuaGVpZ2h0IDogMS4wO1xuICB2YXIgaGVpZ2h0U2VnbWVudHMgPSBvcHRzICYmIG9wdHMuaGVpZ2h0U2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMuaGVpZ2h0U2VnbWVudHMgOiA1O1xuICB2YXIgY2FwU2VnbWVudHMgPSBvcHRzICYmIG9wdHMuY2FwU2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMuY2FwU2VnbWVudHMgOiAyMDtcbiAgdmFyIG9wdGlvbnMgPSBwYy5fY3JlYXRlQ29uZURhdGEocmFkaXVzLCByYWRpdXMsIGhlaWdodCwgaGVpZ2h0U2VnbWVudHMsIGNhcFNlZ21lbnRzLCBmYWxzZSk7XG4gIGlmIChwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHMpIHtcbiAgICBvcHRpb25zLnRhbmdlbnRzID0gcGMuY2FsY3VsYXRlVGFuZ2VudHMob3B0aW9ucy5wb3NpdGlvbnMsIG9wdGlvbnMubm9ybWFscywgb3B0aW9ucy51dnMsIG9wdGlvbnMuaW5kaWNlcyk7XG4gIH1cbiAgcmV0dXJuIHBjLmNyZWF0ZU1lc2goZGV2aWNlLCBvcHRpb25zLnBvc2l0aW9ucywgb3B0aW9ucyk7XG59O1xucGMuY3JlYXRlQ2Fwc3VsZSA9IGZ1bmN0aW9uKGRldmljZSwgb3B0cykge1xuICB2YXIgcmFkaXVzID0gb3B0cyAmJiBvcHRzLnJhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5yYWRpdXMgOiAwLjM7XG4gIHZhciBoZWlnaHQgPSBvcHRzICYmIG9wdHMuaGVpZ2h0ICE9PSB1bmRlZmluZWQgPyBvcHRzLmhlaWdodCA6IDEuMDtcbiAgdmFyIGhlaWdodFNlZ21lbnRzID0gb3B0cyAmJiBvcHRzLmhlaWdodFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLmhlaWdodFNlZ21lbnRzIDogMTtcbiAgdmFyIHNpZGVzID0gb3B0cyAmJiBvcHRzLnNpZGVzICE9PSB1bmRlZmluZWQgPyBvcHRzLnNpZGVzIDogMjA7XG4gIHZhciBvcHRpb25zID0gcGMuX2NyZWF0ZUNvbmVEYXRhKHJhZGl1cywgcmFkaXVzLCBoZWlnaHQgLSAyICogcmFkaXVzLCBoZWlnaHRTZWdtZW50cywgc2lkZXMsIHRydWUpO1xuICBpZiAocGMucHJlY2FsY3VsYXRlZFRhbmdlbnRzKSB7XG4gICAgb3B0aW9ucy50YW5nZW50cyA9IHBjLmNhbGN1bGF0ZVRhbmdlbnRzKG9wdGlvbnMucG9zaXRpb25zLCBvcHRpb25zLm5vcm1hbHMsIG9wdGlvbnMudXZzLCBvcHRpb25zLmluZGljZXMpO1xuICB9XG4gIHJldHVybiBwYy5jcmVhdGVNZXNoKGRldmljZSwgb3B0aW9ucy5wb3NpdGlvbnMsIG9wdGlvbnMpO1xufTtcbnBjLmNyZWF0ZUNvbmUgPSBmdW5jdGlvbihkZXZpY2UsIG9wdHMpIHtcbiAgdmFyIGJhc2VSYWRpdXMgPSBvcHRzICYmIG9wdHMuYmFzZVJhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5iYXNlUmFkaXVzIDogMC41O1xuICB2YXIgcGVha1JhZGl1cyA9IG9wdHMgJiYgb3B0cy5wZWFrUmFkaXVzICE9PSB1bmRlZmluZWQgPyBvcHRzLnBlYWtSYWRpdXMgOiAwLjA7XG4gIHZhciBoZWlnaHQgPSBvcHRzICYmIG9wdHMuaGVpZ2h0ICE9PSB1bmRlZmluZWQgPyBvcHRzLmhlaWdodCA6IDEuMDtcbiAgdmFyIGhlaWdodFNlZ21lbnRzID0gb3B0cyAmJiBvcHRzLmhlaWdodFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLmhlaWdodFNlZ21lbnRzIDogNTtcbiAgdmFyIGNhcFNlZ21lbnRzID0gb3B0cyAmJiBvcHRzLmNhcFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLmNhcFNlZ21lbnRzIDogMTg7XG4gIHZhciBvcHRpb25zID0gcGMuX2NyZWF0ZUNvbmVEYXRhKGJhc2VSYWRpdXMsIHBlYWtSYWRpdXMsIGhlaWdodCwgaGVpZ2h0U2VnbWVudHMsIGNhcFNlZ21lbnRzLCBmYWxzZSk7XG4gIGlmIChwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHMpIHtcbiAgICBvcHRpb25zLnRhbmdlbnRzID0gcGMuY2FsY3VsYXRlVGFuZ2VudHMob3B0aW9ucy5wb3NpdGlvbnMsIG9wdGlvbnMubm9ybWFscywgb3B0aW9ucy51dnMsIG9wdGlvbnMuaW5kaWNlcyk7XG4gIH1cbiAgcmV0dXJuIHBjLmNyZWF0ZU1lc2goZGV2aWNlLCBvcHRpb25zLnBvc2l0aW9ucywgb3B0aW9ucyk7XG59O1xucGMuY3JlYXRlU3BoZXJlID0gZnVuY3Rpb24oZGV2aWNlLCBvcHRzKSB7XG4gIHZhciByYWRpdXMgPSBvcHRzICYmIG9wdHMucmFkaXVzICE9PSB1bmRlZmluZWQgPyBvcHRzLnJhZGl1cyA6IDAuNTtcbiAgdmFyIGxhdGl0dWRlQmFuZHMgPSBvcHRzICYmIG9wdHMubGF0aXR1ZGVCYW5kcyAhPT0gdW5kZWZpbmVkID8gb3B0cy5sYXRpdHVkZUJhbmRzIDogMTY7XG4gIHZhciBsb25naXR1ZGVCYW5kcyA9IG9wdHMgJiYgb3B0cy5sb25naXR1ZGVCYW5kcyAhPT0gdW5kZWZpbmVkID8gb3B0cy5sb25naXR1ZGVCYW5kcyA6IDE2O1xuICB2YXIgbG9uLCBsYXQ7XG4gIHZhciB0aGV0YSwgc2luVGhldGEsIGNvc1RoZXRhLCBwaGksIHNpblBoaSwgY29zUGhpO1xuICB2YXIgZmlyc3QsIHNlY29uZDtcbiAgdmFyIHgsIHksIHosIHUsIHY7XG4gIHZhciBwb3NpdGlvbnMgPSBbXTtcbiAgdmFyIG5vcm1hbHMgPSBbXTtcbiAgdmFyIHV2cyA9IFtdO1xuICB2YXIgaW5kaWNlcyA9IFtdO1xuICBmb3IgKGxhdCA9IDA7bGF0IDw9IGxhdGl0dWRlQmFuZHM7bGF0KyspIHtcbiAgICB0aGV0YSA9IGxhdCAqIE1hdGguUEkgLyBsYXRpdHVkZUJhbmRzO1xuICAgIHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpO1xuICAgIGNvc1RoZXRhID0gTWF0aC5jb3ModGhldGEpO1xuICAgIGZvciAobG9uID0gMDtsb24gPD0gbG9uZ2l0dWRlQmFuZHM7bG9uKyspIHtcbiAgICAgIHBoaSA9IGxvbiAqIDIgKiBNYXRoLlBJIC8gbG9uZ2l0dWRlQmFuZHMgLSBNYXRoLlBJIC8gMi4wO1xuICAgICAgc2luUGhpID0gTWF0aC5zaW4ocGhpKTtcbiAgICAgIGNvc1BoaSA9IE1hdGguY29zKHBoaSk7XG4gICAgICB4ID0gY29zUGhpICogc2luVGhldGE7XG4gICAgICB5ID0gY29zVGhldGE7XG4gICAgICB6ID0gc2luUGhpICogc2luVGhldGE7XG4gICAgICB1ID0gMS4wIC0gbG9uIC8gbG9uZ2l0dWRlQmFuZHM7XG4gICAgICB2ID0gMS4wIC0gbGF0IC8gbGF0aXR1ZGVCYW5kcztcbiAgICAgIHBvc2l0aW9ucy5wdXNoKHggKiByYWRpdXMsIHkgKiByYWRpdXMsIHogKiByYWRpdXMpO1xuICAgICAgbm9ybWFscy5wdXNoKHgsIHksIHopO1xuICAgICAgdXZzLnB1c2godSwgdik7XG4gICAgfVxuICB9XG4gIGZvciAobGF0ID0gMDtsYXQgPCBsYXRpdHVkZUJhbmRzOysrbGF0KSB7XG4gICAgZm9yIChsb24gPSAwO2xvbiA8IGxvbmdpdHVkZUJhbmRzOysrbG9uKSB7XG4gICAgICBmaXJzdCA9IGxhdCAqIChsb25naXR1ZGVCYW5kcyArIDEpICsgbG9uO1xuICAgICAgc2Vjb25kID0gZmlyc3QgKyBsb25naXR1ZGVCYW5kcyArIDE7XG4gICAgICBpbmRpY2VzLnB1c2goZmlyc3QgKyAxLCBzZWNvbmQsIGZpcnN0KTtcbiAgICAgIGluZGljZXMucHVzaChmaXJzdCArIDEsIHNlY29uZCArIDEsIHNlY29uZCk7XG4gICAgfVxuICB9XG4gIHZhciBvcHRpb25zID0ge25vcm1hbHM6bm9ybWFscywgdXZzOnV2cywgdXZzMTp1dnMsIGluZGljZXM6aW5kaWNlc307XG4gIGlmIChwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHMpIHtcbiAgICBvcHRpb25zLnRhbmdlbnRzID0gcGMuY2FsY3VsYXRlVGFuZ2VudHMocG9zaXRpb25zLCBub3JtYWxzLCB1dnMsIGluZGljZXMpO1xuICB9XG4gIHJldHVybiBwYy5jcmVhdGVNZXNoKGRldmljZSwgcG9zaXRpb25zLCBvcHRpb25zKTtcbn07XG5wYy5jcmVhdGVQbGFuZSA9IGZ1bmN0aW9uKGRldmljZSwgb3B0cykge1xuICB2YXIgaGUgPSBvcHRzICYmIG9wdHMuaGFsZkV4dGVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMuaGFsZkV4dGVudHMgOiBuZXcgcGMuVmVjMigwLjUsIDAuNSk7XG4gIHZhciB3cyA9IG9wdHMgJiYgb3B0cy53aWR0aFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLndpZHRoU2VnbWVudHMgOiA1O1xuICB2YXIgbHMgPSBvcHRzICYmIG9wdHMubGVuZ3RoU2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMubGVuZ3RoU2VnbWVudHMgOiA1O1xuICB2YXIgaSwgajtcbiAgdmFyIHgsIHksIHosIHUsIHY7XG4gIHZhciBwb3NpdGlvbnMgPSBbXTtcbiAgdmFyIG5vcm1hbHMgPSBbXTtcbiAgdmFyIHV2cyA9IFtdO1xuICB2YXIgaW5kaWNlcyA9IFtdO1xuICBmb3IgKGkgPSAwO2kgPD0gd3M7aSsrKSB7XG4gICAgZm9yIChqID0gMDtqIDw9IGxzO2orKykge1xuICAgICAgeCA9IC1oZS54ICsgMi4wICogaGUueCAqIGkgLyB3cztcbiAgICAgIHkgPSAwLjA7XG4gICAgICB6ID0gLSgtaGUueSArIDIuMCAqIGhlLnkgKiBqIC8gbHMpO1xuICAgICAgdSA9IGkgLyB3cztcbiAgICAgIHYgPSBqIC8gbHM7XG4gICAgICBwb3NpdGlvbnMucHVzaCh4LCB5LCB6KTtcbiAgICAgIG5vcm1hbHMucHVzaCgwLjAsIDEuMCwgMC4wKTtcbiAgICAgIHV2cy5wdXNoKHUsIHYpO1xuICAgICAgaWYgKGkgPCB3cyAmJiBqIDwgbHMpIHtcbiAgICAgICAgaW5kaWNlcy5wdXNoKGogKyBpICogKHdzICsgMSksIGogKyAoaSArIDEpICogKHdzICsgMSksIGogKyBpICogKHdzICsgMSkgKyAxKTtcbiAgICAgICAgaW5kaWNlcy5wdXNoKGogKyAoaSArIDEpICogKHdzICsgMSksIGogKyAoaSArIDEpICogKHdzICsgMSkgKyAxLCBqICsgaSAqICh3cyArIDEpICsgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHZhciBvcHRpb25zID0ge25vcm1hbHM6bm9ybWFscywgdXZzOnV2cywgdXZzMTp1dnMsIGluZGljZXM6aW5kaWNlc307XG4gIGlmIChwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHMpIHtcbiAgICBvcHRpb25zLnRhbmdlbnRzID0gcGMuY2FsY3VsYXRlVGFuZ2VudHMocG9zaXRpb25zLCBub3JtYWxzLCB1dnMsIGluZGljZXMpO1xuICB9XG4gIHJldHVybiBwYy5jcmVhdGVNZXNoKGRldmljZSwgcG9zaXRpb25zLCBvcHRpb25zKTtcbn07XG5wYy5jcmVhdGVCb3ggPSBmdW5jdGlvbihkZXZpY2UsIG9wdHMpIHtcbiAgdmFyIGhlID0gb3B0cyAmJiBvcHRzLmhhbGZFeHRlbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLmhhbGZFeHRlbnRzIDogbmV3IHBjLlZlYzMoMC41LCAwLjUsIDAuNSk7XG4gIHZhciB3cyA9IG9wdHMgJiYgb3B0cy53aWR0aFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRzLndpZHRoU2VnbWVudHMgOiAxO1xuICB2YXIgbHMgPSBvcHRzICYmIG9wdHMubGVuZ3RoU2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMubGVuZ3RoU2VnbWVudHMgOiAxO1xuICB2YXIgaHMgPSBvcHRzICYmIG9wdHMuaGVpZ2h0U2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdHMuaGVpZ2h0U2VnbWVudHMgOiAxO1xuICB2YXIgY29ybmVycyA9IFtuZXcgcGMuVmVjMygtaGUueCwgLWhlLnksIGhlLnopLCBuZXcgcGMuVmVjMyhoZS54LCAtaGUueSwgaGUueiksIG5ldyBwYy5WZWMzKGhlLngsIGhlLnksIGhlLnopLCBuZXcgcGMuVmVjMygtaGUueCwgaGUueSwgaGUueiksIG5ldyBwYy5WZWMzKGhlLngsIC1oZS55LCAtaGUueiksIG5ldyBwYy5WZWMzKC1oZS54LCAtaGUueSwgLWhlLnopLCBuZXcgcGMuVmVjMygtaGUueCwgaGUueSwgLWhlLnopLCBuZXcgcGMuVmVjMyhoZS54LCBoZS55LCAtaGUueildO1xuICB2YXIgZmFjZUF4ZXMgPSBbWzAsIDEsIDNdLCBbNCwgNSwgN10sIFszLCAyLCA2XSwgWzEsIDAsIDRdLCBbMSwgNCwgMl0sIFs1LCAwLCA2XV07XG4gIHZhciBmYWNlTm9ybWFscyA9IFtbMCwgMCwgMV0sIFswLCAwLCAtMV0sIFswLCAxLCAwXSwgWzAsIC0xLCAwXSwgWzEsIDAsIDBdLCBbLTEsIDAsIDBdXTtcbiAgdmFyIHNpZGVzID0ge0ZST05UOjAsIEJBQ0s6MSwgVE9QOjIsIEJPVFRPTTozLCBSSUdIVDo0LCBMRUZUOjV9O1xuICB2YXIgc2lkZSwgaSwgajtcbiAgdmFyIHBvc2l0aW9ucyA9IFtdO1xuICB2YXIgbm9ybWFscyA9IFtdO1xuICB2YXIgdXZzID0gW107XG4gIHZhciB1dnMxID0gW107XG4gIHZhciBpbmRpY2VzID0gW107XG4gIHZhciBnZW5lcmF0ZUZhY2UgPSBmdW5jdGlvbihzaWRlLCB1U2VnbWVudHMsIHZTZWdtZW50cykge1xuICAgIHZhciB4LCB5LCB6LCB1LCB2O1xuICAgIHZhciBpLCBqO1xuICAgIHZhciBvZmZzZXQgPSBwb3NpdGlvbnMubGVuZ3RoIC8gMztcbiAgICBmb3IgKGkgPSAwO2kgPD0gdVNlZ21lbnRzO2krKykge1xuICAgICAgZm9yIChqID0gMDtqIDw9IHZTZWdtZW50cztqKyspIHtcbiAgICAgICAgdmFyIHRlbXAxID0gbmV3IHBjLlZlYzM7XG4gICAgICAgIHZhciB0ZW1wMiA9IG5ldyBwYy5WZWMzO1xuICAgICAgICB2YXIgdGVtcDMgPSBuZXcgcGMuVmVjMztcbiAgICAgICAgdmFyIHIgPSBuZXcgcGMuVmVjMztcbiAgICAgICAgdGVtcDEubGVycChjb3JuZXJzW2ZhY2VBeGVzW3NpZGVdWzBdXSwgY29ybmVyc1tmYWNlQXhlc1tzaWRlXVsxXV0sIGkgLyB1U2VnbWVudHMpO1xuICAgICAgICB0ZW1wMi5sZXJwKGNvcm5lcnNbZmFjZUF4ZXNbc2lkZV1bMF1dLCBjb3JuZXJzW2ZhY2VBeGVzW3NpZGVdWzJdXSwgaiAvIHZTZWdtZW50cyk7XG4gICAgICAgIHRlbXAzLnN1YjIodGVtcDIsIGNvcm5lcnNbZmFjZUF4ZXNbc2lkZV1bMF1dKTtcbiAgICAgICAgci5hZGQyKHRlbXAxLCB0ZW1wMyk7XG4gICAgICAgIHUgPSBpIC8gdVNlZ21lbnRzO1xuICAgICAgICB2ID0gaiAvIHZTZWdtZW50cztcbiAgICAgICAgcG9zaXRpb25zLnB1c2goci54LCByLnksIHIueik7XG4gICAgICAgIG5vcm1hbHMucHVzaChmYWNlTm9ybWFsc1tzaWRlXVswXSwgZmFjZU5vcm1hbHNbc2lkZV1bMV0sIGZhY2VOb3JtYWxzW3NpZGVdWzJdKTtcbiAgICAgICAgdXZzLnB1c2godSwgdik7XG4gICAgICAgIHUgLz0gMztcbiAgICAgICAgdiAvPSAzO1xuICAgICAgICB1ID0gdSAqIHByaW1pdGl2ZVV2MVBhZGRpbmdTY2FsZSArIHByaW1pdGl2ZVV2MVBhZGRpbmc7XG4gICAgICAgIHYgPSB2ICogcHJpbWl0aXZlVXYxUGFkZGluZ1NjYWxlICsgcHJpbWl0aXZlVXYxUGFkZGluZztcbiAgICAgICAgdSArPSBzaWRlICUgMyAvIDM7XG4gICAgICAgIHYgKz0gTWF0aC5mbG9vcihzaWRlIC8gMykgLyAzO1xuICAgICAgICB1dnMxLnB1c2godSwgdik7XG4gICAgICAgIGlmIChpIDwgdVNlZ21lbnRzICYmIGogPCB2U2VnbWVudHMpIHtcbiAgICAgICAgICBpbmRpY2VzLnB1c2gob2Zmc2V0ICsgaiArIGkgKiAodVNlZ21lbnRzICsgMSksIG9mZnNldCArIGogKyAoaSArIDEpICogKHVTZWdtZW50cyArIDEpLCBvZmZzZXQgKyBqICsgaSAqICh1U2VnbWVudHMgKyAxKSArIDEpO1xuICAgICAgICAgIGluZGljZXMucHVzaChvZmZzZXQgKyBqICsgKGkgKyAxKSAqICh1U2VnbWVudHMgKyAxKSwgb2Zmc2V0ICsgaiArIChpICsgMSkgKiAodVNlZ21lbnRzICsgMSkgKyAxLCBvZmZzZXQgKyBqICsgaSAqICh1U2VnbWVudHMgKyAxKSArIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBnZW5lcmF0ZUZhY2Uoc2lkZXMuRlJPTlQsIHdzLCBocyk7XG4gIGdlbmVyYXRlRmFjZShzaWRlcy5CQUNLLCB3cywgaHMpO1xuICBnZW5lcmF0ZUZhY2Uoc2lkZXMuVE9QLCB3cywgbHMpO1xuICBnZW5lcmF0ZUZhY2Uoc2lkZXMuQk9UVE9NLCB3cywgbHMpO1xuICBnZW5lcmF0ZUZhY2Uoc2lkZXMuUklHSFQsIGxzLCBocyk7XG4gIGdlbmVyYXRlRmFjZShzaWRlcy5MRUZULCBscywgaHMpO1xuICB2YXIgb3B0aW9ucyA9IHtub3JtYWxzOm5vcm1hbHMsIHV2czp1dnMsIHV2czE6dXZzMSwgaW5kaWNlczppbmRpY2VzfTtcbiAgaWYgKHBjLnByZWNhbGN1bGF0ZWRUYW5nZW50cykge1xuICAgIG9wdGlvbnMudGFuZ2VudHMgPSBwYy5jYWxjdWxhdGVUYW5nZW50cyhwb3NpdGlvbnMsIG5vcm1hbHMsIHV2cywgaW5kaWNlcyk7XG4gIH1cbiAgcmV0dXJuIHBjLmNyZWF0ZU1lc2goZGV2aWNlLCBwb3NpdGlvbnMsIG9wdGlvbnMpO1xufTtcbnBjLlNjZW5lLmRlZmF1bHRNYXRlcmlhbCA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xucGMuU2NlbmUuZGVmYXVsdE1hdGVyaWFsLnNoYWRpbmdNb2RlbCA9IHBjLlNQRUNVTEFSX0JMSU5OO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEtleSA9IGZ1bmN0aW9uIEtleSh0aW1lLCBwb3NpdGlvbiwgcm90YXRpb24sIHNjYWxlKSB7XG4gICAgdGhpcy50aW1lID0gdGltZTtcbiAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgdGhpcy5yb3RhdGlvbiA9IHJvdGF0aW9uO1xuICAgIHRoaXMuc2NhbGUgPSBzY2FsZTtcbiAgfTtcbiAgdmFyIE5vZGUgPSBmdW5jdGlvbiBOb2RlKCkge1xuICAgIHRoaXMuX25hbWUgPSBcIlwiO1xuICAgIHRoaXMuX2tleXMgPSBbXTtcbiAgfTtcbiAgdmFyIEFuaW1hdGlvbiA9IGZ1bmN0aW9uIEFuaW1hdGlvbigpIHtcbiAgICB0aGlzLm5hbWUgPSBcIlwiO1xuICAgIHRoaXMuZHVyYXRpb24gPSAwO1xuICAgIHRoaXMuX25vZGVzID0gW107XG4gICAgdGhpcy5fbm9kZURpY3QgPSB7fTtcbiAgfTtcbiAgQW5pbWF0aW9uLnByb3RvdHlwZS5nZXREdXJhdGlvbiA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmR1cmF0aW9uO1xuICB9O1xuICBBbmltYXRpb24ucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5uYW1lO1xuICB9O1xuICBBbmltYXRpb24ucHJvdG90eXBlLmdldE5vZGUgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX25vZGVEaWN0W25hbWVdO1xuICB9O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQW5pbWF0aW9uLnByb3RvdHlwZSwgXCJub2Rlc1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9ub2RlcztcbiAgfX0pO1xuICBBbmltYXRpb24ucHJvdG90eXBlLmdldE5vZGVzID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX25vZGVzO1xuICB9O1xuICBBbmltYXRpb24ucHJvdG90eXBlLnNldER1cmF0aW9uID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLmR1cmF0aW9uID0gdmFsdWU7XG4gIH07XG4gIEFuaW1hdGlvbi5wcm90b3R5cGUuc2V0TmFtZSA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5uYW1lID0gdmFsdWU7XG4gIH07XG4gIEFuaW1hdGlvbi5wcm90b3R5cGUuYWRkTm9kZSA9IGZ1bmN0aW9uKG5vZGUpIHtcbiAgICB0aGlzLl9ub2Rlcy5wdXNoKG5vZGUpO1xuICAgIHRoaXMuX25vZGVEaWN0W25vZGUuX25hbWVdID0gbm9kZTtcbiAgfTtcbiAgcmV0dXJuIHtBbmltYXRpb246QW5pbWF0aW9uLCBLZXk6S2V5LCBOb2RlOk5vZGV9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIEludGVycG9sYXRlZEtleSgpIHtcbiAgICB0aGlzLl93cml0dGVuID0gZmFsc2U7XG4gICAgdGhpcy5fbmFtZSA9IFwiXCI7XG4gICAgdGhpcy5fa2V5RnJhbWVzID0gW107XG4gICAgdGhpcy5fcXVhdCA9IG5ldyBwYy5RdWF0O1xuICAgIHRoaXMuX3BvcyA9IG5ldyBwYy5WZWMzO1xuICAgIHRoaXMuX3NjYWxlID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5fdGFyZ2V0Tm9kZSA9IG51bGw7XG4gIH1cbiAgSW50ZXJwb2xhdGVkS2V5LnByb3RvdHlwZSA9IHtnZXRUYXJnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RhcmdldE5vZGU7XG4gIH0sIHNldFRhcmdldDpmdW5jdGlvbihub2RlKSB7XG4gICAgdGhpcy5fdGFyZ2V0Tm9kZSA9IG5vZGU7XG4gIH19O1xuICB2YXIgU2tlbGV0b24gPSBmdW5jdGlvbiBTa2VsZXRvbihncmFwaCkge1xuICAgIHRoaXMuX2FuaW1hdGlvbiA9IG51bGw7XG4gICAgdGhpcy5fdGltZSA9IDA7XG4gICAgdGhpcy5sb29waW5nID0gdHJ1ZTtcbiAgICB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzID0gW107XG4gICAgdGhpcy5faW50ZXJwb2xhdGVkS2V5RGljdCA9IHt9O1xuICAgIHRoaXMuX2N1cnJLZXlJbmRpY2VzID0ge307XG4gICAgdGhpcy5ncmFwaCA9IG51bGw7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGZ1bmN0aW9uIGFkZEludGVycG9sYXRlZEtleXMobm9kZSkge1xuICAgICAgdmFyIGludGVycEtleSA9IG5ldyBJbnRlcnBvbGF0ZWRLZXk7XG4gICAgICBpbnRlcnBLZXkuX25hbWUgPSBub2RlLm5hbWU7XG4gICAgICBzZWxmLl9pbnRlcnBvbGF0ZWRLZXlzLnB1c2goaW50ZXJwS2V5KTtcbiAgICAgIHNlbGYuX2ludGVycG9sYXRlZEtleURpY3Rbbm9kZS5uYW1lXSA9IGludGVycEtleTtcbiAgICAgIHNlbGYuX2N1cnJLZXlJbmRpY2VzW25vZGUubmFtZV0gPSAwO1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDtpKyspIHtcbiAgICAgICAgYWRkSW50ZXJwb2xhdGVkS2V5cyhub2RlLl9jaGlsZHJlbltpXSk7XG4gICAgICB9XG4gICAgfVxuICAgIGFkZEludGVycG9sYXRlZEtleXMoZ3JhcGgpO1xuICB9O1xuICBTa2VsZXRvbi5wcm90b3R5cGUuYWRkVGltZSA9IGZ1bmN0aW9uKGRlbHRhKSB7XG4gICAgaWYgKHRoaXMuX2FuaW1hdGlvbiAhPT0gbnVsbCkge1xuICAgICAgdmFyIGk7XG4gICAgICB2YXIgbm9kZSwgbm9kZU5hbWU7XG4gICAgICB2YXIga2V5cywgaW50ZXJwS2V5O1xuICAgICAgdmFyIGsxLCBrMiwgYWxwaGE7XG4gICAgICB2YXIgbm9kZXMgPSB0aGlzLl9hbmltYXRpb24uX25vZGVzO1xuICAgICAgdmFyIGR1cmF0aW9uID0gdGhpcy5fYW5pbWF0aW9uLmR1cmF0aW9uO1xuICAgICAgaWYgKHRoaXMuX3RpbWUgPT09IGR1cmF0aW9uICYmICF0aGlzLmxvb3BpbmcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5fdGltZSArPSBkZWx0YTtcbiAgICAgIGlmICh0aGlzLl90aW1lID4gZHVyYXRpb24pIHtcbiAgICAgICAgdGhpcy5fdGltZSA9IHRoaXMubG9vcGluZyA/IDAuMCA6IGR1cmF0aW9uO1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCBub2Rlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgbm9kZSA9IG5vZGVzW2ldO1xuICAgICAgICAgIG5vZGVOYW1lID0gbm9kZS5fbmFtZTtcbiAgICAgICAgICB0aGlzLl9jdXJyS2V5SW5kaWNlc1tub2RlTmFtZV0gPSAwO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5fdGltZSA8IDApIHtcbiAgICAgICAgICB0aGlzLl90aW1lID0gdGhpcy5sb29waW5nID8gZHVyYXRpb24gOiAwLjA7XG4gICAgICAgICAgZm9yIChpID0gMDtpIDwgbm9kZXMubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgbm9kZSA9IG5vZGVzW2ldO1xuICAgICAgICAgICAgbm9kZU5hbWUgPSBub2RlLl9uYW1lO1xuICAgICAgICAgICAgdGhpcy5fY3VycktleUluZGljZXNbbm9kZU5hbWVdID0gbm9kZS5fa2V5cy5sZW5ndGggLSAyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdmFyIG9mZnNldCA9IGRlbHRhID49IDAgPyAxIDogLTE7XG4gICAgICB2YXIgZm91bmRLZXk7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBub2Rlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIG5vZGUgPSBub2Rlc1tpXTtcbiAgICAgICAgbm9kZU5hbWUgPSBub2RlLl9uYW1lO1xuICAgICAgICBrZXlzID0gbm9kZS5fa2V5cztcbiAgICAgICAgaW50ZXJwS2V5ID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5RGljdFtub2RlTmFtZV07XG4gICAgICAgIGZvdW5kS2V5ID0gZmFsc2U7XG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgICAgIGZvciAodmFyIGN1cnJLZXlJbmRleCA9IHRoaXMuX2N1cnJLZXlJbmRpY2VzW25vZGVOYW1lXTtjdXJyS2V5SW5kZXggPCBrZXlzLmxlbmd0aCAtIDEgJiYgY3VycktleUluZGV4ID49IDA7Y3VycktleUluZGV4ICs9IG9mZnNldCkge1xuICAgICAgICAgICAgazEgPSBrZXlzW2N1cnJLZXlJbmRleF07XG4gICAgICAgICAgICBrMiA9IGtleXNbY3VycktleUluZGV4ICsgMV07XG4gICAgICAgICAgICBpZiAoazEudGltZSA8PSB0aGlzLl90aW1lICYmIGsyLnRpbWUgPj0gdGhpcy5fdGltZSkge1xuICAgICAgICAgICAgICBhbHBoYSA9ICh0aGlzLl90aW1lIC0gazEudGltZSkgLyAoazIudGltZSAtIGsxLnRpbWUpO1xuICAgICAgICAgICAgICBpbnRlcnBLZXkuX3Bvcy5sZXJwKGsxLnBvc2l0aW9uLCBrMi5wb3NpdGlvbiwgYWxwaGEpO1xuICAgICAgICAgICAgICBpbnRlcnBLZXkuX3F1YXQuc2xlcnAoazEucm90YXRpb24sIGsyLnJvdGF0aW9uLCBhbHBoYSk7XG4gICAgICAgICAgICAgIGludGVycEtleS5fc2NhbGUubGVycChrMS5zY2FsZSwgazIuc2NhbGUsIGFscGhhKTtcbiAgICAgICAgICAgICAgaW50ZXJwS2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5fY3VycktleUluZGljZXNbbm9kZU5hbWVdID0gY3VycktleUluZGV4O1xuICAgICAgICAgICAgICBmb3VuZEtleSA9IHRydWU7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDEgfHwgIWZvdW5kS2V5ICYmIHRoaXMuX3RpbWUgPT09IDAuMCAmJiB0aGlzLmxvb3BpbmcpIHtcbiAgICAgICAgICBpbnRlcnBLZXkuX3Bvcy5jb3B5KGtleXNbMF0ucG9zaXRpb24pO1xuICAgICAgICAgIGludGVycEtleS5fcXVhdC5jb3B5KGtleXNbMF0ucm90YXRpb24pO1xuICAgICAgICAgIGludGVycEtleS5fc2NhbGUuY29weShrZXlzWzBdLnNjYWxlKTtcbiAgICAgICAgICBpbnRlcnBLZXkuX3dyaXR0ZW4gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBTa2VsZXRvbi5wcm90b3R5cGUuYmxlbmQgPSBmdW5jdGlvbihza2VsMSwgc2tlbDIsIGFscGhhKSB7XG4gICAgdmFyIG51bU5vZGVzID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG51bU5vZGVzO2krKykge1xuICAgICAgdmFyIGtleTEgPSBza2VsMS5faW50ZXJwb2xhdGVkS2V5c1tpXTtcbiAgICAgIHZhciBrZXkyID0gc2tlbDIuX2ludGVycG9sYXRlZEtleXNbaV07XG4gICAgICB2YXIgZHN0S2V5ID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXTtcbiAgICAgIGlmIChrZXkxLl93cml0dGVuICYmIGtleTIuX3dyaXR0ZW4pIHtcbiAgICAgICAgZHN0S2V5Ll9xdWF0LnNsZXJwKGtleTEuX3F1YXQsIHNrZWwyLl9pbnRlcnBvbGF0ZWRLZXlzW2ldLl9xdWF0LCBhbHBoYSk7XG4gICAgICAgIGRzdEtleS5fcG9zLmxlcnAoa2V5MS5fcG9zLCBza2VsMi5faW50ZXJwb2xhdGVkS2V5c1tpXS5fcG9zLCBhbHBoYSk7XG4gICAgICAgIGRzdEtleS5fc2NhbGUubGVycChrZXkxLl9zY2FsZSwga2V5Mi5fc2NhbGUsIGFscGhhKTtcbiAgICAgICAgZHN0S2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChrZXkxLl93cml0dGVuKSB7XG4gICAgICAgICAgZHN0S2V5Ll9xdWF0LmNvcHkoa2V5MS5fcXVhdCk7XG4gICAgICAgICAgZHN0S2V5Ll9wb3MuY29weShrZXkxLl9wb3MpO1xuICAgICAgICAgIGRzdEtleS5fc2NhbGUuY29weShrZXkxLl9zY2FsZSk7XG4gICAgICAgICAgZHN0S2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoa2V5Mi5fd3JpdHRlbikge1xuICAgICAgICAgICAgZHN0S2V5Ll9xdWF0LmNvcHkoa2V5Mi5fcXVhdCk7XG4gICAgICAgICAgICBkc3RLZXkuX3Bvcy5jb3B5KGtleTIuX3Bvcyk7XG4gICAgICAgICAgICBkc3RLZXkuX3NjYWxlLmNvcHkoa2V5Mi5fc2NhbGUpO1xuICAgICAgICAgICAgZHN0S2V5Ll93cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTa2VsZXRvbi5wcm90b3R5cGUsIFwiYW5pbWF0aW9uXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FuaW1hdGlvbjtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fYW5pbWF0aW9uID0gdmFsdWU7XG4gICAgdGhpcy5jdXJyZW50VGltZSA9IDA7XG4gIH19KTtcbiAgU2tlbGV0b24ucHJvdG90eXBlLmdldEFuaW1hdGlvbiA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9hbmltYXRpb247XG4gIH07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTa2VsZXRvbi5wcm90b3R5cGUsIFwiY3VycmVudFRpbWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdGltZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fdGltZSA9IHZhbHVlO1xuICAgIHZhciBudW1Ob2RlcyA9IHRoaXMuX2ludGVycG9sYXRlZEtleXMubGVuZ3RoO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBudW1Ob2RlcztpKyspIHtcbiAgICAgIHZhciBub2RlID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXTtcbiAgICAgIHZhciBub2RlTmFtZSA9IG5vZGUuX25hbWU7XG4gICAgICB0aGlzLl9jdXJyS2V5SW5kaWNlc1tub2RlTmFtZV0gPSAwO1xuICAgIH1cbiAgICB0aGlzLmFkZFRpbWUoMCk7XG4gICAgdGhpcy51cGRhdGVHcmFwaCgpO1xuICB9fSk7XG4gIFNrZWxldG9uLnByb3RvdHlwZS5nZXRDdXJyZW50VGltZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl90aW1lO1xuICB9O1xuICBTa2VsZXRvbi5wcm90b3R5cGUuc2V0Q3VycmVudFRpbWUgPSBmdW5jdGlvbih0aW1lKSB7XG4gICAgdGhpcy5jdXJyZW50VGltZSA9IHRpbWU7XG4gIH07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTa2VsZXRvbi5wcm90b3R5cGUsIFwibnVtTm9kZXNcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7XG4gIH19KTtcbiAgU2tlbGV0b24ucHJvdG90eXBlLmdldE51bU5vZGVzID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ludGVycG9sYXRlZEtleXMubGVuZ3RoO1xuICB9O1xuICBTa2VsZXRvbi5wcm90b3R5cGUuc2V0QW5pbWF0aW9uID0gZnVuY3Rpb24oYW5pbWF0aW9uKSB7XG4gICAgdGhpcy5hbmltYXRpb24gPSBhbmltYXRpb247XG4gIH07XG4gIFNrZWxldG9uLnByb3RvdHlwZS5zZXRHcmFwaCA9IGZ1bmN0aW9uKGdyYXBoKSB7XG4gICAgdmFyIGk7XG4gICAgdGhpcy5ncmFwaCA9IGdyYXBoO1xuICAgIGlmIChncmFwaCkge1xuICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy5faW50ZXJwb2xhdGVkS2V5cy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIHZhciBpbnRlcnBLZXkgPSB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzW2ldO1xuICAgICAgICB2YXIgZ3JhcGhOb2RlID0gZ3JhcGguZmluZEJ5TmFtZShpbnRlcnBLZXkuX25hbWUpO1xuICAgICAgICB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzW2ldLnNldFRhcmdldChncmFwaE5vZGUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl9pbnRlcnBvbGF0ZWRLZXlzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXS5zZXRUYXJnZXQobnVsbCk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBTa2VsZXRvbi5wcm90b3R5cGUudXBkYXRlR3JhcGggPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5ncmFwaCkge1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX2ludGVycG9sYXRlZEtleXMubGVuZ3RoO2krKykge1xuICAgICAgICB2YXIgaW50ZXJwS2V5ID0gdGhpcy5faW50ZXJwb2xhdGVkS2V5c1tpXTtcbiAgICAgICAgaWYgKGludGVycEtleS5fd3JpdHRlbikge1xuICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSBpbnRlcnBLZXkuZ2V0VGFyZ2V0KCk7XG4gICAgICAgICAgdHJhbnNmb3JtLmxvY2FsUG9zaXRpb24uY29weShpbnRlcnBLZXkuX3Bvcyk7XG4gICAgICAgICAgdHJhbnNmb3JtLmxvY2FsUm90YXRpb24uY29weShpbnRlcnBLZXkuX3F1YXQpO1xuICAgICAgICAgIHRyYW5zZm9ybS5sb2NhbFNjYWxlLmNvcHkoaW50ZXJwS2V5Ll9zY2FsZSk7XG4gICAgICAgICAgaWYgKCF0cmFuc2Zvcm0uX2RpcnR5TG9jYWwpIHtcbiAgICAgICAgICAgIHRyYW5zZm9ybS5fZGlydGlmeSh0cnVlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaW50ZXJwS2V5Ll93cml0dGVuID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIFNrZWxldG9uLnByb3RvdHlwZS5zZXRMb29waW5nID0gZnVuY3Rpb24obG9vcGluZykge1xuICAgIHRoaXMubG9vcGluZyA9IGxvb3Bpbmc7XG4gIH07XG4gIFNrZWxldG9uLnByb3RvdHlwZS5nZXRMb29waW5nID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubG9vcGluZztcbiAgfTtcbiAgcmV0dXJuIHtTa2VsZXRvbjpTa2VsZXRvbn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgZnVuY3Rpb24gaGFzQXVkaW8oKSB7XG4gICAgcmV0dXJuIHR5cGVvZiBBdWRpbyAhPT0gXCJ1bmRlZmluZWRcIjtcbiAgfVxuICBmdW5jdGlvbiBoYXNBdWRpb0NvbnRleHQoKSB7XG4gICAgcmV0dXJuICEhKHR5cGVvZiBBdWRpb0NvbnRleHQgIT09IFwidW5kZWZpbmVkXCIgfHwgdHlwZW9mIHdlYmtpdEF1ZGlvQ29udGV4dCAhPT0gXCJ1bmRlZmluZWRcIik7XG4gIH1cbiAgdmFyIFNvdW5kTWFuYWdlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICBpZiAoaGFzQXVkaW9Db250ZXh0KCkgfHwgb3B0aW9ucy5mb3JjZVdlYkF1ZGlvQXBpKSB7XG4gICAgICBpZiAodHlwZW9mIEF1ZGlvQ29udGV4dCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgQXVkaW9Db250ZXh0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHR5cGVvZiB3ZWJraXRBdWRpb0NvbnRleHQgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgd2Via2l0QXVkaW9Db250ZXh0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5jb250ZXh0KSB7XG4gICAgICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0O1xuICAgICAgICBpZiAocGMucGxhdGZvcm0uaW9zKSB7XG4gICAgICAgICAgdmFyIHVubG9jayA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdmFyIGJ1ZmZlciA9IGNvbnRleHQuY3JlYXRlQnVmZmVyKDEsIDEsIDQ0MTAwKTtcbiAgICAgICAgICAgIHZhciBzb3VyY2UgPSBjb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO1xuICAgICAgICAgICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgICAgICAgIHNvdXJjZS5jb25uZWN0KGNvbnRleHQuZGVzdGluYXRpb24pO1xuICAgICAgICAgICAgc291cmNlLnN0YXJ0KDApO1xuICAgICAgICAgICAgc291cmNlLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgdW5sb2NrKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgdW5sb2NrKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJObyBzdXBwb3J0IGZvciAzRCBhdWRpbyBmb3VuZFwiKTtcbiAgICB9XG4gICAgaWYgKCFoYXNBdWRpbygpKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJObyBzdXBwb3J0IGZvciAyRCBhdWRpbyBmb3VuZFwiKTtcbiAgICB9XG4gICAgdGhpcy5saXN0ZW5lciA9IG5ldyBwYy5MaXN0ZW5lcih0aGlzKTtcbiAgICB0aGlzLl92b2x1bWUgPSAxO1xuICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgfTtcbiAgU291bmRNYW5hZ2VyLmhhc0F1ZGlvID0gaGFzQXVkaW87XG4gIFNvdW5kTWFuYWdlci5oYXNBdWRpb0NvbnRleHQgPSBoYXNBdWRpb0NvbnRleHQ7XG4gIFNvdW5kTWFuYWdlci5wcm90b3R5cGUgPSB7c3VzcGVuZDpmdW5jdGlvbigpIHtcbiAgICB0aGlzLnN1c3BlbmRlZCA9IHRydWU7XG4gICAgdGhpcy5maXJlKFwic3VzcGVuZFwiKTtcbiAgfSwgcmVzdW1lOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgdGhpcy5maXJlKFwicmVzdW1lXCIpO1xuICB9LCBkZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZmlyZShcImRlc3Ryb3lcIik7XG4gICAgaWYgKHRoaXMuY29udGV4dCAmJiB0aGlzLmNvbnRleHQuY2xvc2UpIHtcbiAgICAgIHRoaXMuY29udGV4dC5jbG9zZSgpO1xuICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDtcbiAgICB9XG4gIH0sIGdldExpc3RlbmVyOmZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUud2FybignREVQUkVDQVRFRDogZ2V0TGlzdGVuZXIgaXMgZGVwcmVjYXRlZC4gR2V0IHRoZSBcImxpc3RlbmVyXCIgZmllbGQgaW5zdGVhZC4nKTtcbiAgICByZXR1cm4gdGhpcy5saXN0ZW5lcjtcbiAgfSwgZ2V0Vm9sdW1lOmZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUud2FybignREVQUkVDQVRFRDogZ2V0Vm9sdW1lIGlzIGRlcHJlY2F0ZWQuIEdldCB0aGUgXCJ2b2x1bWVcIiBwcm9wZXJ0eSBpbnN0ZWFkLicpO1xuICAgIHJldHVybiB0aGlzLnZvbHVtZTtcbiAgfSwgc2V0Vm9sdW1lOmZ1bmN0aW9uKHZvbHVtZSkge1xuICAgIGNvbnNvbGUud2FybignREVQUkVDQVRFRDogc2V0Vm9sdW1lIGlzIGRlcHJlY2F0ZWQuIFNldCB0aGUgXCJ2b2x1bWVcIiBwcm9wZXJ0eSBpbnN0ZWFkLicpO1xuICAgIHRoaXMudm9sdW1lID0gdm9sdW1lO1xuICB9LCBwbGF5U291bmQ6ZnVuY3Rpb24oc291bmQsIG9wdGlvbnMpIHtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICB2YXIgY2hhbm5lbCA9IG51bGw7XG4gICAgaWYgKHBjLkNoYW5uZWwpIHtcbiAgICAgIGNoYW5uZWwgPSBuZXcgcGMuQ2hhbm5lbCh0aGlzLCBzb3VuZCwgb3B0aW9ucyk7XG4gICAgICBjaGFubmVsLnBsYXkoKTtcbiAgICB9XG4gICAgcmV0dXJuIGNoYW5uZWw7XG4gIH0sIHBsYXlTb3VuZDNkOmZ1bmN0aW9uKHNvdW5kLCBwb3NpdGlvbiwgb3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIHZhciBjaGFubmVsID0gbnVsbDtcbiAgICBpZiAocGMuQ2hhbm5lbDNkKSB7XG4gICAgICBjaGFubmVsID0gbmV3IHBjLkNoYW5uZWwzZCh0aGlzLCBzb3VuZCwgb3B0aW9ucyk7XG4gICAgICBjaGFubmVsLnNldFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICAgIGlmIChvcHRpb25zLnZvbHVtZSkge1xuICAgICAgICBjaGFubmVsLnNldFZvbHVtZShvcHRpb25zLnZvbHVtZSk7XG4gICAgICB9XG4gICAgICBpZiAob3B0aW9ucy5sb29wKSB7XG4gICAgICAgIGNoYW5uZWwuc2V0TG9vcChvcHRpb25zLmxvb3ApO1xuICAgICAgfVxuICAgICAgaWYgKG9wdGlvbnMubWF4RGlzdGFuY2UpIHtcbiAgICAgICAgY2hhbm5lbC5zZXRNYXhEaXN0YW5jZShvcHRpb25zLm1heERpc3RhbmNlKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcHRpb25zLm1pbkRpc3RhbmNlKSB7XG4gICAgICAgIGNoYW5uZWwuc2V0TWluRGlzdGFuY2Uob3B0aW9ucy5taW5EaXN0YW5jZSk7XG4gICAgICB9XG4gICAgICBpZiAob3B0aW9ucy5yb2xsT2ZmRmFjdG9yKSB7XG4gICAgICAgIGNoYW5uZWwuc2V0Um9sbE9mZkZhY3RvcihvcHRpb25zLnJvbGxPZmZGYWN0b3IpO1xuICAgICAgfVxuICAgICAgaWYgKG9wdGlvbnMuZGlzdGFuY2VNb2RlbCkge1xuICAgICAgICBjaGFubmVsLnNldERpc3RhbmNlTW9kZWwob3B0aW9ucy5kaXN0YW5jZU1vZGVsKTtcbiAgICAgIH1cbiAgICAgIGNoYW5uZWwucGxheSgpO1xuICAgIH1cbiAgICByZXR1cm4gY2hhbm5lbDtcbiAgfX07XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZE1hbmFnZXIucHJvdG90eXBlLCBcInZvbHVtZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl92b2x1bWU7XG4gIH0sIHNldDpmdW5jdGlvbih2b2x1bWUpIHtcbiAgICB2b2x1bWUgPSBwYy5tYXRoLmNsYW1wKHZvbHVtZSwgMCwgMSk7XG4gICAgdGhpcy5fdm9sdW1lID0gdm9sdW1lO1xuICAgIHRoaXMuZmlyZShcInZvbHVtZWNoYW5nZVwiLCB2b2x1bWUpO1xuICB9fSk7XG4gIHBjLkF1ZGlvTWFuYWdlciA9IFNvdW5kTWFuYWdlcjtcbiAgcmV0dXJuIHtTb3VuZE1hbmFnZXI6U291bmRNYW5hZ2VyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgU291bmQgPSBmdW5jdGlvbihyZXNvdXJjZSkge1xuICAgIGlmIChyZXNvdXJjZSBpbnN0YW5jZW9mIEF1ZGlvKSB7XG4gICAgICB0aGlzLmF1ZGlvID0gcmVzb3VyY2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYnVmZmVyID0gcmVzb3VyY2U7XG4gICAgfVxuICB9O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmQucHJvdG90eXBlLCBcImR1cmF0aW9uXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGR1cmF0aW9uID0gMDtcbiAgICBpZiAodGhpcy5idWZmZXIpIHtcbiAgICAgIGR1cmF0aW9uID0gdGhpcy5idWZmZXIuZHVyYXRpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmF1ZGlvKSB7XG4gICAgICAgIGR1cmF0aW9uID0gdGhpcy5hdWRpby5kdXJhdGlvbjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGR1cmF0aW9uIHx8IDA7XG4gIH19KTtcbiAgcmV0dXJuIHtTb3VuZDpTb3VuZH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIExpc3RlbmVyID0gZnVuY3Rpb24obWFuYWdlcikge1xuICAgIHRoaXMucG9zaXRpb24gPSBuZXcgcGMuVmVjMztcbiAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5vcmllbnRhdGlvbiA9IG5ldyBwYy5NYXQ0O1xuICAgIGlmIChwYy5BdWRpb01hbmFnZXIuaGFzQXVkaW9Db250ZXh0KCkpIHtcbiAgICAgIHRoaXMubGlzdGVuZXIgPSBtYW5hZ2VyLmNvbnRleHQubGlzdGVuZXI7XG4gICAgfVxuICB9O1xuICBMaXN0ZW5lci5wcm90b3R5cGUgPSB7Z2V0UG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucG9zaXRpb247XG4gIH0sIHNldFBvc2l0aW9uOmZ1bmN0aW9uKHBvc2l0aW9uKSB7XG4gICAgdGhpcy5wb3NpdGlvbi5jb3B5KHBvc2l0aW9uKTtcbiAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgdGhpcy5saXN0ZW5lci5zZXRQb3NpdGlvbihwb3NpdGlvbi54LCBwb3NpdGlvbi55LCBwb3NpdGlvbi56KTtcbiAgICB9XG4gIH0sIGdldFZlbG9jaXR5OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnZlbG9jaXR5O1xuICB9LCBzZXRWZWxvY2l0eTpmdW5jdGlvbih2ZWxvY2l0eSkge1xuICAgIHRoaXMudmVsb2NpdHkuY29weSh2ZWxvY2l0eSk7XG4gICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgIHRoaXMubGlzdGVuZXIuc2V0UG9zaXRpb24odmVsb2NpdHkueCwgdmVsb2NpdHkueSwgdmVsb2NpdHkueik7XG4gICAgfVxuICB9LCBzZXRPcmllbnRhdGlvbjpmdW5jdGlvbihvcmllbnRhdGlvbikge1xuICAgIHRoaXMub3JpZW50YXRpb24uY29weShvcmllbnRhdGlvbik7XG4gICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgIHRoaXMubGlzdGVuZXIuc2V0T3JpZW50YXRpb24oLW9yaWVudGF0aW9uLmRhdGFbOF0sIC1vcmllbnRhdGlvbi5kYXRhWzldLCAtb3JpZW50YXRpb24uZGF0YVsxMF0sIG9yaWVudGF0aW9uLmRhdGFbNF0sIG9yaWVudGF0aW9uLmRhdGFbNV0sIG9yaWVudGF0aW9uLmRhdGFbNl0pO1xuICAgIH1cbiAgfSwgZ2V0T3JpZW50YXRpb246ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb247XG4gIH19O1xuICByZXR1cm4ge0xpc3RlbmVyOkxpc3RlbmVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgU291bmRJbnN0YW5jZTtcbiAgdmFyIFNUQVRFX1BMQVlJTkcgPSAwO1xuICB2YXIgU1RBVEVfUEFVU0VEID0gMTtcbiAgdmFyIFNUQVRFX1NUT1BQRUQgPSAyO1xuICB2YXIgY2FwVGltZSA9IGZ1bmN0aW9uKHRpbWUsIGR1cmF0aW9uKSB7XG4gICAgcmV0dXJuIHRpbWUgJSBkdXJhdGlvbiB8fCAwO1xuICB9O1xuICBpZiAocGMuU291bmRNYW5hZ2VyLmhhc0F1ZGlvQ29udGV4dCgpKSB7XG4gICAgU291bmRJbnN0YW5jZSA9IGZ1bmN0aW9uKG1hbmFnZXIsIHNvdW5kLCBvcHRpb25zKSB7XG4gICAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICB0aGlzLl92b2x1bWUgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gcGMubWF0aC5jbGFtcChOdW1iZXIob3B0aW9ucy52b2x1bWUpIHx8IDAsIDAsIDEpIDogMTtcbiAgICAgIHRoaXMuX3BpdGNoID0gb3B0aW9ucy5waXRjaCAhPT0gdW5kZWZpbmVkID8gTWF0aC5tYXgoMC4wMSwgTnVtYmVyKG9wdGlvbnMucGl0Y2gpIHx8IDApIDogMTtcbiAgICAgIHRoaXMuX2xvb3AgPSAhIShvcHRpb25zLmxvb3AgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubG9vcCA6IGZhbHNlKTtcbiAgICAgIHRoaXMuX3NvdW5kID0gc291bmQ7XG4gICAgICB0aGlzLl9zdGF0ZSA9IFNUQVRFX1NUT1BQRUQ7XG4gICAgICB0aGlzLl9zdXNwZW5kZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuX3N1c3BlbmRFbmRFdmVudCA9IGZhbHNlO1xuICAgICAgdGhpcy5fc3VzcGVuZEluc3RhbmNlRXZlbnRzID0gZmFsc2U7XG4gICAgICB0aGlzLl9zdGFydFRpbWUgPSBNYXRoLm1heCgwLCBOdW1iZXIob3B0aW9ucy5zdGFydFRpbWUpIHx8IDApO1xuICAgICAgdGhpcy5fZHVyYXRpb24gPSBNYXRoLm1heCgwLCBOdW1iZXIob3B0aW9ucy5kdXJhdGlvbikgfHwgMCk7XG4gICAgICB0aGlzLl9zdGFydGVkQXQgPSAwO1xuICAgICAgdGhpcy5fc3RhcnRPZmZzZXQgPSBudWxsO1xuICAgICAgdGhpcy5fY3VycmVudFRpbWUgPSAwO1xuICAgICAgdGhpcy5fY3VycmVudE9mZnNldCA9IDA7XG4gICAgICB0aGlzLl9wbGF5V2hlbkxvYWRlZCA9IHRydWU7XG4gICAgICB0aGlzLl9tYW5hZ2VyID0gbWFuYWdlcjtcbiAgICAgIHRoaXMuX2lucHV0Tm9kZSA9IG51bGw7XG4gICAgICB0aGlzLl9jb25uZWN0b3JOb2RlID0gbnVsbDtcbiAgICAgIHRoaXMuX2ZpcnN0Tm9kZSA9IG51bGw7XG4gICAgICB0aGlzLl9sYXN0Tm9kZSA9IG51bGw7XG4gICAgICB0aGlzLl9pbml0aWFsaXplTm9kZXMoKTtcbiAgICAgIHRoaXMuX29uUGxheUNhbGxiYWNrID0gb3B0aW9ucy5vblBsYXk7XG4gICAgICB0aGlzLl9vblBhdXNlQ2FsbGJhY2sgPSBvcHRpb25zLm9uUGF1c2U7XG4gICAgICB0aGlzLl9vblJlc3VtZUNhbGxiYWNrID0gb3B0aW9ucy5vblJlc3VtZTtcbiAgICAgIHRoaXMuX29uU3RvcENhbGxiYWNrID0gb3B0aW9ucy5vblN0b3A7XG4gICAgICB0aGlzLl9vbkVuZENhbGxiYWNrID0gb3B0aW9ucy5vbkVuZDtcbiAgICAgIHRoaXMuX2VuZGVkSGFuZGxlciA9IHRoaXMuX29uRW5kZWQuYmluZCh0aGlzKTtcbiAgICAgIHRoaXMuc291cmNlID0gbnVsbDtcbiAgICB9O1xuICAgIFNvdW5kSW5zdGFuY2UucHJvdG90eXBlID0ge19pbml0aWFsaXplTm9kZXM6ZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLmdhaW4gPSB0aGlzLl9tYW5hZ2VyLmNvbnRleHQuY3JlYXRlR2FpbigpO1xuICAgICAgdGhpcy5faW5wdXROb2RlID0gdGhpcy5nYWluO1xuICAgICAgdGhpcy5fY29ubmVjdG9yTm9kZSA9IHRoaXMuZ2FpbjtcbiAgICAgIHRoaXMuX2Nvbm5lY3Rvck5vZGUuY29ubmVjdCh0aGlzLl9tYW5hZ2VyLmNvbnRleHQuZGVzdGluYXRpb24pO1xuICAgIH0sIHBsYXk6ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5fc3RhdGUgIT09IFNUQVRFX1NUT1BQRUQpIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuc291cmNlKSB7XG4gICAgICAgIHRoaXMuX2NyZWF0ZVNvdXJjZSgpO1xuICAgICAgfVxuICAgICAgdmFyIG9mZnNldCA9IGNhcFRpbWUodGhpcy5fc3RhcnRPZmZzZXQsIHRoaXMuZHVyYXRpb24pO1xuICAgICAgb2Zmc2V0ID0gY2FwVGltZSh0aGlzLl9zdGFydFRpbWUgKyBvZmZzZXQsIHRoaXMuX3NvdW5kLmR1cmF0aW9uKTtcbiAgICAgIHRoaXMuX3N0YXJ0T2Zmc2V0ID0gbnVsbDtcbiAgICAgIGlmICh0aGlzLl9kdXJhdGlvbikge1xuICAgICAgICB0aGlzLnNvdXJjZS5zdGFydCgwLCBvZmZzZXQsIHRoaXMuX2R1cmF0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc291cmNlLnN0YXJ0KDAsIG9mZnNldCk7XG4gICAgICB9XG4gICAgICB0aGlzLl9zdGFydGVkQXQgPSB0aGlzLl9tYW5hZ2VyLmNvbnRleHQuY3VycmVudFRpbWU7XG4gICAgICB0aGlzLl9jdXJyZW50VGltZSA9IDA7XG4gICAgICB0aGlzLl9jdXJyZW50T2Zmc2V0ID0gb2Zmc2V0O1xuICAgICAgdGhpcy5fc3RhdGUgPSBTVEFURV9QTEFZSU5HO1xuICAgICAgdGhpcy5fcGxheVdoZW5Mb2FkZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMudm9sdW1lID0gdGhpcy5fdm9sdW1lO1xuICAgICAgdGhpcy5sb29wID0gdGhpcy5fbG9vcDtcbiAgICAgIHRoaXMucGl0Y2ggPSB0aGlzLl9waXRjaDtcbiAgICAgIHRoaXMuX21hbmFnZXIub24oXCJ2b2x1bWVjaGFuZ2VcIiwgdGhpcy5fb25NYW5hZ2VyVm9sdW1lQ2hhbmdlLCB0aGlzKTtcbiAgICAgIHRoaXMuX21hbmFnZXIub24oXCJzdXNwZW5kXCIsIHRoaXMuX29uTWFuYWdlclN1c3BlbmQsIHRoaXMpO1xuICAgICAgdGhpcy5fbWFuYWdlci5vbihcInJlc3VtZVwiLCB0aGlzLl9vbk1hbmFnZXJSZXN1bWUsIHRoaXMpO1xuICAgICAgdGhpcy5fbWFuYWdlci5vbihcImRlc3Ryb3lcIiwgdGhpcy5fb25NYW5hZ2VyRGVzdHJveSwgdGhpcyk7XG4gICAgICBpZiAodGhpcy5fbWFuYWdlci5zdXNwZW5kZWQpIHtcbiAgICAgICAgdGhpcy5fb25NYW5hZ2VyU3VzcGVuZCgpO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMpIHtcbiAgICAgICAgdGhpcy5fb25QbGF5KCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LCBwYXVzZTpmdW5jdGlvbigpIHtcbiAgICAgIGlmICh0aGlzLl9zdGF0ZSAhPT0gU1RBVEVfUExBWUlORyB8fCAhdGhpcy5zb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhpcy5fdXBkYXRlQ3VycmVudFRpbWUoKTtcbiAgICAgIHRoaXMuX3N0YXRlID0gU1RBVEVfUEFVU0VEO1xuICAgICAgdGhpcy5fc3VzcGVuZEVuZEV2ZW50ID0gdHJ1ZTtcbiAgICAgIHRoaXMuc291cmNlLnN0b3AoMCk7XG4gICAgICB0aGlzLnNvdXJjZSA9IG51bGw7XG4gICAgICB0aGlzLl9wbGF5V2hlbkxvYWRlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5fc3RhcnRPZmZzZXQgPSBudWxsO1xuICAgICAgaWYgKCF0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMpIHtcbiAgICAgICAgdGhpcy5fb25QYXVzZSgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSwgcmVzdW1lOmZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBTVEFURV9QQVVTRUQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLnNvdXJjZSkge1xuICAgICAgICB0aGlzLl9jcmVhdGVTb3VyY2UoKTtcbiAgICAgIH1cbiAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmN1cnJlbnRUaW1lO1xuICAgICAgaWYgKHRoaXMuX3N0YXJ0T2Zmc2V0ICE9PSBudWxsKSB7XG4gICAgICAgIG9mZnNldCA9IGNhcFRpbWUodGhpcy5fc3RhcnRPZmZzZXQsIHRoaXMuZHVyYXRpb24pO1xuICAgICAgICBvZmZzZXQgPSBjYXBUaW1lKHRoaXMuX3N0YXJ0VGltZSArIG9mZnNldCwgdGhpcy5fc291bmQuZHVyYXRpb24pO1xuICAgICAgICB0aGlzLl9zdGFydE9mZnNldCA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fZHVyYXRpb24pIHtcbiAgICAgICAgdGhpcy5zb3VyY2Uuc3RhcnQoMCwgb2Zmc2V0LCB0aGlzLl9kdXJhdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNvdXJjZS5zdGFydCgwLCBvZmZzZXQpO1xuICAgICAgfVxuICAgICAgdGhpcy5fc3RhdGUgPSBTVEFURV9QTEFZSU5HO1xuICAgICAgdGhpcy5fc3RhcnRlZEF0ID0gdGhpcy5fbWFuYWdlci5jb250ZXh0LmN1cnJlbnRUaW1lO1xuICAgICAgdGhpcy5fY3VycmVudE9mZnNldCA9IG9mZnNldDtcbiAgICAgIHRoaXMudm9sdW1lID0gdGhpcy5fdm9sdW1lO1xuICAgICAgdGhpcy5sb29wID0gdGhpcy5fbG9vcDtcbiAgICAgIHRoaXMucGl0Y2ggPSB0aGlzLl9waXRjaDtcbiAgICAgIHRoaXMuX3BsYXlXaGVuTG9hZGVkID0gZmFsc2U7XG4gICAgICBpZiAoIXRoaXMuX3N1c3BlbmRJbnN0YW5jZUV2ZW50cykge1xuICAgICAgICB0aGlzLl9vblJlc3VtZSgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSwgc3RvcDpmdW5jdGlvbigpIHtcbiAgICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gU1RBVEVfU1RPUFBFRCB8fCAhdGhpcy5zb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhpcy5fbWFuYWdlci5vZmYoXCJ2b2x1bWVjaGFuZ2VcIiwgdGhpcy5fb25NYW5hZ2VyVm9sdW1lQ2hhbmdlLCB0aGlzKTtcbiAgICAgIHRoaXMuX21hbmFnZXIub2ZmKFwic3VzcGVuZFwiLCB0aGlzLl9vbk1hbmFnZXJTdXNwZW5kLCB0aGlzKTtcbiAgICAgIHRoaXMuX21hbmFnZXIub2ZmKFwicmVzdW1lXCIsIHRoaXMuX29uTWFuYWdlclJlc3VtZSwgdGhpcyk7XG4gICAgICB0aGlzLl9tYW5hZ2VyLm9mZihcImRlc3Ryb3lcIiwgdGhpcy5fb25NYW5hZ2VyRGVzdHJveSwgdGhpcyk7XG4gICAgICB0aGlzLl9zdGFydGVkQXQgPSAwO1xuICAgICAgdGhpcy5fY3VycmVudFRpbWUgPSAwO1xuICAgICAgdGhpcy5fY3VycmVudE9mZnNldCA9IDA7XG4gICAgICB0aGlzLl9zdGFydE9mZnNldCA9IG51bGw7XG4gICAgICB0aGlzLl9wbGF5V2hlbkxvYWRlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5fc3VzcGVuZEVuZEV2ZW50ID0gdHJ1ZTtcbiAgICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gU1RBVEVfUExBWUlORykge1xuICAgICAgICB0aGlzLnNvdXJjZS5zdG9wKDApO1xuICAgICAgfVxuICAgICAgdGhpcy5zb3VyY2UgPSBudWxsO1xuICAgICAgdGhpcy5fc3RhdGUgPSBTVEFURV9TVE9QUEVEO1xuICAgICAgaWYgKCF0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMpIHtcbiAgICAgICAgdGhpcy5fb25TdG9wKCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LCBzZXRFeHRlcm5hbE5vZGVzOmZ1bmN0aW9uKGZpcnN0Tm9kZSwgbGFzdE5vZGUpIHtcbiAgICAgIGlmICghZmlyc3ROb2RlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJUaGUgZmlyc3ROb2RlIG11c3QgYmUgYSB2YWxpZCBBdWRpbyBOb2RlXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoIWxhc3ROb2RlKSB7XG4gICAgICAgIGxhc3ROb2RlID0gZmlyc3ROb2RlO1xuICAgICAgfVxuICAgICAgdmFyIHNwZWFrZXJzID0gdGhpcy5fbWFuYWdlci5jb250ZXh0LmRlc3RpbmF0aW9uO1xuICAgICAgaWYgKHRoaXMuX2ZpcnN0Tm9kZSAhPT0gZmlyc3ROb2RlKSB7XG4gICAgICAgIGlmICh0aGlzLl9maXJzdE5vZGUpIHtcbiAgICAgICAgICB0aGlzLl9jb25uZWN0b3JOb2RlLmRpc2Nvbm5lY3QodGhpcy5fZmlyc3ROb2RlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9jb25uZWN0b3JOb2RlLmRpc2Nvbm5lY3Qoc3BlYWtlcnMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2ZpcnN0Tm9kZSA9IGZpcnN0Tm9kZTtcbiAgICAgICAgdGhpcy5fY29ubmVjdG9yTm9kZS5jb25uZWN0KGZpcnN0Tm9kZSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fbGFzdE5vZGUgIT09IGxhc3ROb2RlKSB7XG4gICAgICAgIGlmICh0aGlzLl9sYXN0Tm9kZSkge1xuICAgICAgICAgIHRoaXMuX2xhc3ROb2RlLmRpc2Nvbm5lY3Qoc3BlYWtlcnMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2xhc3ROb2RlID0gbGFzdE5vZGU7XG4gICAgICAgIHRoaXMuX2xhc3ROb2RlLmNvbm5lY3Qoc3BlYWtlcnMpO1xuICAgICAgfVxuICAgIH0sIGNsZWFyRXh0ZXJuYWxOb2RlczpmdW5jdGlvbigpIHtcbiAgICAgIHZhciBzcGVha2VycyA9IHRoaXMuX21hbmFnZXIuY29udGV4dC5kZXN0aW5hdGlvbjtcbiAgICAgIGlmICh0aGlzLl9maXJzdE5vZGUpIHtcbiAgICAgICAgdGhpcy5fY29ubmVjdG9yTm9kZS5kaXNjb25uZWN0KHRoaXMuX2ZpcnN0Tm9kZSk7XG4gICAgICAgIHRoaXMuX2ZpcnN0Tm9kZSA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fbGFzdE5vZGUpIHtcbiAgICAgICAgdGhpcy5fbGFzdE5vZGUuZGlzY29ubmVjdChzcGVha2Vycyk7XG4gICAgICAgIHRoaXMuX2xhc3ROb2RlID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2Nvbm5lY3Rvck5vZGUuY29ubmVjdChzcGVha2Vycyk7XG4gICAgfSwgZ2V0RXh0ZXJuYWxOb2RlczpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBbdGhpcy5fZmlyc3ROb2RlLCB0aGlzLl9sYXN0Tm9kZV07XG4gICAgfSwgX2NyZWF0ZVNvdXJjZTpmdW5jdGlvbigpIHtcbiAgICAgIGlmICghdGhpcy5fc291bmQpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICB2YXIgY29udGV4dCA9IHRoaXMuX21hbmFnZXIuY29udGV4dDtcbiAgICAgIGlmICh0aGlzLl9zb3VuZC5idWZmZXIpIHtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBjb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO1xuICAgICAgICB0aGlzLnNvdXJjZS5idWZmZXIgPSB0aGlzLl9zb3VuZC5idWZmZXI7XG4gICAgICAgIHRoaXMuc291cmNlLmNvbm5lY3QodGhpcy5faW5wdXROb2RlKTtcbiAgICAgICAgdGhpcy5zb3VyY2Uub25lbmRlZCA9IHRoaXMuX2VuZGVkSGFuZGxlcjtcbiAgICAgICAgdGhpcy5zb3VyY2UubG9vcFN0YXJ0ID0gY2FwVGltZSh0aGlzLl9zdGFydFRpbWUsIHRoaXMuc291cmNlLmJ1ZmZlci5kdXJhdGlvbik7XG4gICAgICAgIGlmICh0aGlzLl9kdXJhdGlvbikge1xuICAgICAgICAgIHRoaXMuc291cmNlLmxvb3BFbmQgPSBNYXRoLm1heCh0aGlzLnNvdXJjZS5sb29wU3RhcnQsIGNhcFRpbWUodGhpcy5fc3RhcnRUaW1lICsgdGhpcy5fZHVyYXRpb24sIHRoaXMuc291cmNlLmJ1ZmZlci5kdXJhdGlvbikpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5zb3VyY2U7XG4gICAgfSwgX3VwZGF0ZUN1cnJlbnRUaW1lOmZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5fY3VycmVudFRpbWUgPSBjYXBUaW1lKCh0aGlzLl9tYW5hZ2VyLmNvbnRleHQuY3VycmVudFRpbWUgLSB0aGlzLl9zdGFydGVkQXQpICogdGhpcy5waXRjaCArIHRoaXMuX2N1cnJlbnRPZmZzZXQsIHRoaXMuZHVyYXRpb24pO1xuICAgIH0sIF9vbk1hbmFnZXJEZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoaXMuc291cmNlICYmIHRoaXMuaXNQbGF5aW5nKSB7XG4gICAgICAgIHRoaXMuc291cmNlLnN0b3AoMCk7XG4gICAgICAgIHRoaXMuc291cmNlID0gbnVsbDtcbiAgICAgIH1cbiAgICB9fTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwidm9sdW1lXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5fdm9sdW1lO1xuICAgIH0sIHNldDpmdW5jdGlvbih2b2x1bWUpIHtcbiAgICAgIHZvbHVtZSA9IHBjLm1hdGguY2xhbXAodm9sdW1lLCAwLCAxKTtcbiAgICAgIHRoaXMuX3ZvbHVtZSA9IHZvbHVtZTtcbiAgICAgIGlmICh0aGlzLmdhaW4pIHtcbiAgICAgICAgdGhpcy5nYWluLmdhaW4udmFsdWUgPSB2b2x1bWUgKiB0aGlzLl9tYW5hZ2VyLnZvbHVtZTtcbiAgICAgIH1cbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UucHJvdG90eXBlLCBcInBpdGNoXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5fcGl0Y2g7XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHBpdGNoKSB7XG4gICAgICB2YXIgb2xkID0gdGhpcy5fcGl0Y2g7XG4gICAgICB0aGlzLl9jdXJyZW50T2Zmc2V0ID0gdGhpcy5jdXJyZW50VGltZTtcbiAgICAgIHRoaXMuX3N0YXJ0ZWRBdCA9IHRoaXMuX21hbmFnZXIuY29udGV4dC5jdXJyZW50VGltZTtcbiAgICAgIHRoaXMuX3BpdGNoID0gTWF0aC5tYXgoTnVtYmVyKHBpdGNoKSB8fCAwLCAwLjAxKTtcbiAgICAgIGlmICh0aGlzLnNvdXJjZSkge1xuICAgICAgICB0aGlzLnNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSB0aGlzLl9waXRjaDtcbiAgICAgIH1cbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UucHJvdG90eXBlLCBcImxvb3BcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLl9sb29wO1xuICAgIH0sIHNldDpmdW5jdGlvbihsb29wKSB7XG4gICAgICB0aGlzLl9sb29wID0gISFsb29wO1xuICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgIHRoaXMuc291cmNlLmxvb3AgPSB0aGlzLl9sb29wO1xuICAgICAgfVxuICAgIH19KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwic291bmRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLl9zb3VuZDtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHRoaXMuX3NvdW5kID0gdmFsdWU7XG4gICAgICBpZiAoIXRoaXMuaXNTdG9wcGVkKSB7XG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fY3JlYXRlU291cmNlKCk7XG4gICAgICB9XG4gICAgfX0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJjdXJyZW50VGltZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoaXMuX3N0YXJ0T2Zmc2V0ICE9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zdGFydE9mZnNldDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmlzUGF1c2VkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50VGltZTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmlzU3RvcHBlZCB8fCAhdGhpcy5zb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9XG4gICAgICB0aGlzLl91cGRhdGVDdXJyZW50VGltZSgpO1xuICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRUaW1lO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHZhbHVlIDwgMCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5pc1BsYXlpbmcpIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIHZhciBzdXNwZW5kID0gdGhpcy5fc3VzcGVuZEluc3RhbmNlRXZlbnRzO1xuICAgICAgICB0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMgPSB0cnVlO1xuICAgICAgICB0aGlzLl9zdGFydE9mZnNldCA9IHZhbHVlO1xuICAgICAgICB0aGlzLnBsYXkoKTtcbiAgICAgICAgdGhpcy5fc3VzcGVuZEluc3RhbmNlRXZlbnRzID0gc3VzcGVuZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3N0YXJ0T2Zmc2V0ID0gdmFsdWU7XG4gICAgICAgIHRoaXMuX2N1cnJlbnRUaW1lID0gdmFsdWU7XG4gICAgICB9XG4gICAgfX0pO1xuICB9IGVsc2Uge1xuICAgIGlmIChwYy5Tb3VuZE1hbmFnZXIuaGFzQXVkaW8oKSkge1xuICAgICAgU291bmRJbnN0YW5jZSA9IGZ1bmN0aW9uKG1hbmFnZXIsIHJlc291cmNlLCBvcHRpb25zKSB7XG4gICAgICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICB0aGlzLl92b2x1bWUgPSBvcHRpb25zLnZvbHVtZSAhPT0gdW5kZWZpbmVkID8gcGMubWF0aC5jbGFtcChOdW1iZXIob3B0aW9ucy52b2x1bWUpIHx8IDAsIDAsIDEpIDogMTtcbiAgICAgICAgdGhpcy5fcGl0Y2ggPSBvcHRpb25zLnBpdGNoICE9PSB1bmRlZmluZWQgPyBNYXRoLm1heCgwLjAxLCBOdW1iZXIob3B0aW9ucy5waXRjaCkgfHwgMCkgOiAxO1xuICAgICAgICB0aGlzLl9sb29wID0gISEob3B0aW9ucy5sb29wICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmxvb3AgOiBmYWxzZSk7XG4gICAgICAgIHRoaXMuX3NvdW5kID0gcmVzb3VyY2U7XG4gICAgICAgIHRoaXMuX3N0YXRlID0gU1RBVEVfU1RPUFBFRDtcbiAgICAgICAgdGhpcy5fc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX3N1c3BlbmRFbmRFdmVudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fcGxheVdoZW5Mb2FkZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl9zdGFydFRpbWUgPSBNYXRoLm1heCgwLCBOdW1iZXIob3B0aW9ucy5zdGFydFRpbWUpIHx8IDApO1xuICAgICAgICB0aGlzLl9kdXJhdGlvbiA9IE1hdGgubWF4KDAsIE51bWJlcihvcHRpb25zLmR1cmF0aW9uKSB8fCAwKTtcbiAgICAgICAgdGhpcy5fc3RhcnRPZmZzZXQgPSBudWxsO1xuICAgICAgICB0aGlzLl9pc1JlYWR5ID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX21hbmFnZXIgPSBtYW5hZ2VyO1xuICAgICAgICB0aGlzLl9sb2FkZWRNZXRhZGF0YUhhbmRsZXIgPSB0aGlzLl9vbkxvYWRlZE1ldGFkYXRhLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuX3RpbWVVcGRhdGVIYW5kbGVyID0gdGhpcy5fb25UaW1lVXBkYXRlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuX2VuZGVkSGFuZGxlciA9IHRoaXMuX29uRW5kZWQuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5fb25QbGF5Q2FsbGJhY2sgPSBvcHRpb25zLm9uUGxheTtcbiAgICAgICAgdGhpcy5fb25QYXVzZUNhbGxiYWNrID0gb3B0aW9ucy5vblBhdXNlO1xuICAgICAgICB0aGlzLl9vblJlc3VtZUNhbGxiYWNrID0gb3B0aW9ucy5vblJlc3VtZTtcbiAgICAgICAgdGhpcy5fb25TdG9wQ2FsbGJhY2sgPSBvcHRpb25zLm9uU3RvcDtcbiAgICAgICAgdGhpcy5fb25FbmRDYWxsYmFjayA9IG9wdGlvbnMub25FbmQ7XG4gICAgICAgIHRoaXMuc291cmNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5fY3JlYXRlU291cmNlKCk7XG4gICAgICB9O1xuICAgICAgU291bmRJbnN0YW5jZS5wcm90b3R5cGUgPSB7cGxheTpmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBTVEFURV9TVE9QUEVEKSB7XG4gICAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLnNvdXJjZSkge1xuICAgICAgICAgIGlmICghdGhpcy5fY3JlYXRlU291cmNlKCkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy52b2x1bWUgPSB0aGlzLl92b2x1bWU7XG4gICAgICAgIHRoaXMucGl0Y2ggPSB0aGlzLl9waXRjaDtcbiAgICAgICAgdGhpcy5sb29wID0gdGhpcy5fbG9vcDtcbiAgICAgICAgdGhpcy5zb3VyY2UucGxheSgpO1xuICAgICAgICB0aGlzLl9zdGF0ZSA9IFNUQVRFX1BMQVlJTkc7XG4gICAgICAgIHRoaXMuX3BsYXlXaGVuTG9hZGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX21hbmFnZXIub24oXCJ2b2x1bWVjaGFuZ2VcIiwgdGhpcy5fb25NYW5hZ2VyVm9sdW1lQ2hhbmdlLCB0aGlzKTtcbiAgICAgICAgdGhpcy5fbWFuYWdlci5vbihcInN1c3BlbmRcIiwgdGhpcy5fb25NYW5hZ2VyU3VzcGVuZCwgdGhpcyk7XG4gICAgICAgIHRoaXMuX21hbmFnZXIub24oXCJyZXN1bWVcIiwgdGhpcy5fb25NYW5hZ2VyUmVzdW1lLCB0aGlzKTtcbiAgICAgICAgdGhpcy5fbWFuYWdlci5vbihcImRlc3Ryb3lcIiwgdGhpcy5fb25NYW5hZ2VyRGVzdHJveSwgdGhpcyk7XG4gICAgICAgIGlmICh0aGlzLl9tYW5hZ2VyLnN1c3BlbmRlZCkge1xuICAgICAgICAgIHRoaXMuX29uTWFuYWdlclN1c3BlbmQoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX3N1c3BlbmRJbnN0YW5jZUV2ZW50cykge1xuICAgICAgICAgIHRoaXMuX29uUGxheSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSwgcGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICghdGhpcy5zb3VyY2UgfHwgdGhpcy5fc3RhdGUgIT09IFNUQVRFX1BMQVlJTkcpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc3VzcGVuZEVuZEV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5zb3VyY2UucGF1c2UoKTtcbiAgICAgICAgdGhpcy5fcGxheVdoZW5Mb2FkZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fc3RhdGUgPSBTVEFURV9QQVVTRUQ7XG4gICAgICAgIHRoaXMuX3N0YXJ0T2Zmc2V0ID0gbnVsbDtcbiAgICAgICAgaWYgKCF0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMpIHtcbiAgICAgICAgICB0aGlzLl9vblBhdXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9LCByZXN1bWU6ZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICghdGhpcy5zb3VyY2UgfHwgdGhpcy5fc3RhdGUgIT09IFNUQVRFX1BBVVNFRCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9zdGF0ZSA9IFNUQVRFX1BMQVlJTkc7XG4gICAgICAgIHRoaXMuX3BsYXlXaGVuTG9hZGVkID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnNvdXJjZS5wYXVzZWQpIHtcbiAgICAgICAgICB0aGlzLnNvdXJjZS5wbGF5KCk7XG4gICAgICAgICAgaWYgKCF0aGlzLl9zdXNwZW5kSW5zdGFuY2VFdmVudHMpIHtcbiAgICAgICAgICAgIHRoaXMuX29uUmVzdW1lKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSwgc3RvcDpmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKCF0aGlzLnNvdXJjZSB8fCB0aGlzLl9zdGF0ZSA9PT0gU1RBVEVfU1RPUFBFRCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9tYW5hZ2VyLm9mZihcInZvbHVtZWNoYW5nZVwiLCB0aGlzLl9vbk1hbmFnZXJWb2x1bWVDaGFuZ2UsIHRoaXMpO1xuICAgICAgICB0aGlzLl9tYW5hZ2VyLm9mZihcInN1c3BlbmRcIiwgdGhpcy5fb25NYW5hZ2VyU3VzcGVuZCwgdGhpcyk7XG4gICAgICAgIHRoaXMuX21hbmFnZXIub2ZmKFwicmVzdW1lXCIsIHRoaXMuX29uTWFuYWdlclJlc3VtZSwgdGhpcyk7XG4gICAgICAgIHRoaXMuX21hbmFnZXIub2ZmKFwiZGVzdHJveVwiLCB0aGlzLl9vbk1hbmFnZXJEZXN0cm95LCB0aGlzKTtcbiAgICAgICAgdGhpcy5fc3VzcGVuZEVuZEV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5zb3VyY2UucGF1c2UoKTtcbiAgICAgICAgdGhpcy5fcGxheVdoZW5Mb2FkZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fc3RhdGUgPSBTVEFURV9TVE9QUEVEO1xuICAgICAgICB0aGlzLl9zdGFydE9mZnNldCA9IG51bGw7XG4gICAgICAgIGlmICghdGhpcy5fc3VzcGVuZEluc3RhbmNlRXZlbnRzKSB7XG4gICAgICAgICAgdGhpcy5fb25TdG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9LCBzZXRFeHRlcm5hbE5vZGVzOmZ1bmN0aW9uKCkge1xuICAgICAgfSwgY2xlYXJFeHRlcm5hbE5vZGVzOmZ1bmN0aW9uKCkge1xuICAgICAgfSwgZ2V0RXh0ZXJuYWxOb2RlczpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIFtudWxsLCBudWxsXTtcbiAgICAgIH0sIF9vbkxvYWRlZE1ldGFkYXRhOmZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnNvdXJjZS5yZW1vdmVFdmVudExpc3RlbmVyKFwibG9hZGVkbWV0YWRhdGFcIiwgdGhpcy5fbG9hZGVkTWV0YWRhdGFIYW5kbGVyKTtcbiAgICAgICAgdGhpcy5faXNSZWFkeSA9IHRydWU7XG4gICAgICAgIHZhciBvZmZzZXQgPSBjYXBUaW1lKHRoaXMuX3N0YXJ0T2Zmc2V0LCB0aGlzLmR1cmF0aW9uKTtcbiAgICAgICAgb2Zmc2V0ID0gY2FwVGltZSh0aGlzLl9zdGFydFRpbWUgKyBvZmZzZXQsIHRoaXMuX3NvdW5kLmR1cmF0aW9uKTtcbiAgICAgICAgdGhpcy5fc3RhcnRPZmZzZXQgPSBudWxsO1xuICAgICAgICB0aGlzLnNvdXJjZS5jdXJyZW50VGltZSA9IG9mZnNldDtcbiAgICAgIH0sIF9jcmVhdGVTb3VyY2U6ZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICh0aGlzLl9zb3VuZCAmJiB0aGlzLl9zb3VuZC5hdWRpbykge1xuICAgICAgICAgIHRoaXMuX2lzUmVhZHkgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHRoaXMuX3NvdW5kLmF1ZGlvLmNsb25lTm9kZSh0cnVlKTtcbiAgICAgICAgICB0aGlzLnNvdXJjZS5hZGRFdmVudExpc3RlbmVyKFwibG9hZGVkbWV0YWRhdGFcIiwgdGhpcy5fbG9hZGVkTWV0YWRhdGFIYW5kbGVyKTtcbiAgICAgICAgICB0aGlzLnNvdXJjZS5hZGRFdmVudExpc3RlbmVyKFwidGltZXVwZGF0ZVwiLCB0aGlzLl90aW1lVXBkYXRlSGFuZGxlcik7XG4gICAgICAgICAgdGhpcy5zb3VyY2Uub25lbmRlZCA9IHRoaXMuX2VuZGVkSGFuZGxlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zb3VyY2U7XG4gICAgICB9LCBfb25UaW1lVXBkYXRlOmZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoIXRoaXMuX2R1cmF0aW9uKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnNvdXJjZS5jdXJyZW50VGltZSA+IGNhcFRpbWUodGhpcy5fc3RhcnRUaW1lICsgdGhpcy5fZHVyYXRpb24sIHRoaXMuc291cmNlLmR1cmF0aW9uKSkge1xuICAgICAgICAgIGlmICh0aGlzLmxvb3ApIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlLmN1cnJlbnRUaW1lID0gY2FwVGltZSh0aGlzLl9zdGFydFRpbWUsIHRoaXMuc291cmNlLmR1cmF0aW9uKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRpbWV1cGRhdGVcIiwgdGhpcy5fdGltZVVwZGF0ZUhhbmRsZXIpO1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UucGF1c2UoKTtcbiAgICAgICAgICAgIHRoaXMuX29uRW5kZWQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sIF9vbk1hbmFnZXJEZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICB0aGlzLnNvdXJjZS5wYXVzZSgpO1xuICAgICAgICB9XG4gICAgICB9fTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJ2b2x1bWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZvbHVtZTtcbiAgICAgIH0sIHNldDpmdW5jdGlvbih2b2x1bWUpIHtcbiAgICAgICAgdm9sdW1lID0gcGMubWF0aC5jbGFtcCh2b2x1bWUsIDAsIDEpO1xuICAgICAgICB0aGlzLl92b2x1bWUgPSB2b2x1bWU7XG4gICAgICAgIGlmICh0aGlzLnNvdXJjZSkge1xuICAgICAgICAgIHRoaXMuc291cmNlLnZvbHVtZSA9IHZvbHVtZSAqIHRoaXMuX21hbmFnZXIudm9sdW1lO1xuICAgICAgICB9XG4gICAgICB9fSk7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwicGl0Y2hcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BpdGNoO1xuICAgICAgfSwgc2V0OmZ1bmN0aW9uKHBpdGNoKSB7XG4gICAgICAgIHRoaXMuX3BpdGNoID0gTWF0aC5tYXgoTnVtYmVyKHBpdGNoKSB8fCAwLCAwLjAxKTtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2UucGxheWJhY2tSYXRlID0gdGhpcy5fcGl0Y2g7XG4gICAgICAgIH1cbiAgICAgIH19KTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJsb29wXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sb29wO1xuICAgICAgfSwgc2V0OmZ1bmN0aW9uKGxvb3ApIHtcbiAgICAgICAgdGhpcy5fbG9vcCA9ICEhbG9vcDtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2UubG9vcCA9IHRoaXMuX2xvb3A7XG4gICAgICAgIH1cbiAgICAgIH19KTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJzb3VuZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc291bmQ7XG4gICAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIHRoaXMuX3NvdW5kID0gdmFsdWU7XG4gICAgICB9fSk7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwiY3VycmVudFRpbWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YXJ0T2Zmc2V0ICE9PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0T2Zmc2V0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlzU3RvcHBlZCB8fCAhdGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zb3VyY2UuY3VycmVudFRpbWUgLSB0aGlzLl9zdGFydFRpbWU7XG4gICAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgaWYgKHZhbHVlIDwgMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9zdGFydE9mZnNldCA9IHZhbHVlO1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UgJiYgdGhpcy5faXNSZWFkeSkge1xuICAgICAgICAgIHRoaXMuc291cmNlLmN1cnJlbnRUaW1lID0gY2FwVGltZSh0aGlzLl9zdGFydFRpbWUgKyBjYXBUaW1lKHZhbHVlLCB0aGlzLmR1cmF0aW9uKSwgdGhpcy5fc291bmQuZHVyYXRpb24pO1xuICAgICAgICAgIHRoaXMuX3N0YXJ0T2Zmc2V0ID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBTb3VuZEluc3RhbmNlID0gZnVuY3Rpb24oKSB7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuICBwYy5leHRlbmQoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIHtfb25QbGF5OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZmlyZShcInBsYXlcIik7XG4gICAgaWYgKHRoaXMuX29uUGxheUNhbGxiYWNrKSB7XG4gICAgICB0aGlzLl9vblBsYXlDYWxsYmFjayh0aGlzKTtcbiAgICB9XG4gIH0sIF9vblBhdXNlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZmlyZShcInBhdXNlXCIpO1xuICAgIGlmICh0aGlzLl9vblBhdXNlQ2FsbGJhY2spIHtcbiAgICAgIHRoaXMuX29uUGF1c2VDYWxsYmFjayh0aGlzKTtcbiAgICB9XG4gIH0sIF9vblJlc3VtZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmZpcmUoXCJyZXN1bWVcIik7XG4gICAgaWYgKHRoaXMuX29uUmVzdW1lQ2FsbGJhY2spIHtcbiAgICAgIHRoaXMuX29uUmVzdW1lQ2FsbGJhY2sodGhpcyk7XG4gICAgfVxuICB9LCBfb25TdG9wOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZmlyZShcInN0b3BcIik7XG4gICAgaWYgKHRoaXMuX29uU3RvcENhbGxiYWNrKSB7XG4gICAgICB0aGlzLl9vblN0b3BDYWxsYmFjayh0aGlzKTtcbiAgICB9XG4gIH0sIF9vbkVuZGVkOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9zdXNwZW5kRW5kRXZlbnQpIHtcbiAgICAgIHRoaXMuX3N1c3BlbmRFbmRFdmVudCA9IGZhbHNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJlbmRcIik7XG4gICAgaWYgKHRoaXMuX29uRW5kQ2FsbGJhY2spIHtcbiAgICAgIHRoaXMuX29uRW5kQ2FsbGJhY2sodGhpcyk7XG4gICAgfVxuICAgIHRoaXMuc3RvcCgpO1xuICB9LCBfb25NYW5hZ2VyVm9sdW1lQ2hhbmdlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMudm9sdW1lID0gdGhpcy5fdm9sdW1lO1xuICB9LCBfb25NYW5hZ2VyU3VzcGVuZDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgIXRoaXMuX3N1c3BlbmRlZCkge1xuICAgICAgdGhpcy5fc3VzcGVuZGVkID0gdHJ1ZTtcbiAgICAgIHRoaXMucGF1c2UoKTtcbiAgICB9XG4gIH0sIF9vbk1hbmFnZXJSZXN1bWU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX3N1c3BlbmRlZCkge1xuICAgICAgdGhpcy5fc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnJlc3VtZSgpO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwic3RhcnRUaW1lXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXJ0VGltZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fc3RhcnRUaW1lID0gTWF0aC5tYXgoMCwgTnVtYmVyKHZhbHVlKSB8fCAwKTtcbiAgICB2YXIgaXNQbGF5aW5nID0gdGhpcy5pc1BsYXlpbmc7XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgaWYgKGlzUGxheWluZykge1xuICAgICAgdGhpcy5wbGF5KCk7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJkdXJhdGlvblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fc291bmQpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZHVyYXRpb24pIHtcbiAgICAgIHJldHVybiBjYXBUaW1lKHRoaXMuX2R1cmF0aW9uLCB0aGlzLl9zb3VuZC5kdXJhdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLl9zb3VuZC5kdXJhdGlvbjtcbiAgICB9XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2R1cmF0aW9uID0gTWF0aC5tYXgoMCwgTnVtYmVyKHZhbHVlKSB8fCAwKTtcbiAgICB2YXIgaXNQbGF5aW5nID0gdGhpcy5pc1BsYXlpbmc7XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgaWYgKGlzUGxheWluZykge1xuICAgICAgdGhpcy5wbGF5KCk7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlLnByb3RvdHlwZSwgXCJpc1BsYXlpbmdcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdGUgPT09IFNUQVRFX1BMQVlJTkc7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UucHJvdG90eXBlLCBcImlzUGF1c2VkXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlID09PSBTVEFURV9QQVVTRUQ7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UucHJvdG90eXBlLCBcImlzU3RvcHBlZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZSA9PT0gU1RBVEVfU1RPUFBFRDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZS5wcm90b3R5cGUsIFwiaXNTdXNwZW5kZWRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc3VzcGVuZGVkO1xuICB9fSk7XG4gIHJldHVybiB7U291bmRJbnN0YW5jZTpTb3VuZEluc3RhbmNlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgTUFYX0RJU1RBTkNFID0gMTAwMDA7XG4gIHZhciBTb3VuZEluc3RhbmNlM2Q7XG4gIGlmIChwYy5Tb3VuZE1hbmFnZXIuaGFzQXVkaW9Db250ZXh0KCkpIHtcbiAgICBTb3VuZEluc3RhbmNlM2QgPSBmdW5jdGlvbihtYW5hZ2VyLCBzb3VuZCwgb3B0aW9ucykge1xuICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICB0aGlzLl9wb3NpdGlvbiA9IG5ldyBwYy5WZWMzO1xuICAgICAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IG9wdGlvbnMucG9zaXRpb247XG4gICAgICB9XG4gICAgICB0aGlzLl92ZWxvY2l0eSA9IG5ldyBwYy5WZWMzO1xuICAgICAgaWYgKG9wdGlvbnMudmVsb2NpdHkpIHtcbiAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG9wdGlvbnMudmVsb2NpdHk7XG4gICAgICB9XG4gICAgICB0aGlzLm1heERpc3RhbmNlID0gb3B0aW9ucy5tYXhEaXN0YW5jZSAhPT0gdW5kZWZpbmVkID8gTnVtYmVyKG9wdGlvbnMubWF4RGlzdGFuY2UpIDogTUFYX0RJU1RBTkNFO1xuICAgICAgdGhpcy5yZWZEaXN0YW5jZSA9IG9wdGlvbnMucmVmRGlzdGFuY2UgIT09IHVuZGVmaW5lZCA/IE51bWJlcihvcHRpb25zLnJlZkRpc3RhbmNlKSA6IDE7XG4gICAgICB0aGlzLnJvbGxPZmZGYWN0b3IgPSBvcHRpb25zLnJvbGxPZmZGYWN0b3IgIT09IHVuZGVmaW5lZCA/IE51bWJlcihvcHRpb25zLnJvbGxPZmZGYWN0b3IpIDogMTtcbiAgICAgIHRoaXMuZGlzdGFuY2VNb2RlbCA9IG9wdGlvbnMuZGlzdGFuY2VNb2RlbCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5kaXN0YW5jZU1vZGVsIDogcGMuRElTVEFOQ0VfTElORUFSO1xuICAgIH07XG4gICAgU291bmRJbnN0YW5jZTNkID0gcGMuaW5oZXJpdHMoU291bmRJbnN0YW5jZTNkLCBwYy5Tb3VuZEluc3RhbmNlKTtcbiAgICBTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlID0gcGMuZXh0ZW5kKFNvdW5kSW5zdGFuY2UzZC5wcm90b3R5cGUsIHtfaW5pdGlhbGl6ZU5vZGVzOmZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5nYWluID0gdGhpcy5fbWFuYWdlci5jb250ZXh0LmNyZWF0ZUdhaW4oKTtcbiAgICAgIHRoaXMucGFubmVyID0gdGhpcy5fbWFuYWdlci5jb250ZXh0LmNyZWF0ZVBhbm5lcigpO1xuICAgICAgdGhpcy5wYW5uZXIuY29ubmVjdCh0aGlzLmdhaW4pO1xuICAgICAgdGhpcy5faW5wdXROb2RlID0gdGhpcy5wYW5uZXI7XG4gICAgICB0aGlzLl9jb25uZWN0b3JOb2RlID0gdGhpcy5nYWluO1xuICAgICAgdGhpcy5fY29ubmVjdG9yTm9kZS5jb25uZWN0KHRoaXMuX21hbmFnZXIuY29udGV4dC5kZXN0aW5hdGlvbik7XG4gICAgfX0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlLCBcInBvc2l0aW9uXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5fcG9zaXRpb247XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHBvc2l0aW9uKSB7XG4gICAgICB0aGlzLl9wb3NpdGlvbi5jb3B5KHBvc2l0aW9uKTtcbiAgICAgIHRoaXMucGFubmVyLnNldFBvc2l0aW9uKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHBvc2l0aW9uLnopO1xuICAgIH19KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZTNkLnByb3RvdHlwZSwgXCJ2ZWxvY2l0eVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMuX3ZlbG9jaXR5O1xuICAgIH0sIHNldDpmdW5jdGlvbih2ZWxvY2l0eSkge1xuICAgICAgdGhpcy5fdmVsb2NpdHkuY29weSh2ZWxvY2l0eSk7XG4gICAgICB0aGlzLnBhbm5lci5zZXRWZWxvY2l0eSh2ZWxvY2l0eS54LCB2ZWxvY2l0eS55LCB2ZWxvY2l0eS56KTtcbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UzZC5wcm90b3R5cGUsIFwibWF4RGlzdGFuY2VcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhbm5lci5tYXhEaXN0YW5jZTtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHRoaXMucGFubmVyLm1heERpc3RhbmNlID0gdmFsdWU7XG4gICAgfX0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlLCBcInJlZkRpc3RhbmNlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYW5uZXIucmVmRGlzdGFuY2U7XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICB0aGlzLnBhbm5lci5yZWZEaXN0YW5jZSA9IHZhbHVlO1xuICAgIH19KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZTNkLnByb3RvdHlwZSwgXCJyb2xsT2ZmRmFjdG9yXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYW5uZXIucm9sbG9mZkZhY3RvcjtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHRoaXMucGFubmVyLnJvbGxvZmZGYWN0b3IgPSB2YWx1ZTtcbiAgICB9fSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UzZC5wcm90b3R5cGUsIFwiZGlzdGFuY2VNb2RlbFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMucGFubmVyLmRpc3RhbmNlTW9kZWw7XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICB0aGlzLnBhbm5lci5kaXN0YW5jZU1vZGVsID0gdmFsdWU7XG4gICAgfX0pO1xuICB9IGVsc2Uge1xuICAgIGlmIChwYy5Tb3VuZE1hbmFnZXIuaGFzQXVkaW8oKSkge1xuICAgICAgdmFyIG9mZnNldCA9IG5ldyBwYy5WZWMzO1xuICAgICAgdmFyIGZhbGxPZmYgPSBmdW5jdGlvbihwb3NPbmUsIHBvc1R3bywgcmVmRGlzdGFuY2UsIG1heERpc3RhbmNlLCByb2xsT2ZmRmFjdG9yLCBkaXN0YW5jZU1vZGVsKSB7XG4gICAgICAgIG9mZnNldCA9IG9mZnNldC5zdWIyKHBvc09uZSwgcG9zVHdvKTtcbiAgICAgICAgdmFyIGRpc3RhbmNlID0gb2Zmc2V0Lmxlbmd0aCgpO1xuICAgICAgICBpZiAoZGlzdGFuY2UgPCByZWZEaXN0YW5jZSkge1xuICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChkaXN0YW5jZSA+IG1heERpc3RhbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IDA7XG4gICAgICAgICAgICBpZiAoZGlzdGFuY2VNb2RlbCA9PT0gcGMuRElTVEFOQ0VfTElORUFSKSB7XG4gICAgICAgICAgICAgIHJlc3VsdCA9IDEgLSByb2xsT2ZmRmFjdG9yICogKGRpc3RhbmNlIC0gcmVmRGlzdGFuY2UpIC8gKG1heERpc3RhbmNlIC0gcmVmRGlzdGFuY2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlTW9kZWwgPT09IHBjLkRJU1RBTkNFX0lOVkVSU0UpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZWZEaXN0YW5jZSAvIChyZWZEaXN0YW5jZSArIHJvbGxPZmZGYWN0b3IgKiAoZGlzdGFuY2UgLSByZWZEaXN0YW5jZSkpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZU1vZGVsID09PSBwYy5ESVNUQU5DRV9FWFBPTkVOVElBTCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gTWF0aC5wb3coZGlzdGFuY2UgLyByZWZEaXN0YW5jZSwgLXJvbGxPZmZGYWN0b3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHBjLm1hdGguY2xhbXAocmVzdWx0LCAwLCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBTb3VuZEluc3RhbmNlM2QgPSBmdW5jdGlvbihtYW5hZ2VyLCBzb3VuZCwgb3B0aW9ucykge1xuICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgICAgdGhpcy5fcG9zaXRpb24gPSBuZXcgcGMuVmVjMztcbiAgICAgICAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHtcbiAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gb3B0aW9ucy5wb3NpdGlvbjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl92ZWxvY2l0eSA9IG5ldyBwYy5WZWMzO1xuICAgICAgICBpZiAob3B0aW9ucy52ZWxvY2l0eSkge1xuICAgICAgICAgIHRoaXMudmVsb2NpdHkgPSBvcHRpb25zLnZlbG9jaXR5O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX21heERpc3RhbmNlID0gb3B0aW9ucy5tYXhEaXN0YW5jZSAhPT0gdW5kZWZpbmVkID8gTnVtYmVyKG9wdGlvbnMubWF4RGlzdGFuY2UpIDogTUFYX0RJU1RBTkNFO1xuICAgICAgICB0aGlzLl9yZWZEaXN0YW5jZSA9IG9wdGlvbnMucmVmRGlzdGFuY2UgIT09IHVuZGVmaW5lZCA/IE51bWJlcihvcHRpb25zLnJlZkRpc3RhbmNlKSA6IDE7XG4gICAgICAgIHRoaXMuX3JvbGxPZmZGYWN0b3IgPSBvcHRpb25zLnJvbGxPZmZGYWN0b3IgIT09IHVuZGVmaW5lZCA/IE51bWJlcihvcHRpb25zLnJvbGxPZmZGYWN0b3IpIDogMTtcbiAgICAgICAgdGhpcy5fZGlzdGFuY2VNb2RlbCA9IG9wdGlvbnMuZGlzdGFuY2VNb2RlbCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5kaXN0YW5jZU1vZGVsIDogcGMuRElTVEFOQ0VfTElORUFSO1xuICAgICAgfTtcbiAgICAgIFNvdW5kSW5zdGFuY2UzZCA9IHBjLmluaGVyaXRzKFNvdW5kSW5zdGFuY2UzZCwgcGMuU291bmRJbnN0YW5jZSk7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZTNkLnByb3RvdHlwZSwgXCJwb3NpdGlvblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcG9zaXRpb247XG4gICAgICB9LCBzZXQ6ZnVuY3Rpb24ocG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5fcG9zaXRpb24uY29weShwb3NpdGlvbik7XG4gICAgICAgIGlmICh0aGlzLnNvdXJjZSkge1xuICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHRoaXMuX21hbmFnZXIubGlzdGVuZXI7XG4gICAgICAgICAgdmFyIGxwb3MgPSBsaXN0ZW5lci5nZXRQb3NpdGlvbigpO1xuICAgICAgICAgIHZhciBmYWN0b3IgPSBmYWxsT2ZmKGxwb3MsIHRoaXMuX3Bvc2l0aW9uLCB0aGlzLnJlZkRpc3RhbmNlLCB0aGlzLm1heERpc3RhbmNlLCB0aGlzLnJvbGxPZmZGYWN0b3IsIHRoaXMuZGlzdGFuY2VNb2RlbCk7XG4gICAgICAgICAgdmFyIHYgPSB0aGlzLnZvbHVtZTtcbiAgICAgICAgICB0aGlzLnNvdXJjZS52b2x1bWUgPSB2ICogZmFjdG9yICogdGhpcy5fbWFuYWdlci52b2x1bWU7XG4gICAgICAgIH1cbiAgICAgIH19KTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlLCBcInZlbG9jaXR5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl92ZWxvY2l0eTtcbiAgICAgIH0sIHNldDpmdW5jdGlvbih2ZWxvY2l0eSkge1xuICAgICAgICB0aGlzLl92ZWxvY2l0eS5jb3B5KHZlbG9jaXR5KTtcbiAgICAgIH19KTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlLCBcIm1heERpc3RhbmNlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tYXhEaXN0YW5jZTtcbiAgICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICB0aGlzLl9tYXhEaXN0YW5jZSA9IHZhbHVlO1xuICAgICAgfX0pO1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kSW5zdGFuY2UzZC5wcm90b3R5cGUsIFwicmVmRGlzdGFuY2VcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlZkRpc3RhbmNlO1xuICAgICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX3JlZkRpc3RhbmNlID0gdmFsdWU7XG4gICAgICB9fSk7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRJbnN0YW5jZTNkLnByb3RvdHlwZSwgXCJyb2xsT2ZmRmFjdG9yXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yb2xsT2ZmRmFjdG9yO1xuICAgICAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX3JvbGxPZmZGYWN0b3IgPSB2YWx1ZTtcbiAgICAgIH19KTtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZEluc3RhbmNlM2QucHJvdG90eXBlLCBcImRpc3RhbmNlTW9kZWxcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3RhbmNlTW9kZWw7XG4gICAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgdGhpcy5fZGlzdGFuY2VNb2RlbCA9IHZhbHVlO1xuICAgICAgfX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBTb3VuZEluc3RhbmNlM2QgPSBmdW5jdGlvbigpIHtcbiAgICAgIH07XG4gICAgfVxuICB9XG4gIHJldHVybiB7U291bmRJbnN0YW5jZTNkOlNvdW5kSW5zdGFuY2UzZH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIENoYW5uZWw7XG4gIGlmIChwYy5BdWRpb01hbmFnZXIuaGFzQXVkaW9Db250ZXh0KCkpIHtcbiAgICBDaGFubmVsID0gZnVuY3Rpb24obWFuYWdlciwgc291bmQsIG9wdGlvbnMpIHtcbiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgdGhpcy52b2x1bWUgPSBvcHRpb25zLnZvbHVtZSA9PT0gdW5kZWZpbmVkID8gMSA6IG9wdGlvbnMudm9sdW1lO1xuICAgICAgdGhpcy5sb29wID0gb3B0aW9ucy5sb29wID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IG9wdGlvbnMubG9vcDtcbiAgICAgIHRoaXMucGl0Y2ggPSBvcHRpb25zLnBpdGNoID09PSB1bmRlZmluZWQgPyAxIDogb3B0aW9ucy5waXRjaDtcbiAgICAgIHRoaXMuc291bmQgPSBzb3VuZDtcbiAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7XG4gICAgICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5zdGFydFRpbWUgPSAwO1xuICAgICAgdGhpcy5zdGFydE9mZnNldCA9IDA7XG4gICAgICB0aGlzLm1hbmFnZXIgPSBtYW5hZ2VyO1xuICAgICAgdGhpcy5zb3VyY2UgPSBudWxsO1xuICAgICAgdmFyIGNvbnRleHQgPSBtYW5hZ2VyLmNvbnRleHQ7XG4gICAgICB0aGlzLmdhaW4gPSBjb250ZXh0LmNyZWF0ZUdhaW4oKTtcbiAgICB9O1xuICAgIENoYW5uZWwucHJvdG90eXBlID0ge3BsYXk6ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FsbCBzdG9wKCkgYmVmb3JlIGNhbGxpbmcgcGxheSgpXCIpO1xuICAgICAgfVxuICAgICAgdGhpcy5fY3JlYXRlU291cmNlKCk7XG4gICAgICBpZiAoIXRoaXMuc291cmNlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5tYW5hZ2VyLmNvbnRleHQuY3VycmVudFRpbWU7XG4gICAgICB0aGlzLnNvdXJjZS5zdGFydCgwLCB0aGlzLnN0YXJ0T2Zmc2V0ICUgdGhpcy5zb3VyY2UuYnVmZmVyLmR1cmF0aW9uKTtcbiAgICAgIHRoaXMuc2V0Vm9sdW1lKHRoaXMudm9sdW1lKTtcbiAgICAgIHRoaXMuc2V0TG9vcCh0aGlzLmxvb3ApO1xuICAgICAgdGhpcy5zZXRQaXRjaCh0aGlzLnBpdGNoKTtcbiAgICAgIHRoaXMubWFuYWdlci5vbihcInZvbHVtZWNoYW5nZVwiLCB0aGlzLm9uTWFuYWdlclZvbHVtZUNoYW5nZSwgdGhpcyk7XG4gICAgICB0aGlzLm1hbmFnZXIub24oXCJzdXNwZW5kXCIsIHRoaXMub25NYW5hZ2VyU3VzcGVuZCwgdGhpcyk7XG4gICAgICB0aGlzLm1hbmFnZXIub24oXCJyZXN1bWVcIiwgdGhpcy5vbk1hbmFnZXJSZXN1bWUsIHRoaXMpO1xuICAgICAgaWYgKHRoaXMubWFuYWdlci5zdXNwZW5kZWQpIHtcbiAgICAgICAgdGhpcy5vbk1hbmFnZXJTdXNwZW5kKCk7XG4gICAgICB9XG4gICAgfSwgcGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLnN0YXJ0T2Zmc2V0ICs9IHRoaXMubWFuYWdlci5jb250ZXh0LmN1cnJlbnRUaW1lIC0gdGhpcy5zdGFydFRpbWU7XG4gICAgICAgIHRoaXMuc291cmNlLnN0b3AoMCk7XG4gICAgICAgIHRoaXMuc291cmNlID0gbnVsbDtcbiAgICAgIH1cbiAgICB9LCB1bnBhdXNlOmZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoaXMuc291cmNlIHx8ICF0aGlzLnBhdXNlZCkge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJDYWxsIHBhdXNlKCkgYmVmb3JlIHVucGF1c2luZy5cIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2NyZWF0ZVNvdXJjZSgpO1xuICAgICAgaWYgKCF0aGlzLnNvdXJjZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMubWFuYWdlci5jb250ZXh0LmN1cnJlbnRUaW1lO1xuICAgICAgdGhpcy5zb3VyY2Uuc3RhcnQoMCwgdGhpcy5zdGFydE9mZnNldCAlIHRoaXMuc291cmNlLmJ1ZmZlci5kdXJhdGlvbik7XG4gICAgICB0aGlzLnNldFZvbHVtZSh0aGlzLnZvbHVtZSk7XG4gICAgICB0aGlzLnNldExvb3AodGhpcy5sb29wKTtcbiAgICAgIHRoaXMuc2V0UGl0Y2godGhpcy5waXRjaCk7XG4gICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICAgIH0sIHN0b3A6ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgdGhpcy5zb3VyY2Uuc3RvcCgwKTtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBudWxsO1xuICAgICAgfVxuICAgICAgdGhpcy5tYW5hZ2VyLm9mZihcInZvbHVtZWNoYW5nZVwiLCB0aGlzLm9uTWFuYWdlclZvbHVtZUNoYW5nZSwgdGhpcyk7XG4gICAgICB0aGlzLm1hbmFnZXIub2ZmKFwic3VzcGVuZFwiLCB0aGlzLm9uTWFuYWdlclN1c3BlbmQsIHRoaXMpO1xuICAgICAgdGhpcy5tYW5hZ2VyLm9mZihcInJlc3VtZVwiLCB0aGlzLm9uTWFuYWdlclJlc3VtZSwgdGhpcyk7XG4gICAgfSwgc2V0TG9vcDpmdW5jdGlvbihsb29wKSB7XG4gICAgICB0aGlzLmxvb3AgPSBsb29wO1xuICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgIHRoaXMuc291cmNlLmxvb3AgPSBsb29wO1xuICAgICAgfVxuICAgIH0sIHNldFZvbHVtZTpmdW5jdGlvbih2b2x1bWUpIHtcbiAgICAgIHZvbHVtZSA9IHBjLm1hdGguY2xhbXAodm9sdW1lLCAwLCAxKTtcbiAgICAgIHRoaXMudm9sdW1lID0gdm9sdW1lO1xuICAgICAgaWYgKHRoaXMuZ2Fpbikge1xuICAgICAgICB0aGlzLmdhaW4uZ2Fpbi52YWx1ZSA9IHZvbHVtZSAqIHRoaXMubWFuYWdlci52b2x1bWU7XG4gICAgICB9XG4gICAgfSwgc2V0UGl0Y2g6ZnVuY3Rpb24ocGl0Y2gpIHtcbiAgICAgIHRoaXMucGl0Y2ggPSBwaXRjaDtcbiAgICAgIGlmICh0aGlzLnNvdXJjZSkge1xuICAgICAgICB0aGlzLnNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBwaXRjaDtcbiAgICAgIH1cbiAgICB9LCBpc1BsYXlpbmc6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gIXRoaXMucGF1c2VkICYmIHRoaXMuc291cmNlLnBsYXliYWNrU3RhdGUgPT09IHRoaXMuc291cmNlLlBMQVlJTkdfU1RBVEU7XG4gICAgfSwgZ2V0RHVyYXRpb246ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlLmJ1ZmZlci5kdXJhdGlvbjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgIH0sIF9jcmVhdGVTb3VyY2U6ZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgY29udGV4dCA9IHRoaXMubWFuYWdlci5jb250ZXh0O1xuICAgICAgaWYgKHRoaXMuc291bmQuYnVmZmVyKSB7XG4gICAgICAgIHRoaXMuc291cmNlID0gY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTtcbiAgICAgICAgdGhpcy5zb3VyY2UuYnVmZmVyID0gdGhpcy5zb3VuZC5idWZmZXI7XG4gICAgICAgIHRoaXMuc291cmNlLmNvbm5lY3QodGhpcy5nYWluKTtcbiAgICAgICAgdGhpcy5nYWluLmNvbm5lY3QoY29udGV4dC5kZXN0aW5hdGlvbik7XG4gICAgICAgIGlmICghdGhpcy5sb29wKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2Uub25lbmRlZCA9IHRoaXMucGF1c2UuYmluZCh0aGlzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH19O1xuICB9IGVsc2Uge1xuICAgIGlmIChwYy5BdWRpb01hbmFnZXIuaGFzQXVkaW8oKSkge1xuICAgICAgQ2hhbm5lbCA9IGZ1bmN0aW9uKG1hbmFnZXIsIHNvdW5kLCBvcHRpb25zKSB7XG4gICAgICAgIHRoaXMudm9sdW1lID0gb3B0aW9ucy52b2x1bWUgfHwgMTtcbiAgICAgICAgdGhpcy5sb29wID0gb3B0aW9ucy5sb29wIHx8IGZhbHNlO1xuICAgICAgICB0aGlzLnNvdW5kID0gc291bmQ7XG4gICAgICAgIHRoaXMucGl0Y2ggPSBvcHRpb25zLnBpdGNoICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnBpdGNoIDogMTtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdXNwZW5kZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tYW5hZ2VyID0gbWFuYWdlcjtcbiAgICAgICAgaWYgKHNvdW5kLmF1ZGlvKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VuZC5hdWRpby5jbG9uZU5vZGUoZmFsc2UpO1xuICAgICAgICAgIHRoaXMuc291cmNlLnBhdXNlKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBDaGFubmVsLnByb3RvdHlwZSA9IHtwbGF5OmZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMuc2V0Vm9sdW1lKHRoaXMudm9sdW1lKTtcbiAgICAgICAgICB0aGlzLnNldExvb3AodGhpcy5sb29wKTtcbiAgICAgICAgICB0aGlzLnNldFBpdGNoKHRoaXMucGl0Y2gpO1xuICAgICAgICAgIHRoaXMuc291cmNlLnBsYXkoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1hbmFnZXIub24oXCJ2b2x1bWVjaGFuZ2VcIiwgdGhpcy5vbk1hbmFnZXJWb2x1bWVDaGFuZ2UsIHRoaXMpO1xuICAgICAgICB0aGlzLm1hbmFnZXIub24oXCJzdXNwZW5kXCIsIHRoaXMub25NYW5hZ2VyU3VzcGVuZCwgdGhpcyk7XG4gICAgICAgIHRoaXMubWFuYWdlci5vbihcInJlc3VtZVwiLCB0aGlzLm9uTWFuYWdlclJlc3VtZSwgdGhpcyk7XG4gICAgICAgIGlmICh0aGlzLm1hbmFnZXIuc3VzcGVuZGVkKSB7XG4gICAgICAgICAgdGhpcy5vbk1hbmFnZXJTdXNwZW5kKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIHBhdXNlOmZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5zb3VyY2UucGF1c2UoKTtcbiAgICAgICAgfVxuICAgICAgfSwgdW5wYXVzZTpmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLnNvdXJjZS5wbGF5KCk7XG4gICAgICAgIH1cbiAgICAgIH0sIHN0b3A6ZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICh0aGlzLnNvdXJjZSkge1xuICAgICAgICAgIHRoaXMuc291cmNlLnBhdXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYW5hZ2VyLm9mZihcInZvbHVtZWNoYW5nZVwiLCB0aGlzLm9uTWFuYWdlclZvbHVtZUNoYW5nZSwgdGhpcyk7XG4gICAgICAgIHRoaXMubWFuYWdlci5vZmYoXCJzdXNwZW5kXCIsIHRoaXMub25NYW5hZ2VyU3VzcGVuZCwgdGhpcyk7XG4gICAgICAgIHRoaXMubWFuYWdlci5vZmYoXCJyZXN1bWVcIiwgdGhpcy5vbk1hbmFnZXJSZXN1bWUsIHRoaXMpO1xuICAgICAgfSwgc2V0Vm9sdW1lOmZ1bmN0aW9uKHZvbHVtZSkge1xuICAgICAgICB2b2x1bWUgPSBwYy5tYXRoLmNsYW1wKHZvbHVtZSwgMCwgMSk7XG4gICAgICAgIHRoaXMudm9sdW1lID0gdm9sdW1lO1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICB0aGlzLnNvdXJjZS52b2x1bWUgPSB2b2x1bWUgKiB0aGlzLm1hbmFnZXIudm9sdW1lO1xuICAgICAgICB9XG4gICAgICB9LCBzZXRMb29wOmZ1bmN0aW9uKGxvb3ApIHtcbiAgICAgICAgdGhpcy5sb29wID0gbG9vcDtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2UubG9vcCA9IGxvb3A7XG4gICAgICAgIH1cbiAgICAgIH0sIHNldFBpdGNoOmZ1bmN0aW9uKHBpdGNoKSB7XG4gICAgICAgIHRoaXMucGl0Y2ggPSBwaXRjaDtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5zb3VyY2UucGxheWJhY2tSYXRlID0gcGl0Y2g7XG4gICAgICAgIH1cbiAgICAgIH0sIGdldER1cmF0aW9uOmZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5zb3VyY2UpIHtcbiAgICAgICAgICB2YXIgZCA9IHRoaXMuc291cmNlLmR1cmF0aW9uO1xuICAgICAgICAgIGlmIChkID09PSBkKSB7XG4gICAgICAgICAgICByZXR1cm4gZDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9LCBpc1BsYXlpbmc6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiAhdGhpcy5zb3VyY2UucGF1c2VkO1xuICAgICAgfX07XG4gICAgfSBlbHNlIHtcbiAgICAgIENoYW5uZWwgPSBmdW5jdGlvbigpIHtcbiAgICAgIH07XG4gICAgfVxuICB9XG4gIHBjLmV4dGVuZChDaGFubmVsLnByb3RvdHlwZSwge2dldFZvbHVtZTpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy52b2x1bWU7XG4gIH0sIGdldExvb3A6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMubG9vcDtcbiAgfSwgZ2V0UGl0Y2g6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucGl0Y2g7XG4gIH0sIG9uTWFuYWdlclZvbHVtZUNoYW5nZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLnNldFZvbHVtZSh0aGlzLmdldFZvbHVtZSgpKTtcbiAgfSwgb25NYW5hZ2VyU3VzcGVuZDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5pc1BsYXlpbmcoKSAmJiAhdGhpcy5zdXNwZW5kZWQpIHtcbiAgICAgIHRoaXMuc3VzcGVuZGVkID0gdHJ1ZTtcbiAgICAgIHRoaXMucGF1c2UoKTtcbiAgICB9XG4gIH0sIG9uTWFuYWdlclJlc3VtZTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5zdXNwZW5kZWQpIHtcbiAgICAgIHRoaXMuc3VzcGVuZGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnVucGF1c2UoKTtcbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtDaGFubmVsOkNoYW5uZWx9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBNQVhfRElTVEFOQ0UgPSAxMDAwMDtcbiAgdmFyIENoYW5uZWwzZDtcbiAgaWYgKHBjLkF1ZGlvTWFuYWdlci5oYXNBdWRpb0NvbnRleHQoKSkge1xuICAgIENoYW5uZWwzZCA9IGZ1bmN0aW9uKG1hbmFnZXIsIHNvdW5kLCBvcHRpb25zKSB7XG4gICAgICB0aGlzLnBvc2l0aW9uID0gbmV3IHBjLlZlYzM7XG4gICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IHBjLlZlYzM7XG4gICAgICB2YXIgY29udGV4dCA9IG1hbmFnZXIuY29udGV4dDtcbiAgICAgIHRoaXMucGFubmVyID0gY29udGV4dC5jcmVhdGVQYW5uZXIoKTtcbiAgICB9O1xuICAgIENoYW5uZWwzZCA9IHBjLmluaGVyaXRzKENoYW5uZWwzZCwgcGMuQ2hhbm5lbCk7XG4gICAgQ2hhbm5lbDNkLnByb3RvdHlwZSA9IHBjLmV4dGVuZChDaGFubmVsM2QucHJvdG90eXBlLCB7Z2V0UG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbjtcbiAgICB9LCBzZXRQb3NpdGlvbjpmdW5jdGlvbihwb3NpdGlvbikge1xuICAgICAgdGhpcy5wb3NpdGlvbi5jb3B5KHBvc2l0aW9uKTtcbiAgICAgIHRoaXMucGFubmVyLnNldFBvc2l0aW9uKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHBvc2l0aW9uLnopO1xuICAgIH0sIGdldFZlbG9jaXR5OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMudmVsb2NpdHk7XG4gICAgfSwgc2V0VmVsb2NpdHk6ZnVuY3Rpb24odmVsb2NpdHkpIHtcbiAgICAgIHRoaXMudmVsb2NpdHkuY29weSh2ZWxvY2l0eSk7XG4gICAgICB0aGlzLnBhbm5lci5zZXRWZWxvY2l0eSh2ZWxvY2l0eS54LCB2ZWxvY2l0eS55LCB2ZWxvY2l0eS56KTtcbiAgICB9LCBnZXRNYXhEaXN0YW5jZTpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhbm5lci5tYXhEaXN0YW5jZTtcbiAgICB9LCBzZXRNYXhEaXN0YW5jZTpmdW5jdGlvbihtYXgpIHtcbiAgICAgIHRoaXMucGFubmVyLm1heERpc3RhbmNlID0gbWF4O1xuICAgIH0sIGdldE1pbkRpc3RhbmNlOmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMucGFubmVyLnJlZkRpc3RhbmNlO1xuICAgIH0sIHNldE1pbkRpc3RhbmNlOmZ1bmN0aW9uKG1pbikge1xuICAgICAgdGhpcy5wYW5uZXIucmVmRGlzdGFuY2UgPSBtaW47XG4gICAgfSwgZ2V0Um9sbE9mZkZhY3RvcjpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhbm5lci5yb2xsb2ZmRmFjdG9yO1xuICAgIH0sIHNldFJvbGxPZmZGYWN0b3I6ZnVuY3Rpb24oZmFjdG9yKSB7XG4gICAgICB0aGlzLnBhbm5lci5yb2xsb2ZmRmFjdG9yID0gZmFjdG9yO1xuICAgIH0sIGdldERpc3RhbmNlTW9kZWw6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYW5uZWwuZGlzdGFuY2VNb2RlbDtcbiAgICB9LCBzZXREaXN0YW5jZU1vZGVsOmZ1bmN0aW9uKGRpc3RhbmNlTW9kZWwpIHtcbiAgICAgIHRoaXMucGFubmVyLmRpc3RhbmNlTW9kZWwgPSBkaXN0YW5jZU1vZGVsO1xuICAgIH0sIF9jcmVhdGVTb3VyY2U6ZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgY29udGV4dCA9IHRoaXMubWFuYWdlci5jb250ZXh0O1xuICAgICAgdGhpcy5zb3VyY2UgPSBjb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO1xuICAgICAgdGhpcy5zb3VyY2UuYnVmZmVyID0gdGhpcy5zb3VuZC5idWZmZXI7XG4gICAgICB0aGlzLnNvdXJjZS5jb25uZWN0KHRoaXMucGFubmVyKTtcbiAgICAgIHRoaXMucGFubmVyLmNvbm5lY3QodGhpcy5nYWluKTtcbiAgICAgIHRoaXMuZ2Fpbi5jb25uZWN0KGNvbnRleHQuZGVzdGluYXRpb24pO1xuICAgICAgaWYgKCF0aGlzLmxvb3ApIHtcbiAgICAgICAgdGhpcy5zb3VyY2Uub25lbmRlZCA9IHRoaXMucGF1c2UuYmluZCh0aGlzKTtcbiAgICAgIH1cbiAgICB9fSk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHBjLkF1ZGlvTWFuYWdlci5oYXNBdWRpbygpKSB7XG4gICAgICB2YXIgb2Zmc2V0ID0gbmV3IHBjLlZlYzM7XG4gICAgICB2YXIgZmFsbE9mZiA9IGZ1bmN0aW9uKHBvc09uZSwgcG9zVHdvLCByZWZEaXN0YW5jZSwgbWF4RGlzdGFuY2UsIHJvbGxvZmZGYWN0b3IsIGRpc3RhbmNlTW9kZWwpIHtcbiAgICAgICAgb2Zmc2V0ID0gb2Zmc2V0LnN1YjIocG9zT25lLCBwb3NUd28pO1xuICAgICAgICB2YXIgZGlzdGFuY2UgPSBvZmZzZXQubGVuZ3RoKCk7XG4gICAgICAgIGlmIChkaXN0YW5jZSA8IHJlZkRpc3RhbmNlKSB7XG4gICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGRpc3RhbmNlID4gbWF4RGlzdGFuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gMDtcbiAgICAgICAgICAgIGlmIChkaXN0YW5jZU1vZGVsID09PSBwYy5ESVNUQU5DRV9MSU5FQVIpIHtcbiAgICAgICAgICAgICAgcmVzdWx0ID0gMSAtIHJvbGxvZmZGYWN0b3IgKiAoZGlzdGFuY2UgLSByZWZEaXN0YW5jZSkgLyAobWF4RGlzdGFuY2UgLSByZWZEaXN0YW5jZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAoZGlzdGFuY2VNb2RlbCA9PT0gcGMuRElTVEFOQ0VfSU5WRVJTRSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlZkRpc3RhbmNlIC8gKHJlZkRpc3RhbmNlICsgcm9sbG9mZkZhY3RvciAqIChkaXN0YW5jZSAtIHJlZkRpc3RhbmNlKSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlTW9kZWwgPT09IHBjLkRJU1RBTkNFX0VYUE9ORU5USUFMKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQgPSBNYXRoLnBvdyhkaXN0YW5jZSAvIHJlZkRpc3RhbmNlLCAtcm9sbG9mZkZhY3Rvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcGMubWF0aC5jbGFtcChyZXN1bHQsIDAsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIENoYW5uZWwzZCA9IGZ1bmN0aW9uKG1hbmFnZXIsIHNvdW5kKSB7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgcGMuVmVjMztcbiAgICAgICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBwYy5WZWMzO1xuICAgICAgICB0aGlzLm1heERpc3RhbmNlID0gTUFYX0RJU1RBTkNFO1xuICAgICAgICB0aGlzLm1pbkRpc3RhbmNlID0gMTtcbiAgICAgICAgdGhpcy5yb2xsT2ZmRmFjdG9yID0gMTtcbiAgICAgICAgdGhpcy5kaXN0YW5jZU1vZGVsID0gcGMuRElTVEFOQ0VfSU5WRVJTRTtcbiAgICAgIH07XG4gICAgICBDaGFubmVsM2QgPSBwYy5pbmhlcml0cyhDaGFubmVsM2QsIHBjLkNoYW5uZWwpO1xuICAgICAgQ2hhbm5lbDNkLnByb3RvdHlwZSA9IHBjLmV4dGVuZChDaGFubmVsM2QucHJvdG90eXBlLCB7Z2V0UG9zaXRpb246ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uO1xuICAgICAgfSwgc2V0UG9zaXRpb246ZnVuY3Rpb24ocG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5wb3NpdGlvbi5jb3B5KHBvc2l0aW9uKTtcbiAgICAgICAgaWYgKHRoaXMuc291cmNlKSB7XG4gICAgICAgICAgdmFyIGxpc3RlbmVyID0gdGhpcy5tYW5hZ2VyLmxpc3RlbmVyO1xuICAgICAgICAgIHZhciBscG9zID0gbGlzdGVuZXIuZ2V0UG9zaXRpb24oKTtcbiAgICAgICAgICB2YXIgZmFjdG9yID0gZmFsbE9mZihscG9zLCB0aGlzLnBvc2l0aW9uLCB0aGlzLm1pbkRpc3RhbmNlLCB0aGlzLm1heERpc3RhbmNlLCB0aGlzLnJvbGxPZmZGYWN0b3IsIHRoaXMuZGlzdGFuY2VNb2RlbCk7XG4gICAgICAgICAgdmFyIHYgPSB0aGlzLmdldFZvbHVtZSgpO1xuICAgICAgICAgIHRoaXMuc291cmNlLnZvbHVtZSA9IHYgKiBmYWN0b3I7XG4gICAgICAgIH1cbiAgICAgIH0sIGdldFZlbG9jaXR5OmZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy52ZWxvY2l0eTtcbiAgICAgIH0sIHNldFZlbG9jaXR5OmZ1bmN0aW9uKHZlbG9jaXR5KSB7XG4gICAgICAgIHRoaXMudmVsb2NpdHkuY29weSh2ZWxvY2l0eSk7XG4gICAgICB9LCBnZXRNYXhEaXN0YW5jZTpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4RGlzdGFuY2U7XG4gICAgICB9LCBzZXRNYXhEaXN0YW5jZTpmdW5jdGlvbihtYXgpIHtcbiAgICAgICAgdGhpcy5tYXhEaXN0YW5jZSA9IG1heDtcbiAgICAgIH0sIGdldE1pbkRpc3RhbmNlOmZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5taW5EaXN0YW5jZTtcbiAgICAgIH0sIHNldE1pbkRpc3RhbmNlOmZ1bmN0aW9uKG1pbikge1xuICAgICAgICB0aGlzLm1pbkRpc3RhbmNlID0gbWluO1xuICAgICAgfSwgZ2V0Um9sbE9mZkZhY3RvcjpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm9sbE9mZkZhY3RvcjtcbiAgICAgIH0sIHNldFJvbGxPZmZGYWN0b3I6ZnVuY3Rpb24oZmFjdG9yKSB7XG4gICAgICAgIHRoaXMucm9sbE9mZkZhY3RvciA9IGZhY3RvcjtcbiAgICAgIH0sIGdldERpc3RhbmNlTW9kZWw6ZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3RhbmNlTW9kZWw7XG4gICAgICB9LCBzZXREaXN0YW5jZU1vZGVsOmZ1bmN0aW9uKGRpc3RhbmNlTW9kZWwpIHtcbiAgICAgICAgdGhpcy5kaXN0YW5jZU1vZGVsID0gZGlzdGFuY2VNb2RlbDtcbiAgICAgIH19KTtcbiAgICB9IGVsc2Uge1xuICAgICAgQ2hhbm5lbDNkID0gZnVuY3Rpb24oKSB7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuICByZXR1cm4ge0NoYW5uZWwzZDpDaGFubmVsM2R9O1xufSgpKTtcbihmdW5jdGlvbigpIHtcbiAgdmFyIGVudW1zID0ge0FDVElPTl9NT1VTRTpcIm1vdXNlXCIsIEFDVElPTl9LRVlCT0FSRDpcImtleWJvYXJkXCIsIEFDVElPTl9HQU1FUEFEOlwiZ2FtZXBhZFwiLCBBWElTX01PVVNFX1g6XCJtb3VzZXhcIiwgQVhJU19NT1VTRV9ZOlwibW91c2V5XCIsIEFYSVNfUEFEX0xfWDpcInBhZGx4XCIsIEFYSVNfUEFEX0xfWTpcInBhZGx5XCIsIEFYSVNfUEFEX1JfWDpcInBhZHJ4XCIsIEFYSVNfUEFEX1JfWTpcInBhZHJ5XCIsIEFYSVNfS0VZOlwia2V5XCIsIEVWRU5UX0tFWURPV046XCJrZXlkb3duXCIsIEVWRU5UX0tFWVVQOlwia2V5dXBcIiwgRVZFTlRfTU9VU0VET1dOOlwibW91c2Vkb3duXCIsIEVWRU5UX01PVVNFTU9WRTpcIm1vdXNlbW92ZVwiLCBFVkVOVF9NT1VTRVVQOlwibW91c2V1cFwiLCBFVkVOVF9NT1VTRVdIRUVMOlwibW91c2V3aGVlbFwiLCBFVkVOVF9UT1VDSFNUQVJUOlwidG91Y2hzdGFydFwiLCBFVkVOVF9UT1VDSEVORDpcInRvdWNoZW5kXCIsIEVWRU5UX1RPVUNITU9WRTpcInRvdWNobW92ZVwiLCBFVkVOVF9UT1VDSENBTkNFTDpcInRvdWNoY2FuY2VsXCIsXG4gIEtFWV9CQUNLU1BBQ0U6OCwgS0VZX1RBQjo5LCBLRVlfUkVUVVJOOjEzLCBLRVlfRU5URVI6MTMsIEtFWV9TSElGVDoxNiwgS0VZX0NPTlRST0w6MTcsIEtFWV9BTFQ6MTgsIEtFWV9QQVVTRToxOSwgS0VZX0NBUFNfTE9DSzoyMCwgS0VZX0VTQ0FQRToyNywgS0VZX1NQQUNFOjMyLCBLRVlfUEFHRV9VUDozMywgS0VZX1BBR0VfRE9XTjozNCwgS0VZX0VORDozNSwgS0VZX0hPTUU6MzYsIEtFWV9MRUZUOjM3LCBLRVlfVVA6MzgsIEtFWV9SSUdIVDozOSwgS0VZX0RPV046NDAsIEtFWV9QUklOVF9TQ1JFRU46NDQsIEtFWV9JTlNFUlQ6NDUsIEtFWV9ERUxFVEU6NDYsIEtFWV8wOjQ4LCBLRVlfMTo0OSwgS0VZXzI6NTAsIEtFWV8zOjUxLCBLRVlfNDo1MiwgS0VZXzU6NTMsIEtFWV82OjU0LCBLRVlfNzo1NSwgS0VZXzg6NTYsIEtFWV85OjU3LCBLRVlfU0VNSUNPTE9OOjU5LCBLRVlfRVFVQUw6NjEsIEtFWV9BOjY1LCBLRVlfQjo2NiwgS0VZX0M6NjcsIEtFWV9EOjY4LCBLRVlfRTo2OSxcbiAgS0VZX0Y6NzAsIEtFWV9HOjcxLCBLRVlfSDo3MiwgS0VZX0k6NzMsIEtFWV9KOjc0LCBLRVlfSzo3NSwgS0VZX0w6NzYsIEtFWV9NOjc3LCBLRVlfTjo3OCwgS0VZX086NzksIEtFWV9QOjgwLCBLRVlfUTo4MSwgS0VZX1I6ODIsIEtFWV9TOjgzLCBLRVlfVDo4NCwgS0VZX1U6ODUsIEtFWV9WOjg2LCBLRVlfVzo4NywgS0VZX1g6ODgsIEtFWV9ZOjg5LCBLRVlfWjo5MCwgS0VZX1dJTkRPV1M6OTEsIEtFWV9DT05URVhUX01FTlU6OTMsIEtFWV9OVU1QQURfMDo5NiwgS0VZX05VTVBBRF8xOjk3LCBLRVlfTlVNUEFEXzI6OTgsIEtFWV9OVU1QQURfMzo5OSwgS0VZX05VTVBBRF80OjEwMCwgS0VZX05VTVBBRF81OjEwMSwgS0VZX05VTVBBRF82OjEwMiwgS0VZX05VTVBBRF83OjEwMywgS0VZX05VTVBBRF84OjEwNCwgS0VZX05VTVBBRF85OjEwNSwgS0VZX01VTFRJUExZOjEwNiwgS0VZX0FERDoxMDcsIEtFWV9TRVBBUkFUT1I6MTA4LCBLRVlfU1VCVFJBQ1Q6MTA5LCBLRVlfREVDSU1BTDoxMTAsXG4gIEtFWV9ESVZJREU6MTExLCBLRVlfRjE6MTEyLCBLRVlfRjI6MTEzLCBLRVlfRjM6MTE0LCBLRVlfRjQ6MTE1LCBLRVlfRjU6MTE2LCBLRVlfRjY6MTE3LCBLRVlfRjc6MTE4LCBLRVlfRjg6MTE5LCBLRVlfRjk6MTIwLCBLRVlfRjEwOjEyMSwgS0VZX0YxMToxMjIsIEtFWV9GMTI6MTIzLCBLRVlfQ09NTUE6MTg4LCBLRVlfUEVSSU9EOjE5MCwgS0VZX1NMQVNIOjE5MSwgS0VZX09QRU5fQlJBQ0tFVDoyMTksIEtFWV9CQUNLX1NMQVNIOjIyMCwgS0VZX0NMT1NFX0JSQUNLRVQ6MjIxLCBLRVlfTUVUQToyMjQsIE1PVVNFQlVUVE9OX05PTkU6LTEsIE1PVVNFQlVUVE9OX0xFRlQ6MCwgTU9VU0VCVVRUT05fTUlERExFOjEsIE1PVVNFQlVUVE9OX1JJR0hUOjIsIFBBRF8xOjAsIFBBRF8yOjEsIFBBRF8zOjIsIFBBRF80OjMsIFBBRF9GQUNFXzE6MCwgUEFEX0ZBQ0VfMjoxLCBQQURfRkFDRV8zOjIsIFBBRF9GQUNFXzQ6MywgUEFEX0xfU0hPVUxERVJfMTo0LCBQQURfUl9TSE9VTERFUl8xOjUsXG4gIFBBRF9MX1NIT1VMREVSXzI6NiwgUEFEX1JfU0hPVUxERVJfMjo3LCBQQURfU0VMRUNUOjgsIFBBRF9TVEFSVDo5LCBQQURfTF9TVElDS19CVVRUT046MTAsIFBBRF9SX1NUSUNLX0JVVFRPTjoxMSwgUEFEX1VQOjEyLCBQQURfRE9XTjoxMywgUEFEX0xFRlQ6MTQsIFBBRF9SSUdIVDoxNSwgUEFEX1ZFTkRPUjoxNiwgUEFEX0xfU1RJQ0tfWDowLCBQQURfTF9TVElDS19ZOjEsIFBBRF9SX1NUSUNLX1g6MiwgUEFEX1JfU1RJQ0tfWTozfTtcbiAgcGMuZXh0ZW5kKHBjLCBlbnVtcyk7XG4gIHBjLmlucHV0ID0ge307XG4gIHBjLmV4dGVuZChwYy5pbnB1dCwgZW51bXMpO1xufSkoKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBNb3VzZUV2ZW50ID0gZnVuY3Rpb24obW91c2UsIGV2ZW50KSB7XG4gICAgdmFyIGNvb3JkcyA9IHt4OjAsIHk6MH07XG4gICAgaWYgKGV2ZW50KSB7XG4gICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIHRocm93IEVycm9yKFwiRXhwZWN0ZWQgTW91c2VFdmVudFwiKTtcbiAgICAgIH1cbiAgICAgIGNvb3JkcyA9IG1vdXNlLl9nZXRUYXJnZXRDb29yZHMoZXZlbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBldmVudCA9IHt9O1xuICAgIH1cbiAgICBpZiAoY29vcmRzKSB7XG4gICAgICB0aGlzLnggPSBjb29yZHMueDtcbiAgICAgIHRoaXMueSA9IGNvb3Jkcy55O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocGMuTW91c2UuaXNQb2ludGVyTG9ja2VkKCkpIHtcbiAgICAgICAgdGhpcy54ID0gMDtcbiAgICAgICAgdGhpcy55ID0gMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGV2ZW50LmRldGFpbCkge1xuICAgICAgdGhpcy53aGVlbCA9IC0xICogZXZlbnQuZGV0YWlsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZXZlbnQud2hlZWxEZWx0YSkge1xuICAgICAgICB0aGlzLndoZWVsID0gZXZlbnQud2hlZWxEZWx0YSAvIDEyMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMud2hlZWwgPSAwO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocGMuTW91c2UuaXNQb2ludGVyTG9ja2VkKCkpIHtcbiAgICAgIHRoaXMuZHggPSBldmVudC5tb3ZlbWVudFggfHwgZXZlbnQud2Via2l0TW92ZW1lbnRYIHx8IGV2ZW50Lm1vek1vdmVtZW50WCB8fCAwO1xuICAgICAgdGhpcy5keSA9IGV2ZW50Lm1vdmVtZW50WSB8fCBldmVudC53ZWJraXRNb3ZlbWVudFkgfHwgZXZlbnQubW96TW92ZW1lbnRZIHx8IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZHggPSB0aGlzLnggLSBtb3VzZS5fbGFzdFg7XG4gICAgICB0aGlzLmR5ID0gdGhpcy55IC0gbW91c2UuX2xhc3RZO1xuICAgIH1cbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gXCJtb3VzZWRvd25cIiB8fCBldmVudC50eXBlID09PSBcIm1vdXNldXBcIikge1xuICAgICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYnV0dG9uID0gcGMuTU9VU0VCVVRUT05fTk9ORTtcbiAgICB9XG4gICAgdGhpcy5idXR0b25zID0gbW91c2UuX2J1dHRvbnMuc2xpY2UoMCk7XG4gICAgdGhpcy5lbGVtZW50ID0gZXZlbnQudGFyZ2V0O1xuICAgIHRoaXMuY3RybEtleSA9IGV2ZW50LmN0cmxLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5hbHRLZXkgPSBldmVudC5hbHRLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5zaGlmdEtleSA9IGV2ZW50LnNoaWZ0S2V5IHx8IGZhbHNlO1xuICAgIHRoaXMubWV0YUtleSA9IGV2ZW50Lm1ldGFLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5ldmVudCA9IGV2ZW50O1xuICB9O1xuICB2YXIgTW91c2UgPSBmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgdGhpcy5fbGFzdFggPSAwO1xuICAgIHRoaXMuX2xhc3RZID0gMDtcbiAgICB0aGlzLl9idXR0b25zID0gW2ZhbHNlLCBmYWxzZSwgZmFsc2VdO1xuICAgIHRoaXMuX2xhc3RidXR0b25zID0gW2ZhbHNlLCBmYWxzZSwgZmFsc2VdO1xuICAgIHRoaXMuX3VwSGFuZGxlciA9IHRoaXMuX2hhbmRsZVVwLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fZG93bkhhbmRsZXIgPSB0aGlzLl9oYW5kbGVEb3duLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fbW92ZUhhbmRsZXIgPSB0aGlzLl9oYW5kbGVNb3ZlLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fd2hlZWxIYW5kbGVyID0gdGhpcy5faGFuZGxlV2hlZWwuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9jb250ZXh0TWVudUhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9O1xuICAgIHRoaXMuX3RhcmdldCA9IG51bGw7XG4gICAgdGhpcy5fYXR0YWNoZWQgPSBmYWxzZTtcbiAgICB0aGlzLmF0dGFjaChlbGVtZW50KTtcbiAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICB9O1xuICBNb3VzZS5pc1BvaW50ZXJMb2NrZWQgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gISEoZG9jdW1lbnQucG9pbnRlckxvY2tFbGVtZW50IHx8IGRvY3VtZW50Lm1velBvaW50ZXJMb2NrRWxlbWVudCB8fCBkb2N1bWVudC53ZWJraXRQb2ludGVyTG9ja0VsZW1lbnQpO1xuICB9O1xuICBNb3VzZS5wcm90b3R5cGUgPSB7YXR0YWNoOmZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICB0aGlzLl90YXJnZXQgPSBlbGVtZW50O1xuICAgIGlmICh0aGlzLl9hdHRhY2hlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9hdHRhY2hlZCA9IHRydWU7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZXVwXCIsIHRoaXMuX3VwSGFuZGxlciwgZmFsc2UpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsIHRoaXMuX2Rvd25IYW5kbGVyLCBmYWxzZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW1vdmVcIiwgdGhpcy5fbW92ZUhhbmRsZXIsIGZhbHNlKTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNld2hlZWxcIiwgdGhpcy5fd2hlZWxIYW5kbGVyLCBmYWxzZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJET01Nb3VzZVNjcm9sbFwiLCB0aGlzLl93aGVlbEhhbmRsZXIsIGZhbHNlKTtcbiAgfSwgZGV0YWNoOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fYXR0YWNoZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fYXR0YWNoZWQgPSBmYWxzZTtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5fdXBIYW5kbGVyKTtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCB0aGlzLl9kb3duSGFuZGxlcik7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtb3VzZW1vdmVcIiwgdGhpcy5fbW92ZUhhbmRsZXIpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2V3aGVlbFwiLCB0aGlzLl93aGVlbEhhbmRsZXIpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwiRE9NTW91c2VTY3JvbGxcIiwgdGhpcy5fd2hlZWxIYW5kbGVyKTtcbiAgfSwgZGlzYWJsZUNvbnRleHRNZW51OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fdGFyZ2V0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3RhcmdldC5hZGRFdmVudExpc3RlbmVyKFwiY29udGV4dG1lbnVcIiwgdGhpcy5fY29udGV4dE1lbnVIYW5kbGVyKTtcbiAgfSwgZW5hYmxlQ29udGV4dE1lbnU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLl90YXJnZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjb250ZXh0bWVudVwiLCB0aGlzLl9jb250ZXh0TWVudUhhbmRsZXIpO1xuICB9LCBlbmFibGVQb2ludGVyTG9jazpmdW5jdGlvbihzdWNjZXNzLCBlcnJvcikge1xuICAgIGlmICghZG9jdW1lbnQuYm9keS5yZXF1ZXN0UG9pbnRlckxvY2spIHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBlcnJvcigpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgc3VjY2VzcygpO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInBvaW50ZXJsb2NrY2hhbmdlXCIsIHMpO1xuICAgIH07XG4gICAgdmFyIGUgPSBmdW5jdGlvbigpIHtcbiAgICAgIGVycm9yKCk7XG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwicG9pbnRlcmxvY2tlcnJvclwiLCBlKTtcbiAgICB9O1xuICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwicG9pbnRlcmxvY2tjaGFuZ2VcIiwgcywgZmFsc2UpO1xuICAgIH1cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJwb2ludGVybG9ja2Vycm9yXCIsIGUsIGZhbHNlKTtcbiAgICB9XG4gICAgZG9jdW1lbnQuYm9keS5yZXF1ZXN0UG9pbnRlckxvY2soKTtcbiAgfSwgZGlzYWJsZVBvaW50ZXJMb2NrOmZ1bmN0aW9uKHN1Y2Nlc3MpIHtcbiAgICBpZiAoIWRvY3VtZW50LmV4aXRQb2ludGVyTG9jaykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgc3VjY2VzcygpO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInBvaW50ZXJsb2NrY2hhbmdlXCIsIHMpO1xuICAgIH07XG4gICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJwb2ludGVybG9ja2NoYW5nZVwiLCBzLCBmYWxzZSk7XG4gICAgfVxuICAgIGRvY3VtZW50LmV4aXRQb2ludGVyTG9jaygpO1xuICB9LCB1cGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB0aGlzLl9sYXN0YnV0dG9uc1swXSA9IHRoaXMuX2J1dHRvbnNbMF07XG4gICAgdGhpcy5fbGFzdGJ1dHRvbnNbMV0gPSB0aGlzLl9idXR0b25zWzFdO1xuICAgIHRoaXMuX2xhc3RidXR0b25zWzJdID0gdGhpcy5fYnV0dG9uc1syXTtcbiAgfSwgaXNQcmVzc2VkOmZ1bmN0aW9uKGJ1dHRvbikge1xuICAgIHJldHVybiB0aGlzLl9idXR0b25zW2J1dHRvbl07XG4gIH0sIHdhc1ByZXNzZWQ6ZnVuY3Rpb24oYnV0dG9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2J1dHRvbnNbYnV0dG9uXSAmJiAhdGhpcy5fbGFzdGJ1dHRvbnNbYnV0dG9uXTtcbiAgfSwgd2FzUmVsZWFzZWQ6ZnVuY3Rpb24oYnV0dG9uKSB7XG4gICAgcmV0dXJuICF0aGlzLl9idXR0b25zW2J1dHRvbl0gJiYgdGhpcy5fbGFzdGJ1dHRvbnNbYnV0dG9uXTtcbiAgfSwgX2hhbmRsZVVwOmZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgdGhpcy5fYnV0dG9uc1tldmVudC5idXR0b25dID0gZmFsc2U7XG4gICAgdmFyIGUgPSBuZXcgTW91c2VFdmVudCh0aGlzLCBldmVudCk7XG4gICAgaWYgKCFlLmV2ZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZmlyZShwYy5FVkVOVF9NT1VTRVVQLCBlKTtcbiAgfSwgX2hhbmRsZURvd246ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB0aGlzLl9idXR0b25zW2V2ZW50LmJ1dHRvbl0gPSB0cnVlO1xuICAgIHZhciBlID0gbmV3IE1vdXNlRXZlbnQodGhpcywgZXZlbnQpO1xuICAgIGlmICghZS5ldmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmZpcmUocGMuRVZFTlRfTU9VU0VET1dOLCBlKTtcbiAgfSwgX2hhbmRsZU1vdmU6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgZSA9IG5ldyBNb3VzZUV2ZW50KHRoaXMsIGV2ZW50KTtcbiAgICBpZiAoIWUuZXZlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5maXJlKHBjLkVWRU5UX01PVVNFTU9WRSwgZSk7XG4gICAgdGhpcy5fbGFzdFggPSBlLng7XG4gICAgdGhpcy5fbGFzdFkgPSBlLnk7XG4gIH0sIF9oYW5kbGVXaGVlbDpmdW5jdGlvbihldmVudCkge1xuICAgIHZhciBlID0gbmV3IE1vdXNlRXZlbnQodGhpcywgZXZlbnQpO1xuICAgIGlmICghZS5ldmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmZpcmUocGMuRVZFTlRfTU9VU0VXSEVFTCwgZSk7XG4gIH0sIF9nZXRUYXJnZXRDb29yZHM6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgcmVjdCA9IHRoaXMuX3RhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICB2YXIgbGVmdCA9IE1hdGguZmxvb3IocmVjdC5sZWZ0KTtcbiAgICB2YXIgdG9wID0gTWF0aC5mbG9vcihyZWN0LnRvcCk7XG4gICAgaWYgKGV2ZW50LmNsaWVudFggPCBsZWZ0IHx8IGV2ZW50LmNsaWVudFggPj0gbGVmdCArIHRoaXMuX3RhcmdldC5jbGllbnRXaWR0aCB8fCBldmVudC5jbGllbnRZIDwgdG9wIHx8IGV2ZW50LmNsaWVudFkgPj0gdG9wICsgdGhpcy5fdGFyZ2V0LmNsaWVudEhlaWdodCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiB7eDpldmVudC5jbGllbnRYIC0gbGVmdCwgeTpldmVudC5jbGllbnRZIC0gdG9wfTtcbiAgfX07XG4gIChmdW5jdGlvbigpIHtcbiAgICBpZiAodHlwZW9mIG5hdmlnYXRvciA9PT0gXCJ1bmRlZmluZWRcIiB8fCB0eXBlb2YgZG9jdW1lbnQgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbmF2aWdhdG9yLnBvaW50ZXIgPSBuYXZpZ2F0b3IucG9pbnRlciB8fCBuYXZpZ2F0b3Iud2Via2l0UG9pbnRlciB8fCBuYXZpZ2F0b3IubW96UG9pbnRlcjtcbiAgICB2YXIgcG9pbnRlcmxvY2tjaGFuZ2UgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoXCJDdXN0b21FdmVudFwiKTtcbiAgICAgIGUuaW5pdEN1c3RvbUV2ZW50KFwicG9pbnRlcmxvY2tjaGFuZ2VcIiwgdHJ1ZSwgZmFsc2UsIG51bGwpO1xuICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChlKTtcbiAgICB9O1xuICAgIHZhciBwb2ludGVybG9ja2Vycm9yID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KFwiQ3VzdG9tRXZlbnRcIik7XG4gICAgICBlLmluaXRDdXN0b21FdmVudChcInBvaW50ZXJsb2NrZXJyb3JcIiwgdHJ1ZSwgZmFsc2UsIG51bGwpO1xuICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChlKTtcbiAgICB9O1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJ3ZWJraXRwb2ludGVybG9ja2NoYW5nZVwiLCBwb2ludGVybG9ja2NoYW5nZSwgZmFsc2UpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJ3ZWJraXRwb2ludGVybG9ja2xvc3RcIiwgcG9pbnRlcmxvY2tjaGFuZ2UsIGZhbHNlKTtcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW96cG9pbnRlcmxvY2tjaGFuZ2VcIiwgcG9pbnRlcmxvY2tjaGFuZ2UsIGZhbHNlKTtcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW96cG9pbnRlcmxvY2tsb3N0XCIsIHBvaW50ZXJsb2NrY2hhbmdlLCBmYWxzZSk7XG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIndlYmtpdHBvaW50ZXJsb2NrZXJyb3JcIiwgcG9pbnRlcmxvY2tlcnJvciwgZmFsc2UpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3pwb2ludGVybG9ja2Vycm9yXCIsIHBvaW50ZXJsb2NrZXJyb3IsIGZhbHNlKTtcbiAgICBpZiAoRWxlbWVudC5wcm90b3R5cGUubW96UmVxdWVzdFBvaW50ZXJMb2NrKSB7XG4gICAgICBFbGVtZW50LnByb3RvdHlwZS5yZXF1ZXN0UG9pbnRlckxvY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5tb3pSZXF1ZXN0UG9pbnRlckxvY2soKTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIEVsZW1lbnQucHJvdG90eXBlLnJlcXVlc3RQb2ludGVyTG9jayA9IEVsZW1lbnQucHJvdG90eXBlLnJlcXVlc3RQb2ludGVyTG9jayB8fCBFbGVtZW50LnByb3RvdHlwZS53ZWJraXRSZXF1ZXN0UG9pbnRlckxvY2sgfHwgRWxlbWVudC5wcm90b3R5cGUubW96UmVxdWVzdFBvaW50ZXJMb2NrO1xuICAgIH1cbiAgICBpZiAoIUVsZW1lbnQucHJvdG90eXBlLnJlcXVlc3RQb2ludGVyTG9jayAmJiBuYXZpZ2F0b3IucG9pbnRlcikge1xuICAgICAgRWxlbWVudC5wcm90b3R5cGUucmVxdWVzdFBvaW50ZXJMb2NrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBlbCA9IHRoaXM7XG4gICAgICAgIGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCA9IGVsO1xuICAgICAgICBuYXZpZ2F0b3IucG9pbnRlci5sb2NrKGVsLCBwb2ludGVybG9ja2NoYW5nZSwgcG9pbnRlcmxvY2tlcnJvcik7XG4gICAgICB9O1xuICAgIH1cbiAgICBkb2N1bWVudC5leGl0UG9pbnRlckxvY2sgPSBkb2N1bWVudC5leGl0UG9pbnRlckxvY2sgfHwgZG9jdW1lbnQud2Via2l0RXhpdFBvaW50ZXJMb2NrIHx8IGRvY3VtZW50Lm1vekV4aXRQb2ludGVyTG9jaztcbiAgICBpZiAoIWRvY3VtZW50LmV4aXRQb2ludGVyTG9jaykge1xuICAgICAgZG9jdW1lbnQuZXhpdFBvaW50ZXJMb2NrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChuYXZpZ2F0b3IucG9pbnRlcikge1xuICAgICAgICAgIGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCA9IG51bGw7XG4gICAgICAgICAgbmF2aWdhdG9yLnBvaW50ZXIudW5sb2NrKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9KSgpO1xuICByZXR1cm4ge01vdXNlOk1vdXNlLCBNb3VzZUV2ZW50Ok1vdXNlRXZlbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBLZXlib2FyZEV2ZW50ID0gZnVuY3Rpb24oa2V5Ym9hcmQsIGV2ZW50KSB7XG4gICAgaWYgKGV2ZW50KSB7XG4gICAgICB0aGlzLmtleSA9IGV2ZW50LmtleUNvZGU7XG4gICAgICB0aGlzLmVsZW1lbnQgPSBldmVudC50YXJnZXQ7XG4gICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMua2V5ID0gbnVsbDtcbiAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7XG4gICAgICB0aGlzLmV2ZW50ID0gbnVsbDtcbiAgICB9XG4gIH07XG4gIHZhciBfa2V5Ym9hcmRFdmVudCA9IG5ldyBLZXlib2FyZEV2ZW50O1xuICBmdW5jdGlvbiBtYWtlS2V5Ym9hcmRFdmVudChldmVudCkge1xuICAgIF9rZXlib2FyZEV2ZW50LmtleSA9IGV2ZW50LmtleUNvZGU7XG4gICAgX2tleWJvYXJkRXZlbnQuZWxlbWVudCA9IGV2ZW50LnRhcmdldDtcbiAgICBfa2V5Ym9hcmRFdmVudC5ldmVudCA9IGV2ZW50O1xuICAgIHJldHVybiBfa2V5Ym9hcmRFdmVudDtcbiAgfVxuICBmdW5jdGlvbiB0b0tleUNvZGUocykge1xuICAgIGlmICh0eXBlb2YgcyA9PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gcy50b1VwcGVyQ2FzZSgpLmNoYXJDb2RlQXQoMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzO1xuICAgIH1cbiAgfVxuICB2YXIgX2tleUNvZGVUb0tleUlkZW50aWZpZXIgPSB7OTpcIlRhYlwiLCAxMzpcIkVudGVyXCIsIDE2OlwiU2hpZnRcIiwgMTc6XCJDb250cm9sXCIsIDE4OlwiQWx0XCIsIDI3OlwiRXNjYXBlXCIsIDM3OlwiTGVmdFwiLCAzODpcIlVwXCIsIDM5OlwiUmlnaHRcIiwgNDA6XCJEb3duXCIsIDQ2OlwiRGVsZXRlXCIsIDkxOlwiV2luXCJ9O1xuICB2YXIgS2V5Ym9hcmQgPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgdGhpcy5fZWxlbWVudCA9IG51bGw7XG4gICAgdGhpcy5fa2V5RG93bkhhbmRsZXIgPSB0aGlzLl9oYW5kbGVLZXlEb3duLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fa2V5VXBIYW5kbGVyID0gdGhpcy5faGFuZGxlS2V5VXAuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9rZXlQcmVzc0hhbmRsZXIgPSB0aGlzLl9oYW5kbGVLZXlQcmVzcy5iaW5kKHRoaXMpO1xuICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgdGhpcy5fa2V5bWFwID0ge307XG4gICAgdGhpcy5fbGFzdG1hcCA9IHt9O1xuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICB0aGlzLmF0dGFjaChlbGVtZW50KTtcbiAgICB9XG4gICAgdGhpcy5wcmV2ZW50RGVmYXVsdCA9IG9wdGlvbnMucHJldmVudERlZmF1bHQgfHwgZmFsc2U7XG4gICAgdGhpcy5zdG9wUHJvcGFnYXRpb24gPSBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbiB8fCBmYWxzZTtcbiAgfTtcbiAgS2V5Ym9hcmQucHJvdG90eXBlLmF0dGFjaCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICBpZiAodGhpcy5fZWxlbWVudCkge1xuICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG4gICAgdGhpcy5fZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLl9rZXlEb3duSGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXByZXNzXCIsIHRoaXMuX2tleVByZXNzSGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIHRoaXMuX2tleVVwSGFuZGxlciwgZmFsc2UpO1xuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUuZGV0YWNoID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLl9rZXlEb3duSGFuZGxlcik7XG4gICAgdGhpcy5fZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5cHJlc3NcIiwgdGhpcy5fa2V5UHJlc3NIYW5kbGVyKTtcbiAgICB0aGlzLl9lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXl1cFwiLCB0aGlzLl9rZXlVcEhhbmRsZXIpO1xuICAgIHRoaXMuX2VsZW1lbnQgPSBudWxsO1xuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUudG9LZXlJZGVudGlmaWVyID0gZnVuY3Rpb24oa2V5Q29kZSkge1xuICAgIGtleUNvZGUgPSB0b0tleUNvZGUoa2V5Q29kZSk7XG4gICAgdmFyIGNvdW50O1xuICAgIHZhciBoZXg7XG4gICAgdmFyIGxlbmd0aDtcbiAgICB2YXIgaWQgPSBfa2V5Q29kZVRvS2V5SWRlbnRpZmllcltrZXlDb2RlLnRvU3RyaW5nKCldO1xuICAgIGlmIChpZCkge1xuICAgICAgcmV0dXJuIGlkO1xuICAgIH1cbiAgICBoZXggPSBrZXlDb2RlLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpO1xuICAgIGxlbmd0aCA9IGhleC5sZW5ndGg7XG4gICAgZm9yIChjb3VudCA9IDA7Y291bnQgPCA0IC0gbGVuZ3RoO2NvdW50KyspIHtcbiAgICAgIGhleCA9IFwiMFwiICsgaGV4O1xuICAgIH1cbiAgICByZXR1cm4gXCJVK1wiICsgaGV4O1xuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUuX2hhbmRsZUtleURvd24gPSBmdW5jdGlvbihldmVudCkge1xuICAgIHZhciBjb2RlID0gZXZlbnQua2V5Q29kZSB8fCBldmVudC5jaGFyQ29kZTtcbiAgICB2YXIgaWQgPSB0aGlzLnRvS2V5SWRlbnRpZmllcihjb2RlKTtcbiAgICB0aGlzLl9rZXltYXBbaWRdID0gdHJ1ZTtcbiAgICB0aGlzLmZpcmUoXCJrZXlkb3duXCIsIG1ha2VLZXlib2FyZEV2ZW50KGV2ZW50KSk7XG4gICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0b3BQcm9wYWdhdGlvbikge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUuX2hhbmRsZUtleVVwID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgY29kZSA9IGV2ZW50LmtleUNvZGUgfHwgZXZlbnQuY2hhckNvZGU7XG4gICAgdmFyIGlkID0gdGhpcy50b0tleUlkZW50aWZpZXIoY29kZSk7XG4gICAgZGVsZXRlIHRoaXMuX2tleW1hcFtpZF07XG4gICAgdGhpcy5maXJlKFwia2V5dXBcIiwgbWFrZUtleWJvYXJkRXZlbnQoZXZlbnQpKTtcbiAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RvcFByb3BhZ2F0aW9uKSB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gIH07XG4gIEtleWJvYXJkLnByb3RvdHlwZS5faGFuZGxlS2V5UHJlc3MgPSBmdW5jdGlvbihldmVudCkge1xuICAgIHZhciBjb2RlID0gZXZlbnQua2V5Q29kZSB8fCBldmVudC5jaGFyQ29kZTtcbiAgICB2YXIgaWQgPSB0aGlzLnRvS2V5SWRlbnRpZmllcihjb2RlKTtcbiAgICB0aGlzLmZpcmUoXCJrZXlwcmVzc1wiLCBtYWtlS2V5Ym9hcmRFdmVudChldmVudCkpO1xuICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIH1cbiAgfTtcbiAgS2V5Ym9hcmQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKGR0KSB7XG4gICAgdmFyIHByb3A7XG4gICAgZm9yIChwcm9wIGluIHRoaXMuX2xhc3RtYXApIHtcbiAgICAgIGRlbGV0ZSB0aGlzLl9sYXN0bWFwW3Byb3BdO1xuICAgIH1cbiAgICBmb3IgKHByb3AgaW4gdGhpcy5fa2V5bWFwKSB7XG4gICAgICBpZiAodGhpcy5fa2V5bWFwLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgIHRoaXMuX2xhc3RtYXBbcHJvcF0gPSB0aGlzLl9rZXltYXBbcHJvcF07XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUuaXNQcmVzc2VkID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgdmFyIGtleUNvZGUgPSB0b0tleUNvZGUoa2V5KTtcbiAgICB2YXIgaWQgPSB0aGlzLnRvS2V5SWRlbnRpZmllcihrZXlDb2RlKTtcbiAgICByZXR1cm4gISF0aGlzLl9rZXltYXBbaWRdO1xuICB9O1xuICBLZXlib2FyZC5wcm90b3R5cGUud2FzUHJlc3NlZCA9IGZ1bmN0aW9uKGtleSkge1xuICAgIHZhciBrZXlDb2RlID0gdG9LZXlDb2RlKGtleSk7XG4gICAgdmFyIGlkID0gdGhpcy50b0tleUlkZW50aWZpZXIoa2V5Q29kZSk7XG4gICAgcmV0dXJuICEhdGhpcy5fa2V5bWFwW2lkXSAmJiAhISF0aGlzLl9sYXN0bWFwW2lkXTtcbiAgfTtcbiAgS2V5Ym9hcmQucHJvdG90eXBlLndhc1JlbGVhc2VkID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgdmFyIGtleUNvZGUgPSB0b0tleUNvZGUoa2V5KTtcbiAgICB2YXIgaWQgPSB0aGlzLnRvS2V5SWRlbnRpZmllcihrZXlDb2RlKTtcbiAgICByZXR1cm4gISEhdGhpcy5fa2V5bWFwW2lkXSAmJiAhIXRoaXMuX2xhc3RtYXBbaWRdO1xuICB9O1xuICByZXR1cm4ge0tleWJvYXJkOktleWJvYXJkfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgR2FtZVBhZHMgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmdhbWVwYWRzU3VwcG9ydGVkID0gISFuYXZpZ2F0b3IuZ2V0R2FtZXBhZHMgfHwgISFuYXZpZ2F0b3Iud2Via2l0R2V0R2FtZXBhZHM7XG4gICAgdGhpcy5jdXJyZW50ID0gW107XG4gICAgdGhpcy5wcmV2aW91cyA9IFtdO1xuICAgIHRoaXMuZGVhZFpvbmUgPSAwLjI1O1xuICB9O1xuICB2YXIgTUFQUyA9IHtERUZBVUxUOntidXR0b25zOltcIlBBRF9GQUNFXzFcIiwgXCJQQURfRkFDRV8yXCIsIFwiUEFEX0ZBQ0VfM1wiLCBcIlBBRF9GQUNFXzRcIiwgXCJQQURfTF9TSE9VTERFUl8xXCIsIFwiUEFEX1JfU0hPVUxERVJfMVwiLCBcIlBBRF9MX1NIT1VMREVSXzJcIiwgXCJQQURfUl9TSE9VTERFUl8yXCIsIFwiUEFEX1NFTEVDVFwiLCBcIlBBRF9TVEFSVFwiLCBcIlBBRF9MX1NUSUNLX0JVVFRPTlwiLCBcIlBBRF9SX1NUSUNLX0JVVFRPTlwiLCBcIlBBRF9VUFwiLCBcIlBBRF9ET1dOXCIsIFwiUEFEX0xFRlRcIiwgXCJQQURfUklHSFRcIiwgXCJQQURfVkVORE9SXCJdLCBheGVzOltcIlBBRF9MX1NUSUNLX1hcIiwgXCJQQURfTF9TVElDS19ZXCIsIFwiUEFEX1JfU1RJQ0tfWFwiLCBcIlBBRF9SX1NUSUNLX1lcIl19LCBQUzM6e2J1dHRvbnM6W1wiUEFEX0ZBQ0VfMVwiLCBcIlBBRF9GQUNFXzJcIiwgXCJQQURfRkFDRV80XCIsIFwiUEFEX0ZBQ0VfM1wiLCBcIlBBRF9MX1NIT1VMREVSXzFcIiwgXCJQQURfUl9TSE9VTERFUl8xXCIsIFwiUEFEX0xfU0hPVUxERVJfMlwiLFxuICBcIlBBRF9SX1NIT1VMREVSXzJcIiwgXCJQQURfU0VMRUNUXCIsIFwiUEFEX1NUQVJUXCIsIFwiUEFEX0xfU1RJQ0tfQlVUVE9OXCIsIFwiUEFEX1JfU1RJQ0tfQlVUVE9OXCIsIFwiUEFEX1VQXCIsIFwiUEFEX0RPV05cIiwgXCJQQURfTEVGVFwiLCBcIlBBRF9SSUdIVFwiLCBcIlBBRF9WRU5ET1JcIl0sIGF4ZXM6W1wiUEFEX0xfU1RJQ0tfWFwiLCBcIlBBRF9MX1NUSUNLX1lcIiwgXCJQQURfUl9TVElDS19YXCIsIFwiUEFEX1JfU1RJQ0tfWVwiXX19O1xuICB2YXIgUFJPRFVDVF9DT0RFUyA9IHtcIlByb2R1Y3Q6IDAyNjhcIjpcIlBTM1wifTtcbiAgR2FtZVBhZHMucHJvdG90eXBlID0ge3VwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHZhciBpLCBqLCBsO1xuICAgIHZhciBidXR0b25zLCBidXR0b25zTGVuO1xuICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmN1cnJlbnQubGVuZ3RoO2kgPCBsO2krKykge1xuICAgICAgYnV0dG9ucyA9IHRoaXMuY3VycmVudFtpXS5wYWQuYnV0dG9ucztcbiAgICAgIGJ1dHRvbnNMZW4gPSBidXR0b25zLmxlbmd0aDtcbiAgICAgIGZvciAoaiA9IDA7aiA8IGJ1dHRvbnNMZW47aisrKSB7XG4gICAgICAgIGlmICh0aGlzLnByZXZpb3VzW2ldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aGlzLnByZXZpb3VzW2ldID0gW107XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcmV2aW91c1tpXVtqXSA9IGJ1dHRvbnNbal0ucHJlc3NlZDtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIHBhZHMgPSB0aGlzLnBvbGwoKTtcbiAgICBmb3IgKGkgPSAwLCBsID0gcGFkcy5sZW5ndGg7aSA8IGw7aSsrKSB7XG4gICAgICB0aGlzLmN1cnJlbnRbaV0gPSBwYWRzW2ldO1xuICAgIH1cbiAgfSwgcG9sbDpmdW5jdGlvbigpIHtcbiAgICB2YXIgcGFkcyA9IFtdO1xuICAgIGlmICh0aGlzLmdhbWVwYWRzU3VwcG9ydGVkKSB7XG4gICAgICB2YXIgcGFkRGV2aWNlcyA9IG5hdmlnYXRvci5nZXRHYW1lcGFkcyA/IG5hdmlnYXRvci5nZXRHYW1lcGFkcygpIDogbmF2aWdhdG9yLndlYmtpdEdldEdhbWVwYWRzKCk7XG4gICAgICB2YXIgaSwgbGVuID0gcGFkRGV2aWNlcy5sZW5ndGg7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGlmIChwYWREZXZpY2VzW2ldKSB7XG4gICAgICAgICAgcGFkcy5wdXNoKHttYXA6dGhpcy5nZXRNYXAocGFkRGV2aWNlc1tpXSksIHBhZDpwYWREZXZpY2VzW2ldfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhZHM7XG4gIH0sIGdldE1hcDpmdW5jdGlvbihwYWQpIHtcbiAgICBmb3IgKHZhciBjb2RlIGluIFBST0RVQ1RfQ09ERVMpIHtcbiAgICAgIGlmIChwYWQuaWQuaW5kZXhPZihjb2RlKSA+PSAwKSB7XG4gICAgICAgIHJldHVybiBNQVBTW1BST0RVQ1RfQ09ERVNbY29kZV1dO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gTUFQUy5ERUZBVUxUO1xuICB9LCBpc1ByZXNzZWQ6ZnVuY3Rpb24oaW5kZXgsIGJ1dHRvbikge1xuICAgIGlmICghdGhpcy5jdXJyZW50W2luZGV4XSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIga2V5ID0gdGhpcy5jdXJyZW50W2luZGV4XS5tYXAuYnV0dG9uc1tidXR0b25dO1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRbaW5kZXhdLnBhZC5idXR0b25zW3BjW2tleV1dLnByZXNzZWQ7XG4gIH0sIHdhc1ByZXNzZWQ6ZnVuY3Rpb24oaW5kZXgsIGJ1dHRvbikge1xuICAgIGlmICghdGhpcy5jdXJyZW50W2luZGV4XSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIga2V5ID0gdGhpcy5jdXJyZW50W2luZGV4XS5tYXAuYnV0dG9uc1tidXR0b25dO1xuICAgIHZhciBpID0gcGNba2V5XTtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50W2luZGV4XS5wYWQuYnV0dG9uc1tpXS5wcmVzc2VkICYmICF0aGlzLnByZXZpb3VzW2luZGV4XVtpXTtcbiAgfSwgZ2V0QXhpczpmdW5jdGlvbihpbmRleCwgYXhlcykge1xuICAgIGlmICghdGhpcy5jdXJyZW50W2luZGV4XSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIga2V5ID0gdGhpcy5jdXJyZW50W2luZGV4XS5tYXAuYXhlc1theGVzXTtcbiAgICB2YXIgdmFsdWUgPSB0aGlzLmN1cnJlbnRbaW5kZXhdLnBhZC5heGVzW3BjW2tleV1dO1xuICAgIGlmIChNYXRoLmFicyh2YWx1ZSkgPCB0aGlzLmRlYWRab25lKSB7XG4gICAgICB2YWx1ZSA9IDA7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfX07XG4gIHJldHVybiB7R2FtZVBhZHM6R2FtZVBhZHN9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBUb3VjaEV2ZW50ID0gZnVuY3Rpb24oZGV2aWNlLCBldmVudCkge1xuICAgIHRoaXMuZWxlbWVudCA9IGV2ZW50LnRhcmdldDtcbiAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7XG4gICAgdGhpcy50b3VjaGVzID0gW107XG4gICAgdGhpcy5jaGFuZ2VkVG91Y2hlcyA9IFtdO1xuICAgIGlmIChldmVudCkge1xuICAgICAgdmFyIGksIGwgPSBldmVudC50b3VjaGVzLmxlbmd0aDtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGw7aSsrKSB7XG4gICAgICAgIHRoaXMudG91Y2hlcy5wdXNoKG5ldyBUb3VjaChldmVudC50b3VjaGVzW2ldKSk7XG4gICAgICB9XG4gICAgICBsID0gZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoO1xuICAgICAgZm9yIChpID0gMDtpIDwgbDtpKyspIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VkVG91Y2hlcy5wdXNoKG5ldyBUb3VjaChldmVudC5jaGFuZ2VkVG91Y2hlc1tpXSkpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgVG91Y2hFdmVudC5wcm90b3R5cGUgPSB7Z2V0VG91Y2hCeUlkOmZ1bmN0aW9uKGlkLCBsaXN0KSB7XG4gICAgdmFyIGksIGwgPSBsaXN0Lmxlbmd0aDtcbiAgICBmb3IgKGkgPSAwO2kgPCBsO2krKykge1xuICAgICAgaWYgKGxpc3RbaV0uaWQgPT09IGlkKSB7XG4gICAgICAgIHJldHVybiBsaXN0W2ldO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfX07XG4gIHZhciBUb3VjaCA9IGZ1bmN0aW9uKHRvdWNoKSB7XG4gICAgdmFyIGNvb3JkcyA9IHBjLmdldFRvdWNoVGFyZ2V0Q29vcmRzKHRvdWNoKTtcbiAgICB0aGlzLmlkID0gdG91Y2guaWRlbnRpZmllcjtcbiAgICB0aGlzLnggPSBjb29yZHMueDtcbiAgICB0aGlzLnkgPSBjb29yZHMueTtcbiAgICB0aGlzLnRhcmdldCA9IHRvdWNoLnRhcmdldDtcbiAgICB0aGlzLnRvdWNoID0gdG91Y2g7XG4gIH07XG4gIHZhciBUb3VjaERldmljZSA9IGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICB0aGlzLl9zdGFydEhhbmRsZXIgPSB0aGlzLl9oYW5kbGVUb3VjaFN0YXJ0LmJpbmQodGhpcyk7XG4gICAgdGhpcy5fZW5kSGFuZGxlciA9IHRoaXMuX2hhbmRsZVRvdWNoRW5kLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fbW92ZUhhbmRsZXIgPSB0aGlzLl9oYW5kbGVUb3VjaE1vdmUuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9jYW5jZWxIYW5kbGVyID0gdGhpcy5faGFuZGxlVG91Y2hDYW5jZWwuYmluZCh0aGlzKTtcbiAgICB0aGlzLmF0dGFjaChlbGVtZW50KTtcbiAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICB9O1xuICBUb3VjaERldmljZS5wcm90b3R5cGUgPSB7YXR0YWNoOmZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICBpZiAodGhpcy5fZWxlbWVudCkge1xuICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG4gICAgdGhpcy5fZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCB0aGlzLl9zdGFydEhhbmRsZXIsIGZhbHNlKTtcbiAgICB0aGlzLl9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCB0aGlzLl9lbmRIYW5kbGVyLCBmYWxzZSk7XG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIHRoaXMuX21vdmVIYW5kbGVyLCBmYWxzZSk7XG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hjYW5jZWxcIiwgdGhpcy5fY2FuY2VsSGFuZGxlciwgZmFsc2UpO1xuICB9LCBkZXRhY2g6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2VsZW1lbnQpIHtcbiAgICAgIHRoaXMuX2VsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgdGhpcy5fc3RhcnRIYW5kbGVyLCBmYWxzZSk7XG4gICAgICB0aGlzLl9lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCB0aGlzLl9lbmRIYW5kbGVyLCBmYWxzZSk7XG4gICAgICB0aGlzLl9lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgdGhpcy5fbW92ZUhhbmRsZXIsIGZhbHNlKTtcbiAgICAgIHRoaXMuX2VsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRvdWNoY2FuY2VsXCIsIHRoaXMuX2NhbmNlbEhhbmRsZXIsIGZhbHNlKTtcbiAgICB9XG4gICAgdGhpcy5fZWxlbWVudCA9IG51bGw7XG4gIH0sIF9oYW5kbGVUb3VjaFN0YXJ0OmZ1bmN0aW9uKGUpIHtcbiAgICB0aGlzLmZpcmUoXCJ0b3VjaHN0YXJ0XCIsIG5ldyBUb3VjaEV2ZW50KHRoaXMsIGUpKTtcbiAgfSwgX2hhbmRsZVRvdWNoRW5kOmZ1bmN0aW9uKGUpIHtcbiAgICB0aGlzLmZpcmUoXCJ0b3VjaGVuZFwiLCBuZXcgVG91Y2hFdmVudCh0aGlzLCBlKSk7XG4gIH0sIF9oYW5kbGVUb3VjaE1vdmU6ZnVuY3Rpb24oZSkge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB0aGlzLmZpcmUoXCJ0b3VjaG1vdmVcIiwgbmV3IFRvdWNoRXZlbnQodGhpcywgZSkpO1xuICB9LCBfaGFuZGxlVG91Y2hDYW5jZWw6ZnVuY3Rpb24oZSkge1xuICAgIHRoaXMuZmlyZShcInRvdWNoY2FuY2VsXCIsIG5ldyBUb3VjaEV2ZW50KHRoaXMsIGUpKTtcbiAgfX07XG4gIHJldHVybiB7Z2V0VG91Y2hUYXJnZXRDb29yZHM6ZnVuY3Rpb24odG91Y2gpIHtcbiAgICB2YXIgdG90YWxPZmZzZXRYID0gMDtcbiAgICB2YXIgdG90YWxPZmZzZXRZID0gMDtcbiAgICB2YXIgY2FudmFzWCA9IDA7XG4gICAgdmFyIGNhbnZhc1kgPSAwO1xuICAgIHZhciB0YXJnZXQgPSB0b3VjaC50YXJnZXQ7XG4gICAgd2hpbGUgKCEodGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTtcbiAgICB9XG4gICAgdmFyIGN1cnJlbnRFbGVtZW50ID0gdGFyZ2V0O1xuICAgIGRvIHtcbiAgICAgIHRvdGFsT2Zmc2V0WCArPSBjdXJyZW50RWxlbWVudC5vZmZzZXRMZWZ0IC0gY3VycmVudEVsZW1lbnQuc2Nyb2xsTGVmdDtcbiAgICAgIHRvdGFsT2Zmc2V0WSArPSBjdXJyZW50RWxlbWVudC5vZmZzZXRUb3AgLSBjdXJyZW50RWxlbWVudC5zY3JvbGxUb3A7XG4gICAgICBjdXJyZW50RWxlbWVudCA9IGN1cnJlbnRFbGVtZW50Lm9mZnNldFBhcmVudDtcbiAgICB9IHdoaWxlIChjdXJyZW50RWxlbWVudCk7XG4gICAgcmV0dXJuIHt4OnRvdWNoLnBhZ2VYIC0gdG90YWxPZmZzZXRYLCB5OnRvdWNoLnBhZ2VZIC0gdG90YWxPZmZzZXRZfTtcbiAgfSwgVG91Y2hEZXZpY2U6VG91Y2hEZXZpY2V9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDb250cm9sbGVyID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIHRoaXMuX2tleWJvYXJkID0gb3B0aW9ucy5rZXlib2FyZCB8fCBudWxsO1xuICAgIHRoaXMuX21vdXNlID0gb3B0aW9ucy5tb3VzZSB8fCBudWxsO1xuICAgIHRoaXMuX2dhbWVwYWRzID0gb3B0aW9ucy5nYW1lcGFkcyB8fCBudWxsO1xuICAgIHRoaXMuX2VsZW1lbnQgPSBudWxsO1xuICAgIHRoaXMuX2FjdGlvbnMgPSB7fTtcbiAgICB0aGlzLl9heGVzID0ge307XG4gICAgdGhpcy5fYXhlc1ZhbHVlcyA9IHt9O1xuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICB0aGlzLmF0dGFjaChlbGVtZW50KTtcbiAgICB9XG4gIH07XG4gIENvbnRyb2xsZXIucHJvdG90eXBlLmF0dGFjaCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDtcbiAgICBpZiAodGhpcy5fa2V5Ym9hcmQpIHtcbiAgICAgIHRoaXMuX2tleWJvYXJkLmF0dGFjaChlbGVtZW50KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX21vdXNlKSB7XG4gICAgICB0aGlzLl9tb3VzZS5hdHRhY2goZWxlbWVudCk7XG4gICAgfVxuICB9O1xuICBDb250cm9sbGVyLnByb3RvdHlwZS5kZXRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fa2V5Ym9hcmQpIHtcbiAgICAgIHRoaXMuX2tleWJvYXJkLmRldGFjaCgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbW91c2UpIHtcbiAgICAgIHRoaXMuX21vdXNlLmRldGFjaCgpO1xuICAgIH1cbiAgICB0aGlzLl9lbGVtZW50ID0gbnVsbDtcbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUuZGlzYWJsZUNvbnRleHRNZW51ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLl9tb3VzZSkge1xuICAgICAgdGhpcy5fZW5hYmxlTW91c2UoKTtcbiAgICB9XG4gICAgdGhpcy5fbW91c2UuZGlzYWJsZUNvbnRleHRNZW51KCk7XG4gIH07XG4gIENvbnRyb2xsZXIucHJvdG90eXBlLmVuYWJsZUNvbnRleHRNZW51ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLl9tb3VzZSkge1xuICAgICAgdGhpcy5fZW5hYmxlTW91c2UoKTtcbiAgICB9XG4gICAgdGhpcy5fbW91c2UuZW5hYmxlQ29udGV4dE1lbnUoKTtcbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oZHQpIHtcbiAgICBpZiAodGhpcy5fa2V5Ym9hcmQpIHtcbiAgICAgIHRoaXMuX2tleWJvYXJkLnVwZGF0ZShkdCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9tb3VzZSkge1xuICAgICAgdGhpcy5fbW91c2UudXBkYXRlKGR0KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2dhbWVwYWRzKSB7XG4gICAgICB0aGlzLl9nYW1lcGFkcy51cGRhdGUoZHQpO1xuICAgIH1cbiAgICB0aGlzLl9heGVzVmFsdWVzID0ge307XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMuX2F4ZXMpIHtcbiAgICAgIHRoaXMuX2F4ZXNWYWx1ZXNba2V5XSA9IFtdO1xuICAgIH1cbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUucmVnaXN0ZXJLZXlzID0gZnVuY3Rpb24oYWN0aW9uLCBrZXlzKSB7XG4gICAgaWYgKCF0aGlzLl9rZXlib2FyZCkge1xuICAgICAgdGhpcy5fZW5hYmxlS2V5Ym9hcmQoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2FjdGlvbnNbYWN0aW9uXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKHBjLnN0cmluZy5mb3JtYXQoXCJBY3Rpb246IHswfSBhbHJlYWR5IHJlZ2lzdGVyZWRcIiwgYWN0aW9uKSk7XG4gICAgfVxuICAgIGlmIChrZXlzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgYnV0dG9uXCIpO1xuICAgIH1cbiAgICBpZiAoIWtleXMubGVuZ3RoKSB7XG4gICAgICBrZXlzID0gW2tleXNdO1xuICAgIH1cbiAgICBpZiAodGhpcy5fYWN0aW9uc1thY3Rpb25dKSB7XG4gICAgICB0aGlzLl9hY3Rpb25zW2FjdGlvbl0ucHVzaCh7dHlwZTpwYy5BQ1RJT05fS0VZQk9BUkQsIGtleXM6a2V5c30pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hY3Rpb25zW2FjdGlvbl0gPSBbe3R5cGU6cGMuQUNUSU9OX0tFWUJPQVJELCBrZXlzOmtleXN9XTtcbiAgICB9XG4gIH07XG4gIENvbnRyb2xsZXIucHJvdG90eXBlLnJlZ2lzdGVyTW91c2UgPSBmdW5jdGlvbihhY3Rpb24sIGJ1dHRvbikge1xuICAgIGlmICghdGhpcy5fbW91c2UpIHtcbiAgICAgIHRoaXMuX2VuYWJsZU1vdXNlKCk7XG4gICAgfVxuICAgIGlmIChidXR0b24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBidXR0b25cIik7XG4gICAgfVxuICAgIGlmICh0aGlzLl9hY3Rpb25zW2FjdGlvbl0pIHtcbiAgICAgIHRoaXMuX2FjdGlvbnNbYWN0aW9uXS5wdXNoKHt0eXBlOnBjLkFDVElPTl9NT1VTRSwgYnV0dG9uOmJ1dHRvbn0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hY3Rpb25zW2FjdGlvbl0gPSBbe3R5cGU6cGMuQUNUSU9OX01PVVNFLCBidXR0b246LWJ1dHRvbn1dO1xuICAgIH1cbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUucmVnaXN0ZXJQYWRCdXR0b24gPSBmdW5jdGlvbihhY3Rpb24sIHBhZCwgYnV0dG9uKSB7XG4gICAgaWYgKGJ1dHRvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGJ1dHRvblwiKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2FjdGlvbnNbYWN0aW9uXSkge1xuICAgICAgdGhpcy5fYWN0aW9uc1thY3Rpb25dLnB1c2goe3R5cGU6cGMuQUNUSU9OX0dBTUVQQUQsIGJ1dHRvbjpidXR0b24sIHBhZDpwYWR9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fYWN0aW9uc1thY3Rpb25dID0gW3t0eXBlOnBjLkFDVElPTl9HQU1FUEFELCBidXR0b246YnV0dG9uLCBwYWQ6cGFkfV07XG4gICAgfVxuICB9O1xuICBDb250cm9sbGVyLnByb3RvdHlwZS5yZWdpc3RlckF4aXMgPSBmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgdmFyIG5hbWUgPSBvcHRpb25zLm5hbWU7XG4gICAgaWYgKCF0aGlzLl9heGVzW25hbWVdKSB7XG4gICAgICB0aGlzLl9heGVzW25hbWVdID0gW107XG4gICAgfVxuICAgIHZhciBpID0gdGhpcy5fYXhlc1tuYW1lXS5wdXNoKG5hbWUpO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIG9wdGlvbnMucGFkID0gb3B0aW9ucy5wYWQgfHwgcGMuUEFEXzE7XG4gICAgdmFyIGJpbmQgPSBmdW5jdGlvbihjb250cm9sbGVyLCBzb3VyY2UsIHZhbHVlLCBrZXkpIHtcbiAgICAgIHN3aXRjaChzb3VyY2UpIHtcbiAgICAgICAgY2FzZSBcIm1vdXNleFwiOlxuICAgICAgICAgIGNvbnRyb2xsZXIuX21vdXNlLm9uKHBjLkVWRU5UX01PVVNFTU9WRSwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgY29udHJvbGxlci5fYXhlc1ZhbHVlc1tuYW1lXVtpXSA9IGUuZHggLyAxMDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcIm1vdXNleVwiOlxuICAgICAgICAgIGNvbnRyb2xsZXIuX21vdXNlLm9uKHBjLkVWRU5UX01PVVNFTU9WRSwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgY29udHJvbGxlci5fYXhlc1ZhbHVlc1tuYW1lXVtpXSA9IGUuZHkgLyAxMDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImtleVwiOlxuICAgICAgICAgIGNvbnRyb2xsZXIuX2F4ZXNbbmFtZV0ucHVzaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLl9rZXlib2FyZC5pc1ByZXNzZWQoa2V5KSA/IHZhbHVlIDogMDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcInBhZHJ4XCI6XG4gICAgICAgICAgY29udHJvbGxlci5fYXhlc1tuYW1lXS5wdXNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXIuX2dhbWVwYWRzLmdldEF4aXMob3B0aW9ucy5wYWQsIHBjLlBBRF9SX1NUSUNLX1gpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwicGFkcnlcIjpcbiAgICAgICAgICBjb250cm9sbGVyLl9heGVzW25hbWVdLnB1c2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICByZXR1cm4gY29udHJvbGxlci5fZ2FtZXBhZHMuZ2V0QXhpcyhvcHRpb25zLnBhZCwgcGMuUEFEX1JfU1RJQ0tfWSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJwYWRseFwiOlxuICAgICAgICAgIGNvbnRyb2xsZXIuX2F4ZXNbbmFtZV0ucHVzaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBjb250cm9sbGVyLl9nYW1lcGFkcy5nZXRBeGlzKG9wdGlvbnMucGFkLCBwYy5QQURfTF9TVElDS19YKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcInBhZGx5XCI6XG4gICAgICAgICAgY29udHJvbGxlci5fYXhlc1tuYW1lXS5wdXNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXIuX2dhbWVwYWRzLmdldEF4aXMob3B0aW9ucy5wYWQsIHBjLlBBRF9MX1NUSUNLX1kpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVua25vd24gYXhpc1wiKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGJpbmQodGhpcywgb3B0aW9ucy5wb3NpdGl2ZSwgMSwgb3B0aW9ucy5wb3NpdGl2ZUtleSk7XG4gICAgaWYgKG9wdGlvbnMubmVnYXRpdmVLZXkgfHwgb3B0aW9ucy5uZWdhdGl2ZSAhPT0gb3B0aW9ucy5wb3NpdGl2ZSkge1xuICAgICAgYmluZCh0aGlzLCBvcHRpb25zLm5lZ2F0aXZlLCAtMSwgb3B0aW9ucy5uZWdhdGl2ZUtleSk7XG4gICAgfVxuICB9O1xuICBDb250cm9sbGVyLnByb3RvdHlwZS5pc1ByZXNzZWQgPSBmdW5jdGlvbihhY3Rpb25OYW1lKSB7XG4gICAgaWYgKCF0aGlzLl9hY3Rpb25zW2FjdGlvbk5hbWVdKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBhY3Rpb247XG4gICAgdmFyIGluZGV4ID0gMDtcbiAgICB2YXIgbGVuZ3RoID0gdGhpcy5fYWN0aW9uc1thY3Rpb25OYW1lXS5sZW5ndGg7XG4gICAgZm9yIChpbmRleCA9IDA7aW5kZXggPCBsZW5ndGg7KytpbmRleCkge1xuICAgICAgYWN0aW9uID0gdGhpcy5fYWN0aW9uc1thY3Rpb25OYW1lXVtpbmRleF07XG4gICAgICBzd2l0Y2goYWN0aW9uLnR5cGUpIHtcbiAgICAgICAgY2FzZSBwYy5BQ1RJT05fS0VZQk9BUkQ6XG4gICAgICAgICAgaWYgKHRoaXMuX2tleWJvYXJkKSB7XG4gICAgICAgICAgICB2YXIgaSwgbGVuID0gYWN0aW9uLmtleXMubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICAgICAgICBpZiAodGhpcy5fa2V5Ym9hcmQuaXNQcmVzc2VkKGFjdGlvbi5rZXlzW2ldKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLkFDVElPTl9NT1VTRTpcbiAgICAgICAgICBpZiAodGhpcy5fbW91c2UgJiYgdGhpcy5fbW91c2UuaXNQcmVzc2VkKGFjdGlvbi5idXR0b24pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgcGMuQUNUSU9OX0dBTUVQQUQ6XG4gICAgICAgICAgaWYgKHRoaXMuX2dhbWVwYWRzICYmIHRoaXMuX2dhbWVwYWRzLmlzUHJlc3NlZChhY3Rpb24ucGFkLCBhY3Rpb24uYnV0dG9uKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG4gIENvbnRyb2xsZXIucHJvdG90eXBlLndhc1ByZXNzZWQgPSBmdW5jdGlvbihhY3Rpb25OYW1lKSB7XG4gICAgaWYgKCF0aGlzLl9hY3Rpb25zW2FjdGlvbk5hbWVdKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBpbmRleCA9IDA7XG4gICAgdmFyIGxlbmd0aCA9IHRoaXMuX2FjdGlvbnNbYWN0aW9uTmFtZV0ubGVuZ3RoO1xuICAgIGZvciAoaW5kZXggPSAwO2luZGV4IDwgbGVuZ3RoOysraW5kZXgpIHtcbiAgICAgIHZhciBhY3Rpb24gPSB0aGlzLl9hY3Rpb25zW2FjdGlvbk5hbWVdW2luZGV4XTtcbiAgICAgIHN3aXRjaChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlIHBjLkFDVElPTl9LRVlCT0FSRDpcbiAgICAgICAgICBpZiAodGhpcy5fa2V5Ym9hcmQpIHtcbiAgICAgICAgICAgIHZhciBpLCBsZW4gPSBhY3Rpb24ua2V5cy5sZW5ndGg7XG4gICAgICAgICAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgICAgIGlmICh0aGlzLl9rZXlib2FyZC53YXNQcmVzc2VkKGFjdGlvbi5rZXlzW2ldKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLkFDVElPTl9NT1VTRTpcbiAgICAgICAgICBpZiAodGhpcy5fbW91c2UgJiYgdGhpcy5fbW91c2Uud2FzUHJlc3NlZChhY3Rpb24uYnV0dG9uKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHBjLkFDVElPTl9HQU1FUEFEOlxuICAgICAgICAgIGlmICh0aGlzLl9nYW1lcGFkcyAmJiB0aGlzLl9nYW1lcGFkcy53YXNQcmVzc2VkKGFjdGlvbi5wYWQsIGFjdGlvbi5idXR0b24pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUuZ2V0QXhpcyA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgdmFsdWUgPSAwO1xuICAgIGlmICh0aGlzLl9heGVzW25hbWVdKSB7XG4gICAgICB2YXIgaSwgbGVuID0gdGhpcy5fYXhlc1tuYW1lXS5sZW5ndGg7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGlmIChwYy50eXBlKHRoaXMuX2F4ZXNbbmFtZV1baV0pID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICB2YXIgdiA9IHRoaXMuX2F4ZXNbbmFtZV1baV0oKTtcbiAgICAgICAgICBpZiAoTWF0aC5hYnModikgPiBNYXRoLmFicyh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdjtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHRoaXMuX2F4ZXNWYWx1ZXNbbmFtZV0pIHtcbiAgICAgICAgICAgIGlmIChNYXRoLmFicyh0aGlzLl9heGVzVmFsdWVzW25hbWVdW2ldKSA+IE1hdGguYWJzKHZhbHVlKSkge1xuICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuX2F4ZXNWYWx1ZXNbbmFtZV1baV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfTtcbiAgQ29udHJvbGxlci5wcm90b3R5cGUuX2VuYWJsZU1vdXNlID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fbW91c2UgPSBuZXcgcGMuTW91c2U7XG4gICAgaWYgKCF0aGlzLl9lbGVtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb250cm9sbGVyIG11c3QgYmUgYXR0YWNoZWQgdG8gYW4gRWxlbWVudFwiKTtcbiAgICB9XG4gICAgdGhpcy5fbW91c2UuYXR0YWNoKHRoaXMuX2VsZW1lbnQpO1xuICB9O1xuICBDb250cm9sbGVyLnByb3RvdHlwZS5fZW5hYmxlS2V5Ym9hcmQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9rZXlib2FyZCA9IG5ldyBwYy5LZXlib2FyZDtcbiAgICBpZiAoIXRoaXMuX2VsZW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvbnRyb2xsZXIgbXVzdCBiZSBhdHRhY2hlZCB0byBhbiBFbGVtZW50XCIpO1xuICAgIH1cbiAgICB0aGlzLl9rZXlib2FyZC5hdHRhY2godGhpcy5fZWxlbWVudCk7XG4gIH07XG4gIHJldHVybiB7Q29udHJvbGxlcjpDb250cm9sbGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgdGFyZ2V0WCwgdGFyZ2V0WTtcbiAgdmFyIHZlY0EgPSBuZXcgcGMuVmVjMztcbiAgdmFyIHZlY0IgPSBuZXcgcGMuVmVjMztcbiAgdmFyIF9wcSA9IG5ldyBwYy5WZWMzO1xuICB2YXIgX3BhID0gbmV3IHBjLlZlYzM7XG4gIHZhciBfcGIgPSBuZXcgcGMuVmVjMztcbiAgdmFyIF9wYyA9IG5ldyBwYy5WZWMzO1xuICB2YXIgX3BkID0gbmV3IHBjLlZlYzM7XG4gIHZhciBfbSA9IG5ldyBwYy5WZWMzO1xuICB2YXIgX3NjdCA9IG5ldyBwYy5WZWMzO1xuICB2YXIgaW50ZXJzZWN0TGluZVF1YWQgPSBmdW5jdGlvbihwLCBxLCBjb3JuZXJzKSB7XG4gICAgX3BxLnN1YjIocSwgcCk7XG4gICAgX3BhLnN1YjIoY29ybmVyc1swXSwgcCk7XG4gICAgX3BiLnN1YjIoY29ybmVyc1sxXSwgcCk7XG4gICAgX3BjLnN1YjIoY29ybmVyc1syXSwgcCk7XG4gICAgX20uY3Jvc3MoX3BjLCBfcHEpO1xuICAgIHZhciB2ID0gX3BhLmRvdChfbSk7XG4gICAgaWYgKHYgPj0gMCkge1xuICAgICAgaWYgKC1fcGIuZG90KF9tKSA8IDApIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHNjYWxhclRyaXBsZShfcHEsIF9wYiwgX3BhKSA8IDApIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBfcGQuc3ViMihjb3JuZXJzWzNdLCBwKTtcbiAgICAgIGlmIChfcGQuZG90KF9tKSA8IDApIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHNjYWxhclRyaXBsZShfcHEsIF9wYSwgX3BkKSA8IDApIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfTtcbiAgdmFyIHNjYWxhclRyaXBsZSA9IGZ1bmN0aW9uKHAxLCBwMiwgcDMpIHtcbiAgICByZXR1cm4gX3NjdC5jcm9zcyhwMSwgcDIpLmRvdChwMyk7XG4gIH07XG4gIHZhciBFbGVtZW50SW5wdXRFdmVudCA9IGZ1bmN0aW9uKGV2ZW50LCBlbGVtZW50KSB7XG4gICAgdGhpcy5ldmVudCA9IGV2ZW50O1xuICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy5fc3RvcFByb3BhZ2F0aW9uID0gZmFsc2U7XG4gIH07XG4gIEVsZW1lbnRJbnB1dEV2ZW50LnByb3RvdHlwZSA9IHtzdG9wUHJvcGFnYXRpb246ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fc3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTtcbiAgICB0aGlzLmV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gIH19O1xuICB2YXIgRWxlbWVudE1vdXNlRXZlbnQgPSBmdW5jdGlvbihldmVudCwgZWxlbWVudCwgeCwgeSwgbGFzdFgsIGxhc3RZKSB7XG4gICAgdGhpcy54ID0geDtcbiAgICB0aGlzLnkgPSB5O1xuICAgIHRoaXMuY3RybEtleSA9IGV2ZW50LmN0cmxLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5hbHRLZXkgPSBldmVudC5hbHRLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5zaGlmdEtleSA9IGV2ZW50LnNoaWZ0S2V5IHx8IGZhbHNlO1xuICAgIHRoaXMubWV0YUtleSA9IGV2ZW50Lm1ldGFLZXkgfHwgZmFsc2U7XG4gICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247XG4gICAgaWYgKHBjLk1vdXNlLmlzUG9pbnRlckxvY2tlZCgpKSB7XG4gICAgICB0aGlzLmR4ID0gZXZlbnQubW92ZW1lbnRYIHx8IGV2ZW50LndlYmtpdE1vdmVtZW50WCB8fCBldmVudC5tb3pNb3ZlbWVudFggfHwgMDtcbiAgICAgIHRoaXMuZHkgPSBldmVudC5tb3ZlbWVudFkgfHwgZXZlbnQud2Via2l0TW92ZW1lbnRZIHx8IGV2ZW50Lm1vek1vdmVtZW50WSB8fCAwO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmR4ID0geCAtIGxhc3RYO1xuICAgICAgdGhpcy5keSA9IHkgLSBsYXN0WTtcbiAgICB9XG4gICAgaWYgKGV2ZW50LmRldGFpbCkge1xuICAgICAgdGhpcy53aGVlbCA9IC0xICogZXZlbnQuZGV0YWlsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZXZlbnQud2hlZWxEZWx0YSkge1xuICAgICAgICB0aGlzLndoZWVsID0gZXZlbnQud2hlZWxEZWx0YSAvIDEyMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMud2hlZWwgPSAwO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgRWxlbWVudE1vdXNlRXZlbnQgPSBwYy5pbmhlcml0cyhFbGVtZW50TW91c2VFdmVudCwgRWxlbWVudElucHV0RXZlbnQpO1xuICB2YXIgRWxlbWVudFRvdWNoRXZlbnQgPSBmdW5jdGlvbihldmVudCwgZWxlbWVudCwgaW5wdXQpIHtcbiAgICB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzO1xuICAgIHRoaXMuY2hhbmdlZFRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlcztcbiAgfTtcbiAgRWxlbWVudFRvdWNoRXZlbnQgPSBwYy5pbmhlcml0cyhFbGVtZW50VG91Y2hFdmVudCwgRWxlbWVudElucHV0RXZlbnQpO1xuICB2YXIgRWxlbWVudElucHV0ID0gZnVuY3Rpb24oZG9tRWxlbWVudCkge1xuICAgIHRoaXMuX2FwcCA9IG51bGw7XG4gICAgdGhpcy5fYXR0YWNoZWQgPSBmYWxzZTtcbiAgICB0aGlzLl90YXJnZXQgPSBudWxsO1xuICAgIHRoaXMuX2xhc3RYID0gMDtcbiAgICB0aGlzLl9sYXN0WSA9IDA7XG4gICAgdGhpcy5fdXBIYW5kbGVyID0gdGhpcy5faGFuZGxlVXAuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9kb3duSGFuZGxlciA9IHRoaXMuX2hhbmRsZURvd24uYmluZCh0aGlzKTtcbiAgICB0aGlzLl9tb3ZlSGFuZGxlciA9IHRoaXMuX2hhbmRsZU1vdmUuYmluZCh0aGlzKTtcbiAgICB0aGlzLl93aGVlbEhhbmRsZXIgPSB0aGlzLl9oYW5kbGVXaGVlbC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX3RvdWNoc3RhcnRIYW5kbGVyID0gdGhpcy5faGFuZGxlVG91Y2hTdGFydC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX3RvdWNoZW5kSGFuZGxlciA9IHRoaXMuX2hhbmRsZVRvdWNoRW5kLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fdG91Y2hjYW5jZWxIYW5kbGVyID0gdGhpcy5fdG91Y2hlbmRIYW5kbGVyO1xuICAgIHRoaXMuX3RvdWNobW92ZUhhbmRsZXIgPSB0aGlzLl9oYW5kbGVUb3VjaE1vdmUuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9lbGVtZW50cyA9IFtdO1xuICAgIHRoaXMuX2hvdmVyZWRFbGVtZW50ID0gbnVsbDtcbiAgICB0aGlzLl9wcmVzc2VkRWxlbWVudCA9IG51bGw7XG4gICAgdGhpcy5fdG91Y2hlZEVsZW1lbnRzID0ge307XG4gICAgaWYgKFwib250b3VjaHN0YXJ0XCIgaW4gd2luZG93KSB7XG4gICAgICB0aGlzLl9jbGlja2VkRW50aXRpZXMgPSB7fTtcbiAgICB9XG4gICAgdGhpcy5hdHRhY2goZG9tRWxlbWVudCk7XG4gIH07XG4gIEVsZW1lbnRJbnB1dC5wcm90b3R5cGUgPSB7YXR0YWNoOmZ1bmN0aW9uKGRvbUVsZW1lbnQpIHtcbiAgICBpZiAodGhpcy5fYXR0YWNoZWQpIHtcbiAgICAgIHRoaXMuX2F0dGFjaGVkID0gZmFsc2U7XG4gICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH1cbiAgICB0aGlzLl90YXJnZXQgPSBkb21FbGVtZW50O1xuICAgIHRoaXMuX2F0dGFjaGVkID0gdHJ1ZTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5fdXBIYW5kbGVyLCB7cGFzc2l2ZTp0cnVlfSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgdGhpcy5fZG93bkhhbmRsZXIsIHtwYXNzaXZlOnRydWV9KTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCB0aGlzLl9tb3ZlSGFuZGxlciwge3Bhc3NpdmU6dHJ1ZX0pO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibW91c2V3aGVlbFwiLCB0aGlzLl93aGVlbEhhbmRsZXIsIHtwYXNzaXZlOnRydWV9KTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTU1vdXNlU2Nyb2xsXCIsIHRoaXMuX3doZWVsSGFuZGxlciwge3Bhc3NpdmU6dHJ1ZX0pO1xuICAgIGlmIChcIm9udG91Y2hzdGFydFwiIGluIHdpbmRvdykge1xuICAgICAgdGhpcy5fdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaHN0YXJ0XCIsIHRoaXMuX3RvdWNoc3RhcnRIYW5kbGVyLCB7cGFzc2l2ZTp0cnVlfSk7XG4gICAgICB0aGlzLl90YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIHRoaXMuX3RvdWNoZW5kSGFuZGxlciwge3Bhc3NpdmU6dHJ1ZX0pO1xuICAgICAgdGhpcy5fdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgdGhpcy5fdG91Y2htb3ZlSGFuZGxlciwgZmFsc2UpO1xuICAgICAgdGhpcy5fdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGNhbmNlbFwiLCB0aGlzLl90b3VjaGNhbmNlbEhhbmRsZXIsIHtwYXNzaXZlOnRydWV9KTtcbiAgICB9XG4gIH0sIGRldGFjaDpmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuX2F0dGFjaGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2F0dGFjaGVkID0gZmFsc2U7XG4gICAgdGhpcy5fdGFyZ2V0ID0gbnVsbDtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5fdXBIYW5kbGVyLCBmYWxzZSk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgdGhpcy5fZG93bkhhbmRsZXIsIGZhbHNlKTtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCB0aGlzLl9tb3ZlSGFuZGxlciwgZmFsc2UpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2V3aGVlbFwiLCB0aGlzLl93aGVlbEhhbmRsZXIsIGZhbHNlKTtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIkRPTU1vdXNlU2Nyb2xsXCIsIHRoaXMuX3doZWVsSGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX3RhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCB0aGlzLl90b3VjaHN0YXJ0SGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX3RhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgdGhpcy5fdG91Y2hlbmRIYW5kbGVyLCBmYWxzZSk7XG4gICAgdGhpcy5fdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgdGhpcy5fdG91Y2htb3ZlSGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX3RhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKFwidG91Y2hjYW5jZWxcIiwgdGhpcy5fdG91Y2hjYW5jZWxIYW5kbGVyLCBmYWxzZSk7XG4gIH0sIGFkZEVsZW1lbnQ6ZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIGlmICh0aGlzLl9lbGVtZW50cy5pbmRleE9mKGVsZW1lbnQpID09PSAtMSkge1xuICAgICAgdGhpcy5fZWxlbWVudHMucHVzaChlbGVtZW50KTtcbiAgICB9XG4gIH0sIHJlbW92ZUVsZW1lbnQ6ZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIHZhciBpZHggPSB0aGlzLl9lbGVtZW50cy5pbmRleE9mKGVsZW1lbnQpO1xuICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICB0aGlzLl9lbGVtZW50cy5zcGxpY2UoaWR4LCAxKTtcbiAgICB9XG4gIH0sIF9oYW5kbGVVcDpmdW5jdGlvbihldmVudCkge1xuICAgIGlmIChwYy5Nb3VzZS5pc1BvaW50ZXJMb2NrZWQoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jYWxjTW91c2VDb29yZHMoZXZlbnQpO1xuICAgIGlmICh0YXJnZXRYID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX29uRWxlbWVudE1vdXNlRXZlbnQoZXZlbnQpO1xuICB9LCBfaGFuZGxlRG93bjpmdW5jdGlvbihldmVudCkge1xuICAgIGlmIChwYy5Nb3VzZS5pc1BvaW50ZXJMb2NrZWQoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jYWxjTW91c2VDb29yZHMoZXZlbnQpO1xuICAgIGlmICh0YXJnZXRYID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX29uRWxlbWVudE1vdXNlRXZlbnQoZXZlbnQpO1xuICB9LCBfaGFuZGxlTW92ZTpmdW5jdGlvbihldmVudCkge1xuICAgIHRoaXMuX2NhbGNNb3VzZUNvb3JkcyhldmVudCk7XG4gICAgaWYgKHRhcmdldFggPT09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fb25FbGVtZW50TW91c2VFdmVudChldmVudCk7XG4gICAgdGhpcy5fbGFzdFggPSB0YXJnZXRYO1xuICAgIHRoaXMuX2xhc3RZID0gdGFyZ2V0WTtcbiAgfSwgX2hhbmRsZVdoZWVsOmZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgdGhpcy5fY2FsY01vdXNlQ29vcmRzKGV2ZW50KTtcbiAgICBpZiAodGFyZ2V0WCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9vbkVsZW1lbnRNb3VzZUV2ZW50KGV2ZW50KTtcbiAgfSwgX2hhbmRsZVRvdWNoU3RhcnQ6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgY2FtZXJhcyA9IHRoaXMuYXBwLnN5c3RlbXMuY2FtZXJhLmNhbWVyYXM7XG4gICAgZm9yICh2YXIgaSA9IGNhbWVyYXMubGVuZ3RoIC0gMTtpID49IDA7aS0tKSB7XG4gICAgICB2YXIgY2FtZXJhID0gY2FtZXJhc1tpXTtcbiAgICAgIHZhciBkb25lID0gMDtcbiAgICAgIGZvciAodmFyIGogPSAwLCBsZW4gPSBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7aiA8IGxlbjtqKyspIHtcbiAgICAgICAgaWYgKHRoaXMuX3RvdWNoZWRFbGVtZW50c1tldmVudC5jaGFuZ2VkVG91Y2hlc1tqXS5pZGVudGlmaWVyXSkge1xuICAgICAgICAgIGRvbmUrKztcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgY29vcmRzID0gdGhpcy5fY2FsY1RvdWNoQ29vcmRzKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2pdKTtcbiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLl9nZXRUYXJnZXRFbGVtZW50KGNhbWVyYSwgY29vcmRzLngsIGNvb3Jkcy55KTtcbiAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICBkb25lKys7XG4gICAgICAgICAgdGhpcy5fdG91Y2hlZEVsZW1lbnRzW2V2ZW50LmNoYW5nZWRUb3VjaGVzW2pdLmlkZW50aWZpZXJdID0gZWxlbWVudDtcbiAgICAgICAgICB0aGlzLl9maXJlRXZlbnQoZXZlbnQudHlwZSwgbmV3IEVsZW1lbnRUb3VjaEV2ZW50KGV2ZW50LCBlbGVtZW50LCB0aGlzKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChkb25lID09PSBsZW4pIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9LCBfaGFuZGxlVG91Y2hFbmQ6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgY2FtZXJhcyA9IHRoaXMuYXBwLnN5c3RlbXMuY2FtZXJhLmNhbWVyYXM7XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMuX2NsaWNrZWRFbnRpdGllcykge1xuICAgICAgZGVsZXRlIHRoaXMuX2NsaWNrZWRFbnRpdGllc1trZXldO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgdG91Y2ggPSBldmVudC5jaGFuZ2VkVG91Y2hlc1tpXTtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fdG91Y2hlZEVsZW1lbnRzW3RvdWNoLmlkZW50aWZpZXJdO1xuICAgICAgaWYgKCFlbGVtZW50KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgZGVsZXRlIHRoaXMuX3RvdWNoZWRFbGVtZW50c1t0b3VjaC5pZGVudGlmaWVyXTtcbiAgICAgIHRoaXMuX2ZpcmVFdmVudChldmVudC50eXBlLCBuZXcgRWxlbWVudFRvdWNoRXZlbnQoZXZlbnQsIGVsZW1lbnQsIHRoaXMpKTtcbiAgICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB2YXIgY29vcmRzID0gdGhpcy5fY2FsY1RvdWNoQ29vcmRzKHRvdWNoKTtcbiAgICAgICAgZm9yICh2YXIgYyA9IGNhbWVyYXMubGVuZ3RoIC0gMTtjID49IDA7Yy0tKSB7XG4gICAgICAgICAgdmFyIGhvdmVyZWQgPSB0aGlzLl9nZXRUYXJnZXRFbGVtZW50KGNhbWVyYXNbY10sIGNvb3Jkcy54LCBjb29yZHMueSk7XG4gICAgICAgICAgaWYgKGhvdmVyZWQgPT09IGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5fY2xpY2tlZEVudGl0aWVzW2VsZW1lbnQuZW50aXR5LmdldEd1aWQoKV0pIHtcbiAgICAgICAgICAgICAgdGhpcy5fZmlyZUV2ZW50KFwiY2xpY2tcIiwgbmV3IEVsZW1lbnRUb3VjaEV2ZW50KGV2ZW50LCBlbGVtZW50LCB0aGlzKSk7XG4gICAgICAgICAgICAgIHRoaXMuX2NsaWNrZWRFbnRpdGllc1tlbGVtZW50LmVudGl0eS5nZXRHdWlkKCldID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIF9oYW5kbGVUb3VjaE1vdmU6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fdG91Y2hlZEVsZW1lbnRzW2V2ZW50LmNoYW5nZWRUb3VjaGVzW2ldLmlkZW50aWZpZXJdO1xuICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5fZmlyZUV2ZW50KGV2ZW50LnR5cGUsIG5ldyBFbGVtZW50VG91Y2hFdmVudChldmVudCwgZWxlbWVudCwgdGhpcykpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX29uRWxlbWVudE1vdXNlRXZlbnQ6ZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgZWxlbWVudDtcbiAgICB2YXIgaG92ZXJlZCA9IHRoaXMuX2hvdmVyZWRFbGVtZW50O1xuICAgIHRoaXMuX2hvdmVyZWRFbGVtZW50ID0gbnVsbDtcbiAgICB2YXIgY2FtZXJhcyA9IHRoaXMuYXBwLnN5c3RlbXMuY2FtZXJhLmNhbWVyYXM7XG4gICAgZm9yICh2YXIgaSA9IGNhbWVyYXMubGVuZ3RoIC0gMTtpID49IDA7aS0tKSB7XG4gICAgICB2YXIgY2FtZXJhID0gY2FtZXJhc1tpXTtcbiAgICAgIGVsZW1lbnQgPSB0aGlzLl9nZXRUYXJnZXRFbGVtZW50KGNhbWVyYSwgdGFyZ2V0WCwgdGFyZ2V0WSk7XG4gICAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIHRoaXMuX2ZpcmVFdmVudChldmVudC50eXBlLCBuZXcgRWxlbWVudE1vdXNlRXZlbnQoZXZlbnQsIGVsZW1lbnQsIHRhcmdldFgsIHRhcmdldFksIHRoaXMuX2xhc3RYLCB0aGlzLl9sYXN0WSkpO1xuICAgICAgdGhpcy5faG92ZXJlZEVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IHBjLkVWRU5UX01PVVNFRE9XTikge1xuICAgICAgICB0aGlzLl9wcmVzc2VkRWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChob3ZlcmVkICE9PSB0aGlzLl9ob3ZlcmVkRWxlbWVudCkge1xuICAgICAgaWYgKGhvdmVyZWQpIHtcbiAgICAgICAgdGhpcy5fZmlyZUV2ZW50KFwibW91c2VsZWF2ZVwiLCBuZXcgRWxlbWVudE1vdXNlRXZlbnQoZXZlbnQsIGhvdmVyZWQsIHRhcmdldFgsIHRhcmdldFksIHRoaXMuX2xhc3RYLCB0aGlzLl9sYXN0WSkpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX2hvdmVyZWRFbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX2ZpcmVFdmVudChcIm1vdXNlZW50ZXJcIiwgbmV3IEVsZW1lbnRNb3VzZUV2ZW50KGV2ZW50LCB0aGlzLl9ob3ZlcmVkRWxlbWVudCwgdGFyZ2V0WCwgdGFyZ2V0WSwgdGhpcy5fbGFzdFgsIHRoaXMuX2xhc3RZKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChldmVudC50eXBlID09PSBwYy5FVkVOVF9NT1VTRVVQICYmIHRoaXMuX3ByZXNzZWRFbGVtZW50KSB7XG4gICAgICBpZiAodGhpcy5fcHJlc3NlZEVsZW1lbnQgPT09IHRoaXMuX2hvdmVyZWRFbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX3ByZXNzZWRFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgaWYgKCF0aGlzLl9jbGlja2VkRW50aXRpZXMgfHwgIXRoaXMuX2NsaWNrZWRFbnRpdGllc1t0aGlzLl9ob3ZlcmVkRWxlbWVudC5lbnRpdHkuZ2V0R3VpZCgpXSkge1xuICAgICAgICAgIHRoaXMuX2ZpcmVFdmVudChcImNsaWNrXCIsIG5ldyBFbGVtZW50TW91c2VFdmVudChldmVudCwgdGhpcy5faG92ZXJlZEVsZW1lbnQsIHRhcmdldFgsIHRhcmdldFksIHRoaXMuX2xhc3RYLCB0aGlzLl9sYXN0WSkpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9wcmVzc2VkRWxlbWVudCA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuICB9LCBfZmlyZUV2ZW50OmZ1bmN0aW9uKG5hbWUsIGV2dCkge1xuICAgIHZhciBlbGVtZW50ID0gZXZ0LmVsZW1lbnQ7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGVsZW1lbnQuZmlyZShuYW1lLCBldnQpO1xuICAgICAgaWYgKGV2dC5fc3RvcFByb3BhZ2F0aW9uKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgaWYgKCFlbGVtZW50LmVudGl0eS5wYXJlbnQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBlbGVtZW50ID0gZWxlbWVudC5lbnRpdHkucGFyZW50LmVsZW1lbnQ7XG4gICAgICBpZiAoIWVsZW1lbnQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9LCBfY2FsY01vdXNlQ29vcmRzOmZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgdmFyIHJlY3QgPSB0aGlzLl90YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgdmFyIGxlZnQgPSBNYXRoLmZsb29yKHJlY3QubGVmdCk7XG4gICAgdmFyIHRvcCA9IE1hdGguZmxvb3IocmVjdC50b3ApO1xuICAgIGlmIChldmVudC5jbGllbnRYIDwgbGVmdCB8fCBldmVudC5jbGllbnRYID49IGxlZnQgKyB0aGlzLl90YXJnZXQuY2xpZW50V2lkdGggfHwgZXZlbnQuY2xpZW50WSA8IHRvcCB8fCBldmVudC5jbGllbnRZID49IHRvcCArIHRoaXMuX3RhcmdldC5jbGllbnRIZWlnaHQpIHtcbiAgICAgIHRhcmdldFggPSBudWxsO1xuICAgICAgdGFyZ2V0WSA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldFggPSBldmVudC5jbGllbnRYIC0gbGVmdDtcbiAgICAgIHRhcmdldFkgPSBldmVudC5jbGllbnRZIC0gdG9wO1xuICAgIH1cbiAgfSwgX2NhbGNUb3VjaENvb3JkczpmdW5jdGlvbih0b3VjaCkge1xuICAgIHZhciB0b3RhbE9mZnNldFggPSAwO1xuICAgIHZhciB0b3RhbE9mZnNldFkgPSAwO1xuICAgIHZhciBjYW52YXNYID0gMDtcbiAgICB2YXIgY2FudmFzWSA9IDA7XG4gICAgdmFyIHRhcmdldCA9IHRvdWNoLnRhcmdldDtcbiAgICB3aGlsZSAoISh0YXJnZXQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlO1xuICAgIH1cbiAgICB2YXIgY3VycmVudEVsZW1lbnQgPSB0YXJnZXQ7XG4gICAgZG8ge1xuICAgICAgdG90YWxPZmZzZXRYICs9IGN1cnJlbnRFbGVtZW50Lm9mZnNldExlZnQgLSBjdXJyZW50RWxlbWVudC5zY3JvbGxMZWZ0O1xuICAgICAgdG90YWxPZmZzZXRZICs9IGN1cnJlbnRFbGVtZW50Lm9mZnNldFRvcCAtIGN1cnJlbnRFbGVtZW50LnNjcm9sbFRvcDtcbiAgICAgIGN1cnJlbnRFbGVtZW50ID0gY3VycmVudEVsZW1lbnQub2Zmc2V0UGFyZW50O1xuICAgIH0gd2hpbGUgKGN1cnJlbnRFbGVtZW50KTtcbiAgICByZXR1cm4ge3g6dG91Y2gucGFnZVggLSB0b3RhbE9mZnNldFgsIHk6dG91Y2gucGFnZVkgLSB0b3RhbE9mZnNldFl9O1xuICB9LCBfc29ydEVsZW1lbnRzOmZ1bmN0aW9uKGEsIGIpIHtcbiAgICBpZiAoYS5zY3JlZW4gJiYgIWIuc2NyZWVuKSB7XG4gICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIGlmICghYS5zY3JlZW4gJiYgYi5zY3JlZW4pIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICBpZiAoIWEuc2NyZWVuICYmICFiLnNjcmVlbikge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGlmIChhLnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UgJiYgIWIuc2NyZWVuLnNjcmVlbi5zY3JlZW5TcGFjZSkge1xuICAgICAgcmV0dXJuIC0xO1xuICAgIH1cbiAgICBpZiAoYi5zY3JlZW4uc2NyZWVuLnNjcmVlblNwYWNlICYmICFhLnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gYi5kcmF3T3JkZXIgLSBhLmRyYXdPcmRlcjtcbiAgfSwgX2dldFRhcmdldEVsZW1lbnQ6ZnVuY3Rpb24oY2FtZXJhLCB4LCB5KSB7XG4gICAgdmFyIHJlc3VsdCA9IG51bGw7XG4gICAgdGhpcy5fZWxlbWVudHMuc29ydCh0aGlzLl9zb3J0RWxlbWVudHMpO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9lbGVtZW50cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fZWxlbWVudHNbaV07XG4gICAgICBpZiAoZWxlbWVudC5zY3JlZW4gJiYgZWxlbWVudC5zY3JlZW4uc2NyZWVuLnNjcmVlblNwYWNlKSB7XG4gICAgICAgIGlmICh0aGlzLl9jaGVja0VsZW1lbnQyZCh4LCB5LCBlbGVtZW50LCBjYW1lcmEpKSB7XG4gICAgICAgICAgcmVzdWx0ID0gZWxlbWVudDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuX2NoZWNrRWxlbWVudDNkKHgsIHksIGVsZW1lbnQsIGNhbWVyYSkpIHtcbiAgICAgICAgICByZXN1bHQgPSBlbGVtZW50O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH0sIF9jaGVja0VsZW1lbnQyZDpmdW5jdGlvbih4LCB5LCBlbGVtZW50LCBjYW1lcmEpIHtcbiAgICB2YXIgc3cgPSB0aGlzLmFwcC5ncmFwaGljc0RldmljZS53aWR0aDtcbiAgICB2YXIgc2ggPSB0aGlzLmFwcC5ncmFwaGljc0RldmljZS5oZWlnaHQ7XG4gICAgdmFyIGNhbWVyYVdpZHRoID0gY2FtZXJhLnJlY3QueiAqIHN3O1xuICAgIHZhciBjYW1lcmFIZWlnaHQgPSBjYW1lcmEucmVjdC53ICogc2g7XG4gICAgdmFyIGNhbWVyYUxlZnQgPSBjYW1lcmEucmVjdC54ICogc3c7XG4gICAgdmFyIGNhbWVyYVJpZ2h0ID0gY2FtZXJhTGVmdCArIGNhbWVyYVdpZHRoO1xuICAgIHZhciBjYW1lcmFCb3R0b20gPSAoMSAtIGNhbWVyYS5yZWN0LnkpICogc2g7XG4gICAgdmFyIGNhbWVyYVRvcCA9IGNhbWVyYUJvdHRvbSAtIGNhbWVyYUhlaWdodDtcbiAgICB2YXIgX3ggPSB4ICogc3cgLyB0aGlzLl90YXJnZXQuY2xpZW50V2lkdGg7XG4gICAgdmFyIF95ID0geSAqIHNoIC8gdGhpcy5fdGFyZ2V0LmNsaWVudEhlaWdodDtcbiAgICBpZiAoX3ggPj0gY2FtZXJhTGVmdCAmJiBfeCA8PSBjYW1lcmFSaWdodCAmJiBfeSA8PSBjYW1lcmFCb3R0b20gJiYgX3kgPj0gY2FtZXJhVG9wKSB7XG4gICAgICBfeCA9IHN3ICogKF94IC0gY2FtZXJhTGVmdCkgLyBjYW1lcmFXaWR0aDtcbiAgICAgIF95ID0gc2ggKiAoX3kgLSBjYW1lcmFUb3ApIC8gY2FtZXJhSGVpZ2h0O1xuICAgICAgX3kgPSBzaCAtIF95O1xuICAgICAgdmFyIHNjcmVlbkNvcm5lcnMgPSBlbGVtZW50LnNjcmVlbkNvcm5lcnM7XG4gICAgICB2ZWNBLnNldChfeCwgX3ksIDEpO1xuICAgICAgdmVjQi5zZXQoX3gsIF95LCAtMSk7XG4gICAgICBpZiAoaW50ZXJzZWN0TGluZVF1YWQodmVjQSwgdmVjQiwgc2NyZWVuQ29ybmVycykpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSwgX2NoZWNrRWxlbWVudDNkOmZ1bmN0aW9uKHgsIHksIGVsZW1lbnQsIGNhbWVyYSkge1xuICAgIHZhciBzdyA9IHRoaXMuX3RhcmdldC5jbGllbnRXaWR0aDtcbiAgICB2YXIgc2ggPSB0aGlzLl90YXJnZXQuY2xpZW50SGVpZ2h0O1xuICAgIHZhciBjYW1lcmFXaWR0aCA9IGNhbWVyYS5yZWN0LnogKiBzdztcbiAgICB2YXIgY2FtZXJhSGVpZ2h0ID0gY2FtZXJhLnJlY3QudyAqIHNoO1xuICAgIHZhciBjYW1lcmFMZWZ0ID0gY2FtZXJhLnJlY3QueCAqIHN3O1xuICAgIHZhciBjYW1lcmFSaWdodCA9IGNhbWVyYUxlZnQgKyBjYW1lcmFXaWR0aDtcbiAgICB2YXIgY2FtZXJhQm90dG9tID0gKDEgLSBjYW1lcmEucmVjdC55KSAqIHNoO1xuICAgIHZhciBjYW1lcmFUb3AgPSBjYW1lcmFCb3R0b20gLSBjYW1lcmFIZWlnaHQ7XG4gICAgdmFyIF94ID0geDtcbiAgICB2YXIgX3kgPSB5O1xuICAgIGlmICh4ID49IGNhbWVyYUxlZnQgJiYgeCA8PSBjYW1lcmFSaWdodCAmJiB5IDw9IGNhbWVyYUJvdHRvbSAmJiBfeSA+PSBjYW1lcmFUb3ApIHtcbiAgICAgIF94ID0gc3cgKiAoX3ggLSBjYW1lcmFMZWZ0KSAvIGNhbWVyYVdpZHRoO1xuICAgICAgX3kgPSBzaCAqIChfeSAtIGNhbWVyYVRvcCkgLyBjYW1lcmFIZWlnaHQ7XG4gICAgICB2YXIgd29ybGRDb3JuZXJzID0gZWxlbWVudC53b3JsZENvcm5lcnM7XG4gICAgICB2YXIgc3RhcnQgPSBjYW1lcmEuZW50aXR5LmdldFBvc2l0aW9uKCk7XG4gICAgICB2YXIgZW5kID0gdmVjQTtcbiAgICAgIGNhbWVyYS5zY3JlZW5Ub1dvcmxkKF94LCBfeSwgY2FtZXJhLmZhckNsaXAsIGVuZCk7XG4gICAgICBpZiAoaW50ZXJzZWN0TGluZVF1YWQoc3RhcnQsIGVuZCwgd29ybGRDb3JuZXJzKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRJbnB1dC5wcm90b3R5cGUsIFwiYXBwXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FwcCB8fCBwYy5hcHA7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2FwcCA9IHZhbHVlO1xuICB9fSk7XG4gIHJldHVybiB7RWxlbWVudElucHV0OkVsZW1lbnRJbnB1dCwgRWxlbWVudElucHV0RXZlbnQ6RWxlbWVudElucHV0RXZlbnQsIEVsZW1lbnRNb3VzZUV2ZW50OkVsZW1lbnRNb3VzZUV2ZW50LCBFbGVtZW50VG91Y2hFdmVudDpFbGVtZW50VG91Y2hFdmVudH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFZyTWFuYWdlciA9IGZ1bmN0aW9uKGFwcCkge1xuICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHRoaXMuaXNTdXBwb3J0ZWQgPSBWck1hbmFnZXIuaXNTdXBwb3J0ZWQ7XG4gICAgdGhpcy51c2VzUG9seWZpbGwgPSBWck1hbmFnZXIudXNlc1BvbHlmaWxsO1xuICAgIGlmICh3aW5kb3cuSW5pdGlhbGl6ZVdlYlZSUG9seWZpbGwpIHtcbiAgICAgIHdpbmRvdy5Jbml0aWFsaXplV2ViVlJQb2x5ZmlsbCgpO1xuICAgIH1cbiAgICB0aGlzLl9pbmRleCA9IHt9O1xuICAgIHRoaXMuZGlzcGxheXMgPSBbXTtcbiAgICB0aGlzLmRpc3BsYXkgPSBudWxsO1xuICAgIHRoaXMuX2FwcCA9IGFwcDtcbiAgICB0aGlzLl9vbkRpc3BsYXlDb25uZWN0ID0gdGhpcy5fb25EaXNwbGF5Q29ubmVjdC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX29uRGlzcGxheURpc2Nvbm5lY3QgPSB0aGlzLl9vbkRpc3BsYXlEaXNjb25uZWN0LmJpbmQodGhpcyk7XG4gICAgc2VsZi5fYXR0YWNoKCk7XG4gICAgdGhpcy5fZ2V0RGlzcGxheXMoZnVuY3Rpb24oZXJyLCBkaXNwbGF5cykge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBzZWxmLmZpcmUoXCJlcnJvclwiLCBlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IGRpc3BsYXlzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICBzZWxmLl9hZGREaXNwbGF5KGRpc3BsYXlzW2ldKTtcbiAgICAgICAgfVxuICAgICAgICBzZWxmLmZpcmUoXCJyZWFkeVwiLCBzZWxmLmRpc3BsYXlzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcbiAgVnJNYW5hZ2VyLmlzU3VwcG9ydGVkID0gISFuYXZpZ2F0b3IuZ2V0VlJEaXNwbGF5cztcbiAgVnJNYW5hZ2VyLnVzZXNQb2x5ZmlsbCA9ICEhd2luZG93LkluaXRpYWxpemVXZWJWUlBvbHlmaWxsO1xuICBWck1hbmFnZXIucHJvdG90eXBlID0ge19hdHRhY2g6ZnVuY3Rpb24oKSB7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJ2cmRpc3BsYXljb25uZWN0XCIsIHRoaXMuX29uRGlzcGxheUNvbm5lY3QpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwidnJkaXNwbGF5ZGlzY29ubmVjdFwiLCB0aGlzLl9vbkRpc3BsYXlEaXNjb25uZWN0KTtcbiAgfSwgX2RldGFjaDpmdW5jdGlvbigpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInZyZGlzcGxheWNvbm5lY3RcIiwgdGhpcy5fb25EaXNwbGF5Q29ubmVjdCk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ2cmRpc3BsYXlkaXNjb25uZWN0XCIsIHRoaXMuX29uRGlzcGxheURpc2Nvbm5lY3QpO1xuICB9LCBkZXN0cm95OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX2RldGFjaCgpO1xuICB9LCBwb2xsOmZ1bmN0aW9uKCkge1xuICAgIHZhciBsID0gdGhpcy5kaXNwbGF5cy5sZW5ndGg7XG4gICAgaWYgKCFsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwO2kgPCBsO2krKykge1xuICAgICAgaWYgKHRoaXMuZGlzcGxheXNbaV0uX2NhbWVyYSkge1xuICAgICAgICB0aGlzLmRpc3BsYXlzW2ldLnBvbGwoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9nZXREaXNwbGF5czpmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBpZiAobmF2aWdhdG9yLmdldFZSRGlzcGxheXMpIHtcbiAgICAgIG5hdmlnYXRvci5nZXRWUkRpc3BsYXlzKCkudGhlbihmdW5jdGlvbihkaXNwbGF5cykge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBkaXNwbGF5cyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKFwiV2ViVlIgbm90IHN1cHBvcnRlZFwiKSk7XG4gICAgICB9XG4gICAgfVxuICB9LCBfYWRkRGlzcGxheTpmdW5jdGlvbih2ckRpc3BsYXkpIHtcbiAgICBpZiAodGhpcy5faW5kZXhbdnJEaXNwbGF5LmRpc3BsYXlJZF0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGRpc3BsYXkgPSBuZXcgcGMuVnJEaXNwbGF5KHRoaXMuX2FwcCwgdnJEaXNwbGF5KTtcbiAgICB0aGlzLl9pbmRleFtkaXNwbGF5LmlkXSA9IGRpc3BsYXk7XG4gICAgdGhpcy5kaXNwbGF5cy5wdXNoKGRpc3BsYXkpO1xuICAgIGlmICghdGhpcy5kaXNwbGF5KSB7XG4gICAgICB0aGlzLmRpc3BsYXkgPSBkaXNwbGF5O1xuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJkaXNwbGF5Y29ubmVjdFwiLCBkaXNwbGF5KTtcbiAgfSwgX29uRGlzcGxheUNvbm5lY3Q6ZnVuY3Rpb24oZSkge1xuICAgIGlmIChlLmRldGFpbCAmJiBlLmRldGFpbC5kaXNwbGF5KSB7XG4gICAgICB0aGlzLl9hZGREaXNwbGF5KGUuZGV0YWlsLmRpc3BsYXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hZGREaXNwbGF5KGUuZGlzcGxheSk7XG4gICAgfVxuICB9LCBfb25EaXNwbGF5RGlzY29ubmVjdDpmdW5jdGlvbihlKSB7XG4gICAgdmFyIGlkO1xuICAgIGlmIChlLmRldGFpbCAmJiBlLmRldGFpbC5kaXNwbGF5KSB7XG4gICAgICBpZCA9IGUuZGV0YWlsLmRpc3BsYXkuZGlzcGxheUlkO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZCA9IGUuZGlzcGxheS5kaXNwbGF5SWQ7XG4gICAgfVxuICAgIHZhciBkaXNwbGF5ID0gdGhpcy5faW5kZXhbaWRdO1xuICAgIGlmICghZGlzcGxheSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkaXNwbGF5LmRlc3Ryb3koKTtcbiAgICBkZWxldGUgdGhpcy5faW5kZXhbZGlzcGxheS5pZF07XG4gICAgdmFyIGluZCA9IHRoaXMuZGlzcGxheXMuaW5kZXhPZihkaXNwbGF5KTtcbiAgICB0aGlzLmRpc3BsYXlzLnNwbGljZShpbmQsIDEpO1xuICAgIGlmICh0aGlzLmRpc3BsYXkgPT09IGRpc3BsYXkpIHtcbiAgICAgIGlmICh0aGlzLmRpc3BsYXlzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmRpc3BsYXkgPSB0aGlzLmRpc3BsYXlzWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kaXNwbGF5ID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5maXJlKFwiZGlzcGxheWRpc2Nvbm5lY3RcIiwgZGlzcGxheSk7XG4gIH19O1xuICByZXR1cm4ge1ZyTWFuYWdlcjpWck1hbmFnZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBWckRpc3BsYXkgPSBmdW5jdGlvbihhcHAsIGRpc3BsYXkpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5fYXBwID0gYXBwO1xuICAgIHRoaXMuX2RldmljZSA9IGFwcC5ncmFwaGljc0RldmljZTtcbiAgICB0aGlzLmlkID0gZGlzcGxheS5kaXNwbGF5SWQ7XG4gICAgdGhpcy5fZnJhbWVEYXRhID0gbnVsbDtcbiAgICBpZiAod2luZG93LlZSRnJhbWVEYXRhKSB7XG4gICAgICB0aGlzLl9mcmFtZURhdGEgPSBuZXcgd2luZG93LlZSRnJhbWVEYXRhO1xuICAgIH1cbiAgICB0aGlzLmRpc3BsYXkgPSBkaXNwbGF5O1xuICAgIHRoaXMuX2NhbWVyYSA9IG51bGw7XG4gICAgdGhpcy5zaXRUb1N0YW5kSW52ID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5sZWZ0VmlldyA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMubGVmdFByb2ogPSBuZXcgcGMuTWF0NDtcbiAgICB0aGlzLmxlZnRWaWV3SW52ID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5sZWZ0UG9zID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5yaWdodFZpZXcgPSBuZXcgcGMuTWF0NDtcbiAgICB0aGlzLnJpZ2h0UHJvaiA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMucmlnaHRWaWV3SW52ID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5yaWdodFBvcyA9IG5ldyBwYy5WZWMzO1xuICAgIHRoaXMuY29tYmluZWRQb3MgPSBuZXcgcGMuVmVjMztcbiAgICB0aGlzLmNvbWJpbmVkVmlldyA9IG5ldyBwYy5NYXQ0O1xuICAgIHRoaXMuY29tYmluZWRQcm9qID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5jb21iaW5lZFZpZXdJbnYgPSBuZXcgcGMuTWF0NDtcbiAgICB0aGlzLmNvbWJpbmVkRm92ID0gMDtcbiAgICB0aGlzLmNvbWJpbmVkQXNwZWN0ID0gMDtcbiAgICB0aGlzLnByZXNlbnRpbmcgPSBmYWxzZTtcbiAgICBzZWxmLl9wcmVzZW50Q2hhbmdlID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgIHZhciBkaXNwbGF5O1xuICAgICAgaWYgKGV2ZW50LmRpc3BsYXkpIHtcbiAgICAgICAgZGlzcGxheSA9IGV2ZW50LmRpc3BsYXk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZXZlbnQuZGV0YWlsICYmIGV2ZW50LmRldGFpbC5kaXNwbGF5KSB7XG4gICAgICAgICAgZGlzcGxheSA9IGV2ZW50LmRldGFpbC5kaXNwbGF5O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChldmVudC5kZXRhaWwgJiYgZXZlbnQuZGV0YWlsLnZyZGlzcGxheSkge1xuICAgICAgICAgICAgZGlzcGxheSA9IGV2ZW50LmRldGFpbC52cmRpc3BsYXk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpc3BsYXkgPSBzZWxmLmRpc3BsYXk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoZGlzcGxheSA9PT0gc2VsZi5kaXNwbGF5KSB7XG4gICAgICAgIHNlbGYucHJlc2VudGluZyA9IHNlbGYuZGlzcGxheSAmJiBzZWxmLmRpc3BsYXkuaXNQcmVzZW50aW5nO1xuICAgICAgICBpZiAoc2VsZi5wcmVzZW50aW5nKSB7XG4gICAgICAgICAgdmFyIGxlZnRFeWUgPSBzZWxmLmRpc3BsYXkuZ2V0RXllUGFyYW1ldGVycyhcImxlZnRcIik7XG4gICAgICAgICAgdmFyIHJpZ2h0RXllID0gc2VsZi5kaXNwbGF5LmdldEV5ZVBhcmFtZXRlcnMoXCJyaWdodFwiKTtcbiAgICAgICAgICB2YXIgdyA9IE1hdGgubWF4KGxlZnRFeWUucmVuZGVyV2lkdGgsIHJpZ2h0RXllLnJlbmRlcldpZHRoKSAqIDI7XG4gICAgICAgICAgdmFyIGggPSBNYXRoLm1heChsZWZ0RXllLnJlbmRlckhlaWdodCwgcmlnaHRFeWUucmVuZGVySGVpZ2h0KTtcbiAgICAgICAgICBzZWxmLl9hcHAuZ3JhcGhpY3NEZXZpY2Uuc2V0UmVzb2x1dGlvbih3LCBoKTtcbiAgICAgICAgICBzZWxmLl9hcHAuX2FsbG93UmVzaXplID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VsZi5fYXBwLnNldENhbnZhc1Jlc29sdXRpb24ocGMuUkVTT0xVVElPTl9BVVRPKTtcbiAgICAgICAgICBzZWxmLl9hcHAuX2FsbG93UmVzaXplID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBzZWxmLmZpcmUoXCJiZWZvcmVwcmVzZW50Y2hhbmdlXCIsIHNlbGYpO1xuICAgICAgICBzZWxmLmZpcmUoXCJwcmVzZW50Y2hhbmdlXCIsIHNlbGYpO1xuICAgICAgfVxuICAgIH07XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJ2cmRpc3BsYXlwcmVzZW50Y2hhbmdlXCIsIHNlbGYuX3ByZXNlbnRDaGFuZ2UsIGZhbHNlKTtcbiAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICB9O1xuICBWckRpc3BsYXkucHJvdG90eXBlID0ge2Rlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ2cmRpc3BsYXlwcmVzZW50Y2hhbmdlXCIsIHNlbGYuX3ByZXNlbnRDaGFuZ2UpO1xuICAgIGlmICh0aGlzLl9jYW1lcmEpIHtcbiAgICAgIHRoaXMuX2NhbWVyYS52ckRpc3BsYXkgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLl9jYW1lcmEgPSBudWxsO1xuICB9LCBwb2xsOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmRpc3BsYXkpIHtcbiAgICAgIHRoaXMuZGlzcGxheS5nZXRGcmFtZURhdGEodGhpcy5fZnJhbWVEYXRhKTtcbiAgICAgIHRoaXMubGVmdFByb2ouZGF0YSA9IHRoaXMuX2ZyYW1lRGF0YS5sZWZ0UHJvamVjdGlvbk1hdHJpeDtcbiAgICAgIHRoaXMucmlnaHRQcm9qLmRhdGEgPSB0aGlzLl9mcmFtZURhdGEucmlnaHRQcm9qZWN0aW9uTWF0cml4O1xuICAgICAgdmFyIHN0YWdlID0gdGhpcy5kaXNwbGF5LnN0YWdlUGFyYW1ldGVycztcbiAgICAgIGlmIChzdGFnZSkge1xuICAgICAgICB0aGlzLnNpdFRvU3RhbmRJbnYuc2V0KHN0YWdlLnNpdHRpbmdUb1N0YW5kaW5nVHJhbnNmb3JtKS5pbnZlcnQoKTtcbiAgICAgICAgdGhpcy5jb21iaW5lZFZpZXcuc2V0KHRoaXMuX2ZyYW1lRGF0YS5sZWZ0Vmlld01hdHJpeCk7XG4gICAgICAgIHRoaXMubGVmdFZpZXcubXVsMih0aGlzLmNvbWJpbmVkVmlldywgdGhpcy5zaXRUb1N0YW5kSW52KTtcbiAgICAgICAgdGhpcy5jb21iaW5lZFZpZXcuc2V0KHRoaXMuX2ZyYW1lRGF0YS5yaWdodFZpZXdNYXRyaXgpO1xuICAgICAgICB0aGlzLnJpZ2h0Vmlldy5tdWwyKHRoaXMuY29tYmluZWRWaWV3LCB0aGlzLnNpdFRvU3RhbmRJbnYpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sZWZ0Vmlldy5zZXQodGhpcy5fZnJhbWVEYXRhLmxlZnRWaWV3TWF0cml4KTtcbiAgICAgICAgdGhpcy5yaWdodFZpZXcuc2V0KHRoaXMuX2ZyYW1lRGF0YS5yaWdodFZpZXdNYXRyaXgpO1xuICAgICAgfVxuICAgICAgdmFyIG54ID0gdGhpcy5sZWZ0UHJvai5kYXRhWzNdICsgdGhpcy5sZWZ0UHJvai5kYXRhWzBdO1xuICAgICAgdmFyIG56ID0gdGhpcy5sZWZ0UHJvai5kYXRhWzExXSArIHRoaXMubGVmdFByb2ouZGF0YVs4XTtcbiAgICAgIHZhciBsID0gMS4wIC8gTWF0aC5zcXJ0KG54ICogbnggKyBueiAqIG56KTtcbiAgICAgIG54ICo9IGw7XG4gICAgICBueiAqPSBsO1xuICAgICAgdmFyIG1heEZvdiA9IC1NYXRoLmF0YW4yKG56LCBueCk7XG4gICAgICBueCA9IHRoaXMucmlnaHRQcm9qLmRhdGFbM10gKyB0aGlzLnJpZ2h0UHJvai5kYXRhWzBdO1xuICAgICAgbnogPSB0aGlzLnJpZ2h0UHJvai5kYXRhWzExXSArIHRoaXMucmlnaHRQcm9qLmRhdGFbOF07XG4gICAgICBsID0gMS4wIC8gTWF0aC5zcXJ0KG54ICogbnggKyBueiAqIG56KTtcbiAgICAgIG54ICo9IGw7XG4gICAgICBueiAqPSBsO1xuICAgICAgbWF4Rm92ID0gTWF0aC5tYXgobWF4Rm92LCAtTWF0aC5hdGFuMihueiwgbngpKTtcbiAgICAgIG1heEZvdiAqPSAyLjA7XG4gICAgICB0aGlzLmNvbWJpbmVkRm92ID0gbWF4Rm92O1xuICAgICAgdmFyIGFzcGVjdCA9IHRoaXMucmlnaHRQcm9qLmRhdGFbNV0gLyB0aGlzLnJpZ2h0UHJvai5kYXRhWzBdO1xuICAgICAgdGhpcy5jb21iaW5lZEFzcGVjdCA9IGFzcGVjdDtcbiAgICAgIHZhciB2aWV3ID0gdGhpcy5jb21iaW5lZFZpZXc7XG4gICAgICB2aWV3LmNvcHkodGhpcy5sZWZ0Vmlldyk7XG4gICAgICB2aWV3LmludmVydCgpO1xuICAgICAgdGhpcy5sZWZ0Vmlld0ludi5jb3B5KHZpZXcpO1xuICAgICAgdmFyIHBvcyA9IHRoaXMuY29tYmluZWRQb3MuZGF0YTtcbiAgICAgIHBvc1swXSA9IHRoaXMubGVmdFBvcy5kYXRhWzBdID0gdmlldy5kYXRhWzEyXTtcbiAgICAgIHBvc1sxXSA9IHRoaXMubGVmdFBvcy5kYXRhWzFdID0gdmlldy5kYXRhWzEzXTtcbiAgICAgIHBvc1syXSA9IHRoaXMubGVmdFBvcy5kYXRhWzJdID0gdmlldy5kYXRhWzE0XTtcbiAgICAgIHZpZXcuY29weSh0aGlzLnJpZ2h0Vmlldyk7XG4gICAgICB2aWV3LmludmVydCgpO1xuICAgICAgdGhpcy5yaWdodFZpZXdJbnYuY29weSh2aWV3KTtcbiAgICAgIHZhciBkZWx0YVggPSBwb3NbMF0gLSB2aWV3LmRhdGFbMTJdO1xuICAgICAgdmFyIGRlbHRhWSA9IHBvc1sxXSAtIHZpZXcuZGF0YVsxM107XG4gICAgICB2YXIgZGVsdGFaID0gcG9zWzJdIC0gdmlldy5kYXRhWzE0XTtcbiAgICAgIHZhciBkaXN0ID0gTWF0aC5zcXJ0KGRlbHRhWCAqIGRlbHRhWCArIGRlbHRhWSAqIGRlbHRhWSArIGRlbHRhWiAqIGRlbHRhWik7XG4gICAgICB0aGlzLnJpZ2h0UG9zLmRhdGFbMF0gPSB2aWV3LmRhdGFbMTJdO1xuICAgICAgdGhpcy5yaWdodFBvcy5kYXRhWzFdID0gdmlldy5kYXRhWzEzXTtcbiAgICAgIHRoaXMucmlnaHRQb3MuZGF0YVsyXSA9IHZpZXcuZGF0YVsxNF07XG4gICAgICBwb3NbMF0gKz0gdmlldy5kYXRhWzEyXTtcbiAgICAgIHBvc1sxXSArPSB2aWV3LmRhdGFbMTNdO1xuICAgICAgcG9zWzJdICs9IHZpZXcuZGF0YVsxNF07XG4gICAgICBwb3NbMF0gKj0gMC41O1xuICAgICAgcG9zWzFdICo9IDAuNTtcbiAgICAgIHBvc1syXSAqPSAwLjU7XG4gICAgICB2YXIgYiA9IE1hdGguUEkgKiAwLjU7XG4gICAgICB2YXIgYyA9IG1heEZvdiAqIDAuNTtcbiAgICAgIHZhciBhID0gTWF0aC5QSSAtIChiICsgYyk7XG4gICAgICB2YXIgb2Zmc2V0ID0gZGlzdCAqIDAuNSAqIE1hdGguc2luKGEpO1xuICAgICAgdmFyIGZ3ZFggPSB2aWV3LmRhdGFbOF07XG4gICAgICB2YXIgZndkWSA9IHZpZXcuZGF0YVs5XTtcbiAgICAgIHZhciBmd2RaID0gdmlldy5kYXRhWzEwXTtcbiAgICAgIHZpZXcuZGF0YVsxMl0gPSBwb3NbMF0gKyBmd2RYICogb2Zmc2V0O1xuICAgICAgdmlldy5kYXRhWzEzXSA9IHBvc1sxXSArIGZ3ZFkgKiBvZmZzZXQ7XG4gICAgICB2aWV3LmRhdGFbMTRdID0gcG9zWzJdICsgZndkWiAqIG9mZnNldDtcbiAgICAgIHRoaXMuY29tYmluZWRWaWV3SW52LmNvcHkodmlldyk7XG4gICAgICB2aWV3LmludmVydCgpO1xuICAgICAgdGhpcy5jb21iaW5lZFByb2ouc2V0UGVyc3BlY3RpdmUobWF4Rm92ICogcGMubWF0aC5SQURfVE9fREVHLCBhc3BlY3QsIHRoaXMuZGlzcGxheS5kZXB0aE5lYXIgKyBvZmZzZXQsIHRoaXMuZGlzcGxheS5kZXB0aEZhciArIG9mZnNldCwgdHJ1ZSk7XG4gICAgfVxuICB9LCByZXF1ZXN0UHJlc2VudDpmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIGlmICghdGhpcy5kaXNwbGF5KSB7XG4gICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKFwiTm8gVnJEaXNwbGF5IHRvIHJlcXVlc3RQcmVzZW50XCIpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMucHJlc2VudGluZykge1xuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihcIlZyRGlzcGxheSBhbHJlYWR5IHByZXNlbnRpbmdcIikpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRpc3BsYXkucmVxdWVzdFByZXNlbnQoW3tzb3VyY2U6dGhpcy5fZGV2aWNlLmNhbnZhc31dKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgfSwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSwgZXhpdFByZXNlbnQ6ZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICBpZiAoIXRoaXMuZGlzcGxheSkge1xuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihcIk5vIFZyRGlzcGxheSB0byBleGl0UHJlc2VudFwiKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5wcmVzZW50aW5nKSB7XG4gICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKFwiVnJEaXNwbGF5IG5vdCBwcmVzZW50aW5nXCIpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5kaXNwbGF5LmV4aXRQcmVzZW50KCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfVxuICAgIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihcImV4aXRQcmVzZW50IGZhaWxlZFwiKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sIHJlcXVlc3RBbmltYXRpb25GcmFtZTpmdW5jdGlvbihmbikge1xuICAgIGlmICh0aGlzLmRpc3BsYXkpIHtcbiAgICAgIHRoaXMuZGlzcGxheS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZm4pO1xuICAgIH1cbiAgfSwgc3VibWl0RnJhbWU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuZGlzcGxheSkge1xuICAgICAgdGhpcy5kaXNwbGF5LnN1Ym1pdEZyYW1lKCk7XG4gICAgfVxuICB9LCByZXNldDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5kaXNwbGF5KSB7XG4gICAgICB0aGlzLmRpc3BsYXkucmVzZXRQb3NlKCk7XG4gICAgfVxuICB9LCBzZXRDbGlwUGxhbmVzOmZ1bmN0aW9uKG4sIGYpIHtcbiAgICBpZiAodGhpcy5kaXNwbGF5KSB7XG4gICAgICB0aGlzLmRpc3BsYXkuZGVwdGhOZWFyID0gbjtcbiAgICAgIHRoaXMuZGlzcGxheS5kZXB0aEZhciA9IGY7XG4gICAgfVxuICB9LCBnZXRGcmFtZURhdGE6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuZGlzcGxheSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lRGF0YTtcbiAgICB9XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnJEaXNwbGF5LnByb3RvdHlwZSwgXCJjYXBhYmlsaXRpZXNcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5kaXNwbGF5KSB7XG4gICAgICByZXR1cm4gdGhpcy5kaXNwbGF5LmNhcGFiaWxpdGllcztcbiAgICB9XG4gICAgcmV0dXJuIHt9O1xuICB9fSk7XG4gIHJldHVybiB7VnJEaXNwbGF5OlZyRGlzcGxheX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEh0dHAgPSBmdW5jdGlvbiBIdHRwKCkge1xuICB9O1xuICBIdHRwLkNvbnRlbnRUeXBlID0ge0ZPUk1fVVJMRU5DT0RFRDpcImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFwiLCBHSUY6XCJpbWFnZS9naWZcIiwgSlBFRzpcImltYWdlL2pwZWdcIiwgRERTOlwiaW1hZ2UvZGRzXCIsIEpTT046XCJhcHBsaWNhdGlvbi9qc29uXCIsIFBORzpcImltYWdlL3BuZ1wiLCBURVhUOlwidGV4dC9wbGFpblwiLCBYTUw6XCJhcHBsaWNhdGlvbi94bWxcIiwgV0FWOlwiYXVkaW8veC13YXZcIiwgT0dHOlwiYXVkaW8vb2dnXCIsIE1QMzpcImF1ZGlvL21wZWdcIiwgTVA0OlwiYXVkaW8vbXA0XCIsIEFBQzpcImF1ZGlvL2FhY1wiLCBCSU46XCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIn07XG4gIEh0dHAuUmVzcG9uc2VUeXBlID0ge1RFWFQ6XCJ0ZXh0XCIsIEFSUkFZX0JVRkZFUjpcImFycmF5YnVmZmVyXCIsIEJMT0I6XCJibG9iXCIsIERPQ1VNRU5UOlwiZG9jdW1lbnRcIn07XG4gIEh0dHAuYmluYXJ5RXh0ZW5zaW9ucyA9IFtcIi5tb2RlbFwiLCBcIi53YXZcIiwgXCIub2dnXCIsIFwiLm1wM1wiLCBcIi5tcDRcIiwgXCIubTRhXCIsIFwiLmFhY1wiLCBcIi5kZHNcIl07XG4gIEh0dHAucHJvdG90eXBlID0ge0NvbnRlbnRUeXBlOkh0dHAuQ29udGVudFR5cGUsIFJlc3BvbnNlVHlwZTpIdHRwLlJlc3BvbnNlVHlwZSwgYmluYXJ5RXh0ZW5zaW9uczpIdHRwLmJpbmFyeUV4dGVuc2lvbnMsIGdldDpmdW5jdGlvbih1cmwsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIkdFVFwiLCB1cmwsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgfSwgcG9zdDpmdW5jdGlvbih1cmwsIGRhdGEsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgb3B0aW9ucy5wb3N0ZGF0YSA9IGRhdGE7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIlBPU1RcIiwgdXJsLCBvcHRpb25zLCBjYWxsYmFjayk7XG4gIH0sIHB1dDpmdW5jdGlvbih1cmwsIGRhdGEsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgb3B0aW9ucy5wb3N0ZGF0YSA9IGRhdGE7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIlBVVFwiLCB1cmwsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgfSwgZGVsOmZ1bmN0aW9uKHVybCwgb3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgICAgb3B0aW9ucyA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgb3B0aW9ucywgY2FsbGJhY2spO1xuICB9LCByZXF1ZXN0OmZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIHZhciB1cmksIHF1ZXJ5LCB0aW1lc3RhbXAsIHBvc3RkYXRhLCB4aHI7XG4gICAgdmFyIGVycm9yZWQgPSBmYWxzZTtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgICAgb3B0aW9ucyA9IHt9O1xuICAgIH1cbiAgICBvcHRpb25zLmNhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgaWYgKG9wdGlvbnMuYXN5bmMgPT0gbnVsbCkge1xuICAgICAgb3B0aW9ucy5hc3luYyA9IHRydWU7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmhlYWRlcnMgPT0gbnVsbCkge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzID0ge307XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnBvc3RkYXRhICE9IG51bGwpIHtcbiAgICAgIGlmIChvcHRpb25zLnBvc3RkYXRhIGluc3RhbmNlb2YgRG9jdW1lbnQpIHtcbiAgICAgICAgcG9zdGRhdGEgPSBvcHRpb25zLnBvc3RkYXRhO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKG9wdGlvbnMucG9zdGRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuICAgICAgICAgIHBvc3RkYXRhID0gb3B0aW9ucy5wb3N0ZGF0YTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAob3B0aW9ucy5wb3N0ZGF0YSBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICAgICAgdmFyIGNvbnRlbnRUeXBlID0gb3B0aW9ucy5oZWFkZXJzW1wiQ29udGVudC1UeXBlXCJdO1xuICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgb3B0aW9ucy5oZWFkZXJzW1wiQ29udGVudC1UeXBlXCJdID0gSHR0cC5Db250ZW50VHlwZS5GT1JNX1VSTEVOQ09ERUQ7XG4gICAgICAgICAgICAgIGNvbnRlbnRUeXBlID0gb3B0aW9ucy5oZWFkZXJzW1wiQ29udGVudC1UeXBlXCJdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3dpdGNoKGNvbnRlbnRUeXBlKSB7XG4gICAgICAgICAgICAgIGNhc2UgSHR0cC5Db250ZW50VHlwZS5GT1JNX1VSTEVOQ09ERUQ6XG4gICAgICAgICAgICAgICAgcG9zdGRhdGEgPSBcIlwiO1xuICAgICAgICAgICAgICAgIHZhciBiRmlyc3RJdGVtID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5wb3N0ZGF0YSkge1xuICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucG9zdGRhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYkZpcnN0SXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgIGJGaXJzdEl0ZW0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICBwb3N0ZGF0YSArPSBcIiZcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwb3N0ZGF0YSArPSBlc2NhcGUoa2V5KSArIFwiPVwiICsgZXNjYXBlKG9wdGlvbnMucG9zdGRhdGFba2V5XSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBjYXNlIEh0dHAuQ29udGVudFR5cGUuSlNPTjpcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudFR5cGUgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgb3B0aW9ucy5oZWFkZXJzW1wiQ29udGVudC1UeXBlXCJdID0gSHR0cC5Db250ZW50VHlwZS5KU09OO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwb3N0ZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMucG9zdGRhdGEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwb3N0ZGF0YSA9IG9wdGlvbnMucG9zdGRhdGE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICgheGhyKSB7XG4gICAgICB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmNhY2hlID09PSBmYWxzZSkge1xuICAgICAgdGltZXN0YW1wID0gcGMudGltZS5ub3coKTtcbiAgICAgIHVyaSA9IG5ldyBwYy5VUkkodXJsKTtcbiAgICAgIGlmICghdXJpLnF1ZXJ5KSB7XG4gICAgICAgIHVyaS5xdWVyeSA9IFwidHM9XCIgKyB0aW1lc3RhbXA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1cmkucXVlcnkgPSB1cmkucXVlcnkgKyBcIiZ0cz1cIiArIHRpbWVzdGFtcDtcbiAgICAgIH1cbiAgICAgIHVybCA9IHVyaS50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5xdWVyeSkge1xuICAgICAgdXJpID0gbmV3IHBjLlVSSSh1cmwpO1xuICAgICAgcXVlcnkgPSBwYy5leHRlbmQodXJpLmdldFF1ZXJ5KCksIG9wdGlvbnMucXVlcnkpO1xuICAgICAgdXJpLnNldFF1ZXJ5KHF1ZXJ5KTtcbiAgICAgIHVybCA9IHVyaS50b1N0cmluZygpO1xuICAgIH1cbiAgICB4aHIub3BlbihtZXRob2QsIHVybCwgb3B0aW9ucy5hc3luYyk7XG4gICAgeGhyLndpdGhDcmVkZW50aWFscyA9IG9wdGlvbnMud2l0aENyZWRlbnRpYWxzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLndpdGhDcmVkZW50aWFscyA6IGZhbHNlO1xuICAgIHhoci5yZXNwb25zZVR5cGUgPSBvcHRpb25zLnJlc3BvbnNlVHlwZSB8fCB0aGlzLl9ndWVzc1Jlc3BvbnNlVHlwZSh1cmwpO1xuICAgIGZvciAodmFyIGhlYWRlciBpbiBvcHRpb25zLmhlYWRlcnMpIHtcbiAgICAgIGlmIChvcHRpb25zLmhlYWRlcnMuaGFzT3duUHJvcGVydHkoaGVhZGVyKSkge1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihoZWFkZXIsIG9wdGlvbnMuaGVhZGVyc1toZWFkZXJdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5fb25SZWFkeVN0YXRlQ2hhbmdlKG1ldGhvZCwgdXJsLCBvcHRpb25zLCB4aHIpO1xuICAgIH0uYmluZCh0aGlzKTtcbiAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5fb25FcnJvcihtZXRob2QsIHVybCwgb3B0aW9ucywgeGhyKTtcbiAgICAgIGVycm9yZWQgPSB0cnVlO1xuICAgIH0uYmluZCh0aGlzKTtcbiAgICB0cnkge1xuICAgICAgeGhyLnNlbmQocG9zdGRhdGEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICghZXJyb3JlZCkge1xuICAgICAgICBvcHRpb25zLmVycm9yKHhoci5zdGF0dXMsIHhociwgZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB4aHI7XG4gIH0sIF9ndWVzc1Jlc3BvbnNlVHlwZTpmdW5jdGlvbih1cmwpIHtcbiAgICB2YXIgdXJpID0gbmV3IHBjLlVSSSh1cmwpO1xuICAgIHZhciBleHQgPSBwYy5wYXRoLmdldEV4dGVuc2lvbih1cmkucGF0aCk7XG4gICAgaWYgKEh0dHAuYmluYXJ5RXh0ZW5zaW9ucy5pbmRleE9mKGV4dCkgPj0gMCkge1xuICAgICAgcmV0dXJuIEh0dHAuUmVzcG9uc2VUeXBlLkFSUkFZX0JVRkZFUjtcbiAgICB9XG4gICAgaWYgKGV4dCA9PT0gXCIueG1sXCIpIHtcbiAgICAgIHJldHVybiBIdHRwLlJlc3BvbnNlVHlwZS5ET0NVTUVOVDtcbiAgICB9XG4gICAgcmV0dXJuIEh0dHAuUmVzcG9uc2VUeXBlLlRFWFQ7XG4gIH0sIF9pc0JpbmFyeUNvbnRlbnRUeXBlOmZ1bmN0aW9uKGNvbnRlbnRUeXBlKSB7XG4gICAgdmFyIGJpblR5cGVzID0gW0h0dHAuQ29udGVudFR5cGUuTVA0LCBIdHRwLkNvbnRlbnRUeXBlLldBViwgSHR0cC5Db250ZW50VHlwZS5PR0csIEh0dHAuQ29udGVudFR5cGUuTVAzLCBIdHRwLkNvbnRlbnRUeXBlLkJJTiwgSHR0cC5Db250ZW50VHlwZS5ERFNdO1xuICAgIGlmIChiaW5UeXBlcy5pbmRleE9mKGNvbnRlbnRUeXBlKSA+PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9LCBfb25SZWFkeVN0YXRlQ2hhbmdlOmZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBvcHRpb25zLCB4aHIpIHtcbiAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHtcbiAgICAgIHN3aXRjaCh4aHIuc3RhdHVzKSB7XG4gICAgICAgIGNhc2UgMDpcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZiAodXJsWzBdICE9IFwiL1wiKSB7XG4gICAgICAgICAgICAgIHRoaXMuX29uU3VjY2VzcyhtZXRob2QsIHVybCwgb3B0aW9ucywgeGhyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgY2FzZSAyMDA6XG4gICAgICAgIGNhc2UgMjAxOlxuICAgICAgICBjYXNlIDIwNjpcbiAgICAgICAgY2FzZSAzMDQ6XG4gICAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fb25TdWNjZXNzKG1ldGhvZCwgdXJsLCBvcHRpb25zLCB4aHIpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX29uRXJyb3IobWV0aG9kLCB1cmwsIG9wdGlvbnMsIHhocik7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfb25TdWNjZXNzOmZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBvcHRpb25zLCB4aHIpIHtcbiAgICB2YXIgcmVzcG9uc2U7XG4gICAgdmFyIGhlYWRlcjtcbiAgICB2YXIgY29udGVudFR5cGU7XG4gICAgdmFyIHBhcmFtZXRlcjtcbiAgICB2YXIgcGFydHM7XG4gICAgaGVhZGVyID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKFwiQ29udGVudC1UeXBlXCIpO1xuICAgIGlmIChoZWFkZXIpIHtcbiAgICAgIHBhcnRzID0gaGVhZGVyLnNwbGl0KFwiO1wiKTtcbiAgICAgIGNvbnRlbnRUeXBlID0gcGFydHNbMF0udHJpbSgpO1xuICAgICAgaWYgKHBhcnRzWzFdKSB7XG4gICAgICAgIHBhcmFtZXRlciA9IHBhcnRzWzFdLnRyaW0oKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNvbnRlbnRUeXBlID09PSB0aGlzLkNvbnRlbnRUeXBlLkpTT04gfHwgdXJsLnNwbGl0KFwiP1wiKVswXS5lbmRzV2l0aChcIi5qc29uXCIpKSB7XG4gICAgICByZXNwb25zZSA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl9pc0JpbmFyeUNvbnRlbnRUeXBlKGNvbnRlbnRUeXBlKSkge1xuICAgICAgICByZXNwb25zZSA9IHhoci5yZXNwb25zZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh4aHIucmVzcG9uc2VUeXBlID09PSBIdHRwLlJlc3BvbnNlVHlwZS5BUlJBWV9CVUZGRVIpIHtcbiAgICAgICAgICBsb2dXQVJOSU5HKHBjLnN0cmluZy5mb3JtYXQoXCJyZXNwb25zZVR5cGU6IHswfSBiZWluZyBzZXJ2ZWQgd2l0aCBDb250ZW50LVR5cGU6IHsxfVwiLCBIdHRwLlJlc3BvbnNlVHlwZS5BUlJBWV9CVUZGRVIsIGNvbnRlbnRUeXBlKSk7XG4gICAgICAgICAgcmVzcG9uc2UgPSB4aHIucmVzcG9uc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09IEh0dHAuUmVzcG9uc2VUeXBlLkRPQ1VNRU5UIHx8IGNvbnRlbnRUeXBlID09PSB0aGlzLkNvbnRlbnRUeXBlLlhNTCkge1xuICAgICAgICAgICAgcmVzcG9uc2UgPSB4aHIucmVzcG9uc2VYTUw7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0geGhyLnJlc3BvbnNlVGV4dDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgb3B0aW9ucy5jYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gIH0sIF9vbkVycm9yOmZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBvcHRpb25zLCB4aHIpIHtcbiAgICBvcHRpb25zLmNhbGxiYWNrKHhoci5zdGF0dXMsIG51bGwpO1xuICB9fTtcbiAgcmV0dXJuIHtIdHRwOkh0dHAsIGh0dHA6bmV3IEh0dHB9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBTY3JpcHRSZWdpc3RyeSA9IGZ1bmN0aW9uKGFwcCkge1xuICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgdGhpcy5fc2NyaXB0cyA9IHt9O1xuICAgIHRoaXMuX2xpc3QgPSBbXTtcbiAgfTtcbiAgU2NyaXB0UmVnaXN0cnkucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uKHNjcmlwdCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBpZiAodGhpcy5fc2NyaXB0cy5oYXNPd25Qcm9wZXJ0eShzY3JpcHQuX19uYW1lKSkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHNjcmlwdC5wcm90b3R5cGUuc3dhcCkge1xuICAgICAgICAgIHZhciBvbGQgPSBzZWxmLl9zY3JpcHRzW3NjcmlwdC5fX25hbWVdO1xuICAgICAgICAgIHZhciBpbmQgPSBzZWxmLl9saXN0LmluZGV4T2Yob2xkKTtcbiAgICAgICAgICBzZWxmLl9saXN0W2luZF0gPSBzY3JpcHQ7XG4gICAgICAgICAgc2VsZi5fc2NyaXB0c1tzY3JpcHQuX19uYW1lXSA9IHNjcmlwdDtcbiAgICAgICAgICBzZWxmLmZpcmUoXCJzd2FwXCIsIHNjcmlwdC5fX25hbWUsIHNjcmlwdCk7XG4gICAgICAgICAgc2VsZi5maXJlKFwic3dhcDpcIiArIHNjcmlwdC5fX25hbWUsIHNjcmlwdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKFwic2NyaXB0IHJlZ2lzdHJ5IGFscmVhZHkgaGFzICdcIiArIHNjcmlwdC5fX25hbWUgKyBcIicgc2NyaXB0LCBkZWZpbmUgJ3N3YXAnIG1ldGhvZCBmb3IgbmV3IHNjcmlwdCB0eXBlIHRvIGVuYWJsZSBjb2RlIGhvdCBzd2FwcGluZ1wiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuX3NjcmlwdHNbc2NyaXB0Ll9fbmFtZV0gPSBzY3JpcHQ7XG4gICAgdGhpcy5fbGlzdC5wdXNoKHNjcmlwdCk7XG4gICAgdGhpcy5maXJlKFwiYWRkXCIsIHNjcmlwdC5fX25hbWUsIHNjcmlwdCk7XG4gICAgdGhpcy5maXJlKFwiYWRkOlwiICsgc2NyaXB0Ll9fbmFtZSwgc2NyaXB0KTtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKCFzZWxmLl9zY3JpcHRzLmhhc093blByb3BlcnR5KHNjcmlwdC5fX25hbWUpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHZhciBjb21wb25lbnRzID0gc2VsZi5hcHAuc3lzdGVtcy5zY3JpcHQuX2NvbXBvbmVudHM7XG4gICAgICB2YXIgaSwgcywgc2NyaXB0SW5zdGFuY2UsIGF0dHJpYnV0ZXM7XG4gICAgICB2YXIgc2NyaXB0SW5zdGFuY2VzID0gW107XG4gICAgICB2YXIgc2NyaXB0SW5zdGFuY2VzSW5pdGlhbGl6ZWQgPSBbXTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGNvbXBvbmVudHMubGVuZ3RoO2krKykge1xuICAgICAgICBpZiAoY29tcG9uZW50c1tpXS5fc2NyaXB0c0luZGV4W3NjcmlwdC5fX25hbWVdICYmIGNvbXBvbmVudHNbaV0uX3NjcmlwdHNJbmRleFtzY3JpcHQuX19uYW1lXS5hd2FpdGluZykge1xuICAgICAgICAgIGlmIChjb21wb25lbnRzW2ldLl9zY3JpcHRzRGF0YSAmJiBjb21wb25lbnRzW2ldLl9zY3JpcHRzRGF0YVtzY3JpcHQuX19uYW1lXSkge1xuICAgICAgICAgICAgYXR0cmlidXRlcyA9IGNvbXBvbmVudHNbaV0uX3NjcmlwdHNEYXRhW3NjcmlwdC5fX25hbWVdLmF0dHJpYnV0ZXM7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNjcmlwdEluc3RhbmNlID0gY29tcG9uZW50c1tpXS5jcmVhdGUoc2NyaXB0Ll9fbmFtZSwge3ByZWxvYWRpbmc6dHJ1ZSwgaW5kOmNvbXBvbmVudHNbaV0uX3NjcmlwdHNJbmRleFtzY3JpcHQuX19uYW1lXS5pbmQsIGF0dHJpYnV0ZXM6YXR0cmlidXRlc30pO1xuICAgICAgICAgIGlmIChzY3JpcHRJbnN0YW5jZSkge1xuICAgICAgICAgICAgc2NyaXB0SW5zdGFuY2VzLnB1c2goc2NyaXB0SW5zdGFuY2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChpID0gMDtpIDwgc2NyaXB0SW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgc2NyaXB0SW5zdGFuY2VzW2ldLl9faW5pdGlhbGl6ZUF0dHJpYnV0ZXMoKTtcbiAgICAgIH1cbiAgICAgIGZvciAoaSA9IDA7aSA8IHNjcmlwdEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmIChzY3JpcHRJbnN0YW5jZXNbaV0uZW5hYmxlZCkge1xuICAgICAgICAgIHNjcmlwdEluc3RhbmNlc1tpXS5faW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICAgIHNjcmlwdEluc3RhbmNlc0luaXRpYWxpemVkLnB1c2goc2NyaXB0SW5zdGFuY2VzW2ldKTtcbiAgICAgICAgICBpZiAoc2NyaXB0SW5zdGFuY2VzW2ldLmluaXRpYWxpemUpIHtcbiAgICAgICAgICAgIHNjcmlwdEluc3RhbmNlc1tpXS5pbml0aWFsaXplKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmb3IgKGkgPSAwO2kgPCBzY3JpcHRJbnN0YW5jZXNJbml0aWFsaXplZC5sZW5ndGg7aSsrKSB7XG4gICAgICAgIHNjcmlwdEluc3RhbmNlc0luaXRpYWxpemVkW2ldLl9wb3N0SW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICBpZiAoc2NyaXB0SW5zdGFuY2VzSW5pdGlhbGl6ZWRbaV0ucG9zdEluaXRpYWxpemUpIHtcbiAgICAgICAgICBzY3JpcHRJbnN0YW5jZXNJbml0aWFsaXplZFtpXS5wb3N0SW5pdGlhbGl6ZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG4gIFNjcmlwdFJlZ2lzdHJ5LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihzY3JpcHQpIHtcbiAgICB2YXIgbmFtZSA9IHNjcmlwdDtcbiAgICBpZiAodHlwZW9mIHNjcmlwdCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBuYW1lID0gc2NyaXB0Ll9fbmFtZTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9zY3JpcHRzLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBpdGVtID0gdGhpcy5fc2NyaXB0c1tuYW1lXTtcbiAgICBkZWxldGUgdGhpcy5fc2NyaXB0c1tuYW1lXTtcbiAgICB2YXIgaW5kID0gdGhpcy5fbGlzdC5pbmRleE9mKGl0ZW0pO1xuICAgIHRoaXMuX2xpc3Quc3BsaWNlKGluZCwgMSk7XG4gICAgdGhpcy5maXJlKFwicmVtb3ZlXCIsIG5hbWUsIGl0ZW0pO1xuICAgIHRoaXMuZmlyZShcInJlbW92ZTpcIiArIG5hbWUsIGl0ZW0pO1xuICAgIHJldHVybiB0cnVlO1xuICB9O1xuICBTY3JpcHRSZWdpc3RyeS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHJldHVybiB0aGlzLl9zY3JpcHRzW25hbWVdIHx8IG51bGw7XG4gIH07XG4gIFNjcmlwdFJlZ2lzdHJ5LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NjcmlwdHMuaGFzT3duUHJvcGVydHkobmFtZSk7XG4gIH07XG4gIFNjcmlwdFJlZ2lzdHJ5LnByb3RvdHlwZS5saXN0ID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xpc3Q7XG4gIH07XG4gIHJldHVybiB7U2NyaXB0UmVnaXN0cnk6U2NyaXB0UmVnaXN0cnl9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciByYXdUb1ZhbHVlID0gZnVuY3Rpb24oYXBwLCBhcmdzLCB2YWx1ZSwgb2xkKSB7XG4gICAgdmFyIGk7XG4gICAgc3dpdGNoKGFyZ3MudHlwZSkge1xuICAgICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICAgICAgcmV0dXJuICEhdmFsdWU7XG4gICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdmFyIHYgPSBwYXJzZUludCh2YWx1ZSwgMTApO1xuICAgICAgICAgICAgaWYgKGlzTmFOKHYpKSB7XG4gICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgICAgIHJldHVybiAwICsgdmFsdWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwianNvblwiOlxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhc3NldFwiOlxuICAgICAgICBpZiAoYXJncy5hcnJheSkge1xuICAgICAgICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgZm9yIChpID0gMDtpIDwgdmFsdWUubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgICBpZiAodmFsdWVbaV0gaW5zdGFuY2VvZiBwYy5Bc3NldCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlW2ldID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcHAuYXNzZXRzLmdldCh2YWx1ZVtpXSkgfHwgbnVsbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWVbaV0gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXBwLmFzc2V0cy5nZXQocGFyc2VJbnQodmFsdWVbaV0sIDEwKSkgfHwgbnVsbCk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChudWxsKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBwYy5Bc3NldCkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgIHJldHVybiBhcHAuYXNzZXRzLmdldCh2YWx1ZSkgfHwgbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXBwLmFzc2V0cy5nZXQocGFyc2VJbnQodmFsdWUsIDEwKSkgfHwgbnVsbDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJlbnRpdHlcIjpcbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgcGMuR3JhcGhOb2RlKSB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBhcHAucm9vdC5maW5kQnlHdWlkKHZhbHVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcInJnYlwiOlxuICAgICAgY2FzZSBcInJnYmFcIjpcbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgcGMuQ29sb3IpIHtcbiAgICAgICAgICBpZiAob2xkIGluc3RhbmNlb2YgcGMuQ29sb3IpIHtcbiAgICAgICAgICAgIG9sZC5jb3B5KHZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybiBvbGQ7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5jbG9uZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSAmJiB2YWx1ZS5sZW5ndGggPj0gMyAmJiB2YWx1ZS5sZW5ndGggPD0gNCkge1xuICAgICAgICAgICAgZm9yIChpID0gMDtpIDwgdmFsdWUubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlW2ldICE9PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghb2xkKSB7XG4gICAgICAgICAgICAgIG9sZCA9IG5ldyBwYy5Db2xvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IDQ7aSsrKSB7XG4gICAgICAgICAgICAgIG9sZC5kYXRhW2ldID0gaSA9PT0gNCAmJiB2YWx1ZS5sZW5ndGggPT09IDMgPyAxIDogdmFsdWVbaV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb2xkO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiICYmIC8jKFswLTlhYmNkZWZdezJ9KXszLDR9L2kudGVzdCh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgaWYgKCFvbGQpIHtcbiAgICAgICAgICAgICAgICBvbGQgPSBuZXcgcGMuQ29sb3I7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgb2xkLmZyb21TdHJpbmcodmFsdWUpO1xuICAgICAgICAgICAgICByZXR1cm4gb2xkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcInZlYzJcIjpcbiAgICAgIGNhc2UgXCJ2ZWMzXCI6XG4gICAgICBjYXNlIFwidmVjNFwiOlxuICAgICAgICB2YXIgbGVuID0gcGFyc2VJbnQoYXJncy50eXBlLnNsaWNlKDMpLCAxMCk7XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHBjW1wiVmVjXCIgKyBsZW5dKSB7XG4gICAgICAgICAgaWYgKG9sZCBpbnN0YW5jZW9mIHBjW1wiVmVjXCIgKyBsZW5dKSB7XG4gICAgICAgICAgICBvbGQuY29weSh2YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gb2xkO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUuY2xvbmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkgJiYgdmFsdWUubGVuZ3RoID09PSBsZW4pIHtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IHZhbHVlLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZVtpXSAhPT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIW9sZCkge1xuICAgICAgICAgICAgICBvbGQgPSBuZXcgcGNbXCJWZWNcIiArIGxlbl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgICAgIG9sZC5kYXRhW2ldID0gdmFsdWVbaV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb2xkO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiY3VydmVcIjpcbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgdmFyIGN1cnZlO1xuICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHBjLkN1cnZlIHx8IHZhbHVlIGluc3RhbmNlb2YgcGMuQ3VydmVTZXQpIHtcbiAgICAgICAgICAgIGN1cnZlID0gdmFsdWUuY2xvbmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIEN1cnZlVHlwZSA9IHZhbHVlLmtleXNbMF0gaW5zdGFuY2VvZiBBcnJheSA/IHBjLkN1cnZlU2V0IDogcGMuQ3VydmU7XG4gICAgICAgICAgICBjdXJ2ZSA9IG5ldyBDdXJ2ZVR5cGUodmFsdWUua2V5cyk7XG4gICAgICAgICAgICBjdXJ2ZS50eXBlID0gdmFsdWUudHlwZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGN1cnZlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH07XG4gIHZhciBTY3JpcHRBdHRyaWJ1dGVzID0gZnVuY3Rpb24oc2NyaXB0VHlwZSkge1xuICAgIHRoaXMuc2NyaXB0VHlwZSA9IHNjcmlwdFR5cGU7XG4gICAgdGhpcy5pbmRleCA9IHt9O1xuICB9O1xuICBTY3JpcHRBdHRyaWJ1dGVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihuYW1lLCBhcmdzKSB7XG4gICAgaWYgKHRoaXMuaW5kZXhbbmFtZV0pIHtcbiAgICAgIGNvbnNvbGUud2FybihcImF0dHJpYnV0ZSAnXCIgKyBuYW1lICsgXCInIGlzIGFscmVhZHkgZGVmaW5lZCBmb3Igc2NyaXB0IHR5cGUgJ1wiICsgdGhpcy5zY3JpcHRUeXBlLm5hbWUgKyBcIidcIik7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwYy5jcmVhdGVTY3JpcHQucmVzZXJ2ZWRBdHRyaWJ1dGVzW25hbWVdKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcImF0dHJpYnV0ZSAnXCIgKyBuYW1lICsgXCInIGlzIGEgcmVzZXJ2ZWQgYXR0cmlidXRlIG5hbWVcIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5pbmRleFtuYW1lXSA9IGFyZ3M7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMuc2NyaXB0VHlwZS5wcm90b3R5cGUsIG5hbWUsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5fX2F0dHJpYnV0ZXNbbmFtZV07XG4gICAgfSwgc2V0OmZ1bmN0aW9uKHJhdykge1xuICAgICAgdmFyIG9sZCA9IHRoaXMuX19hdHRyaWJ1dGVzW25hbWVdO1xuICAgICAgdGhpcy5fX2F0dHJpYnV0ZXNbbmFtZV0gPSByYXdUb1ZhbHVlKHRoaXMuYXBwLCBhcmdzLCByYXcsIG9sZCk7XG4gICAgICB0aGlzLmZpcmUoXCJhdHRyXCIsIG5hbWUsIHRoaXMuX19hdHRyaWJ1dGVzW25hbWVdLCBvbGQpO1xuICAgICAgdGhpcy5maXJlKFwiYXR0cjpcIiArIG5hbWUsIHRoaXMuX19hdHRyaWJ1dGVzW25hbWVdLCBvbGQpO1xuICAgIH19KTtcbiAgfTtcbiAgU2NyaXB0QXR0cmlidXRlcy5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkge1xuICAgIGlmICghdGhpcy5pbmRleFtuYW1lXSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBkZWxldGUgdGhpcy5pbmRleFtuYW1lXTtcbiAgICBkZWxldGUgdGhpcy5zY3JpcHRUeXBlLnByb3RvdHlwZVtuYW1lXTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfTtcbiAgU2NyaXB0QXR0cmlidXRlcy5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHJldHVybiAhIXRoaXMuaW5kZXhbbmFtZV07XG4gIH07XG4gIFNjcmlwdEF0dHJpYnV0ZXMucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5pbmRleFtuYW1lXSB8fCBudWxsO1xuICB9O1xuICB2YXIgY3JlYXRlU2NyaXB0ID0gZnVuY3Rpb24obmFtZSwgYXBwKSB7XG4gICAgaWYgKHBjLnNjcmlwdC5sZWdhY3kpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJUaGlzIHByb2plY3QgaXMgdXNpbmcgdGhlIGxlZ2FjeSBzY3JpcHQgc3lzdGVtLiBZb3UgY2Fubm90IGNhbGwgcGMuY3JlYXRlU2NyaXB0KCkuIFNlZTogaHR0cDovL2RldmVsb3Blci5wbGF5Y2FudmFzLmNvbS9lbi91c2VyLW1hbnVhbC9zY3JpcHRpbmcvbGVnYWN5L1wiKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBpZiAoY3JlYXRlU2NyaXB0LnJlc2VydmVkU2NyaXB0c1tuYW1lXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwic2NyaXB0IG5hbWU6ICdcIiArIG5hbWUgKyBcIicgaXMgcmVzZXJ2ZWQsIHBsZWFzZSBjaGFuZ2Ugc2NyaXB0IG5hbWVcIik7XG4gICAgfVxuICAgIHZhciBzY3JpcHQgPSBmdW5jdGlvbihhcmdzKSB7XG4gICAgICBpZiAoIWFyZ3MgfHwgIWFyZ3MuYXBwIHx8ICFhcmdzLmVudGl0eSkge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJzY3JpcHQgJ1wiICsgbmFtZSArIFwiJyBoYXMgbWlzc2luZyBhcmd1bWVudHMgaW4gY29uc3J1Y3RvclwiKTtcbiAgICAgIH1cbiAgICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgICB0aGlzLmFwcCA9IGFyZ3MuYXBwO1xuICAgICAgdGhpcy5lbnRpdHkgPSBhcmdzLmVudGl0eTtcbiAgICAgIHRoaXMuX2VuYWJsZWQgPSB0eXBlb2YgYXJncy5lbmFibGVkID09PSBcImJvb2xlYW5cIiA/IGFyZ3MuZW5hYmxlZCA6IHRydWU7XG4gICAgICB0aGlzLl9lbmFibGVkT2xkID0gdGhpcy5lbmFibGVkO1xuICAgICAgdGhpcy5fX2F0dHJpYnV0ZXMgPSB7fTtcbiAgICAgIHRoaXMuX19hdHRyaWJ1dGVzUmF3ID0gYXJncy5hdHRyaWJ1dGVzIHx8IG51bGw7XG4gICAgICB0aGlzLl9fc2NyaXB0VHlwZSA9IHNjcmlwdDtcbiAgICB9O1xuICAgIHNjcmlwdC5fX25hbWUgPSBuYW1lO1xuICAgIHNjcmlwdC5hdHRyaWJ1dGVzID0gbmV3IFNjcmlwdEF0dHJpYnV0ZXMoc2NyaXB0KTtcbiAgICBzY3JpcHQucHJvdG90eXBlLl9faW5pdGlhbGl6ZUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihmb3JjZSkge1xuICAgICAgaWYgKCFmb3JjZSAmJiAhdGhpcy5fX2F0dHJpYnV0ZXNSYXcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZm9yICh2YXIga2V5IGluIHNjcmlwdC5hdHRyaWJ1dGVzLmluZGV4KSB7XG4gICAgICAgIGlmICh0aGlzLl9fYXR0cmlidXRlc1JhdyAmJiB0aGlzLl9fYXR0cmlidXRlc1Jhdy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgdGhpc1trZXldID0gdGhpcy5fX2F0dHJpYnV0ZXNSYXdba2V5XTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX19hdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgIGlmIChzY3JpcHQuYXR0cmlidXRlcy5pbmRleFtrZXldLmhhc093blByb3BlcnR5KFwiZGVmYXVsdFwiKSkge1xuICAgICAgICAgICAgICB0aGlzW2tleV0gPSBzY3JpcHQuYXR0cmlidXRlcy5pbmRleFtrZXldW1wiZGVmYXVsdFwiXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXNba2V5XSA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLl9fYXR0cmlidXRlc1JhdyA9IG51bGw7XG4gICAgfTtcbiAgICBzY3JpcHQuZXh0ZW5kID0gZnVuY3Rpb24obWV0aG9kcykge1xuICAgICAgZm9yICh2YXIga2V5IGluIG1ldGhvZHMpIHtcbiAgICAgICAgaWYgKCFtZXRob2RzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBzY3JpcHQucHJvdG90eXBlW2tleV0gPSBtZXRob2RzW2tleV07XG4gICAgICB9XG4gICAgfTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2NyaXB0LnByb3RvdHlwZSwgXCJlbmFibGVkXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5zY3JpcHQuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgdmFsdWUgPSAhIXZhbHVlO1xuICAgICAgaWYgKHRoaXMuX2VuYWJsZWQgIT09IHZhbHVlKSB7XG4gICAgICAgIHRoaXMuX2VuYWJsZWQgPSB2YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmVuYWJsZWQgIT09IHRoaXMuX2VuYWJsZWRPbGQpIHtcbiAgICAgICAgdGhpcy5fZW5hYmxlZE9sZCA9IHRoaXMuZW5hYmxlZDtcbiAgICAgICAgdGhpcy5maXJlKHRoaXMuZW5hYmxlZCA/IFwiZW5hYmxlXCIgOiBcImRpc2FibGVcIik7XG4gICAgICAgIHRoaXMuZmlyZShcInN0YXRlXCIsIHRoaXMuZW5hYmxlZCk7XG4gICAgICB9XG4gICAgfX0pO1xuICAgIHZhciByZWdpc3RyeSA9IGFwcCA/IGFwcC5zY3JpcHRzIDogcGMuQXBwbGljYXRpb24uZ2V0QXBwbGljYXRpb24oKS5zY3JpcHRzO1xuICAgIHJlZ2lzdHJ5LmFkZChzY3JpcHQpO1xuICAgIHBjLlNjcmlwdEhhbmRsZXIuX3B1c2goc2NyaXB0KTtcbiAgICByZXR1cm4gc2NyaXB0O1xuICB9O1xuICBjcmVhdGVTY3JpcHQucmVzZXJ2ZWRTY3JpcHRzID0gW1wic3lzdGVtXCIsIFwiZW50aXR5XCIsIFwiY3JlYXRlXCIsIFwiZGVzdHJveVwiLCBcInN3YXBcIiwgXCJtb3ZlXCIsIFwic2NyaXB0c1wiLCBcIl9zY3JpcHRzXCIsIFwiX3NjcmlwdHNJbmRleFwiLCBcIl9zY3JpcHRzRGF0YVwiLCBcImVuYWJsZWRcIiwgXCJfb2xkU3RhdGVcIiwgXCJvbkVuYWJsZVwiLCBcIm9uRGlzYWJsZVwiLCBcIm9uUG9zdFN0YXRlQ2hhbmdlXCIsIFwiX29uU2V0RW5hYmxlZFwiLCBcIl9jaGVja1N0YXRlXCIsIFwiX29uQmVmb3JlUmVtb3ZlXCIsIFwiX29uSW5pdGlhbGl6ZUF0dHJpYnV0ZXNcIiwgXCJfb25Jbml0aWFsaXplXCIsIFwiX29uUG9zdEluaXRpYWxpemVcIiwgXCJfb25VcGRhdGVcIiwgXCJfb25Qb3N0VXBkYXRlXCIsIFwiX2NhbGxiYWNrc1wiLCBcImhhc1wiLCBcIm9uXCIsIFwib2ZmXCIsIFwiZmlyZVwiLCBcIm9uY2VcIiwgXCJoYXNFdmVudFwiXTtcbiAgdmFyIHJlc2VydmVkU2NyaXB0cyA9IHt9O1xuICB2YXIgaTtcbiAgZm9yIChpID0gMDtpIDwgY3JlYXRlU2NyaXB0LnJlc2VydmVkU2NyaXB0cy5sZW5ndGg7aSsrKSB7XG4gICAgcmVzZXJ2ZWRTY3JpcHRzW2NyZWF0ZVNjcmlwdC5yZXNlcnZlZFNjcmlwdHNbaV1dID0gMTtcbiAgfVxuICBjcmVhdGVTY3JpcHQucmVzZXJ2ZWRTY3JpcHRzID0gcmVzZXJ2ZWRTY3JpcHRzO1xuICBjcmVhdGVTY3JpcHQucmVzZXJ2ZWRBdHRyaWJ1dGVzID0gW1wiYXBwXCIsIFwiZW50aXR5XCIsIFwiZW5hYmxlZFwiLCBcIl9lbmFibGVkXCIsIFwiX2VuYWJsZWRPbGRcIiwgXCJfX2F0dHJpYnV0ZXNcIiwgXCJfX2F0dHJpYnV0ZXNSYXdcIiwgXCJfX3NjcmlwdFR5cGVcIiwgXCJfY2FsbGJhY2tzXCIsIFwiaGFzXCIsIFwib25cIiwgXCJvZmZcIiwgXCJmaXJlXCIsIFwib25jZVwiLCBcImhhc0V2ZW50XCJdO1xuICB2YXIgcmVzZXJ2ZWRBdHRyaWJ1dGVzID0ge307XG4gIGZvciAoaSA9IDA7aSA8IGNyZWF0ZVNjcmlwdC5yZXNlcnZlZEF0dHJpYnV0ZXMubGVuZ3RoO2krKykge1xuICAgIHJlc2VydmVkQXR0cmlidXRlc1tjcmVhdGVTY3JpcHQucmVzZXJ2ZWRBdHRyaWJ1dGVzW2ldXSA9IDE7XG4gIH1cbiAgY3JlYXRlU2NyaXB0LnJlc2VydmVkQXR0cmlidXRlcyA9IHJlc2VydmVkQXR0cmlidXRlcztcbiAgcmV0dXJuIHtjcmVhdGVTY3JpcHQ6Y3JlYXRlU2NyaXB0fTtcbn0oKSk7XG5wYy5zY3JpcHQgPSBmdW5jdGlvbigpIHtcbiAgdmFyIF9tYWluID0gbnVsbDtcbiAgdmFyIF9sb2FkZXIgPSBudWxsO1xuICB2YXIgX2xlZ2FjeSA9IGZhbHNlO1xuICB2YXIgX2NyZWF0ZWRMb2FkaW5nU2NyZWVuID0gZmFsc2U7XG4gIHZhciBzY3JpcHQgPSB7YXBwOm51bGwsIGNyZWF0ZTpmdW5jdGlvbihuYW1lLCBjYWxsYmFjaykge1xuICAgIGlmICghX2xlZ2FjeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgU2NyaXB0VHlwZSA9IGNhbGxiYWNrKHBjLnNjcmlwdC5hcHApO1xuICAgIFNjcmlwdFR5cGUuX3BjU2NyaXB0TmFtZSA9IG5hbWU7XG4gICAgcGMuU2NyaXB0SGFuZGxlci5fcHVzaChTY3JpcHRUeXBlKTtcbiAgICB0aGlzLmZpcmUoXCJjcmVhdGVkXCIsIG5hbWUsIGNhbGxiYWNrKTtcbiAgfSwgYXR0cmlidXRlOmZ1bmN0aW9uKG5hbWUsIHR5cGUsIGRlZmF1bHRWYWx1ZSwgb3B0aW9ucykge1xuICB9LCBjcmVhdGVMb2FkaW5nU2NyZWVuOmZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgaWYgKF9jcmVhdGVkTG9hZGluZ1NjcmVlbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBfY3JlYXRlZExvYWRpbmdTY3JlZW4gPSB0cnVlO1xuICAgIHZhciBhcHAgPSBwYy5BcHBsaWNhdGlvbi5nZXRBcHBsaWNhdGlvbigpO1xuICAgIGNhbGxiYWNrKGFwcCk7XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2NyaXB0LCBcImxlZ2FjeVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBfbGVnYWN5O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBfbGVnYWN5ID0gdmFsdWU7XG4gIH19KTtcbiAgcGMuZXZlbnRzLmF0dGFjaChzY3JpcHQpO1xuICByZXR1cm4gc2NyaXB0O1xufSgpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEFwcGxpY2F0aW9uID0gZnVuY3Rpb24oY2FudmFzLCBvcHRpb25zKSB7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgcGMubG9nLm9wZW4oKTtcbiAgICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xuICAgIEFwcGxpY2F0aW9uLl9hcHBsaWNhdGlvbnNbY2FudmFzLmlkXSA9IHRoaXM7XG4gICAgQXBwbGljYXRpb24uX2N1cnJlbnRBcHBsaWNhdGlvbiA9IHRoaXM7XG4gICAgdGhpcy5fdGltZSA9IDA7XG4gICAgdGhpcy50aW1lU2NhbGUgPSAxO1xuICAgIHRoaXMuYXV0b1JlbmRlciA9IHRydWU7XG4gICAgdGhpcy5yZW5kZXJOZXh0RnJhbWUgPSBmYWxzZTtcbiAgICB0aGlzLl9saWJyYXJpZXNMb2FkZWQgPSBmYWxzZTtcbiAgICB0aGlzLl9maWxsTW9kZSA9IHBjLkZJTExNT0RFX0tFRVBfQVNQRUNUO1xuICAgIHRoaXMuX3Jlc29sdXRpb25Nb2RlID0gcGMuUkVTT0xVVElPTl9GSVhFRDtcbiAgICB0aGlzLl9hbGxvd1Jlc2l6ZSA9IHRydWU7XG4gICAgdGhpcy5jb250ZXh0ID0gdGhpcztcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlID0gbmV3IHBjLkdyYXBoaWNzRGV2aWNlKGNhbnZhcywgb3B0aW9ucy5ncmFwaGljc0RldmljZU9wdGlvbnMpO1xuICAgIHRoaXMuc3RhdHMgPSBuZXcgcGMuQXBwbGljYXRpb25TdGF0cyh0aGlzLmdyYXBoaWNzRGV2aWNlKTtcbiAgICB0aGlzLnN5c3RlbXMgPSBuZXcgcGMuQ29tcG9uZW50U3lzdGVtUmVnaXN0cnk7XG4gICAgdGhpcy5fYXVkaW9NYW5hZ2VyID0gbmV3IHBjLlNvdW5kTWFuYWdlcihvcHRpb25zKTtcbiAgICB0aGlzLmxvYWRlciA9IG5ldyBwYy5SZXNvdXJjZUxvYWRlcjtcbiAgICB0aGlzLnNjZW5lID0gbmV3IHBjLlNjZW5lO1xuICAgIHRoaXMucm9vdCA9IG5ldyBwYy5FbnRpdHkodGhpcyk7XG4gICAgdGhpcy5yb290Ll9lbmFibGVkSW5IaWVyYXJjaHkgPSB0cnVlO1xuICAgIHRoaXMuX2VuYWJsZUxpc3QgPSBbXTtcbiAgICB0aGlzLl9lbmFibGVMaXN0LnNpemUgPSAwO1xuICAgIHRoaXMuYXNzZXRzID0gbmV3IHBjLkFzc2V0UmVnaXN0cnkodGhpcy5sb2FkZXIpO1xuICAgIGlmIChvcHRpb25zLmFzc2V0UHJlZml4KSB7XG4gICAgICB0aGlzLmFzc2V0cy5wcmVmaXggPSBvcHRpb25zLmFzc2V0UHJlZml4O1xuICAgIH1cbiAgICB0aGlzLnNjcmlwdHNPcmRlciA9IG9wdGlvbnMuc2NyaXB0c09yZGVyIHx8IFtdO1xuICAgIHRoaXMuc2NyaXB0cyA9IG5ldyBwYy5TY3JpcHRSZWdpc3RyeSh0aGlzKTtcbiAgICB0aGlzLnJlbmRlcmVyID0gbmV3IHBjLkZvcndhcmRSZW5kZXJlcih0aGlzLmdyYXBoaWNzRGV2aWNlKTtcbiAgICB0aGlzLmxpZ2h0bWFwcGVyID0gbmV3IHBjLkxpZ2h0bWFwcGVyKHRoaXMuZ3JhcGhpY3NEZXZpY2UsIHRoaXMucm9vdCwgdGhpcy5zY2VuZSwgdGhpcy5yZW5kZXJlciwgdGhpcy5hc3NldHMpO1xuICAgIHRoaXMub25jZShcInByZXJlbmRlclwiLCB0aGlzLl9maXJzdEJha2UsIHRoaXMpO1xuICAgIHRoaXMuYmF0Y2hlciA9IG5ldyBwYy5CYXRjaE1hbmFnZXIodGhpcy5ncmFwaGljc0RldmljZSwgdGhpcy5yb290LCB0aGlzLnNjZW5lKTtcbiAgICB0aGlzLm9uY2UoXCJwcmVyZW5kZXJcIiwgdGhpcy5fZmlyc3RCYXRjaCwgdGhpcyk7XG4gICAgdGhpcy5rZXlib2FyZCA9IG9wdGlvbnMua2V5Ym9hcmQgfHwgbnVsbDtcbiAgICB0aGlzLm1vdXNlID0gb3B0aW9ucy5tb3VzZSB8fCBudWxsO1xuICAgIHRoaXMudG91Y2ggPSBvcHRpb25zLnRvdWNoIHx8IG51bGw7XG4gICAgdGhpcy5nYW1lcGFkcyA9IG9wdGlvbnMuZ2FtZXBhZHMgfHwgbnVsbDtcbiAgICB0aGlzLmVsZW1lbnRJbnB1dCA9IG9wdGlvbnMuZWxlbWVudElucHV0IHx8IG51bGw7XG4gICAgaWYgKHRoaXMuZWxlbWVudElucHV0KSB7XG4gICAgICB0aGlzLmVsZW1lbnRJbnB1dC5hcHAgPSB0aGlzO1xuICAgIH1cbiAgICB0aGlzLnZyID0gbnVsbDtcbiAgICBpZiAob3B0aW9ucy52cikge1xuICAgICAgdGhpcy5fb25WckNoYW5nZShvcHRpb25zLnZyKTtcbiAgICB9XG4gICAgdGhpcy5faW5Ub29scyA9IGZhbHNlO1xuICAgIHRoaXMuX3NreWJveExhc3QgPSAwO1xuICAgIHRoaXMuX3NjcmlwdFByZWZpeCA9IG9wdGlvbnMuc2NyaXB0UHJlZml4IHx8IFwiXCI7XG4gICAgdGhpcy5sb2FkZXIuYWRkSGFuZGxlcihcImFuaW1hdGlvblwiLCBuZXcgcGMuQW5pbWF0aW9uSGFuZGxlcik7XG4gICAgdGhpcy5sb2FkZXIuYWRkSGFuZGxlcihcIm1vZGVsXCIsIG5ldyBwYy5Nb2RlbEhhbmRsZXIodGhpcy5ncmFwaGljc0RldmljZSkpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJtYXRlcmlhbFwiLCBuZXcgcGMuTWF0ZXJpYWxIYW5kbGVyKHRoaXMpKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwidGV4dHVyZVwiLCBuZXcgcGMuVGV4dHVyZUhhbmRsZXIodGhpcy5ncmFwaGljc0RldmljZSwgdGhpcy5hc3NldHMsIHRoaXMubG9hZGVyKSk7XG4gICAgdGhpcy5sb2FkZXIuYWRkSGFuZGxlcihcInRleHRcIiwgbmV3IHBjLlRleHRIYW5kbGVyKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwianNvblwiLCBuZXcgcGMuSnNvbkhhbmRsZXIpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJhdWRpb1wiLCBuZXcgcGMuQXVkaW9IYW5kbGVyKHRoaXMuX2F1ZGlvTWFuYWdlcikpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJzY3JpcHRcIiwgbmV3IHBjLlNjcmlwdEhhbmRsZXIodGhpcykpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJzY2VuZVwiLCBuZXcgcGMuU2NlbmVIYW5kbGVyKHRoaXMpKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwiY3ViZW1hcFwiLCBuZXcgcGMuQ3ViZW1hcEhhbmRsZXIodGhpcy5ncmFwaGljc0RldmljZSwgdGhpcy5hc3NldHMsIHRoaXMubG9hZGVyKSk7XG4gICAgdGhpcy5sb2FkZXIuYWRkSGFuZGxlcihcImh0bWxcIiwgbmV3IHBjLkh0bWxIYW5kbGVyKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwiY3NzXCIsIG5ldyBwYy5Dc3NIYW5kbGVyKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwic2hhZGVyXCIsIG5ldyBwYy5TaGFkZXJIYW5kbGVyKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwiaGllcmFyY2h5XCIsIG5ldyBwYy5IaWVyYXJjaHlIYW5kbGVyKHRoaXMpKTtcbiAgICB0aGlzLmxvYWRlci5hZGRIYW5kbGVyKFwic2NlbmVzZXR0aW5nc1wiLCBuZXcgcGMuU2NlbmVTZXR0aW5nc0hhbmRsZXIodGhpcykpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJmb2xkZXJcIiwgbmV3IHBjLkZvbGRlckhhbmRsZXIpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJmb250XCIsIG5ldyBwYy5Gb250SGFuZGxlcih0aGlzLmxvYWRlcikpO1xuICAgIHRoaXMubG9hZGVyLmFkZEhhbmRsZXIoXCJiaW5hcnlcIiwgbmV3IHBjLkJpbmFyeUhhbmRsZXIpO1xuICAgIHZhciByaWdpZGJvZHlzeXMgPSBuZXcgcGMuUmlnaWRCb2R5Q29tcG9uZW50U3lzdGVtKHRoaXMpO1xuICAgIHZhciBjb2xsaXNpb25zeXMgPSBuZXcgcGMuQ29sbGlzaW9uQ29tcG9uZW50U3lzdGVtKHRoaXMpO1xuICAgIHZhciBhbmltYXRpb25zeXMgPSBuZXcgcGMuQW5pbWF0aW9uQ29tcG9uZW50U3lzdGVtKHRoaXMpO1xuICAgIHZhciBtb2RlbHN5cyA9IG5ldyBwYy5Nb2RlbENvbXBvbmVudFN5c3RlbSh0aGlzKTtcbiAgICB2YXIgY2FtZXJhc3lzID0gbmV3IHBjLkNhbWVyYUNvbXBvbmVudFN5c3RlbSh0aGlzKTtcbiAgICB2YXIgbGlnaHRzeXMgPSBuZXcgcGMuTGlnaHRDb21wb25lbnRTeXN0ZW0odGhpcyk7XG4gICAgaWYgKHBjLnNjcmlwdC5sZWdhY3kpIHtcbiAgICAgIG5ldyBwYy5TY3JpcHRMZWdhY3lDb21wb25lbnRTeXN0ZW0odGhpcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5ldyBwYy5TY3JpcHRDb21wb25lbnRTeXN0ZW0odGhpcyk7XG4gICAgfVxuICAgIHZhciBhdWRpb3NvdXJjZXN5cyA9IG5ldyBwYy5BdWRpb1NvdXJjZUNvbXBvbmVudFN5c3RlbSh0aGlzLCB0aGlzLl9hdWRpb01hbmFnZXIpO1xuICAgIHZhciBzb3VuZHN5cyA9IG5ldyBwYy5Tb3VuZENvbXBvbmVudFN5c3RlbSh0aGlzLCB0aGlzLl9hdWRpb01hbmFnZXIpO1xuICAgIHZhciBhdWRpb2xpc3RlbmVyc3lzID0gbmV3IHBjLkF1ZGlvTGlzdGVuZXJDb21wb25lbnRTeXN0ZW0odGhpcywgdGhpcy5fYXVkaW9NYW5hZ2VyKTtcbiAgICB2YXIgcGFydGljbGVzeXN0ZW1zeXMgPSBuZXcgcGMuUGFydGljbGVTeXN0ZW1Db21wb25lbnRTeXN0ZW0odGhpcyk7XG4gICAgdmFyIHNjcmVlbnN5cyA9IG5ldyBwYy5TY3JlZW5Db21wb25lbnRTeXN0ZW0odGhpcyk7XG4gICAgdmFyIGVsZW1lbnRzeXMgPSBuZXcgcGMuRWxlbWVudENvbXBvbmVudFN5c3RlbSh0aGlzKTtcbiAgICB2YXIgem9uZXN5cyA9IG5ldyBwYy5ab25lQ29tcG9uZW50U3lzdGVtKHRoaXMpO1xuICAgIHRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VIYW5kbGVyID0gdGhpcy5vblZpc2liaWxpdHlDaGFuZ2UuYmluZCh0aGlzKTtcbiAgICBpZiAoZG9jdW1lbnQuaGlkZGVuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2hpZGRlbkF0dHIgPSBcImhpZGRlblwiO1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcInZpc2liaWxpdHljaGFuZ2VcIiwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZUhhbmRsZXIsIGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGRvY3VtZW50Lm1vekhpZGRlbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuX2hpZGRlbkF0dHIgPSBcIm1vekhpZGRlblwiO1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwibW96dmlzaWJpbGl0eWNoYW5nZVwiLCB0aGlzLl92aXNpYmlsaXR5Q2hhbmdlSGFuZGxlciwgZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGRvY3VtZW50Lm1zSGlkZGVuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aGlzLl9oaWRkZW5BdHRyID0gXCJtc0hpZGRlblwiO1xuICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtc3Zpc2liaWxpdHljaGFuZ2VcIiwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZUhhbmRsZXIsIGZhbHNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoZG9jdW1lbnQud2Via2l0SGlkZGVuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2hpZGRlbkF0dHIgPSBcIndlYmtpdEhpZGRlblwiO1xuICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIndlYmtpdHZpc2liaWxpdHljaGFuZ2VcIiwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZUhhbmRsZXIsIGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50aWNrID0gbWFrZVRpY2sodGhpcyk7XG4gIH07XG4gIEFwcGxpY2F0aW9uLl9jdXJyZW50QXBwbGljYXRpb24gPSBudWxsO1xuICBBcHBsaWNhdGlvbi5fYXBwbGljYXRpb25zID0ge307XG4gIEFwcGxpY2F0aW9uLmdldEFwcGxpY2F0aW9uID0gZnVuY3Rpb24oaWQpIHtcbiAgICBpZiAoaWQpIHtcbiAgICAgIHJldHVybiBBcHBsaWNhdGlvbi5fYXBwbGljYXRpb25zW2lkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIEFwcGxpY2F0aW9uLl9jdXJyZW50QXBwbGljYXRpb247XG4gICAgfVxuICB9O1xuICB2YXIgUHJvZ3Jlc3MgPSBmdW5jdGlvbihsZW5ndGgpIHtcbiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDtcbiAgICB0aGlzLmNvdW50ID0gMDtcbiAgICB0aGlzLmluYyA9IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5jb3VudCsrO1xuICAgIH07XG4gICAgdGhpcy5kb25lID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb3VudCA9PT0gdGhpcy5sZW5ndGg7XG4gICAgfTtcbiAgfTtcbiAgQXBwbGljYXRpb24ucHJvdG90eXBlID0ge2NvbmZpZ3VyZTpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHBjLmh0dHAuZ2V0KHVybCwgZnVuY3Rpb24oZXJyLCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB2YXIgcHJvcHMgPSByZXNwb25zZS5hcHBsaWNhdGlvbl9wcm9wZXJ0aWVzO1xuICAgICAgdmFyIGFzc2V0cyA9IHJlc3BvbnNlLmFzc2V0cztcbiAgICAgIHZhciBzY3JpcHRzID0gcmVzcG9uc2Uuc2NyaXB0cztcbiAgICAgIHZhciBwcmlvcml0eVNjcmlwdHMgPSByZXNwb25zZS5wcmlvcml0eV9zY3JpcHRzO1xuICAgICAgc2VsZi5fcGFyc2VBcHBsaWNhdGlvblByb3BlcnRpZXMocHJvcHMsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICBzZWxmLl9vblZyQ2hhbmdlKHByb3BzLnZyKTtcbiAgICAgICAgc2VsZi5fcGFyc2VBc3NldHMoYXNzZXRzKTtcbiAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSwgcHJlbG9hZDpmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBzZWxmLmZpcmUoXCJwcmVsb2FkOnN0YXJ0XCIpO1xuICAgIHZhciBhc3NldHMgPSB0aGlzLmFzc2V0cy5saXN0KHtwcmVsb2FkOnRydWV9KTtcbiAgICB2YXIgX2Fzc2V0cyA9IG5ldyBQcm9ncmVzcyhhc3NldHMubGVuZ3RoKTtcbiAgICB2YXIgX2RvbmUgPSBmYWxzZTtcbiAgICB2YXIgZG9uZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKCFzZWxmLmdyYXBoaWNzRGV2aWNlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICghX2RvbmUgJiYgX2Fzc2V0cy5kb25lKCkpIHtcbiAgICAgICAgX2RvbmUgPSB0cnVlO1xuICAgICAgICBzZWxmLmZpcmUoXCJwcmVsb2FkOmVuZFwiKTtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHZhciB0b3RhbCA9IGFzc2V0cy5sZW5ndGg7XG4gICAgdmFyIGNvdW50ID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gX2Fzc2V0cy5jb3VudDtcbiAgICB9O1xuICAgIHZhciBpO1xuICAgIGlmIChfYXNzZXRzLmxlbmd0aCkge1xuICAgICAgdmFyIG9uQXNzZXRMb2FkID0gZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgX2Fzc2V0cy5pbmMoKTtcbiAgICAgICAgc2VsZi5maXJlKFwicHJlbG9hZDpwcm9ncmVzc1wiLCBjb3VudCgpIC8gdG90YWwpO1xuICAgICAgICBpZiAoX2Fzc2V0cy5kb25lKCkpIHtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB2YXIgb25Bc3NldEVycm9yID0gZnVuY3Rpb24oZXJyLCBhc3NldCkge1xuICAgICAgICBfYXNzZXRzLmluYygpO1xuICAgICAgICBzZWxmLmZpcmUoXCJwcmVsb2FkOnByb2dyZXNzXCIsIGNvdW50KCkgLyB0b3RhbCk7XG4gICAgICAgIGlmIChfYXNzZXRzLmRvbmUoKSkge1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGFzc2V0cy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmICghYXNzZXRzW2ldLmxvYWRlZCkge1xuICAgICAgICAgIGFzc2V0c1tpXS5vbmNlKFwibG9hZFwiLCBvbkFzc2V0TG9hZCk7XG4gICAgICAgICAgYXNzZXRzW2ldLm9uY2UoXCJlcnJvclwiLCBvbkFzc2V0RXJyb3IpO1xuICAgICAgICAgIHRoaXMuYXNzZXRzLmxvYWQoYXNzZXRzW2ldKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBfYXNzZXRzLmluYygpO1xuICAgICAgICAgIHNlbGYuZmlyZShcInByZWxvYWQ6cHJvZ3Jlc3NcIiwgY291bnQoKSAvIHRvdGFsKTtcbiAgICAgICAgICBpZiAoX2Fzc2V0cy5kb25lKCkpIHtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZG9uZSgpO1xuICAgIH1cbiAgfSwgbG9hZFNjZW5lSGllcmFyY2h5OmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGhhbmRsZXIgPSB0aGlzLmxvYWRlci5nZXRIYW5kbGVyKFwiaGllcmFyY2h5XCIpO1xuICAgIGlmICh0aGlzLmFzc2V0cyAmJiB0aGlzLmFzc2V0cy5wcmVmaXggJiYgIXBjLkFCU09MVVRFX1VSTC50ZXN0KHVybCkpIHtcbiAgICAgIHVybCA9IHBjLnBhdGguam9pbih0aGlzLmFzc2V0cy5wcmVmaXgsIHVybCk7XG4gICAgfVxuICAgIGhhbmRsZXIubG9hZCh1cmwsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHZhciBfbG9hZGVkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBlbnRpdHkgPSBoYW5kbGVyLm9wZW4odXJsLCBkYXRhKTtcbiAgICAgICAgc2VsZi5sb2FkZXIuY2xlYXJDYWNoZSh1cmwsIFwiaGllcmFyY2h5XCIpO1xuICAgICAgICBzZWxmLnJvb3QuYWRkQ2hpbGQoZW50aXR5KTtcbiAgICAgICAgcGMuQ29tcG9uZW50U3lzdGVtLmluaXRpYWxpemUoZW50aXR5KTtcbiAgICAgICAgcGMuQ29tcG9uZW50U3lzdGVtLnBvc3RJbml0aWFsaXplKGVudGl0eSk7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGNhbGxiYWNrKGVyciwgZW50aXR5KTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHNlbGYuX3ByZWxvYWRTY3JpcHRzKGRhdGEsIF9sb2FkZWQpO1xuICAgIH0pO1xuICB9LCBsb2FkU2NlbmVTZXR0aW5nczpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHRoaXMuYXNzZXRzICYmIHRoaXMuYXNzZXRzLnByZWZpeCAmJiAhcGMuQUJTT0xVVEVfVVJMLnRlc3QodXJsKSkge1xuICAgICAgdXJsID0gcGMucGF0aC5qb2luKHRoaXMuYXNzZXRzLnByZWZpeCwgdXJsKTtcbiAgICB9XG4gICAgdGhpcy5sb2FkZXIubG9hZCh1cmwsIFwic2NlbmVzZXR0aW5nc1wiLCBmdW5jdGlvbihlcnIsIHNldHRpbmdzKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICB0aGlzLmFwcGx5U2NlbmVTZXR0aW5ncyhzZXR0aW5ncyk7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgfSwgbG9hZFNjZW5lOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGhhbmRsZXIgPSB0aGlzLmxvYWRlci5nZXRIYW5kbGVyKFwic2NlbmVcIik7XG4gICAgaWYgKHRoaXMuYXNzZXRzICYmIHRoaXMuYXNzZXRzLnByZWZpeCAmJiAhcGMuQUJTT0xVVEVfVVJMLnRlc3QodXJsKSkge1xuICAgICAgdXJsID0gcGMucGF0aC5qb2luKHRoaXMuYXNzZXRzLnByZWZpeCwgdXJsKTtcbiAgICB9XG4gICAgaGFuZGxlci5sb2FkKHVybCwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICB2YXIgX2xvYWRlZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHZhciBzY2VuZSA9IGhhbmRsZXIub3Blbih1cmwsIGRhdGEpO1xuICAgICAgICAgIHNlbGYubG9hZGVyLmNsZWFyQ2FjaGUodXJsLCBcInNjZW5lXCIpO1xuICAgICAgICAgIHNlbGYubG9hZGVyLnBhdGNoKHtyZXNvdXJjZTpzY2VuZSwgdHlwZTpcInNjZW5lXCJ9LCBzZWxmLmFzc2V0cyk7XG4gICAgICAgICAgc2VsZi5yb290LmFkZENoaWxkKHNjZW5lLnJvb3QpO1xuICAgICAgICAgIGlmIChzZWxmLnN5c3RlbXMucmlnaWRib2R5ICYmIHR5cGVvZiBBbW1vICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICBzZWxmLnN5c3RlbXMucmlnaWRib2R5LnNldEdyYXZpdHkoc2NlbmUuX2dyYXZpdHkueCwgc2NlbmUuX2dyYXZpdHkueSwgc2NlbmUuX2dyYXZpdHkueik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgc2NlbmUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fcHJlbG9hZFNjcmlwdHMoZGF0YSwgX2xvYWRlZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgfSwgX3ByZWxvYWRTY3JpcHRzOmZ1bmN0aW9uKHNjZW5lRGF0YSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIXBjLnNjcmlwdC5sZWdhY3kpIHtcbiAgICAgIGNhbGxiYWNrKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBzZWxmLnN5c3RlbXMuc2NyaXB0LnByZWxvYWRpbmcgPSB0cnVlO1xuICAgIHZhciBzY3JpcHRzID0gdGhpcy5fZ2V0U2NyaXB0UmVmZXJlbmNlcyhzY2VuZURhdGEpO1xuICAgIHZhciBpID0gMCwgbCA9IHNjcmlwdHMubGVuZ3RoO1xuICAgIHZhciBwcm9ncmVzcyA9IG5ldyBQcm9ncmVzcyhsKTtcbiAgICB2YXIgc2NyaXB0VXJsO1xuICAgIHZhciByZWdleCA9IC9eaHR0cChzKT86XFwvXFwvLztcbiAgICBpZiAobCkge1xuICAgICAgdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKGVyciwgU2NyaXB0VHlwZSkge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHByb2dyZXNzLmluYygpO1xuICAgICAgICBpZiAocHJvZ3Jlc3MuZG9uZSgpKSB7XG4gICAgICAgICAgc2VsZi5zeXN0ZW1zLnNjcmlwdC5wcmVsb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGw7aSsrKSB7XG4gICAgICAgIHNjcmlwdFVybCA9IHNjcmlwdHNbaV07XG4gICAgICAgIGlmICghcmVnZXgudGVzdChzY3JpcHRVcmwudG9Mb3dlckNhc2UoKSkgJiYgc2VsZi5fc2NyaXB0UHJlZml4KSB7XG4gICAgICAgICAgc2NyaXB0VXJsID0gcGMucGF0aC5qb2luKHNlbGYuX3NjcmlwdFByZWZpeCwgc2NyaXB0c1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2FkZXIubG9hZChzY3JpcHRVcmwsIFwic2NyaXB0XCIsIG9uTG9hZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlbGYuc3lzdGVtcy5zY3JpcHQucHJlbG9hZGluZyA9IGZhbHNlO1xuICAgICAgY2FsbGJhY2soKTtcbiAgICB9XG4gIH0sIF9wYXJzZUFwcGxpY2F0aW9uUHJvcGVydGllczpmdW5jdGlvbihwcm9wcywgY2FsbGJhY2spIHtcbiAgICBpZiAoIXByb3BzLnVzZURldmljZVBpeGVsUmF0aW8pIHtcbiAgICAgIHByb3BzLnVzZURldmljZVBpeGVsUmF0aW8gPSBwcm9wcy51c2VfZGV2aWNlX3BpeGVsX3JhdGlvO1xuICAgIH1cbiAgICBpZiAoIXByb3BzLnJlc29sdXRpb25Nb2RlKSB7XG4gICAgICBwcm9wcy5yZXNvbHV0aW9uTW9kZSA9IHByb3BzLnJlc29sdXRpb25fbW9kZTtcbiAgICB9XG4gICAgaWYgKCFwcm9wcy5maWxsTW9kZSkge1xuICAgICAgcHJvcHMuZmlsbE1vZGUgPSBwcm9wcy5maWxsX21vZGU7XG4gICAgfVxuICAgIGlmICghcHJvcHMudnJQb2x5ZmlsbFVybCkge1xuICAgICAgcHJvcHMudnJQb2x5ZmlsbFVybCA9IHByb3BzLnZyX3BvbHlmaWxsX3VybDtcbiAgICB9XG4gICAgdGhpcy5fd2lkdGggPSBwcm9wcy53aWR0aDtcbiAgICB0aGlzLl9oZWlnaHQgPSBwcm9wcy5oZWlnaHQ7XG4gICAgaWYgKHByb3BzLnVzZURldmljZVBpeGVsUmF0aW8pIHtcbiAgICAgIHRoaXMuZ3JhcGhpY3NEZXZpY2UubWF4UGl4ZWxSYXRpbyA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgIH1cbiAgICB0aGlzLnNldENhbnZhc1Jlc29sdXRpb24ocHJvcHMucmVzb2x1dGlvbk1vZGUsIHRoaXMuX3dpZHRoLCB0aGlzLl9oZWlnaHQpO1xuICAgIHRoaXMuc2V0Q2FudmFzRmlsbE1vZGUocHJvcHMuZmlsbE1vZGUsIHRoaXMuX3dpZHRoLCB0aGlzLl9oZWlnaHQpO1xuICAgIGlmIChwcm9wcy52ciAmJiBwcm9wcy52clBvbHlmaWxsVXJsKSB7XG4gICAgICBpZiAoIXBjLlZyTWFuYWdlci5pc1N1cHBvcnRlZCB8fCBwYy5wbGF0Zm9ybS5hbmRyb2lkKSB7XG4gICAgICAgIHByb3BzLmxpYnJhcmllcy5wdXNoKHByb3BzLnZyUG9seWZpbGxVcmwpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAocHJvcHMuYmF0Y2hHcm91cHMpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBwcm9wcy5iYXRjaEdyb3Vwcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgdmFyIGdycCA9IHByb3BzLmJhdGNoR3JvdXBzW2ldO1xuICAgICAgICB0aGlzLmJhdGNoZXIuYWRkR3JvdXAoZ3JwLm5hbWUsIGdycC5keW5hbWljLCBncnAubWF4QWFiYlNpemUsIGdycC5pZCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2xvYWRMaWJyYXJpZXMocHJvcHMubGlicmFyaWVzLCBjYWxsYmFjayk7XG4gIH0sIF9sb2FkTGlicmFyaWVzOmZ1bmN0aW9uKHVybHMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIGxlbiA9IHVybHMubGVuZ3RoO1xuICAgIHZhciBjb3VudCA9IGxlbjtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIHJlZ2V4ID0gL15odHRwKHMpPzpcXC9cXC8vO1xuICAgIGlmIChsZW4pIHtcbiAgICAgIHZhciBvbkxvYWQgPSBmdW5jdGlvbihlcnIsIHNjcmlwdCkge1xuICAgICAgICBjb3VudC0tO1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoY291bnQgPT09IDApIHtcbiAgICAgICAgICAgIHNlbGYub25MaWJyYXJpZXNMb2FkZWQoKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBsZW47KytpKSB7XG4gICAgICAgIHZhciB1cmwgPSB1cmxzW2ldO1xuICAgICAgICBpZiAoIXJlZ2V4LnRlc3QodXJsLnRvTG93ZXJDYXNlKCkpICYmIHNlbGYuX3NjcmlwdFByZWZpeCkge1xuICAgICAgICAgIHVybCA9IHBjLnBhdGguam9pbihzZWxmLl9zY3JpcHRQcmVmaXgsIHVybCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2FkZXIubG9hZCh1cmwsIFwic2NyaXB0XCIsIG9uTG9hZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgIH1cbiAgfSwgX3BhcnNlQXNzZXRzOmZ1bmN0aW9uKGFzc2V0cykge1xuICAgIHZhciBpLCBpZDtcbiAgICB2YXIgc2NyaXB0cyA9IFtdO1xuICAgIHZhciBsaXN0ID0gW107XG4gICAgdmFyIHNjcmlwdHNJbmRleCA9IHt9O1xuICAgIGlmICghcGMuc2NyaXB0LmxlZ2FjeSkge1xuICAgICAgZm9yIChpID0gMDtpIDwgdGhpcy5zY3JpcHRzT3JkZXIubGVuZ3RoO2krKykge1xuICAgICAgICBpZCA9IHRoaXMuc2NyaXB0c09yZGVyW2ldO1xuICAgICAgICBpZiAoIWFzc2V0c1tpZF0pIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBzY3JpcHRzSW5kZXhbaWRdID0gdHJ1ZTtcbiAgICAgICAgbGlzdC5wdXNoKGFzc2V0c1tpZF0pO1xuICAgICAgfVxuICAgICAgZm9yIChpZCBpbiBhc3NldHMpIHtcbiAgICAgICAgaWYgKHNjcmlwdHNJbmRleFtpZF0pIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBsaXN0LnB1c2goYXNzZXRzW2lkXSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAoaWQgaW4gYXNzZXRzKSB7XG4gICAgICAgIGxpc3QucHVzaChhc3NldHNbaWRdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbGlzdC5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgZGF0YSA9IGxpc3RbaV07XG4gICAgICB2YXIgYXNzZXQgPSBuZXcgcGMuQXNzZXQoZGF0YS5uYW1lLCBkYXRhLnR5cGUsIGRhdGEuZmlsZSwgZGF0YS5kYXRhKTtcbiAgICAgIGFzc2V0LmlkID0gcGFyc2VJbnQoZGF0YS5pZCk7XG4gICAgICBhc3NldC5wcmVsb2FkID0gZGF0YS5wcmVsb2FkID8gZGF0YS5wcmVsb2FkIDogZmFsc2U7XG4gICAgICBhc3NldC50YWdzLmFkZChkYXRhLnRhZ3MpO1xuICAgICAgdGhpcy5hc3NldHMuYWRkKGFzc2V0KTtcbiAgICB9XG4gIH0sIF9nZXRTY3JpcHRSZWZlcmVuY2VzOmZ1bmN0aW9uKHNjZW5lKSB7XG4gICAgdmFyIGksIGtleTtcbiAgICB2YXIgcHJpb3JpdHlTY3JpcHRzID0gW107XG4gICAgaWYgKHNjZW5lLnNldHRpbmdzLnByaW9yaXR5X3NjcmlwdHMpIHtcbiAgICAgIHByaW9yaXR5U2NyaXB0cyA9IHNjZW5lLnNldHRpbmdzLnByaW9yaXR5X3NjcmlwdHM7XG4gICAgfVxuICAgIHZhciBfc2NyaXB0cyA9IFtdO1xuICAgIHZhciBfaW5kZXggPSB7fTtcbiAgICBmb3IgKGkgPSAwO2kgPCBwcmlvcml0eVNjcmlwdHMubGVuZ3RoO2krKykge1xuICAgICAgX3NjcmlwdHMucHVzaChwcmlvcml0eVNjcmlwdHNbaV0pO1xuICAgICAgX2luZGV4W3ByaW9yaXR5U2NyaXB0c1tpXV0gPSB0cnVlO1xuICAgIH1cbiAgICB2YXIgZW50aXRpZXMgPSBzY2VuZS5lbnRpdGllcztcbiAgICBmb3IgKGtleSBpbiBlbnRpdGllcykge1xuICAgICAgaWYgKCFlbnRpdGllc1trZXldLmNvbXBvbmVudHMuc2NyaXB0KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdmFyIHNjcmlwdHMgPSBlbnRpdGllc1trZXldLmNvbXBvbmVudHMuc2NyaXB0LnNjcmlwdHM7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBzY3JpcHRzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYgKF9pbmRleFtzY3JpcHRzW2ldLnVybF0pIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBfc2NyaXB0cy5wdXNoKHNjcmlwdHNbaV0udXJsKTtcbiAgICAgICAgX2luZGV4W3NjcmlwdHNbaV0udXJsXSA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBfc2NyaXB0cztcbiAgfSwgc3RhcnQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5maXJlKFwic3RhcnRcIiwge3RpbWVzdGFtcDpwYy5ub3coKSwgdGFyZ2V0OnRoaXN9KTtcbiAgICBpZiAoIXRoaXMuX2xpYnJhcmllc0xvYWRlZCkge1xuICAgICAgdGhpcy5vbkxpYnJhcmllc0xvYWRlZCgpO1xuICAgIH1cbiAgICBwYy5Db21wb25lbnRTeXN0ZW0uaW5pdGlhbGl6ZSh0aGlzLnJvb3QpO1xuICAgIHRoaXMuZmlyZShcImluaXRpYWxpemVcIik7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLnBvc3RJbml0aWFsaXplKHRoaXMucm9vdCk7XG4gICAgdGhpcy5maXJlKFwicG9zdGluaXRpYWxpemVcIik7XG4gICAgdGhpcy50aWNrKCk7XG4gIH0sIHVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHRoaXMuZ3JhcGhpY3NEZXZpY2UudXBkYXRlQ2xpZW50UmVjdCgpO1xuICAgIGlmICh0aGlzLnZyKSB7XG4gICAgICB0aGlzLnZyLnBvbGwoKTtcbiAgICB9XG4gICAgaWYgKHBjLnNjcmlwdC5sZWdhY3kpIHtcbiAgICAgIHBjLkNvbXBvbmVudFN5c3RlbS5maXhlZFVwZGF0ZSgxLjAgLyA2MC4wLCB0aGlzLl9pblRvb2xzKTtcbiAgICB9XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLnVwZGF0ZShkdCwgdGhpcy5faW5Ub29scyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLnBvc3RVcGRhdGUoZHQsIHRoaXMuX2luVG9vbHMpO1xuICAgIHRoaXMuZmlyZShcInVwZGF0ZVwiLCBkdCk7XG4gICAgaWYgKHRoaXMuY29udHJvbGxlcikge1xuICAgICAgdGhpcy5jb250cm9sbGVyLnVwZGF0ZShkdCk7XG4gICAgfVxuICAgIGlmICh0aGlzLm1vdXNlKSB7XG4gICAgICB0aGlzLm1vdXNlLnVwZGF0ZShkdCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmtleWJvYXJkKSB7XG4gICAgICB0aGlzLmtleWJvYXJkLnVwZGF0ZShkdCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmdhbWVwYWRzKSB7XG4gICAgICB0aGlzLmdhbWVwYWRzLnVwZGF0ZShkdCk7XG4gICAgfVxuICB9LCByZW5kZXI6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5maXJlKFwicHJlcmVuZGVyXCIpO1xuICAgIHZhciBjYW1lcmFzID0gdGhpcy5zeXN0ZW1zLmNhbWVyYS5jYW1lcmFzO1xuICAgIHZhciBjYW1lcmEgPSBudWxsO1xuICAgIHZhciByZW5kZXJlciA9IHRoaXMucmVuZGVyZXI7XG4gICAgdGhpcy5yb290LnN5bmNIaWVyYXJjaHkoKTtcbiAgICB0aGlzLmJhdGNoZXIudXBkYXRlQWxsKCk7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNhbWVyYXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICBjYW1lcmEgPSBjYW1lcmFzW2ldO1xuICAgICAgY2FtZXJhLmZyYW1lQmVnaW4oKTtcbiAgICAgIHJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCBjYW1lcmEuY2FtZXJhKTtcbiAgICAgIGNhbWVyYS5mcmFtZUVuZCgpO1xuICAgIH1cbiAgfSwgX2ZpbGxGcmFtZVN0YXRzOmZ1bmN0aW9uKG5vdywgZHQsIG1zKSB7XG4gICAgdmFyIHN0YXRzID0gdGhpcy5zdGF0cy5mcmFtZTtcbiAgICBzdGF0cy5kdCA9IGR0O1xuICAgIHN0YXRzLm1zID0gbXM7XG4gICAgaWYgKG5vdyA+IHN0YXRzLl90aW1lVG9Db3VudEZyYW1lcykge1xuICAgICAgc3RhdHMuZnBzID0gc3RhdHMuX2Zwc0FjY3VtO1xuICAgICAgc3RhdHMuX2Zwc0FjY3VtID0gMDtcbiAgICAgIHN0YXRzLl90aW1lVG9Db3VudEZyYW1lcyA9IG5vdyArIDEwMDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRzLl9mcHNBY2N1bSsrO1xuICAgIH1cbiAgICBzdGF0cy5jYW1lcmFzID0gdGhpcy5yZW5kZXJlci5fY2FtZXJhc1JlbmRlcmVkO1xuICAgIHN0YXRzLm1hdGVyaWFscyA9IHRoaXMucmVuZGVyZXIuX21hdGVyaWFsU3dpdGNoZXM7XG4gICAgc3RhdHMuc2hhZGVycyA9IHRoaXMuZ3JhcGhpY3NEZXZpY2UuX3NoYWRlclN3aXRjaGVzUGVyRnJhbWU7XG4gICAgc3RhdHMuc2hhZG93TWFwVXBkYXRlcyA9IHRoaXMucmVuZGVyZXIuX3NoYWRvd01hcFVwZGF0ZXM7XG4gICAgc3RhdHMuc2hhZG93TWFwVGltZSA9IHRoaXMucmVuZGVyZXIuX3NoYWRvd01hcFRpbWU7XG4gICAgc3RhdHMuZGVwdGhNYXBUaW1lID0gdGhpcy5yZW5kZXJlci5fZGVwdGhNYXBUaW1lO1xuICAgIHN0YXRzLmZvcndhcmRUaW1lID0gdGhpcy5yZW5kZXJlci5fZm9yd2FyZFRpbWU7XG4gICAgdmFyIHByaW1zID0gdGhpcy5ncmFwaGljc0RldmljZS5fcHJpbXNQZXJGcmFtZTtcbiAgICBzdGF0cy50cmlhbmdsZXMgPSBwcmltc1twYy5QUklNSVRJVkVfVFJJQU5HTEVTXSAvIDMgKyBNYXRoLm1heChwcmltc1twYy5QUklNSVRJVkVfVFJJU1RSSVBdIC0gMiwgMCkgKyBNYXRoLm1heChwcmltc1twYy5QUklNSVRJVkVfVFJJRkFOXSAtIDIsIDApO1xuICAgIHN0YXRzLmN1bGxUaW1lID0gdGhpcy5yZW5kZXJlci5fY3VsbFRpbWU7XG4gICAgc3RhdHMuc29ydFRpbWUgPSB0aGlzLnJlbmRlcmVyLl9zb3J0VGltZTtcbiAgICBzdGF0cy5za2luVGltZSA9IHRoaXMucmVuZGVyZXIuX3NraW5UaW1lO1xuICAgIHN0YXRzLm1vcnBoVGltZSA9IHRoaXMucmVuZGVyZXIuX21vcnBoVGltZTtcbiAgICBzdGF0cy5pbnN0YW5jaW5nVGltZSA9IHRoaXMucmVuZGVyZXIuX2luc3RhbmNpbmdUaW1lO1xuICAgIHN0YXRzLm90aGVyUHJpbWl0aXZlcyA9IDA7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHByaW1zLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmIChpIDwgcGMuUFJJTUlUSVZFX1RSSUFOR0xFUykge1xuICAgICAgICBzdGF0cy5vdGhlclByaW1pdGl2ZXMgKz0gcHJpbXNbaV07XG4gICAgICB9XG4gICAgICBwcmltc1tpXSA9IDA7XG4gICAgfVxuICAgIHRoaXMucmVuZGVyZXIuX2NhbWVyYXNSZW5kZXJlZCA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fbWF0ZXJpYWxTd2l0Y2hlcyA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fc2hhZG93TWFwVXBkYXRlcyA9IDA7XG4gICAgdGhpcy5ncmFwaGljc0RldmljZS5fc2hhZGVyU3dpdGNoZXNQZXJGcmFtZSA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fY3VsbFRpbWUgPSAwO1xuICAgIHRoaXMucmVuZGVyZXIuX3NvcnRUaW1lID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9za2luVGltZSA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fbW9ycGhUaW1lID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9pbnN0YW5jaW5nVGltZSA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fc2hhZG93TWFwVGltZSA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fZGVwdGhNYXBUaW1lID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9mb3J3YXJkVGltZSA9IDA7XG4gICAgc3RhdHMgPSB0aGlzLnN0YXRzLmRyYXdDYWxscztcbiAgICBzdGF0cy5mb3J3YXJkID0gdGhpcy5yZW5kZXJlci5fZm9yd2FyZERyYXdDYWxscztcbiAgICBzdGF0cy5kZXB0aCA9IHRoaXMucmVuZGVyZXIuX2RlcHRoRHJhd0NhbGxzO1xuICAgIHN0YXRzLnNoYWRvdyA9IHRoaXMucmVuZGVyZXIuX3NoYWRvd0RyYXdDYWxscztcbiAgICBzdGF0cy5za2lubmVkID0gdGhpcy5yZW5kZXJlci5fc2tpbkRyYXdDYWxscztcbiAgICBzdGF0cy5pbW1lZGlhdGUgPSB0aGlzLnJlbmRlcmVyLl9pbW1lZGlhdGVSZW5kZXJlZDtcbiAgICBzdGF0cy5pbnN0YW5jZWQgPSB0aGlzLnJlbmRlcmVyLl9pbnN0YW5jZWREcmF3Q2FsbHM7XG4gICAgc3RhdHMucmVtb3ZlZEJ5SW5zdGFuY2luZyA9IHRoaXMucmVuZGVyZXIuX3JlbW92ZWRCeUluc3RhbmNpbmc7XG4gICAgc3RhdHMudG90YWwgPSB0aGlzLmdyYXBoaWNzRGV2aWNlLl9kcmF3Q2FsbHNQZXJGcmFtZTtcbiAgICBzdGF0cy5taXNjID0gc3RhdHMudG90YWwgLSAoc3RhdHMuZm9yd2FyZCArIHN0YXRzLmRlcHRoICsgc3RhdHMuc2hhZG93KTtcbiAgICB0aGlzLnJlbmRlcmVyLl9kZXB0aERyYXdDYWxscyA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5fc2hhZG93RHJhd0NhbGxzID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9mb3J3YXJkRHJhd0NhbGxzID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9za2luRHJhd0NhbGxzID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9pbW1lZGlhdGVSZW5kZXJlZCA9IDA7XG4gICAgdGhpcy5yZW5kZXJlci5faW5zdGFuY2VkRHJhd0NhbGxzID0gMDtcbiAgICB0aGlzLnJlbmRlcmVyLl9yZW1vdmVkQnlJbnN0YW5jaW5nID0gMDtcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlLl9kcmF3Q2FsbHNQZXJGcmFtZSA9IDA7XG4gICAgdGhpcy5zdGF0cy5taXNjLnJlbmRlclRhcmdldENyZWF0aW9uVGltZSA9IHRoaXMuZ3JhcGhpY3NEZXZpY2UucmVuZGVyVGFyZ2V0Q3JlYXRpb25UaW1lO1xuICAgIHN0YXRzID0gdGhpcy5zdGF0cy5wYXJ0aWNsZXM7XG4gICAgc3RhdHMudXBkYXRlc1BlckZyYW1lID0gc3RhdHMuX3VwZGF0ZXNQZXJGcmFtZTtcbiAgICBzdGF0cy5mcmFtZVRpbWUgPSBzdGF0cy5fZnJhbWVUaW1lO1xuICAgIHN0YXRzLl91cGRhdGVzUGVyRnJhbWUgPSAwO1xuICAgIHN0YXRzLl9mcmFtZVRpbWUgPSAwO1xuICB9LCBzZXRDYW52YXNGaWxsTW9kZTpmdW5jdGlvbihtb2RlLCB3aWR0aCwgaGVpZ2h0KSB7XG4gICAgdGhpcy5fZmlsbE1vZGUgPSBtb2RlO1xuICAgIHRoaXMucmVzaXplQ2FudmFzKHdpZHRoLCBoZWlnaHQpO1xuICB9LCBzZXRDYW52YXNSZXNvbHV0aW9uOmZ1bmN0aW9uKG1vZGUsIHdpZHRoLCBoZWlnaHQpIHtcbiAgICB0aGlzLl9yZXNvbHV0aW9uTW9kZSA9IG1vZGU7XG4gICAgaWYgKG1vZGUgPT09IHBjLlJFU09MVVRJT05fQVVUTyAmJiB3aWR0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB3aWR0aCA9IHRoaXMuZ3JhcGhpY3NEZXZpY2UuY2FudmFzLmNsaWVudFdpZHRoO1xuICAgICAgaGVpZ2h0ID0gdGhpcy5ncmFwaGljc0RldmljZS5jYW52YXMuY2xpZW50SGVpZ2h0O1xuICAgIH1cbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlLnJlc2l6ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KTtcbiAgfSwgaXNGdWxsc2NyZWVuOmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAhIWRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50O1xuICB9LCBlbmFibGVGdWxsc2NyZWVuOmZ1bmN0aW9uKGVsZW1lbnQsIHN1Y2Nlc3MsIGVycm9yKSB7XG4gICAgZWxlbWVudCA9IGVsZW1lbnQgfHwgdGhpcy5ncmFwaGljc0RldmljZS5jYW52YXM7XG4gICAgdmFyIHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHN1Y2Nlc3MoKTtcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJmdWxsc2NyZWVuY2hhbmdlXCIsIHMpO1xuICAgIH07XG4gICAgdmFyIGUgPSBmdW5jdGlvbigpIHtcbiAgICAgIGVycm9yKCk7XG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwiZnVsbHNjcmVlbmVycm9yXCIsIGUpO1xuICAgIH07XG4gICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJmdWxsc2NyZWVuY2hhbmdlXCIsIHMsIGZhbHNlKTtcbiAgICB9XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiZnVsbHNjcmVlbmVycm9yXCIsIGUsIGZhbHNlKTtcbiAgICB9XG4gICAgaWYgKGVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4pIHtcbiAgICAgIGVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yKCk7XG4gICAgfVxuICB9LCBkaXNhYmxlRnVsbHNjcmVlbjpmdW5jdGlvbihzdWNjZXNzKSB7XG4gICAgdmFyIHMgPSBmdW5jdGlvbigpIHtcbiAgICAgIHN1Y2Nlc3MoKTtcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJmdWxsc2NyZWVuY2hhbmdlXCIsIHMpO1xuICAgIH07XG4gICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJmdWxsc2NyZWVuY2hhbmdlXCIsIHMsIGZhbHNlKTtcbiAgICB9XG4gICAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4oKTtcbiAgfSwgaXNIaWRkZW46ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIGRvY3VtZW50W3RoaXMuX2hpZGRlbkF0dHJdO1xuICB9LCBvblZpc2liaWxpdHlDaGFuZ2U6ZnVuY3Rpb24oZSkge1xuICAgIGlmICh0aGlzLmlzSGlkZGVuKCkpIHtcbiAgICAgIHRoaXMuX2F1ZGlvTWFuYWdlci5zdXNwZW5kKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2F1ZGlvTWFuYWdlci5yZXN1bWUoKTtcbiAgICB9XG4gIH0sIHJlc2l6ZUNhbnZhczpmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7XG4gICAgaWYgKCF0aGlzLl9hbGxvd1Jlc2l6ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgd2luZG93V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICB2YXIgd2luZG93SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgIGlmIChuYXZpZ2F0b3IuaXNDb2Nvb25KUykge1xuICAgICAgd2lkdGggPSB3aW5kb3dXaWR0aDtcbiAgICAgIGhlaWdodCA9IHdpbmRvd0hlaWdodDtcbiAgICAgIHRoaXMuZ3JhcGhpY3NEZXZpY2UucmVzaXplQ2FudmFzKHdpZHRoLCBoZWlnaHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fZmlsbE1vZGUgPT09IHBjLkZJTExNT0RFX0tFRVBfQVNQRUNUKSB7XG4gICAgICAgIHZhciByID0gdGhpcy5ncmFwaGljc0RldmljZS5jYW52YXMud2lkdGggLyB0aGlzLmdyYXBoaWNzRGV2aWNlLmNhbnZhcy5oZWlnaHQ7XG4gICAgICAgIHZhciB3aW5SID0gd2luZG93V2lkdGggLyB3aW5kb3dIZWlnaHQ7XG4gICAgICAgIGlmIChyID4gd2luUikge1xuICAgICAgICAgIHdpZHRoID0gd2luZG93V2lkdGg7XG4gICAgICAgICAgaGVpZ2h0ID0gd2lkdGggLyByO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGhlaWdodCA9IHdpbmRvd0hlaWdodDtcbiAgICAgICAgICB3aWR0aCA9IGhlaWdodCAqIHI7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLl9maWxsTW9kZSA9PT0gcGMuRklMTE1PREVfRklMTF9XSU5ET1cpIHtcbiAgICAgICAgICB3aWR0aCA9IHdpbmRvd1dpZHRoO1xuICAgICAgICAgIGhlaWdodCA9IHdpbmRvd0hlaWdodDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5ncmFwaGljc0RldmljZS5jYW52YXMuc3R5bGUud2lkdGggPSB3aWR0aCArIFwicHhcIjtcbiAgICAgIHRoaXMuZ3JhcGhpY3NEZXZpY2UuY2FudmFzLnN0eWxlLmhlaWdodCA9IGhlaWdodCArIFwicHhcIjtcbiAgICAgIGlmICh0aGlzLl9yZXNvbHV0aW9uTW9kZSA9PT0gcGMuUkVTT0xVVElPTl9BVVRPKSB7XG4gICAgICAgIHRoaXMuc2V0Q2FudmFzUmVzb2x1dGlvbihwYy5SRVNPTFVUSU9OX0FVVE8pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge3dpZHRoOndpZHRoLCBoZWlnaHQ6aGVpZ2h0fTtcbiAgfSwgb25MaWJyYXJpZXNMb2FkZWQ6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fbGlicmFyaWVzTG9hZGVkID0gdHJ1ZTtcbiAgICB0aGlzLnN5c3RlbXMucmlnaWRib2R5Lm9uTGlicmFyeUxvYWRlZCgpO1xuICAgIHRoaXMuc3lzdGVtcy5jb2xsaXNpb24ub25MaWJyYXJ5TG9hZGVkKCk7XG4gIH0sIGFwcGx5U2NlbmVTZXR0aW5nczpmdW5jdGlvbihzZXR0aW5ncykge1xuICAgIHZhciBhc3NldDtcbiAgICBpZiAodGhpcy5zeXN0ZW1zLnJpZ2lkYm9keSAmJiB0eXBlb2YgQW1tbyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdmFyIGdyYXZpdHkgPSBzZXR0aW5ncy5waHlzaWNzLmdyYXZpdHk7XG4gICAgICB0aGlzLnN5c3RlbXMucmlnaWRib2R5LnNldEdyYXZpdHkoZ3Jhdml0eVswXSwgZ3Jhdml0eVsxXSwgZ3Jhdml0eVsyXSk7XG4gICAgfVxuICAgIHRoaXMuc2NlbmUuYXBwbHlTZXR0aW5ncyhzZXR0aW5ncyk7XG4gICAgaWYgKHNldHRpbmdzLnJlbmRlci5oYXNPd25Qcm9wZXJ0eShcInNreWJveFwiKSkge1xuICAgICAgaWYgKHNldHRpbmdzLnJlbmRlci5za3lib3gpIHtcbiAgICAgICAgYXNzZXQgPSB0aGlzLmFzc2V0cy5nZXQoc2V0dGluZ3MucmVuZGVyLnNreWJveCk7XG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgIHRoaXMuc2V0U2t5Ym94KGFzc2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmFzc2V0cy5vbmNlKFwiYWRkOlwiICsgc2V0dGluZ3MucmVuZGVyLnNreWJveCwgdGhpcy5zZXRTa3lib3gsIHRoaXMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNldFNreWJveChudWxsKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHNldFNreWJveDpmdW5jdGlvbihhc3NldCkge1xuICAgIGlmIChhc3NldCkge1xuICAgICAgaWYgKHRoaXMuX3NreWJveExhc3QgPT09IGFzc2V0LmlkKSB7XG4gICAgICAgIGlmICh0aGlzLnNjZW5lLnNreWJveE1pcCA9PT0gMCAmJiAhYXNzZXQubG9hZEZhY2VzKSB7XG4gICAgICAgICAgdGhpcy5fc2t5Ym94TG9hZChhc3NldCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fb25Ta3lib3hDaGFuZ2UoYXNzZXQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9za3lib3hMYXN0KSB7XG4gICAgICAgIHRoaXMuYXNzZXRzLm9mZihcImFkZDpcIiArIHRoaXMuX3NreWJveExhc3QsIHRoaXMuc2V0U2t5Ym94LCB0aGlzKTtcbiAgICAgICAgdGhpcy5hc3NldHMub2ZmKFwibG9hZDpcIiArIHRoaXMuX3NreWJveExhc3QsIHRoaXMuX29uU2t5Ym94Q2hhbmdlLCB0aGlzKTtcbiAgICAgICAgdGhpcy5hc3NldHMub2ZmKFwicmVtb3ZlOlwiICsgdGhpcy5fc2t5Ym94TGFzdCwgdGhpcy5fc2t5Ym94UmVtb3ZlLCB0aGlzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX3NreWJveExhc3QgPSBhc3NldC5pZDtcbiAgICAgIHRoaXMuYXNzZXRzLm9uKFwibG9hZDpcIiArIGFzc2V0LmlkLCB0aGlzLl9vblNreWJveENoYW5nZSwgdGhpcyk7XG4gICAgICB0aGlzLmFzc2V0cy5vbmNlKFwicmVtb3ZlOlwiICsgYXNzZXQuaWQsIHRoaXMuX3NreWJveFJlbW92ZSwgdGhpcyk7XG4gICAgICBpZiAoYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgdGhpcy5zY2VuZS5zZXRTa3lib3goYXNzZXQucmVzb3VyY2VzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX3NreWJveExvYWQoYXNzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMuX3NreWJveExhc3QpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5fc2t5Ym94UmVtb3ZlKHtpZDp0aGlzLl9za3lib3hMYXN0fSk7XG4gICAgfVxuICB9LCBfb25WckNoYW5nZTpmdW5jdGlvbihlbmFibGVkKSB7XG4gICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgIGlmICghdGhpcy52cikge1xuICAgICAgICB0aGlzLnZyID0gbmV3IHBjLlZyTWFuYWdlcih0aGlzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMudnIpIHtcbiAgICAgICAgdGhpcy52ci5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMudnIgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX29uU2t5Ym94Q2hhbmdlOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5zY2VuZS5zZXRTa3lib3goYXNzZXQucmVzb3VyY2VzKTtcbiAgfSwgX3NreWJveExvYWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBpZiAodGhpcy5zY2VuZS5za3lib3hNaXAgPT09IDApIHtcbiAgICAgIGFzc2V0LmxvYWRGYWNlcyA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgIHRoaXMuX29uU2t5Ym94Q2hhbmdlKGFzc2V0KTtcbiAgfSwgX3NreWJveFJlbW92ZTpmdW5jdGlvbihhc3NldCkge1xuICAgIGlmICghdGhpcy5fc2t5Ym94TGFzdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFzc2V0cy5vZmYoXCJhZGQ6XCIgKyBhc3NldC5pZCwgdGhpcy5zZXRTa3lib3gsIHRoaXMpO1xuICAgIHRoaXMuYXNzZXRzLm9mZihcImxvYWQ6XCIgKyBhc3NldC5pZCwgdGhpcy5fb25Ta3lib3hDaGFuZ2UsIHRoaXMpO1xuICAgIHRoaXMuYXNzZXRzLm9mZihcInJlbW92ZTpcIiArIGFzc2V0LmlkLCB0aGlzLl9za3lib3hSZW1vdmUsIHRoaXMpO1xuICAgIHRoaXMuc2NlbmUuc2V0U2t5Ym94KG51bGwpO1xuICAgIHRoaXMuX3NreWJveExhc3QgPSBudWxsO1xuICB9LCBfZmlyc3RCYWtlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMubGlnaHRtYXBwZXIuYmFrZShudWxsLCB0aGlzLnNjZW5lLmxpZ2h0bWFwTW9kZSk7XG4gIH0sIF9maXJzdEJhdGNoOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLnNjZW5lLl9uZWVkc1N0YXRpY1ByZXBhcmUpIHtcbiAgICAgIHRoaXMucmVuZGVyZXIucHJlcGFyZVN0YXRpY01lc2hlcyh0aGlzLmdyYXBoaWNzRGV2aWNlLCB0aGlzLnNjZW5lKTtcbiAgICAgIHRoaXMuc2NlbmUuX25lZWRzU3RhdGljUHJlcGFyZSA9IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLmJhdGNoZXIuZ2VuZXJhdGUoKTtcbiAgfSwgZGVzdHJveTpmdW5jdGlvbigpIHtcbiAgICBBcHBsaWNhdGlvbi5fYXBwbGljYXRpb25zW3RoaXMuZ3JhcGhpY3NEZXZpY2UuY2FudmFzLmlkXSA9IG51bGw7XG4gICAgdGhpcy5vZmYoXCJsaWJyYXJpZXNsb2FkZWRcIik7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInZpc2liaWxpdHljaGFuZ2VcIiwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZUhhbmRsZXIpO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtb3p2aXNpYmlsaXR5Y2hhbmdlXCIsIHRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VIYW5kbGVyKTtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwibXN2aXNpYmlsaXR5Y2hhbmdlXCIsIHRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VIYW5kbGVyKTtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwid2Via2l0dmlzaWJpbGl0eWNoYW5nZVwiLCB0aGlzLl92aXNpYmlsaXR5Q2hhbmdlSGFuZGxlcik7XG4gICAgdGhpcy5yb290LmRlc3Ryb3koKTtcbiAgICB0aGlzLnJvb3QgPSBudWxsO1xuICAgIGlmICh0aGlzLm1vdXNlKSB7XG4gICAgICB0aGlzLm1vdXNlLm9mZihcIm1vdXNldXBcIik7XG4gICAgICB0aGlzLm1vdXNlLm9mZihcIm1vdXNlZG93blwiKTtcbiAgICAgIHRoaXMubW91c2Uub2ZmKFwibW91c2V3aGVlbFwiKTtcbiAgICAgIHRoaXMubW91c2Uub2ZmKFwibW91c2Vtb3ZlXCIpO1xuICAgICAgdGhpcy5tb3VzZSA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLmtleWJvYXJkKSB7XG4gICAgICB0aGlzLmtleWJvYXJkLm9mZihcImtleWRvd25cIik7XG4gICAgICB0aGlzLmtleWJvYXJkLm9mZihcImtleXVwXCIpO1xuICAgICAgdGhpcy5rZXlib2FyZC5vZmYoXCJrZXlwcmVzc1wiKTtcbiAgICAgIHRoaXMua2V5Ym9hcmQgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy50b3VjaCkge1xuICAgICAgdGhpcy50b3VjaC5vZmYoXCJ0b3VjaHN0YXJ0XCIpO1xuICAgICAgdGhpcy50b3VjaC5vZmYoXCJ0b3VjaGVuZFwiKTtcbiAgICAgIHRoaXMudG91Y2gub2ZmKFwidG91Y2htb3ZlXCIpO1xuICAgICAgdGhpcy50b3VjaC5vZmYoXCJ0b3VjaGNhbmNlbFwiKTtcbiAgICAgIHRoaXMudG91Y2ggPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb250cm9sbGVyKSB7XG4gICAgICB0aGlzLmNvbnRyb2xsZXIgPSBudWxsO1xuICAgIH1cbiAgICBwYy5Db21wb25lbnRTeXN0ZW0uZGVzdHJveSgpO1xuICAgIHZhciBhc3NldHMgPSB0aGlzLmFzc2V0cy5saXN0KCk7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IGFzc2V0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBhc3NldHNbaV0udW5sb2FkKCk7XG4gICAgfVxuICAgIHRoaXMubG9hZGVyLmRlc3Ryb3koKTtcbiAgICB0aGlzLmxvYWRlciA9IG51bGw7XG4gICAgdGhpcy5zY2VuZSA9IG51bGw7XG4gICAgdGhpcy5zeXN0ZW1zID0gW107XG4gICAgdGhpcy5jb250ZXh0ID0gbnVsbDtcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlLmNsZWFyU2hhZGVyQ2FjaGUoKTtcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlLmRlc3Ryb3koKTtcbiAgICB0aGlzLmdyYXBoaWNzRGV2aWNlLmRlc3Ryb3llZCA9IHRydWU7XG4gICAgdGhpcy5ncmFwaGljc0RldmljZSA9IG51bGw7XG4gICAgdGhpcy5yZW5kZXJlciA9IG51bGw7XG4gICAgaWYgKHRoaXMuX2F1ZGlvTWFuYWdlcikge1xuICAgICAgdGhpcy5fYXVkaW9NYW5hZ2VyLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuX2F1ZGlvTWFuYWdlciA9IG51bGw7XG4gICAgfVxuICAgIHBjLmh0dHAgPSBuZXcgcGMuSHR0cDtcbiAgICBwYy5QYXJ0aWNsZUVtaXR0ZXIuREVGQVVMVF9QQVJBTV9URVhUVVJFID0gbnVsbDtcbiAgICBwYy5kZXN0cm95UG9zdEVmZmVjdFF1YWQoKTtcbiAgfX07XG4gIHZhciBtYWtlVGljayA9IGZ1bmN0aW9uKF9hcHApIHtcbiAgICB2YXIgYXBwID0gX2FwcDtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoIWFwcC5ncmFwaGljc0RldmljZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBBcHBsaWNhdGlvbi5fY3VycmVudEFwcGxpY2F0aW9uID0gYXBwO1xuICAgICAgcGMuYXBwID0gYXBwO1xuICAgICAgdmFyIG5vdyA9IHBjLm5vdygpO1xuICAgICAgdmFyIG1zID0gbm93IC0gKGFwcC5fdGltZSB8fCBub3cpO1xuICAgICAgdmFyIGR0ID0gbXMgLyAxMDAwLjA7XG4gICAgICBhcHAuX3RpbWUgPSBub3c7XG4gICAgICBkdCA9IHBjLm1hdGguY2xhbXAoZHQsIDAsIDAuMSk7XG4gICAgICBkdCAqPSBhcHAudGltZVNjYWxlO1xuICAgICAgaWYgKGFwcC52ciAmJiBhcHAudnIuZGlzcGxheSkge1xuICAgICAgICBhcHAudnIuZGlzcGxheS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYXBwLnRpY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShhcHAudGljayk7XG4gICAgICB9XG4gICAgICBhcHAudXBkYXRlKGR0KTtcbiAgICAgIGlmIChhcHAuYXV0b1JlbmRlciB8fCBhcHAucmVuZGVyTmV4dEZyYW1lKSB7XG4gICAgICAgIGFwcC5yZW5kZXIoKTtcbiAgICAgICAgYXBwLnJlbmRlck5leHRGcmFtZSA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgX2ZyYW1lRW5kRGF0YS50aW1lc3RhbXAgPSBwYy5ub3coKTtcbiAgICAgIF9mcmFtZUVuZERhdGEudGFyZ2V0ID0gYXBwO1xuICAgICAgYXBwLmZpcmUoXCJmcmFtZWVuZFwiLCBfZnJhbWVFbmREYXRhKTtcbiAgICAgIGFwcC5maXJlKFwiZnJhbWVFbmRcIiwgX2ZyYW1lRW5kRGF0YSk7XG4gICAgICBpZiAoYXBwLnZyICYmIGFwcC52ci5kaXNwbGF5ICYmIGFwcC52ci5kaXNwbGF5LnByZXNlbnRpbmcpIHtcbiAgICAgICAgYXBwLnZyLmRpc3BsYXkuc3VibWl0RnJhbWUoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9O1xuICB2YXIgX2ZyYW1lRW5kRGF0YSA9IHt9O1xuICByZXR1cm4ge0ZJTExNT0RFX05PTkU6XCJOT05FXCIsIEZJTExNT0RFX0ZJTExfV0lORE9XOlwiRklMTF9XSU5ET1dcIiwgRklMTE1PREVfS0VFUF9BU1BFQ1Q6XCJLRUVQX0FTUEVDVFwiLCBSRVNPTFVUSU9OX0FVVE86XCJBVVRPXCIsIFJFU09MVVRJT05fRklYRUQ6XCJGSVhFRFwiLCBBcHBsaWNhdGlvbjpBcHBsaWNhdGlvbn07XG59KCkpO1xucGMuQXBwbGljYXRpb25TdGF0cyA9IGZ1bmN0aW9uKGRldmljZSkge1xuICB0aGlzLmZyYW1lID0ge2ZwczowLCBtczowLCBkdDowLCB1cGRhdGVTdGFydDowLCB1cGRhdGVUaW1lOjAsIHJlbmRlclN0YXJ0OjAsIHJlbmRlclRpbWU6MCwgcGh5c2ljc1N0YXJ0OjAsIHBoeXNpY3NUaW1lOjAsIGN1bGxUaW1lOjAsIHNvcnRUaW1lOjAsIHNraW5UaW1lOjAsIG1vcnBoVGltZTowLCBpbnN0YW5jaW5nVGltZTowLCB0cmlhbmdsZXM6MCwgb3RoZXJQcmltaXRpdmVzOjAsIHNoYWRlcnM6MCwgbWF0ZXJpYWxzOjAsIGNhbWVyYXM6MCwgc2hhZG93TWFwVXBkYXRlczowLCBzaGFkb3dNYXBUaW1lOjAsIGRlcHRoTWFwVGltZTowLCBmb3J3YXJkVGltZTowLCBfdGltZVRvQ291bnRGcmFtZXM6MCwgX2Zwc0FjY3VtOjB9O1xuICB0aGlzLmRyYXdDYWxscyA9IHtmb3J3YXJkOjAsIGRlcHRoOjAsIHNoYWRvdzowLCBpbW1lZGlhdGU6MCwgbWlzYzowLCB0b3RhbDowLCBza2lubmVkOjAsIGluc3RhbmNlZDowLCByZW1vdmVkQnlJbnN0YW5jaW5nOjB9O1xuICB0aGlzLm1pc2MgPSB7cmVuZGVyVGFyZ2V0Q3JlYXRpb25UaW1lOjB9O1xuICB0aGlzLnBhcnRpY2xlcyA9IHt1cGRhdGVzUGVyRnJhbWU6MCwgX3VwZGF0ZXNQZXJGcmFtZTowLCBmcmFtZVRpbWU6MCwgX2ZyYW1lVGltZTowfTtcbiAgdGhpcy52cmFtID0gZGV2aWNlLl92cmFtO1xuICB0aGlzLnNoYWRlcnMgPSBkZXZpY2UuX3NoYWRlclN0YXRzO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy52cmFtLCBcInRvdGFsVXNlZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnRleCArIHRoaXMudmIgKyB0aGlzLmliO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcInNjZW5lXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHBjLkFwcGxpY2F0aW9uLl9jdXJyZW50QXBwbGljYXRpb24uc2NlbmUuX3N0YXRzO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcImxpZ2h0bWFwcGVyXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHBjLkFwcGxpY2F0aW9uLl9jdXJyZW50QXBwbGljYXRpb24ubGlnaHRtYXBwZXIuX3N0YXRzO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcImJhdGNoZXJcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gcGMuQXBwbGljYXRpb24uX2N1cnJlbnRBcHBsaWNhdGlvbi5iYXRjaGVyLl9zdGF0cztcbiAgfX0pO1xuICBwYy5ldmVudHMuYXR0YWNoKHRoaXMpO1xufTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDb21wb25lbnRTeXN0ZW1SZWdpc3RyeSA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBDb21wb25lbnRTeXN0ZW1SZWdpc3RyeS5wcm90b3R5cGUgPSB7YWRkOmZ1bmN0aW9uKG5hbWUsIHN5c3RlbSkge1xuICAgIGlmICghdGhpc1tuYW1lXSkge1xuICAgICAgdGhpc1tuYW1lXSA9IHN5c3RlbTtcbiAgICAgIHN5c3RlbS5uYW1lID0gbmFtZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKHBjLnN0cmluZy5mb3JtYXQoXCJDb21wb25lbnRTeXN0ZW0gbmFtZSAnezB9JyBhbHJlYWR5IHJlZ2lzdGVyZWQgb3Igbm90IGFsbG93ZWRcIiwgbmFtZSkpO1xuICAgIH1cbiAgfSwgcmVtb3ZlOmZ1bmN0aW9uKG5hbWUpIHtcbiAgICBpZiAoIXRoaXNbbmFtZV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihwYy5zdHJpbmcuZm9ybWF0KFwiTm8gQ29tcG9uZW50U3lzdGVtIG5hbWVkICd7MH0nIHJlZ2lzdGVyZWRcIiwgbmFtZSkpO1xuICAgIH1cbiAgICBkZWxldGUgdGhpc1tuYW1lXTtcbiAgfSwgbGlzdDpmdW5jdGlvbigpIHtcbiAgICB2YXIgbGlzdCA9IE9iamVjdC5rZXlzKHRoaXMpO1xuICAgIHZhciBkZWZhdWx0UHJpb3JpdHkgPSAxO1xuICAgIHZhciBwcmlvcml0aWVzID0ge1wiY29sbGlzaW9ucmVjdFwiOjAuNSwgXCJjb2xsaXNpb25jaXJjbGVcIjowLjV9O1xuICAgIGxpc3Quc29ydChmdW5jdGlvbihhLCBiKSB7XG4gICAgICB2YXIgcGEgPSBwcmlvcml0aWVzW2FdIHx8IGRlZmF1bHRQcmlvcml0eTtcbiAgICAgIHZhciBwYiA9IHByaW9yaXRpZXNbYl0gfHwgZGVmYXVsdFByaW9yaXR5O1xuICAgICAgaWYgKHBhIDwgcGIpIHtcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHBhID4gcGIpIHtcbiAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIDA7XG4gICAgfSk7XG4gICAgcmV0dXJuIGxpc3QubWFwKGZ1bmN0aW9uKGtleSkge1xuICAgICAgcmV0dXJuIHRoaXNba2V5XTtcbiAgICB9LCB0aGlzKTtcbiAgfSwgZ2V0Q29tcG9uZW50U3lzdGVtT3JkZXI6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGluZGV4O1xuICAgIHZhciBuYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMpO1xuICAgIGluZGV4ID0gbmFtZXMuaW5kZXhPZihcImNvbGxpc2lvbnJlY3RcIik7XG4gICAgbmFtZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICBuYW1lcy51bnNoaWZ0KFwiY29sbGlzaW9ucmVjdFwiKTtcbiAgICBpbmRleCA9IG5hbWVzLmluZGV4T2YoXCJjb2xsaXNpb25jaXJjbGVcIik7XG4gICAgbmFtZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICBuYW1lcy51bnNoaWZ0KFwiY29sbGlzaW9uY2lyY2xlXCIpO1xuICAgIHJldHVybiBuYW1lcztcbiAgfX07XG4gIHJldHVybiB7Q29tcG9uZW50U3lzdGVtUmVnaXN0cnk6Q29tcG9uZW50U3lzdGVtUmVnaXN0cnl9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDb21wb25lbnRTeXN0ZW0gPSBmdW5jdGlvbihhcHApIHtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLmRhdGFTdG9yZSA9IHt9O1xuICAgIHRoaXMuc2NoZW1hID0gW107XG4gICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgfTtcbiAgcGMuZXh0ZW5kKENvbXBvbmVudFN5c3RlbSwge2luaXRpYWxpemU6ZnVuY3Rpb24ocm9vdCkge1xuICAgIENvbXBvbmVudFN5c3RlbS5maXJlKFwiaW5pdGlhbGl6ZVwiLCByb290KTtcbiAgfSwgcG9zdEluaXRpYWxpemU6ZnVuY3Rpb24ocm9vdCkge1xuICAgIENvbXBvbmVudFN5c3RlbS5maXJlKFwicG9zdEluaXRpYWxpemVcIiwgcm9vdCk7XG4gIH0sIHVwZGF0ZTpmdW5jdGlvbihkdCwgaW5Ub29scykge1xuICAgIGlmIChpblRvb2xzKSB7XG4gICAgICBDb21wb25lbnRTeXN0ZW0uZmlyZShcInRvb2xzVXBkYXRlXCIsIGR0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgQ29tcG9uZW50U3lzdGVtLmZpcmUoXCJ1cGRhdGVcIiwgZHQpO1xuICAgIH1cbiAgfSwgZml4ZWRVcGRhdGU6ZnVuY3Rpb24oZHQsIGluVG9vbHMpIHtcbiAgICBDb21wb25lbnRTeXN0ZW0uZmlyZShcImZpeGVkVXBkYXRlXCIsIGR0KTtcbiAgfSwgcG9zdFVwZGF0ZTpmdW5jdGlvbihkdCwgaW5Ub29scykge1xuICAgIENvbXBvbmVudFN5c3RlbS5maXJlKFwicG9zdFVwZGF0ZVwiLCBkdCk7XG4gIH19KTtcbiAgQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSA9IHtnZXQgc3RvcmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVN0b3JlO1xuICB9LCBhZGRDb21wb25lbnQ6ZnVuY3Rpb24oZW50aXR5LCBkYXRhKSB7XG4gICAgdmFyIGNvbXBvbmVudCA9IG5ldyB0aGlzLkNvbXBvbmVudFR5cGUodGhpcywgZW50aXR5KTtcbiAgICB2YXIgY29tcG9uZW50RGF0YSA9IG5ldyB0aGlzLkRhdGFUeXBlO1xuICAgIGRhdGEgPSBkYXRhIHx8IHt9O1xuICAgIHRoaXMuZGF0YVN0b3JlW2VudGl0eS5fZ3VpZF0gPSB7ZW50aXR5OmVudGl0eSwgZGF0YTpjb21wb25lbnREYXRhfTtcbiAgICBlbnRpdHlbdGhpcy5pZF0gPSBjb21wb25lbnQ7XG4gICAgZW50aXR5LmNbdGhpcy5pZF0gPSBjb21wb25lbnQ7XG4gICAgdGhpcy5pbml0aWFsaXplQ29tcG9uZW50RGF0YShjb21wb25lbnQsIGRhdGEsIFtdKTtcbiAgICB0aGlzLmZpcmUoXCJhZGRcIiwgZW50aXR5LCBjb21wb25lbnQpO1xuICAgIHJldHVybiBjb21wb25lbnQ7XG4gIH0sIHJlbW92ZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHkpIHtcbiAgICB2YXIgcmVjb3JkID0gdGhpcy5kYXRhU3RvcmVbZW50aXR5Ll9ndWlkXTtcbiAgICB2YXIgY29tcG9uZW50ID0gZW50aXR5LmNbdGhpcy5pZF07XG4gICAgdGhpcy5maXJlKFwiYmVmb3JlcmVtb3ZlXCIsIGVudGl0eSwgY29tcG9uZW50KTtcbiAgICBkZWxldGUgdGhpcy5kYXRhU3RvcmVbZW50aXR5Ll9ndWlkXTtcbiAgICBkZWxldGUgZW50aXR5W3RoaXMuaWRdO1xuICAgIGRlbGV0ZSBlbnRpdHkuY1t0aGlzLmlkXTtcbiAgICB0aGlzLmZpcmUoXCJyZW1vdmVcIiwgZW50aXR5LCByZWNvcmQuZGF0YSk7XG4gIH0sIGNsb25lQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY2xvbmUpIHtcbiAgICB2YXIgc3JjID0gdGhpcy5kYXRhU3RvcmVbZW50aXR5Ll9ndWlkXTtcbiAgICByZXR1cm4gdGhpcy5hZGRDb21wb25lbnQoY2xvbmUsIHNyYy5kYXRhKTtcbiAgfSwgaW5pdGlhbGl6ZUNvbXBvbmVudERhdGE6ZnVuY3Rpb24oY29tcG9uZW50LCBkYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgZGF0YSA9IGRhdGEgfHwge307XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICBpZiAoZGF0YVt2YWx1ZV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb21wb25lbnRbdmFsdWVdID0gZGF0YVt2YWx1ZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb21wb25lbnRbdmFsdWVdID0gY29tcG9uZW50LmRhdGFbdmFsdWVdO1xuICAgICAgfVxuICAgIH0sIHRoaXMpO1xuICAgIGlmIChjb21wb25lbnQuZW5hYmxlZCAmJiBjb21wb25lbnQuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgIGNvbXBvbmVudC5vbkVuYWJsZSgpO1xuICAgIH1cbiAgfX07XG4gIHBjLmV2ZW50cy5hdHRhY2goQ29tcG9uZW50U3lzdGVtKTtcbiAgQ29tcG9uZW50U3lzdGVtLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgICBDb21wb25lbnRTeXN0ZW0ub2ZmKFwiaW5pdGlhbGl6ZVwiKTtcbiAgICBDb21wb25lbnRTeXN0ZW0ub2ZmKFwicG9zdEluaXRpYWxpemVcIik7XG4gICAgQ29tcG9uZW50U3lzdGVtLm9mZihcInRvb2xzVXBkYXRlXCIpO1xuICAgIENvbXBvbmVudFN5c3RlbS5vZmYoXCJ1cGRhdGVcIik7XG4gICAgQ29tcG9uZW50U3lzdGVtLm9mZihcImZpeGVkVXBkYXRlXCIpO1xuICAgIENvbXBvbmVudFN5c3RlbS5vZmYoXCJwb3N0VXBkYXRlXCIpO1xuICB9O1xuICByZXR1cm4ge0NvbXBvbmVudFN5c3RlbTpDb21wb25lbnRTeXN0ZW19O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDb21wb25lbnQgPSBmdW5jdGlvbihzeXN0ZW0sIGVudGl0eSkge1xuICAgIHRoaXMuc3lzdGVtID0gc3lzdGVtO1xuICAgIHRoaXMuZW50aXR5ID0gZW50aXR5O1xuICAgIHBjLmV2ZW50cy5hdHRhY2godGhpcyk7XG4gICAgaWYgKHRoaXMuc3lzdGVtLnNjaGVtYSAmJiAhdGhpcy5fYWNjZXNzb3JzQnVpbHQpIHtcbiAgICAgIHRoaXMuYnVpbGRBY2Nlc3NvcnModGhpcy5zeXN0ZW0uc2NoZW1hKTtcbiAgICB9XG4gICAgdGhpcy5vbihcInNldFwiLCBmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICAgIHRoaXMuZmlyZShcInNldF9cIiArIG5hbWUsIG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSk7XG4gICAgfSk7XG4gICAgdGhpcy5vbihcInNldF9lbmFibGVkXCIsIHRoaXMub25TZXRFbmFibGVkLCB0aGlzKTtcbiAgfTtcbiAgQ29tcG9uZW50Ll9idWlsZEFjY2Vzc29ycyA9IGZ1bmN0aW9uKG9iaiwgc2NoZW1hKSB7XG4gICAgc2NoZW1hLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtwcm9wXTtcbiAgICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgICAgdmFyIG9sZFZhbHVlID0gZGF0YVtwcm9wXTtcbiAgICAgICAgZGF0YVtwcm9wXSA9IHZhbHVlO1xuICAgICAgICB0aGlzLmZpcmUoXCJzZXRcIiwgcHJvcCwgb2xkVmFsdWUsIHZhbHVlKTtcbiAgICAgIH0sIGNvbmZpZ3VyYWJsZTp0cnVlfSk7XG4gICAgfSk7XG4gICAgb2JqLl9hY2Nlc3NvcnNCdWlsdCA9IHRydWU7XG4gIH07XG4gIENvbXBvbmVudC5wcm90b3R5cGUgPSB7Z2V0IGRhdGEoKSB7XG4gICAgdmFyIHJlY29yZCA9IHRoaXMuc3lzdGVtLnN0b3JlW3RoaXMuZW50aXR5Ll9ndWlkXTtcbiAgICBpZiAocmVjb3JkKSB7XG4gICAgICByZXR1cm4gcmVjb3JkLmRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfSwgYnVpbGRBY2Nlc3NvcnM6ZnVuY3Rpb24oc2NoZW1hKSB7XG4gICAgQ29tcG9uZW50Ll9idWlsZEFjY2Vzc29ycyh0aGlzLCBzY2hlbWEpO1xuICB9LCBvblNldEVuYWJsZWQ6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkge1xuICAgICAgaWYgKHRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgaWYgKG5ld1ZhbHVlKSB7XG4gICAgICAgICAgdGhpcy5vbkVuYWJsZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMub25EaXNhYmxlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICB9LCBvbkRpc2FibGU6ZnVuY3Rpb24oKSB7XG4gIH0sIG9uUG9zdFN0YXRlQ2hhbmdlOmZ1bmN0aW9uKCkge1xuICB9fTtcbiAgcmV0dXJuIHtDb21wb25lbnQ6Q29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICByZXR1cm4ge0NvbXBvbmVudERhdGE6Q29tcG9uZW50RGF0YX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEFuaW1hdGlvbkNvbXBvbmVudCA9IGZ1bmN0aW9uKHN5c3RlbSwgZW50aXR5KSB7XG4gICAgdGhpcy5hbmltYXRpb25zSW5kZXggPSB7fTtcbiAgICB0aGlzLm9uKFwic2V0X2FuaW1hdGlvbnNcIiwgdGhpcy5vblNldEFuaW1hdGlvbnMsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfYXNzZXRzXCIsIHRoaXMub25TZXRBc3NldHMsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfbG9vcFwiLCB0aGlzLm9uU2V0TG9vcCwgdGhpcyk7XG4gIH07XG4gIEFuaW1hdGlvbkNvbXBvbmVudCA9IHBjLmluaGVyaXRzKEFuaW1hdGlvbkNvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKEFuaW1hdGlvbkNvbXBvbmVudC5wcm90b3R5cGUsIHtwbGF5OmZ1bmN0aW9uKG5hbWUsIGJsZW5kVGltZSkge1xuICAgIGlmICghdGhpcy5kYXRhLmFuaW1hdGlvbnNbbmFtZV0pIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IocGMuc3RyaW5nLmZvcm1hdChcIlRyeWluZyB0byBwbGF5IGFuaW1hdGlvbiAnezB9JyB3aGljaCBkb2Vzbid0IGV4aXN0XCIsIG5hbWUpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYmxlbmRUaW1lID0gYmxlbmRUaW1lIHx8IDA7XG4gICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgZGF0YS5wcmV2QW5pbSA9IGRhdGEuY3VyckFuaW07XG4gICAgZGF0YS5jdXJyQW5pbSA9IG5hbWU7XG4gICAgaWYgKGRhdGEubW9kZWwpIHtcbiAgICAgIGRhdGEuYmxlbmRpbmcgPSBibGVuZFRpbWUgPiAwICYmIGRhdGEucHJldkFuaW07XG4gICAgICBpZiAoZGF0YS5ibGVuZGluZykge1xuICAgICAgICBkYXRhLmJsZW5kVGltZSA9IGJsZW5kVGltZTtcbiAgICAgICAgZGF0YS5ibGVuZFRpbWVSZW1haW5pbmcgPSBibGVuZFRpbWU7XG4gICAgICAgIGRhdGEuZnJvbVNrZWwuYW5pbWF0aW9uID0gZGF0YS5hbmltYXRpb25zW2RhdGEucHJldkFuaW1dO1xuICAgICAgICBkYXRhLmZyb21Ta2VsLmFkZFRpbWUoZGF0YS5za2VsZXRvbi5fdGltZSk7XG4gICAgICAgIGRhdGEudG9Ta2VsLmFuaW1hdGlvbiA9IGRhdGEuYW5pbWF0aW9uc1tkYXRhLmN1cnJBbmltXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEuc2tlbGV0b24uYW5pbWF0aW9uID0gZGF0YS5hbmltYXRpb25zW2RhdGEuY3VyckFuaW1dO1xuICAgICAgfVxuICAgIH1cbiAgICBkYXRhLnBsYXlpbmcgPSB0cnVlO1xuICB9LCBnZXRBbmltYXRpb246ZnVuY3Rpb24obmFtZSkge1xuICAgIHJldHVybiB0aGlzLmRhdGEuYW5pbWF0aW9uc1tuYW1lXTtcbiAgfSwgc2V0TW9kZWw6ZnVuY3Rpb24obW9kZWwpIHtcbiAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIHZhciBncmFwaCA9IG1vZGVsLmdldEdyYXBoKCk7XG4gICAgICBkYXRhLmZyb21Ta2VsID0gbmV3IHBjLlNrZWxldG9uKGdyYXBoKTtcbiAgICAgIGRhdGEudG9Ta2VsID0gbmV3IHBjLlNrZWxldG9uKGdyYXBoKTtcbiAgICAgIGRhdGEuc2tlbGV0b24gPSBuZXcgcGMuU2tlbGV0b24oZ3JhcGgpO1xuICAgICAgZGF0YS5za2VsZXRvbi5sb29waW5nID0gZGF0YS5sb29wO1xuICAgICAgZGF0YS5za2VsZXRvbi5zZXRHcmFwaChncmFwaCk7XG4gICAgfVxuICAgIGRhdGEubW9kZWwgPSBtb2RlbDtcbiAgICBpZiAoZGF0YS5hbmltYXRpb25zICYmIGRhdGEuY3VyckFuaW0gJiYgZGF0YS5hbmltYXRpb25zW2RhdGEuY3VyckFuaW1dKSB7XG4gICAgICB0aGlzLnBsYXkoZGF0YS5jdXJyQW5pbSk7XG4gICAgfVxuICB9LCBsb2FkQW5pbWF0aW9uQXNzZXRzOmZ1bmN0aW9uKGlkcykge1xuICAgIGlmICghaWRzIHx8ICFpZHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cztcbiAgICB2YXIgaSwgbCA9IGlkcy5sZW5ndGg7XG4gICAgdmFyIG9uQXNzZXRSZWFkeSA9IGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICBzZWxmLmFuaW1hdGlvbnNbYXNzZXQubmFtZV0gPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgIHNlbGYuYW5pbWF0aW9uc0luZGV4W2Fzc2V0LmlkXSA9IGFzc2V0Lm5hbWU7XG4gICAgICBzZWxmLmFuaW1hdGlvbnMgPSBzZWxmLmFuaW1hdGlvbnM7XG4gICAgfTtcbiAgICB2YXIgb25Bc3NldEFkZCA9IGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICBhc3NldC5vZmYoXCJjaGFuZ2VcIiwgc2VsZi5vbkFzc2V0Q2hhbmdlZCwgc2VsZik7XG4gICAgICBhc3NldC5vbihcImNoYW5nZVwiLCBzZWxmLm9uQXNzZXRDaGFuZ2VkLCBzZWxmKTtcbiAgICAgIGFzc2V0Lm9mZihcInJlbW92ZVwiLCBzZWxmLm9uQXNzZXRSZW1vdmVkLCBzZWxmKTtcbiAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHNlbGYub25Bc3NldFJlbW92ZWQsIHNlbGYpO1xuICAgICAgaWYgKGFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgIG9uQXNzZXRSZWFkeShhc3NldCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NldC5vbmNlKFwibG9hZFwiLCBvbkFzc2V0UmVhZHksIHNlbGYpO1xuICAgICAgICBpZiAoc2VsZi5lbmFibGVkICYmIHNlbGYuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIGZvciAoaSA9IDA7aSA8IGw7aSsrKSB7XG4gICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KGlkc1tpXSk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgb25Bc3NldEFkZChhc3NldCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NldHMub24oXCJhZGQ6XCIgKyBpZHNbaV0sIG9uQXNzZXRBZGQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25Bc3NldENoYW5nZWQ6ZnVuY3Rpb24oYXNzZXQsIGF0dHJpYnV0ZSwgbmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgaWYgKGF0dHJpYnV0ZSA9PT0gXCJyZXNvdXJjZVwiKSB7XG4gICAgICBpZiAobmV3VmFsdWUpIHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25zW2Fzc2V0Lm5hbWVdID0gbmV3VmFsdWU7XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uc0luZGV4W2Fzc2V0LmlkXSA9IGFzc2V0Lm5hbWU7XG4gICAgICAgIGlmICh0aGlzLmRhdGEuY3VyckFuaW0gPT09IGFzc2V0Lm5hbWUpIHtcbiAgICAgICAgICBpZiAodGhpcy5kYXRhLnBsYXlpbmcgJiYgdGhpcy5kYXRhLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5wbGF5KGFzc2V0Lm5hbWUsIDApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuYW5pbWF0aW9uc1thc3NldC5uYW1lXTtcbiAgICAgICAgZGVsZXRlIHRoaXMuYW5pbWF0aW9uc0luZGV4W2Fzc2V0LmlkXTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uQXNzZXRSZW1vdmVkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgIGlmICh0aGlzLmFuaW1hdGlvbnMgJiYgdGhpcy5hbmltYXRpb25zW2Fzc2V0Lm5hbWVdKSB7XG4gICAgICBkZWxldGUgdGhpcy5hbmltYXRpb25zW2Fzc2V0Lm5hbWVdO1xuICAgICAgZGVsZXRlIHRoaXMuYW5pbWF0aW9uc0luZGV4W2Fzc2V0LmlkXTtcbiAgICAgIGlmICh0aGlzLmRhdGEuY3VyckFuaW0gPT09IGFzc2V0Lm5hbWUpIHtcbiAgICAgICAgdGhpcy5fc3RvcEN1cnJlbnRBbmltYXRpb24oKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9zdG9wQ3VycmVudEFuaW1hdGlvbjpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmRhdGEuY3VyckFuaW0gPSBudWxsO1xuICAgIHRoaXMuZGF0YS5wbGF5aW5nID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuZGF0YS5za2VsZXRvbikge1xuICAgICAgdGhpcy5kYXRhLnNrZWxldG9uLmN1cnJlbnRUaW1lID0gMDtcbiAgICAgIHRoaXMuZGF0YS5za2VsZXRvbi5hbmltYXRpb24gPSBudWxsO1xuICAgIH1cbiAgfSwgb25TZXRBbmltYXRpb25zOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgIHZhciBtb2RlbENvbXBvbmVudCA9IHRoaXMuZW50aXR5Lm1vZGVsO1xuICAgIGlmIChtb2RlbENvbXBvbmVudCkge1xuICAgICAgdmFyIG0gPSBtb2RlbENvbXBvbmVudC5tb2RlbDtcbiAgICAgIGlmIChtICYmIG0gIT09IGRhdGEubW9kZWwpIHtcbiAgICAgICAgdGhpcy5lbnRpdHkuYW5pbWF0aW9uLnNldE1vZGVsKG0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWRhdGEuY3VyckFuaW0gJiYgZGF0YS5hY3RpdmF0ZSAmJiBkYXRhLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgZm9yICh2YXIgYW5pbU5hbWUgaW4gZGF0YS5hbmltYXRpb25zKSB7XG4gICAgICAgIHRoaXMucGxheShhbmltTmFtZSwgMCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRBc3NldHM6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICYmIG9sZFZhbHVlLmxlbmd0aCkge1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG9sZFZhbHVlLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYgKG9sZFZhbHVlW2ldKSB7XG4gICAgICAgICAgdmFyIGFzc2V0ID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQob2xkVmFsdWVbaV0pO1xuICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgYXNzZXQub2ZmKFwiY2hhbmdlXCIsIHRoaXMub25Bc3NldENoYW5nZWQsIHRoaXMpO1xuICAgICAgICAgICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgICAgICAgICAgdmFyIGFuaW1OYW1lID0gdGhpcy5hbmltYXRpb25zSW5kZXhbYXNzZXQuaWRdO1xuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS5jdXJyQW5pbSA9PT0gYW5pbU5hbWUpIHtcbiAgICAgICAgICAgICAgdGhpcy5fc3RvcEN1cnJlbnRBbmltYXRpb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFuaW1hdGlvbnNbYW5pbU5hbWVdO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuYW5pbWF0aW9uc0luZGV4W2Fzc2V0LmlkXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGlkcyA9IG5ld1ZhbHVlLm1hcChmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgcGMuQXNzZXQpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlLmlkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMubG9hZEFuaW1hdGlvbkFzc2V0cyhpZHMpO1xuICB9LCBvblNldExvb3A6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZGF0YS5za2VsZXRvbikge1xuICAgICAgdGhpcy5kYXRhLnNrZWxldG9uLmxvb3BpbmcgPSB0aGlzLmRhdGEubG9vcDtcbiAgICB9XG4gIH0sIG9uU2V0Q3VycmVudFRpbWU6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5kYXRhLnNrZWxldG9uLmN1cnJlbnRUaW1lID0gbmV3VmFsdWU7XG4gICAgdGhpcy5kYXRhLnNrZWxldG9uLmFkZFRpbWUoMCk7XG4gICAgdGhpcy5kYXRhLnNrZWxldG9uLnVwZGF0ZUdyYXBoKCk7XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIEFuaW1hdGlvbkNvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5kYXRhLmFzc2V0cztcbiAgICB2YXIgcmVnaXN0cnkgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIGlmIChhc3NldHMpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhc3NldHMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIHZhciBhc3NldCA9IGFzc2V0c1tpXTtcbiAgICAgICAgaWYgKCEoYXNzZXQgaW5zdGFuY2VvZiBwYy5Bc3NldCkpIHtcbiAgICAgICAgICBhc3NldCA9IHJlZ2lzdHJ5LmdldChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFzc2V0ICYmICFhc3NldC5yZXNvdXJjZSkge1xuICAgICAgICAgIHJlZ2lzdHJ5LmxvYWQoYXNzZXQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmRhdGEuYWN0aXZhdGUgJiYgIXRoaXMuZGF0YS5jdXJyQW5pbSkge1xuICAgICAgZm9yICh2YXIgYW5pbU5hbWUgaW4gdGhpcy5kYXRhLmFuaW1hdGlvbnMpIHtcbiAgICAgICAgdGhpcy5wbGF5KGFuaW1OYW1lLCAwKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkJlZm9yZVJlbW92ZTpmdW5jdGlvbigpIHtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5hc3NldHMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIGFzc2V0ID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQodGhpcy5hc3NldHNbaV0pO1xuICAgICAgaWYgKCFhc3NldCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGFzc2V0Lm9mZihcImNoYW5nZVwiLCB0aGlzLm9uQXNzZXRDaGFuZ2VkLCB0aGlzKTtcbiAgICAgIGFzc2V0Lm9mZihcInJlbW92ZVwiLCB0aGlzLm9uQXNzZXRSZW1vdmVkLCB0aGlzKTtcbiAgICB9XG4gICAgZGVsZXRlIHRoaXMuZGF0YS5hbmltYXRpb247XG4gICAgZGVsZXRlIHRoaXMuZGF0YS5za2VsZXRvbjtcbiAgICBkZWxldGUgdGhpcy5kYXRhLmZyb21Ta2VsO1xuICAgIGRlbGV0ZSB0aGlzLmRhdGEudG9Ta2VsO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEFuaW1hdGlvbkNvbXBvbmVudC5wcm90b3R5cGUsIHtjdXJyZW50VGltZTp7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGEuc2tlbGV0b24uX3RpbWU7XG4gIH0sIHNldDpmdW5jdGlvbihjdXJyZW50VGltZSkge1xuICAgIHRoaXMuZGF0YS5za2VsZXRvbi5jdXJyZW50VGltZSA9IGN1cnJlbnRUaW1lO1xuICAgIHRoaXMuZGF0YS5za2VsZXRvbi5hZGRUaW1lKDApO1xuICAgIHRoaXMuZGF0YS5za2VsZXRvbi51cGRhdGVHcmFwaCgpO1xuICB9fSwgZHVyYXRpb246e2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmFuaW1hdGlvbnNbdGhpcy5kYXRhLmN1cnJBbmltXS5kdXJhdGlvbjtcbiAgfX19KTtcbiAgcmV0dXJuIHtBbmltYXRpb25Db21wb25lbnQ6QW5pbWF0aW9uQ29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3NjaGVtYSA9IFtcImVuYWJsZWRcIiwgXCJhc3NldHNcIiwgXCJzcGVlZFwiLCBcImxvb3BcIiwgXCJhY3RpdmF0ZVwiLCBcImFuaW1hdGlvbnNcIiwgXCJza2VsZXRvblwiLCBcIm1vZGVsXCIsIFwicHJldkFuaW1cIiwgXCJjdXJyQW5pbVwiLCBcImZyb21Ta2VsXCIsIFwidG9Ta2VsXCIsIFwiYmxlbmRpbmdcIiwgXCJibGVuZFRpbWVSZW1haW5pbmdcIiwgXCJwbGF5aW5nXCJdO1xuICB2YXIgQW5pbWF0aW9uQ29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24gQW5pbWF0aW9uQ29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcImFuaW1hdGlvblwiO1xuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBcIlNwZWNpZmllcyB0aGUgYW5pbWF0aW9uIGFzc2V0cyB0aGF0IGNhbiBydW4gb24gdGhlIG1vZGVsIHNwZWNpZmllZCBieSB0aGUgRW50aXR5J3MgbW9kZWwgQ29tcG9uZW50LlwiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5BbmltYXRpb25Db21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLkFuaW1hdGlvbkNvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMub24oXCJiZWZvcmVyZW1vdmVcIiwgdGhpcy5vbkJlZm9yZVJlbW92ZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInVwZGF0ZVwiLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJ1cGRhdGVcIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gIH07XG4gIEFuaW1hdGlvbkNvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKEFuaW1hdGlvbkNvbXBvbmVudFN5c3RlbSwgcGMuQ29tcG9uZW50U3lzdGVtKTtcbiAgcGMuQ29tcG9uZW50Ll9idWlsZEFjY2Vzc29ycyhwYy5BbmltYXRpb25Db21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKEFuaW1hdGlvbkNvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpIHtcbiAgICBwcm9wZXJ0aWVzID0gW1wiYWN0aXZhdGVcIiwgXCJlbmFibGVkXCIsIFwibG9vcFwiLCBcInNwZWVkXCIsIFwiYXNzZXRzXCJdO1xuICAgIEFuaW1hdGlvbkNvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIGtleTtcbiAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5hZGRDb21wb25lbnQoY2xvbmUsIHt9KTtcbiAgICBjbG9uZS5hbmltYXRpb24uZGF0YS5hc3NldHMgPSBwYy5leHRlbmQoW10sIGVudGl0eS5hbmltYXRpb24uYXNzZXRzKTtcbiAgICBjbG9uZS5hbmltYXRpb24uZGF0YS5zcGVlZCA9IGVudGl0eS5hbmltYXRpb24uc3BlZWQ7XG4gICAgY2xvbmUuYW5pbWF0aW9uLmRhdGEubG9vcCA9IGVudGl0eS5hbmltYXRpb24ubG9vcDtcbiAgICBjbG9uZS5hbmltYXRpb24uZGF0YS5hY3RpdmF0ZSA9IGVudGl0eS5hbmltYXRpb24uYWN0aXZhdGU7XG4gICAgY2xvbmUuYW5pbWF0aW9uLmRhdGEuZW5hYmxlZCA9IGVudGl0eS5hbmltYXRpb24uZW5hYmxlZDtcbiAgICB2YXIgY2xvbmVkQW5pbWF0aW9ucyA9IHt9O1xuICAgIHZhciBhbmltYXRpb25zID0gZW50aXR5LmFuaW1hdGlvbi5hbmltYXRpb25zO1xuICAgIGZvciAoa2V5IGluIGFuaW1hdGlvbnMpIHtcbiAgICAgIGlmIChhbmltYXRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgY2xvbmVkQW5pbWF0aW9uc1trZXldID0gYW5pbWF0aW9uc1trZXldO1xuICAgICAgfVxuICAgIH1cbiAgICBjbG9uZS5hbmltYXRpb24uYW5pbWF0aW9ucyA9IGNsb25lZEFuaW1hdGlvbnM7XG4gICAgdmFyIGNsb25lZEFuaW1hdGlvbnNJbmRleCA9IHt9O1xuICAgIHZhciBhbmltYXRpb25zSW5kZXggPSBlbnRpdHkuYW5pbWF0aW9uLmFuaW1hdGlvbnNJbmRleDtcbiAgICBmb3IgKGtleSBpbiBhbmltYXRpb25zSW5kZXgpIHtcbiAgICAgIGlmIChhbmltYXRpb25zSW5kZXguaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjbG9uZWRBbmltYXRpb25zSW5kZXhba2V5XSA9IGFuaW1hdGlvbnNJbmRleFtrZXldO1xuICAgICAgfVxuICAgIH1cbiAgICBjbG9uZS5hbmltYXRpb24uYW5pbWF0aW9uc0luZGV4ID0gY2xvbmVkQW5pbWF0aW9uc0luZGV4O1xuICB9LCBvbkJlZm9yZVJlbW92ZTpmdW5jdGlvbihlbnRpdHksIGNvbXBvbmVudCkge1xuICAgIGNvbXBvbmVudC5vbkJlZm9yZVJlbW92ZSgpO1xuICB9LCBvblVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHZhciBjb21wb25lbnRzID0gdGhpcy5zdG9yZTtcbiAgICBmb3IgKHZhciBpZCBpbiBjb21wb25lbnRzKSB7XG4gICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShpZCkpIHtcbiAgICAgICAgdmFyIGNvbXBvbmVudCA9IGNvbXBvbmVudHNbaWRdO1xuICAgICAgICB2YXIgY29tcG9uZW50RGF0YSA9IGNvbXBvbmVudC5kYXRhO1xuICAgICAgICBpZiAoY29tcG9uZW50RGF0YS5lbmFibGVkICYmIGNvbXBvbmVudERhdGEucGxheWluZyAmJiBjb21wb25lbnQuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICB2YXIgc2tlbGV0b24gPSBjb21wb25lbnREYXRhLnNrZWxldG9uO1xuICAgICAgICAgIGlmIChza2VsZXRvbiAhPT0gbnVsbCAmJiBjb21wb25lbnREYXRhLm1vZGVsICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoY29tcG9uZW50RGF0YS5ibGVuZGluZykge1xuICAgICAgICAgICAgICBjb21wb25lbnREYXRhLmJsZW5kVGltZVJlbWFpbmluZyAtPSBkdDtcbiAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudERhdGEuYmxlbmRUaW1lUmVtYWluaW5nIDwgMC4wKSB7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YS5ibGVuZFRpbWVSZW1haW5pbmcgPSAwLjA7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgdmFyIGFscGhhID0gMS4wIC0gY29tcG9uZW50RGF0YS5ibGVuZFRpbWVSZW1haW5pbmcgLyBjb21wb25lbnREYXRhLmJsZW5kVGltZTtcbiAgICAgICAgICAgICAgc2tlbGV0b24uYmxlbmQoY29tcG9uZW50RGF0YS5mcm9tU2tlbCwgY29tcG9uZW50RGF0YS50b1NrZWwsIGFscGhhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHZhciBkZWx0YSA9IGR0ICogY29tcG9uZW50RGF0YS5zcGVlZDtcbiAgICAgICAgICAgICAgc2tlbGV0b24uYWRkVGltZShkZWx0YSk7XG4gICAgICAgICAgICAgIGlmIChza2VsZXRvbi5fdGltZSA9PT0gc2tlbGV0b24uX2FuaW1hdGlvbi5kdXJhdGlvbiAmJiAhY29tcG9uZW50RGF0YS5sb29wKSB7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50RGF0YS5wbGF5aW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb21wb25lbnREYXRhLmJsZW5kaW5nICYmIGNvbXBvbmVudERhdGEuYmxlbmRUaW1lUmVtYWluaW5nID09PSAwLjApIHtcbiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YS5ibGVuZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICBza2VsZXRvbi5hbmltYXRpb24gPSBjb21wb25lbnREYXRhLnRvU2tlbC5fYW5pbWF0aW9uO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2tlbGV0b24udXBkYXRlR3JhcGgoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtBbmltYXRpb25Db21wb25lbnRTeXN0ZW06QW5pbWF0aW9uQ29tcG9uZW50U3lzdGVtfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQW5pbWF0aW9uQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuYXNzZXRzID0gW107XG4gICAgdGhpcy5zcGVlZCA9IDEuMDtcbiAgICB0aGlzLmxvb3AgPSB0cnVlO1xuICAgIHRoaXMuYWN0aXZhdGUgPSB0cnVlO1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gICAgdGhpcy5hbmltYXRpb25zID0ge307XG4gICAgdGhpcy5za2VsZXRvbiA9IG51bGw7XG4gICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5wcmV2QW5pbSA9IG51bGw7XG4gICAgdGhpcy5jdXJyQW5pbSA9IG51bGw7XG4gICAgdGhpcy5mcm9tU2tlbCA9IG51bGw7XG4gICAgdGhpcy50b1NrZWwgPSBudWxsO1xuICAgIHRoaXMuYmxlbmRpbmcgPSBmYWxzZTtcbiAgICB0aGlzLmJsZW5kVGltZSA9IDA7XG4gICAgdGhpcy5ibGVuZFRpbWVSZW1haW5pbmcgPSAwO1xuICAgIHRoaXMucGxheWluZyA9IGZhbHNlO1xuICB9O1xuICBBbmltYXRpb25Db21wb25lbnREYXRhID0gcGMuaW5oZXJpdHMoQW5pbWF0aW9uQ29tcG9uZW50RGF0YSwgcGMuQ29tcG9uZW50RGF0YSk7XG4gIHJldHVybiB7QW5pbWF0aW9uQ29tcG9uZW50RGF0YTpBbmltYXRpb25Db21wb25lbnREYXRhfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgTW9kZWxDb21wb25lbnQgPSBmdW5jdGlvbiBNb2RlbENvbXBvbmVudChzeXN0ZW0sIGVudGl0eSkge1xuICAgIHRoaXMub24oXCJzZXRfdHlwZVwiLCB0aGlzLm9uU2V0VHlwZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9hc3NldFwiLCB0aGlzLm9uU2V0QXNzZXQsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfY2FzdFNoYWRvd3NcIiwgdGhpcy5vblNldENhc3RTaGFkb3dzLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X3JlY2VpdmVTaGFkb3dzXCIsIHRoaXMub25TZXRSZWNlaXZlU2hhZG93cywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jYXN0U2hhZG93c0xpZ2h0bWFwXCIsIHRoaXMub25TZXRDYXN0U2hhZG93c0xpZ2h0bWFwLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2xpZ2h0bWFwcGVkXCIsIHRoaXMub25TZXRMaWdodG1hcHBlZCwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9saWdodG1hcFNpemVNdWx0aXBsaWVyXCIsIHRoaXMub25TZXRMaWdodG1hcFNpemVNdWx0aXBsaWVyLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2lzU3RhdGljXCIsIHRoaXMub25TZXRJc1N0YXRpYywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9tb2RlbFwiLCB0aGlzLm9uU2V0TW9kZWwsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfbWF0ZXJpYWxcIiwgdGhpcy5vblNldE1hdGVyaWFsLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X21hcHBpbmdcIiwgdGhpcy5vblNldE1hcHBpbmcsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfYmF0Y2hHcm91cElkXCIsIHRoaXMub25TZXRCYXRjaEdyb3VwSWQsIHRoaXMpO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcIm1hdGVyaWFsQXNzZXRcIiwge3NldDp0aGlzLnNldE1hdGVyaWFsQXNzZXQuYmluZCh0aGlzKSwgZ2V0OnRoaXMuZ2V0TWF0ZXJpYWxBc3NldC5iaW5kKHRoaXMpfSk7XG4gICAgdGhpcy5fYXNzZXRPbGQgPSAwO1xuICAgIHRoaXMuX21hdGVyaWFsRXZlbnRzID0gbnVsbDtcbiAgICB0aGlzLl9kaXJ0eU1vZGVsQXNzZXQgPSBmYWxzZTtcbiAgICB0aGlzLl9kaXJ0eU1hdGVyaWFsQXNzZXQgPSBmYWxzZTtcbiAgICB0aGlzLl9jbG9uZWRNb2RlbCA9IGZhbHNlO1xuICB9O1xuICBNb2RlbENvbXBvbmVudCA9IHBjLmluaGVyaXRzKE1vZGVsQ29tcG9uZW50LCBwYy5Db21wb25lbnQpO1xuICBwYy5leHRlbmQoTW9kZWxDb21wb25lbnQucHJvdG90eXBlLCB7c2V0VmlzaWJsZTpmdW5jdGlvbih2aXNpYmxlKSB7XG4gICAgY29uc29sZS53YXJuKFwiV0FSTklORzogc2V0VmlzaWJsZTogRnVuY3Rpb24gaXMgZGVwcmVjYXRlZC4gU2V0IGVuYWJsZWQgcHJvcGVydHkgaW5zdGVhZC5cIik7XG4gICAgdGhpcy5lbmFibGVkID0gdmlzaWJsZTtcbiAgfSwgX29uQXNzZXRMb2FkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgaWYgKGFzc2V0LnJlc291cmNlKSB7XG4gICAgICB0aGlzLl9vbk1vZGVsTG9hZGVkKGFzc2V0LnJlc291cmNlLmNsb25lKCkpO1xuICAgICAgdGhpcy5fY2xvbmVkTW9kZWwgPSB0cnVlO1xuICAgIH1cbiAgfSwgX29uQXNzZXRVbmxvYWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBpZiAoIXRoaXMubW9kZWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLnJlbW92ZU1vZGVsKHRoaXMubW9kZWwpO1xuICAgIHZhciBkZXZpY2UgPSB0aGlzLnN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gIH0sIF9vbkFzc2V0Q2hhbmdlOmZ1bmN0aW9uKGFzc2V0LCBhdHRyaWJ1dGUsIG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgIGlmIChhdHRyaWJ1dGUgPT09IFwiZGF0YVwiKSB7XG4gICAgICB0aGlzLm1hcHBpbmcgPSB0aGlzLmRhdGEubWFwcGluZztcbiAgICB9XG4gIH0sIF9vbkFzc2V0UmVtb3ZlOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgaWYgKHRoaXMuYXNzZXQgPT09IGFzc2V0LmlkKSB7XG4gICAgICB0aGlzLmFzc2V0ID0gbnVsbDtcbiAgICB9XG4gIH0sIF9zZXRNb2RlbEFzc2V0OmZ1bmN0aW9uKGlkKSB7XG4gICAgaWYgKHRoaXMuX2Fzc2V0T2xkID09PSBpZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgYXNzZXRzID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cztcbiAgICB2YXIgYXNzZXQgPSBpZCAhPT0gbnVsbCA/IGFzc2V0cy5nZXQoaWQpIDogbnVsbDtcbiAgICB0aGlzLl9kaXJ0eU1vZGVsQXNzZXQgPSB0cnVlO1xuICAgIHRoaXMuX29uTW9kZWxBc3NldChhc3NldCB8fCBudWxsKTtcbiAgICBpZiAoIWFzc2V0ICYmIGlkICE9PSBudWxsKSB7XG4gICAgICBhc3NldHMub25jZShcImFkZDpcIiArIGlkLCB0aGlzLl9vbk1vZGVsQXNzZXQsIHRoaXMpO1xuICAgIH1cbiAgfSwgX29uTW9kZWxBc3NldDpmdW5jdGlvbihhc3NldCkge1xuICAgIHZhciBhc3NldHMgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIGlmICh0aGlzLl9hc3NldE9sZCkge1xuICAgICAgYXNzZXRzLm9mZihcImFkZDpcIiArIHRoaXMuX2Fzc2V0T2xkLCB0aGlzLl9vbk1vZGVsQXNzZXQsIHRoaXMpO1xuICAgICAgdmFyIGFzc2V0T2xkID0gYXNzZXRzLmdldCh0aGlzLl9hc3NldE9sZCk7XG4gICAgICBpZiAoYXNzZXRPbGQpIHtcbiAgICAgICAgYXNzZXRPbGQub2ZmKFwibG9hZFwiLCB0aGlzLl9vbkFzc2V0TG9hZCwgdGhpcyk7XG4gICAgICAgIGFzc2V0T2xkLm9mZihcInVubG9hZFwiLCB0aGlzLl9vbkFzc2V0VW5sb2FkLCB0aGlzKTtcbiAgICAgICAgYXNzZXRPbGQub2ZmKFwiY2hhbmdlXCIsIHRoaXMuX29uQXNzZXRDaGFuZ2UsIHRoaXMpO1xuICAgICAgICBhc3NldE9sZC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25Bc3NldFJlbW92ZSwgdGhpcyk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2Fzc2V0T2xkID0gYXNzZXQgPyBhc3NldC5pZCA6IDA7XG4gICAgaWYgKGFzc2V0KSB7XG4gICAgICBhc3NldC5vbihcImxvYWRcIiwgdGhpcy5fb25Bc3NldExvYWQsIHRoaXMpO1xuICAgICAgYXNzZXQub24oXCJ1bmxvYWRcIiwgdGhpcy5fb25Bc3NldFVubG9hZCwgdGhpcyk7XG4gICAgICBhc3NldC5vbihcImNoYW5nZVwiLCB0aGlzLl9vbkFzc2V0Q2hhbmdlLCB0aGlzKTtcbiAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMuX29uQXNzZXRSZW1vdmUsIHRoaXMpO1xuICAgICAgaWYgKGFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgIHRoaXMuX2RpcnR5TW9kZWxBc3NldCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9vbk1vZGVsTG9hZGVkKGFzc2V0LnJlc291cmNlLmNsb25lKCkpO1xuICAgICAgICB0aGlzLl9jbG9uZWRNb2RlbCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICB0aGlzLl9kaXJ0eU1vZGVsQXNzZXQgPSBmYWxzZTtcbiAgICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZGlydHlNb2RlbEFzc2V0ID0gZmFsc2U7XG4gICAgfVxuICB9LCByZW1vdmU6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fb25Nb2RlbEFzc2V0KG51bGwpO1xuICB9LCBfb25Nb2RlbExvYWRlZDpmdW5jdGlvbihtb2RlbCkge1xuICAgIGlmICh0aGlzLmRhdGEudHlwZSA9PT0gXCJhc3NldFwiKSB7XG4gICAgICB0aGlzLm1vZGVsID0gbW9kZWw7XG4gICAgfVxuICB9LCBvblNldFR5cGU6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgaWYgKG5ld1ZhbHVlKSB7XG4gICAgICB2YXIgbWVzaCA9IG51bGw7XG4gICAgICB0aGlzLl9hcmVhID0gbnVsbDtcbiAgICAgIGlmIChuZXdWYWx1ZSA9PT0gXCJhc3NldFwiKSB7XG4gICAgICAgIGlmICh0aGlzLmRhdGEuYXNzZXQgIT09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLl9zZXRNb2RlbEFzc2V0KHRoaXMuZGF0YS5hc3NldCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN3aXRjaChuZXdWYWx1ZSkge1xuICAgICAgICAgIGNhc2UgXCJib3hcIjpcbiAgICAgICAgICAgIG1lc2ggPSB0aGlzLnN5c3RlbS5ib3g7XG4gICAgICAgICAgICB0aGlzLl9hcmVhID0ge3g6MiwgeToyLCB6OjIsIHV2OjIuMCAvIDN9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcImNhcHN1bGVcIjpcbiAgICAgICAgICAgIG1lc2ggPSB0aGlzLnN5c3RlbS5jYXBzdWxlO1xuICAgICAgICAgICAgdGhpcy5fYXJlYSA9IHt4Ok1hdGguUEkgKiAyLCB5Ok1hdGguUEksIHo6TWF0aC5QSSAqIDIsIHV2OjEuMCAvIDMgKyAxLjAgLyAzIC8gMyAqIDJ9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcInNwaGVyZVwiOlxuICAgICAgICAgICAgbWVzaCA9IHRoaXMuc3lzdGVtLnNwaGVyZTtcbiAgICAgICAgICAgIHRoaXMuX2FyZWEgPSB7eDpNYXRoLlBJLCB5Ok1hdGguUEksIHo6TWF0aC5QSSwgdXY6MX07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwiY29uZVwiOlxuICAgICAgICAgICAgbWVzaCA9IHRoaXMuc3lzdGVtLmNvbmU7XG4gICAgICAgICAgICB0aGlzLl9hcmVhID0ge3g6Mi41NCwgeToyLjU0LCB6OjIuNTQsIHV2OjEuMCAvIDMgKyAxLjAgLyAzIC8gM307XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwiY3lsaW5kZXJcIjpcbiAgICAgICAgICAgIG1lc2ggPSB0aGlzLnN5c3RlbS5jeWxpbmRlcjtcbiAgICAgICAgICAgIHRoaXMuX2FyZWEgPSB7eDpNYXRoLlBJLCB5OjAuNzkgKiAyLCB6Ok1hdGguUEksIHV2OjEuMCAvIDMgKyAxLjAgLyAzIC8gMyAqIDJ9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcInBsYW5lXCI6XG4gICAgICAgICAgICBtZXNoID0gdGhpcy5zeXN0ZW0ucGxhbmU7XG4gICAgICAgICAgICB0aGlzLl9hcmVhID0ge3g6MCwgeToxLCB6OjAsIHV2OjF9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgbW9kZWwgdHlwZTogXCIgKyBuZXdWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgcGMuR3JhcGhOb2RlO1xuICAgICAgICB2YXIgbW9kZWwgPSBuZXcgcGMuTW9kZWw7XG4gICAgICAgIG1vZGVsLmdyYXBoID0gbm9kZTtcbiAgICAgICAgbW9kZWwubWVzaEluc3RhbmNlcyA9IFtuZXcgcGMuTWVzaEluc3RhbmNlKG5vZGUsIG1lc2gsIGRhdGEubWF0ZXJpYWwpXTtcbiAgICAgICAgaWYgKHRoaXMuc3lzdGVtLl9pblRvb2xzKSB7XG4gICAgICAgICAgbW9kZWwuZ2VuZXJhdGVXaXJlZnJhbWUoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7XG4gICAgICAgIHRoaXMuYXNzZXQgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRBc3NldDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgaWQgPSBudWxsO1xuICAgIGlmICh0aGlzLmRhdGEudHlwZSA9PT0gXCJhc3NldFwiKSB7XG4gICAgICBpZiAobmV3VmFsdWUgIT09IG51bGwpIHtcbiAgICAgICAgaWQgPSBuZXdWYWx1ZTtcbiAgICAgICAgaWYgKG5ld1ZhbHVlIGluc3RhbmNlb2YgcGMuQXNzZXQpIHtcbiAgICAgICAgICB0aGlzLmRhdGEuYXNzZXQgPSBuZXdWYWx1ZS5pZDtcbiAgICAgICAgICBpZCA9IG5ld1ZhbHVlLmlkO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm1vZGVsID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlkID09PSBudWxsKSB7XG4gICAgICB0aGlzLmRhdGEuYXNzZXQgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLl9zZXRNb2RlbEFzc2V0KGlkKTtcbiAgfSwgb25TZXRDYXN0U2hhZG93czpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgbW9kZWwgPSB0aGlzLmRhdGEubW9kZWw7XG4gICAgaWYgKG1vZGVsKSB7XG4gICAgICB2YXIgc2NlbmUgPSB0aGlzLnN5c3RlbS5hcHAuc2NlbmU7XG4gICAgICB2YXIgaW5TY2VuZSA9IHNjZW5lLmNvbnRhaW5zTW9kZWwobW9kZWwpO1xuICAgICAgaWYgKGluU2NlbmUgJiYgb2xkVmFsdWUgJiYgIW5ld1ZhbHVlKSB7XG4gICAgICAgIHNjZW5lLnJlbW92ZVNoYWRvd0Nhc3Rlcihtb2RlbCk7XG4gICAgICB9XG4gICAgICB2YXIgbWVzaEluc3RhbmNlcyA9IG1vZGVsLm1lc2hJbnN0YW5jZXM7XG4gICAgICBmb3IgKHZhciBpID0gMDtpIDwgbWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIG1lc2hJbnN0YW5jZXNbaV0uY2FzdFNoYWRvdyA9IG5ld1ZhbHVlO1xuICAgICAgfVxuICAgICAgaWYgKGluU2NlbmUgJiYgIW9sZFZhbHVlICYmIG5ld1ZhbHVlKSB7XG4gICAgICAgIHNjZW5lLmFkZFNoYWRvd0Nhc3Rlcihtb2RlbCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldENhc3RTaGFkb3dzTGlnaHRtYXA6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gIH0sIG9uU2V0TGlnaHRtYXBwZWQ6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIGksIG07XG4gICAgaWYgKHRoaXMuZGF0YS5tb2RlbCkge1xuICAgICAgdmFyIHJjdiA9IHRoaXMuZGF0YS5tb2RlbC5tZXNoSW5zdGFuY2VzO1xuICAgICAgaWYgKG5ld1ZhbHVlKSB7XG4gICAgICAgIGZvciAoaSA9IDA7aSA8IHJjdi5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgbSA9IHJjdltpXTtcbiAgICAgICAgICBtLm1hc2sgPSBwYy5NQVNLX0JBS0VEO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCByY3YubGVuZ3RoO2krKykge1xuICAgICAgICAgIG0gPSByY3ZbaV07XG4gICAgICAgICAgbS5kZWxldGVQYXJhbWV0ZXIoXCJ0ZXh0dXJlX2xpZ2h0TWFwXCIpO1xuICAgICAgICAgIG0uZGVsZXRlUGFyYW1ldGVyKFwidGV4dHVyZV9kaXJMaWdodE1hcFwiKTtcbiAgICAgICAgICBtLl9zaGFkZXJEZWZzICY9IH5wYy5TSEFERVJERUZfTE07XG4gICAgICAgICAgbS5tYXNrID0gcGMuTUFTS19EWU5BTUlDO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldExpZ2h0bWFwU2l6ZU11bHRpcGxpZXI6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5kYXRhLmxpZ2h0bWFwU2l6ZU11bHRpcGxpZXIgPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXRJc1N0YXRpYzpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgaSwgbTtcbiAgICBpZiAodGhpcy5kYXRhLm1vZGVsKSB7XG4gICAgICB2YXIgcmN2ID0gdGhpcy5kYXRhLm1vZGVsLm1lc2hJbnN0YW5jZXM7XG4gICAgICBmb3IgKGkgPSAwO2kgPCByY3YubGVuZ3RoO2krKykge1xuICAgICAgICBtID0gcmN2W2ldO1xuICAgICAgICBtLmlzU3RhdGljID0gbmV3VmFsdWU7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldEJhdGNoR3JvdXBJZDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAob2xkVmFsdWUgPj0gMCkge1xuICAgICAgdGhpcy5zeXN0ZW0uYXBwLmJhdGNoZXIuX21hcmtHcm91cERpcnR5KG9sZFZhbHVlKTtcbiAgICB9XG4gICAgaWYgKG5ld1ZhbHVlID49IDApIHtcbiAgICAgIHRoaXMuc3lzdGVtLmFwcC5iYXRjaGVyLl9tYXJrR3JvdXBEaXJ0eShuZXdWYWx1ZSk7XG4gICAgfVxuICAgIGlmIChuZXdWYWx1ZSA8IDAgJiYgb2xkVmFsdWUgPj0gMCAmJiB0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmFkZE1vZGVsKHRoaXMubW9kZWwpO1xuICAgIH1cbiAgfSwgb25TZXRNb2RlbDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAob2xkVmFsdWUpIHtcbiAgICAgIHRoaXMuc3lzdGVtLmFwcC5zY2VuZS5yZW1vdmVNb2RlbChvbGRWYWx1ZSk7XG4gICAgICB0aGlzLmVudGl0eS5yZW1vdmVDaGlsZChvbGRWYWx1ZS5nZXRHcmFwaCgpKTtcbiAgICAgIGRlbGV0ZSBvbGRWYWx1ZS5fZW50aXR5O1xuICAgICAgaWYgKHRoaXMuX2Nsb25lZE1vZGVsKSB7XG4gICAgICAgIG9sZFZhbHVlLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5fY2xvbmVkTW9kZWwgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG5ld1ZhbHVlKSB7XG4gICAgICB2YXIgY29tcG9uZW50RGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHZhciBtZXNoSW5zdGFuY2VzID0gbmV3VmFsdWUubWVzaEluc3RhbmNlcztcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBtZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgbWVzaEluc3RhbmNlc1tpXS5jYXN0U2hhZG93ID0gY29tcG9uZW50RGF0YS5jYXN0U2hhZG93cztcbiAgICAgICAgbWVzaEluc3RhbmNlc1tpXS5yZWNlaXZlU2hhZG93ID0gY29tcG9uZW50RGF0YS5yZWNlaXZlU2hhZG93cztcbiAgICAgIH1cbiAgICAgIHRoaXMubGlnaHRtYXBwZWQgPSBjb21wb25lbnREYXRhLmxpZ2h0bWFwcGVkO1xuICAgICAgdGhpcy5pc1N0YXRpYyA9IGNvbXBvbmVudERhdGEuaXNTdGF0aWM7XG4gICAgICB0aGlzLmVudGl0eS5hZGRDaGlsZChuZXdWYWx1ZS5ncmFwaCk7XG4gICAgICBpZiAodGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmFkZE1vZGVsKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICAgIG5ld1ZhbHVlLl9lbnRpdHkgPSB0aGlzLmVudGl0eTtcbiAgICAgIGlmICh0aGlzLmVudGl0eS5hbmltYXRpb24pIHtcbiAgICAgICAgdGhpcy5lbnRpdHkuYW5pbWF0aW9uLnNldE1vZGVsKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmRhdGEudHlwZSA9PT0gXCJhc3NldFwiKSB7XG4gICAgICAgIHRoaXMubWFwcGluZyA9IHRoaXMuZGF0YS5tYXBwaW5nO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fdW5zZXRNYXRlcmlhbEV2ZW50cygpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91bnNldE1hdGVyaWFsRXZlbnRzKCk7XG4gICAgfVxuICB9LCBfb25NYXRlcmlhbEFzc2V0UmVtb3ZlOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdmFyIGlkID0gaXNOYU4oYXNzZXQpID8gYXNzZXQuaWQgOiBhc3NldDtcbiAgICBpZiAoYXNzZXQgJiYgaXNOYU4oYXNzZXQpICYmIGFzc2V0LnJlc291cmNlID09PSB0aGlzLm1hdGVyaWFsKSB7XG4gICAgICB0aGlzLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgfVxuICAgIGFzc2V0cy5vZmYoXCJhZGQ6XCIgKyBpZCwgdGhpcy5fb25NYXRlcmlhbEFzc2V0QWRkLCB0aGlzKTtcbiAgICBhc3NldHMub2ZmKFwibG9hZDpcIiArIGlkLCB0aGlzLl9vbk1hdGVyaWFsQXNzZXRMb2FkLCB0aGlzKTtcbiAgICBhc3NldHMub2ZmKFwidW5sb2FkOlwiICsgaWQsIHRoaXMuX29uTWF0ZXJpYWxBc3NldFVubG9hZCwgdGhpcyk7XG4gICAgYXNzZXRzLm9mZihcInJlbW92ZTpcIiArIGlkLCB0aGlzLl9vbk1hdGVyaWFsQXNzZXRSZW1vdmUsIHRoaXMpO1xuICB9LCBfb25NYXRlcmlhbEFzc2V0QWRkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgaWYgKGFzc2V0LnJlc291cmNlKSB7XG4gICAgICB0aGlzLm1hdGVyaWFsID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICB0aGlzLl9kaXJ0eU1hdGVyaWFsQXNzZXQgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX2RpcnR5TWF0ZXJpYWxBc3NldCA9IGZhbHNlO1xuICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBfb25NYXRlcmlhbEFzc2V0TG9hZDpmdW5jdGlvbihhc3NldCkge1xuICAgIHZhciBhc3NldHMgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIGlmIChhc3NldC5yZXNvdXJjZSkge1xuICAgICAgdGhpcy5tYXRlcmlhbCA9IGFzc2V0LnJlc291cmNlO1xuICAgICAgdGhpcy5fZGlydHlNYXRlcmlhbEFzc2V0ID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgICB0aGlzLl9kaXJ0eU1hdGVyaWFsQXNzZXQgPSBmYWxzZTtcbiAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX29uTWF0ZXJpYWxBc3NldFVubG9hZDpmdW5jdGlvbihhc3NldCkge1xuICAgIHZhciBhc3NldHMgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIHZhciBpZCA9IGlzTmFOKGFzc2V0KSA/IGFzc2V0LmlkIDogYXNzZXQ7XG4gICAgaWYgKGFzc2V0ICYmIGlzTmFOKGFzc2V0KSAmJiBhc3NldC5yZXNvdXJjZSA9PT0gdGhpcy5tYXRlcmlhbCkge1xuICAgICAgdGhpcy5tYXRlcmlhbCA9IHBjLk1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMO1xuICAgIH1cbiAgfSwgc2V0TWF0ZXJpYWxBc3NldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2RpcnR5TWF0ZXJpYWxBc3NldCA9IHRydWU7XG4gICAgdmFyIGlkID0gdHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiIHx8ICF2YWx1ZSA/IHZhbHVlIDogdmFsdWUuaWQ7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGlmICh0aGlzLmRhdGEubWF0ZXJpYWxBc3NldCAhPT0gaWQpIHtcbiAgICAgIGlmICh0aGlzLmRhdGEubWF0ZXJpYWxBc3NldCkge1xuICAgICAgICB0aGlzLl9vbk1hdGVyaWFsQXNzZXRSZW1vdmUodGhpcy5kYXRhLm1hdGVyaWFsQXNzZXQpO1xuICAgICAgfVxuICAgICAgaWYgKGlkKSB7XG4gICAgICAgIGFzc2V0cy5vbihcImxvYWQ6XCIgKyBpZCwgdGhpcy5fb25NYXRlcmlhbEFzc2V0TG9hZCwgdGhpcyk7XG4gICAgICAgIGFzc2V0cy5vbihcInVubG9hZDpcIiArIGlkLCB0aGlzLl9vbk1hdGVyaWFsQXNzZXRVbmxvYWQsIHRoaXMpO1xuICAgICAgICBhc3NldHMub24oXCJyZW1vdmU6XCIgKyBpZCwgdGhpcy5fb25NYXRlcmlhbEFzc2V0UmVtb3ZlLCB0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlkICE9PSB1bmRlZmluZWQgJiYgaWQgIT09IG51bGwpIHtcbiAgICAgIHZhciBhc3NldCA9IGFzc2V0cy5nZXQoaWQpO1xuICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgIHRoaXMuX29uTWF0ZXJpYWxBc3NldExvYWQoYXNzZXQpO1xuICAgICAgfVxuICAgICAgYXNzZXRzLm9uY2UoXCJhZGQ6XCIgKyBpZCwgdGhpcy5fb25NYXRlcmlhbEFzc2V0QWRkLCB0aGlzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGlkID09PSBudWxsKSB7XG4gICAgICAgIHNlbGYubWF0ZXJpYWwgPSBwYy5Nb2RlbEhhbmRsZXIuREVGQVVMVF9NQVRFUklBTDtcbiAgICAgICAgc2VsZi5fZGlydHlNYXRlcmlhbEFzc2V0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciB2YWx1ZU9sZCA9IHRoaXMuZGF0YS5tYXRlcmlhbEFzc2V0O1xuICAgIHRoaXMuZGF0YS5tYXRlcmlhbEFzc2V0ID0gaWQ7XG4gICAgdGhpcy5maXJlKFwic2V0XCIsIFwibWF0ZXJpYWxBc3NldFwiLCB2YWx1ZU9sZCwgaWQpO1xuICB9LCBnZXRNYXRlcmlhbEFzc2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzLmdldCh0aGlzLmRhdGEubWF0ZXJpYWxBc3NldCk7XG4gIH0sIG9uU2V0TWF0ZXJpYWw6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5kYXRhLm1hdGVyaWFsID0gbmV3VmFsdWU7XG4gICAgICBpZiAodGhpcy5kYXRhLm1vZGVsICYmIHRoaXMuZGF0YS50eXBlICE9PSBcImFzc2V0XCIpIHtcbiAgICAgICAgdmFyIG1lc2hJbnN0YW5jZXMgPSB0aGlzLmRhdGEubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZXNbaV0ubWF0ZXJpYWwgPSBuZXdWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRNYXBwaW5nOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmICh0aGlzLmRhdGEudHlwZSAhPT0gXCJhc3NldFwiIHx8ICF0aGlzLmRhdGEubW9kZWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fdW5zZXRNYXRlcmlhbEV2ZW50cygpO1xuICAgIGlmICghbmV3VmFsdWUpIHtcbiAgICAgIG5ld1ZhbHVlID0ge307XG4gICAgfVxuICAgIHZhciBtZXNoSW5zdGFuY2VzID0gdGhpcy5kYXRhLm1vZGVsLm1lc2hJbnN0YW5jZXM7XG4gICAgdmFyIG1vZGVsQXNzZXQgPSB0aGlzLmFzc2V0ID8gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQodGhpcy5hc3NldCkgOiBudWxsO1xuICAgIHZhciBhc3NldE1hcHBpbmcgPSBtb2RlbEFzc2V0ID8gbW9kZWxBc3NldC5kYXRhLm1hcHBpbmcgOiBudWxsO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBtZXNoSW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKG5ld1ZhbHVlW2ldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKG5ld1ZhbHVlW2ldKSB7XG4gICAgICAgICAgdGhpcy5fbG9hZEFuZFNldE1lc2hJbnN0YW5jZU1hdGVyaWFsKG5ld1ZhbHVlW2ldLCBtZXNoSW5zdGFuY2VzW2ldLCBpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtZXNoSW5zdGFuY2VzW2ldLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChhc3NldE1hcHBpbmcpIHtcbiAgICAgICAgICBpZiAoYXNzZXRNYXBwaW5nW2ldICYmIChhc3NldE1hcHBpbmdbaV0ubWF0ZXJpYWwgfHwgYXNzZXRNYXBwaW5nW2ldLnBhdGgpKSB7XG4gICAgICAgICAgICB2YXIgaWRPclBhdGggPSBhc3NldE1hcHBpbmdbaV0ubWF0ZXJpYWwgfHwgYXNzZXRNYXBwaW5nW2ldLnBhdGg7XG4gICAgICAgICAgICB0aGlzLl9sb2FkQW5kU2V0TWVzaEluc3RhbmNlTWF0ZXJpYWwoaWRPclBhdGgsIG1lc2hJbnN0YW5jZXNbaV0sIGkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2VzW2ldLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfc2V0TWF0ZXJpYWxFdmVudDpmdW5jdGlvbihpbmRleCwgZXZlbnQsIGlkLCBoYW5kbGVyKSB7XG4gICAgdmFyIGV2dCA9IGV2ZW50ICsgXCI6XCIgKyBpZDtcbiAgICB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzLm9uKGV2dCwgaGFuZGxlciwgdGhpcyk7XG4gICAgaWYgKCF0aGlzLl9tYXRlcmlhbEV2ZW50cykge1xuICAgICAgdGhpcy5fbWF0ZXJpYWxFdmVudHMgPSBbXTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9tYXRlcmlhbEV2ZW50c1tpbmRleF0pIHtcbiAgICAgIHRoaXMuX21hdGVyaWFsRXZlbnRzW2luZGV4XSA9IHt9O1xuICAgIH1cbiAgICB0aGlzLl9tYXRlcmlhbEV2ZW50c1tpbmRleF1bZXZ0XSA9IHtpZDppZCwgaGFuZGxlcjpoYW5kbGVyfTtcbiAgfSwgX3Vuc2V0TWF0ZXJpYWxFdmVudHM6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdmFyIGV2ZW50cyA9IHRoaXMuX21hdGVyaWFsRXZlbnRzO1xuICAgIGlmICghZXZlbnRzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBldmVudHMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICBpZiAoIWV2ZW50c1tpXSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZhciBldnQgPSBldmVudHNbaV07XG4gICAgICBmb3IgKHZhciBrZXkgaW4gZXZ0KSB7XG4gICAgICAgIGFzc2V0cy5vZmYoa2V5LCBldnRba2V5XS5oYW5kbGVyLCB0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fbWF0ZXJpYWxFdmVudHMgPSBudWxsO1xuICB9LCBfZ2V0QXNzZXRCeUlkT3JQYXRoOmZ1bmN0aW9uKGlkT3JQYXRoKSB7XG4gICAgdmFyIGFzc2V0ID0gbnVsbDtcbiAgICB2YXIgaXNQYXRoID0gaXNOYU4ocGFyc2VJbnQoaWRPclBhdGgsIDEwKSk7XG4gICAgaWYgKCFpc1BhdGgpIHtcbiAgICAgIGFzc2V0ID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQoaWRPclBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5hc3NldCkge1xuICAgICAgICB2YXIgdXJsID0gdGhpcy5fZ2V0TWF0ZXJpYWxBc3NldFVybChpZE9yUGF0aCk7XG4gICAgICAgIGlmICh1cmwpIHtcbiAgICAgICAgICBhc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0QnlVcmwodXJsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYXNzZXQ7XG4gIH0sIF9nZXRNYXRlcmlhbEFzc2V0VXJsOmZ1bmN0aW9uKHBhdGgpIHtcbiAgICBpZiAoIXRoaXMuYXNzZXQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICB2YXIgbW9kZWxBc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0KHRoaXMuYXNzZXQpO1xuICAgIGlmICghbW9kZWxBc3NldCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHZhciBmaWxlVXJsID0gbW9kZWxBc3NldC5nZXRGaWxlVXJsKCk7XG4gICAgdmFyIGRpclVybCA9IHBjLnBhdGguZ2V0RGlyZWN0b3J5KGZpbGVVcmwpO1xuICAgIHJldHVybiBwYy5wYXRoLmpvaW4oZGlyVXJsLCBwYXRoKTtcbiAgfSwgX2xvYWRBbmRTZXRNZXNoSW5zdGFuY2VNYXRlcmlhbDpmdW5jdGlvbihpZE9yUGF0aCwgbWVzaEluc3RhbmNlLCBpbmRleCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cztcbiAgICB2YXIgYXNzZXQgPSB0aGlzLl9nZXRBc3NldEJ5SWRPclBhdGgoaWRPclBhdGgpO1xuICAgIGlmICghYXNzZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGhhbmRsZU1hdGVyaWFsID0gZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgIGlmIChhc3NldC5yZXNvdXJjZSkge1xuICAgICAgICBtZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgc2VsZi5fc2V0TWF0ZXJpYWxFdmVudChpbmRleCwgXCJyZW1vdmVcIiwgYXNzZXQuaWQsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IHBjLk1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbGYuX3NldE1hdGVyaWFsRXZlbnQoaW5kZXgsIFwibG9hZFwiLCBhc3NldC5pZCwgZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICBtZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICBzZWxmLl9zZXRNYXRlcmlhbEV2ZW50KGluZGV4LCBcInJlbW92ZVwiLCBhc3NldC5pZCwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSBwYy5Nb2RlbEhhbmRsZXIuREVGQVVMVF9NQVRFUklBTDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChzZWxmLmVuYWJsZWQgJiYgc2VsZi5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgaWYgKGFzc2V0KSB7XG4gICAgICBoYW5kbGVNYXRlcmlhbChhc3NldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IHBjLk1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMO1xuICAgICAgdmFyIGlzUGF0aCA9IGlzTmFOKHBhcnNlSW50KGlkT3JQYXRoLCAxMCkpO1xuICAgICAgc2VsZi5fc2V0TWF0ZXJpYWxFdmVudChpbmRleCwgaXNQYXRoID8gXCJhZGQ6dXJsXCIgOiBcImFkZFwiLCBpZE9yUGF0aCwgaGFuZGxlTWF0ZXJpYWwpO1xuICAgIH1cbiAgfSwgb25TZXRSZWNlaXZlU2hhZG93czpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAobmV3VmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFyIGNvbXBvbmVudERhdGEgPSB0aGlzLmRhdGE7XG4gICAgICBpZiAoY29tcG9uZW50RGF0YS5tb2RlbCkge1xuICAgICAgICB2YXIgbWVzaEluc3RhbmNlcyA9IGNvbXBvbmVudERhdGEubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgICAgIG1lc2hJbnN0YW5jZXNbaV0ucmVjZWl2ZVNoYWRvdyA9IG5ld1ZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBNb2RlbENvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICB2YXIgYXNzZXQ7XG4gICAgdmFyIG1vZGVsID0gdGhpcy5kYXRhLm1vZGVsO1xuICAgIHZhciBpc0Fzc2V0ID0gdGhpcy5kYXRhLnR5cGUgPT09IFwiYXNzZXRcIjtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIHZhciBpblNjZW5lID0gdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwobW9kZWwpO1xuICAgICAgaWYgKCFpblNjZW5lKSB7XG4gICAgICAgIHRoaXMuc3lzdGVtLmFwcC5zY2VuZS5hZGRNb2RlbChtb2RlbCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpc0Fzc2V0ICYmIHRoaXMuX2RpcnR5TW9kZWxBc3NldCkge1xuICAgICAgICBhc3NldCA9IHRoaXMuZGF0YS5hc3NldDtcbiAgICAgICAgaWYgKCFhc3NldCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBhc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0KGFzc2V0KTtcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgdGhpcy5fb25Nb2RlbEFzc2V0KGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5fZGlydHlNYXRlcmlhbEFzc2V0KSB7XG4gICAgICB2YXIgbWF0ZXJpYWxBc3NldCA9IHRoaXMuZGF0YS5tYXRlcmlhbEFzc2V0O1xuICAgICAgaWYgKG1hdGVyaWFsQXNzZXQpIHtcbiAgICAgICAgbWF0ZXJpYWxBc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0KG1hdGVyaWFsQXNzZXQpO1xuICAgICAgICBpZiAobWF0ZXJpYWxBc3NldCAmJiAhbWF0ZXJpYWxBc3NldC5yZXNvdXJjZSkge1xuICAgICAgICAgIHRoaXMuX29uTWF0ZXJpYWxBc3NldExvYWQobWF0ZXJpYWxBc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlzQXNzZXQpIHtcbiAgICAgIHZhciBtYXBwaW5nID0gdGhpcy5kYXRhLm1hcHBpbmc7XG4gICAgICBpZiAobWFwcGluZykge1xuICAgICAgICBmb3IgKHZhciBpbmRleCBpbiBtYXBwaW5nKSB7XG4gICAgICAgICAgaWYgKG1hcHBpbmdbaW5kZXhdKSB7XG4gICAgICAgICAgICBhc3NldCA9IHRoaXMuX2dldEFzc2V0QnlJZE9yUGF0aChtYXBwaW5nW2luZGV4XSk7XG4gICAgICAgICAgICBpZiAoYXNzZXQgJiYgIWFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgICAgICAgIHRoaXMuc3lzdGVtLmFwcC5hc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkRpc2FibGU6ZnVuY3Rpb24oKSB7XG4gICAgTW9kZWxDb21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIHZhciBtb2RlbCA9IHRoaXMuZGF0YS5tb2RlbDtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIHZhciBpblNjZW5lID0gdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwobW9kZWwpO1xuICAgICAgaWYgKGluU2NlbmUpIHtcbiAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLnJlbW92ZU1vZGVsKG1vZGVsKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGhpZGU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIG1vZGVsID0gdGhpcy5kYXRhLm1vZGVsO1xuICAgIGlmIChtb2RlbCkge1xuICAgICAgdmFyIGksIGw7XG4gICAgICB2YXIgaW5zdGFuY2VzID0gbW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgIGZvciAoaSA9IDAsIGwgPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsO2krKykge1xuICAgICAgICBpbnN0YW5jZXNbaV0udmlzaWJsZSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgfSwgc2hvdzpmdW5jdGlvbigpIHtcbiAgICB2YXIgbW9kZWwgPSB0aGlzLmRhdGEubW9kZWw7XG4gICAgaWYgKG1vZGVsKSB7XG4gICAgICB2YXIgaSwgbDtcbiAgICAgIHZhciBpbnN0YW5jZXMgPSBtb2RlbC5tZXNoSW5zdGFuY2VzO1xuICAgICAgZm9yIChpID0gMCwgbCA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGw7aSsrKSB7XG4gICAgICAgIGluc3RhbmNlc1tpXS52aXNpYmxlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1vZGVsQ29tcG9uZW50LnByb3RvdHlwZSwgXCJtZXNoSW5zdGFuY2VzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLm1vZGVsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubW9kZWwubWVzaEluc3RhbmNlcztcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKCF0aGlzLm1vZGVsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubW9kZWwubWVzaEluc3RhbmNlcyA9IHZhbHVlO1xuICB9fSk7XG4gIHJldHVybiB7TW9kZWxDb21wb25lbnQ6TW9kZWxDb21wb25lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBfc2NoZW1hID0gW1wiZW5hYmxlZFwiLCBcInR5cGVcIiwgXCJhc3NldFwiLCBcIm1hdGVyaWFsQXNzZXRcIiwgXCJjYXN0U2hhZG93c1wiLCBcInJlY2VpdmVTaGFkb3dzXCIsIFwiY2FzdFNoYWRvd3NMaWdodG1hcFwiLCBcImxpZ2h0bWFwcGVkXCIsIFwibGlnaHRtYXBTaXplTXVsdGlwbGllclwiLCBcImlzU3RhdGljXCIsIFwibWF0ZXJpYWxcIiwgXCJtb2RlbFwiLCBcIm1hcHBpbmdcIiwgXCJiYXRjaEdyb3VwSWRcIl07XG4gIHZhciBNb2RlbENvbXBvbmVudFN5c3RlbSA9IGZ1bmN0aW9uIE1vZGVsQ29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcIm1vZGVsXCI7XG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IFwiUmVuZGVycyBhIDNEIG1vZGVsIGF0IHRoZSBsb2NhdGlvbiBvZiB0aGUgRW50aXR5LlwiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5Nb2RlbENvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuTW9kZWxDb21wb25lbnREYXRhO1xuICAgIHRoaXMuc2NoZW1hID0gX3NjaGVtYTtcbiAgICB2YXIgZ2QgPSBhcHAuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdGhpcy5ib3ggPSBwYy5jcmVhdGVCb3goZ2QsIHtoYWxmRXh0ZW50czpuZXcgcGMuVmVjMygwLjUsIDAuNSwgMC41KX0pO1xuICAgIHRoaXMuY2Fwc3VsZSA9IHBjLmNyZWF0ZUNhcHN1bGUoZ2QsIHtyYWRpdXM6MC41LCBoZWlnaHQ6Mn0pO1xuICAgIHRoaXMuc3BoZXJlID0gcGMuY3JlYXRlU3BoZXJlKGdkLCB7cmFkaXVzOjAuNX0pO1xuICAgIHRoaXMuY29uZSA9IHBjLmNyZWF0ZUNvbmUoZ2QsIHtiYXNlUmFkaXVzOjAuNSwgcGVha1JhZGl1czowLCBoZWlnaHQ6MX0pO1xuICAgIHRoaXMuY3lsaW5kZXIgPSBwYy5jcmVhdGVDeWxpbmRlcihnZCwge3JhZGl1czowLjUsIGhlaWdodDoxfSk7XG4gICAgdGhpcy5wbGFuZSA9IHBjLmNyZWF0ZVBsYW5lKGdkLCB7aGFsZkV4dGVudHM6bmV3IHBjLlZlYzIoMC41LCAwLjUpLCB3aWR0aFNlZ21lbnRzOjEsIGxlbmd0aFNlZ21lbnRzOjF9KTtcbiAgICB0aGlzLmRlZmF1bHRNYXRlcmlhbCA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xuICAgIHRoaXMub24oXCJiZWZvcmVyZW1vdmVcIiwgdGhpcy5vblJlbW92ZSwgdGhpcyk7XG4gIH07XG4gIE1vZGVsQ29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoTW9kZWxDb21wb25lbnRTeXN0ZW0sIHBjLkNvbXBvbmVudFN5c3RlbSk7XG4gIHBjLkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMocGMuTW9kZWxDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKE1vZGVsQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwge2luaXRpYWxpemVDb21wb25lbnREYXRhOmZ1bmN0aW9uKGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcykge1xuICAgIGRhdGEubWF0ZXJpYWwgPSB0aGlzLmRlZmF1bHRNYXRlcmlhbDtcbiAgICBpZiAoZGF0YS5iYXRjaEdyb3VwSWQgPT09IG51bGwgfHwgZGF0YS5iYXRjaEdyb3VwSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgZGF0YS5iYXRjaEdyb3VwSWQgPSAtMTtcbiAgICB9XG4gICAgcHJvcGVydGllcyA9IFtcImVuYWJsZWRcIiwgXCJtYXRlcmlhbFwiLCBcIm1hdGVyaWFsQXNzZXRcIiwgXCJhc3NldFwiLCBcImNhc3RTaGFkb3dzXCIsIFwicmVjZWl2ZVNoYWRvd3NcIiwgXCJjYXN0U2hhZG93c0xpZ2h0bWFwXCIsIFwibGlnaHRtYXBwZWRcIiwgXCJsaWdodG1hcFNpemVNdWx0aXBsaWVyXCIsIFwidHlwZVwiLCBcIm1hcHBpbmdcIiwgXCJpc1N0YXRpY1wiLCBcImJhdGNoR3JvdXBJZFwiXTtcbiAgICBNb2RlbENvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCByZW1vdmVDb21wb25lbnQ6ZnVuY3Rpb24oZW50aXR5KSB7XG4gICAgdmFyIGRhdGEgPSBlbnRpdHkubW9kZWwuZGF0YTtcbiAgICBlbnRpdHkubW9kZWwuYXNzZXQgPSBudWxsO1xuICAgIGlmIChkYXRhLnR5cGUgIT09IFwiYXNzZXRcIiAmJiBkYXRhLm1vZGVsKSB7XG4gICAgICB0aGlzLmFwcC5zY2VuZS5yZW1vdmVNb2RlbChkYXRhLm1vZGVsKTtcbiAgICAgIGVudGl0eS5yZW1vdmVDaGlsZChkYXRhLm1vZGVsLmdldEdyYXBoKCkpO1xuICAgICAgZGF0YS5tb2RlbCA9IG51bGw7XG4gICAgfVxuICAgIE1vZGVsQ29tcG9uZW50U3lzdGVtLl9zdXBlci5yZW1vdmVDb21wb25lbnQuY2FsbCh0aGlzLCBlbnRpdHkpO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIGRhdGEgPSB7dHlwZTplbnRpdHkubW9kZWwudHlwZSwgYXNzZXQ6ZW50aXR5Lm1vZGVsLmFzc2V0LCBjYXN0U2hhZG93czplbnRpdHkubW9kZWwuY2FzdFNoYWRvd3MsIHJlY2VpdmVTaGFkb3dzOmVudGl0eS5tb2RlbC5yZWNlaXZlU2hhZG93cywgY2FzdFNoYWRvd3NMaWdodG1hcDplbnRpdHkubW9kZWwuY2FzdFNoYWRvd3NMaWdodG1hcCwgbGlnaHRtYXBwZWQ6ZW50aXR5Lm1vZGVsLmxpZ2h0bWFwcGVkLCBsaWdodG1hcFNpemVNdWx0aXBsaWVyOmVudGl0eS5tb2RlbC5saWdodG1hcFNpemVNdWx0aXBsaWVyLCBpc1N0YXRpYzplbnRpdHkubW9kZWwuaXNTdGF0aWMsIGVuYWJsZWQ6ZW50aXR5Lm1vZGVsLmVuYWJsZWQsIGJhdGNoR3JvdXBJZDplbnRpdHkubW9kZWwuYmF0Y2hHcm91cElkLCBtYXBwaW5nOnBjLmV4dGVuZCh7fSwgZW50aXR5Lm1vZGVsLm1hcHBpbmcpfTtcbiAgICB2YXIgbWF0ZXJpYWxBc3NldCA9IGVudGl0eS5tb2RlbC5tYXRlcmlhbEFzc2V0O1xuICAgIGlmICghKG1hdGVyaWFsQXNzZXQgaW5zdGFuY2VvZiBwYy5Bc3NldCkgJiYgbWF0ZXJpYWxBc3NldCAhPSBudWxsKSB7XG4gICAgICBtYXRlcmlhbEFzc2V0ID0gdGhpcy5hcHAuYXNzZXRzLmdldChtYXRlcmlhbEFzc2V0KTtcbiAgICB9XG4gICAgdmFyIG1hdGVyaWFsID0gZW50aXR5Lm1vZGVsLm1hdGVyaWFsO1xuICAgIGlmICghbWF0ZXJpYWwgfHwgbWF0ZXJpYWwgPT09IHBjLk1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMIHx8ICFtYXRlcmlhbEFzc2V0IHx8IG1hdGVyaWFsID09PSBtYXRlcmlhbEFzc2V0LnJlc291cmNlKSB7XG4gICAgICBkYXRhLm1hdGVyaWFsQXNzZXQgPSBtYXRlcmlhbEFzc2V0O1xuICAgIH1cbiAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5hZGRDb21wb25lbnQoY2xvbmUsIGRhdGEpO1xuICAgIGlmICghZGF0YS5tYXRlcmlhbEFzc2V0KSB7XG4gICAgICBjb21wb25lbnQubWF0ZXJpYWwgPSBtYXRlcmlhbDtcbiAgICB9XG4gICAgaWYgKGVudGl0eS5tb2RlbC5tb2RlbCkge1xuICAgICAgdmFyIG1lc2hJbnN0YW5jZXMgPSBlbnRpdHkubW9kZWwubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgIHZhciBtZXNoSW5zdGFuY2VzQ2xvbmUgPSBjb21wb25lbnQubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBtZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgbWVzaEluc3RhbmNlc0Nsb25lW2ldLm1hc2sgPSBtZXNoSW5zdGFuY2VzW2ldLm1hc2s7XG4gICAgICAgIG1lc2hJbnN0YW5jZXNDbG9uZVtpXS5tYXRlcmlhbCA9IG1lc2hJbnN0YW5jZXNbaV0ubWF0ZXJpYWw7XG4gICAgICAgIG1lc2hJbnN0YW5jZXNDbG9uZVtpXS5sYXllciA9IG1lc2hJbnN0YW5jZXNbaV0ubGF5ZXI7XG4gICAgICAgIG1lc2hJbnN0YW5jZXNDbG9uZVtpXS5yZWNlaXZlU2hhZG93ID0gbWVzaEluc3RhbmNlc1tpXS5yZWNlaXZlU2hhZG93O1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25SZW1vdmU6ZnVuY3Rpb24oZW50aXR5LCBjb21wb25lbnQpIHtcbiAgICBjb21wb25lbnQucmVtb3ZlKCk7XG4gIH19KTtcbiAgcmV0dXJuIHtNb2RlbENvbXBvbmVudFN5c3RlbTpNb2RlbENvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIE1vZGVsQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gICAgdGhpcy50eXBlID0gXCJhc3NldFwiO1xuICAgIHRoaXMuYXNzZXQgPSBudWxsO1xuICAgIHRoaXMuY2FzdFNoYWRvd3MgPSB0cnVlO1xuICAgIHRoaXMucmVjZWl2ZVNoYWRvd3MgPSB0cnVlO1xuICAgIHRoaXMubWF0ZXJpYWxBc3NldCA9IG51bGw7XG4gICAgdGhpcy5tYXBwaW5nID0gbnVsbDtcbiAgICB0aGlzLmNhc3RTaGFkb3dzTGlnaHRtYXAgPSB0cnVlO1xuICAgIHRoaXMubGlnaHRtYXBwZWQgPSBmYWxzZTtcbiAgICB0aGlzLmxpZ2h0bWFwU2l6ZU11bHRpcGxpZXIgPSAxO1xuICAgIHRoaXMuaXNTdGF0aWMgPSBmYWxzZTtcbiAgICB0aGlzLmJhdGNoR3JvdXBJZCA9IC0xO1xuICAgIHRoaXMubWF0ZXJpYWwgPSBudWxsO1xuICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICB9O1xuICBNb2RlbENvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhNb2RlbENvbXBvbmVudERhdGEsIHBjLkNvbXBvbmVudERhdGEpO1xuICByZXR1cm4ge01vZGVsQ29tcG9uZW50RGF0YTpNb2RlbENvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDYW1lcmFDb21wb25lbnQgPSBmdW5jdGlvbiBDYW1lcmFDb21wb25lbnQoc3lzdGVtLCBlbnRpdHkpIHtcbiAgICB0aGlzLm9uKFwic2V0X2FzcGVjdFJhdGlvXCIsIHRoaXMub25TZXRBc3BlY3RSYXRpbywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jYW1lcmFcIiwgdGhpcy5vblNldENhbWVyYSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jbGVhckNvbG9yXCIsIHRoaXMub25TZXRDbGVhckNvbG9yLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2ZvdlwiLCB0aGlzLm9uU2V0Rm92LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X29ydGhvSGVpZ2h0XCIsIHRoaXMub25TZXRPcnRob0hlaWdodCwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9uZWFyQ2xpcFwiLCB0aGlzLm9uU2V0TmVhckNsaXAsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfZmFyQ2xpcFwiLCB0aGlzLm9uU2V0RmFyQ2xpcCwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9wcm9qZWN0aW9uXCIsIHRoaXMub25TZXRQcm9qZWN0aW9uLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X3ByaW9yaXR5XCIsIHRoaXMub25TZXRQcmlvcml0eSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jbGVhckNvbG9yQnVmZmVyXCIsIHRoaXMudXBkYXRlQ2xlYXJGbGFncywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jbGVhckRlcHRoQnVmZmVyXCIsIHRoaXMudXBkYXRlQ2xlYXJGbGFncywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9jbGVhclN0ZW5jaWxCdWZmZXJcIiwgdGhpcy51cGRhdGVDbGVhckZsYWdzLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X3JlbmRlclRhcmdldFwiLCB0aGlzLm9uU2V0UmVuZGVyVGFyZ2V0LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X3JlY3RcIiwgdGhpcy5vblNldFJlY3QsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfc2Npc3NvclJlY3RcIiwgdGhpcy5vblNldFNjaXNzb3JSZWN0LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2hvcml6b250YWxGb3ZcIiwgdGhpcy5vblNldEhvcml6b250YWxGb3YsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfZnJ1c3R1bUN1bGxpbmdcIiwgdGhpcy5vblNldEZydXN0dW1DdWxsaW5nLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2NhbGN1bGF0ZVRyYW5zZm9ybVwiLCB0aGlzLm9uU2V0Q2FsY3VsYXRlVHJhbnNmb3JtLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2NhbGN1bGF0ZVByb2plY3Rpb25cIiwgdGhpcy5vblNldENhbGN1bGF0ZVByb2plY3Rpb24sIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfY3VsbEZhY2VzXCIsIHRoaXMub25TZXRDdWxsRmFjZXMsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfZmxpcEZhY2VzXCIsIHRoaXMub25TZXRGbGlwRmFjZXMsIHRoaXMpO1xuICB9O1xuICBDYW1lcmFDb21wb25lbnQgPSBwYy5pbmhlcml0cyhDYW1lcmFDb21wb25lbnQsIHBjLkNvbXBvbmVudCk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmFDb21wb25lbnQucHJvdG90eXBlLCBcInByb2plY3Rpb25NYXRyaXhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmNhbWVyYS5nZXRQcm9qZWN0aW9uTWF0cml4KCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENhbWVyYUNvbXBvbmVudC5wcm90b3R5cGUsIFwidmlld01hdHJpeFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciB3dG0gPSB0aGlzLmRhdGEuY2FtZXJhLl9ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgcmV0dXJuIHd0bS5jbG9uZSgpLmludmVydCgpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmFDb21wb25lbnQucHJvdG90eXBlLCBcImZydXN0dW1cIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmNhbWVyYS5mcnVzdHVtO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDYW1lcmFDb21wb25lbnQucHJvdG90eXBlLCBcInZyRGlzcGxheVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGEuY2FtZXJhLnZyRGlzcGxheTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5kYXRhLmNhbWVyYS52ckRpc3BsYXkgPSB2YWx1ZTtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHZhbHVlLl9jYW1lcmEgPSB0aGlzLmRhdGEuY2FtZXJhO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ2FtZXJhQ29tcG9uZW50LnByb3RvdHlwZSwgXCJub2RlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YS5jYW1lcmEuX25vZGU7XG4gIH19KTtcbiAgcGMuZXh0ZW5kKENhbWVyYUNvbXBvbmVudC5wcm90b3R5cGUsIHtzY3JlZW5Ub1dvcmxkOmZ1bmN0aW9uKHNjcmVlbngsIHNjcmVlbnksIGNhbWVyYXosIHdvcmxkQ29vcmQpIHtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlO1xuICAgIHJldHVybiB0aGlzLmRhdGEuY2FtZXJhLnNjcmVlblRvV29ybGQoc2NyZWVueCwgc2NyZWVueSwgY2FtZXJheiwgZGV2aWNlLmNsaWVudFJlY3Qud2lkdGgsIGRldmljZS5jbGllbnRSZWN0LmhlaWdodCwgd29ybGRDb29yZCk7XG4gIH0sIHdvcmxkVG9TY3JlZW46ZnVuY3Rpb24od29ybGRDb29yZCwgc2NyZWVuQ29vcmQpIHtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlO1xuICAgIHJldHVybiB0aGlzLmRhdGEuY2FtZXJhLndvcmxkVG9TY3JlZW4od29ybGRDb29yZCwgZGV2aWNlLmNsaWVudFJlY3Qud2lkdGgsIGRldmljZS5jbGllbnRSZWN0LmhlaWdodCwgc2NyZWVuQ29vcmQpO1xuICB9LCBvblNldEFzcGVjdFJhdGlvOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEuYXNwZWN0UmF0aW8gPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXRDYW1lcmE6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlKSB7XG4gICAgICBvbGRWYWx1ZS5fbm9kZSA9IG51bGw7XG4gICAgfVxuICAgIG5ld1ZhbHVlLl9ub2RlID0gdGhpcy5lbnRpdHk7XG4gIH0sIG9uU2V0Q2xlYXJDb2xvcjpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLmNsZWFyQ29sb3JbMF0gPSBuZXdWYWx1ZS5kYXRhWzBdO1xuICAgIHRoaXMuZGF0YS5jYW1lcmEuY2xlYXJDb2xvclsxXSA9IG5ld1ZhbHVlLmRhdGFbMV07XG4gICAgdGhpcy5kYXRhLmNhbWVyYS5jbGVhckNvbG9yWzJdID0gbmV3VmFsdWUuZGF0YVsyXTtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLmNsZWFyQ29sb3JbM10gPSBuZXdWYWx1ZS5kYXRhWzNdO1xuICB9LCBvblNldEZvdjpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLmZvdiA9IG5ld1ZhbHVlO1xuICB9LCBvblNldE9ydGhvSGVpZ2h0OmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEub3J0aG9IZWlnaHQgPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXROZWFyQ2xpcDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLm5lYXJDbGlwID0gbmV3VmFsdWU7XG4gIH0sIG9uU2V0RmFyQ2xpcDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLmZhckNsaXAgPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXRIb3Jpem9udGFsRm92OmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEuaG9yaXpvbnRhbEZvdiA9IG5ld1ZhbHVlO1xuICB9LCBvblNldEZydXN0dW1DdWxsaW5nOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEuZnJ1c3R1bUN1bGxpbmcgPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXRDYWxjdWxhdGVUcmFuc2Zvcm06ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fY2FsY3VsYXRlVHJhbnNmb3JtID0gbmV3VmFsdWU7XG4gICAgdGhpcy5jYW1lcmEub3ZlcnJpZGVDYWxjdWxhdGVUcmFuc2Zvcm0gPSAhIW5ld1ZhbHVlO1xuICB9LCBvblNldENhbGN1bGF0ZVByb2plY3Rpb246ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fY2FsY3VsYXRlUHJvamVjdGlvbiA9IG5ld1ZhbHVlO1xuICAgIHRoaXMuY2FtZXJhLl9wcm9qTWF0RGlydHkgPSB0cnVlO1xuICAgIHRoaXMuY2FtZXJhLm92ZXJyaWRlQ2FsY3VsYXRlUHJvamVjdGlvbiA9ICEhbmV3VmFsdWU7XG4gIH0sIG9uU2V0Q3VsbEZhY2VzOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuY2FtZXJhLl9jdWxsRmFjZXMgPSBuZXdWYWx1ZTtcbiAgfSwgb25TZXRGbGlwRmFjZXM6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5jYW1lcmEuX2ZsaXBGYWNlcyA9IG5ld1ZhbHVlO1xuICB9LCBvblNldFByb2plY3Rpb246ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5kYXRhLmNhbWVyYS5wcm9qZWN0aW9uID0gbmV3VmFsdWU7XG4gIH0sIG9uU2V0UHJpb3JpdHk6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5zeXN0ZW0uc29ydENhbWVyYXNCeVByaW9yaXR5KCk7XG4gIH0sIHVwZGF0ZUNsZWFyRmxhZ3M6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGZsYWdzID0gMDtcbiAgICBpZiAodGhpcy5jbGVhckNvbG9yQnVmZmVyKSB7XG4gICAgICBmbGFncyA9IGZsYWdzIHwgcGMuQ0xFQVJGTEFHX0NPTE9SO1xuICAgIH1cbiAgICBpZiAodGhpcy5jbGVhckRlcHRoQnVmZmVyKSB7XG4gICAgICBmbGFncyA9IGZsYWdzIHwgcGMuQ0xFQVJGTEFHX0RFUFRIO1xuICAgIH1cbiAgICBpZiAodGhpcy5jbGVhclN0ZW5jaWxCdWZmZXIpIHtcbiAgICAgIGZsYWdzID0gZmxhZ3MgfCBwYy5DTEVBUkZMQUdfU1RFTkNJTDtcbiAgICB9XG4gICAgdGhpcy5kYXRhLmNhbWVyYS5jbGVhckZsYWdzID0gZmxhZ3M7XG4gIH0sIG9uU2V0UmVuZGVyVGFyZ2V0OmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEucmVuZGVyVGFyZ2V0ID0gbmV3VmFsdWU7XG4gIH0sIG9uU2V0UmVjdDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB0aGlzLmRhdGEuY2FtZXJhLnNldFJlY3QobmV3VmFsdWUuZGF0YVswXSwgbmV3VmFsdWUuZGF0YVsxXSwgbmV3VmFsdWUuZGF0YVsyXSwgbmV3VmFsdWUuZGF0YVszXSk7XG4gICAgdGhpcy5fcmVzZXRBc3BlY3RSYXRpbygpO1xuICB9LCBvblNldFNjaXNzb3JSZWN0OmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHRoaXMuZGF0YS5jYW1lcmEuc2V0U2Npc3NvclJlY3QobmV3VmFsdWUuZGF0YVswXSwgbmV3VmFsdWUuZGF0YVsxXSwgbmV3VmFsdWUuZGF0YVsyXSwgbmV3VmFsdWUuZGF0YVszXSk7XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIENhbWVyYUNvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICB0aGlzLnN5c3RlbS5hZGRDYW1lcmEodGhpcyk7XG4gICAgdGhpcy5wb3N0RWZmZWN0cy5lbmFibGUoKTtcbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIENhbWVyYUNvbXBvbmVudC5fc3VwZXIub25EaXNhYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy5wb3N0RWZmZWN0cy5kaXNhYmxlKCk7XG4gICAgdGhpcy5zeXN0ZW0ucmVtb3ZlQ2FtZXJhKHRoaXMpO1xuICB9LCBfcmVzZXRBc3BlY3RSYXRpbzpmdW5jdGlvbigpIHtcbiAgICB2YXIgY2FtZXJhID0gdGhpcy5jYW1lcmE7XG4gICAgaWYgKGNhbWVyYSkge1xuICAgICAgaWYgKGNhbWVyYS5yZW5kZXJUYXJnZXQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdmFyIGRldmljZSA9IHRoaXMuc3lzdGVtLmFwcC5ncmFwaGljc0RldmljZTtcbiAgICAgIHZhciByZWN0ID0gdGhpcy5yZWN0O1xuICAgICAgdGhpcy5hc3BlY3RSYXRpbyA9IGRldmljZS53aWR0aCAqIHJlY3QueiAvIChkZXZpY2UuaGVpZ2h0ICogcmVjdC53KTtcbiAgICB9XG4gIH0sIGZyYW1lQmVnaW46ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fcmVzZXRBc3BlY3RSYXRpbygpO1xuICAgIHRoaXMuZGF0YS5pc1JlbmRlcmluZyA9IHRydWU7XG4gIH0sIGZyYW1lRW5kOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZGF0YS5pc1JlbmRlcmluZyA9IGZhbHNlO1xuICB9LCBlbnRlclZyOmZ1bmN0aW9uKGRpc3BsYXksIGNhbGxiYWNrKSB7XG4gICAgaWYgKGRpc3BsYXkgaW5zdGFuY2VvZiBGdW5jdGlvbiAmJiAhY2FsbGJhY2spIHtcbiAgICAgIGNhbGxiYWNrID0gZGlzcGxheTtcbiAgICAgIGRpc3BsYXkgPSBudWxsO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuc3lzdGVtLmFwcC52cikge1xuICAgICAgY2FsbGJhY2soXCJWck1hbmFnZXIgbm90IGNyZWF0ZWQuIEVuYWJsZSBWUiBpbiBwcm9qZWN0IHNldHRpbmdzLlwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCFkaXNwbGF5KSB7XG4gICAgICBkaXNwbGF5ID0gdGhpcy5zeXN0ZW0uYXBwLnZyLmRpc3BsYXk7XG4gICAgfVxuICAgIGlmIChkaXNwbGF5KSB7XG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICBpZiAoZGlzcGxheS5jYXBhYmlsaXRpZXMuY2FuUHJlc2VudCkge1xuICAgICAgICBkaXNwbGF5LnJlcXVlc3RQcmVzZW50KGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICBzZWxmLnZyRGlzcGxheSA9IGRpc3BsYXk7XG4gICAgICAgICAgICBzZWxmLnZyRGlzcGxheS5vbmNlKFwiYmVmb3JlcHJlc2VudGNoYW5nZVwiLCBmdW5jdGlvbihkaXNwbGF5KSB7XG4gICAgICAgICAgICAgIGlmICghZGlzcGxheS5wcmVzZW50aW5nKSB7XG4gICAgICAgICAgICAgICAgc2VsZi52ckRpc3BsYXkgPSBudWxsO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZWxmLnZyRGlzcGxheSA9IGRpc3BsYXk7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxiYWNrKFwiTm8gcGMuVnJEaXNwbGF5IHRvIHByZXNlbnRcIik7XG4gICAgfVxuICB9LCBleGl0VnI6ZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy52ckRpc3BsYXkpIHtcbiAgICAgIGlmICh0aGlzLnZyRGlzcGxheS5jYXBhYmlsaXRpZXMuY2FuUHJlc2VudCkge1xuICAgICAgICB2YXIgZGlzcGxheSA9IHRoaXMudnJEaXNwbGF5O1xuICAgICAgICB0aGlzLnZyRGlzcGxheSA9IG51bGw7XG4gICAgICAgIGRpc3BsYXkuZXhpdFByZXNlbnQoY2FsbGJhY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy52ckRpc3BsYXkgPSBudWxsO1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjYWxsYmFjayhcIk5vdCBwcmVzZW50aW5nIFZSXCIpO1xuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge0NhbWVyYUNvbXBvbmVudDpDYW1lcmFDb21wb25lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBfc2NoZW1hID0gW1wiZW5hYmxlZFwiLCBcImNsZWFyQ29sb3JCdWZmZXJcIiwgXCJjbGVhckNvbG9yXCIsIFwiY2xlYXJEZXB0aEJ1ZmZlclwiLCBcImNsZWFyU3RlbmNpbEJ1ZmZlclwiLCBcImZydXN0dW1DdWxsaW5nXCIsIFwicHJvamVjdGlvblwiLCBcImZvdlwiLCBcIm9ydGhvSGVpZ2h0XCIsIFwibmVhckNsaXBcIiwgXCJmYXJDbGlwXCIsIFwicHJpb3JpdHlcIiwgXCJyZWN0XCIsIFwic2Npc3NvclJlY3RcIiwgXCJjYW1lcmFcIiwgXCJhc3BlY3RSYXRpb1wiLCBcImhvcml6b250YWxGb3ZcIiwgXCJtb2RlbFwiLCBcInJlbmRlclRhcmdldFwiLCBcImNhbGN1bGF0ZVRyYW5zZm9ybVwiLCBcImNhbGN1bGF0ZVByb2plY3Rpb25cIiwgXCJjdWxsRmFjZXNcIiwgXCJmbGlwRmFjZXNcIl07XG4gIHZhciBDYW1lcmFDb21wb25lbnRTeXN0ZW0gPSBmdW5jdGlvbihhcHApIHtcbiAgICB0aGlzLmlkID0gXCJjYW1lcmFcIjtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gXCJSZW5kZXJzIHRoZSBzY2VuZSBmcm9tIHRoZSBsb2NhdGlvbiBvZiB0aGUgRW50aXR5LlwiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5DYW1lcmFDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLkNhbWVyYUNvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMuY2FtZXJhcyA9IFtdO1xuICAgIHRoaXMub24oXCJiZWZvcmVyZW1vdmVcIiwgdGhpcy5vbkJlZm9yZVJlbW92ZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInJlbW92ZVwiLCB0aGlzLm9uUmVtb3ZlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJ1cGRhdGVcIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gIH07XG4gIENhbWVyYUNvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKENhbWVyYUNvbXBvbmVudFN5c3RlbSwgcGMuQ29tcG9uZW50U3lzdGVtKTtcbiAgcGMuQ29tcG9uZW50Ll9idWlsZEFjY2Vzc29ycyhwYy5DYW1lcmFDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKENhbWVyYUNvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIF9kYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcyA9IFtcInBvc3RFZmZlY3RzXCIsIFwiZW5hYmxlZFwiLCBcIm1vZGVsXCIsIFwiY2FtZXJhXCIsIFwiYXNwZWN0UmF0aW9cIiwgXCJob3Jpem9udGFsRm92XCIsIFwicmVuZGVyVGFyZ2V0XCIsIFwiY2xlYXJDb2xvclwiLCBcImZvdlwiLCBcIm9ydGhvSGVpZ2h0XCIsIFwibmVhckNsaXBcIiwgXCJmYXJDbGlwXCIsIFwicHJvamVjdGlvblwiLCBcInByaW9yaXR5XCIsIFwiY2xlYXJDb2xvckJ1ZmZlclwiLCBcImNsZWFyRGVwdGhCdWZmZXJcIiwgXCJjbGVhclN0ZW5jaWxCdWZmZXJcIiwgXCJmcnVzdHVtQ3VsbGluZ1wiLCBcInJlY3RcIiwgXCJzY2lzc29yUmVjdFwiLCBcImNhbGN1bGF0ZVRyYW5zZm9ybVwiLCBcImNhbGN1bGF0ZVByb2plY3Rpb25cIiwgXCJjdWxsRmFjZXNcIiwgXCJmbGlwRmFjZXNcIl07XG4gICAgdmFyIGRhdGEgPSB7fTtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgZGF0YVtwcm9wXSA9IF9kYXRhW3Byb3BdO1xuICAgIH0pO1xuICAgIGlmIChkYXRhLmNsZWFyQ29sb3IgJiYgcGMudHlwZShkYXRhLmNsZWFyQ29sb3IpID09PSBcImFycmF5XCIpIHtcbiAgICAgIHZhciBjID0gZGF0YS5jbGVhckNvbG9yO1xuICAgICAgZGF0YS5jbGVhckNvbG9yID0gbmV3IHBjLkNvbG9yKGNbMF0sIGNbMV0sIGNbMl0sIGNbM10pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5yZWN0ICYmIHBjLnR5cGUoZGF0YS5yZWN0KSA9PT0gXCJhcnJheVwiKSB7XG4gICAgICB2YXIgcmVjdCA9IGRhdGEucmVjdDtcbiAgICAgIGRhdGEucmVjdCA9IG5ldyBwYy5WZWM0KHJlY3RbMF0sIHJlY3RbMV0sIHJlY3RbMl0sIHJlY3RbM10pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5zY2lzc29yUmVjdCAmJiBwYy50eXBlKGRhdGEuc2Npc3NvclJlY3QpID09PSBcImFycmF5XCIpIHtcbiAgICAgIHZhciBzY2lzc29yUmVjdCA9IGRhdGEuc2Npc3NvclJlY3Q7XG4gICAgICBkYXRhLnNjaXNzb3JSZWN0ID0gbmV3IHBjLlZlYzQoc2Npc3NvclJlY3RbMF0sIHNjaXNzb3JSZWN0WzFdLCBzY2lzc29yUmVjdFsyXSwgc2Npc3NvclJlY3RbM10pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5hY3RpdmF0ZSkge1xuICAgICAgY29uc29sZS53YXJuKFwiV0FSTklORzogYWN0aXZhdGU6IFByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuIFNldCBlbmFibGVkIHByb3BlcnR5IGluc3RlYWQuXCIpO1xuICAgICAgZGF0YS5lbmFibGVkID0gZGF0YS5hY3RpdmF0ZTtcbiAgICB9XG4gICAgZGF0YS5jYW1lcmEgPSBuZXcgcGMuQ2FtZXJhO1xuICAgIGRhdGEuX25vZGUgPSBjb21wb25lbnQuZW50aXR5O1xuICAgIHZhciBzZWxmID0gY29tcG9uZW50O1xuICAgIGRhdGEuY2FtZXJhLmNhbGN1bGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKG1hdCwgbW9kZSkge1xuICAgICAgaWYgKCFzZWxmLl9jYWxjdWxhdGVUcmFuc2Zvcm0pIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICByZXR1cm4gc2VsZi5fY2FsY3VsYXRlVHJhbnNmb3JtKG1hdCwgbW9kZSk7XG4gICAgfTtcbiAgICBkYXRhLmNhbWVyYS5jYWxjdWxhdGVQcm9qZWN0aW9uID0gZnVuY3Rpb24obWF0LCBtb2RlKSB7XG4gICAgICBpZiAoIXNlbGYuX2NhbGN1bGF0ZVByb2plY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICByZXR1cm4gc2VsZi5fY2FsY3VsYXRlUHJvamVjdGlvbihtYXQsIG1vZGUpO1xuICAgIH07XG4gICAgZGF0YS5wb3N0RWZmZWN0cyA9IG5ldyBwYy5Qb3N0RWZmZWN0UXVldWUodGhpcy5hcHAsIGNvbXBvbmVudCk7XG4gICAgQ2FtZXJhQ29tcG9uZW50U3lzdGVtLl9zdXBlci5pbml0aWFsaXplQ29tcG9uZW50RGF0YS5jYWxsKHRoaXMsIGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcyk7XG4gIH0sIG9uQmVmb3JlUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgY29tcG9uZW50KSB7XG4gICAgdGhpcy5yZW1vdmVDYW1lcmEoY29tcG9uZW50KTtcbiAgfSwgb25SZW1vdmU6ZnVuY3Rpb24oZW50aXR5LCBkYXRhKSB7XG4gICAgZGF0YS5jYW1lcmEgPSBudWxsO1xuICB9LCBvblVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHZhciBjb21wb25lbnRzID0gdGhpcy5zdG9yZTtcbiAgICB2YXIgY29tcG9uZW50LCBjb21wb25lbnREYXRhLCBjYW0sIHZyRGlzcGxheTtcbiAgICBpZiAodGhpcy5hcHAudnIpIHtcbiAgICAgIGZvciAodmFyIGlkIGluIGNvbXBvbmVudHMpIHtcbiAgICAgICAgY29tcG9uZW50ID0gY29tcG9uZW50c1tpZF07XG4gICAgICAgIGNvbXBvbmVudERhdGEgPSBjb21wb25lbnQuZGF0YTtcbiAgICAgICAgY2FtID0gY29tcG9uZW50RGF0YS5jYW1lcmE7XG4gICAgICAgIHZyRGlzcGxheSA9IGNhbS52ckRpc3BsYXk7XG4gICAgICAgIGlmIChjb21wb25lbnREYXRhLmVuYWJsZWQgJiYgY29tcG9uZW50LmVudGl0eS5lbmFibGVkICYmIHZyRGlzcGxheSkge1xuICAgICAgICAgIHZyRGlzcGxheS5zZXRDbGlwUGxhbmVzKGNhbS5fbmVhckNsaXAsIGNhbS5fZmFyQ2xpcCk7XG4gICAgICAgICAgaWYgKGNhbS5fbm9kZSkge1xuICAgICAgICAgICAgY2FtLl9ub2RlLmxvY2FsVHJhbnNmb3JtLmNvcHkodnJEaXNwbGF5LmNvbWJpbmVkVmlld0ludik7XG4gICAgICAgICAgICBjYW0uX25vZGUuX2RpcnR5TG9jYWwgPSBmYWxzZTtcbiAgICAgICAgICAgIGNhbS5fbm9kZS5fZGlydGlmeSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgYWRkQ2FtZXJhOmZ1bmN0aW9uKGNhbWVyYSkge1xuICAgIHRoaXMuY2FtZXJhcy5wdXNoKGNhbWVyYSk7XG4gICAgdGhpcy5zb3J0Q2FtZXJhc0J5UHJpb3JpdHkoKTtcbiAgfSwgcmVtb3ZlQ2FtZXJhOmZ1bmN0aW9uKGNhbWVyYSkge1xuICAgIHZhciBpbmRleCA9IHRoaXMuY2FtZXJhcy5pbmRleE9mKGNhbWVyYSk7XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgIHRoaXMuY2FtZXJhcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgdGhpcy5zb3J0Q2FtZXJhc0J5UHJpb3JpdHkoKTtcbiAgICB9XG4gIH0sIHNvcnRDYW1lcmFzQnlQcmlvcml0eTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNhbWVyYXMuc29ydChmdW5jdGlvbihhLCBiKSB7XG4gICAgICByZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7XG4gICAgfSk7XG4gIH19KTtcbiAgcmV0dXJuIHtDYW1lcmFDb21wb25lbnRTeXN0ZW06Q2FtZXJhQ29tcG9uZW50U3lzdGVtfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQ2FtZXJhQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuY2xlYXJDb2xvciA9IG5ldyBwYy5Db2xvcigwLjcyMiwgMC43MjIsIDAuNzIyLCAxKTtcbiAgICB0aGlzLmNsZWFyQ29sb3JCdWZmZXIgPSB0cnVlO1xuICAgIHRoaXMuY2xlYXJEZXB0aEJ1ZmZlciA9IHRydWU7XG4gICAgdGhpcy5jbGVhclN0ZW5jaWxCdWZmZXIgPSB0cnVlO1xuICAgIHRoaXMubmVhckNsaXAgPSAwLjE7XG4gICAgdGhpcy5mYXJDbGlwID0gMTAwMDtcbiAgICB0aGlzLmZvdiA9IDQ1O1xuICAgIHRoaXMub3J0aG9IZWlnaHQgPSAxMDA7XG4gICAgdGhpcy5wcm9qZWN0aW9uID0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRTtcbiAgICB0aGlzLnByaW9yaXR5ID0gMDtcbiAgICB0aGlzLnJlY3QgPSBuZXcgcGMuVmVjNCgwLCAwLCAxLCAxKTtcbiAgICB0aGlzLnNjaXNzb3JSZWN0ID0gbmV3IHBjLlZlYzQoMCwgMCwgMSwgMSk7XG4gICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgICB0aGlzLmZydXN0dW1DdWxsaW5nID0gZmFsc2U7XG4gICAgdGhpcy5jdWxsRmFjZXMgPSB0cnVlO1xuICAgIHRoaXMuZmxpcEZhY2VzID0gZmFsc2U7XG4gICAgdGhpcy5jYW1lcmEgPSBudWxsO1xuICAgIHRoaXMuYXNwZWN0UmF0aW8gPSAxNiAvIDk7XG4gICAgdGhpcy5yZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgIHRoaXMucG9zdEVmZmVjdHMgPSBudWxsO1xuICAgIHRoaXMuaXNSZW5kZXJpbmcgPSBmYWxzZTtcbiAgICB0aGlzLmNhbGN1bGF0ZVRyYW5zZm9ybSA9IG51bGw7XG4gICAgdGhpcy5jYWxjdWxhdGVQcm9qZWN0aW9uID0gbnVsbDtcbiAgfTtcbiAgQ2FtZXJhQ29tcG9uZW50RGF0YSA9IHBjLmluaGVyaXRzKENhbWVyYUNvbXBvbmVudERhdGEsIHBjLkNvbXBvbmVudERhdGEpO1xuICByZXR1cm4ge0NhbWVyYUNvbXBvbmVudERhdGE6Q2FtZXJhQ29tcG9uZW50RGF0YX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgZnVuY3Rpb24gUG9zdEVmZmVjdFF1ZXVlKGFwcCwgY2FtZXJhKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHRoaXMuYXBwID0gYXBwO1xuICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhO1xuICAgIHRoaXMuZWZmZWN0cyA9IFtdO1xuICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlO1xuICAgIHRoaXMuZGVwdGhUYXJnZXQgPSBudWxsO1xuICAgIHRoaXMucmVuZGVyVGFyZ2V0U2NhbGUgPSAxO1xuICAgIHRoaXMucmVzaXplVGltZW91dCA9IG51bGw7XG4gICAgdGhpcy5yZXNpemVMYXN0ID0gMDtcbiAgICB0aGlzLl9yZXNpemVUaW1lb3V0Q2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIHNlbGYucmVzaXplUmVuZGVyVGFyZ2V0cygpO1xuICAgIH07XG4gICAgY2FtZXJhLm9uKFwic2V0X3JlY3RcIiwgdGhpcy5vbkNhbWVyYVJlY3RDaGFuZ2VkLCB0aGlzKTtcbiAgfVxuICBQb3N0RWZmZWN0UXVldWUucHJvdG90eXBlID0ge19jcmVhdGVPZmZzY3JlZW5UYXJnZXQ6ZnVuY3Rpb24odXNlRGVwdGgsIGhkcikge1xuICAgIHZhciByZWN0ID0gdGhpcy5jYW1lcmEucmVjdDtcbiAgICB2YXIgd2lkdGggPSBNYXRoLmZsb29yKHJlY3QueiAqIHRoaXMuYXBwLmdyYXBoaWNzRGV2aWNlLndpZHRoICogdGhpcy5yZW5kZXJUYXJnZXRTY2FsZSk7XG4gICAgdmFyIGhlaWdodCA9IE1hdGguZmxvb3IocmVjdC53ICogdGhpcy5hcHAuZ3JhcGhpY3NEZXZpY2UuaGVpZ2h0ICogdGhpcy5yZW5kZXJUYXJnZXRTY2FsZSk7XG4gICAgdmFyIGRldmljZSA9IHRoaXMuYXBwLmdyYXBoaWNzRGV2aWNlO1xuICAgIHZhciBmb3JtYXQgPSBoZHIgPyBkZXZpY2UuZ2V0SGRyRm9ybWF0KCkgOiBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BODtcbiAgICB2YXIgY29sb3JCdWZmZXIgPSBuZXcgcGMuVGV4dHVyZShkZXZpY2UsIHtmb3JtYXQ6Zm9ybWF0LCB3aWR0aDp3aWR0aCwgaGVpZ2h0OmhlaWdodH0pO1xuICAgIGNvbG9yQnVmZmVyLm1pbkZpbHRlciA9IHBjLkZJTFRFUl9ORUFSRVNUO1xuICAgIGNvbG9yQnVmZmVyLm1hZ0ZpbHRlciA9IHBjLkZJTFRFUl9ORUFSRVNUO1xuICAgIGNvbG9yQnVmZmVyLmFkZHJlc3NVID0gcGMuQUREUkVTU19DTEFNUF9UT19FREdFO1xuICAgIGNvbG9yQnVmZmVyLmFkZHJlc3NWID0gcGMuQUREUkVTU19DTEFNUF9UT19FREdFO1xuICAgIHJldHVybiBuZXcgcGMuUmVuZGVyVGFyZ2V0KHRoaXMuYXBwLmdyYXBoaWNzRGV2aWNlLCBjb2xvckJ1ZmZlciwge2RlcHRoOnVzZURlcHRofSk7XG4gIH0sIHNldFJlbmRlclRhcmdldFNjYWxlOmZ1bmN0aW9uKHNjYWxlKSB7XG4gICAgdGhpcy5yZW5kZXJUYXJnZXRTY2FsZSA9IHNjYWxlO1xuICAgIHRoaXMucmVzaXplUmVuZGVyVGFyZ2V0cygpO1xuICB9LCBhZGRFZmZlY3Q6ZnVuY3Rpb24oZWZmZWN0KSB7XG4gICAgdmFyIGlzRmlyc3RFZmZlY3QgPSB0aGlzLmVmZmVjdHMubGVuZ3RoID09PSAwO1xuICAgIHZhciBlZmZlY3RzID0gdGhpcy5lZmZlY3RzO1xuICAgIHZhciBuZXdFbnRyeSA9IHtlZmZlY3Q6ZWZmZWN0LCBpbnB1dFRhcmdldDp0aGlzLl9jcmVhdGVPZmZzY3JlZW5UYXJnZXQoaXNGaXJzdEVmZmVjdCwgZWZmZWN0LmhkciksIG91dHB1dFRhcmdldDpudWxsfTtcbiAgICBpZiAoaXNGaXJzdEVmZmVjdCkge1xuICAgICAgdGhpcy5jYW1lcmEucmVuZGVyVGFyZ2V0ID0gbmV3RW50cnkuaW5wdXRUYXJnZXQ7XG4gICAgfVxuICAgIGVmZmVjdHMucHVzaChuZXdFbnRyeSk7XG4gICAgdmFyIGxlbiA9IGVmZmVjdHMubGVuZ3RoO1xuICAgIGlmIChsZW4gPiAxKSB7XG4gICAgICBlZmZlY3RzW2xlbiAtIDJdLm91dHB1dFRhcmdldCA9IG5ld0VudHJ5LmlucHV0VGFyZ2V0O1xuICAgIH1cbiAgICB0aGlzLmVuYWJsZSgpO1xuICB9LCByZW1vdmVFZmZlY3Q6ZnVuY3Rpb24oZWZmZWN0KSB7XG4gICAgdmFyIGluZGV4ID0gLTE7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuZWZmZWN0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmICh0aGlzLmVmZmVjdHNbaV0uZWZmZWN0ID09PSBlZmZlY3QpIHtcbiAgICAgICAgaW5kZXggPSBpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgIGlmIChpbmRleCA+IDApIHtcbiAgICAgICAgdGhpcy5lZmZlY3RzW2luZGV4IC0gMV0ub3V0cHV0VGFyZ2V0ID0gaW5kZXggKyAxIDwgdGhpcy5lZmZlY3RzLmxlbmd0aCA/IHRoaXMuZWZmZWN0c1tpbmRleCArIDFdLmlucHV0VGFyZ2V0IDogbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLmVmZmVjdHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgIGlmICghdGhpcy5lZmZlY3RzWzFdLmlucHV0VGFyZ2V0Ll9kZXB0aCkge1xuICAgICAgICAgICAgdGhpcy5lZmZlY3RzWzFdLmlucHV0VGFyZ2V0LmRlc3Ryb3koKTtcbiAgICAgICAgICAgIHRoaXMuZWZmZWN0c1sxXS5pbnB1dFRhcmdldCA9IHRoaXMuX2NyZWF0ZU9mZnNjcmVlblRhcmdldCh0cnVlLCB0aGlzLmVmZmVjdHNbMV0uaGRyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5jYW1lcmEucmVuZGVyVGFyZ2V0ID0gdGhpcy5lZmZlY3RzWzFdLmlucHV0VGFyZ2V0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmVmZmVjdHNbaW5kZXhdLmlucHV0VGFyZ2V0LmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuZWZmZWN0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgICBpZiAodGhpcy5lbmFibGVkKSB7XG4gICAgICBpZiAoZWZmZWN0Lm5lZWRzRGVwdGhCdWZmZXIpIHtcbiAgICAgICAgdGhpcy5jYW1lcmEucmVsZWFzZURlcHRoTWFwKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmVmZmVjdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLmRpc2FibGUoKTtcbiAgICB9XG4gIH0sIHJlcXVlc3REZXB0aE1hcDpmdW5jdGlvbigpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5lZmZlY3RzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdmFyIGVmZmVjdCA9IHRoaXMuZWZmZWN0c1tpXS5lZmZlY3Q7XG4gICAgICBpZiAoZWZmZWN0Lm5lZWRzRGVwdGhCdWZmZXIpIHtcbiAgICAgICAgdGhpcy5jYW1lcmEuY2FtZXJhLnJlcXVlc3REZXB0aE1hcCgpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgcmVsZWFzZURlcHRoTWFwOmZ1bmN0aW9uKCkge1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmVmZmVjdHMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgZWZmZWN0ID0gdGhpcy5lZmZlY3RzW2ldLmVmZmVjdDtcbiAgICAgIGlmIChlZmZlY3QubmVlZHNEZXB0aEJ1ZmZlcikge1xuICAgICAgICB0aGlzLmNhbWVyYS5yZWxlYXNlRGVwdGhNYXAoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGRlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuZWZmZWN0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHRoaXMuZWZmZWN0c1tpXS5pbnB1dFRhcmdldC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuZWZmZWN0cy5sZW5ndGggPSAwO1xuICAgIHRoaXMuZGlzYWJsZSgpO1xuICB9LCBlbmFibGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgJiYgdGhpcy5lZmZlY3RzLmxlbmd0aCkge1xuICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgIHRoaXMucmVxdWVzdERlcHRoTWFwKCk7XG4gICAgICB0aGlzLmFwcC5ncmFwaGljc0RldmljZS5vbihcInJlc2l6ZWNhbnZhc1wiLCB0aGlzLl9vbkNhbnZhc1Jlc2l6ZWQsIHRoaXMpO1xuICAgICAgc2VsZi5jYW1lcmEuY2FtZXJhLnNldFJlY3QoMCwgMCwgMSwgMSk7XG4gICAgICB0aGlzLmNvbW1hbmQgPSBuZXcgcGMuQ29tbWFuZChwYy5MQVlFUl9GWCwgcGMuQkxFTkRfTk9ORSwgZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChzZWxmLmVuYWJsZWQgJiYgc2VsZi5jYW1lcmEuZGF0YS5pc1JlbmRlcmluZykge1xuICAgICAgICAgIHZhciByZWN0ID0gbnVsbDtcbiAgICAgICAgICB2YXIgbGVuID0gc2VsZi5lZmZlY3RzLmxlbmd0aDtcbiAgICAgICAgICBpZiAobGVuKSB7XG4gICAgICAgICAgICBzZWxmLmNhbWVyYS5yZW5kZXJUYXJnZXQgPSBzZWxmLmVmZmVjdHNbMF0uaW5wdXRUYXJnZXQ7XG4gICAgICAgICAgICBzZWxmLmRlcHRoVGFyZ2V0ID0gc2VsZi5jYW1lcmEuY2FtZXJhLl9kZXB0aFRhcmdldDtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgICAgIHZhciBmeCA9IHNlbGYuZWZmZWN0c1tpXTtcbiAgICAgICAgICAgICAgaWYgKHNlbGYuZGVwdGhUYXJnZXQpIHtcbiAgICAgICAgICAgICAgICBmeC5lZmZlY3QuZGVwdGhNYXAgPSBzZWxmLmRlcHRoVGFyZ2V0LmNvbG9yQnVmZmVyO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChpID09PSBsZW4gLSAxKSB7XG4gICAgICAgICAgICAgICAgcmVjdCA9IHNlbGYuY2FtZXJhLnJlY3Q7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZnguZWZmZWN0LnJlbmRlcihmeC5pbnB1dFRhcmdldCwgZngub3V0cHV0VGFyZ2V0LCByZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5hcHAuc2NlbmUuZHJhd0NhbGxzLnB1c2godGhpcy5jb21tYW5kKTtcbiAgICB9XG4gIH0sIGRpc2FibGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuZW5hYmxlZCkge1xuICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLmFwcC5ncmFwaGljc0RldmljZS5vZmYoXCJyZXNpemVjYW52YXNcIiwgdGhpcy5fb25DYW52YXNSZXNpemVkLCB0aGlzKTtcbiAgICAgIHRoaXMuY2FtZXJhLnJlbmRlclRhcmdldCA9IG51bGw7XG4gICAgICB0aGlzLnJlbGVhc2VEZXB0aE1hcCgpO1xuICAgICAgdmFyIHJlY3QgPSB0aGlzLmNhbWVyYS5yZWN0O1xuICAgICAgdGhpcy5jYW1lcmEuY2FtZXJhLnNldFJlY3QocmVjdC54LCByZWN0LnksIHJlY3QueiwgcmVjdC53KTtcbiAgICAgIHZhciBpID0gdGhpcy5hcHAuc2NlbmUuZHJhd0NhbGxzLmluZGV4T2YodGhpcy5jb21tYW5kKTtcbiAgICAgIGlmIChpID49IDApIHtcbiAgICAgICAgdGhpcy5hcHAuc2NlbmUuZHJhd0NhbGxzLnNwbGljZShpLCAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vbkNhbnZhc1Jlc2l6ZWQ6ZnVuY3Rpb24od2lkdGgsIGhlaWdodCkge1xuICAgIHZhciByZWN0ID0gdGhpcy5jYW1lcmEucmVjdDtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5hcHAuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdGhpcy5jYW1lcmEuY2FtZXJhLmFzcGVjdFJhdGlvID0gZGV2aWNlLndpZHRoICogcmVjdC56IC8gKGRldmljZS5oZWlnaHQgKiByZWN0LncpO1xuICAgIGlmICh0aGlzLnJlc2l6ZVRpbWVvdXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHBjLm5vdygpIC0gdGhpcy5yZXNpemVMYXN0ID4gMTAwKSB7XG4gICAgICB0aGlzLnJlc2l6ZVJlbmRlclRhcmdldHMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZXNpemVUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9yZXNpemVUaW1lb3V0Q2FsbGJhY2ssIDEwMCk7XG4gICAgfVxuICB9LCByZXNpemVSZW5kZXJUYXJnZXRzOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLnJlc2l6ZVRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlc2l6ZVRpbWVvdXQpO1xuICAgICAgdGhpcy5yZXNpemVUaW1lb3V0ID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5yZXNpemVMYXN0ID0gcGMubm93KCk7XG4gICAgdmFyIHJlY3QgPSB0aGlzLmNhbWVyYS5yZWN0O1xuICAgIHZhciBkZXNpcmVkV2lkdGggPSBNYXRoLmZsb29yKHJlY3QueiAqIHRoaXMuYXBwLmdyYXBoaWNzRGV2aWNlLndpZHRoICogdGhpcy5yZW5kZXJUYXJnZXRTY2FsZSk7XG4gICAgdmFyIGRlc2lyZWRIZWlnaHQgPSBNYXRoLmZsb29yKHJlY3QudyAqIHRoaXMuYXBwLmdyYXBoaWNzRGV2aWNlLmhlaWdodCAqIHRoaXMucmVuZGVyVGFyZ2V0U2NhbGUpO1xuICAgIHZhciBlZmZlY3RzID0gdGhpcy5lZmZlY3RzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBlZmZlY3RzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdmFyIGZ4ID0gZWZmZWN0c1tpXTtcbiAgICAgIGlmIChmeC5pbnB1dFRhcmdldC53aWR0aCAhPT0gZGVzaXJlZFdpZHRoIHx8IGZ4LmlucHV0VGFyZ2V0LmhlaWdodCAhPT0gZGVzaXJlZEhlaWdodCkge1xuICAgICAgICBmeC5pbnB1dFRhcmdldC5kZXN0cm95KCk7XG4gICAgICAgIGZ4LmlucHV0VGFyZ2V0ID0gdGhpcy5fY3JlYXRlT2Zmc2NyZWVuVGFyZ2V0KGZ4LmVmZmVjdC5uZWVkc0RlcHRoQnVmZmVyIHx8IGkgPT09IDAsIGZ4Lmhkcik7XG4gICAgICAgIGlmIChpID4gMCkge1xuICAgICAgICAgIGVmZmVjdHNbaSAtIDFdLm91dHB1dFRhcmdldCA9IGZ4LmlucHV0VGFyZ2V0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuY2FtZXJhLnJlbmRlclRhcmdldCA9IGZ4LmlucHV0VGFyZ2V0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkNhbWVyYVJlY3RDaGFuZ2VkOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmICh0aGlzLmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuY2FtZXJhLmNhbWVyYS5zZXRSZWN0KDAsIDAsIDEsIDEpO1xuICAgICAgdGhpcy5yZXNpemVSZW5kZXJUYXJnZXRzKCk7XG4gICAgfVxuICB9fTtcbiAgcmV0dXJuIHtQb3N0RWZmZWN0UXVldWU6UG9zdEVmZmVjdFF1ZXVlfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3Byb3BzID0gW107XG4gIHZhciBfcHJvcHNEZWZhdWx0ID0gW107XG4gIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShuYW1lLCBkZWZhdWx0VmFsdWUsIHNldEZ1bmMsIHNraXBFcXVhbHNDaGVjaykge1xuICAgIHZhciBjID0gTGlnaHRDb21wb25lbnQucHJvdG90eXBlO1xuICAgIF9wcm9wcy5wdXNoKG5hbWUpO1xuICAgIF9wcm9wc0RlZmF1bHQucHVzaChkZWZhdWx0VmFsdWUpO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjLCBuYW1lLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YVtuYW1lXTtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgdmFyIG9sZFZhbHVlID0gZGF0YVtuYW1lXTtcbiAgICAgIGlmICghc2tpcEVxdWFsc0NoZWNrICYmIG9sZFZhbHVlID09PSB2YWx1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkYXRhW25hbWVdID0gdmFsdWU7XG4gICAgICBpZiAoc2V0RnVuYykge1xuICAgICAgICBzZXRGdW5jLmNhbGwodGhpcywgdmFsdWUsIG9sZFZhbHVlKTtcbiAgICAgIH1cbiAgICB9LCBjb25maWd1cmFibGU6dHJ1ZX0pO1xuICB9XG4gIHZhciBMaWdodENvbXBvbmVudCA9IGZ1bmN0aW9uIExpZ2h0Q29tcG9uZW50KHN5c3RlbSwgZW50aXR5KSB7XG4gICAgdGhpcy5fY29va2llQXNzZXQgPSBudWxsO1xuICAgIHRoaXMuX2Nvb2tpZUFzc2V0SWQgPSBudWxsO1xuICAgIHRoaXMuX2Nvb2tpZUFzc2V0QWRkID0gZmFsc2U7XG4gICAgdGhpcy5fY29va2llTWF0cml4ID0gbnVsbDtcbiAgfTtcbiAgTGlnaHRDb21wb25lbnQgPSBwYy5pbmhlcml0cyhMaWdodENvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgdmFyIF9kZWZpbmVQcm9wcyA9IGZ1bmN0aW9uKGMsIGQsIHMpIHtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJlbmFibGVkXCIsIHRydWUsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5vblNldEVuYWJsZWQobnVsbCwgb2xkVmFsdWUsIG5ld1ZhbHVlKTtcbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJsaWdodFwiLCBudWxsKTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJ0eXBlXCIsIFwiZGlyZWN0aW9uYWxcIiwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICB0aGlzLnN5c3RlbS5jaGFuZ2VUeXBlKHRoaXMsIG9sZFZhbHVlLCBuZXdWYWx1ZSk7XG4gICAgICB0aGlzLnJlZnJlc2hQcm9wZXJ0aWVzKCk7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY29sb3JcIiwgbmV3IHBjLkNvbG9yKDEsIDEsIDEpLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuc2V0Q29sb3IobmV3VmFsdWUpO1xuICAgIH0sIHRydWUpO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImludGVuc2l0eVwiLCAxLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuaW50ZW5zaXR5ID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY2FzdFNoYWRvd3NcIiwgZmFsc2UsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5jYXN0U2hhZG93cyA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcInNoYWRvd0Rpc3RhbmNlXCIsIDQwLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuc2hhZG93RGlzdGFuY2UgPSBuZXdWYWx1ZTtcbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJzaGFkb3dSZXNvbHV0aW9uXCIsIDEwMjQsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5zaGFkb3dSZXNvbHV0aW9uID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwic2hhZG93Qmlhc1wiLCAwLjA1LCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuc2hhZG93QmlhcyA9IC0wLjAxICogbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwibm9ybWFsT2Zmc2V0Qmlhc1wiLCAwLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQubm9ybWFsT2Zmc2V0QmlhcyA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcInJhbmdlXCIsIDEwLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuYXR0ZW51YXRpb25FbmQgPSBuZXdWYWx1ZTtcbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJpbm5lckNvbmVBbmdsZVwiLCA0MCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICB0aGlzLmxpZ2h0LmlubmVyQ29uZUFuZ2xlID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwib3V0ZXJDb25lQW5nbGVcIiwgNDUsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5vdXRlckNvbmVBbmdsZSA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImZhbGxvZmZNb2RlXCIsIHBjLkxJR0hURkFMTE9GRl9MSU5FQVIsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5mYWxsb2ZmTW9kZSA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcInNoYWRvd1R5cGVcIiwgcGMuU0hBRE9XX1BDRjMsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5zaGFkb3dUeXBlID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwidnNtQmx1clNpemVcIiwgMTEsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC52c21CbHVyU2l6ZSA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcInZzbUJsdXJNb2RlXCIsIHBjLkJMVVJfR0FVU1NJQU4sIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC52c21CbHVyTW9kZSA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcInZzbUJpYXNcIiwgMC4wMSAqIDAuMjUsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC52c21CaWFzID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY29va2llQXNzZXRcIiwgbnVsbCwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICBpZiAodGhpcy5fY29va2llQXNzZXRJZCAmJiAobmV3VmFsdWUgaW5zdGFuY2VvZiBwYy5Bc3NldCAmJiBuZXdWYWx1ZS5pZCA9PT0gdGhpcy5fY29va2llQXNzZXRJZCB8fCBuZXdWYWx1ZSA9PT0gdGhpcy5fY29va2llQXNzZXRJZCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5vbkNvb2tpZUFzc2V0UmVtb3ZlKCk7XG4gICAgICB0aGlzLl9jb29raWVBc3NldElkID0gbnVsbDtcbiAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICAgIHRoaXMuZGF0YS5jb29raWVBc3NldCA9IG5ld1ZhbHVlLmlkO1xuICAgICAgICB0aGlzLl9jb29raWVBc3NldElkID0gbmV3VmFsdWUuaWQ7XG4gICAgICAgIHRoaXMub25Db29raWVBc3NldEFkZChuZXdWYWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodHlwZW9mIG5ld1ZhbHVlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgdGhpcy5fY29va2llQXNzZXRJZCA9IG5ld1ZhbHVlO1xuICAgICAgICAgIHZhciBhc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0KG5ld1ZhbHVlKTtcbiAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIHRoaXMub25Db29raWVBc3NldEFkZChhc3NldCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2Nvb2tpZUFzc2V0QWRkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuc3lzdGVtLmFwcC5hc3NldHMub24oXCJhZGQ6XCIgKyB0aGlzLl9jb29raWVBc3NldElkLCB0aGlzLm9uQ29va2llQXNzZXRBZGQsIHRoaXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImNvb2tpZVwiLCBudWxsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuY29va2llID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY29va2llSW50ZW5zaXR5XCIsIDEsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5jb29raWVJbnRlbnNpdHkgPSBuZXdWYWx1ZTtcbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJjb29raWVGYWxsb2ZmXCIsIHRydWUsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5jb29raWVGYWxsb2ZmID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY29va2llQ2hhbm5lbFwiLCBcInJnYlwiLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuY29va2llQ2hhbm5lbCA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImNvb2tpZUFuZ2xlXCIsIDAsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgaWYgKG5ld1ZhbHVlICE9PSAwIHx8IHRoaXMuY29va2llU2NhbGUgIT09IG51bGwpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9jb29raWVNYXRyaXgpIHtcbiAgICAgICAgICB0aGlzLl9jb29raWVNYXRyaXggPSBuZXcgcGMuVmVjNDtcbiAgICAgICAgfVxuICAgICAgICB2YXIgc2N4ID0gMTtcbiAgICAgICAgdmFyIHNjeSA9IDE7XG4gICAgICAgIGlmICh0aGlzLmNvb2tpZVNjYWxlKSB7XG4gICAgICAgICAgc2N4ID0gdGhpcy5jb29raWVTY2FsZS54O1xuICAgICAgICAgIHNjeSA9IHRoaXMuY29va2llU2NhbGUueTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgYyA9IE1hdGguY29zKG5ld1ZhbHVlICogcGMubWF0aC5ERUdfVE9fUkFEKTtcbiAgICAgICAgdmFyIHMgPSBNYXRoLnNpbihuZXdWYWx1ZSAqIHBjLm1hdGguREVHX1RPX1JBRCk7XG4gICAgICAgIHRoaXMuX2Nvb2tpZU1hdHJpeC5zZXQoYyAvIHNjeCwgLXMgLyBzY3gsIHMgLyBzY3ksIGMgLyBzY3kpO1xuICAgICAgICB0aGlzLmxpZ2h0LmNvb2tpZVRyYW5zZm9ybSA9IHRoaXMuX2Nvb2tpZU1hdHJpeDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubGlnaHQuY29va2llVHJhbnNmb3JtID0gbnVsbDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJjb29raWVTY2FsZVwiLCBudWxsLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIGlmIChuZXdWYWx1ZSAhPT0gbnVsbCB8fCB0aGlzLmNvb2tpZUFuZ2xlICE9PSAwKSB7XG4gICAgICAgIGlmICghdGhpcy5fY29va2llTWF0cml4KSB7XG4gICAgICAgICAgdGhpcy5fY29va2llTWF0cml4ID0gbmV3IHBjLlZlYzQ7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHNjeCA9IG5ld1ZhbHVlLng7XG4gICAgICAgIHZhciBzY3kgPSBuZXdWYWx1ZS55O1xuICAgICAgICB2YXIgYyA9IE1hdGguY29zKHRoaXMuY29va2llQW5nbGUgKiBwYy5tYXRoLkRFR19UT19SQUQpO1xuICAgICAgICB2YXIgcyA9IE1hdGguc2luKHRoaXMuY29va2llQW5nbGUgKiBwYy5tYXRoLkRFR19UT19SQUQpO1xuICAgICAgICB0aGlzLl9jb29raWVNYXRyaXguc2V0KGMgLyBzY3gsIC1zIC8gc2N4LCBzIC8gc2N5LCBjIC8gc2N5KTtcbiAgICAgICAgdGhpcy5saWdodC5jb29raWVUcmFuc2Zvcm0gPSB0aGlzLl9jb29raWVNYXRyaXg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxpZ2h0LmNvb2tpZVRyYW5zZm9ybSA9IG51bGw7XG4gICAgICB9XG4gICAgfSwgdHJ1ZSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiY29va2llT2Zmc2V0XCIsIG51bGwsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5jb29raWVPZmZzZXQgPSBuZXdWYWx1ZTtcbiAgICB9LCB0cnVlKTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJzaGFkb3dVcGRhdGVNb2RlXCIsIHBjLlNIQURPV1VQREFURV9SRUFMVElNRSwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICB0aGlzLmxpZ2h0LnNoYWRvd1VwZGF0ZU1vZGUgPSBuZXdWYWx1ZTtcbiAgICB9KTtcbiAgICBfZGVmaW5lUHJvcGVydHkoXCJtYXNrXCIsIDEsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xuICAgICAgdGhpcy5saWdodC5tYXNrID0gbmV3VmFsdWU7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiYWZmZWN0RHluYW1pY1wiLCB0cnVlLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIGlmIChuZXdWYWx1ZSkge1xuICAgICAgICB0aGlzLmxpZ2h0Lm1hc2sgfD0gcGMuTUFTS19EWU5BTUlDO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5saWdodC5tYXNrICY9IH5wYy5NQVNLX0RZTkFNSUM7XG4gICAgICB9XG4gICAgICB0aGlzLmxpZ2h0Lm1hc2sgPSB0aGlzLmxpZ2h0Ll9tYXNrO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImFmZmVjdExpZ2h0bWFwcGVkXCIsIGZhbHNlLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIGlmIChuZXdWYWx1ZSkge1xuICAgICAgICB0aGlzLmxpZ2h0Lm1hc2sgfD0gcGMuTUFTS19CQUtFRDtcbiAgICAgICAgaWYgKHRoaXMuYmFrZSkge1xuICAgICAgICAgIHRoaXMubGlnaHQubWFzayAmPSB+cGMuTUFTS19MSUdIVE1BUDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5saWdodC5tYXNrICY9IH5wYy5NQVNLX0JBS0VEO1xuICAgICAgICBpZiAodGhpcy5iYWtlKSB7XG4gICAgICAgICAgdGhpcy5saWdodC5tYXNrIHw9IHBjLk1BU0tfTElHSFRNQVA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMubGlnaHQubWFzayA9IHRoaXMubGlnaHQuX21hc2s7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiYmFrZVwiLCBmYWxzZSwgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7XG4gICAgICBpZiAobmV3VmFsdWUpIHtcbiAgICAgICAgdGhpcy5saWdodC5tYXNrIHw9IHBjLk1BU0tfTElHSFRNQVA7XG4gICAgICAgIGlmICh0aGlzLmFmZmVjdExpZ2h0bWFwcGVkKSB7XG4gICAgICAgICAgdGhpcy5saWdodC5tYXNrICY9IH5wYy5NQVNLX0JBS0VEO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxpZ2h0Lm1hc2sgJj0gfnBjLk1BU0tfTElHSFRNQVA7XG4gICAgICAgIGlmICh0aGlzLmFmZmVjdExpZ2h0bWFwcGVkKSB7XG4gICAgICAgICAgdGhpcy5saWdodC5tYXNrIHw9IHBjLk1BU0tfQkFLRUQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMubGlnaHQubWFzayA9IHRoaXMubGlnaHQuX21hc2s7XG4gICAgfSk7XG4gICAgX2RlZmluZVByb3BlcnR5KFwiYmFrZURpclwiLCB0cnVlLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuYmFrZURpciA9IG5ld1ZhbHVlO1xuICAgIH0pO1xuICAgIF9kZWZpbmVQcm9wZXJ0eShcImlzU3RhdGljXCIsIGZhbHNlLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMubGlnaHQuaXNTdGF0aWMgPSBuZXdWYWx1ZTtcbiAgICB9KTtcbiAgfTtcbiAgX2RlZmluZVByb3BzKCk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMaWdodENvbXBvbmVudC5wcm90b3R5cGUsIFwiZW5hYmxlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS53YXJuKFwiV0FSTklORzogZW5hYmxlOiBQcm9wZXJ0eSBpcyBkZXByZWNhdGVkLiBRdWVyeSBlbmFibGVkIHByb3BlcnR5IGluc3RlYWQuXCIpO1xuICAgIHJldHVybiB0aGlzLmVuYWJsZWQ7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IGVuYWJsZTogUHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gU2V0IGVuYWJsZWQgcHJvcGVydHkgaW5zdGVhZC5cIik7XG4gICAgdGhpcy5lbmFibGVkID0gdmFsdWU7XG4gIH19KTtcbiAgcGMuZXh0ZW5kKExpZ2h0Q29tcG9uZW50LnByb3RvdHlwZSwge3JlZnJlc2hQcm9wZXJ0aWVzOmZ1bmN0aW9uKCkge1xuICAgIHZhciBuYW1lO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBfcHJvcHMubGVuZ3RoO2krKykge1xuICAgICAgbmFtZSA9IF9wcm9wc1tpXTtcbiAgICAgIHRoaXNbbmFtZV0gPSB0aGlzW25hbWVdO1xuICAgIH1cbiAgICBpZiAodGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgIHRoaXMub25FbmFibGUoKTtcbiAgICB9XG4gIH0sIHVwZGF0ZVNoYWRvdzpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmxpZ2h0LnVwZGF0ZVNoYWRvdygpO1xuICB9LCBvbkNvb2tpZUFzc2V0U2V0OmZ1bmN0aW9uKCkge1xuICAgIHZhciBmb3JjZUxvYWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5fY29va2llQXNzZXQudHlwZSA9PT0gXCJjdWJlbWFwXCIgJiYgIXRoaXMuX2Nvb2tpZUFzc2V0LmxvYWRGYWNlcykge1xuICAgICAgdGhpcy5fY29va2llQXNzZXQubG9hZEZhY2VzID0gdHJ1ZTtcbiAgICAgIGZvcmNlTG9hZCA9IHRydWU7XG4gICAgfVxuICAgIGlmICghdGhpcy5fY29va2llQXNzZXQucmVzb3VyY2UgfHwgZm9yY2VMb2FkKSB7XG4gICAgICB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzLmxvYWQodGhpcy5fY29va2llQXNzZXQpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fY29va2llQXNzZXQucmVzb3VyY2UpIHtcbiAgICAgIHRoaXMub25Db29raWVBc3NldExvYWQoKTtcbiAgICB9XG4gIH0sIG9uQ29va2llQXNzZXRBZGQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBpZiAodGhpcy5fY29va2llQXNzZXRJZCAhPT0gYXNzZXQuaWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fY29va2llQXNzZXQgPSBhc3NldDtcbiAgICBpZiAodGhpcy5saWdodC5fZW5hYmxlZCkge1xuICAgICAgdGhpcy5vbkNvb2tpZUFzc2V0U2V0KCk7XG4gICAgfVxuICAgIHRoaXMuX2Nvb2tpZUFzc2V0Lm9uKFwibG9hZFwiLCB0aGlzLm9uQ29va2llQXNzZXRMb2FkLCB0aGlzKTtcbiAgICB0aGlzLl9jb29raWVBc3NldC5vbihcInJlbW92ZVwiLCB0aGlzLm9uQ29va2llQXNzZXRSZW1vdmUsIHRoaXMpO1xuICB9LCBvbkNvb2tpZUFzc2V0TG9hZDpmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuX2Nvb2tpZUFzc2V0IHx8ICF0aGlzLl9jb29raWVBc3NldC5yZXNvdXJjZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmNvb2tpZSA9IHRoaXMuX2Nvb2tpZUFzc2V0LnJlc291cmNlO1xuICB9LCBvbkNvb2tpZUFzc2V0UmVtb3ZlOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fY29va2llQXNzZXRJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5fY29va2llQXNzZXRBZGQpIHtcbiAgICAgIHRoaXMuc3lzdGVtLmFwcC5hc3NldHMub2ZmKFwiYWRkOlwiICsgdGhpcy5fY29va2llQXNzZXRJZCwgdGhpcy5vbkNvb2tpZUFzc2V0QWRkLCB0aGlzKTtcbiAgICAgIHRoaXMuX2Nvb2tpZUFzc2V0QWRkID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLl9jb29raWVBc3NldCkge1xuICAgICAgdGhpcy5fY29va2llQXNzZXQub2ZmKFwibG9hZFwiLCB0aGlzLm9uQ29va2llQXNzZXRMb2FkLCB0aGlzKTtcbiAgICAgIHRoaXMuX2Nvb2tpZUFzc2V0Lm9mZihcInJlbW92ZVwiLCB0aGlzLm9uQ29va2llQXNzZXRSZW1vdmUsIHRoaXMpO1xuICAgICAgdGhpcy5fY29va2llQXNzZXQgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLmNvb2tpZSA9IG51bGw7XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIExpZ2h0Q29tcG9uZW50Ll9zdXBlci5vbkVuYWJsZS5jYWxsKHRoaXMpO1xuICAgIHRoaXMubGlnaHQuZW5hYmxlZCA9IHRydWU7XG4gICAgaWYgKHRoaXMuX2Nvb2tpZUFzc2V0ICYmICF0aGlzLmNvb2tpZSkge1xuICAgICAgdGhpcy5vbkNvb2tpZUFzc2V0U2V0KCk7XG4gICAgfVxuICB9LCBvbkRpc2FibGU6ZnVuY3Rpb24oKSB7XG4gICAgTGlnaHRDb21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIHRoaXMubGlnaHQuZW5hYmxlZCA9IGZhbHNlO1xuICB9fSk7XG4gIHJldHVybiB7TGlnaHRDb21wb25lbnQ6TGlnaHRDb21wb25lbnQsIF9saWdodFByb3BzOl9wcm9wcywgX2xpZ2h0UHJvcHNEZWZhdWx0Ol9wcm9wc0RlZmF1bHR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBsaWdodFR5cGVzID0ge1wiZGlyZWN0aW9uYWxcIjpwYy5MSUdIVFRZUEVfRElSRUNUSU9OQUwsIFwicG9pbnRcIjpwYy5MSUdIVFRZUEVfUE9JTlQsIFwic3BvdFwiOnBjLkxJR0hUVFlQRV9TUE9UfTtcbiAgdmFyIExpZ2h0Q29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24oYXBwKSB7XG4gICAgdGhpcy5pZCA9IFwibGlnaHRcIjtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gXCJFbmFibGVzIHRoZSBFbnRpdHkgdG8gZW1pdCBsaWdodC5cIjtcbiAgICBhcHAuc3lzdGVtcy5hZGQodGhpcy5pZCwgdGhpcyk7XG4gICAgdGhpcy5Db21wb25lbnRUeXBlID0gcGMuTGlnaHRDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLkxpZ2h0Q29tcG9uZW50RGF0YTtcbiAgICB0aGlzLm9uKFwicmVtb3ZlXCIsIHRoaXMub25SZW1vdmUsIHRoaXMpO1xuICB9O1xuICBMaWdodENvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKExpZ2h0Q29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5leHRlbmQoTGlnaHRDb21wb25lbnRTeXN0ZW0ucHJvdG90eXBlLCB7aW5pdGlhbGl6ZUNvbXBvbmVudERhdGE6ZnVuY3Rpb24oY29tcG9uZW50LCBfZGF0YSkge1xuICAgIHZhciBkYXRhID0ge307XG4gICAgdmFyIF9wcm9wcyA9IHBjLl9saWdodFByb3BzO1xuICAgIHZhciBuYW1lO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBfcHJvcHMubGVuZ3RoO2krKykge1xuICAgICAgbmFtZSA9IF9wcm9wc1tpXTtcbiAgICAgIGRhdGFbbmFtZV0gPSBfZGF0YVtuYW1lXTtcbiAgICB9XG4gICAgaWYgKCFkYXRhLnR5cGUpIHtcbiAgICAgIGRhdGEudHlwZSA9IGNvbXBvbmVudC5kYXRhLnR5cGU7XG4gICAgfVxuICAgIGNvbXBvbmVudC5kYXRhLnR5cGUgPSBkYXRhLnR5cGU7XG4gICAgaWYgKGRhdGEuY29sb3IgJiYgcGMudHlwZShkYXRhLmNvbG9yKSA9PT0gXCJhcnJheVwiKSB7XG4gICAgICBkYXRhLmNvbG9yID0gbmV3IHBjLkNvbG9yKGRhdGEuY29sb3JbMF0sIGRhdGEuY29sb3JbMV0sIGRhdGEuY29sb3JbMl0pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5jb29raWVPZmZzZXQgJiYgZGF0YS5jb29raWVPZmZzZXQgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgZGF0YS5jb29raWVPZmZzZXQgPSBuZXcgcGMuVmVjMihkYXRhLmNvb2tpZU9mZnNldFswXSwgZGF0YS5jb29raWVPZmZzZXRbMV0pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5jb29raWVTY2FsZSAmJiBkYXRhLmNvb2tpZVNjYWxlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgIGRhdGEuY29va2llU2NhbGUgPSBuZXcgcGMuVmVjMihkYXRhLmNvb2tpZVNjYWxlWzBdLCBkYXRhLmNvb2tpZVNjYWxlWzFdKTtcbiAgICB9XG4gICAgaWYgKGRhdGEuZW5hYmxlKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJXQVJOSU5HOiBlbmFibGU6IFByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuIFNldCBlbmFibGVkIHByb3BlcnR5IGluc3RlYWQuXCIpO1xuICAgICAgZGF0YS5lbmFibGVkID0gZGF0YS5lbmFibGU7XG4gICAgfVxuICAgIHZhciBsaWdodCA9IG5ldyBwYy5MaWdodDtcbiAgICBsaWdodC50eXBlID0gbGlnaHRUeXBlc1tkYXRhLnR5cGVdO1xuICAgIGxpZ2h0Ll9ub2RlID0gY29tcG9uZW50LmVudGl0eTtcbiAgICB0aGlzLmFwcC5zY2VuZS5hZGRMaWdodChsaWdodCk7XG4gICAgY29tcG9uZW50LmRhdGEubGlnaHQgPSBsaWdodDtcbiAgICBMaWdodENvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIF9wcm9wcyk7XG4gIH0sIG9uUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgZGF0YSkge1xuICAgIHRoaXMuYXBwLnNjZW5lLnJlbW92ZUxpZ2h0KGRhdGEubGlnaHQpO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIGxpZ2h0ID0gZW50aXR5LmxpZ2h0O1xuICAgIHZhciBkYXRhID0gW107XG4gICAgdmFyIG5hbWU7XG4gICAgdmFyIF9wcm9wcyA9IHBjLl9saWdodFByb3BzO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBfcHJvcHMubGVuZ3RoO2krKykge1xuICAgICAgbmFtZSA9IF9wcm9wc1tpXTtcbiAgICAgIGlmIChuYW1lID09PSBcImxpZ2h0XCIpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAobGlnaHRbbmFtZV0gJiYgbGlnaHRbbmFtZV0uY2xvbmUpIHtcbiAgICAgICAgZGF0YVtuYW1lXSA9IGxpZ2h0W25hbWVdLmNsb25lKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhW25hbWVdID0gbGlnaHRbbmFtZV07XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuYWRkQ29tcG9uZW50KGNsb25lLCBkYXRhKTtcbiAgfSwgY2hhbmdlVHlwZTpmdW5jdGlvbihjb21wb25lbnQsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHtcbiAgICAgIGNvbXBvbmVudC5saWdodC50eXBlID0gbGlnaHRUeXBlc1tuZXdWYWx1ZV07XG4gICAgfVxuICB9fSk7XG4gIHJldHVybiB7TGlnaHRDb21wb25lbnRTeXN0ZW06TGlnaHRDb21wb25lbnRTeXN0ZW19O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBMaWdodENvbXBvbmVudERhdGEgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgX3Byb3BzID0gcGMuX2xpZ2h0UHJvcHM7XG4gICAgdmFyIF9wcm9wc0RlZmF1bHQgPSBwYy5fbGlnaHRQcm9wc0RlZmF1bHQ7XG4gICAgdmFyIHZhbHVlO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBfcHJvcHMubGVuZ3RoO2krKykge1xuICAgICAgdmFsdWUgPSBfcHJvcHNEZWZhdWx0W2ldO1xuICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNsb25lKSB7XG4gICAgICAgIHRoaXNbX3Byb3BzW2ldXSA9IHZhbHVlLmNsb25lKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzW19wcm9wc1tpXV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIExpZ2h0Q29tcG9uZW50RGF0YSA9IHBjLmluaGVyaXRzKExpZ2h0Q29tcG9uZW50RGF0YSwgcGMuQ29tcG9uZW50RGF0YSk7XG4gIHJldHVybiB7TGlnaHRDb21wb25lbnREYXRhOkxpZ2h0Q29tcG9uZW50RGF0YX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjcmlwdENvbXBvbmVudCA9IGZ1bmN0aW9uIFNjcmlwdENvbXBvbmVudChzeXN0ZW0sIGVudGl0eSkge1xuICAgIHRoaXMuX3NjcmlwdHMgPSBbXTtcbiAgICB0aGlzLl9zY3JpcHRzSW5kZXggPSB7fTtcbiAgICB0aGlzLl9zY3JpcHRzRGF0YSA9IG51bGw7XG4gICAgdGhpcy5fb2xkU3RhdGUgPSB0cnVlO1xuICAgIHRoaXMub24oXCJzZXRfZW5hYmxlZFwiLCB0aGlzLl9vblNldEVuYWJsZWQsIHRoaXMpO1xuICB9O1xuICBTY3JpcHRDb21wb25lbnQgPSBwYy5pbmhlcml0cyhTY3JpcHRDb21wb25lbnQsIHBjLkNvbXBvbmVudCk7XG4gIFNjcmlwdENvbXBvbmVudC5zY3JpcHRNZXRob2RzID0ge2luaXRpYWxpemU6XCJpbml0aWFsaXplXCIsIHBvc3RJbml0aWFsaXplOlwicG9zdEluaXRpYWxpemVcIiwgdXBkYXRlOlwidXBkYXRlXCIsIHBvc3RVcGRhdGU6XCJwb3N0VXBkYXRlXCIsIHN3YXA6XCJzd2FwXCJ9O1xuICBwYy5leHRlbmQoU2NyaXB0Q29tcG9uZW50LnByb3RvdHlwZSwge29uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIFNjcmlwdENvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICB0aGlzLl9jaGVja1N0YXRlKCk7XG4gIH0sIG9uRGlzYWJsZTpmdW5jdGlvbigpIHtcbiAgICBTY3JpcHRDb21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIHRoaXMuX2NoZWNrU3RhdGUoKTtcbiAgfSwgb25Qb3N0U3RhdGVDaGFuZ2U6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHNjcmlwdDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5zY3JpcHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIHNjcmlwdCA9IHRoaXMuc2NyaXB0c1tpXTtcbiAgICAgIGlmIChzY3JpcHQuX2luaXRpYWxpemVkICYmICFzY3JpcHQuX3Bvc3RJbml0aWFsaXplZCkge1xuICAgICAgICBzY3JpcHQuX3Bvc3RJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIGlmIChzY3JpcHQucG9zdEluaXRpYWxpemUpIHtcbiAgICAgICAgICB0aGlzLl9zY3JpcHRNZXRob2Qoc2NyaXB0LCBTY3JpcHRDb21wb25lbnQuc2NyaXB0TWV0aG9kcy5wb3N0SW5pdGlhbGl6ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vblNldEVuYWJsZWQ6ZnVuY3Rpb24ocHJvcCwgb2xkLCB2YWx1ZSkge1xuICAgIHRoaXMuX2NoZWNrU3RhdGUoKTtcbiAgfSwgX2NoZWNrU3RhdGU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHN0YXRlID0gdGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQ7XG4gICAgaWYgKHN0YXRlID09PSB0aGlzLl9vbGRTdGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9vbGRTdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMuZmlyZSh0aGlzLmVuYWJsZWQgPyBcImVuYWJsZVwiIDogXCJkaXNhYmxlXCIpO1xuICAgIHRoaXMuZmlyZShcInN0YXRlXCIsIHRoaXMuZW5hYmxlZCk7XG4gICAgdmFyIHNjcmlwdDtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5zY3JpcHRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgc2NyaXB0ID0gdGhpcy5zY3JpcHRzW2ldO1xuICAgICAgc2NyaXB0LmVuYWJsZWQgPSBzY3JpcHQuX2VuYWJsZWQ7XG4gICAgICBpZiAoIXNjcmlwdC5faW5pdGlhbGl6ZWQgJiYgc2NyaXB0LmVuYWJsZWQpIHtcbiAgICAgICAgc2NyaXB0Ll9pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIHNjcmlwdC5fX2luaXRpYWxpemVBdHRyaWJ1dGVzKHRydWUpO1xuICAgICAgICBpZiAoc2NyaXB0LmluaXRpYWxpemUpIHtcbiAgICAgICAgICB0aGlzLl9zY3JpcHRNZXRob2Qoc2NyaXB0LCBTY3JpcHRDb21wb25lbnQuc2NyaXB0TWV0aG9kcy5pbml0aWFsaXplKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgX29uQmVmb3JlUmVtb3ZlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZmlyZShcInJlbW92ZVwiKTtcbiAgICB2YXIgZGVzdHJveWVkID0gdHJ1ZTtcbiAgICB3aGlsZSAodGhpcy5zY3JpcHRzLmxlbmd0aCA+IDAgJiYgZGVzdHJveWVkKSB7XG4gICAgICBkZXN0cm95ZWQgPSB0aGlzLmRlc3Ryb3kodGhpcy5zY3JpcHRzWzBdLl9fc2NyaXB0VHlwZS5fX25hbWUpO1xuICAgIH1cbiAgfSwgX29uSW5pdGlhbGl6ZUF0dHJpYnV0ZXM6ZnVuY3Rpb24oKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuc2NyaXB0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHRoaXMuc2NyaXB0c1tpXS5fX2luaXRpYWxpemVBdHRyaWJ1dGVzKCk7XG4gICAgfVxuICB9LCBfc2NyaXB0TWV0aG9kOmZ1bmN0aW9uKHNjcmlwdCwgbWV0aG9kLCBhcmcpIHtcbiAgICB0cnkge1xuICAgICAgc2NyaXB0W21ldGhvZF0oYXJnKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgc2NyaXB0LmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgIGlmICghc2NyaXB0Ll9jYWxsYmFja3MgfHwgIXNjcmlwdC5fY2FsbGJhY2tzLmVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybigndW5oYW5kbGVkIGV4Y2VwdGlvbiB3aGlsZSBjYWxsaW5nIFwiJyArIG1ldGhvZCArICdcIiBmb3IgXCInICsgc2NyaXB0Ll9fc2NyaXB0VHlwZS5fX25hbWUgKyAnXCIgc2NyaXB0OiAnLCBleCk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXgpO1xuICAgICAgfVxuICAgICAgc2NyaXB0LmZpcmUoXCJlcnJvclwiLCBleCwgbWV0aG9kKTtcbiAgICAgIHRoaXMuZmlyZShcImVycm9yXCIsIHNjcmlwdCwgZXgsIG1ldGhvZCk7XG4gICAgfVxuICB9LCBfb25Jbml0aWFsaXplOmZ1bmN0aW9uKCkge1xuICAgIHZhciBzY3JpcHQsIHNjcmlwdHMgPSB0aGlzLl9zY3JpcHRzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzY3JpcHRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgc2NyaXB0ID0gc2NyaXB0c1tpXTtcbiAgICAgIGlmICghc2NyaXB0Ll9pbml0aWFsaXplZCAmJiBzY3JpcHQuZW5hYmxlZCkge1xuICAgICAgICBzY3JpcHQuX2luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKHNjcmlwdC5pbml0aWFsaXplKSB7XG4gICAgICAgICAgdGhpcy5fc2NyaXB0TWV0aG9kKHNjcmlwdCwgU2NyaXB0Q29tcG9uZW50LnNjcmlwdE1ldGhvZHMuaW5pdGlhbGl6ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vblBvc3RJbml0aWFsaXplOmZ1bmN0aW9uKCkge1xuICAgIHZhciBzY3JpcHQsIHNjcmlwdHMgPSB0aGlzLl9zY3JpcHRzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzY3JpcHRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgc2NyaXB0ID0gc2NyaXB0c1tpXTtcbiAgICAgIGlmICghc2NyaXB0Ll9wb3N0SW5pdGlhbGl6ZWQgJiYgc2NyaXB0LmVuYWJsZWQpIHtcbiAgICAgICAgc2NyaXB0Ll9wb3N0SW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICBpZiAoc2NyaXB0LnBvc3RJbml0aWFsaXplKSB7XG4gICAgICAgICAgdGhpcy5fc2NyaXB0TWV0aG9kKHNjcmlwdCwgU2NyaXB0Q29tcG9uZW50LnNjcmlwdE1ldGhvZHMucG9zdEluaXRpYWxpemUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfb25VcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB2YXIgc2NyaXB0LCBzY3JpcHRzID0gdGhpcy5fc2NyaXB0cztcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc2NyaXB0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHNjcmlwdCA9IHNjcmlwdHNbaV07XG4gICAgICBpZiAoc2NyaXB0LnVwZGF0ZSAmJiBzY3JpcHQuZW5hYmxlZCkge1xuICAgICAgICB0aGlzLl9zY3JpcHRNZXRob2Qoc2NyaXB0LCBTY3JpcHRDb21wb25lbnQuc2NyaXB0TWV0aG9kcy51cGRhdGUsIGR0KTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vblBvc3RVcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB2YXIgc2NyaXB0LCBzY3JpcHRzID0gdGhpcy5fc2NyaXB0cztcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc2NyaXB0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHNjcmlwdCA9IHNjcmlwdHNbaV07XG4gICAgICBpZiAoc2NyaXB0LnBvc3RVcGRhdGUgJiYgc2NyaXB0LmVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5fc2NyaXB0TWV0aG9kKHNjcmlwdCwgU2NyaXB0Q29tcG9uZW50LnNjcmlwdE1ldGhvZHMucG9zdFVwZGF0ZSwgZHQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgaGFzOmZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgc2NyaXB0VHlwZSA9IG5hbWU7XG4gICAgaWYgKHR5cGVvZiBzY3JpcHRUeXBlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBzY3JpcHRUeXBlID0gdGhpcy5zeXN0ZW0uYXBwLnNjcmlwdHMuZ2V0KHNjcmlwdFR5cGUpO1xuICAgIH1cbiAgICByZXR1cm4gISF0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0VHlwZS5fX25hbWVdO1xuICB9LCBjcmVhdGU6ZnVuY3Rpb24obmFtZSwgYXJncykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBhcmdzID0gYXJncyB8fCB7fTtcbiAgICB2YXIgc2NyaXB0VHlwZSA9IG5hbWU7XG4gICAgdmFyIHNjcmlwdE5hbWUgPSBuYW1lO1xuICAgIGlmICh0eXBlb2Ygc2NyaXB0VHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgc2NyaXB0VHlwZSA9IHRoaXMuc3lzdGVtLmFwcC5zY3JpcHRzLmdldChzY3JpcHRUeXBlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNjcmlwdFR5cGUpIHtcbiAgICAgICAgc2NyaXB0TmFtZSA9IHNjcmlwdFR5cGUuX19uYW1lO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc2NyaXB0VHlwZSkge1xuICAgICAgaWYgKCF0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0VHlwZS5fX25hbWVdIHx8ICF0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0VHlwZS5fX25hbWVdLmluc3RhbmNlKSB7XG4gICAgICAgIHZhciBzY3JpcHRJbnN0YW5jZSA9IG5ldyBzY3JpcHRUeXBlKHthcHA6dGhpcy5zeXN0ZW0uYXBwLCBlbnRpdHk6dGhpcy5lbnRpdHksIGVuYWJsZWQ6YXJncy5oYXNPd25Qcm9wZXJ0eShcImVuYWJsZWRcIikgPyBhcmdzLmVuYWJsZWQgOiB0cnVlLCBhdHRyaWJ1dGVzOmFyZ3MuYXR0cmlidXRlcyB8fCBudWxsfSk7XG4gICAgICAgIHZhciBpbmQgPSAtMTtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmdzLmluZCA9PT0gXCJudW1iZXJcIiAmJiBhcmdzLmluZCAhPT0gLTEgJiYgdGhpcy5fc2NyaXB0cy5sZW5ndGggPiBhcmdzLmluZCkge1xuICAgICAgICAgIGluZCA9IGFyZ3MuaW5kO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpbmQgPT09IC0xKSB7XG4gICAgICAgICAgdGhpcy5fc2NyaXB0cy5wdXNoKHNjcmlwdEluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9zY3JpcHRzLnNwbGljZShpbmQsIDAsIHNjcmlwdEluc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0VHlwZS5fX25hbWVdID0ge2luc3RhbmNlOnNjcmlwdEluc3RhbmNlLCBvblN3YXA6ZnVuY3Rpb24oKSB7XG4gICAgICAgICAgc2VsZi5zd2FwKHNjcmlwdFR5cGUuX19uYW1lKTtcbiAgICAgICAgfX07XG4gICAgICAgIHRoaXNbc2NyaXB0VHlwZS5fX25hbWVdID0gc2NyaXB0SW5zdGFuY2U7XG4gICAgICAgIGlmICghYXJncy5wcmVsb2FkaW5nKSB7XG4gICAgICAgICAgc2NyaXB0SW5zdGFuY2UuX19pbml0aWFsaXplQXR0cmlidXRlcygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmlyZShcImNyZWF0ZVwiLCBzY3JpcHRUeXBlLl9fbmFtZSwgc2NyaXB0SW5zdGFuY2UpO1xuICAgICAgICB0aGlzLmZpcmUoXCJjcmVhdGU6XCIgKyBzY3JpcHRUeXBlLl9fbmFtZSwgc2NyaXB0SW5zdGFuY2UpO1xuICAgICAgICB0aGlzLnN5c3RlbS5hcHAuc2NyaXB0cy5vbihcInN3YXA6XCIgKyBzY3JpcHRUeXBlLl9fbmFtZSwgdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdFR5cGUuX19uYW1lXS5vblN3YXApO1xuICAgICAgICBpZiAoIWFyZ3MucHJlbG9hZGluZyAmJiB0aGlzLmVuYWJsZWQgJiYgc2NyaXB0SW5zdGFuY2UuZW5hYmxlZCAmJiAhc2NyaXB0SW5zdGFuY2UuX2luaXRpYWxpemVkKSB7XG4gICAgICAgICAgc2NyaXB0SW5zdGFuY2UuX2luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICBzY3JpcHRJbnN0YW5jZS5fcG9zdEluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICBpZiAoc2NyaXB0SW5zdGFuY2UuaW5pdGlhbGl6ZSkge1xuICAgICAgICAgICAgdGhpcy5fc2NyaXB0TWV0aG9kKHNjcmlwdEluc3RhbmNlLCBTY3JpcHRDb21wb25lbnQuc2NyaXB0TWV0aG9kcy5pbml0aWFsaXplKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHNjcmlwdEluc3RhbmNlLnBvc3RJbml0aWFsaXplKSB7XG4gICAgICAgICAgICB0aGlzLl9zY3JpcHRNZXRob2Qoc2NyaXB0SW5zdGFuY2UsIFNjcmlwdENvbXBvbmVudC5zY3JpcHRNZXRob2RzLnBvc3RJbml0aWFsaXplKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNjcmlwdEluc3RhbmNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwic2NyaXB0ICdcIiArIHNjcmlwdE5hbWUgKyBcIicgaXMgYWxyZWFkeSBhZGRlZCB0byBlbnRpdHkgJ1wiICsgdGhpcy5lbnRpdHkubmFtZSArIFwiJ1wiKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdE5hbWVdID0ge2F3YWl0aW5nOnRydWUsIGluZDp0aGlzLl9zY3JpcHRzLmxlbmd0aH07XG4gICAgICBjb25zb2xlLndhcm4oXCJzY3JpcHQgJ1wiICsgc2NyaXB0TmFtZSArIFwiJyBpcyBub3QgZm91bmQsIGF3YWl0aW5nIGl0IHRvIGJlIGFkZGVkIHRvIHJlZ2lzdHJ5XCIpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfSwgZGVzdHJveTpmdW5jdGlvbihuYW1lKSB7XG4gICAgdmFyIHNjcmlwdE5hbWUgPSBuYW1lO1xuICAgIHZhciBzY3JpcHRUeXBlID0gbmFtZTtcbiAgICBpZiAodHlwZW9mIHNjcmlwdFR5cGUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHNjcmlwdFR5cGUgPSB0aGlzLnN5c3RlbS5hcHAuc2NyaXB0cy5nZXQoc2NyaXB0VHlwZSk7XG4gICAgICBpZiAoc2NyaXB0VHlwZSkge1xuICAgICAgICBzY3JpcHROYW1lID0gc2NyaXB0VHlwZS5fX25hbWU7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBzY3JpcHREYXRhID0gdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdE5hbWVdO1xuICAgIGRlbGV0ZSB0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0TmFtZV07XG4gICAgaWYgKCFzY3JpcHREYXRhKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChzY3JpcHREYXRhLmluc3RhbmNlKSB7XG4gICAgICB2YXIgaW5kID0gdGhpcy5fc2NyaXB0cy5pbmRleE9mKHNjcmlwdERhdGEuaW5zdGFuY2UpO1xuICAgICAgdGhpcy5fc2NyaXB0cy5zcGxpY2UoaW5kLCAxKTtcbiAgICB9XG4gICAgdGhpcy5zeXN0ZW0uYXBwLnNjcmlwdHMub2ZmKFwic3dhcDpcIiArIHNjcmlwdE5hbWUsIHNjcmlwdERhdGEub25Td2FwKTtcbiAgICBkZWxldGUgdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdE5hbWVdO1xuICAgIGRlbGV0ZSB0aGlzW3NjcmlwdE5hbWVdO1xuICAgIHRoaXMuZmlyZShcImRlc3Ryb3lcIiwgc2NyaXB0TmFtZSwgc2NyaXB0RGF0YS5pbnN0YW5jZSB8fCBudWxsKTtcbiAgICB0aGlzLmZpcmUoXCJkZXN0cm95OlwiICsgc2NyaXB0TmFtZSwgc2NyaXB0RGF0YS5pbnN0YW5jZSB8fCBudWxsKTtcbiAgICBpZiAoc2NyaXB0RGF0YS5pbnN0YW5jZSkge1xuICAgICAgc2NyaXB0RGF0YS5pbnN0YW5jZS5maXJlKFwiZGVzdHJveVwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIHN3YXA6ZnVuY3Rpb24oc2NyaXB0KSB7XG4gICAgdmFyIHNjcmlwdFR5cGUgPSBzY3JpcHQ7XG4gICAgaWYgKHR5cGVvZiBzY3JpcHRUeXBlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBzY3JpcHRUeXBlID0gdGhpcy5zeXN0ZW0uYXBwLnNjcmlwdHMuZ2V0KHNjcmlwdFR5cGUpO1xuICAgIH1cbiAgICB2YXIgb2xkID0gdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdFR5cGUuX19uYW1lXTtcbiAgICBpZiAoIW9sZCB8fCAhb2xkLmluc3RhbmNlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBzY3JpcHRJbnN0YW5jZU9sZCA9IG9sZC5pbnN0YW5jZTtcbiAgICB2YXIgaW5kID0gdGhpcy5fc2NyaXB0cy5pbmRleE9mKHNjcmlwdEluc3RhbmNlT2xkKTtcbiAgICB2YXIgc2NyaXB0SW5zdGFuY2UgPSBuZXcgc2NyaXB0VHlwZSh7YXBwOnRoaXMuc3lzdGVtLmFwcCwgZW50aXR5OnRoaXMuZW50aXR5LCBlbmFibGVkOnNjcmlwdEluc3RhbmNlT2xkLmVuYWJsZWQsIGF0dHJpYnV0ZXM6c2NyaXB0SW5zdGFuY2VPbGQuX19hdHRyaWJ1dGVzfSk7XG4gICAgaWYgKCFzY3JpcHRJbnN0YW5jZS5zd2FwKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHNjcmlwdEluc3RhbmNlLl9faW5pdGlhbGl6ZUF0dHJpYnV0ZXMoKTtcbiAgICB0aGlzLl9zY3JpcHRzW2luZF0gPSBzY3JpcHRJbnN0YW5jZTtcbiAgICB0aGlzLl9zY3JpcHRzSW5kZXhbc2NyaXB0VHlwZS5fX25hbWVdLmluc3RhbmNlID0gc2NyaXB0SW5zdGFuY2U7XG4gICAgdGhpc1tzY3JpcHRUeXBlLl9fbmFtZV0gPSBzY3JpcHRJbnN0YW5jZTtcbiAgICB0aGlzLl9zY3JpcHRNZXRob2Qoc2NyaXB0SW5zdGFuY2UsIFNjcmlwdENvbXBvbmVudC5zY3JpcHRNZXRob2RzLnN3YXAsIHNjcmlwdEluc3RhbmNlT2xkKTtcbiAgICB0aGlzLmZpcmUoXCJzd2FwXCIsIHNjcmlwdFR5cGUuX19uYW1lLCBzY3JpcHRJbnN0YW5jZSk7XG4gICAgdGhpcy5maXJlKFwic3dhcDpcIiArIHNjcmlwdFR5cGUuX19uYW1lLCBzY3JpcHRJbnN0YW5jZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIG1vdmU6ZnVuY3Rpb24obmFtZSwgaW5kKSB7XG4gICAgaWYgKGluZCA+PSB0aGlzLl9zY3JpcHRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIgc2NyaXB0TmFtZSA9IG5hbWU7XG4gICAgaWYgKHR5cGVvZiBzY3JpcHROYW1lICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICBzY3JpcHROYW1lID0gbmFtZS5fX25hbWU7XG4gICAgfVxuICAgIHZhciBzY3JpcHREYXRhID0gdGhpcy5fc2NyaXB0c0luZGV4W3NjcmlwdE5hbWVdO1xuICAgIGlmICghc2NyaXB0RGF0YSB8fCAhc2NyaXB0RGF0YS5pbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIgaW5kT2xkID0gdGhpcy5fc2NyaXB0cy5pbmRleE9mKHNjcmlwdERhdGEuaW5zdGFuY2UpO1xuICAgIGlmIChpbmRPbGQgPT09IC0xIHx8IGluZE9sZCA9PT0gaW5kKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuX3NjcmlwdHMuc3BsaWNlKGluZCwgMCwgdGhpcy5fc2NyaXB0cy5zcGxpY2UoaW5kT2xkLCAxKVswXSk7XG4gICAgdGhpcy5maXJlKFwibW92ZVwiLCBzY3JpcHROYW1lLCBzY3JpcHREYXRhLmluc3RhbmNlLCBpbmQsIGluZE9sZCk7XG4gICAgdGhpcy5maXJlKFwibW92ZTpcIiArIHNjcmlwdE5hbWUsIHNjcmlwdERhdGEuaW5zdGFuY2UsIGluZCwgaW5kT2xkKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NyaXB0Q29tcG9uZW50LnByb3RvdHlwZSwgXCJzY3JpcHRzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NjcmlwdHM7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3NjcmlwdHNEYXRhID0gdmFsdWU7XG4gICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7XG4gICAgICBpZiAoIXZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB2YXIgc2NyaXB0ID0gdGhpcy5fc2NyaXB0c0luZGV4W2tleV07XG4gICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWVba2V5XS5lbmFibGVkID09PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgIHNjcmlwdC5lbmFibGVkID0gISF2YWx1ZVtrZXldLmVuYWJsZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZVtrZXldLmF0dHJpYnV0ZXMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIHZhbHVlW2tleV0uYXR0cmlidXRlcykge1xuICAgICAgICAgICAgaWYgKHBjLmNyZWF0ZVNjcmlwdC5yZXNlcnZlZEF0dHJpYnV0ZXNbYXR0cl0pIHtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXNjcmlwdC5fX2F0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cikpIHtcbiAgICAgICAgICAgICAgdmFyIHNjcmlwdFR5cGUgPSB0aGlzLnN5c3RlbS5hcHAuc2NyaXB0cy5nZXQoa2V5KTtcbiAgICAgICAgICAgICAgaWYgKHNjcmlwdFR5cGUpIHtcbiAgICAgICAgICAgICAgICBzY3JpcHRUeXBlLmF0dHJpYnV0ZXMuYWRkKGF0dHIsIHt9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2NyaXB0W2F0dHJdID0gdmFsdWVba2V5XS5hdHRyaWJ1dGVzW2F0dHJdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5vcmRlcik7XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIHJldHVybiB7U2NyaXB0Q29tcG9uZW50OlNjcmlwdENvbXBvbmVudH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIF9zY2hlbWEgPSBbXCJlbmFibGVkXCJdO1xuICB2YXIgU2NyaXB0Q29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24gU2NyaXB0Q29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcInNjcmlwdFwiO1xuICAgIHRoaXMuYXBwID0gYXBwO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5TY3JpcHRDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLlNjcmlwdENvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMuX2NvbXBvbmVudHMgPSBbXTtcbiAgICB0aGlzLm9uKFwiYmVmb3JlcmVtb3ZlXCIsIHRoaXMuX29uQmVmb3JlUmVtb3ZlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJpbml0aWFsaXplXCIsIHRoaXMuX29uSW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKFwicG9zdEluaXRpYWxpemVcIiwgdGhpcy5fb25Qb3N0SW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKFwidXBkYXRlXCIsIHRoaXMuX29uVXBkYXRlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJwb3N0VXBkYXRlXCIsIHRoaXMuX29uUG9zdFVwZGF0ZSwgdGhpcyk7XG4gIH07XG4gIFNjcmlwdENvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKFNjcmlwdENvbXBvbmVudFN5c3RlbSwgcGMuQ29tcG9uZW50U3lzdGVtKTtcbiAgcGMuQ29tcG9uZW50Ll9idWlsZEFjY2Vzc29ycyhwYy5TY3JpcHRDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKFNjcmlwdENvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpIHtcbiAgICB0aGlzLl9jb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcbiAgICBjb21wb25lbnQuZW5hYmxlZCA9IGRhdGEuaGFzT3duUHJvcGVydHkoXCJlbmFibGVkXCIpID8gISFkYXRhLmVuYWJsZWQgOiB0cnVlO1xuICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KFwib3JkZXJcIikgJiYgZGF0YS5oYXNPd25Qcm9wZXJ0eShcInNjcmlwdHNcIikpIHtcbiAgICAgIGNvbXBvbmVudC5fc2NyaXB0c0RhdGEgPSBkYXRhLnNjcmlwdHM7XG4gICAgICBmb3IgKHZhciBpID0gMDtpIDwgZGF0YS5vcmRlci5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGNvbXBvbmVudC5jcmVhdGUoZGF0YS5vcmRlcltpXSwge2VuYWJsZWQ6ZGF0YS5zY3JpcHRzW2RhdGEub3JkZXJbaV1dLmVuYWJsZWQsIGF0dHJpYnV0ZXM6ZGF0YS5zY3JpcHRzW2RhdGEub3JkZXJbaV1dLmF0dHJpYnV0ZXMsIHByZWxvYWRpbmc6dHJ1ZX0pO1xuICAgICAgfVxuICAgIH1cbiAgfSwgY2xvbmVDb21wb25lbnQ6ZnVuY3Rpb24oZW50aXR5LCBjbG9uZSkge1xuICAgIHZhciBpLCBrZXk7XG4gICAgdmFyIG9yZGVyID0gW107XG4gICAgdmFyIHNjcmlwdHMgPSB7fTtcbiAgICBmb3IgKGkgPSAwO2kgPCBlbnRpdHkuc2NyaXB0Ll9zY3JpcHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBzY3JpcHRJbnN0YW5jZSA9IGVudGl0eS5zY3JpcHQuX3NjcmlwdHNbaV07XG4gICAgICB2YXIgc2NyaXB0TmFtZSA9IHNjcmlwdEluc3RhbmNlLl9fc2NyaXB0VHlwZS5fX25hbWU7XG4gICAgICBvcmRlci5wdXNoKHNjcmlwdE5hbWUpO1xuICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB7fTtcbiAgICAgIGZvciAoa2V5IGluIHNjcmlwdEluc3RhbmNlLl9fYXR0cmlidXRlcykge1xuICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSBzY3JpcHRJbnN0YW5jZS5fX2F0dHJpYnV0ZXNba2V5XTtcbiAgICAgIH1cbiAgICAgIHNjcmlwdHNbc2NyaXB0TmFtZV0gPSB7ZW5hYmxlZDpzY3JpcHRJbnN0YW5jZS5fZW5hYmxlZCwgYXR0cmlidXRlczphdHRyaWJ1dGVzfTtcbiAgICB9XG4gICAgZm9yIChrZXkgaW4gZW50aXR5LnNjcmlwdC5fc2NyaXB0c0luZGV4KSB7XG4gICAgICB2YXIgc2NyaXB0RGF0YSA9IGVudGl0eS5zY3JpcHQuX3NjcmlwdHNJbmRleFtrZXldO1xuICAgICAgaWYgKGtleS5hd2F5dGluZykge1xuICAgICAgICBvcmRlci5zcGxpY2Uoa2V5LmluZCwgMCwga2V5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGRhdGEgPSB7ZW5hYmxlZDplbnRpdHkuc2NyaXB0LmVuYWJsZWQsIG9yZGVyOm9yZGVyLCBzY3JpcHRzOnNjcmlwdHN9O1xuICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gIH0sIF9jYWxsQ29tcG9uZW50TWV0aG9kOmZ1bmN0aW9uKG5hbWUsIGR0KSB7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX2NvbXBvbmVudHMubGVuZ3RoO2krKykge1xuICAgICAgaWYgKCF0aGlzLl9jb21wb25lbnRzW2ldLmVudGl0eS5lbmFibGVkIHx8ICF0aGlzLl9jb21wb25lbnRzW2ldLmVuYWJsZWQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0aGlzLl9jb21wb25lbnRzW2ldW25hbWVdKGR0KTtcbiAgICB9XG4gIH0sIF9vbkluaXRpYWxpemU6ZnVuY3Rpb24oKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX2NvbXBvbmVudHMubGVuZ3RoO2krKykge1xuICAgICAgdGhpcy5fY29tcG9uZW50c1tpXS5fb25Jbml0aWFsaXplQXR0cmlidXRlcygpO1xuICAgIH1cbiAgICB0aGlzLl9jYWxsQ29tcG9uZW50TWV0aG9kKFwiX29uSW5pdGlhbGl6ZVwiKTtcbiAgfSwgX29uUG9zdEluaXRpYWxpemU6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fY2FsbENvbXBvbmVudE1ldGhvZChcIl9vblBvc3RJbml0aWFsaXplXCIpO1xuICB9LCBfb25VcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB0aGlzLl9jYWxsQ29tcG9uZW50TWV0aG9kKFwiX29uVXBkYXRlXCIsIGR0KTtcbiAgfSwgX29uUG9zdFVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHRoaXMuX2NhbGxDb21wb25lbnRNZXRob2QoXCJfb25Qb3N0VXBkYXRlXCIsIGR0KTtcbiAgfSwgX29uQmVmb3JlUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgY29tcG9uZW50KSB7XG4gICAgdmFyIGluZCA9IHRoaXMuX2NvbXBvbmVudHMuaW5kZXhPZihjb21wb25lbnQpO1xuICAgIGlmIChpbmQgPT09IC0xKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbXBvbmVudC5fb25CZWZvcmVSZW1vdmUoKTtcbiAgICB0aGlzLl9jb21wb25lbnRzLnNwbGljZShpbmQsIDEpO1xuICB9fSk7XG4gIHJldHVybiB7U2NyaXB0Q29tcG9uZW50U3lzdGVtOlNjcmlwdENvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjcmlwdENvbXBvbmVudERhdGEgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICB9O1xuICBTY3JpcHRDb21wb25lbnREYXRhID0gcGMuaW5oZXJpdHMoU2NyaXB0Q29tcG9uZW50RGF0YSwgcGMuQ29tcG9uZW50RGF0YSk7XG4gIHJldHVybiB7U2NyaXB0Q29tcG9uZW50RGF0YTpTY3JpcHRDb21wb25lbnREYXRhfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgU2NyaXB0TGVnYWN5Q29tcG9uZW50ID0gZnVuY3Rpb24gU2NyaXB0TGVnYWN5Q29tcG9uZW50KHN5c3RlbSwgZW50aXR5KSB7XG4gICAgdGhpcy5vbihcInNldF9zY3JpcHRzXCIsIHRoaXMub25TZXRTY3JpcHRzLCB0aGlzKTtcbiAgfTtcbiAgU2NyaXB0TGVnYWN5Q29tcG9uZW50ID0gcGMuaW5oZXJpdHMoU2NyaXB0TGVnYWN5Q29tcG9uZW50LCBwYy5Db21wb25lbnQpO1xuICBwYy5leHRlbmQoU2NyaXB0TGVnYWN5Q29tcG9uZW50LnByb3RvdHlwZSwge3NlbmQ6ZnVuY3Rpb24obmFtZSwgZnVuY3Rpb25OYW1lKSB7XG4gICAgY29uc29sZS53YXJuKFwiREVQUkVDQVRFRDogU2NyaXB0TGVnYWN5Q29tcG9uZW50LnNlbmQoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgc29vbi4gUGxlYXNlIHVzZTogaHR0cDovL2RldmVsb3Blci5wbGF5Y2FudmFzLmNvbS91c2VyLW1hbnVhbC9zY3JpcHRpbmcvY29tbXVuaWNhdGlvbi9cIik7XG4gICAgdmFyIGFyZ3MgPSBwYy5tYWtlQXJyYXkoYXJndW1lbnRzKS5zbGljZSgyKTtcbiAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5lbnRpdHkuc2NyaXB0Lmluc3RhbmNlcztcbiAgICB2YXIgZm47XG4gICAgaWYgKGluc3RhbmNlcyAmJiBpbnN0YW5jZXNbbmFtZV0pIHtcbiAgICAgIGZuID0gaW5zdGFuY2VzW25hbWVdLmluc3RhbmNlW2Z1bmN0aW9uTmFtZV07XG4gICAgICBpZiAoZm4pIHtcbiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGluc3RhbmNlc1tuYW1lXS5pbnN0YW5jZSwgYXJncyk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBTY3JpcHRMZWdhY3lDb21wb25lbnQuX3N1cGVyLm9uRW5hYmxlLmNhbGwodGhpcyk7XG4gICAgaWYgKHRoaXMuZGF0YS5hcmVTY3JpcHRzTG9hZGVkICYmICF0aGlzLnN5c3RlbS5wcmVsb2FkaW5nKSB7XG4gICAgICBpZiAoIXRoaXMuZGF0YS5pbml0aWFsaXplZCkge1xuICAgICAgICB0aGlzLnN5c3RlbS5faW5pdGlhbGl6ZVNjcmlwdENvbXBvbmVudCh0aGlzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3lzdGVtLl9lbmFibGVTY3JpcHRDb21wb25lbnQodGhpcyk7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuZGF0YS5wb3N0SW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgdGhpcy5zeXN0ZW0uX3Bvc3RJbml0aWFsaXplU2NyaXB0Q29tcG9uZW50KHRoaXMpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIFNjcmlwdExlZ2FjeUNvbXBvbmVudC5fc3VwZXIub25EaXNhYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy5zeXN0ZW0uX2Rpc2FibGVTY3JpcHRDb21wb25lbnQodGhpcyk7XG4gIH0sIG9uU2V0U2NyaXB0czpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAoIXRoaXMuc3lzdGVtLl9pblRvb2xzIHx8IHRoaXMucnVuSW5Ub29scykge1xuICAgICAgaWYgKHRoaXMuX3VwZGF0ZVNjcmlwdEF0dHJpYnV0ZXMob2xkVmFsdWUsIG5ld1ZhbHVlKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuc3lzdGVtLl9kaXNhYmxlU2NyaXB0Q29tcG9uZW50KHRoaXMpO1xuICAgICAgfVxuICAgICAgdGhpcy5zeXN0ZW0uX2Rlc3Ryb3lTY3JpcHRDb21wb25lbnQodGhpcyk7XG4gICAgICB0aGlzLmRhdGEuYXJlU2NyaXB0c0xvYWRlZCA9IGZhbHNlO1xuICAgICAgdmFyIHNjcmlwdHMgPSBuZXdWYWx1ZTtcbiAgICAgIHZhciB1cmxzID0gc2NyaXB0cy5tYXAoZnVuY3Rpb24ocykge1xuICAgICAgICByZXR1cm4gcy51cmw7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLl9sb2FkRnJvbUNhY2hlKHVybHMpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2xvYWRTY3JpcHRzKHVybHMpO1xuICAgIH1cbiAgfSwgX3VwZGF0ZVNjcmlwdEF0dHJpYnV0ZXM6ZnVuY3Rpb24ob2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIG9ubHlVcGRhdGVBdHRyaWJ1dGVzID0gdHJ1ZTtcbiAgICBpZiAob2xkVmFsdWUubGVuZ3RoICE9PSBuZXdWYWx1ZS5sZW5ndGgpIHtcbiAgICAgIG9ubHlVcGRhdGVBdHRyaWJ1dGVzID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBpLCBsZW4gPSBuZXdWYWx1ZS5sZW5ndGg7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGlmIChvbGRWYWx1ZVtpXS51cmwgIT09IG5ld1ZhbHVlW2ldLnVybCkge1xuICAgICAgICAgIG9ubHlVcGRhdGVBdHRyaWJ1dGVzID0gZmFsc2U7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9ubHlVcGRhdGVBdHRyaWJ1dGVzKSB7XG4gICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5pbnN0YW5jZXMpIHtcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICB0aGlzLnN5c3RlbS5fdXBkYXRlQWNjZXNzb3JzKHRoaXMuZW50aXR5LCB0aGlzLmluc3RhbmNlc1trZXldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb25seVVwZGF0ZUF0dHJpYnV0ZXM7XG4gIH0sIF9sb2FkRnJvbUNhY2hlOmZ1bmN0aW9uKHVybHMpIHtcbiAgICB2YXIgaSwgbGVuO1xuICAgIHZhciBjYWNoZWQgPSBbXTtcbiAgICB2YXIgcHJlZml4ID0gdGhpcy5zeXN0ZW0uYXBwLl9zY3JpcHRQcmVmaXggfHwgXCJcIjtcbiAgICB2YXIgcmVnZXggPSAvXmh0dHAocyk/OlxcL1xcLy9pO1xuICAgIGZvciAoaSA9IDAsIGxlbiA9IHVybHMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgdXJsID0gdXJsc1tpXTtcbiAgICAgIGlmICghcmVnZXgudGVzdCh1cmwpKSB7XG4gICAgICAgIHVybCA9IHBjLnBhdGguam9pbihwcmVmaXgsIHVybCk7XG4gICAgICB9XG4gICAgICB2YXIgdHlwZSA9IHRoaXMuc3lzdGVtLmFwcC5sb2FkZXIuZ2V0RnJvbUNhY2hlKHVybCwgXCJzY3JpcHRcIik7XG4gICAgICBpZiAoIXR5cGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FjaGVkLnB1c2godHlwZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDAsIGxlbiA9IGNhY2hlZC5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHZhciBTY3JpcHRUeXBlID0gY2FjaGVkW2ldO1xuICAgICAgaWYgKFNjcmlwdFR5cGUgPT09IHRydWUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoU2NyaXB0VHlwZSAmJiB0aGlzLmVudGl0eS5zY3JpcHQpIHtcbiAgICAgICAgaWYgKCF0aGlzLmVudGl0eS5zY3JpcHQuaW5zdGFuY2VzW1NjcmlwdFR5cGUuX3BjU2NyaXB0TmFtZV0pIHtcbiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgU2NyaXB0VHlwZSh0aGlzLmVudGl0eSk7XG4gICAgICAgICAgdGhpcy5zeXN0ZW0uX3ByZVJlZ2lzdGVySW5zdGFuY2UodGhpcy5lbnRpdHksIHVybHNbaV0sIFNjcmlwdFR5cGUuX3BjU2NyaXB0TmFtZSwgaW5zdGFuY2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmRhdGEpIHtcbiAgICAgIHRoaXMuZGF0YS5hcmVTY3JpcHRzTG9hZGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnN5c3RlbS5wcmVsb2FkaW5nKSB7XG4gICAgICB0aGlzLnN5c3RlbS5vbkluaXRpYWxpemUodGhpcy5lbnRpdHkpO1xuICAgICAgdGhpcy5zeXN0ZW0ub25Qb3N0SW5pdGlhbGl6ZSh0aGlzLmVudGl0eSk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9LCBfbG9hZFNjcmlwdHM6ZnVuY3Rpb24odXJscykge1xuICAgIHZhciBjb3VudCA9IHVybHMubGVuZ3RoO1xuICAgIHZhciBwcmVmaXggPSB0aGlzLnN5c3RlbS5hcHAuX3NjcmlwdFByZWZpeCB8fCBcIlwiO1xuICAgIHVybHMuZm9yRWFjaChmdW5jdGlvbih1cmwpIHtcbiAgICAgIHZhciBfdXJsID0gbnVsbDtcbiAgICAgIHZhciBfdW5wcmVmaXhlZCA9IG51bGw7XG4gICAgICBpZiAodXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aChcImh0dHA6Ly9cIikgfHwgdXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aChcImh0dHBzOi8vXCIpKSB7XG4gICAgICAgIF91bnByZWZpeGVkID0gdXJsO1xuICAgICAgICBfdXJsID0gdXJsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgX3VucHJlZml4ZWQgPSB1cmw7XG4gICAgICAgIF91cmwgPSBwYy5wYXRoLmpvaW4ocHJlZml4LCB1cmwpO1xuICAgICAgfVxuICAgICAgdGhpcy5zeXN0ZW0uYXBwLmxvYWRlci5sb2FkKF91cmwsIFwic2NyaXB0XCIsIGZ1bmN0aW9uKGVyciwgU2NyaXB0VHlwZSkge1xuICAgICAgICBjb3VudC0tO1xuICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgIGlmIChTY3JpcHRUeXBlICYmIHRoaXMuZW50aXR5LnNjcmlwdCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmVudGl0eS5zY3JpcHQuaW5zdGFuY2VzW1NjcmlwdFR5cGUuX3BjU2NyaXB0TmFtZV0pIHtcbiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IFNjcmlwdFR5cGUodGhpcy5lbnRpdHkpO1xuICAgICAgICAgICAgICB0aGlzLnN5c3RlbS5fcHJlUmVnaXN0ZXJJbnN0YW5jZSh0aGlzLmVudGl0eSwgX3VucHJlZml4ZWQsIFNjcmlwdFR5cGUuX3BjU2NyaXB0TmFtZSwgaW5zdGFuY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvdW50ID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5kYXRhLmFyZVNjcmlwdHNMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgIGlmICghdGhpcy5zeXN0ZW0ucHJlbG9hZGluZykge1xuICAgICAgICAgICAgdGhpcy5zeXN0ZW0ub25Jbml0aWFsaXplKHRoaXMuZW50aXR5KTtcbiAgICAgICAgICAgIHRoaXMuc3lzdGVtLm9uUG9zdEluaXRpYWxpemUodGhpcy5lbnRpdHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9LmJpbmQodGhpcykpO1xuICB9fSk7XG4gIHJldHVybiB7U2NyaXB0TGVnYWN5Q29tcG9uZW50OlNjcmlwdExlZ2FjeUNvbXBvbmVudH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIF9zY2hlbWEgPSBbXCJlbmFibGVkXCIsIFwic2NyaXB0c1wiLCBcImluc3RhbmNlc1wiLCBcInJ1bkluVG9vbHNcIl07XG4gIHZhciBJTklUSUFMSVpFID0gXCJpbml0aWFsaXplXCI7XG4gIHZhciBQT1NUX0lOSVRJQUxJWkUgPSBcInBvc3RJbml0aWFsaXplXCI7XG4gIHZhciBVUERBVEUgPSBcInVwZGF0ZVwiO1xuICB2YXIgUE9TVF9VUERBVEUgPSBcInBvc3RVcGRhdGVcIjtcbiAgdmFyIEZJWEVEX1VQREFURSA9IFwiZml4ZWRVcGRhdGVcIjtcbiAgdmFyIFRPT0xTX1VQREFURSA9IFwidG9vbHNVcGRhdGVcIjtcbiAgdmFyIE9OX0VOQUJMRSA9IFwib25FbmFibGVcIjtcbiAgdmFyIE9OX0RJU0FCTEUgPSBcIm9uRGlzYWJsZVwiO1xuICB2YXIgU2NyaXB0TGVnYWN5Q29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24gU2NyaXB0TGVnYWN5Q29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcInNjcmlwdFwiO1xuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBcIkFsbG93cyB0aGUgRW50aXR5IHRvIHJ1biBKYXZhU2NyaXB0IGZyYWdtZW50cyB0byBpbXBsZW1lbnQgY3VzdG9tIGJlaGF2aW9yLlwiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5TY3JpcHRMZWdhY3lDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLlNjcmlwdExlZ2FjeUNvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMucHJlbG9hZGluZyA9IGZhbHNlO1xuICAgIHRoaXMuaW5zdGFuY2VzV2l0aFVwZGF0ZSA9IFtdO1xuICAgIHRoaXMuaW5zdGFuY2VzV2l0aEZpeGVkVXBkYXRlID0gW107XG4gICAgdGhpcy5pbnN0YW5jZXNXaXRoUG9zdFVwZGF0ZSA9IFtdO1xuICAgIHRoaXMuaW5zdGFuY2VzV2l0aFRvb2xzVXBkYXRlID0gW107XG4gICAgdGhpcy5vbihcImJlZm9yZXJlbW92ZVwiLCB0aGlzLm9uQmVmb3JlUmVtb3ZlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oSU5JVElBTElaRSwgdGhpcy5vbkluaXRpYWxpemUsIHRoaXMpO1xuICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vbihQT1NUX0lOSVRJQUxJWkUsIHRoaXMub25Qb3N0SW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKFVQREFURSwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKEZJWEVEX1VQREFURSwgdGhpcy5vbkZpeGVkVXBkYXRlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oUE9TVF9VUERBVEUsIHRoaXMub25Qb3N0VXBkYXRlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oVE9PTFNfVVBEQVRFLCB0aGlzLm9uVG9vbHNVcGRhdGUsIHRoaXMpO1xuICB9O1xuICBTY3JpcHRMZWdhY3lDb21wb25lbnRTeXN0ZW0gPSBwYy5pbmhlcml0cyhTY3JpcHRMZWdhY3lDb21wb25lbnRTeXN0ZW0sIHBjLkNvbXBvbmVudFN5c3RlbSk7XG4gIHBjLkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMocGMuU2NyaXB0TGVnYWN5Q29tcG9uZW50LnByb3RvdHlwZSwgX3NjaGVtYSk7XG4gIHBjLmV4dGVuZChTY3JpcHRMZWdhY3lDb21wb25lbnRTeXN0ZW0ucHJvdG90eXBlLCB7aW5pdGlhbGl6ZUNvbXBvbmVudERhdGE6ZnVuY3Rpb24oY29tcG9uZW50LCBkYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcyA9IFtcInJ1bkluVG9vbHNcIiwgXCJlbmFibGVkXCIsIFwic2NyaXB0c1wiXTtcbiAgICBpZiAoZGF0YS5zY3JpcHRzICYmIGRhdGEuc2NyaXB0cy5sZW5ndGgpIHtcbiAgICAgIGRhdGEuc2NyaXB0cy5mb3JFYWNoKGZ1bmN0aW9uKHNjcmlwdCkge1xuICAgICAgICBpZiAoc2NyaXB0LmF0dHJpYnV0ZXMgJiYgcGMudHlwZShzY3JpcHQuYXR0cmlidXRlcykgPT09IFwiYXJyYXlcIikge1xuICAgICAgICAgIHZhciBkaWN0ID0ge307XG4gICAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IHNjcmlwdC5hdHRyaWJ1dGVzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgIGRpY3Rbc2NyaXB0LmF0dHJpYnV0ZXNbaV0ubmFtZV0gPSBzY3JpcHQuYXR0cmlidXRlc1tpXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc2NyaXB0LmF0dHJpYnV0ZXMgPSBkaWN0O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgU2NyaXB0TGVnYWN5Q29tcG9uZW50U3lzdGVtLl9zdXBlci5pbml0aWFsaXplQ29tcG9uZW50RGF0YS5jYWxsKHRoaXMsIGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcyk7XG4gIH0sIGNsb25lQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY2xvbmUpIHtcbiAgICB2YXIgc3JjID0gdGhpcy5kYXRhU3RvcmVbZW50aXR5Ll9ndWlkXTtcbiAgICB2YXIgZGF0YSA9IHtydW5JblRvb2xzOnNyYy5kYXRhLnJ1bkluVG9vbHMsIHNjcmlwdHM6W10sIGVuYWJsZWQ6c3JjLmRhdGEuZW5hYmxlZH07XG4gICAgdmFyIHNjcmlwdHMgPSBzcmMuZGF0YS5zY3JpcHRzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzY3JpcHRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBzY3JpcHRzW2ldLmF0dHJpYnV0ZXM7XG4gICAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgICBkZWxldGUgc2NyaXB0c1tpXS5hdHRyaWJ1dGVzO1xuICAgICAgfVxuICAgICAgZGF0YS5zY3JpcHRzLnB1c2gocGMuZXh0ZW5kKHt9LCBzY3JpcHRzW2ldKSk7XG4gICAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgICBkYXRhLnNjcmlwdHNbaV0uYXR0cmlidXRlcyA9IHRoaXMuX2Nsb25lQXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcbiAgICAgICAgc2NyaXB0c1tpXS5hdHRyaWJ1dGVzID0gYXR0cmlidXRlcztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYWRkQ29tcG9uZW50KGNsb25lLCBkYXRhKTtcbiAgfSwgb25CZWZvcmVSZW1vdmU6ZnVuY3Rpb24oZW50aXR5LCBjb21wb25lbnQpIHtcbiAgICBpZiAoY29tcG9uZW50LmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuX2Rpc2FibGVTY3JpcHRDb21wb25lbnQoY29tcG9uZW50KTtcbiAgICB9XG4gICAgdGhpcy5fZGVzdHJveVNjcmlwdENvbXBvbmVudChjb21wb25lbnQpO1xuICB9LCBvbkluaXRpYWxpemU6ZnVuY3Rpb24ocm9vdCkge1xuICAgIHRoaXMuX3JlZ2lzdGVySW5zdGFuY2VzKHJvb3QpO1xuICAgIGlmIChyb290LmVuYWJsZWQpIHtcbiAgICAgIGlmIChyb290LnNjcmlwdCAmJiByb290LnNjcmlwdC5lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVTY3JpcHRDb21wb25lbnQocm9vdC5zY3JpcHQpO1xuICAgICAgfVxuICAgICAgdmFyIGNoaWxkcmVuID0gcm9vdC5fY2hpbGRyZW47XG4gICAgICB2YXIgaSwgbGVuID0gY2hpbGRyZW4ubGVuZ3RoO1xuICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICBpZiAoY2hpbGRyZW5baV0gaW5zdGFuY2VvZiBwYy5FbnRpdHkpIHtcbiAgICAgICAgICB0aGlzLm9uSW5pdGlhbGl6ZShjaGlsZHJlbltpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uUG9zdEluaXRpYWxpemU6ZnVuY3Rpb24ocm9vdCkge1xuICAgIGlmIChyb290LmVuYWJsZWQpIHtcbiAgICAgIGlmIChyb290LnNjcmlwdCAmJiByb290LnNjcmlwdC5lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX3Bvc3RJbml0aWFsaXplU2NyaXB0Q29tcG9uZW50KHJvb3Quc2NyaXB0KTtcbiAgICAgIH1cbiAgICAgIHZhciBjaGlsZHJlbiA9IHJvb3QuX2NoaWxkcmVuO1xuICAgICAgdmFyIGksIGxlbiA9IGNoaWxkcmVuLmxlbmd0aDtcbiAgICAgIGZvciAoaSA9IDA7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgaWYgKGNoaWxkcmVuW2ldIGluc3RhbmNlb2YgcGMuRW50aXR5KSB7XG4gICAgICAgICAgdGhpcy5vblBvc3RJbml0aWFsaXplKGNoaWxkcmVuW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgX2NhbGxJbnN0YW5jZXNNZXRob2Q6ZnVuY3Rpb24oc2NyaXB0LCBtZXRob2QpIHtcbiAgICB2YXIgaW5zdGFuY2VzID0gc2NyaXB0LmRhdGEuaW5zdGFuY2VzO1xuICAgIGZvciAodmFyIG5hbWUgaW4gaW5zdGFuY2VzKSB7XG4gICAgICBpZiAoaW5zdGFuY2VzLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlc1tuYW1lXS5pbnN0YW5jZTtcbiAgICAgICAgaWYgKGluc3RhbmNlW21ldGhvZF0pIHtcbiAgICAgICAgICBpbnN0YW5jZVttZXRob2RdLmNhbGwoaW5zdGFuY2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfaW5pdGlhbGl6ZVNjcmlwdENvbXBvbmVudDpmdW5jdGlvbihzY3JpcHQpIHtcbiAgICB0aGlzLl9jYWxsSW5zdGFuY2VzTWV0aG9kKHNjcmlwdCwgSU5JVElBTElaRSk7XG4gICAgc2NyaXB0LmRhdGEuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIGlmIChzY3JpcHQuZW5hYmxlZCAmJiBzY3JpcHQuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuX2VuYWJsZVNjcmlwdENvbXBvbmVudChzY3JpcHQpO1xuICAgIH1cbiAgfSwgX2VuYWJsZVNjcmlwdENvbXBvbmVudDpmdW5jdGlvbihzY3JpcHQpIHtcbiAgICB0aGlzLl9jYWxsSW5zdGFuY2VzTWV0aG9kKHNjcmlwdCwgT05fRU5BQkxFKTtcbiAgfSwgX2Rpc2FibGVTY3JpcHRDb21wb25lbnQ6ZnVuY3Rpb24oc2NyaXB0KSB7XG4gICAgdGhpcy5fY2FsbEluc3RhbmNlc01ldGhvZChzY3JpcHQsIE9OX0RJU0FCTEUpO1xuICB9LCBfZGVzdHJveVNjcmlwdENvbXBvbmVudDpmdW5jdGlvbihzY3JpcHQpIHtcbiAgICB2YXIgaW5kZXg7XG4gICAgdmFyIGluc3RhbmNlcyA9IHNjcmlwdC5kYXRhLmluc3RhbmNlcztcbiAgICBmb3IgKHZhciBuYW1lIGluIGluc3RhbmNlcykge1xuICAgICAgaWYgKGluc3RhbmNlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICB2YXIgaW5zdGFuY2UgPSBpbnN0YW5jZXNbbmFtZV0uaW5zdGFuY2U7XG4gICAgICAgIGlmIChpbnN0YW5jZS5kZXN0cm95KSB7XG4gICAgICAgICAgaW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpbnN0YW5jZS51cGRhdGUpIHtcbiAgICAgICAgICBpbmRleCA9IHRoaXMuaW5zdGFuY2VzV2l0aFVwZGF0ZS5pbmRleE9mKGluc3RhbmNlKTtcbiAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZXNXaXRoVXBkYXRlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChpbnN0YW5jZS5maXhlZFVwZGF0ZSkge1xuICAgICAgICAgIGluZGV4ID0gdGhpcy5pbnN0YW5jZXNXaXRoRml4ZWRVcGRhdGUuaW5kZXhPZihpbnN0YW5jZSk7XG4gICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VzV2l0aEZpeGVkVXBkYXRlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChpbnN0YW5jZS5wb3N0VXBkYXRlKSB7XG4gICAgICAgICAgaW5kZXggPSB0aGlzLmluc3RhbmNlc1dpdGhQb3N0VXBkYXRlLmluZGV4T2YoaW5zdGFuY2UpO1xuICAgICAgICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlc1dpdGhQb3N0VXBkYXRlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChpbnN0YW5jZS50b29sc1VwZGF0ZSkge1xuICAgICAgICAgIGluZGV4ID0gdGhpcy5pbnN0YW5jZXNXaXRoVG9vbHNVcGRhdGUuaW5kZXhPZihpbnN0YW5jZSk7XG4gICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VzV2l0aFRvb2xzVXBkYXRlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzY3JpcHQuaW5zdGFuY2VzW25hbWVdLmluc3RhbmNlID09PSBzY3JpcHRbbmFtZV0pIHtcbiAgICAgICAgICBkZWxldGUgc2NyaXB0W25hbWVdO1xuICAgICAgICB9XG4gICAgICAgIGRlbGV0ZSBzY3JpcHQuaW5zdGFuY2VzW25hbWVdO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX3Bvc3RJbml0aWFsaXplU2NyaXB0Q29tcG9uZW50OmZ1bmN0aW9uKHNjcmlwdCkge1xuICAgIHRoaXMuX2NhbGxJbnN0YW5jZXNNZXRob2Qoc2NyaXB0LCBQT1NUX0lOSVRJQUxJWkUpO1xuICAgIHNjcmlwdC5kYXRhLnBvc3RJbml0aWFsaXplZCA9IHRydWU7XG4gIH0sIF91cGRhdGVJbnN0YW5jZXM6ZnVuY3Rpb24obWV0aG9kLCB1cGRhdGVMaXN0LCBkdCkge1xuICAgIHZhciBpdGVtO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB1cGRhdGVMaXN0Lmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaXRlbSA9IHVwZGF0ZUxpc3RbaV07XG4gICAgICBpZiAoaXRlbSAmJiBpdGVtLmVudGl0eSAmJiBpdGVtLmVudGl0eS5lbmFibGVkICYmIGl0ZW0uZW50aXR5LnNjcmlwdC5lbmFibGVkKSB7XG4gICAgICAgIGl0ZW1bbWV0aG9kXS5jYWxsKGl0ZW0sIGR0KTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uVXBkYXRlOmZ1bmN0aW9uKGR0KSB7XG4gICAgdGhpcy5fdXBkYXRlSW5zdGFuY2VzKFVQREFURSwgdGhpcy5pbnN0YW5jZXNXaXRoVXBkYXRlLCBkdCk7XG4gIH0sIG9uRml4ZWRVcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB0aGlzLl91cGRhdGVJbnN0YW5jZXMoRklYRURfVVBEQVRFLCB0aGlzLmluc3RhbmNlc1dpdGhGaXhlZFVwZGF0ZSwgZHQpO1xuICB9LCBvblBvc3RVcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB0aGlzLl91cGRhdGVJbnN0YW5jZXMoUE9TVF9VUERBVEUsIHRoaXMuaW5zdGFuY2VzV2l0aFBvc3RVcGRhdGUsIGR0KTtcbiAgfSwgb25Ub29sc1VwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHRoaXMuX3VwZGF0ZUluc3RhbmNlcyhUT09MU19VUERBVEUsIHRoaXMuaW5zdGFuY2VzV2l0aFRvb2xzVXBkYXRlLCBkdCk7XG4gIH0sIGJyb2FkY2FzdDpmdW5jdGlvbihuYW1lLCBmdW5jdGlvbk5hbWUpIHtcbiAgICBjb25zb2xlLndhcm4oXCJERVBSRUNBVEVEOiBTY3JpcHRMZWdhY3lDb21wb25lbnRTeXN0ZW0uYnJvYWRjYXN0KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIHNvb24uIFBsZWFzZSB1c2U6IGh0dHA6Ly9kZXZlbG9wZXIucGxheWNhbnZhcy5jb20vdXNlci1tYW51YWwvc2NyaXB0aW5nL2NvbW11bmljYXRpb24vXCIpO1xuICAgIHZhciBhcmdzID0gcGMubWFrZUFycmF5KGFyZ3VtZW50cykuc2xpY2UoMik7XG4gICAgdmFyIGlkLCBkYXRhLCBmbjtcbiAgICB2YXIgZGF0YVN0b3JlID0gdGhpcy5zdG9yZTtcbiAgICBmb3IgKGlkIGluIGRhdGFTdG9yZSkge1xuICAgICAgaWYgKGRhdGFTdG9yZS5oYXNPd25Qcm9wZXJ0eShpZCkpIHtcbiAgICAgICAgZGF0YSA9IGRhdGFTdG9yZVtpZF0uZGF0YTtcbiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2VzW25hbWVdKSB7XG4gICAgICAgICAgZm4gPSBkYXRhLmluc3RhbmNlc1tuYW1lXS5pbnN0YW5jZVtmdW5jdGlvbk5hbWVdO1xuICAgICAgICAgIGlmIChmbikge1xuICAgICAgICAgICAgZm4uYXBwbHkoZGF0YS5pbnN0YW5jZXNbbmFtZV0uaW5zdGFuY2UsIGFyZ3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgX3ByZVJlZ2lzdGVySW5zdGFuY2U6ZnVuY3Rpb24oZW50aXR5LCB1cmwsIG5hbWUsIGluc3RhbmNlKSB7XG4gICAgaWYgKGVudGl0eS5zY3JpcHQpIHtcbiAgICAgIGVudGl0eS5zY3JpcHQuZGF0YS5faW5zdGFuY2VzID0gZW50aXR5LnNjcmlwdC5kYXRhLl9pbnN0YW5jZXMgfHwge307XG4gICAgICBpZiAoZW50aXR5LnNjcmlwdC5kYXRhLl9pbnN0YW5jZXNbbmFtZV0pIHtcbiAgICAgICAgdGhyb3cgRXJyb3IocGMuc3RyaW5nLmZvcm1hdChcIlNjcmlwdCBuYW1lIGNvbGxpc2lvbiAnezB9Jy4gU2NyaXB0cyBmcm9tICd7MX0nIGFuZCAnezJ9JyB7ezN9fVwiLCBuYW1lLCB1cmwsIGVudGl0eS5zY3JpcHQuZGF0YS5faW5zdGFuY2VzW25hbWVdLnVybCwgZW50aXR5Ll9ndWlkKSk7XG4gICAgICB9XG4gICAgICBlbnRpdHkuc2NyaXB0LmRhdGEuX2luc3RhbmNlc1tuYW1lXSA9IHt1cmw6dXJsLCBuYW1lOm5hbWUsIGluc3RhbmNlOmluc3RhbmNlfTtcbiAgICB9XG4gIH0sIF9yZWdpc3Rlckluc3RhbmNlczpmdW5jdGlvbihlbnRpdHkpIHtcbiAgICB2YXIgcHJlUmVnaXN0ZXJlZCwgaW5zdGFuY2UsIGluc3RhbmNlTmFtZTtcbiAgICBpZiAoZW50aXR5LnNjcmlwdCkge1xuICAgICAgaWYgKGVudGl0eS5zY3JpcHQuZGF0YS5faW5zdGFuY2VzKSB7XG4gICAgICAgIGVudGl0eS5zY3JpcHQuaW5zdGFuY2VzID0gZW50aXR5LnNjcmlwdC5kYXRhLl9pbnN0YW5jZXM7XG4gICAgICAgIGZvciAoaW5zdGFuY2VOYW1lIGluIGVudGl0eS5zY3JpcHQuaW5zdGFuY2VzKSB7XG4gICAgICAgICAgcHJlUmVnaXN0ZXJlZCA9IGVudGl0eS5zY3JpcHQuaW5zdGFuY2VzW2luc3RhbmNlTmFtZV07XG4gICAgICAgICAgaW5zdGFuY2UgPSBwcmVSZWdpc3RlcmVkLmluc3RhbmNlO1xuICAgICAgICAgIHBjLmV2ZW50cy5hdHRhY2goaW5zdGFuY2UpO1xuICAgICAgICAgIGlmIChpbnN0YW5jZS51cGRhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VzV2l0aFVwZGF0ZS5wdXNoKGluc3RhbmNlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGluc3RhbmNlLmZpeGVkVXBkYXRlKSB7XG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlc1dpdGhGaXhlZFVwZGF0ZS5wdXNoKGluc3RhbmNlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGluc3RhbmNlLnBvc3RVcGRhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VzV2l0aFBvc3RVcGRhdGUucHVzaChpbnN0YW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChpbnN0YW5jZS50b29sc1VwZGF0ZSkge1xuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZXNXaXRoVG9vbHNVcGRhdGUucHVzaChpbnN0YW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChlbnRpdHkuc2NyaXB0LnNjcmlwdHMpIHtcbiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUFjY2Vzc29ycyhlbnRpdHksIHByZVJlZ2lzdGVyZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZW50aXR5LnNjcmlwdFtpbnN0YW5jZU5hbWVdKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihwYy5zdHJpbmcuZm9ybWF0KFwiU2NyaXB0IHdpdGggbmFtZSAnezB9JyBpcyBhbHJlYWR5IGF0dGFjaGVkIHRvIFNjcmlwdCBDb21wb25lbnRcIiwgaW5zdGFuY2VOYW1lKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVudGl0eS5zY3JpcHRbaW5zdGFuY2VOYW1lXSA9IGluc3RhbmNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBkZWxldGUgZW50aXR5LnNjcmlwdC5kYXRhLl9pbnN0YW5jZXM7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBjaGlsZHJlbiA9IGVudGl0eS5fY2hpbGRyZW47XG4gICAgdmFyIGksIGxlbiA9IGNoaWxkcmVuLmxlbmd0aDtcbiAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICBpZiAoY2hpbGRyZW5baV0gaW5zdGFuY2VvZiBwYy5FbnRpdHkpIHtcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJJbnN0YW5jZXMoY2hpbGRyZW5baV0pO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX2Nsb25lQXR0cmlidXRlczpmdW5jdGlvbihhdHRyaWJ1dGVzKSB7XG4gICAgdmFyIHJlc3VsdCA9IHt9O1xuICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICBpZiAoIWF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChhdHRyaWJ1dGVzW2tleV0udHlwZSAhPT0gXCJlbnRpdHlcIikge1xuICAgICAgICByZXN1bHRba2V5XSA9IHBjLmV4dGVuZCh7fSwgYXR0cmlidXRlc1trZXldKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciB2YWwgPSBhdHRyaWJ1dGVzW2tleV0udmFsdWU7XG4gICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGVzW2tleV0udmFsdWU7XG4gICAgICAgIHJlc3VsdFtrZXldID0gcGMuZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzW2tleV0pO1xuICAgICAgICByZXN1bHRba2V5XS52YWx1ZSA9IHZhbDtcbiAgICAgICAgYXR0cmlidXRlc1trZXldLnZhbHVlID0gdmFsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9LCBfY3JlYXRlQWNjZXNzb3JzOmZ1bmN0aW9uKGVudGl0eSwgaW5zdGFuY2UpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGk7XG4gICAgdmFyIGxlbiA9IGVudGl0eS5zY3JpcHQuc2NyaXB0cy5sZW5ndGg7XG4gICAgdmFyIHVybCA9IGluc3RhbmNlLnVybDtcbiAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgc2NyaXB0ID0gZW50aXR5LnNjcmlwdC5zY3JpcHRzW2ldO1xuICAgICAgaWYgKHNjcmlwdC51cmwgPT09IHVybCkge1xuICAgICAgICB2YXIgYXR0cmlidXRlcyA9IHNjcmlwdC5hdHRyaWJ1dGVzO1xuICAgICAgICBpZiAoc2NyaXB0Lm5hbWUgJiYgYXR0cmlidXRlcykge1xuICAgICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgIHNlbGYuX2NyZWF0ZUFjY2Vzc29yKGF0dHJpYnV0ZXNba2V5XSwgaW5zdGFuY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBlbnRpdHkuc2NyaXB0LmRhdGEuYXR0cmlidXRlc1tzY3JpcHQubmFtZV0gPSBzZWxmLl9jbG9uZUF0dHJpYnV0ZXMoYXR0cmlidXRlcyk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9LCBfY3JlYXRlQWNjZXNzb3I6ZnVuY3Rpb24oYXR0cmlidXRlLCBpbnN0YW5jZSkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBhdHRyaWJ1dGUgPSB7bmFtZTphdHRyaWJ1dGUubmFtZSwgdmFsdWU6YXR0cmlidXRlLnZhbHVlLCB0eXBlOmF0dHJpYnV0ZS50eXBlfTtcbiAgICBzZWxmLl9jb252ZXJ0QXR0cmlidXRlVmFsdWUoYXR0cmlidXRlKTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5zdGFuY2UuaW5zdGFuY2UsIGF0dHJpYnV0ZS5uYW1lLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGF0dHJpYnV0ZS52YWx1ZTtcbiAgICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIHZhciBvbGRWYWx1ZSA9IGF0dHJpYnV0ZS52YWx1ZTtcbiAgICAgIGF0dHJpYnV0ZS52YWx1ZSA9IHZhbHVlO1xuICAgICAgc2VsZi5fY29udmVydEF0dHJpYnV0ZVZhbHVlKGF0dHJpYnV0ZSk7XG4gICAgICBpbnN0YW5jZS5pbnN0YW5jZS5maXJlKFwic2V0XCIsIGF0dHJpYnV0ZS5uYW1lLCBvbGRWYWx1ZSwgYXR0cmlidXRlLnZhbHVlKTtcbiAgICB9LCBjb25maWd1cmFibGU6dHJ1ZX0pO1xuICB9LCBfdXBkYXRlQWNjZXNzb3JzOmZ1bmN0aW9uKGVudGl0eSwgaW5zdGFuY2UpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGk7XG4gICAgdmFyIGxlbiA9IGVudGl0eS5zY3JpcHQuc2NyaXB0cy5sZW5ndGg7XG4gICAgdmFyIGtleTtcbiAgICB2YXIgdXJsID0gaW5zdGFuY2UudXJsO1xuICAgIHZhciBzY3JpcHRDb21wb25lbnQsIHNjcmlwdCwgbmFtZSwgYXR0cmlidXRlcztcbiAgICB2YXIgcHJldmlvdXNBdHRyaWJ1dGVzO1xuICAgIHZhciBvbGRBdHRyaWJ1dGU7XG4gICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgc2NyaXB0Q29tcG9uZW50ID0gZW50aXR5LnNjcmlwdDtcbiAgICAgIHNjcmlwdCA9IHNjcmlwdENvbXBvbmVudC5zY3JpcHRzW2ldO1xuICAgICAgaWYgKHNjcmlwdC51cmwgPT09IHVybCkge1xuICAgICAgICBuYW1lID0gc2NyaXB0Lm5hbWU7XG4gICAgICAgIGF0dHJpYnV0ZXMgPSBzY3JpcHQuYXR0cmlidXRlcztcbiAgICAgICAgaWYgKG5hbWUpIHtcbiAgICAgICAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgICAgICAgZm9yIChrZXkgaW4gYXR0cmlidXRlcykge1xuICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5fY3JlYXRlQWNjZXNzb3IoYXR0cmlidXRlc1trZXldLCBpbnN0YW5jZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzID0gc2NyaXB0Q29tcG9uZW50LmRhdGEuYXR0cmlidXRlc1tuYW1lXTtcbiAgICAgICAgICBpZiAocHJldmlvdXNBdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBmb3IgKGtleSBpbiBwcmV2aW91c0F0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgICAgb2xkQXR0cmlidXRlID0gcHJldmlvdXNBdHRyaWJ1dGVzW2tleV07XG4gICAgICAgICAgICAgIGlmICghKGtleSBpbiBhdHRyaWJ1dGVzKSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBpbnN0YW5jZS5pbnN0YW5jZVtvbGRBdHRyaWJ1dGUubmFtZV07XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXNba2V5XS52YWx1ZSAhPT0gb2xkQXR0cmlidXRlLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuaW5zdGFuY2Uub25BdHRyaWJ1dGVDaGFuZ2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmluc3RhbmNlLm9uQXR0cmlidXRlQ2hhbmdlZChvbGRBdHRyaWJ1dGUubmFtZSwgb2xkQXR0cmlidXRlLnZhbHVlLCBhdHRyaWJ1dGVzW2tleV0udmFsdWUpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgICAgICAgc2NyaXB0Q29tcG9uZW50LmRhdGEuYXR0cmlidXRlc1tuYW1lXSA9IHNlbGYuX2Nsb25lQXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIHNjcmlwdENvbXBvbmVudC5kYXRhLmF0dHJpYnV0ZXNbbmFtZV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX2NvbnZlcnRBdHRyaWJ1dGVWYWx1ZTpmdW5jdGlvbihhdHRyaWJ1dGUpIHtcbiAgICBpZiAoYXR0cmlidXRlLnR5cGUgPT09IFwicmdiXCIgfHwgYXR0cmlidXRlLnR5cGUgPT09IFwicmdiYVwiKSB7XG4gICAgICBpZiAocGMudHlwZShhdHRyaWJ1dGUudmFsdWUpID09PSBcImFycmF5XCIpIHtcbiAgICAgICAgYXR0cmlidXRlLnZhbHVlID0gYXR0cmlidXRlLnZhbHVlLmxlbmd0aCA9PT0gMyA/IG5ldyBwYy5Db2xvcihhdHRyaWJ1dGUudmFsdWVbMF0sIGF0dHJpYnV0ZS52YWx1ZVsxXSwgYXR0cmlidXRlLnZhbHVlWzJdKSA6IG5ldyBwYy5Db2xvcihhdHRyaWJ1dGUudmFsdWVbMF0sIGF0dHJpYnV0ZS52YWx1ZVsxXSwgYXR0cmlidXRlLnZhbHVlWzJdLCBhdHRyaWJ1dGUudmFsdWVbM10pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoYXR0cmlidXRlLnR5cGUgPT09IFwidmVjMlwiKSB7XG4gICAgICAgIGlmIChwYy50eXBlKGF0dHJpYnV0ZS52YWx1ZSkgPT09IFwiYXJyYXlcIikge1xuICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZSA9IG5ldyBwYy5WZWMyKGF0dHJpYnV0ZS52YWx1ZVswXSwgYXR0cmlidXRlLnZhbHVlWzFdKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGF0dHJpYnV0ZS50eXBlID09PSBcInZlYzNcIiB8fCBhdHRyaWJ1dGUudHlwZSA9PT0gXCJ2ZWN0b3JcIikge1xuICAgICAgICAgIGlmIChwYy50eXBlKGF0dHJpYnV0ZS52YWx1ZSkgPT09IFwiYXJyYXlcIikge1xuICAgICAgICAgICAgYXR0cmlidXRlLnZhbHVlID0gbmV3IHBjLlZlYzMoYXR0cmlidXRlLnZhbHVlWzBdLCBhdHRyaWJ1dGUudmFsdWVbMV0sIGF0dHJpYnV0ZS52YWx1ZVsyXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChhdHRyaWJ1dGUudHlwZSA9PT0gXCJ2ZWM0XCIpIHtcbiAgICAgICAgICAgIGlmIChwYy50eXBlKGF0dHJpYnV0ZS52YWx1ZSkgPT09IFwiYXJyYXlcIikge1xuICAgICAgICAgICAgICBhdHRyaWJ1dGUudmFsdWUgPSBuZXcgcGMuVmVjNChhdHRyaWJ1dGUudmFsdWVbMF0sIGF0dHJpYnV0ZS52YWx1ZVsxXSwgYXR0cmlidXRlLnZhbHVlWzJdLCBhdHRyaWJ1dGUudmFsdWVbM10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoYXR0cmlidXRlLnR5cGUgPT09IFwiZW50aXR5XCIpIHtcbiAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZS52YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgYXR0cmlidXRlLnZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlLnZhbHVlID0gdGhpcy5hcHAucm9vdC5maW5kQnlHdWlkKGF0dHJpYnV0ZS52YWx1ZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGUudHlwZSA9PT0gXCJjdXJ2ZVwiIHx8IGF0dHJpYnV0ZS50eXBlID09PSBcImNvbG9yY3VydmVcIikge1xuICAgICAgICAgICAgICAgIHZhciBjdXJ2ZVR5cGUgPSBhdHRyaWJ1dGUudmFsdWUua2V5c1swXSBpbnN0YW5jZW9mIEFycmF5ID8gcGMuQ3VydmVTZXQgOiBwYy5DdXJ2ZTtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGUudmFsdWUgPSBuZXcgY3VydmVUeXBlKGF0dHJpYnV0ZS52YWx1ZS5rZXlzKTtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGUudmFsdWUudHlwZSA9IGF0dHJpYnV0ZS52YWx1ZS50eXBlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIHJldHVybiB7U2NyaXB0TGVnYWN5Q29tcG9uZW50U3lzdGVtOlNjcmlwdExlZ2FjeUNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjcmlwdExlZ2FjeUNvbXBvbmVudERhdGEgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnNjcmlwdHMgPSBbXTtcbiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICAgIHRoaXMuaW5zdGFuY2VzID0ge307XG4gICAgdGhpcy5faW5zdGFuY2VzID0ge307XG4gICAgdGhpcy5ydW5JblRvb2xzID0gZmFsc2U7XG4gICAgdGhpcy5hdHRyaWJ1dGVzID0ge307XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIHRoaXMucG9zdEluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgdGhpcy5hcmVTY3JpcHRzTG9hZGVkID0gZmFsc2U7XG4gIH07XG4gIFNjcmlwdExlZ2FjeUNvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhTY3JpcHRMZWdhY3lDb21wb25lbnREYXRhLCBwYy5Db21wb25lbnREYXRhKTtcbiAgcmV0dXJuIHtTY3JpcHRMZWdhY3lDb21wb25lbnREYXRhOlNjcmlwdExlZ2FjeUNvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywge0RJU1RBTkNFX0xJTkVBUjpcImxpbmVhclwiLCBESVNUQU5DRV9JTlZFUlNFOlwiaW52ZXJzZVwiLCBESVNUQU5DRV9FWFBPTkVOVElBTDpcImV4cG9uZW50aWFsXCJ9KTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBpbnN0YW5jZU9wdGlvbnMgPSB7dm9sdW1lOjAsIHBpdGNoOjAsIGxvb3A6ZmFsc2UsIHN0YXJ0VGltZTowLCBkdXJhdGlvbjowLCBwb3NpdGlvbjpuZXcgcGMuVmVjMywgbWF4RGlzdGFuY2U6MCwgcmVmRGlzdGFuY2U6MCwgcm9sbE9mZkZhY3RvcjowLCBkaXN0YW5jZU1vZGVsOjAsIG9uUGxheTpudWxsLCBvblBhdXNlOm51bGwsIG9uUmVzdW1lOm51bGwsIG9uU3RvcDpudWxsLCBvbkVuZDpudWxsfTtcbiAgdmFyIFNvdW5kU2xvdCA9IGZ1bmN0aW9uKGNvbXBvbmVudCwgbmFtZSwgb3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIHRoaXMuX2NvbXBvbmVudCA9IGNvbXBvbmVudDtcbiAgICB0aGlzLl9hc3NldHMgPSBjb21wb25lbnQuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdGhpcy5fbWFuYWdlciA9IGNvbXBvbmVudC5zeXN0ZW0ubWFuYWdlcjtcbiAgICB0aGlzLl9uYW1lID0gbmFtZSB8fCBcIlVudGl0bGVkXCI7XG4gICAgdGhpcy5fdm9sdW1lID0gb3B0aW9ucy52b2x1bWUgIT09IHVuZGVmaW5lZCA/IHBjLm1hdGguY2xhbXAoTnVtYmVyKG9wdGlvbnMudm9sdW1lKSB8fCAwLCAwLCAxKSA6IDE7XG4gICAgdGhpcy5fcGl0Y2ggPSBvcHRpb25zLnBpdGNoICE9PSB1bmRlZmluZWQgPyBNYXRoLm1heCgwLjAxLCBOdW1iZXIob3B0aW9ucy5waXRjaCkgfHwgMCkgOiAxO1xuICAgIHRoaXMuX2xvb3AgPSAhIShvcHRpb25zLmxvb3AgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubG9vcCA6IGZhbHNlKTtcbiAgICB0aGlzLl9kdXJhdGlvbiA9IG9wdGlvbnMuZHVyYXRpb24gPiAwID8gb3B0aW9ucy5kdXJhdGlvbiA6IG51bGw7XG4gICAgdGhpcy5fc3RhcnRUaW1lID0gTWF0aC5tYXgoMCwgTnVtYmVyKG9wdGlvbnMuc3RhcnRUaW1lKSB8fCAwKTtcbiAgICB0aGlzLl9vdmVybGFwID0gISFvcHRpb25zLm92ZXJsYXA7XG4gICAgdGhpcy5fYXV0b1BsYXkgPSAhIW9wdGlvbnMuYXV0b1BsYXk7XG4gICAgdGhpcy5fZmlyc3ROb2RlID0gbnVsbDtcbiAgICB0aGlzLl9sYXN0Tm9kZSA9IG51bGw7XG4gICAgdGhpcy5fYXNzZXQgPSBvcHRpb25zLmFzc2V0O1xuICAgIGlmICh0aGlzLl9hc3NldCBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICB0aGlzLl9hc3NldCA9IHRoaXMuX2Fzc2V0LmlkO1xuICAgIH1cbiAgICB0aGlzLl9vbkluc3RhbmNlUGxheUhhbmRsZXIgPSB0aGlzLl9vbkluc3RhbmNlUGxheS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX29uSW5zdGFuY2VQYXVzZUhhbmRsZXIgPSB0aGlzLl9vbkluc3RhbmNlUGF1c2UuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9vbkluc3RhbmNlUmVzdW1lSGFuZGxlciA9IHRoaXMuX29uSW5zdGFuY2VSZXN1bWUuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9vbkluc3RhbmNlU3RvcEhhbmRsZXIgPSB0aGlzLl9vbkluc3RhbmNlU3RvcC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX29uSW5zdGFuY2VFbmRIYW5kbGVyID0gdGhpcy5fb25JbnN0YW5jZUVuZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuaW5zdGFuY2VzID0gW107XG4gICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgfTtcbiAgU291bmRTbG90LnByb3RvdHlwZSA9IHtwbGF5OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5vdmVybGFwICYmICh0aGlzLmlzUGxheWluZyB8fCB0aGlzLmlzUGF1c2VkKSkge1xuICAgICAgdGhpcy5zdG9wKCk7XG4gICAgfVxuICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuX2NyZWF0ZUluc3RhbmNlKCk7XG4gICAgdGhpcy5pbnN0YW5jZXMucHVzaChpbnN0YW5jZSk7XG4gICAgaWYgKCF0aGlzLmlzTG9hZGVkKSB7XG4gICAgICB2YXIgb25Mb2FkID0gZnVuY3Rpb24oc291bmQpIHtcbiAgICAgICAgdmFyIHBsYXlXaGVuTG9hZGVkID0gaW5zdGFuY2UuX3BsYXlXaGVuTG9hZGVkO1xuICAgICAgICBpbnN0YW5jZS5zb3VuZCA9IHNvdW5kO1xuICAgICAgICBpZiAocGxheVdoZW5Mb2FkZWQpIHtcbiAgICAgICAgICBpbnN0YW5jZS5wbGF5KCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLm9mZihcImxvYWRcIiwgb25Mb2FkKTtcbiAgICAgIHRoaXMub25jZShcImxvYWRcIiwgb25Mb2FkKTtcbiAgICAgIHRoaXMubG9hZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbnN0YW5jZS5wbGF5KCk7XG4gICAgfVxuICAgIHJldHVybiBpbnN0YW5jZTtcbiAgfSwgcGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBhdXNlZCA9IGZhbHNlO1xuICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlcztcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKGluc3RhbmNlc1tpXS5wYXVzZSgpKSB7XG4gICAgICAgIHBhdXNlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwYXVzZWQ7XG4gIH0sIHJlc3VtZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgcmVzdW1lZCA9IGZhbHNlO1xuICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlcztcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKGluc3RhbmNlc1tpXS5yZXN1bWUoKSkge1xuICAgICAgICByZXN1bWVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VtZWQ7XG4gIH0sIHN0b3A6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHN0b3BwZWQgPSBmYWxzZTtcbiAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5pbnN0YW5jZXM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmIChpbnN0YW5jZXNbaV0uc3RvcCgpKSB7XG4gICAgICAgIHN0b3BwZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBpbnN0YW5jZXMubGVuZ3RoID0gMDtcbiAgICByZXR1cm4gc3RvcHBlZDtcbiAgfSwgbG9hZDpmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuX2hhc0Fzc2V0KCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGFzc2V0ID0gdGhpcy5fYXNzZXRzLmdldCh0aGlzLl9hc3NldCk7XG4gICAgaWYgKCFhc3NldCkge1xuICAgICAgdGhpcy5fYXNzZXRzLm9mZihcImFkZDpcIiArIHRoaXMuX2Fzc2V0LCB0aGlzLl9vbkFzc2V0QWRkLCB0aGlzKTtcbiAgICAgIHRoaXMuX2Fzc2V0cy5vbmNlKFwiYWRkOlwiICsgdGhpcy5fYXNzZXQsIHRoaXMuX29uQXNzZXRBZGQsIHRoaXMpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhc3NldC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMuX29uQXNzZXRSZW1vdmVkLCB0aGlzKTtcbiAgICBpZiAoIWFzc2V0LnJlc291cmNlKSB7XG4gICAgICBhc3NldC5vZmYoXCJsb2FkXCIsIHRoaXMuX29uQXNzZXRMb2FkLCB0aGlzKTtcbiAgICAgIGFzc2V0Lm9uY2UoXCJsb2FkXCIsIHRoaXMuX29uQXNzZXRMb2FkLCB0aGlzKTtcbiAgICAgIHRoaXMuX2Fzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5maXJlKFwibG9hZFwiLCBhc3NldC5yZXNvdXJjZSk7XG4gIH0sIHNldEV4dGVybmFsTm9kZXM6ZnVuY3Rpb24oZmlyc3ROb2RlLCBsYXN0Tm9kZSkge1xuICAgIGlmICghZmlyc3ROb2RlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiVGhlIGZpcnN0Tm9kZSBtdXN0IGhhdmUgYSB2YWxpZCBBdWRpb05vZGVcIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghbGFzdE5vZGUpIHtcbiAgICAgIGxhc3ROb2RlID0gZmlyc3ROb2RlO1xuICAgIH1cbiAgICB0aGlzLl9maXJzdE5vZGUgPSBmaXJzdE5vZGU7XG4gICAgdGhpcy5fbGFzdE5vZGUgPSBsYXN0Tm9kZTtcbiAgICBpZiAoIXRoaXMuX292ZXJsYXApIHtcbiAgICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlcztcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGluc3RhbmNlc1tpXS5zZXRFeHRlcm5hbE5vZGVzKGZpcnN0Tm9kZSwgbGFzdE5vZGUpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgY2xlYXJFeHRlcm5hbE5vZGVzOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX2ZpcnN0Tm9kZSA9IG51bGw7XG4gICAgdGhpcy5fbGFzdE5vZGUgPSBudWxsO1xuICAgIGlmICghdGhpcy5fb3ZlcmxhcCkge1xuICAgICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VzO1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgaW5zdGFuY2VzW2ldLmNsZWFyRXh0ZXJuYWxOb2RlcygpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgZ2V0RXh0ZXJuYWxOb2RlczpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gW3RoaXMuX2ZpcnN0Tm9kZSwgdGhpcy5fbGFzdE5vZGVdO1xuICB9LCBfaGFzQXNzZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Fzc2V0ICE9IG51bGw7XG4gIH0sIF9jcmVhdGVJbnN0YW5jZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zdGFuY2UgPSBudWxsO1xuICAgIHZhciBjb21wb25lbnQgPSB0aGlzLl9jb21wb25lbnQ7XG4gICAgdmFyIHNvdW5kID0gbnVsbDtcbiAgICBpZiAodGhpcy5faGFzQXNzZXQoKSkge1xuICAgICAgdmFyIGFzc2V0ID0gdGhpcy5fYXNzZXRzLmdldCh0aGlzLl9hc3NldCk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgc291bmQgPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGRhdGEgPSBpbnN0YW5jZU9wdGlvbnM7XG4gICAgZGF0YS52b2x1bWUgPSB0aGlzLl92b2x1bWUgKiBjb21wb25lbnQudm9sdW1lO1xuICAgIGRhdGEucGl0Y2ggPSB0aGlzLl9waXRjaCAqIGNvbXBvbmVudC5waXRjaDtcbiAgICBkYXRhLmxvb3AgPSB0aGlzLl9sb29wO1xuICAgIGRhdGEuc3RhcnRUaW1lID0gdGhpcy5fc3RhcnRUaW1lO1xuICAgIGRhdGEuZHVyYXRpb24gPSB0aGlzLl9kdXJhdGlvbjtcbiAgICBkYXRhLm9uUGxheSA9IHRoaXMuX29uSW5zdGFuY2VQbGF5SGFuZGxlcjtcbiAgICBkYXRhLm9uUGF1c2UgPSB0aGlzLl9vbkluc3RhbmNlUGF1c2VIYW5kbGVyO1xuICAgIGRhdGEub25SZXN1bWUgPSB0aGlzLl9vbkluc3RhbmNlUmVzdW1lSGFuZGxlcjtcbiAgICBkYXRhLm9uU3RvcCA9IHRoaXMuX29uSW5zdGFuY2VTdG9wSGFuZGxlcjtcbiAgICBkYXRhLm9uRW5kID0gdGhpcy5fb25JbnN0YW5jZUVuZEhhbmRsZXI7XG4gICAgaWYgKGNvbXBvbmVudC5wb3NpdGlvbmFsKSB7XG4gICAgICBkYXRhLnBvc2l0aW9uLmNvcHkoY29tcG9uZW50LmVudGl0eS5nZXRQb3NpdGlvbigpKTtcbiAgICAgIGRhdGEubWF4RGlzdGFuY2UgPSBjb21wb25lbnQubWF4RGlzdGFuY2U7XG4gICAgICBkYXRhLnJlZkRpc3RhbmNlID0gY29tcG9uZW50LnJlZkRpc3RhbmNlO1xuICAgICAgZGF0YS5yb2xsT2ZmRmFjdG9yID0gY29tcG9uZW50LnJvbGxPZmZGYWN0b3I7XG4gICAgICBkYXRhLmRpc3RhbmNlTW9kZWwgPSBjb21wb25lbnQuZGlzdGFuY2VNb2RlbDtcbiAgICAgIGluc3RhbmNlID0gbmV3IHBjLlNvdW5kSW5zdGFuY2UzZCh0aGlzLl9tYW5hZ2VyLCBzb3VuZCwgZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc3RhbmNlID0gbmV3IHBjLlNvdW5kSW5zdGFuY2UodGhpcy5fbWFuYWdlciwgc291bmQsIGRhdGEpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZmlyc3ROb2RlKSB7XG4gICAgICBpbnN0YW5jZS5zZXRFeHRlcm5hbE5vZGVzKHRoaXMuX2ZpcnN0Tm9kZSwgdGhpcy5fbGFzdE5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH0sIF9vbkluc3RhbmNlUGxheTpmdW5jdGlvbihpbnN0YW5jZSkge1xuICAgIHRoaXMuZmlyZShcInBsYXlcIiwgaW5zdGFuY2UpO1xuICAgIHRoaXMuX2NvbXBvbmVudC5maXJlKFwicGxheVwiLCB0aGlzLCBpbnN0YW5jZSk7XG4gIH0sIF9vbkluc3RhbmNlUGF1c2U6ZnVuY3Rpb24oaW5zdGFuY2UpIHtcbiAgICB0aGlzLmZpcmUoXCJwYXVzZVwiLCBpbnN0YW5jZSk7XG4gICAgdGhpcy5fY29tcG9uZW50LmZpcmUoXCJwYXVzZVwiLCB0aGlzLCBpbnN0YW5jZSk7XG4gIH0sIF9vbkluc3RhbmNlUmVzdW1lOmZ1bmN0aW9uKGluc3RhbmNlKSB7XG4gICAgdGhpcy5maXJlKFwicmVzdW1lXCIsIGluc3RhbmNlKTtcbiAgICB0aGlzLl9jb21wb25lbnQuZmlyZShcInJlc3VtZVwiLCB0aGlzLCBpbnN0YW5jZSk7XG4gIH0sIF9vbkluc3RhbmNlU3RvcDpmdW5jdGlvbihpbnN0YW5jZSkge1xuICAgIHRoaXMuZmlyZShcInN0b3BcIiwgaW5zdGFuY2UpO1xuICAgIHRoaXMuX2NvbXBvbmVudC5maXJlKFwic3RvcFwiLCB0aGlzLCBpbnN0YW5jZSk7XG4gIH0sIF9vbkluc3RhbmNlRW5kOmZ1bmN0aW9uKGluc3RhbmNlKSB7XG4gICAgdmFyIGlkeCA9IHRoaXMuaW5zdGFuY2VzLmluZGV4T2YoaW5zdGFuY2UpO1xuICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICB0aGlzLmluc3RhbmNlcy5zcGxpY2UoaWR4LCAxKTtcbiAgICB9XG4gICAgdGhpcy5maXJlKFwiZW5kXCIsIGluc3RhbmNlKTtcbiAgICB0aGlzLl9jb21wb25lbnQuZmlyZShcImVuZFwiLCB0aGlzLCBpbnN0YW5jZSk7XG4gIH0sIF9vbkFzc2V0QWRkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5sb2FkKCk7XG4gIH0sIF9vbkFzc2V0TG9hZDpmdW5jdGlvbihhc3NldCkge1xuICAgIHRoaXMubG9hZCgpO1xuICB9LCBfb25Bc3NldFJlbW92ZWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBhc3NldC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgIHRoaXMuX2Fzc2V0cy5vZmYoXCJhZGQ6XCIgKyBhc3NldC5pZCwgdGhpcy5fb25Bc3NldEFkZCwgdGhpcyk7XG4gICAgdGhpcy5zdG9wKCk7XG4gIH0sIHVwZGF0ZVBvc2l0aW9uOmZ1bmN0aW9uKHBvc2l0aW9uKSB7XG4gICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICBpbnN0YW5jZXNbaV0ucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICB9XG4gIH19O1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRTbG90LnByb3RvdHlwZSwgXCJuYW1lXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX25hbWU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHZhciBvbGQgPSB0aGlzLl9uYW1lO1xuICAgIHRoaXMuX25hbWUgPSB2YWx1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRTbG90LnByb3RvdHlwZSwgXCJ2b2x1bWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdm9sdW1lO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgb2xkID0gdGhpcy5fdm9sdW1lO1xuICAgIHRoaXMuX3ZvbHVtZSA9IHBjLm1hdGguY2xhbXAoTnVtYmVyKHZhbHVlKSB8fCAwLCAwLCAxKTtcbiAgICBpZiAoIXRoaXMuX292ZXJsYXApIHtcbiAgICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlcztcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGluc3RhbmNlc1tpXS52b2x1bWUgPSB0aGlzLl92b2x1bWUgKiB0aGlzLl9jb21wb25lbnQudm9sdW1lO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRTbG90LnByb3RvdHlwZSwgXCJwaXRjaFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9waXRjaDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIG9sZCA9IHRoaXMuX3BpdGNoO1xuICAgIHRoaXMuX3BpdGNoID0gTWF0aC5tYXgoTnVtYmVyKHZhbHVlKSB8fCAwLCAwLjAxKTtcbiAgICBpZiAoIXRoaXMuX292ZXJsYXApIHtcbiAgICAgIHZhciBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlcztcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIGluc3RhbmNlc1tpXS5waXRjaCA9IHRoaXMucGl0Y2ggKiB0aGlzLl9jb21wb25lbnQucGl0Y2g7XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZFNsb3QucHJvdG90eXBlLCBcImxvb3BcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbG9vcDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIG9sZCA9IHRoaXMuX2xvb3A7XG4gICAgdGhpcy5fbG9vcCA9ICEhdmFsdWU7XG4gICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VzO1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICBpbnN0YW5jZXNbaV0ubG9vcCA9IHRoaXMuX2xvb3A7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZFNsb3QucHJvdG90eXBlLCBcImF1dG9QbGF5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2F1dG9QbGF5O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgb2xkID0gdGhpcy5fYXV0b1BsYXk7XG4gICAgdGhpcy5fYXV0b1BsYXkgPSAhIXZhbHVlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZFNsb3QucHJvdG90eXBlLCBcIm92ZXJsYXBcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fb3ZlcmxhcDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIG9sZCA9IHRoaXMuX292ZXJsYXA7XG4gICAgdGhpcy5fb3ZlcmxhcCA9ICEhdmFsdWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kU2xvdC5wcm90b3R5cGUsIFwic3RhcnRUaW1lXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXJ0VGltZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIG9sZCA9IHRoaXMuX3N0YXJ0VGltZTtcbiAgICB0aGlzLl9zdGFydFRpbWUgPSBNYXRoLm1heCgwLCBOdW1iZXIodmFsdWUpIHx8IDApO1xuICAgIGlmICghdGhpcy5fb3ZlcmxhcCkge1xuICAgICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VzO1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgaW5zdGFuY2VzW2ldLnN0YXJ0VGltZSA9IHRoaXMuX3N0YXJ0VGltZTtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kU2xvdC5wcm90b3R5cGUsIFwiZHVyYXRpb25cIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgYXNzZXREdXJhdGlvbiA9IDA7XG4gICAgaWYgKHRoaXMuX2hhc0Fzc2V0KCkpIHtcbiAgICAgIHZhciBhc3NldCA9IHRoaXMuX2Fzc2V0cy5nZXQodGhpcy5fYXNzZXQpO1xuICAgICAgYXNzZXREdXJhdGlvbiA9IGFzc2V0LnJlc291cmNlID8gYXNzZXQucmVzb3VyY2UuZHVyYXRpb24gOiAwO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZHVyYXRpb24gIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2R1cmF0aW9uICUgKGFzc2V0RHVyYXRpb24gfHwgMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhc3NldER1cmF0aW9uO1xuICAgIH1cbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIG9sZCA9IHRoaXMuX2R1cmF0aW9uO1xuICAgIHRoaXMuX2R1cmF0aW9uID0gTWF0aC5tYXgoMCwgTnVtYmVyKHZhbHVlKSB8fCAwKSB8fCBudWxsO1xuICAgIGlmICghdGhpcy5fb3ZlcmxhcCkge1xuICAgICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuaW5zdGFuY2VzO1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgaW5zdGFuY2VzW2ldLmR1cmF0aW9uID0gdGhpcy5fZHVyYXRpb247XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTb3VuZFNsb3QucHJvdG90eXBlLCBcImFzc2V0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Fzc2V0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgb2xkID0gdGhpcy5fYXNzZXQ7XG4gICAgaWYgKG9sZCkge1xuICAgICAgdGhpcy5fYXNzZXRzLm9mZihcImFkZDpcIiArIG9sZCwgdGhpcy5fb25Bc3NldEFkZCwgdGhpcyk7XG4gICAgICB2YXIgb2xkQXNzZXQgPSB0aGlzLl9hc3NldHMuZ2V0KG9sZCk7XG4gICAgICBpZiAob2xkQXNzZXQpIHtcbiAgICAgICAgb2xkQXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMuX29uQXNzZXRSZW1vdmVkLCB0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fYXNzZXQgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5fYXNzZXQgaW5zdGFuY2VvZiBwYy5Bc3NldCkge1xuICAgICAgdGhpcy5fYXNzZXQgPSB0aGlzLl9hc3NldC5pZDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2hhc0Fzc2V0KCkgJiYgdGhpcy5fY29tcG9uZW50LmVuYWJsZWQgJiYgdGhpcy5fY29tcG9uZW50LmVudGl0eS5lbmFibGVkKSB7XG4gICAgICB0aGlzLmxvYWQoKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kU2xvdC5wcm90b3R5cGUsIFwiaXNMb2FkZWRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5faGFzQXNzZXQoKSkge1xuICAgICAgdmFyIGFzc2V0ID0gdGhpcy5fYXNzZXRzLmdldCh0aGlzLl9hc3NldCk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgcmV0dXJuICEhYXNzZXQucmVzb3VyY2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRTbG90LnByb3RvdHlwZSwgXCJpc1BsYXlpbmdcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5pbnN0YW5jZXM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmIChpbnN0YW5jZXNbaV0uaXNQbGF5aW5nKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kU2xvdC5wcm90b3R5cGUsIFwiaXNQYXVzZWRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5pbnN0YW5jZXM7XG4gICAgdmFyIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7XG4gICAgaWYgKGxlbiA9PT0gMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKCFpbnN0YW5jZXNbaV0uaXNQYXVzZWQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU291bmRTbG90LnByb3RvdHlwZSwgXCJpc1N0b3BwZWRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5pbnN0YW5jZXM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmICghaW5zdGFuY2VzW2ldLmlzU3RvcHBlZCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9fSk7XG4gIHJldHVybiB7U291bmRTbG90OlNvdW5kU2xvdH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNvdW5kQ29tcG9uZW50ID0gZnVuY3Rpb24oc3lzdGVtLCBlbnRpdHkpIHtcbiAgICB0aGlzLm9uKFwic2V0X3Nsb3RzXCIsIHRoaXMub25TZXRTbG90cywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF92b2x1bWVcIiwgdGhpcy5vblNldFZvbHVtZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9waXRjaFwiLCB0aGlzLm9uU2V0UGl0Y2gsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfcmVmRGlzdGFuY2VcIiwgdGhpcy5vblNldFJlZkRpc3RhbmNlLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X21heERpc3RhbmNlXCIsIHRoaXMub25TZXRNYXhEaXN0YW5jZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9yb2xsT2ZmRmFjdG9yXCIsIHRoaXMub25TZXRSb2xsT2ZmRmFjdG9yLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2Rpc3RhbmNlTW9kZWxcIiwgdGhpcy5vblNldERpc3RhbmNlTW9kZWwsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfcG9zaXRpb25hbFwiLCB0aGlzLm9uU2V0UG9zaXRpb25hbCwgdGhpcyk7XG4gIH07XG4gIFNvdW5kQ29tcG9uZW50ID0gcGMuaW5oZXJpdHMoU291bmRDb21wb25lbnQsIHBjLkNvbXBvbmVudCk7XG4gIHBjLmV4dGVuZChTb3VuZENvbXBvbmVudC5wcm90b3R5cGUsIHtvblNldFNsb3RzOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBrZXk7XG4gICAgaWYgKG9sZFZhbHVlKSB7XG4gICAgICBmb3IgKGtleSBpbiBvbGRWYWx1ZSkge1xuICAgICAgICBvbGRWYWx1ZVtrZXldLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIHNsb3RzID0ge307XG4gICAgZm9yIChrZXkgaW4gbmV3VmFsdWUpIHtcbiAgICAgIGlmICghKG5ld1ZhbHVlW2tleV0gaW5zdGFuY2VvZiBwYy5Tb3VuZFNsb3QpKSB7XG4gICAgICAgIGlmIChuZXdWYWx1ZVtrZXldLm5hbWUpIHtcbiAgICAgICAgICBzbG90c1tuZXdWYWx1ZVtrZXldLm5hbWVdID0gbmV3IHBjLlNvdW5kU2xvdCh0aGlzLCBuZXdWYWx1ZVtrZXldLm5hbWUsIG5ld1ZhbHVlW2tleV0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzbG90c1tuZXdWYWx1ZVtrZXldLm5hbWVdID0gbmV3VmFsdWVba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5kYXRhLnNsb3RzID0gc2xvdHM7XG4gICAgaWYgKHRoaXMuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICB0aGlzLm9uRW5hYmxlKCk7XG4gICAgfVxuICB9LCBvblNldFZvbHVtZTpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICB2YXIgc2xvdCA9IHNsb3RzW2tleV07XG4gICAgICBpZiAoIXNsb3Qub3ZlcmxhcCkge1xuICAgICAgICB2YXIgaW5zdGFuY2VzID0gc2xvdC5pbnN0YW5jZXM7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgaW5zdGFuY2VzW2ldLnZvbHVtZSA9IHNsb3Qudm9sdW1lICogbmV3VmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0UGl0Y2g6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIHNsb3RzID0gdGhpcy5kYXRhLnNsb3RzO1xuICAgIGZvciAodmFyIGtleSBpbiBzbG90cykge1xuICAgICAgdmFyIHNsb3QgPSBzbG90c1trZXldO1xuICAgICAgaWYgKCFzbG90Lm92ZXJsYXApIHtcbiAgICAgICAgdmFyIGluc3RhbmNlcyA9IHNsb3QuaW5zdGFuY2VzO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgICAgIGluc3RhbmNlc1tpXS5waXRjaCA9IHNsb3QucGl0Y2ggKiBuZXdWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRSZWZEaXN0YW5jZTpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICB2YXIgc2xvdCA9IHNsb3RzW2tleV07XG4gICAgICBpZiAoIXNsb3Qub3ZlcmxhcCkge1xuICAgICAgICB2YXIgaW5zdGFuY2VzID0gc2xvdC5pbnN0YW5jZXM7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgaW5zdGFuY2VzW2ldLnJlZkRpc3RhbmNlID0gbmV3VmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0TWF4RGlzdGFuY2U6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIHNsb3RzID0gdGhpcy5kYXRhLnNsb3RzO1xuICAgIGZvciAodmFyIGtleSBpbiBzbG90cykge1xuICAgICAgdmFyIHNsb3QgPSBzbG90c1trZXldO1xuICAgICAgaWYgKCFzbG90Lm92ZXJsYXApIHtcbiAgICAgICAgdmFyIGluc3RhbmNlcyA9IHNsb3QuaW5zdGFuY2VzO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgICAgIGluc3RhbmNlc1tpXS5tYXhEaXN0YW5jZSA9IG5ld1ZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldFJvbGxPZmZGYWN0b3I6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIHNsb3RzID0gdGhpcy5kYXRhLnNsb3RzO1xuICAgIGZvciAodmFyIGtleSBpbiBzbG90cykge1xuICAgICAgdmFyIHNsb3QgPSBzbG90c1trZXldO1xuICAgICAgaWYgKCFzbG90Lm92ZXJsYXApIHtcbiAgICAgICAgdmFyIGluc3RhbmNlcyA9IHNsb3QuaW5zdGFuY2VzO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgICAgIGluc3RhbmNlc1tpXS5yb2xsT2ZmRmFjdG9yID0gbmV3VmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0RGlzdGFuY2VNb2RlbDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICB2YXIgc2xvdCA9IHNsb3RzW2tleV07XG4gICAgICBpZiAoIXNsb3Qub3ZlcmxhcCkge1xuICAgICAgICB2YXIgaW5zdGFuY2VzID0gc2xvdC5pbnN0YW5jZXM7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgICAgaW5zdGFuY2VzW2ldLmRpc3RhbmNlTW9kZWwgPSBuZXdWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRQb3NpdGlvbmFsOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBzbG90cyA9IHRoaXMuZGF0YS5zbG90cztcbiAgICBmb3IgKHZhciBrZXkgaW4gc2xvdHMpIHtcbiAgICAgIHZhciBzbG90ID0gc2xvdHNba2V5XTtcbiAgICAgIGlmICghc2xvdC5vdmVybGFwKSB7XG4gICAgICAgIHZhciBpbnN0YW5jZXMgPSBzbG90Lmluc3RhbmNlcztcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgICB2YXIgaXNQbGF5aW5nID0gaW5zdGFuY2VzW2ldLmlzUGxheWluZyB8fCBpbnN0YW5jZXNbaV0uaXNTdXNwZW5kZWQ7XG4gICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5zdGFuY2VzW2ldLmN1cnJlbnRUaW1lO1xuICAgICAgICAgIGlmIChpc1BsYXlpbmcpIHtcbiAgICAgICAgICAgIGluc3RhbmNlc1tpXS5zdG9wKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGluc3RhbmNlc1tpXSA9IHNsb3QuX2NyZWF0ZUluc3RhbmNlKCk7XG4gICAgICAgICAgaWYgKGlzUGxheWluZykge1xuICAgICAgICAgICAgaW5zdGFuY2VzW2ldLnBsYXkoKTtcbiAgICAgICAgICAgIGluc3RhbmNlc1tpXS5jdXJyZW50VGltZSA9IGN1cnJlbnRUaW1lO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25FbmFibGU6ZnVuY3Rpb24oKSB7XG4gICAgU291bmRDb21wb25lbnQuX3N1cGVyLm9uRW5hYmxlLmNhbGwodGhpcyk7XG4gICAgaWYgKHRoaXMuc3lzdGVtLl9pblRvb2xzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBzbG90cyA9IHRoaXMuZGF0YS5zbG90cztcbiAgICB2YXIgcGxheWluZ0JlZm9yZURpc2FibGUgPSB0aGlzLmRhdGEucGxheWluZ0JlZm9yZURpc2FibGU7XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICB2YXIgc2xvdCA9IHNsb3RzW2tleV07XG4gICAgICBpZiAoc2xvdC5hdXRvUGxheSAmJiBzbG90LmlzU3RvcHBlZCkge1xuICAgICAgICBzbG90LnBsYXkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChwbGF5aW5nQmVmb3JlRGlzYWJsZVtrZXldKSB7XG4gICAgICAgICAgc2xvdC5yZXN1bWUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIXNsb3QuaXNMb2FkZWQpIHtcbiAgICAgICAgICAgIHNsb3QubG9hZCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIFNvdW5kQ29tcG9uZW50Ll9zdXBlci5vbkRpc2FibGUuY2FsbCh0aGlzKTtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgdmFyIHBsYXlpbmdCZWZvcmVEaXNhYmxlID0ge307XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICBpZiAoIXNsb3RzW2tleV0ub3ZlcmxhcCkge1xuICAgICAgICBpZiAoc2xvdHNba2V5XS5pc1BsYXlpbmcpIHtcbiAgICAgICAgICBzbG90c1trZXldLnBhdXNlKCk7XG4gICAgICAgICAgcGxheWluZ0JlZm9yZURpc2FibGVba2V5XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5kYXRhLnBsYXlpbmdCZWZvcmVEaXNhYmxlID0gcGxheWluZ0JlZm9yZURpc2FibGU7XG4gIH0sIGFkZFNsb3Q6ZnVuY3Rpb24obmFtZSwgb3B0aW9ucykge1xuICAgIHZhciBzbG90cyA9IHRoaXMuZGF0YS5zbG90cztcbiAgICBpZiAoc2xvdHNbbmFtZV0pIHtcbiAgICAgIGxvZ1dBUk5JTkcoXCJBIHNvdW5kIHNsb3Qgd2l0aCBuYW1lIFwiICsgbmFtZSArIFwiIGFscmVhZHkgZXhpc3RzIG9uIEVudGl0eSBcIiArIHRoaXMuZW50aXR5LmdldFBhdGgoKSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgdmFyIHNsb3QgPSBuZXcgcGMuU291bmRTbG90KHRoaXMsIG5hbWUsIG9wdGlvbnMpO1xuICAgIHNsb3RzW25hbWVdID0gc2xvdDtcbiAgICBpZiAoc2xvdC5hdXRvUGxheSAmJiB0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgc2xvdC5wbGF5KCk7XG4gICAgfVxuICAgIHJldHVybiBzbG90O1xuICB9LCByZW1vdmVTbG90OmZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgaWYgKHNsb3RzW25hbWVdKSB7XG4gICAgICBzbG90c1tuYW1lXS5zdG9wKCk7XG4gICAgICBkZWxldGUgc2xvdHNbbmFtZV07XG4gICAgfVxuICB9LCBzbG90OmZ1bmN0aW9uKG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLnNsb3RzW25hbWVdO1xuICB9LCBwbGF5OmZ1bmN0aW9uKG5hbWUpIHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHZhciBzbG90ID0gdGhpcy5zbG90c1tuYW1lXTtcbiAgICBpZiAoIXNsb3QpIHtcbiAgICAgIGxvZ1dBUk5JTkcoXCJUcnlpbmcgdG8gcGxheSBzb3VuZCBzbG90IHdpdGggbmFtZSBcIiArIG5hbWUgKyBcIiB3aGljaCBkb2VzIG5vdCBleGlzdFwiKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gc2xvdC5wbGF5KCk7XG4gIH0sIHBhdXNlOmZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgc2xvdDtcbiAgICB2YXIgc2xvdHMgPSB0aGlzLmRhdGEuc2xvdHM7XG4gICAgaWYgKG5hbWUpIHtcbiAgICAgIHNsb3QgPSBzbG90c1tuYW1lXTtcbiAgICAgIGlmICghc2xvdCkge1xuICAgICAgICBsb2dXQVJOSU5HKFwiVHJ5aW5nIHRvIHBhdXNlIHNvdW5kIHNsb3Qgd2l0aCBuYW1lIFwiICsgbmFtZSArIFwiIHdoaWNoIGRvZXMgbm90IGV4aXN0XCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzbG90LnBhdXNlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAodmFyIGtleSBpbiBzbG90cykge1xuICAgICAgICBzbG90c1trZXldLnBhdXNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCByZXN1bWU6ZnVuY3Rpb24obmFtZSkge1xuICAgIHZhciBzbG90O1xuICAgIHZhciBzbG90cyA9IHRoaXMuZGF0YS5zbG90cztcbiAgICBpZiAobmFtZSkge1xuICAgICAgc2xvdCA9IHNsb3RzW25hbWVdO1xuICAgICAgaWYgKCFzbG90KSB7XG4gICAgICAgIGxvZ1dBUk5JTkcoXCJUcnlpbmcgdG8gcmVzdW1lIHNvdW5kIHNsb3Qgd2l0aCBuYW1lIFwiICsgbmFtZSArIFwiIHdoaWNoIGRvZXMgbm90IGV4aXN0XCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoc2xvdC5pc1BhdXNlZCkge1xuICAgICAgICBzbG90LnJlc3VtZSgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKHZhciBrZXkgaW4gc2xvdHMpIHtcbiAgICAgICAgc2xvdHNba2V5XS5yZXN1bWUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIHN0b3A6ZnVuY3Rpb24obmFtZSkge1xuICAgIHZhciBzbG90O1xuICAgIHZhciBzbG90cyA9IHRoaXMuZGF0YS5zbG90cztcbiAgICBpZiAobmFtZSkge1xuICAgICAgc2xvdCA9IHNsb3RzW25hbWVdO1xuICAgICAgaWYgKCFzbG90KSB7XG4gICAgICAgIGxvZ1dBUk5JTkcoXCJUcnlpbmcgdG8gc3RvcCBzb3VuZCBzbG90IHdpdGggbmFtZSBcIiArIG5hbWUgKyBcIiB3aGljaCBkb2VzIG5vdCBleGlzdFwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc2xvdC5zdG9wKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAodmFyIGtleSBpbiBzbG90cykge1xuICAgICAgICBzbG90c1trZXldLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtTb3VuZENvbXBvbmVudDpTb3VuZENvbXBvbmVudH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIF9zY2hlbWEgPSBbXCJlbmFibGVkXCIsIFwidm9sdW1lXCIsIFwicGl0Y2hcIiwgXCJwb3NpdGlvbmFsXCIsIFwicmVmRGlzdGFuY2VcIiwgXCJtYXhEaXN0YW5jZVwiLCBcInJvbGxPZmZGYWN0b3JcIiwgXCJkaXN0YW5jZU1vZGVsXCIsIFwic2xvdHNcIl07XG4gIHZhciBTb3VuZENvbXBvbmVudFN5c3RlbSA9IGZ1bmN0aW9uKGFwcCwgbWFuYWdlcikge1xuICAgIHRoaXMuaWQgPSBcInNvdW5kXCI7XG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IFwiQWxsb3dzIGFuIEVudGl0eSB0byBwbGF5IHNvdW5kc1wiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5Tb3VuZENvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuU291bmRDb21wb25lbnREYXRhO1xuICAgIHRoaXMuc2NoZW1hID0gX3NjaGVtYTtcbiAgICB0aGlzLm1hbmFnZXIgPSBtYW5hZ2VyO1xuICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vbihcInVwZGF0ZVwiLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwiYmVmb3JlcmVtb3ZlXCIsIHRoaXMub25CZWZvcmVSZW1vdmUsIHRoaXMpO1xuICB9O1xuICBTb3VuZENvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKFNvdW5kQ29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLlNvdW5kQ29tcG9uZW50LnByb3RvdHlwZSwgX3NjaGVtYSk7XG4gIHBjLmV4dGVuZChTb3VuZENvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpIHtcbiAgICBwcm9wZXJ0aWVzID0gW1widm9sdW1lXCIsIFwicGl0Y2hcIiwgXCJwb3NpdGlvbmFsXCIsIFwicmVmRGlzdGFuY2VcIiwgXCJtYXhEaXN0YW5jZVwiLCBcInJvbGxPZmZGYWN0b3JcIiwgXCJkaXN0YW5jZU1vZGVsXCIsIFwic2xvdHNcIiwgXCJlbmFibGVkXCJdO1xuICAgIFNvdW5kQ29tcG9uZW50U3lzdGVtLl9zdXBlci5pbml0aWFsaXplQ29tcG9uZW50RGF0YS5jYWxsKHRoaXMsIGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcyk7XG4gIH0sIGNsb25lQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY2xvbmUpIHtcbiAgICB2YXIga2V5O1xuICAgIHZhciBvbGREYXRhID0gZW50aXR5LnNvdW5kLmRhdGE7XG4gICAgdmFyIG5ld0RhdGEgPSB7fTtcbiAgICBmb3IgKGtleSBpbiBvbGREYXRhKSB7XG4gICAgICBpZiAob2xkRGF0YS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIG5ld0RhdGFba2V5XSA9IG9sZERhdGFba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgbmV3RGF0YS5zbG90cyA9IHt9O1xuICAgIGZvciAoa2V5IGluIG9sZERhdGEuc2xvdHMpIHtcbiAgICAgIHZhciBvbGRTbG90ID0gb2xkRGF0YS5zbG90c1trZXldO1xuICAgICAgaWYgKG9sZFNsb3QgaW5zdGFuY2VvZiBwYy5Tb3VuZFNsb3QpIHtcbiAgICAgICAgbmV3RGF0YS5zbG90c1trZXldID0ge25hbWU6b2xkU2xvdC5uYW1lLCB2b2x1bWU6b2xkU2xvdC52b2x1bWUsIHBpdGNoOm9sZFNsb3QucGl0Y2gsIGxvb3A6b2xkU2xvdC5sb29wLCBkdXJhdGlvbjpvbGRTbG90LmR1cmF0aW9uLCBzdGFydFRpbWU6b2xkU2xvdC5zdGFydFRpbWUsIG92ZXJsYXA6b2xkU2xvdC5vdmVybGFwLCBhdXRvUGxheTpvbGRTbG90LmF1dG9QbGF5LCBhc3NldDpvbGRTbG90LmFzc2V0fTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ld0RhdGEuc2xvdHNba2V5XSA9IG9sZFNsb3Q7XG4gICAgICB9XG4gICAgfVxuICAgIG5ld0RhdGEucGxheWluZ0JlZm9yZURpc2FibGUgPSB7fTtcbiAgICByZXR1cm4gdGhpcy5hZGRDb21wb25lbnQoY2xvbmUsIG5ld0RhdGEpO1xuICB9LCBvblVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIHZhciBzdG9yZSA9IHRoaXMuc3RvcmU7XG4gICAgZm9yICh2YXIgaWQgaW4gc3RvcmUpIHtcbiAgICAgIGlmIChzdG9yZS5oYXNPd25Qcm9wZXJ0eShpZCkpIHtcbiAgICAgICAgdmFyIGl0ZW0gPSBzdG9yZVtpZF07XG4gICAgICAgIHZhciBlbnRpdHkgPSBpdGVtLmVudGl0eTtcbiAgICAgICAgdmFyIGNvbXBvbmVudERhdGEgPSBpdGVtLmRhdGE7XG4gICAgICAgIGlmIChjb21wb25lbnREYXRhLmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQgJiYgY29tcG9uZW50RGF0YS5wb3NpdGlvbmFsKSB7XG4gICAgICAgICAgdmFyIHBvc2l0aW9uID0gZW50aXR5LmdldFBvc2l0aW9uKCk7XG4gICAgICAgICAgdmFyIHNsb3RzID0gY29tcG9uZW50RGF0YS5zbG90cztcbiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc2xvdHMpIHtcbiAgICAgICAgICAgIHNsb3RzW2tleV0udXBkYXRlUG9zaXRpb24ocG9zaXRpb24pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25CZWZvcmVSZW1vdmU6ZnVuY3Rpb24oZW50aXR5LCBjb21wb25lbnQpIHtcbiAgICB2YXIgc2xvdHMgPSBjb21wb25lbnQuc2xvdHM7XG4gICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7XG4gICAgICBpZiAoIXNsb3RzW2tleV0ub3ZlcmxhcCkge1xuICAgICAgICBzbG90c1trZXldLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwgXCJ2b2x1bWVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5tYW5hZ2VyLnZvbHVtZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZvbHVtZSkge1xuICAgIHRoaXMubWFuYWdlci52b2x1bWUgPSB2b2x1bWU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNvdW5kQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwgXCJjb250ZXh0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCFwYy5Tb3VuZE1hbmFnZXIuaGFzQXVkaW9Db250ZXh0KCkpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IEF1ZGlvIGNvbnRleHQgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGJyb3dzZXJcIik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubWFuYWdlci5jb250ZXh0O1xuICB9fSk7XG4gIHJldHVybiB7U291bmRDb21wb25lbnRTeXN0ZW06U291bmRDb21wb25lbnRTeXN0ZW19O1xufSgpKTtcbnBjLlNvdW5kQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uIFNvdW5kQ29tcG9uZW50RGF0YSgpIHtcbiAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgdGhpcy52b2x1bWUgPSAxO1xuICB0aGlzLnBpdGNoID0gMTtcbiAgdGhpcy5wb3NpdGlvbmFsID0gdHJ1ZTtcbiAgdGhpcy5yZWZEaXN0YW5jZSA9IDE7XG4gIHRoaXMubWF4RGlzdGFuY2UgPSAxMDAwMDtcbiAgdGhpcy5yb2xsT2ZmRmFjdG9yID0gMTtcbiAgdGhpcy5kaXN0YW5jZU1vZGVsID0gcGMuRElTVEFOQ0VfTElORUFSO1xuICB0aGlzLnNsb3RzID0ge307XG4gIHRoaXMucGxheWluZ0JlZm9yZURpc2FibGUgPSB7fTtcbn07XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQXVkaW9Tb3VyY2VDb21wb25lbnQgPSBmdW5jdGlvbihzeXN0ZW0sIGVudGl0eSkge1xuICAgIHRoaXMub24oXCJzZXRfYXNzZXRzXCIsIHRoaXMub25TZXRBc3NldHMsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfbG9vcFwiLCB0aGlzLm9uU2V0TG9vcCwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF92b2x1bWVcIiwgdGhpcy5vblNldFZvbHVtZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9waXRjaFwiLCB0aGlzLm9uU2V0UGl0Y2gsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfbWluRGlzdGFuY2VcIiwgdGhpcy5vblNldE1pbkRpc3RhbmNlLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X21heERpc3RhbmNlXCIsIHRoaXMub25TZXRNYXhEaXN0YW5jZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9yb2xsT2ZmRmFjdG9yXCIsIHRoaXMub25TZXRSb2xsT2ZmRmFjdG9yLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2Rpc3RhbmNlTW9kZWxcIiwgdGhpcy5vblNldERpc3RhbmNlTW9kZWwsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfM2RcIiwgdGhpcy5vblNldDNkLCB0aGlzKTtcbiAgfTtcbiAgQXVkaW9Tb3VyY2VDb21wb25lbnQgPSBwYy5pbmhlcml0cyhBdWRpb1NvdXJjZUNvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKEF1ZGlvU291cmNlQ29tcG9uZW50LnByb3RvdHlwZSwge3BsYXk6ZnVuY3Rpb24obmFtZSkge1xuICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICF0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLmNoYW5uZWwpIHtcbiAgICAgIHRoaXMuc3RvcCgpO1xuICAgIH1cbiAgICB2YXIgY2hhbm5lbDtcbiAgICB2YXIgY29tcG9uZW50RGF0YSA9IHRoaXMuZGF0YTtcbiAgICBpZiAoY29tcG9uZW50RGF0YS5zb3VyY2VzW25hbWVdKSB7XG4gICAgICBpZiAoIWNvbXBvbmVudERhdGFbXCIzZFwiXSkge1xuICAgICAgICBjaGFubmVsID0gdGhpcy5zeXN0ZW0ubWFuYWdlci5wbGF5U291bmQoY29tcG9uZW50RGF0YS5zb3VyY2VzW25hbWVdLCBjb21wb25lbnREYXRhKTtcbiAgICAgICAgY29tcG9uZW50RGF0YS5jdXJyZW50U291cmNlID0gbmFtZTtcbiAgICAgICAgY29tcG9uZW50RGF0YS5jaGFubmVsID0gY2hhbm5lbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBwb3MgPSB0aGlzLmVudGl0eS5nZXRQb3NpdGlvbigpO1xuICAgICAgICBjaGFubmVsID0gdGhpcy5zeXN0ZW0ubWFuYWdlci5wbGF5U291bmQzZChjb21wb25lbnREYXRhLnNvdXJjZXNbbmFtZV0sIHBvcywgY29tcG9uZW50RGF0YSk7XG4gICAgICAgIGNvbXBvbmVudERhdGEuY3VycmVudFNvdXJjZSA9IG5hbWU7XG4gICAgICAgIGNvbXBvbmVudERhdGEuY2hhbm5lbCA9IGNoYW5uZWw7XG4gICAgICB9XG4gICAgfVxuICB9LCBwYXVzZTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICB0aGlzLmNoYW5uZWwucGF1c2UoKTtcbiAgICB9XG4gIH0sIHVucGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuY2hhbm5lbCAmJiB0aGlzLmNoYW5uZWwucGF1c2VkKSB7XG4gICAgICB0aGlzLmNoYW5uZWwudW5wYXVzZSgpO1xuICAgIH1cbiAgfSwgc3RvcDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICB0aGlzLmNoYW5uZWwuc3RvcCgpO1xuICAgICAgdGhpcy5jaGFubmVsID0gbnVsbDtcbiAgICB9XG4gIH0sIG9uU2V0QXNzZXRzOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBjb21wb25lbnREYXRhID0gdGhpcy5kYXRhO1xuICAgIHZhciBuZXdBc3NldHMgPSBbXTtcbiAgICB2YXIgaSwgbGVuID0gbmV3VmFsdWUubGVuZ3RoO1xuICAgIGlmIChvbGRWYWx1ZSAmJiBvbGRWYWx1ZS5sZW5ndGgpIHtcbiAgICAgIGZvciAoaSA9IDA7aSA8IG9sZFZhbHVlLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYgKG9sZFZhbHVlW2ldKSB7XG4gICAgICAgICAgdmFyIGFzc2V0ID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQob2xkVmFsdWVbaV0pO1xuICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgYXNzZXQub2ZmKFwiY2hhbmdlXCIsIHRoaXMub25Bc3NldENoYW5nZWQsIHRoaXMpO1xuICAgICAgICAgICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFNvdXJjZSA9PT0gYXNzZXQubmFtZSkge1xuICAgICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGxlbikge1xuICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICBpZiAob2xkVmFsdWUuaW5kZXhPZihuZXdWYWx1ZVtpXSkgPCAwKSB7XG4gICAgICAgICAgaWYgKG5ld1ZhbHVlW2ldIGluc3RhbmNlb2YgcGMuQXNzZXQpIHtcbiAgICAgICAgICAgIG5ld0Fzc2V0cy5wdXNoKG5ld1ZhbHVlW2ldLmlkKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV3QXNzZXRzLnB1c2gobmV3VmFsdWVbaV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuc3lzdGVtLl9pblRvb2xzICYmIG5ld0Fzc2V0cy5sZW5ndGgpIHtcbiAgICAgIHRoaXMubG9hZEF1ZGlvU291cmNlQXNzZXRzKG5ld0Fzc2V0cyk7XG4gICAgfVxuICB9LCBvbkFzc2V0Q2hhbmdlZDpmdW5jdGlvbihhc3NldCwgYXR0cmlidXRlLCBuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICBpZiAoYXR0cmlidXRlID09PSBcInJlc291cmNlXCIpIHtcbiAgICAgIHZhciBzb3VyY2VzID0gdGhpcy5kYXRhLnNvdXJjZXM7XG4gICAgICBpZiAoc291cmNlcykge1xuICAgICAgICB0aGlzLmRhdGEuc291cmNlc1thc3NldC5uYW1lXSA9IG5ld1ZhbHVlO1xuICAgICAgICBpZiAodGhpcy5kYXRhLmN1cnJlbnRTb3VyY2UgPT09IGFzc2V0Lm5hbWUpIHtcbiAgICAgICAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGFubmVsLnBhdXNlZCkge1xuICAgICAgICAgICAgICB0aGlzLnBsYXkoYXNzZXQubmFtZSk7XG4gICAgICAgICAgICAgIHRoaXMucGF1c2UoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMucGxheShhc3NldC5uYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uQXNzZXRSZW1vdmVkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgIGlmICh0aGlzLmRhdGEuc291cmNlc1thc3NldC5uYW1lXSkge1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YS5zb3VyY2VzW2Fzc2V0Lm5hbWVdO1xuICAgICAgaWYgKHRoaXMuZGF0YS5jdXJyZW50U291cmNlID09PSBhc3NldC5uYW1lKSB7XG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICB0aGlzLmRhdGEuY3VycmVudFNvdXJjZSA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldExvb3A6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICE9IG5ld1ZhbHVlKSB7XG4gICAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICAgIHRoaXMuY2hhbm5lbC5zZXRMb29wKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0Vm9sdW1lOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmIChvbGRWYWx1ZSAhPSBuZXdWYWx1ZSkge1xuICAgICAgaWYgKHRoaXMuY2hhbm5lbCkge1xuICAgICAgICB0aGlzLmNoYW5uZWwuc2V0Vm9sdW1lKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0UGl0Y2g6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICE9IG5ld1ZhbHVlKSB7XG4gICAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICAgIHRoaXMuY2hhbm5lbC5zZXRQaXRjaChuZXdWYWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldE1heERpc3RhbmNlOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmIChvbGRWYWx1ZSAhPSBuZXdWYWx1ZSkge1xuICAgICAgaWYgKHRoaXMuY2hhbm5lbCBpbnN0YW5jZW9mIHBjLkNoYW5uZWwzZCkge1xuICAgICAgICB0aGlzLmNoYW5uZWwuc2V0TWF4RGlzdGFuY2UobmV3VmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXRNaW5EaXN0YW5jZTpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAob2xkVmFsdWUgIT0gbmV3VmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLmNoYW5uZWwgaW5zdGFuY2VvZiBwYy5DaGFubmVsM2QpIHtcbiAgICAgICAgdGhpcy5jaGFubmVsLnNldE1pbkRpc3RhbmNlKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0Um9sbE9mZkZhY3RvcjpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAob2xkVmFsdWUgIT0gbmV3VmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLmNoYW5uZWwgaW5zdGFuY2VvZiBwYy5DaGFubmVsM2QpIHtcbiAgICAgICAgdGhpcy5jaGFubmVsLnNldFJvbGxPZmZGYWN0b3IobmV3VmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXREaXN0YW5jZU1vZGVsOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLmNoYW5uZWwgaW5zdGFuY2VvZiBwYy5DaGFubmVsM2QpIHtcbiAgICAgICAgdGhpcy5jaGFubmVsLnNldERpc3RhbmNlTW9kZWwobmV3VmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgb25TZXQzZDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7XG4gICAgICBpZiAodGhpcy5zeXN0ZW0uaW5pdGlhbGl6ZWQgJiYgdGhpcy5jdXJyZW50U291cmNlKSB7XG4gICAgICAgIHZhciBwYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICAgICAgcGF1c2VkID0gdGhpcy5jaGFubmVsLnBhdXNlZDtcbiAgICAgICAgICBzdXNwZW5kZWQgPSB0aGlzLmNoYW5uZWwuc3VzcGVuZGVkO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGxheSh0aGlzLmN1cnJlbnRTb3VyY2UpO1xuICAgICAgICBpZiAodGhpcy5jaGFubmVsKSB7XG4gICAgICAgICAgdGhpcy5jaGFubmVsLnBhdXNlZCA9IHBhdXNlZDtcbiAgICAgICAgICB0aGlzLmNoYW5uZWwuc3VzcGVuZGVkID0gc3VzcGVuZGVkO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBBdWRpb1NvdXJjZUNvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5kYXRhLmFzc2V0cztcbiAgICBpZiAoYXNzZXRzKSB7XG4gICAgICB2YXIgcmVnaXN0cnkgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFzc2V0cy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgdmFyIGFzc2V0ID0gYXNzZXRzW2ldO1xuICAgICAgICBpZiAoIShhc3NldCBpbnN0YW5jZW9mIHBjLkFzc2V0KSkge1xuICAgICAgICAgIGFzc2V0ID0gcmVnaXN0cnkuZ2V0KGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXNzZXQgJiYgIWFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgICAgcmVnaXN0cnkubG9hZChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuc3lzdGVtLmluaXRpYWxpemVkKSB7XG4gICAgICBpZiAodGhpcy5kYXRhLmFjdGl2YXRlICYmICF0aGlzLmNoYW5uZWwpIHtcbiAgICAgICAgdGhpcy5wbGF5KHRoaXMuY3VycmVudFNvdXJjZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnVucGF1c2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uRGlzYWJsZTpmdW5jdGlvbigpIHtcbiAgICBBdWRpb1NvdXJjZUNvbXBvbmVudC5fc3VwZXIub25EaXNhYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy5wYXVzZSgpO1xuICB9LCBsb2FkQXVkaW9Tb3VyY2VBc3NldHM6ZnVuY3Rpb24oaWRzKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBhc3NldHMgPSBpZHMubWFwKGZ1bmN0aW9uKGlkKSB7XG4gICAgICByZXR1cm4gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5nZXQoaWQpO1xuICAgIH0sIHRoaXMpO1xuICAgIHZhciBzb3VyY2VzID0ge307XG4gICAgdmFyIGN1cnJlbnRTb3VyY2UgPSBudWxsO1xuICAgIHZhciBjb3VudCA9IGFzc2V0cy5sZW5ndGg7XG4gICAgdmFyIF9lcnJvciA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgIGNvdW50LS07XG4gICAgfTtcbiAgICB2YXIgX2RvbmUgPSBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuZGF0YS5zb3VyY2VzID0gc291cmNlcztcbiAgICAgIHRoaXMuZGF0YS5jdXJyZW50U291cmNlID0gY3VycmVudFNvdXJjZTtcbiAgICAgIGlmICh0aGlzLmVuYWJsZWQgJiYgdGhpcy5hY3RpdmF0ZSAmJiBjdXJyZW50U291cmNlKSB7XG4gICAgICAgIHRoaXMub25FbmFibGUoKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcyk7XG4gICAgYXNzZXRzLmZvckVhY2goZnVuY3Rpb24oYXNzZXQsIGluZGV4KSB7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgY3VycmVudFNvdXJjZSA9IGN1cnJlbnRTb3VyY2UgfHwgYXNzZXQubmFtZTtcbiAgICAgICAgYXNzZXQub2ZmKFwiY2hhbmdlXCIsIHRoaXMub25Bc3NldENoYW5nZWQsIHRoaXMpO1xuICAgICAgICBhc3NldC5vbihcImNoYW5nZVwiLCB0aGlzLm9uQXNzZXRDaGFuZ2VkLCB0aGlzKTtcbiAgICAgICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgICAgICBhc3NldC5vbihcInJlbW92ZVwiLCB0aGlzLm9uQXNzZXRSZW1vdmVkLCB0aGlzKTtcbiAgICAgICAgYXNzZXQub2ZmKFwiZXJyb3JcIiwgX2Vycm9yLCB0aGlzKTtcbiAgICAgICAgYXNzZXQub24oXCJlcnJvclwiLCBfZXJyb3IsIHRoaXMpO1xuICAgICAgICBhc3NldC5yZWFkeShmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgIHNvdXJjZXNbYXNzZXQubmFtZV0gPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICBjb3VudC0tO1xuICAgICAgICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgX2RvbmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIWFzc2V0LnJlc291cmNlICYmIHNlbGYuZW5hYmxlZCAmJiBzZWxmLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY291bnQtLTtcbiAgICAgICAgaWYgKGNvdW50ID09PSAwKSB7XG4gICAgICAgICAgX2RvbmUoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzLm9uKFwiYWRkOlwiICsgaWRzW2luZGV4XSwgZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICBhc3NldC5yZWFkeShmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgc2VsZi5kYXRhLnNvdXJjZXNbYXNzZXQubmFtZV0gPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAoIWFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgICAgICBzZWxmLnN5c3RlbS5hcHAuYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSwgdGhpcyk7XG4gIH19KTtcbiAgcmV0dXJuIHtBdWRpb1NvdXJjZUNvbXBvbmVudDpBdWRpb1NvdXJjZUNvbXBvbmVudH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIF9zY2hlbWEgPSBbXCJlbmFibGVkXCIsIFwiYXNzZXRzXCIsIFwidm9sdW1lXCIsIFwicGl0Y2hcIiwgXCJsb29wXCIsIFwiYWN0aXZhdGVcIiwgXCIzZFwiLCBcIm1pbkRpc3RhbmNlXCIsIFwibWF4RGlzdGFuY2VcIiwgXCJyb2xsT2ZmRmFjdG9yXCIsIFwiZGlzdGFuY2VNb2RlbFwiLCBcInNvdXJjZXNcIiwgXCJjdXJyZW50U291cmNlXCIsIFwiY2hhbm5lbFwiXTtcbiAgdmFyIEF1ZGlvU291cmNlQ29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24oYXBwLCBtYW5hZ2VyKSB7XG4gICAgdGhpcy5pZCA9IFwiYXVkaW9zb3VyY2VcIjtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gXCJTcGVjaWZpZXMgYXVkaW8gYXNzZXRzIHRoYXQgY2FuIGJlIHBsYXllZCBhdCB0aGUgcG9zaXRpb24gb2YgdGhlIEVudGl0eS5cIjtcbiAgICBhcHAuc3lzdGVtcy5hZGQodGhpcy5pZCwgdGhpcyk7XG4gICAgdGhpcy5Db21wb25lbnRUeXBlID0gcGMuQXVkaW9Tb3VyY2VDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLkF1ZGlvU291cmNlQ29tcG9uZW50RGF0YTtcbiAgICB0aGlzLnNjaGVtYSA9IF9zY2hlbWE7XG4gICAgdGhpcy5tYW5hZ2VyID0gbWFuYWdlcjtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKFwiaW5pdGlhbGl6ZVwiLCB0aGlzLm9uSW5pdGlhbGl6ZSwgdGhpcyk7XG4gICAgcGMuQ29tcG9uZW50U3lzdGVtLm9uKFwidXBkYXRlXCIsIHRoaXMub25VcGRhdGUsIHRoaXMpO1xuICAgIHRoaXMub24oXCJyZW1vdmVcIiwgdGhpcy5vblJlbW92ZSwgdGhpcyk7XG4gIH07XG4gIEF1ZGlvU291cmNlQ29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoQXVkaW9Tb3VyY2VDb21wb25lbnRTeXN0ZW0sIHBjLkNvbXBvbmVudFN5c3RlbSk7XG4gIHBjLkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMocGMuQXVkaW9Tb3VyY2VDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKEF1ZGlvU291cmNlQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwge2luaXRpYWxpemVDb21wb25lbnREYXRhOmZ1bmN0aW9uKGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcykge1xuICAgIHByb3BlcnRpZXMgPSBbXCJhY3RpdmF0ZVwiLCBcInZvbHVtZVwiLCBcInBpdGNoXCIsIFwibG9vcFwiLCBcIjNkXCIsIFwibWluRGlzdGFuY2VcIiwgXCJtYXhEaXN0YW5jZVwiLCBcInJvbGxPZmZGYWN0b3JcIiwgXCJkaXN0YW5jZU1vZGVsXCIsIFwiZW5hYmxlZFwiLCBcImFzc2V0c1wiXTtcbiAgICBBdWRpb1NvdXJjZUNvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICAgIGNvbXBvbmVudC5wYXVzZWQgPSAhKGNvbXBvbmVudC5lbmFibGVkICYmIGNvbXBvbmVudC5hY3RpdmF0ZSk7XG4gIH0sIG9uSW5pdGlhbGl6ZTpmdW5jdGlvbihyb290KSB7XG4gICAgaWYgKHJvb3QuYXVkaW9zb3VyY2UgJiYgcm9vdC5lbmFibGVkICYmIHJvb3QuYXVkaW9zb3VyY2UuZW5hYmxlZCAmJiByb290LmF1ZGlvc291cmNlLmFjdGl2YXRlKSB7XG4gICAgICByb290LmF1ZGlvc291cmNlLnBsYXkocm9vdC5hdWRpb3NvdXJjZS5jdXJyZW50U291cmNlKTtcbiAgICB9XG4gICAgdmFyIGNoaWxkcmVuID0gcm9vdC5fY2hpbGRyZW47XG4gICAgdmFyIGksIGxlbiA9IGNoaWxkcmVuLmxlbmd0aDtcbiAgICBmb3IgKGkgPSAwO2kgPCBsZW47aSsrKSB7XG4gICAgICBpZiAoY2hpbGRyZW5baV0gaW5zdGFuY2VvZiBwYy5FbnRpdHkpIHtcbiAgICAgICAgdGhpcy5vbkluaXRpYWxpemUoY2hpbGRyZW5baV0pO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfSwgb25VcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB2YXIgY29tcG9uZW50cyA9IHRoaXMuc3RvcmU7XG4gICAgZm9yICh2YXIgaWQgaW4gY29tcG9uZW50cykge1xuICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgIHZhciBjb21wb25lbnQgPSBjb21wb25lbnRzW2lkXTtcbiAgICAgICAgdmFyIGVudGl0eSA9IGNvbXBvbmVudC5lbnRpdHk7XG4gICAgICAgIHZhciBjb21wb25lbnREYXRhID0gY29tcG9uZW50LmRhdGE7XG4gICAgICAgIGlmIChjb21wb25lbnREYXRhLmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQgJiYgY29tcG9uZW50RGF0YS5jaGFubmVsIGluc3RhbmNlb2YgcGMuQ2hhbm5lbDNkKSB7XG4gICAgICAgICAgdmFyIHBvcyA9IGVudGl0eS5nZXRQb3NpdGlvbigpO1xuICAgICAgICAgIGNvbXBvbmVudERhdGEuY2hhbm5lbC5zZXRQb3NpdGlvbihwb3MpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBvblJlbW92ZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICBpZiAoZGF0YS5jaGFubmVsKSB7XG4gICAgICBkYXRhLmNoYW5uZWwuc3RvcCgpO1xuICAgICAgZGF0YS5jaGFubmVsID0gbnVsbDtcbiAgICB9XG4gIH0sIHNldFZvbHVtZTpmdW5jdGlvbih2b2x1bWUpIHtcbiAgICB0aGlzLm1hbmFnZXIuc2V0Vm9sdW1lKHZvbHVtZSk7XG4gIH19KTtcbiAgcmV0dXJuIHtBdWRpb1NvdXJjZUNvbXBvbmVudFN5c3RlbTpBdWRpb1NvdXJjZUNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuQXVkaW9Tb3VyY2VDb21wb25lbnREYXRhID0gZnVuY3Rpb24gQXVkaW9Tb3VyY2VDb21wb25lbnREYXRhKCkge1xuICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICB0aGlzLmFzc2V0cyA9IFtdO1xuICB0aGlzLmFjdGl2YXRlID0gdHJ1ZTtcbiAgdGhpcy52b2x1bWUgPSAxO1xuICB0aGlzLnBpdGNoID0gMTtcbiAgdGhpcy5sb29wID0gZmFsc2U7XG4gIHRoaXNbXCIzZFwiXSA9IHRydWU7XG4gIHRoaXMubWluRGlzdGFuY2UgPSAxO1xuICB0aGlzLm1heERpc3RhbmNlID0gMTAwMDA7XG4gIHRoaXMucm9sbE9mZkZhY3RvciA9IDE7XG4gIHRoaXMuZGlzdGFuY2VNb2RlbCA9IHBjLkRJU1RBTkNFX0lOVkVSU0U7XG4gIHRoaXMucGF1c2VkID0gdHJ1ZTtcbiAgdGhpcy5zb3VyY2VzID0ge307XG4gIHRoaXMuY3VycmVudFNvdXJjZSA9IG51bGw7XG4gIHRoaXMuY2hhbm5lbCA9IG51bGw7XG59O1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEF1ZGlvTGlzdGVuZXJDb21wb25lbnQgPSBmdW5jdGlvbihzeXN0ZW0sIGVudGl0eSkge1xuICB9O1xuICBBdWRpb0xpc3RlbmVyQ29tcG9uZW50ID0gcGMuaW5oZXJpdHMoQXVkaW9MaXN0ZW5lckNvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKEF1ZGlvTGlzdGVuZXJDb21wb25lbnQucHJvdG90eXBlLCB7c2V0Q3VycmVudExpc3RlbmVyOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuYXVkaW9saXN0ZW5lciAmJiB0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICB0aGlzLnN5c3RlbS5jdXJyZW50ID0gdGhpcy5lbnRpdHk7XG4gICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLnN5c3RlbS5jdXJyZW50LmdldFBvc2l0aW9uKCk7XG4gICAgICB0aGlzLnN5c3RlbS5tYW5hZ2VyLmxpc3RlbmVyLnNldFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICB9XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIEF1ZGlvTGlzdGVuZXJDb21wb25lbnQuX3N1cGVyLm9uRW5hYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy5zZXRDdXJyZW50TGlzdGVuZXIoKTtcbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIEF1ZGlvTGlzdGVuZXJDb21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIGlmICh0aGlzLnN5c3RlbS5jdXJyZW50ID09PSB0aGlzLmVudGl0eSkge1xuICAgICAgdGhpcy5zeXN0ZW0uY3VycmVudCA9IG51bGw7XG4gICAgfVxuICB9fSk7XG4gIHJldHVybiB7QXVkaW9MaXN0ZW5lckNvbXBvbmVudDpBdWRpb0xpc3RlbmVyQ29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3NjaGVtYSA9IFtcImVuYWJsZWRcIl07XG4gIHZhciBBdWRpb0xpc3RlbmVyQ29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24oYXBwLCBtYW5hZ2VyKSB7XG4gICAgdGhpcy5pZCA9IFwiYXVkaW9saXN0ZW5lclwiO1xuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBcIlNwZWNpZmllcyB0aGUgbG9jYXRpb24gb2YgdGhlIGxpc3RlbmVyIGZvciAzRCBhdWRpbyBwbGF5YmFjay5cIjtcbiAgICBhcHAuc3lzdGVtcy5hZGQodGhpcy5pZCwgdGhpcyk7XG4gICAgdGhpcy5Db21wb25lbnRUeXBlID0gcGMuQXVkaW9MaXN0ZW5lckNvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuQXVkaW9MaXN0ZW5lckNvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMubWFuYWdlciA9IG1hbmFnZXI7XG4gICAgdGhpcy5jdXJyZW50ID0gbnVsbDtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJ1cGRhdGVcIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gIH07XG4gIEF1ZGlvTGlzdGVuZXJDb21wb25lbnRTeXN0ZW0gPSBwYy5pbmhlcml0cyhBdWRpb0xpc3RlbmVyQ29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLkF1ZGlvTGlzdGVuZXJDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKEF1ZGlvTGlzdGVuZXJDb21wb25lbnRTeXN0ZW0ucHJvdG90eXBlLCB7aW5pdGlhbGl6ZUNvbXBvbmVudERhdGE6ZnVuY3Rpb24oY29tcG9uZW50LCBkYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcyA9IFtcImVuYWJsZWRcIl07XG4gICAgQXVkaW9MaXN0ZW5lckNvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCBvblVwZGF0ZTpmdW5jdGlvbihkdCkge1xuICAgIGlmICh0aGlzLmN1cnJlbnQpIHtcbiAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuY3VycmVudC5nZXRQb3NpdGlvbigpO1xuICAgICAgdGhpcy5tYW5hZ2VyLmxpc3RlbmVyLnNldFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICAgIHZhciB3dG0gPSB0aGlzLmN1cnJlbnQuZ2V0V29ybGRUcmFuc2Zvcm0oKTtcbiAgICAgIHRoaXMubWFuYWdlci5saXN0ZW5lci5zZXRPcmllbnRhdGlvbih3dG0pO1xuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge0F1ZGlvTGlzdGVuZXJDb21wb25lbnRTeXN0ZW06QXVkaW9MaXN0ZW5lckNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEF1ZGlvTGlzdGVuZXJDb21wb25lbnREYXRhID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgfTtcbiAgQXVkaW9MaXN0ZW5lckNvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhBdWRpb0xpc3RlbmVyQ29tcG9uZW50RGF0YSwgcGMuQ29tcG9uZW50RGF0YSk7XG4gIHJldHVybiB7QXVkaW9MaXN0ZW5lckNvbXBvbmVudERhdGE6QXVkaW9MaXN0ZW5lckNvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywge0JPRFlUWVBFX1NUQVRJQzpcInN0YXRpY1wiLCBCT0RZVFlQRV9EWU5BTUlDOlwiZHluYW1pY1wiLCBCT0RZVFlQRV9LSU5FTUFUSUM6XCJraW5lbWF0aWNcIiwgQk9EWUZMQUdfU1RBVElDX09CSkVDVDoxLCBCT0RZRkxBR19LSU5FTUFUSUNfT0JKRUNUOjIsIEJPRFlGTEFHX05PUkVTUE9OU0VfT0JKRUNUOjQsIEJPRFlTVEFURV9BQ1RJVkVfVEFHOjEsIEJPRFlTVEFURV9JU0xBTkRfU0xFRVBJTkc6MiwgQk9EWVNUQVRFX1dBTlRTX0RFQUNUSVZBVElPTjozLCBCT0RZU1RBVEVfRElTQUJMRV9ERUFDVElWQVRJT046NCwgQk9EWVNUQVRFX0RJU0FCTEVfU0lNVUxBVElPTjo1LCBCT0RZR1JPVVBfTk9ORTowLCBCT0RZR1JPVVBfREVGQVVMVDoxLCBCT0RZR1JPVVBfRFlOQU1JQzoxLCBCT0RZR1JPVVBfU1RBVElDOjIsIEJPRFlHUk9VUF9LSU5FTUFUSUM6NCwgQk9EWUdST1VQX0VOR0lORV8xOjgsIEJPRFlHUk9VUF9UUklHR0VSOjE2LCBCT0RZR1JPVVBfRU5HSU5FXzI6MzIsXG5CT0RZR1JPVVBfRU5HSU5FXzM6NjQsIEJPRFlHUk9VUF9VU0VSXzE6MTI4LCBCT0RZR1JPVVBfVVNFUl8yOjI1NiwgQk9EWUdST1VQX1VTRVJfMzo1MTIsIEJPRFlHUk9VUF9VU0VSXzQ6MTAyNCwgQk9EWUdST1VQX1VTRVJfNToyMDQ4LCBCT0RZR1JPVVBfVVNFUl82OjQwOTYsIEJPRFlHUk9VUF9VU0VSXzc6ODE5MiwgQk9EWUdST1VQX1VTRVJfODoxNjM4NCwgQk9EWU1BU0tfTk9ORTowLCBCT0RZTUFTS19BTEw6NjU1MzUsIEJPRFlNQVNLX1NUQVRJQzoyLCBCT0RZTUFTS19OT1RfU1RBVElDOjY1NTM1IF4gMiwgQk9EWU1BU0tfTk9UX1NUQVRJQ19LSU5FTUFUSUM6NjU1MzUgXiAoMiB8IDQpfSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgYW1tb1RyYW5zZm9ybTtcbiAgdmFyIGFtbW9WZWMxLCBhbW1vVmVjMiwgYW1tb1F1YXQsIGFtbW9PcmlnaW47XG4gIHZhciBSaWdpZEJvZHlDb21wb25lbnQgPSBmdW5jdGlvbiBSaWdpZEJvZHlDb21wb25lbnQoc3lzdGVtLCBlbnRpdHkpIHtcbiAgICBpZiAodHlwZW9mIEFtbW8gIT09IFwidW5kZWZpbmVkXCIgJiYgIWFtbW9UcmFuc2Zvcm0pIHtcbiAgICAgIGFtbW9UcmFuc2Zvcm0gPSBuZXcgQW1tby5idFRyYW5zZm9ybTtcbiAgICAgIGFtbW9WZWMxID0gbmV3IEFtbW8uYnRWZWN0b3IzO1xuICAgICAgYW1tb1ZlYzIgPSBuZXcgQW1tby5idFZlY3RvcjM7XG4gICAgICBhbW1vUXVhdCA9IG5ldyBBbW1vLmJ0UXVhdGVybmlvbjtcbiAgICAgIGFtbW9PcmlnaW4gPSBuZXcgQW1tby5idFZlY3RvcjMoMCwgMCwgMCk7XG4gICAgfVxuICAgIHRoaXMub24oXCJzZXRfbWFzc1wiLCB0aGlzLm9uU2V0TWFzcywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9saW5lYXJEYW1waW5nXCIsIHRoaXMub25TZXRMaW5lYXJEYW1waW5nLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2FuZ3VsYXJEYW1waW5nXCIsIHRoaXMub25TZXRBbmd1bGFyRGFtcGluZywgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9saW5lYXJGYWN0b3JcIiwgdGhpcy5vblNldExpbmVhckZhY3RvciwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9hbmd1bGFyRmFjdG9yXCIsIHRoaXMub25TZXRBbmd1bGFyRmFjdG9yLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2ZyaWN0aW9uXCIsIHRoaXMub25TZXRGcmljdGlvbiwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9yZXN0aXR1dGlvblwiLCB0aGlzLm9uU2V0UmVzdGl0dXRpb24sIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfdHlwZVwiLCB0aGlzLm9uU2V0VHlwZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9ncm91cFwiLCB0aGlzLm9uU2V0R3JvdXBPck1hc2ssIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfbWFza1wiLCB0aGlzLm9uU2V0R3JvdXBPck1hc2ssIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfYm9keVwiLCB0aGlzLm9uU2V0Qm9keSwgdGhpcyk7XG4gICAgdGhpcy5fZGlzcGxhY2VtZW50ID0gbmV3IHBjLlZlYzMoMCwgMCwgMCk7XG4gICAgdGhpcy5fbGluZWFyVmVsb2NpdHkgPSBuZXcgcGMuVmVjMygwLCAwLCAwKTtcbiAgICB0aGlzLl9hbmd1bGFyVmVsb2NpdHkgPSBuZXcgcGMuVmVjMygwLCAwLCAwKTtcbiAgfTtcbiAgUmlnaWRCb2R5Q29tcG9uZW50ID0gcGMuaW5oZXJpdHMoUmlnaWRCb2R5Q29tcG9uZW50LCBwYy5Db21wb25lbnQpO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUmlnaWRCb2R5Q29tcG9uZW50LnByb3RvdHlwZSwgXCJib2R5VHlwZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUud2FybihcIldBUk5JTkc6IGJvZHlUeXBlOiBGdW5jdGlvbiBpcyBkZXByZWNhdGVkLiBRdWVyeSB0eXBlIHByb3BlcnR5IGluc3RlYWQuXCIpO1xuICAgIHJldHVybiB0aGlzLnR5cGU7XG4gIH0sIHNldDpmdW5jdGlvbih0eXBlKSB7XG4gICAgY29uc29sZS53YXJuKFwiV0FSTklORzogYm9keVR5cGU6IEZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQuIFNldCB0eXBlIHByb3BlcnR5IGluc3RlYWQuXCIpO1xuICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFJpZ2lkQm9keUNvbXBvbmVudC5wcm90b3R5cGUsIFwibGluZWFyVmVsb2NpdHlcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuaXNLaW5lbWF0aWMoKSkge1xuICAgICAgaWYgKHRoaXMuYm9keSkge1xuICAgICAgICB2YXIgdmVsID0gdGhpcy5ib2R5LmdldExpbmVhclZlbG9jaXR5KCk7XG4gICAgICAgIHRoaXMuX2xpbmVhclZlbG9jaXR5LnNldCh2ZWwueCgpLCB2ZWwueSgpLCB2ZWwueigpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xpbmVhclZlbG9jaXR5O1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5fbGluZWFyVmVsb2NpdHk7XG4gICAgfVxuICB9LCBzZXQ6ZnVuY3Rpb24obHYpIHtcbiAgICB0aGlzLmFjdGl2YXRlKCk7XG4gICAgaWYgKCF0aGlzLmlzS2luZW1hdGljKCkpIHtcbiAgICAgIHZhciBib2R5ID0gdGhpcy5ib2R5O1xuICAgICAgaWYgKGJvZHkpIHtcbiAgICAgICAgYW1tb1ZlYzEuc2V0VmFsdWUobHYueCwgbHYueSwgbHYueik7XG4gICAgICAgIGJvZHkuc2V0TGluZWFyVmVsb2NpdHkoYW1tb1ZlYzEpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9saW5lYXJWZWxvY2l0eS5jb3B5KGx2KTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFJpZ2lkQm9keUNvbXBvbmVudC5wcm90b3R5cGUsIFwiYW5ndWxhclZlbG9jaXR5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmlzS2luZW1hdGljKCkpIHtcbiAgICAgIGlmICh0aGlzLmJvZHkpIHtcbiAgICAgICAgdmFyIHZlbCA9IHRoaXMuYm9keS5nZXRBbmd1bGFyVmVsb2NpdHkoKTtcbiAgICAgICAgdGhpcy5fYW5ndWxhclZlbG9jaXR5LnNldCh2ZWwueCgpLCB2ZWwueSgpLCB2ZWwueigpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ3VsYXJWZWxvY2l0eTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuX2FuZ3VsYXJWZWxvY2l0eTtcbiAgICB9XG4gIH0sIHNldDpmdW5jdGlvbihhdikge1xuICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgICBpZiAoIXRoaXMuaXNLaW5lbWF0aWMoKSkge1xuICAgICAgdmFyIGJvZHkgPSB0aGlzLmJvZHk7XG4gICAgICBpZiAoYm9keSkge1xuICAgICAgICBhbW1vVmVjMS5zZXRWYWx1ZShhdi54LCBhdi55LCBhdi56KTtcbiAgICAgICAgYm9keS5zZXRBbmd1bGFyVmVsb2NpdHkoYW1tb1ZlYzEpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hbmd1bGFyVmVsb2NpdHkuY29weShhdik7XG4gICAgfVxuICB9fSk7XG4gIHBjLmV4dGVuZChSaWdpZEJvZHlDb21wb25lbnQucHJvdG90eXBlLCB7Y3JlYXRlQm9keTpmdW5jdGlvbigpIHtcbiAgICB2YXIgZW50aXR5ID0gdGhpcy5lbnRpdHk7XG4gICAgdmFyIHNoYXBlO1xuICAgIGlmIChlbnRpdHkuY29sbGlzaW9uKSB7XG4gICAgICBzaGFwZSA9IGVudGl0eS5jb2xsaXNpb24uc2hhcGU7XG4gICAgICBpZiAoZW50aXR5LnRyaWdnZXIpIHtcbiAgICAgICAgZW50aXR5LnRyaWdnZXIuZGVzdHJveSgpO1xuICAgICAgICBkZWxldGUgZW50aXR5LnRyaWdnZXI7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzaGFwZSkge1xuICAgICAgaWYgKHRoaXMuYm9keSkge1xuICAgICAgICB0aGlzLnN5c3RlbS5yZW1vdmVCb2R5KHRoaXMuYm9keSk7XG4gICAgICAgIEFtbW8uZGVzdHJveSh0aGlzLmJvZHkpO1xuICAgICAgfVxuICAgICAgdmFyIGlzU3RhdGljT3JLaW5lbWF0aWMgPSB0aGlzLmlzU3RhdGljT3JLaW5lbWF0aWMoKTtcbiAgICAgIHZhciBtYXNzID0gaXNTdGF0aWNPcktpbmVtYXRpYyA/IDAgOiB0aGlzLm1hc3M7XG4gICAgICB2YXIgbG9jYWxJbmVydGlhID0gbmV3IEFtbW8uYnRWZWN0b3IzKDAsIDAsIDApO1xuICAgICAgaWYgKCFpc1N0YXRpY09yS2luZW1hdGljKSB7XG4gICAgICAgIHNoYXBlLmNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCBsb2NhbEluZXJ0aWEpO1xuICAgICAgfVxuICAgICAgdmFyIHBvcyA9IGVudGl0eS5nZXRQb3NpdGlvbigpO1xuICAgICAgdmFyIHJvdCA9IGVudGl0eS5nZXRSb3RhdGlvbigpO1xuICAgICAgYW1tb1F1YXQuc2V0VmFsdWUocm90LngsIHJvdC55LCByb3Queiwgcm90LncpO1xuICAgICAgdmFyIHN0YXJ0VHJhbnNmb3JtID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm07XG4gICAgICBzdGFydFRyYW5zZm9ybS5zZXRJZGVudGl0eSgpO1xuICAgICAgc3RhcnRUcmFuc2Zvcm0uZ2V0T3JpZ2luKCkuc2V0VmFsdWUocG9zLngsIHBvcy55LCBwb3Mueik7XG4gICAgICBzdGFydFRyYW5zZm9ybS5zZXRSb3RhdGlvbihhbW1vUXVhdCk7XG4gICAgICB2YXIgbW90aW9uU3RhdGUgPSBuZXcgQW1tby5idERlZmF1bHRNb3Rpb25TdGF0ZShzdGFydFRyYW5zZm9ybSk7XG4gICAgICB2YXIgYm9keUluZm8gPSBuZXcgQW1tby5idFJpZ2lkQm9keUNvbnN0cnVjdGlvbkluZm8obWFzcywgbW90aW9uU3RhdGUsIHNoYXBlLCBsb2NhbEluZXJ0aWEpO1xuICAgICAgdmFyIGJvZHkgPSBuZXcgQW1tby5idFJpZ2lkQm9keShib2R5SW5mbyk7XG4gICAgICBib2R5LnNldFJlc3RpdHV0aW9uKHRoaXMucmVzdGl0dXRpb24pO1xuICAgICAgYm9keS5zZXRGcmljdGlvbih0aGlzLmZyaWN0aW9uKTtcbiAgICAgIGJvZHkuc2V0RGFtcGluZyh0aGlzLmxpbmVhckRhbXBpbmcsIHRoaXMuYW5ndWxhckRhbXBpbmcpO1xuICAgICAgdmFyIHY7XG4gICAgICB2ID0gdGhpcy5saW5lYXJGYWN0b3I7XG4gICAgICBhbW1vVmVjMS5zZXRWYWx1ZSh2LngsIHYueSwgdi56KTtcbiAgICAgIGJvZHkuc2V0TGluZWFyRmFjdG9yKGFtbW9WZWMxKTtcbiAgICAgIHYgPSB0aGlzLmFuZ3VsYXJGYWN0b3I7XG4gICAgICBhbW1vVmVjMS5zZXRWYWx1ZSh2LngsIHYueSwgdi56KTtcbiAgICAgIGJvZHkuc2V0QW5ndWxhckZhY3RvcihhbW1vVmVjMSk7XG4gICAgICBib2R5LmVudGl0eSA9IGVudGl0eTtcbiAgICAgIGlmICh0aGlzLmlzS2luZW1hdGljKCkpIHtcbiAgICAgICAgYm9keS5zZXRDb2xsaXNpb25GbGFncyhib2R5LmdldENvbGxpc2lvbkZsYWdzKCkgfCBwYy5CT0RZRkxBR19LSU5FTUFUSUNfT0JKRUNUKTtcbiAgICAgICAgYm9keS5zZXRBY3RpdmF0aW9uU3RhdGUocGMuQk9EWVNUQVRFX0RJU0FCTEVfREVBQ1RJVkFUSU9OKTtcbiAgICAgIH1cbiAgICAgIGVudGl0eS5yaWdpZGJvZHkuYm9keSA9IGJvZHk7XG4gICAgICBpZiAodGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5lbmFibGVTaW11bGF0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBpc0FjdGl2ZTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5ib2R5KSB7XG4gICAgICByZXR1cm4gdGhpcy5ib2R5LmlzQWN0aXZlKCk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSwgYWN0aXZhdGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuYm9keSkge1xuICAgICAgdGhpcy5ib2R5LmFjdGl2YXRlKCk7XG4gICAgfVxuICB9LCBlbmFibGVTaW11bGF0aW9uOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmVudGl0eS5jb2xsaXNpb24gJiYgdGhpcy5lbnRpdHkuY29sbGlzaW9uLmVuYWJsZWQgJiYgIXRoaXMuZGF0YS5zaW11bGF0aW9uRW5hYmxlZCkge1xuICAgICAgdmFyIGJvZHkgPSB0aGlzLmJvZHk7XG4gICAgICBpZiAoYm9keSkge1xuICAgICAgICB0aGlzLnN5c3RlbS5hZGRCb2R5KGJvZHksIHRoaXMuZ3JvdXAsIHRoaXMubWFzayk7XG4gICAgICAgIGlmICh0aGlzLmlzS2luZW1hdGljKCkpIHtcbiAgICAgICAgICBib2R5LmZvcmNlQWN0aXZhdGlvblN0YXRlKHBjLkJPRFlTVEFURV9ESVNBQkxFX0RFQUNUSVZBVElPTik7XG4gICAgICAgICAgYm9keS5hY3RpdmF0ZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGJvZHkuZm9yY2VBY3RpdmF0aW9uU3RhdGUocGMuQk9EWUZMQUdfQUNUSVZFX1RBRyk7XG4gICAgICAgICAgdGhpcy5zeW5jRW50aXR5VG9Cb2R5KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXRhLnNpbXVsYXRpb25FbmFibGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGRpc2FibGVTaW11bGF0aW9uOmZ1bmN0aW9uKCkge1xuICAgIHZhciBib2R5ID0gdGhpcy5ib2R5O1xuICAgIGlmIChib2R5ICYmIHRoaXMuZGF0YS5zaW11bGF0aW9uRW5hYmxlZCkge1xuICAgICAgdGhpcy5zeXN0ZW0ucmVtb3ZlQm9keShib2R5KTtcbiAgICAgIGJvZHkuZm9yY2VBY3RpdmF0aW9uU3RhdGUocGMuQk9EWVNUQVRFX0RJU0FCTEVfU0lNVUxBVElPTik7XG4gICAgICB0aGlzLmRhdGEuc2ltdWxhdGlvbkVuYWJsZWQgPSBmYWxzZTtcbiAgICB9XG4gIH0sIGFwcGx5Rm9yY2U6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHgsIHksIHo7XG4gICAgdmFyIHB4LCBweSwgcHo7XG4gICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHtcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgeCA9IGFyZ3VtZW50c1swXS54O1xuICAgICAgICB5ID0gYXJndW1lbnRzWzBdLnk7XG4gICAgICAgIHogPSBhcmd1bWVudHNbMF0uejtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIHggPSBhcmd1bWVudHNbMF0ueDtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1swXS55O1xuICAgICAgICB6ID0gYXJndW1lbnRzWzBdLno7XG4gICAgICAgIHB4ID0gYXJndW1lbnRzWzFdLng7XG4gICAgICAgIHB5ID0gYXJndW1lbnRzWzFdLnk7XG4gICAgICAgIHB6ID0gYXJndW1lbnRzWzFdLno7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzOlxuICAgICAgICB4ID0gYXJndW1lbnRzWzBdO1xuICAgICAgICB5ID0gYXJndW1lbnRzWzFdO1xuICAgICAgICB6ID0gYXJndW1lbnRzWzJdO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgNjpcbiAgICAgICAgeCA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgcHggPSBhcmd1bWVudHNbM107XG4gICAgICAgIHB5ID0gYXJndW1lbnRzWzRdO1xuICAgICAgICBweiA9IGFyZ3VtZW50c1s1XTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHZhciBib2R5ID0gdGhpcy5ib2R5O1xuICAgIGlmIChib2R5KSB7XG4gICAgICBib2R5LmFjdGl2YXRlKCk7XG4gICAgICBhbW1vVmVjMS5zZXRWYWx1ZSh4LCB5LCB6KTtcbiAgICAgIGlmIChweCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGFtbW9WZWMyLnNldFZhbHVlKHB4LCBweSwgcHopO1xuICAgICAgICBib2R5LmFwcGx5Rm9yY2UoYW1tb1ZlYzEsIGFtbW9WZWMyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJvZHkuYXBwbHlGb3JjZShhbW1vVmVjMSwgYW1tb09yaWdpbik7XG4gICAgICB9XG4gICAgfVxuICB9LCBhcHBseVRvcnF1ZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgeCwgeSwgejtcbiAgICBzd2l0Y2goYXJndW1lbnRzLmxlbmd0aCkge1xuICAgICAgY2FzZSAxOlxuICAgICAgICB4ID0gYXJndW1lbnRzWzBdLng7XG4gICAgICAgIHkgPSBhcmd1bWVudHNbMF0ueTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1swXS56O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMzpcbiAgICAgICAgeCA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zb2xlLmVycm9yKFwiRVJST1I6IGFwcGx5VG9ycXVlOiBmdW5jdGlvbiB0YWtlcyAxIG9yIDMgYXJndW1lbnRzXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBib2R5ID0gdGhpcy5ib2R5O1xuICAgIGlmIChib2R5KSB7XG4gICAgICBib2R5LmFjdGl2YXRlKCk7XG4gICAgICBhbW1vVmVjMS5zZXRWYWx1ZSh4LCB5LCB6KTtcbiAgICAgIGJvZHkuYXBwbHlUb3JxdWUoYW1tb1ZlYzEpO1xuICAgIH1cbiAgfSwgYXBwbHlJbXB1bHNlOmZ1bmN0aW9uKCkge1xuICAgIHZhciB4LCB5LCB6O1xuICAgIHZhciBweCwgcHksIHB6O1xuICAgIHN3aXRjaChhcmd1bWVudHMubGVuZ3RoKSB7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIHggPSBhcmd1bWVudHNbMF0ueDtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1swXS55O1xuICAgICAgICB6ID0gYXJndW1lbnRzWzBdLno7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICB4ID0gYXJndW1lbnRzWzBdLng7XG4gICAgICAgIHkgPSBhcmd1bWVudHNbMF0ueTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1swXS56O1xuICAgICAgICBweCA9IGFyZ3VtZW50c1sxXS54O1xuICAgICAgICBweSA9IGFyZ3VtZW50c1sxXS55O1xuICAgICAgICBweiA9IGFyZ3VtZW50c1sxXS56O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMzpcbiAgICAgICAgeCA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDY6XG4gICAgICAgIHggPSBhcmd1bWVudHNbMF07XG4gICAgICAgIHkgPSBhcmd1bWVudHNbMV07XG4gICAgICAgIHogPSBhcmd1bWVudHNbMl07XG4gICAgICAgIHB4ID0gYXJndW1lbnRzWzBdO1xuICAgICAgICBweSA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgcHogPSBhcmd1bWVudHNbMl07XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICB2YXIgYm9keSA9IHRoaXMuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgYm9keS5hY3RpdmF0ZSgpO1xuICAgICAgYW1tb1ZlYzEuc2V0VmFsdWUoeCwgeSwgeik7XG4gICAgICBpZiAocHggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBhbW1vVmVjMi5zZXRWYWx1ZShweCwgcHksIHB6KTtcbiAgICAgICAgYm9keS5hcHBseUltcHVsc2UoYW1tb1ZlYzEsIGFtbW9WZWMyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJvZHkuYXBwbHlJbXB1bHNlKGFtbW9WZWMxLCBhbW1vT3JpZ2luKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGFwcGx5VG9ycXVlSW1wdWxzZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgeCwgeSwgejtcbiAgICBzd2l0Y2goYXJndW1lbnRzLmxlbmd0aCkge1xuICAgICAgY2FzZSAxOlxuICAgICAgICB4ID0gYXJndW1lbnRzWzBdLng7XG4gICAgICAgIHkgPSBhcmd1bWVudHNbMF0ueTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1swXS56O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMzpcbiAgICAgICAgeCA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgeSA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgeiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zb2xlLmVycm9yKFwiRVJST1I6IGFwcGx5VG9ycXVlSW1wdWxzZTogZnVuY3Rpb24gdGFrZXMgMSBvciAzIGFyZ3VtZW50c1wiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgYm9keSA9IHRoaXMuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgYm9keS5hY3RpdmF0ZSgpO1xuICAgICAgYW1tb1ZlYzEuc2V0VmFsdWUoeCwgeSwgeik7XG4gICAgICBib2R5LmFwcGx5VG9ycXVlSW1wdWxzZShhbW1vVmVjMSk7XG4gICAgfVxuICB9LCBpc1N0YXRpYzpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy50eXBlID09PSBwYy5CT0RZVFlQRV9TVEFUSUM7XG4gIH0sIGlzU3RhdGljT3JLaW5lbWF0aWM6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gcGMuQk9EWVRZUEVfU1RBVElDIHx8IHRoaXMudHlwZSA9PT0gcGMuQk9EWVRZUEVfS0lORU1BVElDO1xuICB9LCBpc0tpbmVtYXRpYzpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy50eXBlID09PSBwYy5CT0RZVFlQRV9LSU5FTUFUSUM7XG4gIH0sIHN5bmNFbnRpdHlUb0JvZHk6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGJvZHkgPSB0aGlzLmJvZHk7XG4gICAgaWYgKGJvZHkpIHtcbiAgICAgIHZhciBwb3MgPSB0aGlzLmVudGl0eS5nZXRQb3NpdGlvbigpO1xuICAgICAgdmFyIHJvdCA9IHRoaXMuZW50aXR5LmdldFJvdGF0aW9uKCk7XG4gICAgICB2YXIgdHJhbnNmb3JtID0gYm9keS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgdHJhbnNmb3JtLmdldE9yaWdpbigpLnNldFZhbHVlKHBvcy54LCBwb3MueSwgcG9zLnopO1xuICAgICAgYW1tb1F1YXQuc2V0VmFsdWUocm90LngsIHJvdC55LCByb3Queiwgcm90LncpO1xuICAgICAgdHJhbnNmb3JtLnNldFJvdGF0aW9uKGFtbW9RdWF0KTtcbiAgICAgIGlmICh0aGlzLmlzS2luZW1hdGljKCkpIHtcbiAgICAgICAgdmFyIG1vdGlvblN0YXRlID0gdGhpcy5ib2R5LmdldE1vdGlvblN0YXRlKCk7XG4gICAgICAgIGlmIChtb3Rpb25TdGF0ZSkge1xuICAgICAgICAgIG1vdGlvblN0YXRlLnNldFdvcmxkVHJhbnNmb3JtKHRyYW5zZm9ybSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGJvZHkuYWN0aXZhdGUoKTtcbiAgICB9XG4gIH0sIHN5bmNCb2R5VG9FbnRpdHk6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGJvZHkgPSB0aGlzLmJvZHk7XG4gICAgaWYgKGJvZHkuaXNBY3RpdmUoKSkge1xuICAgICAgdmFyIG1vdGlvblN0YXRlID0gYm9keS5nZXRNb3Rpb25TdGF0ZSgpO1xuICAgICAgaWYgKG1vdGlvblN0YXRlKSB7XG4gICAgICAgIG1vdGlvblN0YXRlLmdldFdvcmxkVHJhbnNmb3JtKGFtbW9UcmFuc2Zvcm0pO1xuICAgICAgICB2YXIgcCA9IGFtbW9UcmFuc2Zvcm0uZ2V0T3JpZ2luKCk7XG4gICAgICAgIHZhciBxID0gYW1tb1RyYW5zZm9ybS5nZXRSb3RhdGlvbigpO1xuICAgICAgICB0aGlzLmVudGl0eS5zZXRQb3NpdGlvbihwLngoKSwgcC55KCksIHAueigpKTtcbiAgICAgICAgdGhpcy5lbnRpdHkuc2V0Um90YXRpb24ocS54KCksIHEueSgpLCBxLnooKSwgcS53KCkpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgdGVsZXBvcnQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7XG4gICAgICBpZiAoYXJndW1lbnRzWzBdKSB7XG4gICAgICAgIHRoaXMuZW50aXR5LnNldFBvc2l0aW9uKGFyZ3VtZW50c1swXSk7XG4gICAgICB9XG4gICAgICBpZiAoYXJndW1lbnRzWzFdKSB7XG4gICAgICAgIGlmIChhcmd1bWVudHNbMV0gaW5zdGFuY2VvZiBwYy5RdWF0KSB7XG4gICAgICAgICAgdGhpcy5lbnRpdHkuc2V0Um90YXRpb24oYXJndW1lbnRzWzFdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmVudGl0eS5zZXRFdWxlckFuZ2xlcyhhcmd1bWVudHNbMV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSA2KSB7XG4gICAgICAgIHRoaXMuZW50aXR5LnNldEV1bGVyQW5nbGVzKGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pO1xuICAgICAgfVxuICAgICAgdGhpcy5lbnRpdHkuc2V0UG9zaXRpb24oYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7XG4gICAgfVxuICAgIHRoaXMuc3luY0VudGl0eVRvQm9keSgpO1xuICB9LCBfdXBkYXRlS2luZW1hdGljOmZ1bmN0aW9uKGR0KSB7XG4gICAgdGhpcy5fZGlzcGxhY2VtZW50LmNvcHkodGhpcy5fbGluZWFyVmVsb2NpdHkpLnNjYWxlKGR0KTtcbiAgICB0aGlzLmVudGl0eS50cmFuc2xhdGUodGhpcy5fZGlzcGxhY2VtZW50KTtcbiAgICB0aGlzLl9kaXNwbGFjZW1lbnQuY29weSh0aGlzLl9hbmd1bGFyVmVsb2NpdHkpLnNjYWxlKGR0KTtcbiAgICB0aGlzLmVudGl0eS5yb3RhdGUodGhpcy5fZGlzcGxhY2VtZW50LngsIHRoaXMuX2Rpc3BsYWNlbWVudC55LCB0aGlzLl9kaXNwbGFjZW1lbnQueik7XG4gICAgaWYgKHRoaXMuYm9keS5nZXRNb3Rpb25TdGF0ZSgpKSB7XG4gICAgICB2YXIgcG9zID0gdGhpcy5lbnRpdHkuZ2V0UG9zaXRpb24oKTtcbiAgICAgIHZhciByb3QgPSB0aGlzLmVudGl0eS5nZXRSb3RhdGlvbigpO1xuICAgICAgYW1tb1RyYW5zZm9ybS5nZXRPcmlnaW4oKS5zZXRWYWx1ZShwb3MueCwgcG9zLnksIHBvcy56KTtcbiAgICAgIGFtbW9RdWF0LnNldFZhbHVlKHJvdC54LCByb3QueSwgcm90LnosIHJvdC53KTtcbiAgICAgIGFtbW9UcmFuc2Zvcm0uc2V0Um90YXRpb24oYW1tb1F1YXQpO1xuICAgICAgdGhpcy5ib2R5LmdldE1vdGlvblN0YXRlKCkuc2V0V29ybGRUcmFuc2Zvcm0oYW1tb1RyYW5zZm9ybSk7XG4gICAgfVxuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBSaWdpZEJvZHlDb21wb25lbnQuX3N1cGVyLm9uRW5hYmxlLmNhbGwodGhpcyk7XG4gICAgaWYgKCF0aGlzLmJvZHkpIHtcbiAgICAgIHRoaXMuY3JlYXRlQm9keSgpO1xuICAgIH1cbiAgICB0aGlzLmVuYWJsZVNpbXVsYXRpb24oKTtcbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIFJpZ2lkQm9keUNvbXBvbmVudC5fc3VwZXIub25EaXNhYmxlLmNhbGwodGhpcyk7XG4gICAgdGhpcy5kaXNhYmxlU2ltdWxhdGlvbigpO1xuICB9LCBvblNldE1hc3M6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIGJvZHkgPSB0aGlzLmRhdGEuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgdmFyIGlzRW5hYmxlZCA9IHRoaXMuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkO1xuICAgICAgaWYgKGlzRW5hYmxlZCkge1xuICAgICAgICB0aGlzLmRpc2FibGVTaW11bGF0aW9uKCk7XG4gICAgICB9XG4gICAgICB2YXIgbWFzcyA9IG5ld1ZhbHVlO1xuICAgICAgdmFyIGxvY2FsSW5lcnRpYSA9IG5ldyBBbW1vLmJ0VmVjdG9yMygwLCAwLCAwKTtcbiAgICAgIGJvZHkuZ2V0Q29sbGlzaW9uU2hhcGUoKS5jYWxjdWxhdGVMb2NhbEluZXJ0aWEobWFzcywgbG9jYWxJbmVydGlhKTtcbiAgICAgIGJvZHkuc2V0TWFzc1Byb3BzKG1hc3MsIGxvY2FsSW5lcnRpYSk7XG4gICAgICBib2R5LnVwZGF0ZUluZXJ0aWFUZW5zb3IoKTtcbiAgICAgIGlmIChpc0VuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5lbmFibGVTaW11bGF0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldExpbmVhckRhbXBpbmc6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIGJvZHkgPSB0aGlzLmRhdGEuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgYm9keS5zZXREYW1waW5nKG5ld1ZhbHVlLCB0aGlzLmRhdGEuYW5ndWxhckRhbXBpbmcpO1xuICAgIH1cbiAgfSwgb25TZXRBbmd1bGFyRGFtcGluZzpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgYm9keSA9IHRoaXMuZGF0YS5ib2R5O1xuICAgIGlmIChib2R5KSB7XG4gICAgICBib2R5LnNldERhbXBpbmcodGhpcy5kYXRhLmxpbmVhckRhbXBpbmcsIG5ld1ZhbHVlKTtcbiAgICB9XG4gIH0sIG9uU2V0TGluZWFyRmFjdG9yOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBib2R5ID0gdGhpcy5kYXRhLmJvZHk7XG4gICAgaWYgKGJvZHkpIHtcbiAgICAgIGFtbW9WZWMxLnNldFZhbHVlKG5ld1ZhbHVlLngsIG5ld1ZhbHVlLnksIG5ld1ZhbHVlLnopO1xuICAgICAgYm9keS5zZXRMaW5lYXJGYWN0b3IoYW1tb1ZlYzEpO1xuICAgIH1cbiAgfSwgb25TZXRBbmd1bGFyRmFjdG9yOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBib2R5ID0gdGhpcy5kYXRhLmJvZHk7XG4gICAgaWYgKGJvZHkpIHtcbiAgICAgIGFtbW9WZWMxLnNldFZhbHVlKG5ld1ZhbHVlLngsIG5ld1ZhbHVlLnksIG5ld1ZhbHVlLnopO1xuICAgICAgYm9keS5zZXRBbmd1bGFyRmFjdG9yKGFtbW9WZWMxKTtcbiAgICB9XG4gIH0sIG9uU2V0RnJpY3Rpb246ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIGJvZHkgPSB0aGlzLmRhdGEuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgYm9keS5zZXRGcmljdGlvbihuZXdWYWx1ZSk7XG4gICAgfVxuICB9LCBvblNldFJlc3RpdHV0aW9uOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBib2R5ID0gdGhpcy5kYXRhLmJvZHk7XG4gICAgaWYgKGJvZHkpIHtcbiAgICAgIGJvZHkuc2V0UmVzdGl0dXRpb24obmV3VmFsdWUpO1xuICAgIH1cbiAgfSwgb25TZXRUeXBlOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmIChuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHtcbiAgICAgIHRoaXMuZGlzYWJsZVNpbXVsYXRpb24oKTtcbiAgICAgIGlmIChuZXdWYWx1ZSA9PT0gcGMuQk9EWVRZUEVfRFlOQU1JQykge1xuICAgICAgICB0aGlzLmRhdGEuZ3JvdXAgPSBwYy5CT0RZR1JPVVBfRFlOQU1JQztcbiAgICAgICAgdGhpcy5kYXRhLm1hc2sgPSBwYy5CT0RZTUFTS19BTEw7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobmV3VmFsdWUgPT09IHBjLkJPRFlUWVBFX0tJTkVNQVRJQykge1xuICAgICAgICAgIHRoaXMuZGF0YS5ncm91cCA9IHBjLkJPRFlHUk9VUF9LSU5FTUFUSUM7XG4gICAgICAgICAgdGhpcy5kYXRhLm1hc2sgPSBwYy5CT0RZTUFTS19BTEw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5kYXRhLmdyb3VwID0gcGMuQk9EWUdST1VQX1NUQVRJQztcbiAgICAgICAgICB0aGlzLmRhdGEubWFzayA9IHBjLkJPRFlNQVNLX05PVF9TVEFUSUM7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuY3JlYXRlQm9keSgpO1xuICAgIH1cbiAgfSwgb25TZXRHcm91cE9yTWFzazpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAobmV3VmFsdWUgIT09IG9sZFZhbHVlKSB7XG4gICAgICB2YXIgaXNFbmFibGVkID0gdGhpcy5lbmFibGVkICYmIHRoaXMuZW50aXR5LmVuYWJsZWQ7XG4gICAgICBpZiAoaXNFbmFibGVkKSB7XG4gICAgICAgIHRoaXMuZGlzYWJsZVNpbXVsYXRpb24oKTtcbiAgICAgICAgdGhpcy5lbmFibGVTaW11bGF0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvblNldEJvZHk6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuYm9keSAmJiB0aGlzLmRhdGEuc2ltdWxhdGlvbkVuYWJsZWQpIHtcbiAgICAgIHRoaXMuYm9keS5hY3RpdmF0ZSgpO1xuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge1JpZ2lkQm9keUNvbXBvbmVudDpSaWdpZEJvZHlDb21wb25lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciB0cmFuc2Zvcm0gPSBuZXcgcGMuTWF0NDtcbiAgdmFyIG5ld1d0bSA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgcG9zaXRpb24gPSBuZXcgcGMuVmVjMztcbiAgdmFyIHJvdGF0aW9uID0gbmV3IHBjLlZlYzM7XG4gIHZhciBzY2FsZSA9IG5ldyBwYy5WZWMzO1xuICB2YXIgYW1tb1JheVN0YXJ0LCBhbW1vUmF5RW5kO1xuICB2YXIgY29sbGlzaW9ucyA9IHt9O1xuICB2YXIgZnJhbWVDb2xsaXNpb25zID0ge307XG4gIHZhciBXQVJORURfUkFZQ0FTVF9DQUxMQkFDSyA9IGZhbHNlO1xuICB2YXIgUmF5Y2FzdFJlc3VsdCA9IGZ1bmN0aW9uIFJheWNhc3RSZXN1bHQoZW50aXR5LCBwb2ludCwgbm9ybWFsKSB7XG4gICAgdGhpcy5lbnRpdHkgPSBlbnRpdHk7XG4gICAgdGhpcy5wb2ludCA9IHBvaW50O1xuICAgIHRoaXMubm9ybWFsID0gbm9ybWFsO1xuICB9O1xuICB2YXIgU2luZ2xlQ29udGFjdFJlc3VsdCA9IGZ1bmN0aW9uIFNpbmdsZUNvbnRhY3RSZXN1bHQoYSwgYiwgY29udGFjdFBvaW50KSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuYSA9IG51bGw7XG4gICAgICB0aGlzLmIgPSBudWxsO1xuICAgICAgdGhpcy5sb2NhbFBvaW50QSA9IG5ldyBwYy5WZWMzO1xuICAgICAgdGhpcy5sb2NhbFBvaW50QiA9IG5ldyBwYy5WZWMzO1xuICAgICAgdGhpcy5wb2ludEEgPSBuZXcgcGMuVmVjMztcbiAgICAgIHRoaXMucG9pbnRCID0gbmV3IHBjLlZlYzM7XG4gICAgICB0aGlzLm5vcm1hbCA9IG5ldyBwYy5WZWMzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmEgPSBhO1xuICAgICAgdGhpcy5iID0gYjtcbiAgICAgIHRoaXMubG9jYWxQb2ludEEgPSBjb250YWN0UG9pbnQubG9jYWxQb2ludDtcbiAgICAgIHRoaXMubG9jYWxQb2ludEIgPSBjb250YWN0UG9pbnQubG9jYWxQb2ludE90aGVyO1xuICAgICAgdGhpcy5wb2ludEEgPSBjb250YWN0UG9pbnQucG9pbnQ7XG4gICAgICB0aGlzLnBvaW50QiA9IGNvbnRhY3RQb2ludC5wb2ludE90aGVyO1xuICAgICAgdGhpcy5ub3JtYWwgPSBjb250YWN0UG9pbnQubm9ybWFsO1xuICAgIH1cbiAgfTtcbiAgdmFyIENvbnRhY3RQb2ludCA9IGZ1bmN0aW9uIENvbnRhY3RQb2ludChsb2NhbFBvaW50LCBsb2NhbFBvaW50T3RoZXIsIHBvaW50LCBwb2ludE90aGVyLCBub3JtYWwpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5sb2NhbFBvaW50ID0gbmV3IHBjLlZlYzM7XG4gICAgICB0aGlzLmxvY2FsUG9pbnRPdGhlciA9IG5ldyBwYy5WZWMzO1xuICAgICAgdGhpcy5wb2ludCA9IG5ldyBwYy5WZWMzO1xuICAgICAgdGhpcy5wb2ludE90aGVyID0gbmV3IHBjLlZlYzM7XG4gICAgICB0aGlzLm5vcm1hbCA9IG5ldyBwYy5WZWMzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvY2FsUG9pbnQgPSBsb2NhbFBvaW50O1xuICAgICAgdGhpcy5sb2NhbFBvaW50T3RoZXIgPSBsb2NhbFBvaW50T3RoZXI7XG4gICAgICB0aGlzLnBvaW50ID0gcG9pbnQ7XG4gICAgICB0aGlzLnBvaW50T3RoZXIgPSBwb2ludE90aGVyO1xuICAgICAgdGhpcy5ub3JtYWwgPSBub3JtYWw7XG4gICAgfVxuICB9O1xuICB2YXIgQ29udGFjdFJlc3VsdCA9IGZ1bmN0aW9uIENvbnRhY3RSZXN1bHQob3RoZXIsIGNvbnRhY3RzKSB7XG4gICAgdGhpcy5vdGhlciA9IG90aGVyO1xuICAgIHRoaXMuY29udGFjdHMgPSBjb250YWN0cztcbiAgfTtcbiAgdmFyIF9zY2hlbWEgPSBbXCJlbmFibGVkXCIsIFwidHlwZVwiLCBcIm1hc3NcIiwgXCJsaW5lYXJEYW1waW5nXCIsIFwiYW5ndWxhckRhbXBpbmdcIiwgXCJsaW5lYXJGYWN0b3JcIiwgXCJhbmd1bGFyRmFjdG9yXCIsIFwiZnJpY3Rpb25cIiwgXCJyZXN0aXR1dGlvblwiLCBcImdyb3VwXCIsIFwibWFza1wiLCBcImJvZHlcIl07XG4gIHZhciBSaWdpZEJvZHlDb21wb25lbnRTeXN0ZW0gPSBmdW5jdGlvbiBSaWdpZEJvZHlDb21wb25lbnRTeXN0ZW0oYXBwKSB7XG4gICAgdGhpcy5pZCA9IFwicmlnaWRib2R5XCI7XG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IFwiQWRkcyB0aGUgZW50aXR5IHRvIHRoZSBzY2VuZSdzIHBoeXNpY2FsIHNpbXVsYXRpb24uXCI7XG4gICAgYXBwLnN5c3RlbXMuYWRkKHRoaXMuaWQsIHRoaXMpO1xuICAgIHRoaXMuX3N0YXRzID0gYXBwLnN0YXRzLmZyYW1lO1xuICAgIHRoaXMuQ29tcG9uZW50VHlwZSA9IHBjLlJpZ2lkQm9keUNvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuUmlnaWRCb2R5Q29tcG9uZW50RGF0YTtcbiAgICB0aGlzLmNvbnRhY3RQb2ludFBvb2wgPSBuZXcgcGMuQWxsb2NhdGVQb29sKENvbnRhY3RQb2ludCwgMSk7XG4gICAgdGhpcy5jb250YWN0UmVzdWx0UG9vbCA9IG5ldyBwYy5BbGxvY2F0ZVBvb2woQ29udGFjdFJlc3VsdCwgMSk7XG4gICAgdGhpcy5zaW5nbGVDb250YWN0UmVzdWx0UG9vbCA9IG5ldyBwYy5BbGxvY2F0ZVBvb2woU2luZ2xlQ29udGFjdFJlc3VsdCwgMSk7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMubWF4U3ViU3RlcHMgPSAxMDtcbiAgICB0aGlzLmZpeGVkVGltZVN0ZXAgPSAxIC8gNjA7XG4gICAgdGhpcy5vbihcInJlbW92ZVwiLCB0aGlzLm9uUmVtb3ZlLCB0aGlzKTtcbiAgfTtcbiAgUmlnaWRCb2R5Q29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoUmlnaWRCb2R5Q29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLlJpZ2lkQm9keUNvbXBvbmVudC5wcm90b3R5cGUsIF9zY2hlbWEpO1xuICBwYy5leHRlbmQoUmlnaWRCb2R5Q29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwge29uTGlicmFyeUxvYWRlZDpmdW5jdGlvbigpIHtcbiAgICBpZiAodHlwZW9mIEFtbW8gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHZhciBjb2xsaXNpb25Db25maWd1cmF0aW9uID0gbmV3IEFtbW8uYnREZWZhdWx0Q29sbGlzaW9uQ29uZmlndXJhdGlvbjtcbiAgICAgIHZhciBkaXNwYXRjaGVyID0gbmV3IEFtbW8uYnRDb2xsaXNpb25EaXNwYXRjaGVyKGNvbGxpc2lvbkNvbmZpZ3VyYXRpb24pO1xuICAgICAgdmFyIG92ZXJsYXBwaW5nUGFpckNhY2hlID0gbmV3IEFtbW8uYnREYnZ0QnJvYWRwaGFzZTtcbiAgICAgIHZhciBzb2x2ZXIgPSBuZXcgQW1tby5idFNlcXVlbnRpYWxJbXB1bHNlQ29uc3RyYWludFNvbHZlcjtcbiAgICAgIHRoaXMuZHluYW1pY3NXb3JsZCA9IG5ldyBBbW1vLmJ0RGlzY3JldGVEeW5hbWljc1dvcmxkKGRpc3BhdGNoZXIsIG92ZXJsYXBwaW5nUGFpckNhY2hlLCBzb2x2ZXIsIGNvbGxpc2lvbkNvbmZpZ3VyYXRpb24pO1xuICAgICAgdGhpcy5fYW1tb0dyYXZpdHkgPSBuZXcgQW1tby5idFZlY3RvcjMoMCwgLTkuODIsIDApO1xuICAgICAgdGhpcy5keW5hbWljc1dvcmxkLnNldEdyYXZpdHkodGhpcy5fYW1tb0dyYXZpdHkpO1xuICAgICAgYW1tb1JheVN0YXJ0ID0gbmV3IEFtbW8uYnRWZWN0b3IzO1xuICAgICAgYW1tb1JheUVuZCA9IG5ldyBBbW1vLmJ0VmVjdG9yMztcbiAgICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vbihcInVwZGF0ZVwiLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGMuQ29tcG9uZW50U3lzdGVtLm9mZihcInVwZGF0ZVwiLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgICB9XG4gIH0sIGluaXRpYWxpemVDb21wb25lbnREYXRhOmZ1bmN0aW9uKGNvbXBvbmVudCwgX2RhdGEsIHByb3BlcnRpZXMpIHtcbiAgICBwcm9wZXJ0aWVzID0gW1wiZW5hYmxlZFwiLCBcIm1hc3NcIiwgXCJsaW5lYXJEYW1waW5nXCIsIFwiYW5ndWxhckRhbXBpbmdcIiwgXCJsaW5lYXJGYWN0b3JcIiwgXCJhbmd1bGFyRmFjdG9yXCIsIFwiZnJpY3Rpb25cIiwgXCJyZXN0aXR1dGlvblwiLCBcInR5cGVcIiwgXCJncm91cFwiLCBcIm1hc2tcIl07XG4gICAgdmFyIGRhdGEgPSB7fTtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgZGF0YVtwcm9wXSA9IF9kYXRhW3Byb3BdO1xuICAgIH0pO1xuICAgIGlmIChfZGF0YS5ib2R5VHlwZSkge1xuICAgICAgZGF0YS50eXBlID0gX2RhdGEuYm9keVR5cGU7XG4gICAgICBjb25zb2xlLndhcm4oXCJXQVJOSU5HOiByaWdpZGJvZHkuYm9keVR5cGU6IFByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuIFVzZSB0eXBlIGluc3RlYWQuXCIpO1xuICAgIH1cbiAgICBpZiAoZGF0YS5saW5lYXJGYWN0b3IgJiYgcGMudHlwZShkYXRhLmxpbmVhckZhY3RvcikgPT09IFwiYXJyYXlcIikge1xuICAgICAgZGF0YS5saW5lYXJGYWN0b3IgPSBuZXcgcGMuVmVjMyhkYXRhLmxpbmVhckZhY3RvclswXSwgZGF0YS5saW5lYXJGYWN0b3JbMV0sIGRhdGEubGluZWFyRmFjdG9yWzJdKTtcbiAgICB9XG4gICAgaWYgKGRhdGEuYW5ndWxhckZhY3RvciAmJiBwYy50eXBlKGRhdGEuYW5ndWxhckZhY3RvcikgPT09IFwiYXJyYXlcIikge1xuICAgICAgZGF0YS5hbmd1bGFyRmFjdG9yID0gbmV3IHBjLlZlYzMoZGF0YS5hbmd1bGFyRmFjdG9yWzBdLCBkYXRhLmFuZ3VsYXJGYWN0b3JbMV0sIGRhdGEuYW5ndWxhckZhY3RvclsyXSk7XG4gICAgfVxuICAgIFJpZ2lkQm9keUNvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIGRhdGEgPSB7ZW5hYmxlZDplbnRpdHkucmlnaWRib2R5LmVuYWJsZWQsIG1hc3M6ZW50aXR5LnJpZ2lkYm9keS5tYXNzLCBsaW5lYXJEYW1waW5nOmVudGl0eS5yaWdpZGJvZHkubGluZWFyRGFtcGluZywgYW5ndWxhckRhbXBpbmc6ZW50aXR5LnJpZ2lkYm9keS5hbmd1bGFyRGFtcGluZywgbGluZWFyRmFjdG9yOltlbnRpdHkucmlnaWRib2R5LmxpbmVhckZhY3Rvci54LCBlbnRpdHkucmlnaWRib2R5LmxpbmVhckZhY3Rvci55LCBlbnRpdHkucmlnaWRib2R5LmxpbmVhckZhY3Rvci56XSwgYW5ndWxhckZhY3RvcjpbZW50aXR5LnJpZ2lkYm9keS5hbmd1bGFyRmFjdG9yLngsIGVudGl0eS5yaWdpZGJvZHkuYW5ndWxhckZhY3Rvci55LCBlbnRpdHkucmlnaWRib2R5LmFuZ3VsYXJGYWN0b3Iuel0sIGZyaWN0aW9uOmVudGl0eS5yaWdpZGJvZHkuZnJpY3Rpb24sIHJlc3RpdHV0aW9uOmVudGl0eS5yaWdpZGJvZHkucmVzdGl0dXRpb24sIHR5cGU6ZW50aXR5LnJpZ2lkYm9keS50eXBlLFxuICAgIGdyb3VwOmVudGl0eS5yaWdpZGJvZHkuZ3JvdXAsIG1hc2s6ZW50aXR5LnJpZ2lkYm9keS5tYXNrfTtcbiAgICB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gIH0sIG9uUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgZGF0YSkge1xuICAgIGlmIChkYXRhLmJvZHkpIHtcbiAgICAgIHRoaXMucmVtb3ZlQm9keShkYXRhLmJvZHkpO1xuICAgICAgQW1tby5kZXN0cm95KGRhdGEuYm9keSk7XG4gICAgfVxuICAgIGRhdGEuYm9keSA9IG51bGw7XG4gIH0sIGFkZEJvZHk6ZnVuY3Rpb24oYm9keSwgZ3JvdXAsIG1hc2spIHtcbiAgICBpZiAoZ3JvdXAgIT09IHVuZGVmaW5lZCAmJiBtYXNrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZHluYW1pY3NXb3JsZC5hZGRSaWdpZEJvZHkoYm9keSwgZ3JvdXAsIG1hc2spO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmR5bmFtaWNzV29ybGQuYWRkUmlnaWRCb2R5KGJvZHkpO1xuICAgIH1cbiAgICByZXR1cm4gYm9keTtcbiAgfSwgcmVtb3ZlQm9keTpmdW5jdGlvbihib2R5KSB7XG4gICAgdGhpcy5keW5hbWljc1dvcmxkLnJlbW92ZVJpZ2lkQm9keShib2R5KTtcbiAgfSwgYWRkQ29uc3RyYWludDpmdW5jdGlvbihjb25zdHJhaW50KSB7XG4gICAgdGhpcy5keW5hbWljc1dvcmxkLmFkZENvbnN0cmFpbnQoY29uc3RyYWludCk7XG4gICAgcmV0dXJuIGNvbnN0cmFpbnQ7XG4gIH0sIHJlbW92ZUNvbnN0cmFpbnQ6ZnVuY3Rpb24oY29uc3RyYWludCkge1xuICAgIHRoaXMuZHluYW1pY3NXb3JsZC5yZW1vdmVDb25zdHJhaW50KGNvbnN0cmFpbnQpO1xuICB9LCBzZXRHcmF2aXR5OmZ1bmN0aW9uKCkge1xuICAgIHZhciB4LCB5LCB6O1xuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7XG4gICAgICB4ID0gYXJndW1lbnRzWzBdLng7XG4gICAgICB5ID0gYXJndW1lbnRzWzBdLnk7XG4gICAgICB6ID0gYXJndW1lbnRzWzBdLno7XG4gICAgfSBlbHNlIHtcbiAgICAgIHggPSBhcmd1bWVudHNbMF07XG4gICAgICB5ID0gYXJndW1lbnRzWzFdO1xuICAgICAgeiA9IGFyZ3VtZW50c1syXTtcbiAgICB9XG4gICAgdGhpcy5fYW1tb0dyYXZpdHkuc2V0VmFsdWUoeCwgeSwgeik7XG4gICAgdGhpcy5keW5hbWljc1dvcmxkLnNldEdyYXZpdHkodGhpcy5fYW1tb0dyYXZpdHkpO1xuICB9LCByYXljYXN0Rmlyc3Q6ZnVuY3Rpb24oc3RhcnQsIGVuZCwgY2FsbGJhY2spIHtcbiAgICB2YXIgcmVzdWx0ID0gbnVsbDtcbiAgICBhbW1vUmF5U3RhcnQuc2V0VmFsdWUoc3RhcnQueCwgc3RhcnQueSwgc3RhcnQueik7XG4gICAgYW1tb1JheUVuZC5zZXRWYWx1ZShlbmQueCwgZW5kLnksIGVuZC56KTtcbiAgICB2YXIgcmF5Q2FsbGJhY2sgPSBuZXcgQW1tby5DbG9zZXN0UmF5UmVzdWx0Q2FsbGJhY2soYW1tb1JheVN0YXJ0LCBhbW1vUmF5RW5kKTtcbiAgICB0aGlzLmR5bmFtaWNzV29ybGQucmF5VGVzdChhbW1vUmF5U3RhcnQsIGFtbW9SYXlFbmQsIHJheUNhbGxiYWNrKTtcbiAgICBpZiAocmF5Q2FsbGJhY2suaGFzSGl0KCkpIHtcbiAgICAgIHZhciBjb2xsaXNpb25PYmogPSByYXlDYWxsYmFjay5nZXRfbV9jb2xsaXNpb25PYmplY3QoKTtcbiAgICAgIHZhciBib2R5ID0gQW1tby5jYXN0T2JqZWN0KGNvbGxpc2lvbk9iaiwgQW1tby5idFJpZ2lkQm9keSk7XG4gICAgICBpZiAoYm9keSkge1xuICAgICAgICB2YXIgcG9pbnQgPSByYXlDYWxsYmFjay5nZXRfbV9oaXRQb2ludFdvcmxkKCk7XG4gICAgICAgIHZhciBub3JtYWwgPSByYXlDYWxsYmFjay5nZXRfbV9oaXROb3JtYWxXb3JsZCgpO1xuICAgICAgICByZXN1bHQgPSBuZXcgUmF5Y2FzdFJlc3VsdChib2R5LmVudGl0eSwgbmV3IHBjLlZlYzMocG9pbnQueCgpLCBwb2ludC55KCksIHBvaW50LnooKSksIG5ldyBwYy5WZWMzKG5vcm1hbC54KCksIG5vcm1hbC55KCksIG5vcm1hbC56KCkpKTtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgY2FsbGJhY2socmVzdWx0KTtcbiAgICAgICAgICBpZiAoIVdBUk5FRF9SQVlDQVNUX0NBTExCQUNLKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJbREVQUkVDQVRFRF06IHBjLlJpZ2lkQm9keUNvbXBvbmVudFN5c3RlbSNyYXlDYXN0Rmlyc3Qgbm8gbG9uZ2VyIHJlcXVpcmVzIGEgY2FsbGJhY2suIFRoZSByZXN1bHQgb2YgdGhlIHJheWNhc3QgaXMgcmV0dXJuZWQgYnkgdGhlIGZ1bmN0aW9uIGluc3RlYWQuXCIpO1xuICAgICAgICAgICAgV0FSTkVEX1JBWUNBU1RfQ0FMTEJBQ0sgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBBbW1vLmRlc3Ryb3kocmF5Q2FsbGJhY2spO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0sIF9zdG9yZUNvbGxpc2lvbjpmdW5jdGlvbihlbnRpdHksIG90aGVyKSB7XG4gICAgdmFyIGlzTmV3Q29sbGlzaW9uID0gZmFsc2U7XG4gICAgdmFyIGd1aWQgPSBlbnRpdHkuX2d1aWQ7XG4gICAgY29sbGlzaW9uc1tndWlkXSA9IGNvbGxpc2lvbnNbZ3VpZF0gfHwge290aGVyczpbXSwgZW50aXR5OmVudGl0eX07XG4gICAgaWYgKGNvbGxpc2lvbnNbZ3VpZF0ub3RoZXJzLmluZGV4T2Yob3RoZXIpIDwgMCkge1xuICAgICAgY29sbGlzaW9uc1tndWlkXS5vdGhlcnMucHVzaChvdGhlcik7XG4gICAgICBpc05ld0NvbGxpc2lvbiA9IHRydWU7XG4gICAgfVxuICAgIGZyYW1lQ29sbGlzaW9uc1tndWlkXSA9IGZyYW1lQ29sbGlzaW9uc1tndWlkXSB8fCB7b3RoZXJzOltdLCBlbnRpdHk6ZW50aXR5fTtcbiAgICBmcmFtZUNvbGxpc2lvbnNbZ3VpZF0ub3RoZXJzLnB1c2gob3RoZXIpO1xuICAgIHJldHVybiBpc05ld0NvbGxpc2lvbjtcbiAgfSwgX2NyZWF0ZUNvbnRhY3RQb2ludEZyb21BbW1vOmZ1bmN0aW9uKGNvbnRhY3RQb2ludCkge1xuICAgIHZhciBjb250YWN0ID0gdGhpcy5jb250YWN0UG9pbnRQb29sLmFsbG9jYXRlKCk7XG4gICAgY29udGFjdC5sb2NhbFBvaW50LnNldChjb250YWN0UG9pbnQuZ2V0X21fbG9jYWxQb2ludEEoKS54KCksIGNvbnRhY3RQb2ludC5nZXRfbV9sb2NhbFBvaW50QSgpLnkoKSwgY29udGFjdFBvaW50LmdldF9tX2xvY2FsUG9pbnRBKCkueigpKTtcbiAgICBjb250YWN0LmxvY2FsUG9pbnRPdGhlci5zZXQoY29udGFjdFBvaW50LmdldF9tX2xvY2FsUG9pbnRCKCkueCgpLCBjb250YWN0UG9pbnQuZ2V0X21fbG9jYWxQb2ludEIoKS55KCksIGNvbnRhY3RQb2ludC5nZXRfbV9sb2NhbFBvaW50QigpLnooKSk7XG4gICAgY29udGFjdC5wb2ludC5zZXQoY29udGFjdFBvaW50LmdldFBvc2l0aW9uV29ybGRPbkEoKS54KCksIGNvbnRhY3RQb2ludC5nZXRQb3NpdGlvbldvcmxkT25BKCkueSgpLCBjb250YWN0UG9pbnQuZ2V0UG9zaXRpb25Xb3JsZE9uQSgpLnooKSk7XG4gICAgY29udGFjdC5wb2ludE90aGVyLnNldChjb250YWN0UG9pbnQuZ2V0UG9zaXRpb25Xb3JsZE9uQigpLngoKSwgY29udGFjdFBvaW50LmdldFBvc2l0aW9uV29ybGRPbkIoKS55KCksIGNvbnRhY3RQb2ludC5nZXRQb3NpdGlvbldvcmxkT25CKCkueigpKTtcbiAgICBjb250YWN0Lm5vcm1hbC5zZXQoY29udGFjdFBvaW50LmdldF9tX25vcm1hbFdvcmxkT25CKCkueCgpLCBjb250YWN0UG9pbnQuZ2V0X21fbm9ybWFsV29ybGRPbkIoKS55KCksIGNvbnRhY3RQb2ludC5nZXRfbV9ub3JtYWxXb3JsZE9uQigpLnooKSk7XG4gICAgcmV0dXJuIGNvbnRhY3Q7XG4gIH0sIF9jcmVhdGVSZXZlcnNlQ29udGFjdFBvaW50RnJvbUFtbW86ZnVuY3Rpb24oY29udGFjdFBvaW50KSB7XG4gICAgdmFyIGNvbnRhY3QgPSB0aGlzLmNvbnRhY3RQb2ludFBvb2wuYWxsb2NhdGUoKTtcbiAgICBjb250YWN0LmxvY2FsUG9pbnRPdGhlci5zZXQoY29udGFjdFBvaW50LmdldF9tX2xvY2FsUG9pbnRBKCkueCgpLCBjb250YWN0UG9pbnQuZ2V0X21fbG9jYWxQb2ludEEoKS55KCksIGNvbnRhY3RQb2ludC5nZXRfbV9sb2NhbFBvaW50QSgpLnooKSk7XG4gICAgY29udGFjdC5sb2NhbFBvaW50LnNldChjb250YWN0UG9pbnQuZ2V0X21fbG9jYWxQb2ludEIoKS54KCksIGNvbnRhY3RQb2ludC5nZXRfbV9sb2NhbFBvaW50QigpLnkoKSwgY29udGFjdFBvaW50LmdldF9tX2xvY2FsUG9pbnRCKCkueigpKTtcbiAgICBjb250YWN0LnBvaW50T3RoZXIuc2V0KGNvbnRhY3RQb2ludC5nZXRQb3NpdGlvbldvcmxkT25BKCkueCgpLCBjb250YWN0UG9pbnQuZ2V0UG9zaXRpb25Xb3JsZE9uQSgpLnkoKSwgY29udGFjdFBvaW50LmdldFBvc2l0aW9uV29ybGRPbkEoKS56KCkpO1xuICAgIGNvbnRhY3QucG9pbnQuc2V0KGNvbnRhY3RQb2ludC5nZXRQb3NpdGlvbldvcmxkT25CKCkueCgpLCBjb250YWN0UG9pbnQuZ2V0UG9zaXRpb25Xb3JsZE9uQigpLnkoKSwgY29udGFjdFBvaW50LmdldFBvc2l0aW9uV29ybGRPbkIoKS56KCkpO1xuICAgIGNvbnRhY3Qubm9ybWFsLnNldChjb250YWN0UG9pbnQuZ2V0X21fbm9ybWFsV29ybGRPbkIoKS54KCksIGNvbnRhY3RQb2ludC5nZXRfbV9ub3JtYWxXb3JsZE9uQigpLnkoKSwgY29udGFjdFBvaW50LmdldF9tX25vcm1hbFdvcmxkT25CKCkueigpKTtcbiAgICByZXR1cm4gY29udGFjdDtcbiAgfSwgX2NyZWF0ZVNpbmdsZUNvbnRhY3RSZXN1bHQ6ZnVuY3Rpb24oYSwgYiwgY29udGFjdFBvaW50KSB7XG4gICAgdmFyIHJlc3VsdCA9IHRoaXMuc2luZ2xlQ29udGFjdFJlc3VsdFBvb2wuYWxsb2NhdGUoKTtcbiAgICByZXN1bHQuYSA9IGE7XG4gICAgcmVzdWx0LmIgPSBiO1xuICAgIHJlc3VsdC5sb2NhbFBvaW50QSA9IGNvbnRhY3RQb2ludC5sb2NhbFBvaW50O1xuICAgIHJlc3VsdC5sb2NhbFBvaW50QiA9IGNvbnRhY3RQb2ludC5sb2NhbFBvaW50T3RoZXI7XG4gICAgcmVzdWx0LnBvaW50QSA9IGNvbnRhY3RQb2ludC5wb2ludDtcbiAgICByZXN1bHQucG9pbnRCID0gY29udGFjdFBvaW50LnBvaW50T3RoZXI7XG4gICAgcmVzdWx0Lm5vcm1hbCA9IGNvbnRhY3RQb2ludC5ub3JtYWw7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSwgX2NyZWF0ZUNvbnRhY3RSZXN1bHQ6ZnVuY3Rpb24ob3RoZXIsIGNvbnRhY3RzKSB7XG4gICAgdmFyIHJlc3VsdCA9IHRoaXMuY29udGFjdFJlc3VsdFBvb2wuYWxsb2NhdGUoKTtcbiAgICByZXN1bHQub3RoZXIgPSBvdGhlcjtcbiAgICByZXN1bHQuY29udGFjdHMgPSBjb250YWN0cztcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9LCBfY2xlYW5PbGRDb2xsaXNpb25zOmZ1bmN0aW9uKCkge1xuICAgIGZvciAodmFyIGd1aWQgaW4gY29sbGlzaW9ucykge1xuICAgICAgaWYgKGNvbGxpc2lvbnMuaGFzT3duUHJvcGVydHkoZ3VpZCkpIHtcbiAgICAgICAgdmFyIGVudGl0eSA9IGNvbGxpc2lvbnNbZ3VpZF0uZW50aXR5O1xuICAgICAgICB2YXIgZW50aXR5Q29sbGlzaW9uID0gZW50aXR5LmNvbGxpc2lvbjtcbiAgICAgICAgdmFyIG90aGVycyA9IGNvbGxpc2lvbnNbZ3VpZF0ub3RoZXJzO1xuICAgICAgICB2YXIgbGVuZ3RoID0gb3RoZXJzLmxlbmd0aDtcbiAgICAgICAgdmFyIGkgPSBsZW5ndGg7XG4gICAgICAgIHdoaWxlIChpLS0pIHtcbiAgICAgICAgICB2YXIgb3RoZXIgPSBvdGhlcnNbaV07XG4gICAgICAgICAgaWYgKCFmcmFtZUNvbGxpc2lvbnNbZ3VpZF0gfHwgZnJhbWVDb2xsaXNpb25zW2d1aWRdLm90aGVycy5pbmRleE9mKG90aGVyKSA8IDApIHtcbiAgICAgICAgICAgIG90aGVycy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICBpZiAoZW50aXR5Q29sbGlzaW9uICYmIG90aGVyLmNvbGxpc2lvbikge1xuICAgICAgICAgICAgICBpZiAoZW50aXR5LnJpZ2lkYm9keSAmJiBvdGhlci5yaWdpZGJvZHkpIHtcbiAgICAgICAgICAgICAgICBlbnRpdHlDb2xsaXNpb24uZmlyZShcImNvbGxpc2lvbmVuZFwiLCBvdGhlcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGVudGl0eS50cmlnZ2VyKSB7XG4gICAgICAgICAgICAgICAgICBlbnRpdHlDb2xsaXNpb24uZmlyZShcInRyaWdnZXJsZWF2ZVwiLCBvdGhlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChvdGhlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgZGVsZXRlIGNvbGxpc2lvbnNbZ3VpZF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uVXBkYXRlOmZ1bmN0aW9uKGR0KSB7XG4gICAgdmFyIGZyYW1lQ29udGFjdHMgPSAwO1xuICAgIHRoaXMuZHluYW1pY3NXb3JsZC5zdGVwU2ltdWxhdGlvbihkdCwgdGhpcy5tYXhTdWJTdGVwcywgdGhpcy5maXhlZFRpbWVTdGVwKTtcbiAgICB2YXIgY29tcG9uZW50cyA9IHRoaXMuc3RvcmU7XG4gICAgZm9yICh2YXIgaWQgaW4gY29tcG9uZW50cykge1xuICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgIHZhciBlbnRpdHkgPSBjb21wb25lbnRzW2lkXS5lbnRpdHk7XG4gICAgICAgIHZhciBjb21wb25lbnREYXRhID0gY29tcG9uZW50c1tpZF0uZGF0YTtcbiAgICAgICAgaWYgKGNvbXBvbmVudERhdGEuYm9keSAmJiBjb21wb25lbnREYXRhLmJvZHkuaXNBY3RpdmUoKSAmJiBjb21wb25lbnREYXRhLmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICBpZiAoY29tcG9uZW50RGF0YS50eXBlID09PSBwYy5CT0RZVFlQRV9EWU5BTUlDKSB7XG4gICAgICAgICAgICBlbnRpdHkucmlnaWRib2R5LnN5bmNCb2R5VG9FbnRpdHkoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNvbXBvbmVudERhdGEudHlwZSA9PT0gcGMuQk9EWVRZUEVfS0lORU1BVElDKSB7XG4gICAgICAgICAgICAgIGVudGl0eS5yaWdpZGJvZHkuX3VwZGF0ZUtpbmVtYXRpYyhkdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBkaXNwYXRjaGVyID0gdGhpcy5keW5hbWljc1dvcmxkLmdldERpc3BhdGNoZXIoKTtcbiAgICB2YXIgbnVtTWFuaWZvbGRzID0gZGlzcGF0Y2hlci5nZXROdW1NYW5pZm9sZHMoKTtcbiAgICB2YXIgaSwgajtcbiAgICBmcmFtZUNvbGxpc2lvbnMgPSB7fTtcbiAgICBmb3IgKGkgPSAwO2kgPCBudW1NYW5pZm9sZHM7aSsrKSB7XG4gICAgICB2YXIgbWFuaWZvbGQgPSBkaXNwYXRjaGVyLmdldE1hbmlmb2xkQnlJbmRleEludGVybmFsKGkpO1xuICAgICAgdmFyIGJvZHkwID0gbWFuaWZvbGQuZ2V0Qm9keTAoKTtcbiAgICAgIHZhciBib2R5MSA9IG1hbmlmb2xkLmdldEJvZHkxKCk7XG4gICAgICB2YXIgd2IwID0gQW1tby5jYXN0T2JqZWN0KGJvZHkwLCBBbW1vLmJ0UmlnaWRCb2R5KTtcbiAgICAgIHZhciB3YjEgPSBBbW1vLmNhc3RPYmplY3QoYm9keTEsIEFtbW8uYnRSaWdpZEJvZHkpO1xuICAgICAgdmFyIGUwID0gd2IwLmVudGl0eTtcbiAgICAgIHZhciBlMSA9IHdiMS5lbnRpdHk7XG4gICAgICBpZiAoIWUwIHx8ICFlMSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZhciBmbGFnczAgPSBib2R5MC5nZXRDb2xsaXNpb25GbGFncygpO1xuICAgICAgdmFyIGZsYWdzMSA9IGJvZHkxLmdldENvbGxpc2lvbkZsYWdzKCk7XG4gICAgICB2YXIgbnVtQ29udGFjdHMgPSBtYW5pZm9sZC5nZXROdW1Db250YWN0cygpO1xuICAgICAgdmFyIGZvcndhcmRDb250YWN0cyA9IFtdO1xuICAgICAgdmFyIHJldmVyc2VDb250YWN0cyA9IFtdO1xuICAgICAgdmFyIG5ld0NvbGxpc2lvbiwgZTBFdmVudHMsIGUxRXZlbnRzO1xuICAgICAgaWYgKG51bUNvbnRhY3RzID4gMCkge1xuICAgICAgICBpZiAoZmxhZ3MwICYgcGMuQk9EWUZMQUdfTk9SRVNQT05TRV9PQkpFQ1QgfHwgZmxhZ3MxICYgcGMuQk9EWUZMQUdfTk9SRVNQT05TRV9PQkpFQ1QpIHtcbiAgICAgICAgICBlMEV2ZW50cyA9IGUwLmNvbGxpc2lvbiA/IGUwLmNvbGxpc2lvbi5oYXNFdmVudChcInRyaWdnZXJlbnRlclwiKSB8fCBlMC5jb2xsaXNpb24uaGFzRXZlbnQoXCJ0cmlnZ2VybGVhdmVcIikgOiBmYWxzZTtcbiAgICAgICAgICBlMUV2ZW50cyA9IGUxLmNvbGxpc2lvbiA/IGUxLmNvbGxpc2lvbi5oYXNFdmVudChcInRyaWdnZXJlbnRlclwiKSB8fCBlMS5jb2xsaXNpb24uaGFzRXZlbnQoXCJ0cmlnZ2VybGVhdmVcIikgOiBmYWxzZTtcbiAgICAgICAgICBpZiAoZTBFdmVudHMpIHtcbiAgICAgICAgICAgIG5ld0NvbGxpc2lvbiA9IHRoaXMuX3N0b3JlQ29sbGlzaW9uKGUwLCBlMSk7XG4gICAgICAgICAgICBpZiAobmV3Q29sbGlzaW9uKSB7XG4gICAgICAgICAgICAgIGlmIChlMC5jb2xsaXNpb24gJiYgIShmbGFnczEgJiBwYy5CT0RZRkxBR19OT1JFU1BPTlNFX09CSkVDVCkpIHtcbiAgICAgICAgICAgICAgICBlMC5jb2xsaXNpb24uZmlyZShcInRyaWdnZXJlbnRlclwiLCBlMSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGUxRXZlbnRzKSB7XG4gICAgICAgICAgICBuZXdDb2xsaXNpb24gPSB0aGlzLl9zdG9yZUNvbGxpc2lvbihlMSwgZTApO1xuICAgICAgICAgICAgaWYgKG5ld0NvbGxpc2lvbikge1xuICAgICAgICAgICAgICBpZiAoZTEuY29sbGlzaW9uICYmICEoZmxhZ3MwICYgcGMuQk9EWUZMQUdfTk9SRVNQT05TRV9PQkpFQ1QpKSB7XG4gICAgICAgICAgICAgICAgZTEuY29sbGlzaW9uLmZpcmUoXCJ0cmlnZ2VyZW50ZXJcIiwgZTApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGUwRXZlbnRzID0gZTAuY29sbGlzaW9uID8gZTAuY29sbGlzaW9uLmhhc0V2ZW50KFwiY29sbGlzaW9uc3RhcnRcIikgfHwgZTAuY29sbGlzaW9uLmhhc0V2ZW50KFwiY29sbGlzaW9uZW5kXCIpIHx8IGUwLmNvbGxpc2lvbi5oYXNFdmVudChcImNvbnRhY3RcIikgOiBmYWxzZTtcbiAgICAgICAgICBlMUV2ZW50cyA9IGUxLmNvbGxpc2lvbiA/IGUxLmNvbGxpc2lvbi5oYXNFdmVudChcImNvbGxpc2lvbnN0YXJ0XCIpIHx8IGUxLmNvbGxpc2lvbi5oYXNFdmVudChcImNvbGxpc2lvbmVuZFwiKSB8fCBlMS5jb2xsaXNpb24uaGFzRXZlbnQoXCJjb250YWN0XCIpIDogZmFsc2U7XG4gICAgICAgICAgdmFyIGdsb2JhbEV2ZW50cyA9IHRoaXMuaGFzRXZlbnQoXCJjb250YWN0XCIpO1xuICAgICAgICAgIGlmIChnbG9iYWxFdmVudHMgfHwgZTBFdmVudHMgfHwgZTFFdmVudHMpIHtcbiAgICAgICAgICAgIGZvciAoaiA9IDA7aiA8IG51bUNvbnRhY3RzO2orKykge1xuICAgICAgICAgICAgICB2YXIgYnRDb250YWN0UG9pbnQgPSBtYW5pZm9sZC5nZXRDb250YWN0UG9pbnQoaik7XG4gICAgICAgICAgICAgIHZhciBjb250YWN0UG9pbnQgPSB0aGlzLl9jcmVhdGVDb250YWN0UG9pbnRGcm9tQW1tbyhidENvbnRhY3RQb2ludCk7XG4gICAgICAgICAgICAgIHZhciByZXZlcnNlQ29udGFjdFBvaW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgaWYgKGUwRXZlbnRzIHx8IGUxRXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgcmV2ZXJzZUNvbnRhY3RQb2ludCA9IHRoaXMuX2NyZWF0ZVJldmVyc2VDb250YWN0UG9pbnRGcm9tQW1tbyhidENvbnRhY3RQb2ludCk7XG4gICAgICAgICAgICAgICAgZm9yd2FyZENvbnRhY3RzLnB1c2goY29udGFjdFBvaW50KTtcbiAgICAgICAgICAgICAgICByZXZlcnNlQ29udGFjdHMucHVzaChyZXZlcnNlQ29udGFjdFBvaW50KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoZ2xvYmFsRXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuX2NyZWF0ZVNpbmdsZUNvbnRhY3RSZXN1bHQoZTAsIGUxLCBjb250YWN0UG9pbnQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyZShcImNvbnRhY3RcIiwgcmVzdWx0KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGUwRXZlbnRzKSB7XG4gICAgICAgICAgICAgIHZhciBmb3J3YXJkUmVzdWx0ID0gdGhpcy5fY3JlYXRlQ29udGFjdFJlc3VsdChlMSwgZm9yd2FyZENvbnRhY3RzKTtcbiAgICAgICAgICAgICAgaWYgKGUwLmNvbGxpc2lvbikge1xuICAgICAgICAgICAgICAgIGUwLmNvbGxpc2lvbi5maXJlKFwiY29udGFjdFwiLCBmb3J3YXJkUmVzdWx0KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBuZXdDb2xsaXNpb24gPSB0aGlzLl9zdG9yZUNvbGxpc2lvbihlMCwgZTEpO1xuICAgICAgICAgICAgICBpZiAobmV3Q29sbGlzaW9uICYmIGUwLmNvbGxpc2lvbikge1xuICAgICAgICAgICAgICAgIGUwLmNvbGxpc2lvbi5maXJlKFwiY29sbGlzaW9uc3RhcnRcIiwgZm9yd2FyZFJlc3VsdCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlMUV2ZW50cykge1xuICAgICAgICAgICAgICB2YXIgcmV2ZXJzZVJlc3VsdCA9IHRoaXMuX2NyZWF0ZUNvbnRhY3RSZXN1bHQoZTAsIHJldmVyc2VDb250YWN0cyk7XG4gICAgICAgICAgICAgIGlmIChlMS5jb2xsaXNpb24pIHtcbiAgICAgICAgICAgICAgICBlMS5jb2xsaXNpb24uZmlyZShcImNvbnRhY3RcIiwgcmV2ZXJzZVJlc3VsdCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbmV3Q29sbGlzaW9uID0gdGhpcy5fc3RvcmVDb2xsaXNpb24oZTEsIGUwKTtcbiAgICAgICAgICAgICAgaWYgKG5ld0NvbGxpc2lvbiAmJiBlMS5jb2xsaXNpb24pIHtcbiAgICAgICAgICAgICAgICBlMS5jb2xsaXNpb24uZmlyZShcImNvbGxpc2lvbnN0YXJ0XCIsIHJldmVyc2VSZXN1bHQpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2NsZWFuT2xkQ29sbGlzaW9ucygpO1xuICAgIHRoaXMuY29udGFjdFBvaW50UG9vbC5mcmVlQWxsKCk7XG4gICAgdGhpcy5jb250YWN0UmVzdWx0UG9vbC5mcmVlQWxsKCk7XG4gICAgdGhpcy5zaW5nbGVDb250YWN0UmVzdWx0UG9vbC5mcmVlQWxsKCk7XG4gIH19KTtcbiAgcmV0dXJuIHtSSUdJREJPRFlfVFlQRV9TVEFUSUM6XCJzdGF0aWNcIiwgUklHSURCT0RZX1RZUEVfRFlOQU1JQzpcImR5bmFtaWNcIiwgUklHSURCT0RZX1RZUEVfS0lORU1BVElDOlwia2luZW1hdGljXCIsIFJJR0lEQk9EWV9DRl9TVEFUSUNfT0JKRUNUOjEsIFJJR0lEQk9EWV9DRl9LSU5FTUFUSUNfT0JKRUNUOjIsIFJJR0lEQk9EWV9DRl9OT1JFU1BPTlNFX09CSkVDVDo0LCBSSUdJREJPRFlfQUNUSVZFX1RBRzoxLCBSSUdJREJPRFlfSVNMQU5EX1NMRUVQSU5HOjIsIFJJR0lEQk9EWV9XQU5UU19ERUFDVElWQVRJT046MywgUklHSURCT0RZX0RJU0FCTEVfREVBQ1RJVkFUSU9OOjQsIFJJR0lEQk9EWV9ESVNBQkxFX1NJTVVMQVRJT046NSwgUmlnaWRCb2R5Q29tcG9uZW50U3lzdGVtOlJpZ2lkQm9keUNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFJpZ2lkQm9keUNvbXBvbmVudERhdGEgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICAgIHRoaXMubWFzcyA9IDE7XG4gICAgdGhpcy5saW5lYXJEYW1waW5nID0gMDtcbiAgICB0aGlzLmFuZ3VsYXJEYW1waW5nID0gMDtcbiAgICB0aGlzLmxpbmVhckZhY3RvciA9IG5ldyBwYy5WZWMzKDEsIDEsIDEpO1xuICAgIHRoaXMuYW5ndWxhckZhY3RvciA9IG5ldyBwYy5WZWMzKDEsIDEsIDEpO1xuICAgIHRoaXMuZnJpY3Rpb24gPSAwLjU7XG4gICAgdGhpcy5yZXN0aXR1dGlvbiA9IDA7XG4gICAgdGhpcy50eXBlID0gcGMuQk9EWVRZUEVfU1RBVElDO1xuICAgIHRoaXMuZ3JvdXAgPSBwYy5CT0RZR1JPVVBfU1RBVElDO1xuICAgIHRoaXMubWFzayA9IHBjLkJPRFlNQVNLX05PVF9TVEFUSUM7XG4gICAgdGhpcy5ib2R5ID0gbnVsbDtcbiAgICB0aGlzLnNpbXVsYXRpb25FbmFibGVkID0gZmFsc2U7XG4gIH07XG4gIFJpZ2lkQm9keUNvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhSaWdpZEJvZHlDb21wb25lbnREYXRhLCBwYy5Db21wb25lbnREYXRhKTtcbiAgcmV0dXJuIHtSaWdpZEJvZHlDb21wb25lbnREYXRhOlJpZ2lkQm9keUNvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBhbW1vVmVjMSwgYW1tb1F1YXQ7XG4gIHZhciBUcmlnZ2VyID0gZnVuY3Rpb24gVHJpZ2dlcihhcHAsIGNvbXBvbmVudCwgZGF0YSkge1xuICAgIHRoaXMuZW50aXR5ID0gY29tcG9uZW50LmVudGl0eTtcbiAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICBpZiAodHlwZW9mIEFtbW8gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGFtbW9WZWMxID0gbmV3IEFtbW8uYnRWZWN0b3IzO1xuICAgICAgYW1tb1F1YXQgPSBuZXcgQW1tby5idFF1YXRlcm5pb247XG4gICAgfVxuICAgIHRoaXMuaW5pdGlhbGl6ZShkYXRhKTtcbiAgfTtcbiAgVHJpZ2dlci5wcm90b3R5cGUgPSB7aW5pdGlhbGl6ZTpmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIGVudGl0eSA9IHRoaXMuZW50aXR5O1xuICAgIHZhciBzaGFwZSA9IGRhdGEuc2hhcGU7XG4gICAgaWYgKHNoYXBlICYmIHR5cGVvZiBBbW1vICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBpZiAoZW50aXR5LnRyaWdnZXIpIHtcbiAgICAgICAgZW50aXR5LnRyaWdnZXIuZGVzdHJveSgpO1xuICAgICAgfVxuICAgICAgdmFyIG1hc3MgPSAxO1xuICAgICAgdmFyIGxvY2FsSW5lcnRpYSA9IG5ldyBBbW1vLmJ0VmVjdG9yMygwLCAwLCAwKTtcbiAgICAgIHNoYXBlLmNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCBsb2NhbEluZXJ0aWEpO1xuICAgICAgdmFyIHBvcyA9IGVudGl0eS5nZXRQb3NpdGlvbigpO1xuICAgICAgdmFyIHJvdCA9IGVudGl0eS5nZXRSb3RhdGlvbigpO1xuICAgICAgYW1tb1F1YXQuc2V0VmFsdWUocm90LngsIHJvdC55LCByb3Queiwgcm90LncpO1xuICAgICAgdmFyIHN0YXJ0VHJhbnNmb3JtID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm07XG4gICAgICBzdGFydFRyYW5zZm9ybS5zZXRJZGVudGl0eSgpO1xuICAgICAgc3RhcnRUcmFuc2Zvcm0uZ2V0T3JpZ2luKCkuc2V0VmFsdWUocG9zLngsIHBvcy55LCBwb3Mueik7XG4gICAgICBzdGFydFRyYW5zZm9ybS5zZXRSb3RhdGlvbihhbW1vUXVhdCk7XG4gICAgICB2YXIgbW90aW9uU3RhdGUgPSBuZXcgQW1tby5idERlZmF1bHRNb3Rpb25TdGF0ZShzdGFydFRyYW5zZm9ybSk7XG4gICAgICB2YXIgYm9keUluZm8gPSBuZXcgQW1tby5idFJpZ2lkQm9keUNvbnN0cnVjdGlvbkluZm8obWFzcywgbW90aW9uU3RhdGUsIHNoYXBlLCBsb2NhbEluZXJ0aWEpO1xuICAgICAgdmFyIGJvZHkgPSBuZXcgQW1tby5idFJpZ2lkQm9keShib2R5SW5mbyk7XG4gICAgICB0aGlzLmJvZHkgPSBib2R5O1xuICAgICAgYm9keS5zZXRSZXN0aXR1dGlvbigwKTtcbiAgICAgIGJvZHkuc2V0RnJpY3Rpb24oMCk7XG4gICAgICBib2R5LnNldERhbXBpbmcoMCwgMCk7XG4gICAgICBhbW1vVmVjMS5zZXRWYWx1ZSgwLCAwLCAwKTtcbiAgICAgIGJvZHkuc2V0TGluZWFyRmFjdG9yKGFtbW9WZWMxKTtcbiAgICAgIGJvZHkuc2V0QW5ndWxhckZhY3RvcihhbW1vVmVjMSk7XG4gICAgICBib2R5LnNldENvbGxpc2lvbkZsYWdzKGJvZHkuZ2V0Q29sbGlzaW9uRmxhZ3MoKSB8IHBjLkJPRFlGTEFHX05PUkVTUE9OU0VfT0JKRUNUKTtcbiAgICAgIGJvZHkuZW50aXR5ID0gZW50aXR5O1xuICAgICAgaWYgKHRoaXMuY29tcG9uZW50LmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5lbmFibGUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIGRlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuYm9keSkge1xuICAgICAgdGhpcy5hcHAuc3lzdGVtcy5yaWdpZGJvZHkucmVtb3ZlQm9keSh0aGlzLmJvZHkpO1xuICAgIH1cbiAgfSwgc3luY0VudGl0eVRvQm9keTpmdW5jdGlvbigpIHtcbiAgICB2YXIgYm9keSA9IHRoaXMuYm9keTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgdmFyIHBvc2l0aW9uID0gdGhpcy5lbnRpdHkuZ2V0UG9zaXRpb24oKTtcbiAgICAgIHZhciByb3RhdGlvbiA9IHRoaXMuZW50aXR5LmdldFJvdGF0aW9uKCk7XG4gICAgICB2YXIgdHJhbnNmb3JtID0gYm9keS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgdHJhbnNmb3JtLmdldE9yaWdpbigpLnNldFZhbHVlKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHBvc2l0aW9uLnopO1xuICAgICAgYW1tb1F1YXQuc2V0VmFsdWUocm90YXRpb24ueCwgcm90YXRpb24ueSwgcm90YXRpb24ueiwgcm90YXRpb24udyk7XG4gICAgICB0cmFuc2Zvcm0uc2V0Um90YXRpb24oYW1tb1F1YXQpO1xuICAgICAgYm9keS5hY3RpdmF0ZSgpO1xuICAgIH1cbiAgfSwgZW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIHZhciBib2R5ID0gdGhpcy5ib2R5O1xuICAgIGlmICghYm9keSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFwcC5zeXN0ZW1zLnJpZ2lkYm9keS5hZGRCb2R5KGJvZHksIHBjLkJPRFlHUk9VUF9UUklHR0VSLCBwYy5CT0RZTUFTS19OT1RfU1RBVElDIF4gcGMuQk9EWUdST1VQX1RSSUdHRVIpO1xuICAgIGJvZHkuZm9yY2VBY3RpdmF0aW9uU3RhdGUocGMuQk9EWVNUQVRFX0FDVElWRV9UQUcpO1xuICAgIGJvZHkuYWN0aXZhdGUoKTtcbiAgICB0aGlzLnN5bmNFbnRpdHlUb0JvZHkoKTtcbiAgfSwgZGlzYWJsZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgYm9keSA9IHRoaXMuYm9keTtcbiAgICBpZiAoIWJvZHkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5hcHAuc3lzdGVtcy5yaWdpZGJvZHkucmVtb3ZlQm9keShib2R5KTtcbiAgICBib2R5LmZvcmNlQWN0aXZhdGlvblN0YXRlKHBjLkJPRFlTVEFURV9ESVNBQkxFX1NJTVVMQVRJT04pO1xuICB9fTtcbiAgcmV0dXJuIHtUcmlnZ2VyOlRyaWdnZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDb2xsaXNpb25Db21wb25lbnQgPSBmdW5jdGlvbiBDb2xsaXNpb25Db21wb25lbnQoc3lzdGVtLCBlbnRpdHkpIHtcbiAgICB0aGlzLm9uKFwic2V0X3R5cGVcIiwgdGhpcy5vblNldFR5cGUsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfaGFsZkV4dGVudHNcIiwgdGhpcy5vblNldEhhbGZFeHRlbnRzLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X3JhZGl1c1wiLCB0aGlzLm9uU2V0UmFkaXVzLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2hlaWdodFwiLCB0aGlzLm9uU2V0SGVpZ2h0LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2F4aXNcIiwgdGhpcy5vblNldEF4aXMsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfYXNzZXRcIiwgdGhpcy5vblNldEFzc2V0LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X21vZGVsXCIsIHRoaXMub25TZXRNb2RlbCwgdGhpcyk7XG4gIH07XG4gIENvbGxpc2lvbkNvbXBvbmVudCA9IHBjLmluaGVyaXRzKENvbGxpc2lvbkNvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKENvbGxpc2lvbkNvbXBvbmVudC5wcm90b3R5cGUsIHtvblNldFR5cGU6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkge1xuICAgICAgdGhpcy5zeXN0ZW0uY2hhbmdlVHlwZSh0aGlzLCBvbGRWYWx1ZSwgbmV3VmFsdWUpO1xuICAgIH1cbiAgfSwgb25TZXRIYWxmRXh0ZW50czpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAodGhpcy5kYXRhLmluaXRpYWxpemVkICYmIHRoaXMuZGF0YS50eXBlID09PSBcImJveFwiKSB7XG4gICAgICB0aGlzLnN5c3RlbS5yZWNyZWF0ZVBoeXNpY2FsU2hhcGVzKHRoaXMpO1xuICAgIH1cbiAgfSwgb25TZXRSYWRpdXM6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZGF0YS5pbml0aWFsaXplZCAmJiAodGhpcy5kYXRhLnR5cGUgPT09IFwic3BoZXJlXCIgfHwgdGhpcy5kYXRhLnR5cGUgPT09IFwiY2Fwc3VsZVwiIHx8IHRoaXMuZGF0YS50eXBlID09PSBcImN5bGluZGVyXCIpKSB7XG4gICAgICB0aGlzLnN5c3RlbS5yZWNyZWF0ZVBoeXNpY2FsU2hhcGVzKHRoaXMpO1xuICAgIH1cbiAgfSwgb25TZXRIZWlnaHQ6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZGF0YS5pbml0aWFsaXplZCAmJiAodGhpcy5kYXRhLnR5cGUgPT09IFwiY2Fwc3VsZVwiIHx8IHRoaXMuZGF0YS50eXBlID09PSBcImN5bGluZGVyXCIpKSB7XG4gICAgICB0aGlzLnN5c3RlbS5yZWNyZWF0ZVBoeXNpY2FsU2hhcGVzKHRoaXMpO1xuICAgIH1cbiAgfSwgb25TZXRBeGlzOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmICh0aGlzLmRhdGEuaW5pdGlhbGl6ZWQgJiYgKHRoaXMuZGF0YS50eXBlID09PSBcImNhcHN1bGVcIiB8fCB0aGlzLmRhdGEudHlwZSA9PT0gXCJjeWxpbmRlclwiKSkge1xuICAgICAgdGhpcy5zeXN0ZW0ucmVjcmVhdGVQaHlzaWNhbFNoYXBlcyh0aGlzKTtcbiAgICB9XG4gIH0sIG9uU2V0QXNzZXQ6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBhc3NldDtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cztcbiAgICBpZiAob2xkVmFsdWUpIHtcbiAgICAgIGFzc2V0ID0gYXNzZXRzLmdldChvbGRWYWx1ZSk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAobmV3VmFsdWUpIHtcbiAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICAgIHRoaXMuZGF0YS5hc3NldCA9IG5ld1ZhbHVlLmlkO1xuICAgICAgfVxuICAgICAgYXNzZXQgPSBhc3NldHMuZ2V0KHRoaXMuZGF0YS5hc3NldCk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgICAgICBhc3NldC5vbihcInJlbW92ZVwiLCB0aGlzLm9uQXNzZXRSZW1vdmVkLCB0aGlzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuZGF0YS5pbml0aWFsaXplZCAmJiB0aGlzLmRhdGEudHlwZSA9PT0gXCJtZXNoXCIpIHtcbiAgICAgIGlmICghbmV3VmFsdWUpIHtcbiAgICAgICAgdGhpcy5kYXRhLm1vZGVsID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3lzdGVtLnJlY3JlYXRlUGh5c2ljYWxTaGFwZXModGhpcyk7XG4gICAgfVxuICB9LCBvblNldE1vZGVsOmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmICh0aGlzLmRhdGEuaW5pdGlhbGl6ZWQgJiYgdGhpcy5kYXRhLnR5cGUgPT09IFwibWVzaFwiKSB7XG4gICAgICB0aGlzLnN5c3RlbS5pbXBsZW1lbnRhdGlvbnMubWVzaC5kb1JlY3JlYXRlUGh5c2ljYWxTaGFwZSh0aGlzKTtcbiAgICB9XG4gIH0sIG9uQXNzZXRSZW1vdmVkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgYXNzZXQub2ZmKFwicmVtb3ZlXCIsIHRoaXMub25Bc3NldFJlbW92ZWQsIHRoaXMpO1xuICAgIGlmICh0aGlzLmRhdGEuYXNzZXQgPT09IGFzc2V0LmlkKSB7XG4gICAgICB0aGlzLmFzc2V0ID0gbnVsbDtcbiAgICB9XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIENvbGxpc2lvbkNvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgICBpZiAodGhpcy5kYXRhLnR5cGUgPT09IFwibWVzaFwiICYmIHRoaXMuZGF0YS5hc3NldCAmJiB0aGlzLmRhdGEuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHZhciBhc3NldCA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHMuZ2V0KHRoaXMuZGF0YS5hc3NldCk7XG4gICAgICBpZiAoYXNzZXQgJiYgKCFhc3NldC5yZXNvdXJjZSB8fCAhdGhpcy5kYXRhLnNoYXBlKSkge1xuICAgICAgICB0aGlzLnN5c3RlbS5yZWNyZWF0ZVBoeXNpY2FsU2hhcGVzKHRoaXMpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmVudGl0eS50cmlnZ2VyKSB7XG4gICAgICB0aGlzLmVudGl0eS50cmlnZ2VyLmVuYWJsZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5lbnRpdHkucmlnaWRib2R5KSB7XG4gICAgICAgIGlmICh0aGlzLmVudGl0eS5yaWdpZGJvZHkuZW5hYmxlZCkge1xuICAgICAgICAgIHRoaXMuZW50aXR5LnJpZ2lkYm9keS5lbmFibGVTaW11bGF0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uRGlzYWJsZTpmdW5jdGlvbigpIHtcbiAgICBDb2xsaXNpb25Db21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIGlmICh0aGlzLmVudGl0eS50cmlnZ2VyKSB7XG4gICAgICB0aGlzLmVudGl0eS50cmlnZ2VyLmRpc2FibGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuZW50aXR5LnJpZ2lkYm9keSkge1xuICAgICAgICB0aGlzLmVudGl0eS5yaWdpZGJvZHkuZGlzYWJsZVNpbXVsYXRpb24oKTtcbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtDb2xsaXNpb25Db21wb25lbnQ6Q29sbGlzaW9uQ29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3NjaGVtYSA9IFtcImVuYWJsZWRcIiwgXCJ0eXBlXCIsIFwiaGFsZkV4dGVudHNcIiwgXCJyYWRpdXNcIiwgXCJheGlzXCIsIFwiaGVpZ2h0XCIsIFwiYXNzZXRcIiwgXCJzaGFwZVwiLCBcIm1vZGVsXCJdO1xuICB2YXIgQ29sbGlzaW9uQ29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24gQ29sbGlzaW9uQ29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcImNvbGxpc2lvblwiO1xuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBcIlNwZWNpZmllcyBhIGNvbGxpc2lvbiB2b2x1bWUuXCI7XG4gICAgYXBwLnN5c3RlbXMuYWRkKHRoaXMuaWQsIHRoaXMpO1xuICAgIHRoaXMuQ29tcG9uZW50VHlwZSA9IHBjLkNvbGxpc2lvbkNvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuQ29sbGlzaW9uQ29tcG9uZW50RGF0YTtcbiAgICB0aGlzLnNjaGVtYSA9IF9zY2hlbWE7XG4gICAgdGhpcy5pbXBsZW1lbnRhdGlvbnMgPSB7fTtcbiAgICB0aGlzLm9uKFwicmVtb3ZlXCIsIHRoaXMub25SZW1vdmUsIHRoaXMpO1xuICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vbihcInVwZGF0ZVwiLCB0aGlzLm9uVXBkYXRlLCB0aGlzKTtcbiAgfTtcbiAgQ29sbGlzaW9uQ29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoQ29sbGlzaW9uQ29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLkNvbGxpc2lvbkNvbXBvbmVudC5wcm90b3R5cGUsIF9zY2hlbWEpO1xuICBDb2xsaXNpb25Db21wb25lbnRTeXN0ZW0ucHJvdG90eXBlID0gcGMuZXh0ZW5kKENvbGxpc2lvbkNvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtvbkxpYnJhcnlMb2FkZWQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHR5cGVvZiBBbW1vICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vZmYoXCJ1cGRhdGVcIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gICAgfVxuICB9LCBpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIF9kYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgdmFyIGlkeDtcbiAgICB2YXIgZGF0YSA9IHt9O1xuICAgIHByb3BlcnRpZXMgPSBbXCJ0eXBlXCIsIFwiaGFsZkV4dGVudHNcIiwgXCJyYWRpdXNcIiwgXCJheGlzXCIsIFwiaGVpZ2h0XCIsIFwic2hhcGVcIiwgXCJtb2RlbFwiLCBcImFzc2V0XCIsIFwiZW5hYmxlZFwiXTtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgZGF0YVtwcm9wXSA9IF9kYXRhW3Byb3BdO1xuICAgIH0pO1xuICAgIGlmIChfZGF0YS5oYXNPd25Qcm9wZXJ0eShcImFzc2V0XCIpKSB7XG4gICAgICBpZHggPSBwcm9wZXJ0aWVzLmluZGV4T2YoXCJtb2RlbFwiKTtcbiAgICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICAgIHByb3BlcnRpZXMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChfZGF0YS5oYXNPd25Qcm9wZXJ0eShcIm1vZGVsXCIpKSB7XG4gICAgICAgIGlkeCA9IHByb3BlcnRpZXMuaW5kZXhPZihcImFzc2V0XCIpO1xuICAgICAgICBpZiAoaWR4ICE9PSAtMSkge1xuICAgICAgICAgIHByb3BlcnRpZXMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFkYXRhLnR5cGUpIHtcbiAgICAgIGRhdGEudHlwZSA9IGNvbXBvbmVudC5kYXRhLnR5cGU7XG4gICAgfVxuICAgIGNvbXBvbmVudC5kYXRhLnR5cGUgPSBkYXRhLnR5cGU7XG4gICAgaWYgKGRhdGEuaGFsZkV4dGVudHMgJiYgcGMudHlwZShkYXRhLmhhbGZFeHRlbnRzKSA9PT0gXCJhcnJheVwiKSB7XG4gICAgICBkYXRhLmhhbGZFeHRlbnRzID0gbmV3IHBjLlZlYzMoZGF0YS5oYWxmRXh0ZW50c1swXSwgZGF0YS5oYWxmRXh0ZW50c1sxXSwgZGF0YS5oYWxmRXh0ZW50c1syXSk7XG4gICAgfVxuICAgIHZhciBpbXBsID0gdGhpcy5fY3JlYXRlSW1wbGVtZW50YXRpb24oZGF0YS50eXBlKTtcbiAgICBpbXBsLmJlZm9yZUluaXRpYWxpemUoY29tcG9uZW50LCBkYXRhKTtcbiAgICBDb2xsaXNpb25Db21wb25lbnRTeXN0ZW0uX3N1cGVyLmluaXRpYWxpemVDb21wb25lbnREYXRhLmNhbGwodGhpcy5zeXN0ZW0sIGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcyk7XG4gICAgaW1wbC5hZnRlckluaXRpYWxpemUoY29tcG9uZW50LCBkYXRhKTtcbiAgfSwgX2NyZWF0ZUltcGxlbWVudGF0aW9uOmZ1bmN0aW9uKHR5cGUpIHtcbiAgICBpZiAodGhpcy5pbXBsZW1lbnRhdGlvbnNbdHlwZV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFyIGltcGw7XG4gICAgICBzd2l0Y2godHlwZSkge1xuICAgICAgICBjYXNlIFwiYm94XCI6XG4gICAgICAgICAgaW1wbCA9IG5ldyBDb2xsaXNpb25Cb3hTeXN0ZW1JbXBsKHRoaXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwic3BoZXJlXCI6XG4gICAgICAgICAgaW1wbCA9IG5ldyBDb2xsaXNpb25TcGhlcmVTeXN0ZW1JbXBsKHRoaXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiY2Fwc3VsZVwiOlxuICAgICAgICAgIGltcGwgPSBuZXcgQ29sbGlzaW9uQ2Fwc3VsZVN5c3RlbUltcGwodGhpcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJjeWxpbmRlclwiOlxuICAgICAgICAgIGltcGwgPSBuZXcgQ29sbGlzaW9uQ3lsaW5kZXJTeXN0ZW1JbXBsKHRoaXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwibWVzaFwiOlxuICAgICAgICAgIGltcGwgPSBuZXcgQ29sbGlzaW9uTWVzaFN5c3RlbUltcGwodGhpcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgXCJJbnZhbGlkIGNvbGxpc2lvbiBzeXN0ZW0gdHlwZTogXCIgKyB0eXBlO1xuICAgICAgfVxuICAgICAgdGhpcy5pbXBsZW1lbnRhdGlvbnNbdHlwZV0gPSBpbXBsO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5pbXBsZW1lbnRhdGlvbnNbdHlwZV07XG4gIH0sIF9nZXRJbXBsZW1lbnRhdGlvbjpmdW5jdGlvbihlbnRpdHkpIHtcbiAgICByZXR1cm4gdGhpcy5pbXBsZW1lbnRhdGlvbnNbZW50aXR5LmNvbGxpc2lvbi5kYXRhLnR5cGVdO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldEltcGxlbWVudGF0aW9uKGVudGl0eSkuY2xvbmUoZW50aXR5LCBjbG9uZSk7XG4gIH0sIG9uUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgZGF0YSkge1xuICAgIHRoaXMuaW1wbGVtZW50YXRpb25zW2RhdGEudHlwZV0ucmVtb3ZlKGVudGl0eSwgZGF0YSk7XG4gIH0sIG9uVXBkYXRlOmZ1bmN0aW9uKGR0KSB7XG4gICAgdmFyIGlkLCBlbnRpdHksIGRhdGE7XG4gICAgdmFyIGNvbXBvbmVudHMgPSB0aGlzLnN0b3JlO1xuICAgIGZvciAoaWQgaW4gY29tcG9uZW50cykge1xuICAgICAgZW50aXR5ID0gY29tcG9uZW50c1tpZF0uZW50aXR5O1xuICAgICAgZGF0YSA9IGNvbXBvbmVudHNbaWRdLmRhdGE7XG4gICAgICBpZiAoZGF0YS5lbmFibGVkICYmIGVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgIGlmICghZW50aXR5LnJpZ2lkYm9keSAmJiBlbnRpdHkudHJpZ2dlcikge1xuICAgICAgICAgIGVudGl0eS50cmlnZ2VyLnN5bmNFbnRpdHlUb0JvZHkoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgb25UcmFuc2Zvcm1DaGFuZ2VkOmZ1bmN0aW9uKGNvbXBvbmVudCwgcG9zaXRpb24sIHJvdGF0aW9uLCBzY2FsZSkge1xuICAgIHRoaXMuaW1wbGVtZW50YXRpb25zW2NvbXBvbmVudC5kYXRhLnR5cGVdLnVwZGF0ZVRyYW5zZm9ybShjb21wb25lbnQsIHBvc2l0aW9uLCByb3RhdGlvbiwgc2NhbGUpO1xuICB9LCBjaGFuZ2VUeXBlOmZ1bmN0aW9uKGNvbXBvbmVudCwgcHJldmlvdXNUeXBlLCBuZXdUeXBlKSB7XG4gICAgdGhpcy5pbXBsZW1lbnRhdGlvbnNbcHJldmlvdXNUeXBlXS5yZW1vdmUoY29tcG9uZW50LmVudGl0eSwgY29tcG9uZW50LmRhdGEpO1xuICAgIHRoaXMuX2NyZWF0ZUltcGxlbWVudGF0aW9uKG5ld1R5cGUpLnJlc2V0KGNvbXBvbmVudCwgY29tcG9uZW50LmRhdGEpO1xuICB9LCByZWNyZWF0ZVBoeXNpY2FsU2hhcGVzOmZ1bmN0aW9uKGNvbXBvbmVudCkge1xuICAgIHRoaXMuaW1wbGVtZW50YXRpb25zW2NvbXBvbmVudC5kYXRhLnR5cGVdLnJlY3JlYXRlUGh5c2ljYWxTaGFwZXMoY29tcG9uZW50KTtcbiAgfX0pO1xuICB2YXIgQ29sbGlzaW9uU3lzdGVtSW1wbCA9IGZ1bmN0aW9uKHN5c3RlbSkge1xuICAgIHRoaXMuc3lzdGVtID0gc3lzdGVtO1xuICB9O1xuICBDb2xsaXNpb25TeXN0ZW1JbXBsLnByb3RvdHlwZSA9IHtiZWZvcmVJbml0aWFsaXplOmZ1bmN0aW9uKGNvbXBvbmVudCwgZGF0YSkge1xuICAgIGRhdGEuc2hhcGUgPSB0aGlzLmNyZWF0ZVBoeXNpY2FsU2hhcGUoY29tcG9uZW50LmVudGl0eSwgZGF0YSk7XG4gICAgZGF0YS5tb2RlbCA9IG5ldyBwYy5Nb2RlbDtcbiAgICBkYXRhLm1vZGVsLmdyYXBoID0gbmV3IHBjLkdyYXBoTm9kZTtcbiAgfSwgYWZ0ZXJJbml0aWFsaXplOmZ1bmN0aW9uKGNvbXBvbmVudCwgZGF0YSkge1xuICAgIHRoaXMucmVjcmVhdGVQaHlzaWNhbFNoYXBlcyhjb21wb25lbnQpO1xuICAgIGNvbXBvbmVudC5kYXRhLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfSwgcmVzZXQ6ZnVuY3Rpb24oY29tcG9uZW50LCBkYXRhKSB7XG4gICAgdGhpcy5iZWZvcmVJbml0aWFsaXplKGNvbXBvbmVudCwgZGF0YSk7XG4gICAgdGhpcy5hZnRlckluaXRpYWxpemUoY29tcG9uZW50LCBkYXRhKTtcbiAgfSwgcmVjcmVhdGVQaHlzaWNhbFNoYXBlczpmdW5jdGlvbihjb21wb25lbnQpIHtcbiAgICB2YXIgZW50aXR5ID0gY29tcG9uZW50LmVudGl0eTtcbiAgICB2YXIgZGF0YSA9IGNvbXBvbmVudC5kYXRhO1xuICAgIGlmICh0eXBlb2YgQW1tbyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgZGF0YS5zaGFwZSA9IHRoaXMuY3JlYXRlUGh5c2ljYWxTaGFwZShjb21wb25lbnQuZW50aXR5LCBkYXRhKTtcbiAgICAgIGlmIChlbnRpdHkucmlnaWRib2R5KSB7XG4gICAgICAgIGVudGl0eS5yaWdpZGJvZHkuZGlzYWJsZVNpbXVsYXRpb24oKTtcbiAgICAgICAgZW50aXR5LnJpZ2lkYm9keS5jcmVhdGVCb2R5KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIWVudGl0eS50cmlnZ2VyKSB7XG4gICAgICAgICAgZW50aXR5LnRyaWdnZXIgPSBuZXcgcGMuVHJpZ2dlcih0aGlzLnN5c3RlbS5hcHAsIGNvbXBvbmVudCwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZW50aXR5LnRyaWdnZXIuaW5pdGlhbGl6ZShkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSwgY3JlYXRlUGh5c2ljYWxTaGFwZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9LCB1cGRhdGVUcmFuc2Zvcm06ZnVuY3Rpb24oY29tcG9uZW50LCBwb3NpdGlvbiwgcm90YXRpb24sIHNjYWxlKSB7XG4gICAgaWYgKGNvbXBvbmVudC5lbnRpdHkudHJpZ2dlcikge1xuICAgICAgY29tcG9uZW50LmVudGl0eS50cmlnZ2VyLnN5bmNFbnRpdHlUb0JvZHkoKTtcbiAgICB9XG4gIH0sIHJlbW92ZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICB2YXIgYXBwID0gdGhpcy5zeXN0ZW0uYXBwO1xuICAgIGlmIChlbnRpdHkucmlnaWRib2R5ICYmIGVudGl0eS5yaWdpZGJvZHkuYm9keSkge1xuICAgICAgYXBwLnN5c3RlbXMucmlnaWRib2R5LnJlbW92ZUJvZHkoZW50aXR5LnJpZ2lkYm9keS5ib2R5KTtcbiAgICAgIGVudGl0eS5yaWdpZGJvZHkuZGlzYWJsZVNpbXVsYXRpb24oKTtcbiAgICB9XG4gICAgaWYgKGVudGl0eS50cmlnZ2VyKSB7XG4gICAgICBlbnRpdHkudHJpZ2dlci5kZXN0cm95KCk7XG4gICAgICBkZWxldGUgZW50aXR5LnRyaWdnZXI7XG4gICAgfVxuICAgIGlmIChhcHAuc2NlbmUuY29udGFpbnNNb2RlbChkYXRhLm1vZGVsKSkge1xuICAgICAgYXBwLnJvb3QucmVtb3ZlQ2hpbGQoZGF0YS5tb2RlbC5ncmFwaCk7XG4gICAgICBhcHAuc2NlbmUucmVtb3ZlTW9kZWwoZGF0YS5tb2RlbCk7XG4gICAgfVxuICB9LCBjbG9uZTpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIHNyYyA9IHRoaXMuc3lzdGVtLmRhdGFTdG9yZVtlbnRpdHkuX2d1aWRdO1xuICAgIHZhciBkYXRhID0ge2VuYWJsZWQ6c3JjLmRhdGEuZW5hYmxlZCwgdHlwZTpzcmMuZGF0YS50eXBlLCBoYWxmRXh0ZW50czpbc3JjLmRhdGEuaGFsZkV4dGVudHMueCwgc3JjLmRhdGEuaGFsZkV4dGVudHMueSwgc3JjLmRhdGEuaGFsZkV4dGVudHMuel0sIHJhZGl1czpzcmMuZGF0YS5yYWRpdXMsIGF4aXM6c3JjLmRhdGEuYXhpcywgaGVpZ2h0OnNyYy5kYXRhLmhlaWdodCwgYXNzZXQ6c3JjLmRhdGEuYXNzZXQsIG1vZGVsOnNyYy5kYXRhLm1vZGVsfTtcbiAgICByZXR1cm4gdGhpcy5zeXN0ZW0uYWRkQ29tcG9uZW50KGNsb25lLCBkYXRhKTtcbiAgfX07XG4gIHZhciBDb2xsaXNpb25Cb3hTeXN0ZW1JbXBsID0gZnVuY3Rpb24oc3lzdGVtKSB7XG4gIH07XG4gIENvbGxpc2lvbkJveFN5c3RlbUltcGwgPSBwYy5pbmhlcml0cyhDb2xsaXNpb25Cb3hTeXN0ZW1JbXBsLCBDb2xsaXNpb25TeXN0ZW1JbXBsKTtcbiAgQ29sbGlzaW9uQm94U3lzdGVtSW1wbC5wcm90b3R5cGUgPSBwYy5leHRlbmQoQ29sbGlzaW9uQm94U3lzdGVtSW1wbC5wcm90b3R5cGUsIHtjcmVhdGVQaHlzaWNhbFNoYXBlOmZ1bmN0aW9uKGVudGl0eSwgZGF0YSkge1xuICAgIGlmICh0eXBlb2YgQW1tbyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdmFyIGhlID0gZGF0YS5oYWxmRXh0ZW50cztcbiAgICAgIHZhciBhbW1vSGUgPSBuZXcgQW1tby5idFZlY3RvcjMoaGUgPyBoZS54IDogMC41LCBoZSA/IGhlLnkgOiAwLjUsIGhlID8gaGUueiA6IDAuNSk7XG4gICAgICByZXR1cm4gbmV3IEFtbW8uYnRCb3hTaGFwZShhbW1vSGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfX0pO1xuICB2YXIgQ29sbGlzaW9uU3BoZXJlU3lzdGVtSW1wbCA9IGZ1bmN0aW9uKHN5c3RlbSkge1xuICB9O1xuICBDb2xsaXNpb25TcGhlcmVTeXN0ZW1JbXBsID0gcGMuaW5oZXJpdHMoQ29sbGlzaW9uU3BoZXJlU3lzdGVtSW1wbCwgQ29sbGlzaW9uU3lzdGVtSW1wbCk7XG4gIENvbGxpc2lvblNwaGVyZVN5c3RlbUltcGwucHJvdG90eXBlID0gcGMuZXh0ZW5kKENvbGxpc2lvblNwaGVyZVN5c3RlbUltcGwucHJvdG90eXBlLCB7Y3JlYXRlUGh5c2ljYWxTaGFwZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICBpZiAodHlwZW9mIEFtbW8gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHJldHVybiBuZXcgQW1tby5idFNwaGVyZVNoYXBlKGRhdGEucmFkaXVzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH19KTtcbiAgdmFyIENvbGxpc2lvbkNhcHN1bGVTeXN0ZW1JbXBsID0gZnVuY3Rpb24oc3lzdGVtKSB7XG4gIH07XG4gIENvbGxpc2lvbkNhcHN1bGVTeXN0ZW1JbXBsID0gcGMuaW5oZXJpdHMoQ29sbGlzaW9uQ2Fwc3VsZVN5c3RlbUltcGwsIENvbGxpc2lvblN5c3RlbUltcGwpO1xuICBDb2xsaXNpb25DYXBzdWxlU3lzdGVtSW1wbC5wcm90b3R5cGUgPSBwYy5leHRlbmQoQ29sbGlzaW9uQ2Fwc3VsZVN5c3RlbUltcGwucHJvdG90eXBlLCB7Y3JlYXRlUGh5c2ljYWxTaGFwZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICB2YXIgc2hhcGUgPSBudWxsO1xuICAgIHZhciBheGlzID0gZGF0YS5heGlzICE9PSB1bmRlZmluZWQgPyBkYXRhLmF4aXMgOiAxO1xuICAgIHZhciByYWRpdXMgPSBkYXRhLnJhZGl1cyB8fCAwLjU7XG4gICAgdmFyIGhlaWdodCA9IE1hdGgubWF4KChkYXRhLmhlaWdodCB8fCAyKSAtIDIgKiByYWRpdXMsIDApO1xuICAgIGlmICh0eXBlb2YgQW1tbyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgc3dpdGNoKGF4aXMpIHtcbiAgICAgICAgY2FzZSAwOlxuICAgICAgICAgIHNoYXBlID0gbmV3IEFtbW8uYnRDYXBzdWxlU2hhcGVYKHJhZGl1cywgaGVpZ2h0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAxOlxuICAgICAgICAgIHNoYXBlID0gbmV3IEFtbW8uYnRDYXBzdWxlU2hhcGUocmFkaXVzLCBoZWlnaHQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgc2hhcGUgPSBuZXcgQW1tby5idENhcHN1bGVTaGFwZVoocmFkaXVzLCBoZWlnaHQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2hhcGU7XG4gIH19KTtcbiAgdmFyIENvbGxpc2lvbkN5bGluZGVyU3lzdGVtSW1wbCA9IGZ1bmN0aW9uKHN5c3RlbSkge1xuICB9O1xuICBDb2xsaXNpb25DeWxpbmRlclN5c3RlbUltcGwgPSBwYy5pbmhlcml0cyhDb2xsaXNpb25DeWxpbmRlclN5c3RlbUltcGwsIENvbGxpc2lvblN5c3RlbUltcGwpO1xuICBDb2xsaXNpb25DeWxpbmRlclN5c3RlbUltcGwucHJvdG90eXBlID0gcGMuZXh0ZW5kKENvbGxpc2lvbkN5bGluZGVyU3lzdGVtSW1wbC5wcm90b3R5cGUsIHtjcmVhdGVQaHlzaWNhbFNoYXBlOmZ1bmN0aW9uKGVudGl0eSwgZGF0YSkge1xuICAgIHZhciBoYWxmRXh0ZW50cyA9IG51bGw7XG4gICAgdmFyIHNoYXBlID0gbnVsbDtcbiAgICB2YXIgYXhpcyA9IGRhdGEuYXhpcyAhPT0gdW5kZWZpbmVkID8gZGF0YS5heGlzIDogMTtcbiAgICB2YXIgcmFkaXVzID0gZGF0YS5yYWRpdXMgIT09IHVuZGVmaW5lZCA/IGRhdGEucmFkaXVzIDogMC41O1xuICAgIHZhciBoZWlnaHQgPSBkYXRhLmhlaWdodCAhPT0gdW5kZWZpbmVkID8gZGF0YS5oZWlnaHQgOiAxO1xuICAgIGlmICh0eXBlb2YgQW1tbyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgc3dpdGNoKGF4aXMpIHtcbiAgICAgICAgY2FzZSAwOlxuICAgICAgICAgIGhhbGZFeHRlbnRzID0gbmV3IEFtbW8uYnRWZWN0b3IzKGhlaWdodCAqIDAuNSwgcmFkaXVzLCByYWRpdXMpO1xuICAgICAgICAgIHNoYXBlID0gbmV3IEFtbW8uYnRDeWxpbmRlclNoYXBlWChoYWxmRXh0ZW50cyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgMTpcbiAgICAgICAgICBoYWxmRXh0ZW50cyA9IG5ldyBBbW1vLmJ0VmVjdG9yMyhyYWRpdXMsIGhlaWdodCAqIDAuNSwgcmFkaXVzKTtcbiAgICAgICAgICBzaGFwZSA9IG5ldyBBbW1vLmJ0Q3lsaW5kZXJTaGFwZShoYWxmRXh0ZW50cyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgMjpcbiAgICAgICAgICBoYWxmRXh0ZW50cyA9IG5ldyBBbW1vLmJ0VmVjdG9yMyhyYWRpdXMsIHJhZGl1cywgaGVpZ2h0ICogMC41KTtcbiAgICAgICAgICBzaGFwZSA9IG5ldyBBbW1vLmJ0Q3lsaW5kZXJTaGFwZVooaGFsZkV4dGVudHMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2hhcGU7XG4gIH19KTtcbiAgdmFyIENvbGxpc2lvbk1lc2hTeXN0ZW1JbXBsID0gZnVuY3Rpb24oc3lzdGVtKSB7XG4gIH07XG4gIENvbGxpc2lvbk1lc2hTeXN0ZW1JbXBsID0gcGMuaW5oZXJpdHMoQ29sbGlzaW9uTWVzaFN5c3RlbUltcGwsIENvbGxpc2lvblN5c3RlbUltcGwpO1xuICBDb2xsaXNpb25NZXNoU3lzdGVtSW1wbC5wcm90b3R5cGUgPSBwYy5leHRlbmQoQ29sbGlzaW9uTWVzaFN5c3RlbUltcGwucHJvdG90eXBlLCB7YmVmb3JlSW5pdGlhbGl6ZTpmdW5jdGlvbihjb21wb25lbnQsIGRhdGEpIHtcbiAgfSwgY3JlYXRlUGh5c2ljYWxTaGFwZTpmdW5jdGlvbihlbnRpdHksIGRhdGEpIHtcbiAgICBpZiAodHlwZW9mIEFtbW8gIT09IFwidW5kZWZpbmVkXCIgJiYgZGF0YS5tb2RlbCkge1xuICAgICAgdmFyIG1vZGVsID0gZGF0YS5tb2RlbDtcbiAgICAgIHZhciBzaGFwZSA9IG5ldyBBbW1vLmJ0Q29tcG91bmRTaGFwZTtcbiAgICAgIHZhciBpLCBqO1xuICAgICAgZm9yIChpID0gMDtpIDwgbW9kZWwubWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIHZhciBtZXNoSW5zdGFuY2UgPSBtb2RlbC5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgICB2YXIgbWVzaCA9IG1lc2hJbnN0YW5jZS5tZXNoO1xuICAgICAgICB2YXIgaWIgPSBtZXNoLmluZGV4QnVmZmVyW3BjLlJFTkRFUlNUWUxFX1NPTElEXTtcbiAgICAgICAgdmFyIHZiID0gbWVzaC52ZXJ0ZXhCdWZmZXI7XG4gICAgICAgIHZhciBmb3JtYXQgPSB2Yi5nZXRGb3JtYXQoKTtcbiAgICAgICAgdmFyIHN0cmlkZSA9IGZvcm1hdC5zaXplIC8gNDtcbiAgICAgICAgdmFyIHBvc2l0aW9ucztcbiAgICAgICAgZm9yIChqID0gMDtqIDwgZm9ybWF0LmVsZW1lbnRzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICB2YXIgZWxlbWVudCA9IGZvcm1hdC5lbGVtZW50c1tqXTtcbiAgICAgICAgICBpZiAoZWxlbWVudC5uYW1lID09PSBwYy5TRU1BTlRJQ19QT1NJVElPTikge1xuICAgICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheSh2Yi5sb2NrKCksIGVsZW1lbnQub2Zmc2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoaWIubG9jaygpKTtcbiAgICAgICAgdmFyIG51bVRyaWFuZ2xlcyA9IG1lc2gucHJpbWl0aXZlWzBdLmNvdW50IC8gMztcbiAgICAgICAgdmFyIHYxID0gbmV3IEFtbW8uYnRWZWN0b3IzO1xuICAgICAgICB2YXIgdjIgPSBuZXcgQW1tby5idFZlY3RvcjM7XG4gICAgICAgIHZhciB2MyA9IG5ldyBBbW1vLmJ0VmVjdG9yMztcbiAgICAgICAgdmFyIGkxLCBpMiwgaTM7XG4gICAgICAgIHZhciBiYXNlID0gbWVzaC5wcmltaXRpdmVbMF0uYmFzZTtcbiAgICAgICAgdmFyIHRyaU1lc2ggPSBuZXcgQW1tby5idFRyaWFuZ2xlTWVzaDtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbnVtVHJpYW5nbGVzO2orKykge1xuICAgICAgICAgIGkxID0gaW5kaWNlc1tiYXNlICsgaiAqIDNdICogc3RyaWRlO1xuICAgICAgICAgIGkyID0gaW5kaWNlc1tiYXNlICsgaiAqIDMgKyAxXSAqIHN0cmlkZTtcbiAgICAgICAgICBpMyA9IGluZGljZXNbYmFzZSArIGogKiAzICsgMl0gKiBzdHJpZGU7XG4gICAgICAgICAgdjEuc2V0VmFsdWUocG9zaXRpb25zW2kxXSwgcG9zaXRpb25zW2kxICsgMV0sIHBvc2l0aW9uc1tpMSArIDJdKTtcbiAgICAgICAgICB2Mi5zZXRWYWx1ZShwb3NpdGlvbnNbaTJdLCBwb3NpdGlvbnNbaTIgKyAxXSwgcG9zaXRpb25zW2kyICsgMl0pO1xuICAgICAgICAgIHYzLnNldFZhbHVlKHBvc2l0aW9uc1tpM10sIHBvc2l0aW9uc1tpMyArIDFdLCBwb3NpdGlvbnNbaTMgKyAyXSk7XG4gICAgICAgICAgdHJpTWVzaC5hZGRUcmlhbmdsZSh2MSwgdjIsIHYzLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdXNlUXVhbnRpemVkQWFiYkNvbXByZXNzaW9uID0gdHJ1ZTtcbiAgICAgICAgdmFyIHRyaU1lc2hTaGFwZSA9IG5ldyBBbW1vLmJ0QnZoVHJpYW5nbGVNZXNoU2hhcGUodHJpTWVzaCwgdXNlUXVhbnRpemVkQWFiYkNvbXByZXNzaW9uKTtcbiAgICAgICAgdmFyIHd0bSA9IG1lc2hJbnN0YW5jZS5ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgICAgIHZhciBzY2wgPSB3dG0uZ2V0U2NhbGUoKTtcbiAgICAgICAgdHJpTWVzaFNoYXBlLnNldExvY2FsU2NhbGluZyhuZXcgQW1tby5idFZlY3RvcjMoc2NsLngsIHNjbC55LCBzY2wueikpO1xuICAgICAgICB2YXIgcG9zID0gbWVzaEluc3RhbmNlLm5vZGUuZ2V0UG9zaXRpb24oKTtcbiAgICAgICAgdmFyIHJvdCA9IG1lc2hJbnN0YW5jZS5ub2RlLmdldFJvdGF0aW9uKCk7XG4gICAgICAgIHZhciB0cmFuc2Zvcm0gPSBuZXcgQW1tby5idFRyYW5zZm9ybTtcbiAgICAgICAgdHJhbnNmb3JtLnNldElkZW50aXR5KCk7XG4gICAgICAgIHRyYW5zZm9ybS5nZXRPcmlnaW4oKS5zZXRWYWx1ZShwb3MueCwgcG9zLnksIHBvcy56KTtcbiAgICAgICAgdmFyIGFtbW9RdWF0ID0gbmV3IEFtbW8uYnRRdWF0ZXJuaW9uO1xuICAgICAgICBhbW1vUXVhdC5zZXRWYWx1ZShyb3QueCwgcm90LnksIHJvdC56LCByb3Qudyk7XG4gICAgICAgIHRyYW5zZm9ybS5zZXRSb3RhdGlvbihhbW1vUXVhdCk7XG4gICAgICAgIHNoYXBlLmFkZENoaWxkU2hhcGUodHJhbnNmb3JtLCB0cmlNZXNoU2hhcGUpO1xuICAgICAgfVxuICAgICAgdmFyIGVudGl0eVRyYW5zZm9ybSA9IGVudGl0eS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgdmFyIHNjYWxlID0gZW50aXR5VHJhbnNmb3JtLmdldFNjYWxlKCk7XG4gICAgICB2YXIgdmVjID0gbmV3IEFtbW8uYnRWZWN0b3IzO1xuICAgICAgdmVjLnNldFZhbHVlKHNjYWxlLngsIHNjYWxlLnksIHNjYWxlLnopO1xuICAgICAgc2hhcGUuc2V0TG9jYWxTY2FsaW5nKHZlYyk7XG4gICAgICByZXR1cm4gc2hhcGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9LCByZWNyZWF0ZVBoeXNpY2FsU2hhcGVzOmZ1bmN0aW9uKGNvbXBvbmVudCkge1xuICAgIHZhciBkYXRhID0gY29tcG9uZW50LmRhdGE7XG4gICAgaWYgKGRhdGEuYXNzZXQgIT09IG51bGwgJiYgY29tcG9uZW50LmVuYWJsZWQgJiYgY29tcG9uZW50LmVudGl0eS5lbmFibGVkKSB7XG4gICAgICB0aGlzLmxvYWRNb2RlbEFzc2V0KGNvbXBvbmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9SZWNyZWF0ZVBoeXNpY2FsU2hhcGUoY29tcG9uZW50KTtcbiAgICB9XG4gIH0sIGxvYWRNb2RlbEFzc2V0OmZ1bmN0aW9uKGNvbXBvbmVudCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgaWQgPSBjb21wb25lbnQuZGF0YS5hc3NldDtcbiAgICB2YXIgZGF0YSA9IGNvbXBvbmVudC5kYXRhO1xuICAgIHZhciBhc3NldHMgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIHZhciBhc3NldCA9IGFzc2V0cy5nZXQoaWQpO1xuICAgIGlmIChhc3NldCkge1xuICAgICAgYXNzZXQucmVhZHkoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgZGF0YS5tb2RlbCA9IGFzc2V0LnJlc291cmNlO1xuICAgICAgICBzZWxmLmRvUmVjcmVhdGVQaHlzaWNhbFNoYXBlKGNvbXBvbmVudCk7XG4gICAgICB9KTtcbiAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXNzZXRzLm9uY2UoXCJhZGQ6XCIgKyBpZCwgZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgYXNzZXQucmVhZHkoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICBkYXRhLm1vZGVsID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICAgICAgc2VsZi5kb1JlY3JlYXRlUGh5c2ljYWxTaGFwZShjb21wb25lbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LCBkb1JlY3JlYXRlUGh5c2ljYWxTaGFwZTpmdW5jdGlvbihjb21wb25lbnQpIHtcbiAgICB2YXIgZW50aXR5ID0gY29tcG9uZW50LmVudGl0eTtcbiAgICB2YXIgZGF0YSA9IGNvbXBvbmVudC5kYXRhO1xuICAgIGlmIChkYXRhLm1vZGVsKSB7XG4gICAgICBpZiAoZGF0YS5zaGFwZSkge1xuICAgICAgICBBbW1vLmRlc3Ryb3koZGF0YS5zaGFwZSk7XG4gICAgICB9XG4gICAgICBkYXRhLnNoYXBlID0gdGhpcy5jcmVhdGVQaHlzaWNhbFNoYXBlKGVudGl0eSwgZGF0YSk7XG4gICAgICBpZiAoZW50aXR5LnJpZ2lkYm9keSkge1xuICAgICAgICBlbnRpdHkucmlnaWRib2R5LmNyZWF0ZUJvZHkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghZW50aXR5LnRyaWdnZXIpIHtcbiAgICAgICAgICBlbnRpdHkudHJpZ2dlciA9IG5ldyBwYy5UcmlnZ2VyKHRoaXMuc3lzdGVtLmFwcCwgY29tcG9uZW50LCBkYXRhKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBlbnRpdHkudHJpZ2dlci5pbml0aWFsaXplKGRhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVtb3ZlKGVudGl0eSwgZGF0YSk7XG4gICAgfVxuICB9LCB1cGRhdGVUcmFuc2Zvcm06ZnVuY3Rpb24oY29tcG9uZW50LCBwb3NpdGlvbiwgcm90YXRpb24sIHNjYWxlKSB7XG4gICAgaWYgKGNvbXBvbmVudC5zaGFwZSkge1xuICAgICAgdmFyIGVudGl0eVRyYW5zZm9ybSA9IGNvbXBvbmVudC5lbnRpdHkuZ2V0V29ybGRUcmFuc2Zvcm0oKTtcbiAgICAgIHZhciB3b3JsZFNjYWxlID0gZW50aXR5VHJhbnNmb3JtLmdldFNjYWxlKCk7XG4gICAgICB2YXIgcHJldmlvdXNTY2FsZSA9IGNvbXBvbmVudC5zaGFwZS5nZXRMb2NhbFNjYWxpbmcoKTtcbiAgICAgIGlmICh3b3JsZFNjYWxlLnggIT09IHByZXZpb3VzU2NhbGUueCgpIHx8IHdvcmxkU2NhbGUueSAhPT0gcHJldmlvdXNTY2FsZS55KCkgfHwgd29ybGRTY2FsZS56ICE9PSBwcmV2aW91c1NjYWxlLnooKSkge1xuICAgICAgICB0aGlzLmRvUmVjcmVhdGVQaHlzaWNhbFNoYXBlKGNvbXBvbmVudCk7XG4gICAgICB9XG4gICAgfVxuICAgIENvbGxpc2lvbk1lc2hTeXN0ZW1JbXBsLl9zdXBlci51cGRhdGVUcmFuc2Zvcm0uY2FsbCh0aGlzLCBjb21wb25lbnQsIHBvc2l0aW9uLCByb3RhdGlvbiwgc2NhbGUpO1xuICB9fSk7XG4gIHJldHVybiB7Q29sbGlzaW9uQ29tcG9uZW50U3lzdGVtOkNvbGxpc2lvbkNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIENvbGxpc2lvbkNvbXBvbmVudERhdGEgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICAgIHRoaXMudHlwZSA9IFwiYm94XCI7XG4gICAgdGhpcy5oYWxmRXh0ZW50cyA9IG5ldyBwYy5WZWMzKDAuNSwgMC41LCAwLjUpO1xuICAgIHRoaXMucmFkaXVzID0gMC41O1xuICAgIHRoaXMuYXhpcyA9IDE7XG4gICAgdGhpcy5oZWlnaHQgPSAyO1xuICAgIHRoaXMuYXNzZXQgPSBudWxsO1xuICAgIHRoaXMuc2hhcGUgPSBudWxsO1xuICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgfTtcbiAgQ29sbGlzaW9uQ29tcG9uZW50RGF0YSA9IHBjLmluaGVyaXRzKENvbGxpc2lvbkNvbXBvbmVudERhdGEsIHBjLkNvbXBvbmVudERhdGEpO1xuICByZXR1cm4ge0NvbGxpc2lvbkNvbXBvbmVudERhdGE6Q29sbGlzaW9uQ29tcG9uZW50RGF0YX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNJTVBMRV9QUk9QRVJUSUVTID0gW1wiZW1pdHRlckV4dGVudHNcIiwgXCJlbWl0dGVyUmFkaXVzXCIsIFwibG9vcFwiLCBcImluaXRpYWxWZWxvY2l0eVwiLCBcImFuaW1TcGVlZFwiLCBcIm5vcm1hbE1hcFwiXTtcbiAgdmFyIENPTVBMRVhfUFJPUEVSVElFUyA9IFtcIm51bVBhcnRpY2xlc1wiLCBcImxpZmV0aW1lXCIsIFwicmF0ZVwiLCBcInJhdGUyXCIsIFwic3RhcnRBbmdsZVwiLCBcInN0YXJ0QW5nbGUyXCIsIFwibGlnaHRpbmdcIiwgXCJoYWxmTGFtYmVydFwiLCBcImludGVuc2l0eVwiLCBcIndyYXBcIiwgXCJ3cmFwQm91bmRzXCIsIFwiZGVwdGhXcml0ZVwiLCBcIm5vRm9nXCIsIFwic29ydFwiLCBcInN0cmV0Y2hcIiwgXCJhbGlnblRvTW90aW9uXCIsIFwicHJlV2FybVwiLCBcImVtaXR0ZXJTaGFwZVwiLCBcImFuaW1UaWxlc1hcIiwgXCJhbmltVGlsZXNZXCIsIFwiYW5pbUZyYW1lc1wiLCBcImFuaW1Mb29wXCIsIFwiY29sb3JNYXBcIiwgXCJsb2NhbFNwYWNlXCJdO1xuICB2YXIgR1JBUEhfUFJPUEVSVElFUyA9IFtcInNjYWxlR3JhcGhcIiwgXCJzY2FsZUdyYXBoMlwiLCBcImNvbG9yR3JhcGhcIiwgXCJjb2xvckdyYXBoMlwiLCBcImFscGhhR3JhcGhcIiwgXCJhbHBoYUdyYXBoMlwiLCBcInZlbG9jaXR5R3JhcGhcIiwgXCJ2ZWxvY2l0eUdyYXBoMlwiLCBcImxvY2FsVmVsb2NpdHlHcmFwaFwiLCBcImxvY2FsVmVsb2NpdHlHcmFwaDJcIiwgXCJyb3RhdGlvblNwZWVkR3JhcGhcIiwgXCJyb3RhdGlvblNwZWVkR3JhcGgyXCJdO1xuICB2YXIgQVNTRVRfUFJPUEVSVElFUyA9IFtcImNvbG9yTWFwQXNzZXRcIiwgXCJub3JtYWxNYXBBc3NldFwiLCBcIm1lc2hcIl07XG4gIHZhciBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudCA9IGZ1bmN0aW9uIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50KHN5c3RlbSwgZW50aXR5KSB7XG4gICAgdGhpcy5vbihcInNldF9jb2xvck1hcEFzc2V0XCIsIHRoaXMub25TZXRDb2xvck1hcEFzc2V0LCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X25vcm1hbE1hcEFzc2V0XCIsIHRoaXMub25TZXROb3JtYWxNYXBBc3NldCwgdGhpcyk7XG4gICAgdGhpcy5vbihcInNldF9tZXNoXCIsIHRoaXMub25TZXRNZXNoLCB0aGlzKTtcbiAgICB0aGlzLm9uKFwic2V0X2xvb3BcIiwgdGhpcy5vblNldExvb3AsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfYmxlbmRUeXBlXCIsIHRoaXMub25TZXRCbGVuZFR5cGUsIHRoaXMpO1xuICAgIHRoaXMub24oXCJzZXRfZGVwdGhTb2Z0ZW5pbmdcIiwgdGhpcy5vblNldERlcHRoU29mdGVuaW5nLCB0aGlzKTtcbiAgICBTSU1QTEVfUFJPUEVSVElFUy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIHRoaXMub24oXCJzZXRfXCIgKyBwcm9wLCB0aGlzLm9uU2V0U2ltcGxlUHJvcGVydHksIHRoaXMpO1xuICAgIH0uYmluZCh0aGlzKSk7XG4gICAgQ09NUExFWF9QUk9QRVJUSUVTLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgdGhpcy5vbihcInNldF9cIiArIHByb3AsIHRoaXMub25TZXRDb21wbGV4UHJvcGVydHksIHRoaXMpO1xuICAgIH0uYmluZCh0aGlzKSk7XG4gICAgR1JBUEhfUFJPUEVSVElFUy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIHRoaXMub24oXCJzZXRfXCIgKyBwcm9wLCB0aGlzLm9uU2V0R3JhcGhQcm9wZXJ0eSwgdGhpcyk7XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgfTtcbiAgUGFydGljbGVTeXN0ZW1Db21wb25lbnQgPSBwYy5pbmhlcml0cyhQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50LnByb3RvdHlwZSwge29uU2V0Q29sb3JNYXBBc3NldDpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGFzc2V0O1xuICAgIHZhciBhc3NldHMgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzO1xuICAgIGlmIChvbGRWYWx1ZSkge1xuICAgICAgYXNzZXQgPSBhc3NldHMuZ2V0KG9sZFZhbHVlKTtcbiAgICAgIGlmIChhc3NldCkge1xuICAgICAgICBhc3NldC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5vbkNvbG9yTWFwUmVtb3ZlZCwgdGhpcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChuZXdWYWx1ZSkge1xuICAgICAgaWYgKG5ld1ZhbHVlIGluc3RhbmNlb2YgcGMuQXNzZXQpIHtcbiAgICAgICAgdGhpcy5kYXRhLmNvbG9yTWFwQXNzZXQgPSBuZXdWYWx1ZS5pZDtcbiAgICAgICAgbmV3VmFsdWUgPSBuZXdWYWx1ZS5pZDtcbiAgICAgIH1cbiAgICAgIGFzc2V0ID0gYXNzZXRzLmdldChuZXdWYWx1ZSk7XG4gICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgYXNzZXQub24oXCJyZW1vdmVcIiwgdGhpcy5vbkNvbG9yTWFwUmVtb3ZlZCwgdGhpcyk7XG4gICAgICAgIGFzc2V0LnJlYWR5KGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICAgICAgc2VsZi5jb2xvck1hcCA9IGFzc2V0LnJlc291cmNlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHNlbGYuZW5hYmxlZCAmJiBzZWxmLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NldHMub25jZShcImFkZDpcIiArIG5ld1ZhbHVlLCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMub25Db2xvck1hcFJlbW92ZWQsIHRoaXMpO1xuICAgICAgICAgIGFzc2V0LnJlYWR5KGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICAgICAgICBzZWxmLmNvbG9yTWFwID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKHNlbGYuZW5hYmxlZCAmJiBzZWxmLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jb2xvck1hcCA9IG51bGw7XG4gICAgfVxuICB9LCBvbkNvbG9yTWFwUmVtb3ZlZDpmdW5jdGlvbihhc3NldCkge1xuICAgIGFzc2V0Lm9mZihcInJlbW92ZVwiLCB0aGlzLm9uQ29sb3JNYXBSZW1vdmVkLCB0aGlzKTtcbiAgICB0aGlzLmNvbG9yTWFwQXNzZXQgPSBudWxsO1xuICB9LCBvblNldE5vcm1hbE1hcEFzc2V0OmZ1bmN0aW9uKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgYXNzZXQ7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgaWYgKG9sZFZhbHVlKSB7XG4gICAgICBhc3NldCA9IGFzc2V0cy5nZXQob2xkVmFsdWUpO1xuICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgIGFzc2V0Lm9mZihcInJlbW92ZVwiLCB0aGlzLm9uTm9ybWFsTWFwUmVtb3ZlZCwgdGhpcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChuZXdWYWx1ZSkge1xuICAgICAgaWYgKG5ld1ZhbHVlIGluc3RhbmNlb2YgcGMuQXNzZXQpIHtcbiAgICAgICAgdGhpcy5kYXRhLm5vcm1hbE1hcEFzc2V0ID0gbmV3VmFsdWUuaWQ7XG4gICAgICAgIG5ld1ZhbHVlID0gbmV3VmFsdWUuaWQ7XG4gICAgICB9XG4gICAgICBhc3NldCA9IGFzc2V0cy5nZXQobmV3VmFsdWUpO1xuICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMub25Ob3JtYWxNYXBSZW1vdmVkLCB0aGlzKTtcbiAgICAgICAgYXNzZXQucmVhZHkoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICBzZWxmLm5vcm1hbE1hcCA9IGFzc2V0LnJlc291cmNlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHNlbGYuZW5hYmxlZCAmJiBzZWxmLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NldHMub25jZShcImFkZDpcIiArIG5ld1ZhbHVlLCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMub25Ob3JtYWxNYXBSZW1vdmVkLCB0aGlzKTtcbiAgICAgICAgICBhc3NldC5yZWFkeShmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgc2VsZi5ub3JtYWxNYXAgPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAoc2VsZi5lbmFibGVkICYmIHNlbGYuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm5vcm1hbE1hcCA9IG51bGw7XG4gICAgfVxuICB9LCBvbk5vcm1hbE1hcFJlbW92ZWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBhc3NldC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5vbk5vcm1hbE1hcFJlbW92ZWQsIHRoaXMpO1xuICAgIHRoaXMubm9ybWFsTWFwQXNzZXQgPSBudWxsO1xuICB9LCBvblNldE1lc2g6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBhc3NldDtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cztcbiAgICBpZiAob2xkVmFsdWUgJiYgdHlwZW9mIG9sZFZhbHVlID09PSBcIm51bWJlclwiKSB7XG4gICAgICBhc3NldCA9IGFzc2V0cy5nZXQob2xkVmFsdWUpO1xuICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgIGFzc2V0Lm9mZihcInJlbW92ZVwiLCB0aGlzLm9uTWVzaFJlbW92ZWQsIHRoaXMpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAobmV3VmFsdWUpIHtcbiAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICAgIHRoaXMuZGF0YS5tZXNoID0gbmV3VmFsdWUuaWQ7XG4gICAgICAgIG5ld1ZhbHVlID0gbmV3VmFsdWUuaWQ7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG5ld1ZhbHVlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgIGFzc2V0ID0gYXNzZXRzLmdldChuZXdWYWx1ZSk7XG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMub25NZXNoUmVtb3ZlZCwgdGhpcyk7XG4gICAgICAgICAgYXNzZXQucmVhZHkoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICAgIHNlbGYuX29uTWVzaENoYW5nZWQoYXNzZXQucmVzb3VyY2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGlmIChzZWxmLmVuYWJsZWQgJiYgc2VsZi5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhc3NldHMub25jZShcImFkZDpcIiArIG5ld1ZhbHVlLCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgYXNzZXQub24oXCJyZW1vdmVcIiwgdGhpcy5vbk1lc2hSZW1vdmVkLCB0aGlzKTtcbiAgICAgICAgICAgIGFzc2V0LnJlYWR5KGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICAgICAgICAgIHNlbGYuX29uTWVzaENoYW5nZWQoYXNzZXQucmVzb3VyY2UpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoc2VsZi5lbmFibGVkICYmIHNlbGYuZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9vbk1lc2hDaGFuZ2VkKG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fb25NZXNoQ2hhbmdlZChudWxsKTtcbiAgICB9XG4gIH0sIF9vbk1lc2hDaGFuZ2VkOmZ1bmN0aW9uKG1lc2gpIHtcbiAgICBpZiAobWVzaCAmJiAhKG1lc2ggaW5zdGFuY2VvZiBwYy5NZXNoKSkge1xuICAgICAgaWYgKG1lc2gubWVzaEluc3RhbmNlc1swXSkge1xuICAgICAgICBtZXNoID0gbWVzaC5tZXNoSW5zdGFuY2VzWzBdLm1lc2g7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNoID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5kYXRhLm1lc2ggPSBtZXNoO1xuICAgIGlmICh0aGlzLmVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5tZXNoID0gbWVzaDtcbiAgICAgIHRoaXMuZW1pdHRlci5yZXNldE1hdGVyaWFsKCk7XG4gICAgICB0aGlzLnJlYnVpbGQoKTtcbiAgICB9XG4gIH0sIG9uTWVzaFJlbW92ZWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBhc3NldC5vZmYoXCJyZW1vdmVcIiwgdGhpcy5vbk1lc2hSZW1vdmVkLCB0aGlzKTtcbiAgICB0aGlzLm1lc2ggPSBudWxsO1xuICB9LCBvblNldExvb3A6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgdGhpcy5lbWl0dGVyW25hbWVdID0gbmV3VmFsdWU7XG4gICAgICB0aGlzLmVtaXR0ZXIucmVzZXRUaW1lKCk7XG4gICAgfVxuICB9LCBvblNldEJsZW5kVHlwZTpmdW5jdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICBpZiAodGhpcy5lbWl0dGVyKSB7XG4gICAgICB0aGlzLmVtaXR0ZXJbbmFtZV0gPSBuZXdWYWx1ZTtcbiAgICAgIHRoaXMuZW1pdHRlci5tYXRlcmlhbC5ibGVuZFR5cGUgPSBuZXdWYWx1ZTtcbiAgICAgIHRoaXMuZW1pdHRlci5yZXNldE1hdGVyaWFsKCk7XG4gICAgICB0aGlzLnJlYnVpbGQoKTtcbiAgICB9XG4gIH0sIG9uU2V0RGVwdGhTb2Z0ZW5pbmc6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkge1xuICAgICAgICBpZiAobmV3VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXJbbmFtZV0gPSBuZXdWYWx1ZTtcbiAgICAgICAgICBpZiAodGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXR0ZXIub25FbmFibGVEZXB0aCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXR0ZXIub25EaXNhYmxlRGVwdGgoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5lbWl0dGVyW25hbWVdID0gbmV3VmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIucmVzZXRNYXRlcmlhbCgpO1xuICAgICAgICB0aGlzLnJlYnVpbGQoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uU2V0U2ltcGxlUHJvcGVydHk6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgdGhpcy5lbWl0dGVyW25hbWVdID0gbmV3VmFsdWU7XG4gICAgICB0aGlzLmVtaXR0ZXIucmVzZXRNYXRlcmlhbCgpO1xuICAgIH1cbiAgfSwgb25TZXRDb21wbGV4UHJvcGVydHk6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgdGhpcy5lbWl0dGVyW25hbWVdID0gbmV3VmFsdWU7XG4gICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICB0aGlzLmVtaXR0ZXIucmVzZXRNYXRlcmlhbCgpO1xuICAgICAgdGhpcy5yZWJ1aWxkKCk7XG4gICAgfVxuICB9LCBvblNldEdyYXBoUHJvcGVydHk6ZnVuY3Rpb24obmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgdGhpcy5lbWl0dGVyW25hbWVdID0gbmV3VmFsdWU7XG4gICAgICB0aGlzLmVtaXR0ZXIucmVidWlsZEdyYXBocygpO1xuICAgICAgdGhpcy5lbWl0dGVyLnJlc2V0TWF0ZXJpYWwoKTtcbiAgICB9XG4gIH0sIG9uRW5hYmxlOmZ1bmN0aW9uKCkge1xuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBBU1NFVF9QUk9QRVJUSUVTLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgdmFyIGFzc2V0ID0gdGhpcy5kYXRhW0FTU0VUX1BST1BFUlRJRVNbaV1dO1xuICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgIGlmICghKGFzc2V0IGluc3RhbmNlb2YgcGMuQXNzZXQpKSB7XG4gICAgICAgICAgdmFyIGlkID0gcGFyc2VJbnQoYXNzZXQsIDEwKTtcbiAgICAgICAgICBpZiAoaWQgPj0gMCkge1xuICAgICAgICAgICAgYXNzZXQgPSB0aGlzLnN5c3RlbS5hcHAuYXNzZXRzLmdldChhc3NldCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYXNzZXQgJiYgIWFzc2V0LnJlc291cmNlKSB7XG4gICAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLmFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB2YXIgZmlyc3RSdW4gPSBmYWxzZTtcbiAgICBpZiAoIXRoaXMuZW1pdHRlcikge1xuICAgICAgdmFyIG1lc2ggPSB0aGlzLmRhdGEubWVzaDtcbiAgICAgIGlmICghKG1lc2ggaW5zdGFuY2VvZiBwYy5NZXNoKSkge1xuICAgICAgICBtZXNoID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIGZpcnN0UnVuID0gdHJ1ZTtcbiAgICAgIHRoaXMuZW1pdHRlciA9IG5ldyBwYy5QYXJ0aWNsZUVtaXR0ZXIodGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlLCB7bnVtUGFydGljbGVzOnRoaXMuZGF0YS5udW1QYXJ0aWNsZXMsIGVtaXR0ZXJFeHRlbnRzOnRoaXMuZGF0YS5lbWl0dGVyRXh0ZW50cywgZW1pdHRlclJhZGl1czp0aGlzLmRhdGEuZW1pdHRlclJhZGl1cywgZW1pdHRlclNoYXBlOnRoaXMuZGF0YS5lbWl0dGVyU2hhcGUsIGluaXRpYWxWZWxvY2l0eTp0aGlzLmRhdGEuaW5pdGlhbFZlbG9jaXR5LCB3cmFwOnRoaXMuZGF0YS53cmFwLCBsb2NhbFNwYWNlOnRoaXMuZGF0YS5sb2NhbFNwYWNlLCB3cmFwQm91bmRzOnRoaXMuZGF0YS53cmFwQm91bmRzLCBsaWZldGltZTp0aGlzLmRhdGEubGlmZXRpbWUsIHJhdGU6dGhpcy5kYXRhLnJhdGUsIHJhdGUyOnRoaXMuZGF0YS5yYXRlMiwgYW5pbVRpbGVzWDp0aGlzLmRhdGEuYW5pbVRpbGVzWCwgYW5pbVRpbGVzWTp0aGlzLmRhdGEuYW5pbVRpbGVzWSwgYW5pbU51bUZyYW1lczp0aGlzLmRhdGEuYW5pbU51bUZyYW1lcyxcbiAgICAgIGFuaW1TcGVlZDp0aGlzLmRhdGEuYW5pbVNwZWVkLCBhbmltTG9vcDp0aGlzLmRhdGEuYW5pbUxvb3AsIHN0YXJ0QW5nbGU6dGhpcy5kYXRhLnN0YXJ0QW5nbGUsIHN0YXJ0QW5nbGUyOnRoaXMuZGF0YS5zdGFydEFuZ2xlMiwgc2NhbGVHcmFwaDp0aGlzLmRhdGEuc2NhbGVHcmFwaCwgc2NhbGVHcmFwaDI6dGhpcy5kYXRhLnNjYWxlR3JhcGgyLCBjb2xvckdyYXBoOnRoaXMuZGF0YS5jb2xvckdyYXBoLCBjb2xvckdyYXBoMjp0aGlzLmRhdGEuY29sb3JHcmFwaDIsIGFscGhhR3JhcGg6dGhpcy5kYXRhLmFscGhhR3JhcGgsIGFscGhhR3JhcGgyOnRoaXMuZGF0YS5hbHBoYUdyYXBoMiwgbG9jYWxWZWxvY2l0eUdyYXBoOnRoaXMuZGF0YS5sb2NhbFZlbG9jaXR5R3JhcGgsIGxvY2FsVmVsb2NpdHlHcmFwaDI6dGhpcy5kYXRhLmxvY2FsVmVsb2NpdHlHcmFwaDIsIHZlbG9jaXR5R3JhcGg6dGhpcy5kYXRhLnZlbG9jaXR5R3JhcGgsIHZlbG9jaXR5R3JhcGgyOnRoaXMuZGF0YS52ZWxvY2l0eUdyYXBoMixcbiAgICAgIHJvdGF0aW9uU3BlZWRHcmFwaDp0aGlzLmRhdGEucm90YXRpb25TcGVlZEdyYXBoLCByb3RhdGlvblNwZWVkR3JhcGgyOnRoaXMuZGF0YS5yb3RhdGlvblNwZWVkR3JhcGgyLCBjb2xvck1hcDp0aGlzLmRhdGEuY29sb3JNYXAsIG5vcm1hbE1hcDp0aGlzLmRhdGEubm9ybWFsTWFwLCBsb29wOnRoaXMuZGF0YS5sb29wLCBwcmVXYXJtOnRoaXMuZGF0YS5wcmVXYXJtLCBzb3J0OnRoaXMuZGF0YS5zb3J0LCBzdHJldGNoOnRoaXMuZGF0YS5zdHJldGNoLCBhbGlnblRvTW90aW9uOnRoaXMuZGF0YS5hbGlnblRvTW90aW9uLCBsaWdodGluZzp0aGlzLmRhdGEubGlnaHRpbmcsIGhhbGZMYW1iZXJ0OnRoaXMuZGF0YS5oYWxmTGFtYmVydCwgaW50ZW5zaXR5OnRoaXMuZGF0YS5pbnRlbnNpdHksIGRlcHRoU29mdGVuaW5nOnRoaXMuZGF0YS5kZXB0aFNvZnRlbmluZywgc2NlbmU6dGhpcy5zeXN0ZW0uYXBwLnNjZW5lLCBtZXNoOm1lc2gsIGRlcHRoV3JpdGU6dGhpcy5kYXRhLmRlcHRoV3JpdGUsXG4gICAgICBub0ZvZzp0aGlzLmRhdGEubm9Gb2csIG5vZGU6dGhpcy5lbnRpdHksIGJsZW5kVHlwZTp0aGlzLmRhdGEuYmxlbmRUeXBlfSk7XG4gICAgICB0aGlzLmVtaXR0ZXIubWVzaEluc3RhbmNlLm5vZGUgPSB0aGlzLmVudGl0eTtcbiAgICAgIHRoaXMucHN5cyA9IG5ldyBwYy5Nb2RlbDtcbiAgICAgIHRoaXMucHN5cy5ncmFwaCA9IHRoaXMuZW50aXR5O1xuICAgICAgdGhpcy5wc3lzLmVtaXR0ZXIgPSB0aGlzLmVtaXR0ZXI7XG4gICAgICB0aGlzLnBzeXMubWVzaEluc3RhbmNlcyA9IFt0aGlzLmVtaXR0ZXIubWVzaEluc3RhbmNlXTtcbiAgICAgIHRoaXMuZGF0YS5tb2RlbCA9IHRoaXMucHN5cztcbiAgICAgIHRoaXMuZW1pdHRlci5wc3lzID0gdGhpcy5wc3lzO1xuICAgICAgaWYgKCF0aGlzLmRhdGEuYXV0b1BsYXkpIHtcbiAgICAgICAgdGhpcy5wYXVzZSgpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIubWVzaEluc3RhbmNlLnZpc2libGUgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuZGF0YS5tb2RlbCkge1xuICAgICAgaWYgKCF0aGlzLnN5c3RlbS5hcHAuc2NlbmUuY29udGFpbnNNb2RlbCh0aGlzLmRhdGEubW9kZWwpKSB7XG4gICAgICAgIGlmICh0aGlzLmVtaXR0ZXIuY29sb3JNYXApIHtcbiAgICAgICAgICB0aGlzLnN5c3RlbS5hcHAuc2NlbmUuYWRkTW9kZWwodGhpcy5kYXRhLm1vZGVsKTtcbiAgICAgICAgICBpZiAoIWZpcnN0UnVuKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXR0ZXIub25FbmFibGVEZXB0aCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudC5fc3VwZXIub25FbmFibGUuY2FsbCh0aGlzKTtcbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50Ll9zdXBlci5vbkRpc2FibGUuY2FsbCh0aGlzKTtcbiAgICBpZiAodGhpcy5kYXRhLm1vZGVsKSB7XG4gICAgICBpZiAodGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwodGhpcy5kYXRhLm1vZGVsKSkge1xuICAgICAgICB0aGlzLnN5c3RlbS5hcHAuc2NlbmUucmVtb3ZlTW9kZWwodGhpcy5kYXRhLm1vZGVsKTtcbiAgICAgICAgdGhpcy5lbWl0dGVyLm9uRGlzYWJsZURlcHRoKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCByZXNldDpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5lbWl0dGVyKSB7XG4gICAgICB0aGlzLmVtaXR0ZXIucmVzZXQoKTtcbiAgICB9XG4gIH0sIHN0b3A6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuZW1pdHRlcikge1xuICAgICAgdGhpcy5lbWl0dGVyLmxvb3AgPSBmYWxzZTtcbiAgICAgIHRoaXMuZW1pdHRlci5yZXNldFRpbWUoKTtcbiAgICAgIHRoaXMuZW1pdHRlci5hZGRUaW1lKDAsIHRydWUpO1xuICAgIH1cbiAgfSwgcGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5kYXRhLnBhdXNlZCA9IHRydWU7XG4gIH0sIHVucGF1c2U6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5kYXRhLnBhdXNlZCA9IGZhbHNlO1xuICB9LCBwbGF5OmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZGF0YS5wYXVzZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5lbWl0dGVyKSB7XG4gICAgICB0aGlzLmVtaXR0ZXIubWVzaEluc3RhbmNlLnZpc2libGUgPSB0cnVlO1xuICAgICAgdGhpcy5lbWl0dGVyLmxvb3AgPSB0aGlzLmRhdGEubG9vcDtcbiAgICAgIHRoaXMuZW1pdHRlci5yZXNldFRpbWUoKTtcbiAgICB9XG4gIH0sIGlzUGxheWluZzpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5kYXRhLnBhdXNlZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5lbWl0dGVyICYmIHRoaXMuZW1pdHRlci5sb29wKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIERhdGUubm93KCkgPD0gdGhpcy5lbWl0dGVyLmVuZFRpbWU7XG4gICAgICB9XG4gICAgfVxuICB9LCByZWJ1aWxkOmZ1bmN0aW9uKCkge1xuICAgIHZhciBlbmFibGVkID0gdGhpcy5lbmFibGVkO1xuICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5yZWJ1aWxkKCk7XG4gICAgICB0aGlzLmVtaXR0ZXIubWVzaEluc3RhbmNlLm5vZGUgPSB0aGlzLmVudGl0eTtcbiAgICAgIHRoaXMuZGF0YS5tb2RlbC5tZXNoSW5zdGFuY2VzID0gW3RoaXMuZW1pdHRlci5tZXNoSW5zdGFuY2VdO1xuICAgIH1cbiAgICB0aGlzLmVuYWJsZWQgPSBlbmFibGVkO1xuICB9fSk7XG4gIHJldHVybiB7UGFydGljbGVTeXN0ZW1Db21wb25lbnQ6UGFydGljbGVTeXN0ZW1Db21wb25lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBfc2NoZW1hID0gW1wiZW5hYmxlZFwiLCBcImF1dG9QbGF5XCIsIFwibnVtUGFydGljbGVzXCIsIFwibGlmZXRpbWVcIiwgXCJyYXRlXCIsIFwicmF0ZTJcIiwgXCJzdGFydEFuZ2xlXCIsIFwic3RhcnRBbmdsZTJcIiwgXCJsb29wXCIsIFwicHJlV2FybVwiLCBcImxpZ2h0aW5nXCIsIFwiaGFsZkxhbWJlcnRcIiwgXCJpbnRlbnNpdHlcIiwgXCJkZXB0aFdyaXRlXCIsIFwibm9Gb2dcIiwgXCJkZXB0aFNvZnRlbmluZ1wiLCBcInNvcnRcIiwgXCJibGVuZFR5cGVcIiwgXCJzdHJldGNoXCIsIFwiYWxpZ25Ub01vdGlvblwiLCBcImVtaXR0ZXJTaGFwZVwiLCBcImVtaXR0ZXJFeHRlbnRzXCIsIFwiZW1pdHRlclJhZGl1c1wiLCBcImluaXRpYWxWZWxvY2l0eVwiLCBcIndyYXBcIiwgXCJ3cmFwQm91bmRzXCIsIFwibG9jYWxTcGFjZVwiLCBcImNvbG9yTWFwQXNzZXRcIiwgXCJub3JtYWxNYXBBc3NldFwiLCBcIm1lc2hcIiwgXCJsb2NhbFZlbG9jaXR5R3JhcGhcIiwgXCJsb2NhbFZlbG9jaXR5R3JhcGgyXCIsIFwidmVsb2NpdHlHcmFwaFwiLCBcInZlbG9jaXR5R3JhcGgyXCIsIFwicm90YXRpb25TcGVlZEdyYXBoXCIsXG4gIFwicm90YXRpb25TcGVlZEdyYXBoMlwiLCBcInNjYWxlR3JhcGhcIiwgXCJzY2FsZUdyYXBoMlwiLCBcImNvbG9yR3JhcGhcIiwgXCJjb2xvckdyYXBoMlwiLCBcImFscGhhR3JhcGhcIiwgXCJhbHBoYUdyYXBoMlwiLCBcImNvbG9yTWFwXCIsIFwibm9ybWFsTWFwXCIsIFwiYW5pbVRpbGVzWFwiLCBcImFuaW1UaWxlc1lcIiwgXCJhbmltTnVtRnJhbWVzXCIsIFwiYW5pbVNwZWVkXCIsIFwiYW5pbUxvb3BcIl07XG4gIHZhciBQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudFN5c3RlbSA9IGZ1bmN0aW9uIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcInBhcnRpY2xlc3lzdGVtXCI7XG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IFwiVXBkYXRlcyBhbmQgcmVuZGVycyBwYXJ0aWNsZSBzeXN0ZW0gaW4gdGhlIHNjZW5lLlwiO1xuICAgIGFwcC5zeXN0ZW1zLmFkZCh0aGlzLmlkLCB0aGlzKTtcbiAgICB0aGlzLkNvbXBvbmVudFR5cGUgPSBwYy5QYXJ0aWNsZVN5c3RlbUNvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuUGFydGljbGVTeXN0ZW1Db21wb25lbnREYXRhO1xuICAgIHRoaXMuc2NoZW1hID0gX3NjaGVtYTtcbiAgICB0aGlzLnByb3BlcnR5VHlwZXMgPSB7ZW1pdHRlckV4dGVudHM6XCJ2ZWMzXCIsIHdyYXBCb3VuZHM6XCJ2ZWMzXCIsIGxvY2FsVmVsb2NpdHlHcmFwaDpcImN1cnZlc2V0XCIsIGxvY2FsVmVsb2NpdHlHcmFwaDI6XCJjdXJ2ZXNldFwiLCB2ZWxvY2l0eUdyYXBoOlwiY3VydmVzZXRcIiwgdmVsb2NpdHlHcmFwaDI6XCJjdXJ2ZXNldFwiLCBjb2xvckdyYXBoOlwiY3VydmVzZXRcIiwgY29sb3JHcmFwaDI6XCJjdXJ2ZXNldFwiLCBhbHBoYUdyYXBoOlwiY3VydmVcIiwgYWxwaGFHcmFwaDI6XCJjdXJ2ZVwiLCByb3RhdGlvblNwZWVkR3JhcGg6XCJjdXJ2ZVwiLCByb3RhdGlvblNwZWVkR3JhcGgyOlwiY3VydmVcIiwgc2NhbGVHcmFwaDpcImN1cnZlXCIsIHNjYWxlR3JhcGgyOlwiY3VydmVcIn07XG4gICAgdGhpcy5vbihcImJlZm9yZXJlbW92ZVwiLCB0aGlzLm9uUmVtb3ZlLCB0aGlzKTtcbiAgICBwYy5Db21wb25lbnRTeXN0ZW0ub24oXCJ1cGRhdGVcIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7XG4gIH07XG4gIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoUGFydGljbGVTeXN0ZW1Db21wb25lbnRTeXN0ZW0sIHBjLkNvbXBvbmVudFN5c3RlbSk7XG4gIHBjLkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMocGMuUGFydGljbGVTeXN0ZW1Db21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwge2luaXRpYWxpemVDb21wb25lbnREYXRhOmZ1bmN0aW9uKGNvbXBvbmVudCwgX2RhdGEsIHByb3BlcnRpZXMpIHtcbiAgICB2YXIgZGF0YSA9IHt9O1xuICAgIHByb3BlcnRpZXMgPSBbXTtcbiAgICB2YXIgdHlwZXMgPSB0aGlzLnByb3BlcnR5VHlwZXM7XG4gICAgdmFyIHR5cGU7XG4gICAgZm9yICh2YXIgcHJvcCBpbiBfZGF0YSkge1xuICAgICAgaWYgKF9kYXRhLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgIHByb3BlcnRpZXMucHVzaChwcm9wKTtcbiAgICAgICAgZGF0YVtwcm9wXSA9IF9kYXRhW3Byb3BdO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVzW3Byb3BdID09PSBcInZlYzNcIikge1xuICAgICAgICBpZiAocGMudHlwZShkYXRhW3Byb3BdKSA9PT0gXCJhcnJheVwiKSB7XG4gICAgICAgICAgZGF0YVtwcm9wXSA9IG5ldyBwYy5WZWMzKGRhdGFbcHJvcF1bMF0sIGRhdGFbcHJvcF1bMV0sIGRhdGFbcHJvcF1bMl0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodHlwZXNbcHJvcF0gPT09IFwiY3VydmVcIikge1xuICAgICAgICAgIGlmICghKGRhdGFbcHJvcF0gaW5zdGFuY2VvZiBwYy5DdXJ2ZSkpIHtcbiAgICAgICAgICAgIHR5cGUgPSBkYXRhW3Byb3BdLnR5cGU7XG4gICAgICAgICAgICBkYXRhW3Byb3BdID0gbmV3IHBjLkN1cnZlKGRhdGFbcHJvcF0ua2V5cyk7XG4gICAgICAgICAgICBkYXRhW3Byb3BdLnR5cGUgPSB0eXBlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodHlwZXNbcHJvcF0gPT09IFwiY3VydmVzZXRcIikge1xuICAgICAgICAgICAgaWYgKCEoZGF0YVtwcm9wXSBpbnN0YW5jZW9mIHBjLkN1cnZlU2V0KSkge1xuICAgICAgICAgICAgICB0eXBlID0gZGF0YVtwcm9wXS50eXBlO1xuICAgICAgICAgICAgICBkYXRhW3Byb3BdID0gbmV3IHBjLkN1cnZlU2V0KGRhdGFbcHJvcF0ua2V5cyk7XG4gICAgICAgICAgICAgIGRhdGFbcHJvcF0udHlwZSA9IHR5cGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50U3lzdGVtLl9zdXBlci5pbml0aWFsaXplQ29tcG9uZW50RGF0YS5jYWxsKHRoaXMsIGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcyk7XG4gIH0sIGNsb25lQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY2xvbmUpIHtcbiAgICB2YXIgc291cmNlID0gZW50aXR5LnBhcnRpY2xlc3lzdGVtLmRhdGE7XG4gICAgdmFyIHNjaGVtYSA9IHRoaXMuc2NoZW1hO1xuICAgIHZhciBkYXRhID0ge307XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHNjaGVtYS5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIHZhciBwcm9wID0gc2NoZW1hW2ldO1xuICAgICAgdmFyIHNvdXJjZVByb3AgPSBzb3VyY2VbcHJvcF07XG4gICAgICBpZiAoc291cmNlUHJvcCBpbnN0YW5jZW9mIHBjLlZlYzMgfHwgc291cmNlUHJvcCBpbnN0YW5jZW9mIHBjLkN1cnZlIHx8IHNvdXJjZVByb3AgaW5zdGFuY2VvZiBwYy5DdXJ2ZVNldCkge1xuICAgICAgICBzb3VyY2VQcm9wID0gc291cmNlUHJvcC5jbG9uZSgpO1xuICAgICAgICBkYXRhW3Byb3BdID0gc291cmNlUHJvcDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChzb3VyY2VQcm9wICE9PSBudWxsICYmIHNvdXJjZVByb3AgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGRhdGFbcHJvcF0gPSBzb3VyY2VQcm9wO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gIH0sIG9uVXBkYXRlOmZ1bmN0aW9uKGR0KSB7XG4gICAgdmFyIGNvbXBvbmVudHMgPSB0aGlzLnN0b3JlO1xuICAgIHZhciBjdXJyZW50Q2FtZXJhO1xuICAgIHZhciBudW1TdGVwcywgaTtcbiAgICB2YXIgc3RhdHMgPSB0aGlzLmFwcC5zdGF0cy5wYXJ0aWNsZXM7XG4gICAgZm9yICh2YXIgaWQgaW4gY29tcG9uZW50cykge1xuICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgIHZhciBjID0gY29tcG9uZW50c1tpZF07XG4gICAgICAgIHZhciBlbnRpdHkgPSBjLmVudGl0eTtcbiAgICAgICAgdmFyIGRhdGEgPSBjLmRhdGE7XG4gICAgICAgIGlmIChkYXRhLmVuYWJsZWQgJiYgZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgICAgICB2YXIgZW1pdHRlciA9IGRhdGEubW9kZWwuZW1pdHRlcjtcbiAgICAgICAgICBpZiAoIWVtaXR0ZXIubWVzaEluc3RhbmNlLnZpc2libGUpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIWRhdGEucGF1c2VkKSB7XG4gICAgICAgICAgICBlbWl0dGVyLnNpbVRpbWUgKz0gZHQ7XG4gICAgICAgICAgICBudW1TdGVwcyA9IDA7XG4gICAgICAgICAgICBpZiAoZW1pdHRlci5zaW1UaW1lID4gZW1pdHRlci5maXhlZFRpbWVTdGVwKSB7XG4gICAgICAgICAgICAgIG51bVN0ZXBzID0gTWF0aC5mbG9vcihlbWl0dGVyLnNpbVRpbWUgLyBlbWl0dGVyLmZpeGVkVGltZVN0ZXApO1xuICAgICAgICAgICAgICBlbWl0dGVyLnNpbVRpbWUgLT0gbnVtU3RlcHMgKiBlbWl0dGVyLmZpeGVkVGltZVN0ZXA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobnVtU3RlcHMpIHtcbiAgICAgICAgICAgICAgbnVtU3RlcHMgPSBNYXRoLm1pbihudW1TdGVwcywgZW1pdHRlci5tYXhTdWJTdGVwcyk7XG4gICAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IG51bVN0ZXBzO2krKykge1xuICAgICAgICAgICAgICAgIGVtaXR0ZXIuYWRkVGltZShlbWl0dGVyLmZpeGVkVGltZVN0ZXApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHN0YXRzLl91cGRhdGVzUGVyRnJhbWUgKz0gbnVtU3RlcHM7XG4gICAgICAgICAgICAgIHN0YXRzLl9mcmFtZVRpbWUgKz0gZW1pdHRlci5fYWRkVGltZVRpbWU7XG4gICAgICAgICAgICAgIGVtaXR0ZXIuX2FkZFRpbWVUaW1lID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVtaXR0ZXIuZmluaXNoRnJhbWUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9uUmVtb3ZlOmZ1bmN0aW9uKGVudGl0eSwgY29tcG9uZW50KSB7XG4gICAgdmFyIGRhdGEgPSBjb21wb25lbnQuZGF0YTtcbiAgICBpZiAoZGF0YS5tb2RlbCkge1xuICAgICAgdGhpcy5hcHAuc2NlbmUucmVtb3ZlTW9kZWwoZGF0YS5tb2RlbCk7XG4gICAgICBlbnRpdHkucmVtb3ZlQ2hpbGQoZGF0YS5tb2RlbC5nZXRHcmFwaCgpKTtcbiAgICAgIGRhdGEubW9kZWwgPSBudWxsO1xuICAgIH1cbiAgICBpZiAoY29tcG9uZW50LmVtaXR0ZXIpIHtcbiAgICAgIGNvbXBvbmVudC5lbWl0dGVyLmRlc3Ryb3koKTtcbiAgICAgIGNvbXBvbmVudC5lbWl0dGVyID0gbnVsbDtcbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudFN5c3RlbTpQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFBhcnRpY2xlU3lzdGVtQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMubnVtUGFydGljbGVzID0gMTtcbiAgICB0aGlzLnJhdGUgPSAxO1xuICAgIHRoaXMucmF0ZTIgPSBudWxsO1xuICAgIHRoaXMuc3RhcnRBbmdsZSA9IDA7XG4gICAgdGhpcy5zdGFydEFuZ2xlMiA9IG51bGw7XG4gICAgdGhpcy5saWZldGltZSA9IDUwO1xuICAgIHRoaXMuZW1pdHRlckV4dGVudHMgPSBuZXcgcGMuVmVjMztcbiAgICB0aGlzLmVtaXR0ZXJSYWRpdXMgPSAwO1xuICAgIHRoaXMuZW1pdHRlclNoYXBlID0gcGMuRU1JVFRFUlNIQVBFX0JPWDtcbiAgICB0aGlzLmluaXRpYWxWZWxvY2l0eSA9IDA7XG4gICAgdGhpcy53cmFwQm91bmRzID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5sb2NhbFNwYWNlID0gZmFsc2U7XG4gICAgdGhpcy5jb2xvck1hcCA9IG51bGw7XG4gICAgdGhpcy5jb2xvck1hcEFzc2V0ID0gbnVsbDtcbiAgICB0aGlzLm5vcm1hbE1hcCA9IG51bGw7XG4gICAgdGhpcy5ub3JtYWxNYXBBc3NldCA9IG51bGw7XG4gICAgdGhpcy5sb29wID0gdHJ1ZTtcbiAgICB0aGlzLnByZVdhcm0gPSBmYWxzZTtcbiAgICB0aGlzLnNvcnQgPSAwO1xuICAgIHRoaXMubW9kZSA9IHBjLlBBUlRJQ0xFTU9ERV9HUFU7XG4gICAgdGhpcy5zY2VuZSA9IG51bGw7XG4gICAgdGhpcy5saWdodGluZyA9IGZhbHNlO1xuICAgIHRoaXMuaGFsZkxhbWJlcnQgPSBmYWxzZTtcbiAgICB0aGlzLmludGVuc2l0eSA9IDE7XG4gICAgdGhpcy5zdHJldGNoID0gMC4wO1xuICAgIHRoaXMuYWxpZ25Ub01vdGlvbiA9IGZhbHNlO1xuICAgIHRoaXMuZGVwdGhTb2Z0ZW5pbmcgPSAwO1xuICAgIHRoaXMubWVzaCA9IG51bGw7XG4gICAgdGhpcy5kZXB0aFdyaXRlID0gZmFsc2U7XG4gICAgdGhpcy5ub0ZvZyA9IGZhbHNlO1xuICAgIHRoaXMuYW5pbVRpbGVzWCA9IDE7XG4gICAgdGhpcy5hbmltVGlsZXNZID0gMTtcbiAgICB0aGlzLmFuaW1OdW1GcmFtZXMgPSAxO1xuICAgIHRoaXMuYW5pbVNwZWVkID0gMTtcbiAgICB0aGlzLmFuaW1Mb29wID0gdHJ1ZTtcbiAgICB0aGlzLnNjYWxlR3JhcGggPSBudWxsO1xuICAgIHRoaXMuc2NhbGVHcmFwaDIgPSBudWxsO1xuICAgIHRoaXMuY29sb3JHcmFwaCA9IG51bGw7XG4gICAgdGhpcy5jb2xvckdyYXBoMiA9IG51bGw7XG4gICAgdGhpcy5hbHBoYUdyYXBoID0gbnVsbDtcbiAgICB0aGlzLmFscGhhR3JhcGgyID0gbnVsbDtcbiAgICB0aGlzLmxvY2FsVmVsb2NpdHlHcmFwaCA9IG51bGw7XG4gICAgdGhpcy5sb2NhbFZlbG9jaXR5R3JhcGgyID0gbnVsbDtcbiAgICB0aGlzLnZlbG9jaXR5R3JhcGggPSBudWxsO1xuICAgIHRoaXMudmVsb2NpdHlHcmFwaDIgPSBudWxsO1xuICAgIHRoaXMucm90YXRpb25TcGVlZEdyYXBoID0gbnVsbDtcbiAgICB0aGlzLnJvdGF0aW9uU3BlZWRHcmFwaDIgPSBudWxsO1xuICAgIHRoaXMuYmxlbmRUeXBlID0gcGMuQkxFTkRfTk9STUFMO1xuICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICB0aGlzLmF1dG9QbGF5ID0gdHJ1ZTtcbiAgfTtcbiAgUGFydGljbGVTeXN0ZW1Db21wb25lbnREYXRhID0gcGMuaW5oZXJpdHMoUGFydGljbGVTeXN0ZW1Db21wb25lbnREYXRhLCBwYy5Db21wb25lbnREYXRhKTtcbiAgcmV0dXJuIHtQYXJ0aWNsZVN5c3RlbUNvbXBvbmVudERhdGE6UGFydGljbGVTeXN0ZW1Db21wb25lbnREYXRhfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICBwYy5TQ0FMRU1PREVfTk9ORSA9IFwibm9uZVwiO1xuICBwYy5TQ0FMRU1PREVfQkxFTkQgPSBcImJsZW5kXCI7XG4gIHZhciBTY3JlZW5Db21wb25lbnQgPSBmdW5jdGlvbiBTY3JlZW5Db21wb25lbnQoc3lzdGVtLCBlbnRpdHkpIHtcbiAgICB0aGlzLl9yZXNvbHV0aW9uID0gbmV3IHBjLlZlYzIoNjQwLCAzMjApO1xuICAgIHRoaXMuX3JlZmVyZW5jZVJlc29sdXRpb24gPSBuZXcgcGMuVmVjMig2NDAsIDMyMCk7XG4gICAgdGhpcy5fc2NhbGVNb2RlID0gcGMuU0NBTEVNT0RFX05PTkU7XG4gICAgdGhpcy5zY2FsZSA9IDE7XG4gICAgdGhpcy5fc2NhbGVCbGVuZCA9IDAuNTtcbiAgICB0aGlzLl9zY3JlZW5TcGFjZSA9IGZhbHNlO1xuICAgIHRoaXMuX3NjcmVlbk1hdHJpeCA9IG5ldyBwYy5NYXQ0O1xuICAgIHN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2Uub24oXCJyZXNpemVjYW52YXNcIiwgdGhpcy5fb25SZXNpemUsIHRoaXMpO1xuICB9O1xuICBTY3JlZW5Db21wb25lbnQgPSBwYy5pbmhlcml0cyhTY3JlZW5Db21wb25lbnQsIHBjLkNvbXBvbmVudCk7XG4gIHZhciBfdHJhbnNmb3JtID0gbmV3IHBjLk1hdDQ7XG4gIHBjLmV4dGVuZChTY3JlZW5Db21wb25lbnQucHJvdG90eXBlLCB7c3luY0RyYXdPcmRlcjpmdW5jdGlvbigpIHtcbiAgICB2YXIgaSA9IDE7XG4gICAgdmFyIHJlY3Vyc2UgPSBmdW5jdGlvbihlKSB7XG4gICAgICBpZiAoZS5lbGVtZW50KSB7XG4gICAgICAgIGUuZWxlbWVudC5kcmF3T3JkZXIgPSBpKys7XG4gICAgICB9XG4gICAgICB2YXIgY2hpbGRyZW4gPSBlLmdldENoaWxkcmVuKCk7XG4gICAgICBmb3IgKHZhciBqID0gMDtqIDwgY2hpbGRyZW4ubGVuZ3RoO2orKykge1xuICAgICAgICByZWN1cnNlKGNoaWxkcmVuW2pdKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHJlY3Vyc2UodGhpcy5lbnRpdHkpO1xuICB9LCBfY2FsY1Byb2plY3Rpb25NYXRyaXg6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIGxlZnQ7XG4gICAgdmFyIHJpZ2h0O1xuICAgIHZhciBib3R0b207XG4gICAgdmFyIHRvcDtcbiAgICB2YXIgbmVhciA9IDE7XG4gICAgdmFyIGZhciA9IC0xO1xuICAgIHZhciB3ID0gdGhpcy5fcmVzb2x1dGlvbi54IC8gdGhpcy5zY2FsZTtcbiAgICB2YXIgaCA9IHRoaXMuX3Jlc29sdXRpb24ueSAvIHRoaXMuc2NhbGU7XG4gICAgbGVmdCA9IDA7XG4gICAgcmlnaHQgPSB3O1xuICAgIGJvdHRvbSA9IC1oO1xuICAgIHRvcCA9IDA7XG4gICAgdGhpcy5fc2NyZWVuTWF0cml4LnNldE9ydGhvKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgbmVhciwgZmFyKTtcbiAgICBpZiAoIXRoaXMuX3NjcmVlblNwYWNlKSB7XG4gICAgICBfdHJhbnNmb3JtLnNldFNjYWxlKDAuNSAqIHcsIDAuNSAqIGgsIDEpO1xuICAgICAgdGhpcy5fc2NyZWVuTWF0cml4Lm11bDIoX3RyYW5zZm9ybSwgdGhpcy5fc2NyZWVuTWF0cml4KTtcbiAgICB9XG4gIH0sIF91cGRhdGVTY2FsZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLnNjYWxlID0gdGhpcy5fY2FsY1NjYWxlKHRoaXMuX3Jlc29sdXRpb24sIHRoaXMucmVmZXJlbmNlUmVzb2x1dGlvbik7XG4gIH0sIF9jYWxjU2NhbGU6ZnVuY3Rpb24ocmVzb2x1dGlvbiwgcmVmZXJlbmNlUmVzb2x1dGlvbikge1xuICAgIHZhciBseCA9IE1hdGgubG9nMihyZXNvbHV0aW9uLnggLyByZWZlcmVuY2VSZXNvbHV0aW9uLngpO1xuICAgIHZhciBseSA9IE1hdGgubG9nMihyZXNvbHV0aW9uLnkgLyByZWZlcmVuY2VSZXNvbHV0aW9uLnkpO1xuICAgIHJldHVybiBNYXRoLnBvdygyLCBseCAqICgxIC0gdGhpcy5fc2NhbGVCbGVuZCkgKyBseSAqIHRoaXMuX3NjYWxlQmxlbmQpO1xuICB9LCBfb25SZXNpemU6ZnVuY3Rpb24od2lkdGgsIGhlaWdodCkge1xuICAgIGlmICh0aGlzLl9zY3JlZW5TcGFjZSkge1xuICAgICAgdGhpcy5fcmVzb2x1dGlvbi5zZXQod2lkdGgsIGhlaWdodCk7XG4gICAgICB0aGlzLnJlc29sdXRpb24gPSB0aGlzLl9yZXNvbHV0aW9uO1xuICAgIH1cbiAgfSwgb25SZW1vdmU6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlLm9mZihcInJlc2l6ZWNhbnZhc1wiLCB0aGlzLl9vblJlc2l6ZSwgdGhpcyk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNjcmVlbkNvbXBvbmVudC5wcm90b3R5cGUsIFwicmVzb2x1dGlvblwiLCB7c2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKCF0aGlzLl9zY3JlZW5TcGFjZSkge1xuICAgICAgdGhpcy5fcmVzb2x1dGlvbi5zZXQodmFsdWUueCwgdmFsdWUueSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3Jlc29sdXRpb24uc2V0KHRoaXMuc3lzdGVtLmFwcC5ncmFwaGljc0RldmljZS53aWR0aCwgdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlLmhlaWdodCk7XG4gICAgfVxuICAgIHRoaXMuX3VwZGF0ZVNjYWxlKCk7XG4gICAgdGhpcy5fY2FsY1Byb2plY3Rpb25NYXRyaXgoKTtcbiAgICBpZiAoIXRoaXMuZW50aXR5Ll9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLmVudGl0eS5fZGlydGlmeSh0cnVlKTtcbiAgICB9XG4gICAgdGhpcy5maXJlKFwic2V0OnJlc29sdXRpb25cIiwgdGhpcy5fcmVzb2x1dGlvbik7XG4gIH0sIGdldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVzb2x1dGlvbjtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2NyZWVuQ29tcG9uZW50LnByb3RvdHlwZSwgXCJyZWZlcmVuY2VSZXNvbHV0aW9uXCIsIHtzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9yZWZlcmVuY2VSZXNvbHV0aW9uLnNldCh2YWx1ZS54LCB2YWx1ZS55KTtcbiAgICB0aGlzLl91cGRhdGVTY2FsZSgpO1xuICAgIHRoaXMuX2NhbGNQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgaWYgKCF0aGlzLmVudGl0eS5fZGlydHlMb2NhbCkge1xuICAgICAgdGhpcy5lbnRpdHkuX2RpcnRpZnkodHJ1ZSk7XG4gICAgfVxuICAgIHRoaXMuZmlyZShcInNldDpyZWZlcmVuY2VyZXNvbHV0aW9uXCIsIHRoaXMuX3Jlc29sdXRpb24pO1xuICB9LCBnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX3NjYWxlTW9kZSA9PT0gcGMuU0NBTEVNT0RFX05PTkUpIHtcbiAgICAgIHJldHVybiB0aGlzLl9yZXNvbHV0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5fcmVmZXJlbmNlUmVzb2x1dGlvbjtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNjcmVlbkNvbXBvbmVudC5wcm90b3R5cGUsIFwic2NyZWVuU3BhY2VcIiwge3NldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3NjcmVlblNwYWNlID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3NjcmVlblNwYWNlKSB7XG4gICAgICB0aGlzLl9yZXNvbHV0aW9uLnNldCh0aGlzLnN5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2Uud2lkdGgsIHRoaXMuc3lzdGVtLmFwcC5ncmFwaGljc0RldmljZS5oZWlnaHQpO1xuICAgIH1cbiAgICB0aGlzLnJlc29sdXRpb24gPSB0aGlzLl9yZXNvbHV0aW9uO1xuICAgIGlmICghdGhpcy5lbnRpdHkuX2RpcnR5TG9jYWwpIHtcbiAgICAgIHRoaXMuZW50aXR5Ll9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJzZXQ6c2NyZWVuc3BhY2VcIiwgdGhpcy5fc2NyZWVuU3BhY2UpO1xuICB9LCBnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NjcmVlblNwYWNlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY3JlZW5Db21wb25lbnQucHJvdG90eXBlLCBcInNjYWxlTW9kZVwiLCB7c2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlICE9PSBwYy5TQ0FMRU1PREVfTk9ORSAmJiB2YWx1ZSAhPT0gcGMuU0NBTEVNT0RFX0JMRU5EKSB7XG4gICAgICB2YWx1ZSA9IHBjLlNDQUxFTU9ERV9OT05FO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuX3NjcmVlblNwYWNlICYmIHZhbHVlICE9PSBwYy5TQ0FMRU1PREVfTk9ORSkge1xuICAgICAgdmFsdWUgPSBwYy5TQ0FMRU1PREVfTk9ORTtcbiAgICB9XG4gICAgdGhpcy5fc2NhbGVNb2RlID0gdmFsdWU7XG4gICAgdGhpcy5yZXNvbHV0aW9uID0gdGhpcy5fcmVzb2x1dGlvbjtcbiAgICB0aGlzLmZpcmUoXCJzZXQ6c2NhbGVtb2RlXCIsIHRoaXMuX3NjYWxlTW9kZSk7XG4gIH0sIGdldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2NhbGVNb2RlO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTY3JlZW5Db21wb25lbnQucHJvdG90eXBlLCBcInNjYWxlQmxlbmRcIiwge3NldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3NjYWxlQmxlbmQgPSB2YWx1ZTtcbiAgICB0aGlzLl91cGRhdGVTY2FsZSgpO1xuICAgIHRoaXMuX2NhbGNQcm9qZWN0aW9uTWF0cml4KCk7XG4gICAgaWYgKCF0aGlzLmVudGl0eS5fZGlydHlMb2NhbCkge1xuICAgICAgdGhpcy5lbnRpdHkuX2RpcnRpZnkodHJ1ZSk7XG4gICAgfVxuICAgIHRoaXMuZmlyZShcInNldDpzY2FsZWJsZW5kXCIsIHRoaXMuX3NjYWxlQmxlbmQpO1xuICB9LCBnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NjYWxlQmxlbmQ7XG4gIH19KTtcbiAgcmV0dXJuIHtTY3JlZW5Db21wb25lbnQ6U2NyZWVuQ29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3NjaGVtYSA9IFtcImVuYWJsZWRcIl07XG4gIHZhciBTY3JlZW5Db21wb25lbnRTeXN0ZW0gPSBmdW5jdGlvbiBTY3JlZW5Db21wb25lbnRTeXN0ZW0oYXBwKSB7XG4gICAgdGhpcy5pZCA9IFwic2NyZWVuXCI7XG4gICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgYXBwLnN5c3RlbXMuYWRkKHRoaXMuaWQsIHRoaXMpO1xuICAgIHRoaXMuQ29tcG9uZW50VHlwZSA9IHBjLlNjcmVlbkNvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuU2NyZWVuQ29tcG9uZW50RGF0YTtcbiAgICB0aGlzLnNjaGVtYSA9IF9zY2hlbWE7XG4gICAgdGhpcy53aW5kb3dSZXNvbHV0aW9uID0gbmV3IHBjLlZlYzI7XG4gICAgdGhpcy5hcHAuZ3JhcGhpY3NEZXZpY2Uub24oXCJyZXNpemVjYW52YXNcIiwgdGhpcy5fb25SZXNpemUsIHRoaXMpO1xuICAgIHBjLkNvbXBvbmVudFN5c3RlbS5vbihcInVwZGF0ZVwiLCB0aGlzLl9vblVwZGF0ZSwgdGhpcyk7XG4gICAgdGhpcy5vbihcImJlZm9yZXJlbW92ZVwiLCB0aGlzLm9uUmVtb3ZlQ29tcG9uZW50LCB0aGlzKTtcbiAgfTtcbiAgU2NyZWVuQ29tcG9uZW50U3lzdGVtID0gcGMuaW5oZXJpdHMoU2NyZWVuQ29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLlNjcmVlbkNvbXBvbmVudC5wcm90b3R5cGUsIF9zY2hlbWEpO1xuICBwYy5leHRlbmQoU2NyZWVuQ29tcG9uZW50U3lzdGVtLnByb3RvdHlwZSwge2luaXRpYWxpemVDb21wb25lbnREYXRhOmZ1bmN0aW9uKGNvbXBvbmVudCwgZGF0YSwgcHJvcGVydGllcykge1xuICAgIGlmIChkYXRhLnNjcmVlblNwYWNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbXBvbmVudC5zY3JlZW5TcGFjZSA9IGRhdGEuc2NyZWVuU3BhY2U7XG4gICAgfVxuICAgIGlmIChkYXRhLnNjYWxlTW9kZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb21wb25lbnQuc2NhbGVNb2RlID0gZGF0YS5zY2FsZU1vZGU7XG4gICAgfVxuICAgIGlmIChkYXRhLnNjYWxlQmxlbmQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29tcG9uZW50LnNjYWxlQmxlbmQgPSBkYXRhLnNjYWxlQmxlbmQ7XG4gICAgfVxuICAgIGlmIChkYXRhLnJlc29sdXRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKGRhdGEucmVzb2x1dGlvbiBpbnN0YW5jZW9mIHBjLlZlYzIpIHtcbiAgICAgICAgY29tcG9uZW50Ll9yZXNvbHV0aW9uLmNvcHkoZGF0YS5yZXNvbHV0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXBvbmVudC5fcmVzb2x1dGlvbi5zZXQoZGF0YS5yZXNvbHV0aW9uWzBdLCBkYXRhLnJlc29sdXRpb25bMV0pO1xuICAgICAgfVxuICAgICAgY29tcG9uZW50LnJlc29sdXRpb24gPSBjb21wb25lbnQuX3Jlc29sdXRpb247XG4gICAgfVxuICAgIGlmIChkYXRhLnJlZmVyZW5jZVJlc29sdXRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKGRhdGEucmVmZXJlbmNlUmVzb2x1dGlvbiBpbnN0YW5jZW9mIHBjLlZlYzIpIHtcbiAgICAgICAgY29tcG9uZW50Ll9yZWZlcmVuY2VSZXNvbHV0aW9uLmNvcHkoZGF0YS5yZWZlcmVuY2VSZXNvbHV0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXBvbmVudC5fcmVmZXJlbmNlUmVzb2x1dGlvbi5zZXQoZGF0YS5yZWZlcmVuY2VSZXNvbHV0aW9uWzBdLCBkYXRhLnJlZmVyZW5jZVJlc29sdXRpb25bMV0pO1xuICAgICAgfVxuICAgICAgY29tcG9uZW50LnJlZmVyZW5jZVJlc29sdXRpb24gPSBjb21wb25lbnQuX3JlZmVyZW5jZVJlc29sdXRpb247XG4gICAgfVxuICAgIFNjcmVlbkNvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCBfb25VcGRhdGU6ZnVuY3Rpb24oZHQpIHtcbiAgICB2YXIgY29tcG9uZW50cyA9IHRoaXMuc3RvcmU7XG4gICAgZm9yICh2YXIgaWQgaW4gY29tcG9uZW50cykge1xuICAgICAgaWYgKGNvbXBvbmVudHNbaWRdLmVudGl0eS5zY3JlZW4udXBkYXRlKSB7XG4gICAgICAgIGNvbXBvbmVudHNbaWRdLmVudGl0eS5zY3JlZW4udXBkYXRlKGR0KTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vblJlc2l6ZTpmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7XG4gICAgdGhpcy53aW5kb3dSZXNvbHV0aW9uLnggPSB3aWR0aDtcbiAgICB0aGlzLndpbmRvd1Jlc29sdXRpb24ueSA9IGhlaWdodDtcbiAgfSwgY2xvbmVDb21wb25lbnQ6ZnVuY3Rpb24oZW50aXR5LCBjbG9uZSkge1xuICAgIHZhciBzY3JlZW4gPSBlbnRpdHkuc2NyZWVuO1xuICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwge2VuYWJsZWQ6c2NyZWVuLmVuYWJsZWQsIHNjcmVlblNwYWNlOnNjcmVlbi5zY3JlZW5TcGFjZSwgc2NhbGVNb2RlOnNjcmVlbi5zY2FsZU1vZGUsIHJlc29sdXRpb246c2NyZWVuLnJlc29sdXRpb24uY2xvbmUoKSwgcmVmZXJlbmNlUmVzb2x1dGlvbjpzY3JlZW4ucmVmZXJlbmNlUmVzb2x1dGlvbi5jbG9uZSgpfSk7XG4gIH0sIG9uUmVtb3ZlQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY29tcG9uZW50KSB7XG4gICAgY29tcG9uZW50Lm9uUmVtb3ZlKCk7XG4gIH19KTtcbiAgcmV0dXJuIHtTY3JlZW5Db21wb25lbnRTeXN0ZW06U2NyZWVuQ29tcG9uZW50U3lzdGVtfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgU2NyZWVuQ29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gIH07XG4gIFNjcmVlbkNvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhTY3JlZW5Db21wb25lbnREYXRhLCBwYy5Db21wb25lbnREYXRhKTtcbiAgcmV0dXJuIHtTY3JlZW5Db21wb25lbnREYXRhOlNjcmVlbkNvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHBjLkVMRU1FTlRUWVBFX0dST1VQID0gXCJncm91cFwiO1xuICBwYy5FTEVNRU5UVFlQRV9JTUFHRSA9IFwiaW1hZ2VcIjtcbiAgcGMuRUxFTUVOVFRZUEVfVEVYVCA9IFwidGV4dFwiO1xuICB2YXIgdmVjQSA9IG5ldyBwYy5WZWMzO1xuICB2YXIgdmVjQiA9IG5ldyBwYy5WZWMzO1xuICB2YXIgbWF0QSA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgbWF0QiA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgbWF0QyA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgbWF0RCA9IG5ldyBwYy5NYXQ0O1xuICB2YXIgRWxlbWVudENvbXBvbmVudCA9IGZ1bmN0aW9uIEVsZW1lbnRDb21wb25lbnQoc3lzdGVtLCBlbnRpdHkpIHtcbiAgICB0aGlzLl9hbmNob3IgPSBuZXcgcGMuVmVjNDtcbiAgICB0aGlzLl9sb2NhbEFuY2hvciA9IG5ldyBwYy5WZWM0O1xuICAgIHRoaXMuX3Bpdm90ID0gbmV3IHBjLlZlYzI7XG4gICAgdGhpcy5fd2lkdGggPSAzMjtcbiAgICB0aGlzLl9oZWlnaHQgPSAzMjtcbiAgICB0aGlzLl9tYXJnaW4gPSBuZXcgcGMuVmVjNCgwLCAwLCAtMzIsIC0zMik7XG4gICAgdGhpcy5fbW9kZWxUcmFuc2Zvcm0gPSBuZXcgcGMuTWF0NDtcbiAgICB0aGlzLl9zY3JlZW5Ub1dvcmxkID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5fYW5jaG9yVHJhbnNmb3JtID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5fYW5jaG9yRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX3BhcmVudFdvcmxkVHJhbnNmb3JtID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5fc2NyZWVuVHJhbnNmb3JtID0gbmV3IHBjLk1hdDQ7XG4gICAgdGhpcy5fc2NyZWVuQ29ybmVycyA9IFtuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjM107XG4gICAgdGhpcy5fY2FudmFzQ29ybmVycyA9IFtuZXcgcGMuVmVjMiwgbmV3IHBjLlZlYzIsIG5ldyBwYy5WZWMyLCBuZXcgcGMuVmVjMl07XG4gICAgdGhpcy5fd29ybGRDb3JuZXJzID0gW25ldyBwYy5WZWMzLCBuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzXTtcbiAgICB0aGlzLl9jb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2NhbnZhc0Nvcm5lcnNEaXJ0eSA9IHRydWU7XG4gICAgdGhpcy5fd29ybGRDb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuZW50aXR5Lm9uKFwiaW5zZXJ0XCIsIHRoaXMuX29uSW5zZXJ0LCB0aGlzKTtcbiAgICB0aGlzLl9wYXRjaCgpO1xuICAgIHRoaXMuc2NyZWVuID0gbnVsbDtcbiAgICB0aGlzLl90eXBlID0gcGMuRUxFTUVOVFRZUEVfR1JPVVA7XG4gICAgdGhpcy5faW1hZ2UgPSBudWxsO1xuICAgIHRoaXMuX3RleHQgPSBudWxsO1xuICAgIHRoaXMuX2dyb3VwID0gbnVsbDtcbiAgICB0aGlzLl91c2VJbnB1dCA9IGZhbHNlO1xuICAgIHRoaXMuX2JhdGNoR3JvdXBJZCA9IC0xO1xuICB9O1xuICBFbGVtZW50Q29tcG9uZW50ID0gcGMuaW5oZXJpdHMoRWxlbWVudENvbXBvbmVudCwgcGMuQ29tcG9uZW50KTtcbiAgcGMuZXh0ZW5kKEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCB7X3BhdGNoOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW50aXR5Ll9zeW5jID0gdGhpcy5fc3luYztcbiAgICB0aGlzLmVudGl0eS5zZXRQb3NpdGlvbiA9IHRoaXMuX3NldFBvc2l0aW9uO1xuICAgIHRoaXMuZW50aXR5LnNldExvY2FsUG9zaXRpb24gPSB0aGlzLl9zZXRMb2NhbFBvc2l0aW9uO1xuICB9LCBfdW5wYXRjaDpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmVudGl0eS5fc3luYyA9IHBjLkVudGl0eS5wcm90b3R5cGUuX3N5bmM7XG4gICAgdGhpcy5lbnRpdHkuc2V0UG9zaXRpb24gPSBwYy5FbnRpdHkucHJvdG90eXBlLnNldFBvc2l0aW9uO1xuICAgIHRoaXMuZW50aXR5LnNldExvY2FsUG9zaXRpb24gPSBwYy5FbnRpdHkucHJvdG90eXBlLnNldExvY2FsUG9zaXRpb247XG4gIH0sIF9zZXRQb3NpdGlvbjpmdW5jdGlvbigpIHtcbiAgICB2YXIgcG9zaXRpb24gPSBuZXcgcGMuVmVjMztcbiAgICB2YXIgaW52UGFyZW50V3RtID0gbmV3IHBjLk1hdDQ7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHgsIHksIHopIHtcbiAgICAgIGlmICghdGhpcy5lbGVtZW50LnNjcmVlbikge1xuICAgICAgICByZXR1cm4gcGMuRW50aXR5LnByb3RvdHlwZS5zZXRQb3NpdGlvbi5jYWxsKHRoaXMsIHgsIHksIHopO1xuICAgICAgfVxuICAgICAgaWYgKHggaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICAgIHBvc2l0aW9uLmNvcHkoeCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwb3NpdGlvbi5zZXQoeCwgeSwgeik7XG4gICAgICB9XG4gICAgICB0aGlzLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgICBpbnZQYXJlbnRXdG0uY29weSh0aGlzLmVsZW1lbnQuX3NjcmVlblRvV29ybGQpLmludmVydCgpO1xuICAgICAgaW52UGFyZW50V3RtLnRyYW5zZm9ybVBvaW50KHBvc2l0aW9uLCB0aGlzLmxvY2FsUG9zaXRpb24pO1xuICAgICAgaWYgKCF0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICAgIHRoaXMuX2RpcnRpZnkodHJ1ZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfSgpLCBfc2V0TG9jYWxQb3NpdGlvbjpmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgaWYgKHggaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICB0aGlzLmxvY2FsUG9zaXRpb24uY29weSh4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbFBvc2l0aW9uLnNldCh4LCB5LCB6KTtcbiAgICB9XG4gICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7XG4gICAgdmFyIHAgPSB0aGlzLmxvY2FsUG9zaXRpb24uZGF0YTtcbiAgICB2YXIgcHZ0ID0gZWxlbWVudC5fcGl2b3QuZGF0YTtcbiAgICBlbGVtZW50Ll9tYXJnaW4uZGF0YVswXSA9IHBbMF0gLSBlbGVtZW50Ll93aWR0aCAqIHB2dFswXTtcbiAgICBlbGVtZW50Ll9tYXJnaW4uZGF0YVsyXSA9IGVsZW1lbnQuX2xvY2FsQW5jaG9yLmRhdGFbMl0gLSBlbGVtZW50Ll9sb2NhbEFuY2hvci5kYXRhWzBdIC0gZWxlbWVudC5fd2lkdGggLSBlbGVtZW50Ll9tYXJnaW4uZGF0YVswXTtcbiAgICBlbGVtZW50Ll9tYXJnaW4uZGF0YVsxXSA9IHBbMV0gLSBlbGVtZW50Ll9oZWlnaHQgKiBwdnRbMV07XG4gICAgZWxlbWVudC5fbWFyZ2luLmRhdGFbM10gPSBlbGVtZW50Ll9sb2NhbEFuY2hvci5kYXRhWzNdIC0gZWxlbWVudC5fbG9jYWxBbmNob3IuZGF0YVsxXSAtIGVsZW1lbnQuX2hlaWdodCAtIGVsZW1lbnQuX21hcmdpbi5kYXRhWzFdO1xuICAgIGlmICghdGhpcy5fZGlydHlMb2NhbCkge1xuICAgICAgdGhpcy5fZGlydGlmeSh0cnVlKTtcbiAgICB9XG4gIH0sIF9zeW5jOmZ1bmN0aW9uKCkge1xuICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50O1xuICAgIHZhciBzY3JlZW4gPSBlbGVtZW50LnNjcmVlbjtcbiAgICBpZiAoc2NyZWVuKSB7XG4gICAgICBpZiAoZWxlbWVudC5fYW5jaG9yRGlydHkpIHtcbiAgICAgICAgdmFyIHJlc3ggPSAwO1xuICAgICAgICB2YXIgcmVzeSA9IDA7XG4gICAgICAgIHZhciBweCA9IDA7XG4gICAgICAgIHZhciBweSA9IDE7XG4gICAgICAgIGlmICh0aGlzLl9wYXJlbnQgJiYgdGhpcy5fcGFyZW50LmVsZW1lbnQpIHtcbiAgICAgICAgICByZXN4ID0gdGhpcy5fcGFyZW50LmVsZW1lbnQud2lkdGg7XG4gICAgICAgICAgcmVzeSA9IHRoaXMuX3BhcmVudC5lbGVtZW50LmhlaWdodDtcbiAgICAgICAgICBweCA9IHRoaXMuX3BhcmVudC5lbGVtZW50LnBpdm90Lng7XG4gICAgICAgICAgcHkgPSB0aGlzLl9wYXJlbnQuZWxlbWVudC5waXZvdC55O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChzY3JlZW4pIHtcbiAgICAgICAgICAgIHZhciByZXNvbHV0aW9uID0gc2NyZWVuLnNjcmVlbi5yZXNvbHV0aW9uO1xuICAgICAgICAgICAgcmVzeCA9IHJlc29sdXRpb24ueCAvIHNjcmVlbi5zY3JlZW4uc2NhbGU7XG4gICAgICAgICAgICByZXN5ID0gcmVzb2x1dGlvbi55IC8gc2NyZWVuLnNjcmVlbi5zY2FsZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxlbWVudC5fYW5jaG9yVHJhbnNmb3JtLnNldFRyYW5zbGF0ZShyZXN4ICogKGVsZW1lbnQuYW5jaG9yLnggLSBweCksIC0ocmVzeSAqIChweSAtIGVsZW1lbnQuYW5jaG9yLnkpKSwgMCk7XG4gICAgICAgIGVsZW1lbnQuX2FuY2hvckRpcnR5ID0gZmFsc2U7XG4gICAgICAgIGVsZW1lbnQuX2NhbGN1bGF0ZUxvY2FsQW5jaG9ycygpO1xuICAgICAgfVxuICAgICAgaWYgKGVsZW1lbnQuX3NpemVEaXJ0eSkge1xuICAgICAgICBlbGVtZW50Ll9jYWxjdWxhdGVTaXplKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLl9kaXJ0eUxvY2FsKSB7XG4gICAgICB0aGlzLmxvY2FsVHJhbnNmb3JtLnNldFRSUyh0aGlzLmxvY2FsUG9zaXRpb24sIHRoaXMubG9jYWxSb3RhdGlvbiwgdGhpcy5sb2NhbFNjYWxlKTtcbiAgICAgIHZhciBwID0gdGhpcy5sb2NhbFBvc2l0aW9uLmRhdGE7XG4gICAgICB2YXIgcHZ0ID0gZWxlbWVudC5fcGl2b3QuZGF0YTtcbiAgICAgIGVsZW1lbnQuX21hcmdpbi5kYXRhWzBdID0gcFswXSAtIGVsZW1lbnQuX3dpZHRoICogcHZ0WzBdO1xuICAgICAgZWxlbWVudC5fbWFyZ2luLmRhdGFbMl0gPSBlbGVtZW50Ll9sb2NhbEFuY2hvci5kYXRhWzJdIC0gZWxlbWVudC5fbG9jYWxBbmNob3IuZGF0YVswXSAtIGVsZW1lbnQuX3dpZHRoIC0gZWxlbWVudC5fbWFyZ2luLmRhdGFbMF07XG4gICAgICBlbGVtZW50Ll9tYXJnaW4uZGF0YVsxXSA9IHBbMV0gLSBlbGVtZW50Ll9oZWlnaHQgKiBwdnRbMV07XG4gICAgICBlbGVtZW50Ll9tYXJnaW4uZGF0YVszXSA9IGVsZW1lbnQuX2xvY2FsQW5jaG9yLmRhdGFbM10gLSBlbGVtZW50Ll9sb2NhbEFuY2hvci5kYXRhWzFdIC0gZWxlbWVudC5faGVpZ2h0IC0gZWxlbWVudC5fbWFyZ2luLmRhdGFbMV07XG4gICAgICB0aGlzLl9kaXJ0eUxvY2FsID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICghc2NyZWVuKSB7XG4gICAgICBpZiAodGhpcy5fZGlydHlXb3JsZCkge1xuICAgICAgICBlbGVtZW50Ll9jb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgICAgICBlbGVtZW50Ll9jYW52YXNDb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgICAgICBlbGVtZW50Ll93b3JsZENvcm5lcnNEaXJ0eSA9IHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gcGMuRW50aXR5LnByb3RvdHlwZS5fc3luYy5jYWxsKHRoaXMpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZGlydHlXb3JsZCkge1xuICAgICAgaWYgKHRoaXMuX3BhcmVudCA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLndvcmxkVHJhbnNmb3JtLmNvcHkodGhpcy5sb2NhbFRyYW5zZm9ybSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5fcGFyZW50LmVsZW1lbnQpIHtcbiAgICAgICAgICBlbGVtZW50Ll9zY3JlZW5Ub1dvcmxkLm11bDIodGhpcy5fcGFyZW50LmVsZW1lbnQuX21vZGVsVHJhbnNmb3JtLCBlbGVtZW50Ll9hbmNob3JUcmFuc2Zvcm0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVsZW1lbnQuX3NjcmVlblRvV29ybGQuY29weShlbGVtZW50Ll9hbmNob3JUcmFuc2Zvcm0pO1xuICAgICAgICB9XG4gICAgICAgIGVsZW1lbnQuX21vZGVsVHJhbnNmb3JtLm11bDIoZWxlbWVudC5fc2NyZWVuVG9Xb3JsZCwgdGhpcy5sb2NhbFRyYW5zZm9ybSk7XG4gICAgICAgIGlmIChzY3JlZW4pIHtcbiAgICAgICAgICBlbGVtZW50Ll9zY3JlZW5Ub1dvcmxkLm11bDIoc2NyZWVuLnNjcmVlbi5fc2NyZWVuTWF0cml4LCBlbGVtZW50Ll9zY3JlZW5Ub1dvcmxkKTtcbiAgICAgICAgICBpZiAoIXNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpIHtcbiAgICAgICAgICAgIGVsZW1lbnQuX3NjcmVlblRvV29ybGQubXVsMihzY3JlZW4ud29ybGRUcmFuc2Zvcm0sIGVsZW1lbnQuX3NjcmVlblRvV29ybGQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLndvcmxkVHJhbnNmb3JtLm11bDIoZWxlbWVudC5fc2NyZWVuVG9Xb3JsZCwgdGhpcy5sb2NhbFRyYW5zZm9ybSk7XG4gICAgICAgICAgdmFyIHBhcmVudFdvcmxkVHJhbnNmb3JtID0gZWxlbWVudC5fcGFyZW50V29ybGRUcmFuc2Zvcm07XG4gICAgICAgICAgcGFyZW50V29ybGRUcmFuc2Zvcm0uc2V0SWRlbnRpdHkoKTtcbiAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50O1xuICAgICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LmVsZW1lbnQgJiYgcGFyZW50ICE9PSBzY3JlZW4pIHtcbiAgICAgICAgICAgIG1hdEEuc2V0VFJTKHBjLlZlYzMuWkVSTywgcGFyZW50LmdldExvY2FsUm90YXRpb24oKSwgcGFyZW50LmdldExvY2FsU2NhbGUoKSk7XG4gICAgICAgICAgICBwYXJlbnRXb3JsZFRyYW5zZm9ybS5tdWwyKHBhcmVudC5lbGVtZW50Ll9wYXJlbnRXb3JsZFRyYW5zZm9ybSwgbWF0QSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciBkZXB0aE9mZnNldCA9IHZlY0E7XG4gICAgICAgICAgZGVwdGhPZmZzZXQuc2V0KDAsIDAsIHRoaXMubG9jYWxQb3NpdGlvbi56KTtcbiAgICAgICAgICB2YXIgcGl2b3RPZmZzZXQgPSB2ZWNCO1xuICAgICAgICAgIHBpdm90T2Zmc2V0LnNldChlbGVtZW50Ll9hYnNMZWZ0ICsgZWxlbWVudC5fcGl2b3QueCAqIGVsZW1lbnQud2lkdGgsIGVsZW1lbnQuX2Fic0JvdHRvbSArIGVsZW1lbnQuX3Bpdm90LnkgKiBlbGVtZW50LmhlaWdodCwgMCk7XG4gICAgICAgICAgbWF0QS5zZXRUcmFuc2xhdGUoLXBpdm90T2Zmc2V0LngsIC1waXZvdE9mZnNldC55LCAtcGl2b3RPZmZzZXQueik7XG4gICAgICAgICAgbWF0Qi5zZXRUUlMoZGVwdGhPZmZzZXQsIHRoaXMuZ2V0TG9jYWxSb3RhdGlvbigpLCB0aGlzLmdldExvY2FsU2NhbGUoKSk7XG4gICAgICAgICAgbWF0Qy5zZXRUcmFuc2xhdGUocGl2b3RPZmZzZXQueCwgcGl2b3RPZmZzZXQueSwgcGl2b3RPZmZzZXQueik7XG4gICAgICAgICAgZWxlbWVudC5fc2NyZWVuVHJhbnNmb3JtLm11bDIoZWxlbWVudC5fcGFyZW50V29ybGRUcmFuc2Zvcm0sIG1hdEMpLm11bChtYXRCKS5tdWwobWF0QSk7XG4gICAgICAgICAgZWxlbWVudC5fY29ybmVyc0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICBlbGVtZW50Ll9jYW52YXNDb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgICAgICAgIGVsZW1lbnQuX3dvcmxkQ29ybmVyc0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLndvcmxkVHJhbnNmb3JtLmNvcHkoZWxlbWVudC5fbW9kZWxUcmFuc2Zvcm0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLl9kaXJ0eVdvcmxkID0gZmFsc2U7XG4gICAgfVxuICB9LCBfb25JbnNlcnQ6ZnVuY3Rpb24ocGFyZW50KSB7XG4gICAgdmFyIHNjcmVlbiA9IHRoaXMuX2ZpbmRTY3JlZW4oKTtcbiAgICB0aGlzLmVudGl0eS5fZGlydGlmeSgpO1xuICAgIHRoaXMuX3VwZGF0ZVNjcmVlbihzY3JlZW4pO1xuICB9LCBfdXBkYXRlU2NyZWVuOmZ1bmN0aW9uKHNjcmVlbikge1xuICAgIGlmICh0aGlzLnNjcmVlbiAmJiB0aGlzLnNjcmVlbiAhPT0gc2NyZWVuKSB7XG4gICAgICB0aGlzLnNjcmVlbi5zY3JlZW4ub2ZmKFwic2V0OnJlc29sdXRpb25cIiwgdGhpcy5fb25TY3JlZW5SZXNpemUsIHRoaXMpO1xuICAgICAgdGhpcy5zY3JlZW4uc2NyZWVuLm9mZihcInNldDpyZWZlcmVuY2VyZXNvbHV0aW9uXCIsIHRoaXMuX29uU2NyZWVuUmVzaXplLCB0aGlzKTtcbiAgICAgIHRoaXMuc2NyZWVuLnNjcmVlbi5vZmYoXCJzZXQ6c2NhbGVibGVuZFwiLCB0aGlzLl9vblNjcmVlblJlc2l6ZSwgdGhpcyk7XG4gICAgICB0aGlzLnNjcmVlbi5zY3JlZW4ub2ZmKFwic2V0OnNjcmVlbnNwYWNlXCIsIHRoaXMuX29uU2NyZWVuU3BhY2VDaGFuZ2UsIHRoaXMpO1xuICAgIH1cbiAgICB0aGlzLnNjcmVlbiA9IHNjcmVlbjtcbiAgICBpZiAodGhpcy5zY3JlZW4pIHtcbiAgICAgIHRoaXMuc2NyZWVuLnNjcmVlbi5vbihcInNldDpyZXNvbHV0aW9uXCIsIHRoaXMuX29uU2NyZWVuUmVzaXplLCB0aGlzKTtcbiAgICAgIHRoaXMuc2NyZWVuLnNjcmVlbi5vbihcInNldDpyZWZlcmVuY2VyZXNvbHV0aW9uXCIsIHRoaXMuX29uU2NyZWVuUmVzaXplLCB0aGlzKTtcbiAgICAgIHRoaXMuc2NyZWVuLnNjcmVlbi5vbihcInNldDpzY2FsZWJsZW5kXCIsIHRoaXMuX29uU2NyZWVuUmVzaXplLCB0aGlzKTtcbiAgICAgIHRoaXMuc2NyZWVuLnNjcmVlbi5vbihcInNldDpzY3JlZW5zcGFjZVwiLCB0aGlzLl9vblNjcmVlblNwYWNlQ2hhbmdlLCB0aGlzKTtcbiAgICB9XG4gICAgdGhpcy5fY2FsY3VsYXRlU2l6ZSgpO1xuICAgIHRoaXMuZmlyZShcInNldDpzY3JlZW5cIiwgdGhpcy5zY3JlZW4pO1xuICAgIHRoaXMuX2FuY2hvckRpcnR5ID0gdHJ1ZTtcbiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmVudGl0eS5nZXRDaGlsZHJlbigpO1xuICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGRyZW4ubGVuZ3RoO2kgPCBsO2krKykge1xuICAgICAgaWYgKGNoaWxkcmVuW2ldLmVsZW1lbnQpIHtcbiAgICAgICAgY2hpbGRyZW5baV0uZWxlbWVudC5fdXBkYXRlU2NyZWVuKHNjcmVlbik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnNjcmVlbikge1xuICAgICAgdGhpcy5zY3JlZW4uc2NyZWVuLnN5bmNEcmF3T3JkZXIoKTtcbiAgICB9XG4gIH0sIF9maW5kU2NyZWVuOmZ1bmN0aW9uKCkge1xuICAgIHZhciBzY3JlZW4gPSB0aGlzLmVudGl0eS5fcGFyZW50O1xuICAgIHdoaWxlIChzY3JlZW4gJiYgIXNjcmVlbi5zY3JlZW4pIHtcbiAgICAgIHNjcmVlbiA9IHNjcmVlbi5fcGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gc2NyZWVuO1xuICB9LCBfb25TY3JlZW5SZXNpemU6ZnVuY3Rpb24ocmVzKSB7XG4gICAgdGhpcy5fYW5jaG9yRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2Nvcm5lcnNEaXJ0eSA9IHRydWU7XG4gICAgdGhpcy5fd29ybGRDb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgIHRoaXMuX2NhbGN1bGF0ZVNpemUoKTtcbiAgICB0aGlzLmZpcmUoXCJzY3JlZW46c2V0OnJlc29sdXRpb25cIiwgcmVzKTtcbiAgfSwgX29uU2NyZWVuU3BhY2VDaGFuZ2U6ZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5maXJlKFwic2NyZWVuOnNldDpzY3JlZW5zcGFjZVwiLCB0aGlzLnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpO1xuICB9LCBfY2FsY3VsYXRlTG9jYWxBbmNob3JzOmZ1bmN0aW9uKCkge1xuICAgIHZhciByZXN4ID0gMTAwMDtcbiAgICB2YXIgcmVzeSA9IDEwMDA7XG4gICAgdmFyIHBhcmVudCA9IHRoaXMuZW50aXR5Ll9wYXJlbnQ7XG4gICAgaWYgKHBhcmVudCAmJiBwYXJlbnQuZWxlbWVudCkge1xuICAgICAgcmVzeCA9IHBhcmVudC5lbGVtZW50LndpZHRoO1xuICAgICAgcmVzeSA9IHBhcmVudC5lbGVtZW50LmhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuc2NyZWVuKSB7XG4gICAgICAgIHZhciByZXMgPSB0aGlzLnNjcmVlbi5zY3JlZW4ucmVzb2x1dGlvbjtcbiAgICAgICAgdmFyIHNjYWxlID0gdGhpcy5zY3JlZW4uc2NyZWVuLnNjYWxlO1xuICAgICAgICByZXN4ID0gcmVzLnggLyBzY2FsZTtcbiAgICAgICAgcmVzeSA9IHJlcy55IC8gc2NhbGU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2xvY2FsQW5jaG9yLnNldCh0aGlzLl9hbmNob3IueCAqIHJlc3gsIHRoaXMuX2FuY2hvci55ICogcmVzeSwgdGhpcy5fYW5jaG9yLnogKiByZXN4LCB0aGlzLl9hbmNob3IudyAqIHJlc3kpO1xuICB9LCBnZXRPZmZzZXRQb3NpdGlvbjpmdW5jdGlvbih4LCB5KSB7XG4gICAgdmFyIHAgPSB0aGlzLmVudGl0eS5nZXRMb2NhbFBvc2l0aW9uKCkuY2xvbmUoKTtcbiAgICBwLnggKz0geDtcbiAgICBwLnkgKz0geTtcbiAgICB0aGlzLl9zY3JlZW5Ub1dvcmxkLnRyYW5zZm9ybVBvaW50KHAsIHApO1xuICAgIHJldHVybiBwO1xuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBFbGVtZW50Q29tcG9uZW50Ll9zdXBlci5vbkVuYWJsZS5jYWxsKHRoaXMpO1xuICAgIGlmICh0aGlzLl9pbWFnZSkge1xuICAgICAgdGhpcy5faW1hZ2Uub25FbmFibGUoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3RleHQpIHtcbiAgICAgIHRoaXMuX3RleHQub25FbmFibGUoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2dyb3VwKSB7XG4gICAgICB0aGlzLl9ncm91cC5vbkVuYWJsZSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy51c2VJbnB1dCAmJiB0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0KSB7XG4gICAgICB0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0LmFkZEVsZW1lbnQodGhpcyk7XG4gICAgfVxuICB9LCBvbkRpc2FibGU6ZnVuY3Rpb24oKSB7XG4gICAgRWxlbWVudENvbXBvbmVudC5fc3VwZXIub25EaXNhYmxlLmNhbGwodGhpcyk7XG4gICAgaWYgKHRoaXMuX2ltYWdlKSB7XG4gICAgICB0aGlzLl9pbWFnZS5vbkRpc2FibGUoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3RleHQpIHtcbiAgICAgIHRoaXMuX3RleHQub25EaXNhYmxlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9ncm91cCkge1xuICAgICAgdGhpcy5fZ3JvdXAub25EaXNhYmxlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0ICYmIHRoaXMudXNlSW5wdXQpIHtcbiAgICAgIHRoaXMuc3lzdGVtLmFwcC5lbGVtZW50SW5wdXQucmVtb3ZlRWxlbWVudCh0aGlzKTtcbiAgICB9XG4gIH0sIG9uUmVtb3ZlOmZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW50aXR5Lm9mZihcImluc2VydFwiLCB0aGlzLl9vbkluc2VydCwgdGhpcyk7XG4gICAgdGhpcy5fdW5wYXRjaCgpO1xuICAgIGlmICh0aGlzLl9pbWFnZSkge1xuICAgICAgdGhpcy5faW1hZ2UuZGVzdHJveSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fdGV4dCkge1xuICAgICAgdGhpcy5fdGV4dC5kZXN0cm95KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0ICYmIHRoaXMudXNlSW5wdXQpIHtcbiAgICAgIHRoaXMuc3lzdGVtLmFwcC5lbGVtZW50SW5wdXQucmVtb3ZlRWxlbWVudCh0aGlzKTtcbiAgICB9XG4gIH0sIF9jYWxjdWxhdGVTaXplOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5lbnRpdHkuX3BhcmVudCAmJiAhdGhpcy5zY3JlZW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fY2FsY3VsYXRlTG9jYWxBbmNob3JzKCk7XG4gICAgdmFyIHAgPSB0aGlzLmVudGl0eS5nZXRMb2NhbFBvc2l0aW9uKCk7XG4gICAgdGhpcy5fc2V0V2lkdGgodGhpcy5fYWJzUmlnaHQgLSB0aGlzLl9hYnNMZWZ0KTtcbiAgICB0aGlzLl9zZXRIZWlnaHQodGhpcy5fYWJzVG9wIC0gdGhpcy5fYWJzQm90dG9tKTtcbiAgICBwLnggPSB0aGlzLl9tYXJnaW4uZGF0YVswXSArIHRoaXMuX3dpZHRoICogdGhpcy5fcGl2b3QuZGF0YVswXTtcbiAgICBwLnkgPSB0aGlzLl9tYXJnaW4uZGF0YVsxXSArIHRoaXMuX2hlaWdodCAqIHRoaXMuX3Bpdm90LmRhdGFbMV07XG4gICAgdGhpcy5lbnRpdHkuc2V0TG9jYWxQb3NpdGlvbihwKTtcbiAgICB0aGlzLl9zaXplRGlydHkgPSBmYWxzZTtcbiAgfSwgX3NldFdpZHRoOmZ1bmN0aW9uKHcpIHtcbiAgICB0aGlzLl93aWR0aCA9IHc7XG4gICAgdmFyIGksIGw7XG4gICAgdmFyIGMgPSB0aGlzLmVudGl0eS5fY2hpbGRyZW47XG4gICAgZm9yIChpID0gMCwgbCA9IGMubGVuZ3RoO2kgPCBsO2krKykge1xuICAgICAgaWYgKGNbaV0uZWxlbWVudCkge1xuICAgICAgICBjW2ldLmVsZW1lbnQuX2FuY2hvckRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgY1tpXS5lbGVtZW50Ll9zaXplRGlydHkgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJzZXQ6d2lkdGhcIiwgdGhpcy5fd2lkdGgpO1xuICAgIHRoaXMuZmlyZShcInJlc2l6ZVwiLCB0aGlzLl93aWR0aCwgdGhpcy5faGVpZ2h0KTtcbiAgfSwgX3NldEhlaWdodDpmdW5jdGlvbihoKSB7XG4gICAgdGhpcy5faGVpZ2h0ID0gaDtcbiAgICB2YXIgaSwgbDtcbiAgICB2YXIgYyA9IHRoaXMuZW50aXR5Ll9jaGlsZHJlbjtcbiAgICBmb3IgKGkgPSAwLCBsID0gYy5sZW5ndGg7aSA8IGw7aSsrKSB7XG4gICAgICBpZiAoY1tpXS5lbGVtZW50KSB7XG4gICAgICAgIGNbaV0uZWxlbWVudC5fYW5jaG9yRGlydHkgPSB0cnVlO1xuICAgICAgICBjW2ldLmVsZW1lbnQuX3NpemVEaXJ0eSA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZmlyZShcInNldDpoZWlnaHRcIiwgdGhpcy5faGVpZ2h0KTtcbiAgICB0aGlzLmZpcmUoXCJyZXNpemVcIiwgdGhpcy5fd2lkdGgsIHRoaXMuX2hlaWdodCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcInR5cGVcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlICE9PSB0aGlzLl90eXBlKSB7XG4gICAgICB0aGlzLl90eXBlID0gdmFsdWU7XG4gICAgICBpZiAodGhpcy5faW1hZ2UpIHtcbiAgICAgICAgdGhpcy5faW1hZ2UuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLl9pbWFnZSA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fdGV4dCkge1xuICAgICAgICB0aGlzLl90ZXh0LmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5fdGV4dCA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAodmFsdWUgPT09IHBjLkVMRU1FTlRUWVBFX0lNQUdFKSB7XG4gICAgICAgIHRoaXMuX2ltYWdlID0gbmV3IHBjLkltYWdlRWxlbWVudCh0aGlzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gcGMuRUxFTUVOVFRZUEVfVEVYVCkge1xuICAgICAgICAgIHRoaXMuX3RleHQgPSBuZXcgcGMuVGV4dEVsZW1lbnQodGhpcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcImRyYXdPcmRlclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9kcmF3T3JkZXI7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2RyYXdPcmRlciA9IHZhbHVlO1xuICAgIHRoaXMuZmlyZShcInNldDpkcmF3b3JkZXJcIiwgdGhpcy5fZHJhd09yZGVyKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwiX2Fic0xlZnRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbG9jYWxBbmNob3IuZGF0YVswXSArIHRoaXMuX21hcmdpbi5kYXRhWzBdO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJfYWJzUmlnaHRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbG9jYWxBbmNob3IuZGF0YVsyXSAtIHRoaXMuX21hcmdpbi5kYXRhWzJdO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJfYWJzVG9wXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xvY2FsQW5jaG9yLmRhdGFbM10gLSB0aGlzLl9tYXJnaW4uZGF0YVszXTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwiX2Fic0JvdHRvbVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzFdICsgdGhpcy5fbWFyZ2luLmRhdGFbMV07XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcIm1hcmdpblwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9tYXJnaW47XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX21hcmdpbi5jb3B5KHZhbHVlKTtcbiAgICB0aGlzLl9jYWxjdWxhdGVTaXplKCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcImxlZnRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWFyZ2luLmRhdGFbMF07XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX21hcmdpbi5kYXRhWzBdID0gdmFsdWU7XG4gICAgdmFyIHAgPSB0aGlzLmVudGl0eS5nZXRMb2NhbFBvc2l0aW9uKCk7XG4gICAgdmFyIHdyID0gdGhpcy5fYWJzUmlnaHQ7XG4gICAgdmFyIHdsID0gdGhpcy5fbG9jYWxBbmNob3IuZGF0YVswXSArIHZhbHVlO1xuICAgIHRoaXMuX3NldFdpZHRoKHdyIC0gd2wpO1xuICAgIHAueCA9IHZhbHVlICsgdGhpcy5fd2lkdGggKiB0aGlzLl9waXZvdC5kYXRhWzBdO1xuICAgIHRoaXMuZW50aXR5LnNldExvY2FsUG9zaXRpb24ocCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcInJpZ2h0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX21hcmdpbi5kYXRhWzJdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVsyXSA9IHZhbHVlO1xuICAgIHZhciBwID0gdGhpcy5lbnRpdHkuZ2V0TG9jYWxQb3NpdGlvbigpO1xuICAgIHZhciB3bCA9IHRoaXMuX2Fic0xlZnQ7XG4gICAgdmFyIHdyID0gdGhpcy5fbG9jYWxBbmNob3IuZGF0YVsyXSAtIHZhbHVlO1xuICAgIHRoaXMuX3NldFdpZHRoKHdyIC0gd2wpO1xuICAgIHAueCA9IHRoaXMuX2xvY2FsQW5jaG9yLmRhdGFbMl0gLSB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzBdIC0gdmFsdWUgLSB0aGlzLl93aWR0aCAqICgxIC0gdGhpcy5fcGl2b3QuZGF0YVswXSk7XG4gICAgdGhpcy5lbnRpdHkuc2V0TG9jYWxQb3NpdGlvbihwKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwidG9wXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX21hcmdpbi5kYXRhWzNdO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVszXSA9IHZhbHVlO1xuICAgIHZhciBwID0gdGhpcy5lbnRpdHkuZ2V0TG9jYWxQb3NpdGlvbigpO1xuICAgIHZhciB3YiA9IHRoaXMuX2Fic0JvdHRvbTtcbiAgICB2YXIgd3QgPSB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzNdIC0gdmFsdWU7XG4gICAgdGhpcy5fc2V0SGVpZ2h0KHd0IC0gd2IpO1xuICAgIHAueSA9IHRoaXMuX2xvY2FsQW5jaG9yLmRhdGFbM10gLSB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzFdIC0gdmFsdWUgLSB0aGlzLl9oZWlnaHQgKiAoMSAtIHRoaXMuX3Bpdm90LmRhdGFbMV0pO1xuICAgIHRoaXMuZW50aXR5LnNldExvY2FsUG9zaXRpb24ocCk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcImJvdHRvbVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9tYXJnaW4uZGF0YVsxXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fbWFyZ2luLmRhdGFbMV0gPSB2YWx1ZTtcbiAgICB2YXIgcCA9IHRoaXMuZW50aXR5LmdldExvY2FsUG9zaXRpb24oKTtcbiAgICB2YXIgd3QgPSB0aGlzLl9hYnNUb3A7XG4gICAgdmFyIHdiID0gdGhpcy5fbG9jYWxBbmNob3IuZGF0YVsxXSArIHZhbHVlO1xuICAgIHRoaXMuX3NldEhlaWdodCh3dCAtIHdiKTtcbiAgICBwLnkgPSB2YWx1ZSArIHRoaXMuX2hlaWdodCAqIHRoaXMuX3Bpdm90LmRhdGFbMV07XG4gICAgdGhpcy5lbnRpdHkuc2V0TG9jYWxQb3NpdGlvbihwKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwid2lkdGhcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fd2lkdGg7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3dpZHRoID0gdmFsdWU7XG4gICAgdmFyIHAgPSB0aGlzLmVudGl0eS5nZXRMb2NhbFBvc2l0aW9uKCkuZGF0YTtcbiAgICB2YXIgcHZ0ID0gdGhpcy5fcGl2b3QuZGF0YTtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVswXSA9IHBbMF0gLSB0aGlzLl93aWR0aCAqIHB2dFswXTtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVsyXSA9IHRoaXMuX2xvY2FsQW5jaG9yLmRhdGFbMl0gLSB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzBdIC0gdGhpcy5fd2lkdGggLSB0aGlzLl9tYXJnaW4uZGF0YVswXTtcbiAgICB2YXIgaSwgbDtcbiAgICB2YXIgYyA9IHRoaXMuZW50aXR5Ll9jaGlsZHJlbjtcbiAgICBmb3IgKGkgPSAwLCBsID0gYy5sZW5ndGg7aSA8IGw7aSsrKSB7XG4gICAgICBpZiAoY1tpXS5lbGVtZW50KSB7XG4gICAgICAgIGNbaV0uZWxlbWVudC5fYW5jaG9yRGlydHkgPSB0cnVlO1xuICAgICAgICBjW2ldLmVsZW1lbnQuX3NpemVEaXJ0eSA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZmlyZShcInNldDp3aWR0aFwiLCB0aGlzLl93aWR0aCk7XG4gICAgdGhpcy5maXJlKFwicmVzaXplXCIsIHRoaXMuX3dpZHRoLCB0aGlzLl9oZWlnaHQpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJoZWlnaHRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5faGVpZ2h0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9oZWlnaHQgPSB2YWx1ZTtcbiAgICB2YXIgcCA9IHRoaXMuZW50aXR5LmdldExvY2FsUG9zaXRpb24oKS5kYXRhO1xuICAgIHZhciBwdnQgPSB0aGlzLl9waXZvdC5kYXRhO1xuICAgIHRoaXMuX21hcmdpbi5kYXRhWzFdID0gcFsxXSAtIHRoaXMuX2hlaWdodCAqIHB2dFsxXTtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVszXSA9IHRoaXMuX2xvY2FsQW5jaG9yLmRhdGFbM10gLSB0aGlzLl9sb2NhbEFuY2hvci5kYXRhWzFdIC0gdGhpcy5faGVpZ2h0IC0gdGhpcy5fbWFyZ2luLmRhdGFbMV07XG4gICAgdmFyIGksIGw7XG4gICAgdmFyIGMgPSB0aGlzLmVudGl0eS5fY2hpbGRyZW47XG4gICAgZm9yIChpID0gMCwgbCA9IGMubGVuZ3RoO2kgPCBsO2krKykge1xuICAgICAgaWYgKGNbaV0uZWxlbWVudCkge1xuICAgICAgICBjW2ldLmVsZW1lbnQuX2FuY2hvckRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgY1tpXS5lbGVtZW50Ll9zaXplRGlydHkgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJzZXQ6aGVpZ2h0XCIsIHRoaXMuX2hlaWdodCk7XG4gICAgdGhpcy5maXJlKFwicmVzaXplXCIsIHRoaXMuX3dpZHRoLCB0aGlzLl9oZWlnaHQpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJwaXZvdFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9waXZvdDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIHByZXZYID0gdGhpcy5fcGl2b3QueDtcbiAgICB2YXIgcHJldlkgPSB0aGlzLl9waXZvdC55O1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHBjLlZlYzIpIHtcbiAgICAgIHRoaXMuX3Bpdm90LnNldCh2YWx1ZS54LCB2YWx1ZS55KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fcGl2b3Quc2V0KHZhbHVlWzBdLCB2YWx1ZVsxXSk7XG4gICAgfVxuICAgIHZhciBteCA9IHRoaXMuX21hcmdpbi5kYXRhWzBdICsgdGhpcy5fbWFyZ2luLmRhdGFbMl07XG4gICAgdmFyIGR4ID0gdGhpcy5fcGl2b3QueCAtIHByZXZYO1xuICAgIHRoaXMuX21hcmdpbi5kYXRhWzBdICs9IG14ICogZHg7XG4gICAgdGhpcy5fbWFyZ2luLmRhdGFbMl0gLT0gbXggKiBkeDtcbiAgICB2YXIgbXkgPSB0aGlzLl9tYXJnaW4uZGF0YVsxXSArIHRoaXMuX21hcmdpbi5kYXRhWzNdO1xuICAgIHZhciBkeSA9IHRoaXMuX3Bpdm90LnkgLSBwcmV2WTtcbiAgICB0aGlzLl9tYXJnaW4uZGF0YVsxXSArPSBteSAqIGR5O1xuICAgIHRoaXMuX21hcmdpbi5kYXRhWzNdIC09IG15ICogZHk7XG4gICAgdGhpcy5fb25TY3JlZW5SZXNpemUoKTtcbiAgICB0aGlzLmZpcmUoXCJzZXQ6cGl2b3RcIiwgdGhpcy5fcGl2b3QpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJhbmNob3JcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fYW5jaG9yO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBwYy5WZWM0KSB7XG4gICAgICB0aGlzLl9hbmNob3Iuc2V0KHZhbHVlLngsIHZhbHVlLnksIHZhbHVlLnosIHZhbHVlLncpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9hbmNob3Iuc2V0KHZhbHVlWzBdLCB2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmVudGl0eS5fcGFyZW50ICYmICF0aGlzLnNjcmVlbikge1xuICAgICAgdGhpcy5fY2FsY3VsYXRlTG9jYWxBbmNob3JzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NhbGN1bGF0ZVNpemUoKTtcbiAgICB9XG4gICAgdGhpcy5fYW5jaG9yRGlydHkgPSB0cnVlO1xuICAgIGlmICghdGhpcy5lbnRpdHkuX2RpcnR5TG9jYWwpIHtcbiAgICAgIHRoaXMuZW50aXR5Ll9kaXJ0aWZ5KHRydWUpO1xuICAgIH1cbiAgICB0aGlzLmZpcmUoXCJzZXQ6YW5jaG9yXCIsIHRoaXMuX2FuY2hvcik7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcInNjcmVlbkNvcm5lcnNcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuX2Nvcm5lcnNEaXJ0eSB8fCAhdGhpcy5zY3JlZW4pIHtcbiAgICAgIHJldHVybiB0aGlzLl9zY3JlZW5Db3JuZXJzO1xuICAgIH1cbiAgICB2YXIgcGFyZW50Qm90dG9tTGVmdCA9IHRoaXMuZW50aXR5LnBhcmVudCAmJiB0aGlzLmVudGl0eS5wYXJlbnQuZWxlbWVudCAmJiB0aGlzLmVudGl0eS5wYXJlbnQuZWxlbWVudC5zY3JlZW5Db3JuZXJzWzBdO1xuICAgIHRoaXMuX3NjcmVlbkNvcm5lcnNbMF0uc2V0KHRoaXMuX2Fic0xlZnQsIHRoaXMuX2Fic0JvdHRvbSwgMCk7XG4gICAgdGhpcy5fc2NyZWVuQ29ybmVyc1sxXS5zZXQodGhpcy5fYWJzUmlnaHQsIHRoaXMuX2Fic0JvdHRvbSwgMCk7XG4gICAgdGhpcy5fc2NyZWVuQ29ybmVyc1syXS5zZXQodGhpcy5fYWJzUmlnaHQsIHRoaXMuX2Fic1RvcCwgMCk7XG4gICAgdGhpcy5fc2NyZWVuQ29ybmVyc1szXS5zZXQodGhpcy5fYWJzTGVmdCwgdGhpcy5fYWJzVG9wLCAwKTtcbiAgICB2YXIgc2NyZWVuU3BhY2UgPSB0aGlzLnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2U7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDQ7aSsrKSB7XG4gICAgICB0aGlzLl9zY3JlZW5UcmFuc2Zvcm0udHJhbnNmb3JtUG9pbnQodGhpcy5fc2NyZWVuQ29ybmVyc1tpXSwgdGhpcy5fc2NyZWVuQ29ybmVyc1tpXSk7XG4gICAgICBpZiAoc2NyZWVuU3BhY2UpIHtcbiAgICAgICAgdGhpcy5fc2NyZWVuQ29ybmVyc1tpXS5zY2FsZSh0aGlzLnNjcmVlbi5zY3JlZW4uc2NhbGUpO1xuICAgICAgfVxuICAgICAgaWYgKHBhcmVudEJvdHRvbUxlZnQpIHtcbiAgICAgICAgdGhpcy5fc2NyZWVuQ29ybmVyc1tpXS5hZGQocGFyZW50Qm90dG9tTGVmdCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2Nvcm5lcnNEaXJ0eSA9IGZhbHNlO1xuICAgIHRoaXMuX2NhbnZhc0Nvcm5lcnNEaXJ0eSA9IHRydWU7XG4gICAgdGhpcy5fd29ybGRDb3JuZXJzRGlydHkgPSB0cnVlO1xuICAgIHJldHVybiB0aGlzLl9zY3JlZW5Db3JuZXJzO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJjYW52YXNDb3JuZXJzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLl9jYW52YXNDb3JuZXJzRGlydHkgfHwgIXRoaXMuc2NyZWVuIHx8ICF0aGlzLnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jYW52YXNDb3JuZXJzO1xuICAgIH1cbiAgICB2YXIgZGV2aWNlID0gdGhpcy5zeXN0ZW0uYXBwLmdyYXBoaWNzRGV2aWNlO1xuICAgIHZhciBzY3JlZW5Db3JuZXJzID0gdGhpcy5zY3JlZW5Db3JuZXJzO1xuICAgIHZhciBzeCA9IGRldmljZS5jYW52YXMuY2xpZW50V2lkdGggLyBkZXZpY2Uud2lkdGg7XG4gICAgdmFyIHN5ID0gZGV2aWNlLmNhbnZhcy5jbGllbnRIZWlnaHQgLyBkZXZpY2UuaGVpZ2h0O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCA0O2krKykge1xuICAgICAgdGhpcy5fY2FudmFzQ29ybmVyc1tpXS5zZXQoc2NyZWVuQ29ybmVyc1tpXS54ICogc3gsIChkZXZpY2UuaGVpZ2h0IC0gc2NyZWVuQ29ybmVyc1tpXS55KSAqIHN5KTtcbiAgICB9XG4gICAgdGhpcy5fY2FudmFzQ29ybmVyc0RpcnR5ID0gZmFsc2U7XG4gICAgcmV0dXJuIHRoaXMuX2NhbnZhc0Nvcm5lcnM7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcIndvcmxkQ29ybmVyc1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5fd29ybGRDb3JuZXJzRGlydHkpIHtcbiAgICAgIHJldHVybiB0aGlzLl93b3JsZENvcm5lcnM7XG4gICAgfVxuICAgIGlmICh0aGlzLnNjcmVlbikge1xuICAgICAgdmFyIHNjcmVlbkNvcm5lcnMgPSB0aGlzLnNjcmVlbkNvcm5lcnM7XG4gICAgICBpZiAoIXRoaXMuc2NyZWVuLnNjcmVlbi5zY3JlZW5TcGFjZSkge1xuICAgICAgICBtYXRBLmNvcHkodGhpcy5zY3JlZW4uc2NyZWVuLl9zY3JlZW5NYXRyaXgpO1xuICAgICAgICBtYXRBLmRhdGFbMTNdID0gLW1hdEEuZGF0YVsxM107XG4gICAgICAgIG1hdEEubXVsMih0aGlzLnNjcmVlbi5nZXRXb3JsZFRyYW5zZm9ybSgpLCBtYXRBKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IDQ7aSsrKSB7XG4gICAgICAgICAgbWF0QS50cmFuc2Zvcm1Qb2ludChzY3JlZW5Db3JuZXJzW2ldLCB0aGlzLl93b3JsZENvcm5lcnNbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBsb2NhbFBvcyA9IHRoaXMuZW50aXR5LmdldExvY2FsUG9zaXRpb24oKTtcbiAgICAgIG1hdEEuc2V0VHJhbnNsYXRlKC1sb2NhbFBvcy54LCAtbG9jYWxQb3MueSwgLWxvY2FsUG9zLnopO1xuICAgICAgbWF0Qi5zZXRUUlMocGMuVmVjMy5aRVJPLCB0aGlzLmVudGl0eS5nZXRMb2NhbFJvdGF0aW9uKCksIHRoaXMuZW50aXR5LmdldExvY2FsU2NhbGUoKSk7XG4gICAgICBtYXRDLnNldFRyYW5zbGF0ZShsb2NhbFBvcy54LCBsb2NhbFBvcy55LCBsb2NhbFBvcy56KTtcbiAgICAgIG1hdEQuY29weSh0aGlzLmVudGl0eS5wYXJlbnQuZ2V0V29ybGRUcmFuc2Zvcm0oKSk7XG4gICAgICBtYXRELm11bChtYXRDKS5tdWwobWF0QikubXVsKG1hdEEpO1xuICAgICAgdmVjQS5zZXQobG9jYWxQb3MueCAtIHRoaXMucGl2b3QueCAqIHRoaXMud2lkdGgsIGxvY2FsUG9zLnkgLSB0aGlzLnBpdm90LnkgKiB0aGlzLmhlaWdodCwgbG9jYWxQb3Mueik7XG4gICAgICBtYXRELnRyYW5zZm9ybVBvaW50KHZlY0EsIHRoaXMuX3dvcmxkQ29ybmVyc1swXSk7XG4gICAgICB2ZWNBLnNldChsb2NhbFBvcy54ICsgKDEgLSB0aGlzLnBpdm90LngpICogdGhpcy53aWR0aCwgbG9jYWxQb3MueSAtIHRoaXMucGl2b3QueSAqIHRoaXMuaGVpZ2h0LCBsb2NhbFBvcy56KTtcbiAgICAgIG1hdEQudHJhbnNmb3JtUG9pbnQodmVjQSwgdGhpcy5fd29ybGRDb3JuZXJzWzFdKTtcbiAgICAgIHZlY0Euc2V0KGxvY2FsUG9zLnggKyAoMSAtIHRoaXMucGl2b3QueCkgKiB0aGlzLndpZHRoLCBsb2NhbFBvcy55ICsgKDEgLSB0aGlzLnBpdm90LnkpICogdGhpcy5oZWlnaHQsIGxvY2FsUG9zLnopO1xuICAgICAgbWF0RC50cmFuc2Zvcm1Qb2ludCh2ZWNBLCB0aGlzLl93b3JsZENvcm5lcnNbMl0pO1xuICAgICAgdmVjQS5zZXQobG9jYWxQb3MueCAtIHRoaXMucGl2b3QueCAqIHRoaXMud2lkdGgsIGxvY2FsUG9zLnkgKyAoMSAtIHRoaXMucGl2b3QueSkgKiB0aGlzLmhlaWdodCwgbG9jYWxQb3Mueik7XG4gICAgICBtYXRELnRyYW5zZm9ybVBvaW50KHZlY0EsIHRoaXMuX3dvcmxkQ29ybmVyc1szXSk7XG4gICAgfVxuICAgIHRoaXMuX3dvcmxkQ29ybmVyc0RpcnR5ID0gZmFsc2U7XG4gICAgcmV0dXJuIHRoaXMuX3dvcmxkQ29ybmVycztcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwidGV4dFdpZHRoXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RleHQgPyB0aGlzLl90ZXh0LndpZHRoIDogMDtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIFwidGV4dEhlaWdodFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl90ZXh0ID8gdGhpcy5fdGV4dC5oZWlnaHQgOiAwO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbGVtZW50Q29tcG9uZW50LnByb3RvdHlwZSwgXCJ1c2VJbnB1dFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl91c2VJbnB1dDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuX3VzZUlucHV0ID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl91c2VJbnB1dCA9IHZhbHVlO1xuICAgIGlmICh0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0KSB7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLmVsZW1lbnRJbnB1dC5hZGRFbGVtZW50KHRoaXMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN5c3RlbS5hcHAuZWxlbWVudElucHV0LnJlbW92ZUVsZW1lbnQodGhpcyk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZmlyZShcInNldDp1c2VJbnB1dFwiLCB2YWx1ZSk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBcImJhdGNoR3JvdXBJZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9iYXRjaEdyb3VwSWQ7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICh0aGlzLl9iYXRjaEdyb3VwSWQgPT09IHZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLl9iYXRjaEdyb3VwSWQgPj0gMCkge1xuICAgICAgdGhpcy5zeXN0ZW0uYXBwLmJhdGNoZXIuX21hcmtHcm91cERpcnR5KHRoaXMuX2JhdGNoR3JvdXBJZCk7XG4gICAgfVxuICAgIGlmICh2YWx1ZSA+PSAwKSB7XG4gICAgICB0aGlzLnN5c3RlbS5hcHAuYmF0Y2hlci5fbWFya0dyb3VwRGlydHkodmFsdWUpO1xuICAgIH1cbiAgICBpZiAodmFsdWUgPCAwICYmIHRoaXMuX2JhdGNoR3JvdXBJZCA+PSAwICYmIHRoaXMuZW5hYmxlZCAmJiB0aGlzLmVudGl0eS5lbmFibGVkKSB7XG4gICAgICBpZiAodGhpcy5faW1hZ2UuX21vZGVsKSB7XG4gICAgICAgIHRoaXMuc3lzdGVtLmFwcC5zY2VuZS5hZGRNb2RlbCh0aGlzLl9pbWFnZS5fbW9kZWwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuX3RleHQuX21vZGVsKSB7XG4gICAgICAgICAgdGhpcy5zeXN0ZW0uYXBwLnNjZW5lLmFkZE1vZGVsKHRoaXMuX3RleHQuX21vZGVsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9iYXRjaEdyb3VwSWQgPSB2YWx1ZTtcbiAgfX0pO1xuICB2YXIgX2RlZmluZSA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRWxlbWVudENvbXBvbmVudC5wcm90b3R5cGUsIG5hbWUsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5fdGV4dCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGV4dFtuYW1lXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLl9pbWFnZSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZVtuYW1lXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHRoaXMuX3RleHQpIHtcbiAgICAgICAgdGhpcy5fdGV4dFtuYW1lXSA9IHZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuX2ltYWdlKSB7XG4gICAgICAgICAgdGhpcy5faW1hZ2VbbmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH19KTtcbiAgfTtcbiAgX2RlZmluZShcImZvbnRTaXplXCIpO1xuICBfZGVmaW5lKFwiY29sb3JcIik7XG4gIF9kZWZpbmUoXCJmb250XCIpO1xuICBfZGVmaW5lKFwiZm9udEFzc2V0XCIpO1xuICBfZGVmaW5lKFwic3BhY2luZ1wiKTtcbiAgX2RlZmluZShcImxpbmVIZWlnaHRcIik7XG4gIF9kZWZpbmUoXCJhbGlnbm1lbnRcIik7XG4gIF9kZWZpbmUoXCJhdXRvV2lkdGhcIik7XG4gIF9kZWZpbmUoXCJhdXRvSGVpZ2h0XCIpO1xuICBfZGVmaW5lKFwidGV4dFwiKTtcbiAgX2RlZmluZShcInRleHR1cmVcIik7XG4gIF9kZWZpbmUoXCJ0ZXh0dXJlQXNzZXRcIik7XG4gIF9kZWZpbmUoXCJtYXRlcmlhbFwiKTtcbiAgX2RlZmluZShcIm1hdGVyaWFsQXNzZXRcIik7XG4gIF9kZWZpbmUoXCJvcGFjaXR5XCIpO1xuICBfZGVmaW5lKFwicmVjdFwiKTtcbiAgcmV0dXJuIHtFbGVtZW50Q29tcG9uZW50OkVsZW1lbnRDb21wb25lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBfc2NoZW1hID0gW1wiZW5hYmxlZFwiXTtcbiAgdmFyIEVsZW1lbnRDb21wb25lbnRTeXN0ZW0gPSBmdW5jdGlvbiBFbGVtZW50Q29tcG9uZW50U3lzdGVtKGFwcCkge1xuICAgIHRoaXMuaWQgPSBcImVsZW1lbnRcIjtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICBhcHAuc3lzdGVtcy5hZGQodGhpcy5pZCwgdGhpcyk7XG4gICAgdGhpcy5Db21wb25lbnRUeXBlID0gcGMuRWxlbWVudENvbXBvbmVudDtcbiAgICB0aGlzLkRhdGFUeXBlID0gcGMuRWxlbWVudENvbXBvbmVudERhdGE7XG4gICAgdGhpcy5zY2hlbWEgPSBfc2NoZW1hO1xuICAgIHRoaXMuX2RlZmF1bHRUZXh0dXJlID0gbmV3IHBjLlRleHR1cmUoYXBwLmdyYXBoaWNzRGV2aWNlLCB7d2lkdGg6MSwgaGVpZ2h0OjEsIGZvcm1hdDpwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOH0pO1xuICAgIHZhciBwaXhlbHMgPSB0aGlzLl9kZWZhdWx0VGV4dHVyZS5sb2NrKCk7XG4gICAgdmFyIHBpeGVsRGF0YSA9IG5ldyBVaW50OEFycmF5KDQpO1xuICAgIHBpeGVsRGF0YVswXSA9IDI1NS4wO1xuICAgIHBpeGVsRGF0YVsxXSA9IDI1NS4wO1xuICAgIHBpeGVsRGF0YVsyXSA9IDI1NS4wO1xuICAgIHBpeGVsRGF0YVszXSA9IDI1NS4wO1xuICAgIHBpeGVscy5zZXQocGl4ZWxEYXRhKTtcbiAgICB0aGlzLl9kZWZhdWx0VGV4dHVyZS51bmxvY2soKTtcbiAgICB0aGlzLmRlZmF1bHRJbWFnZU1hdGVyaWFsID0gbmV3IHBjLlN0YW5kYXJkTWF0ZXJpYWw7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC5kaWZmdXNlID0gbmV3IHBjLkNvbG9yKDAsIDAsIDAsIDEpO1xuICAgIHRoaXMuZGVmYXVsdEltYWdlTWF0ZXJpYWwuZW1pc3NpdmUgPSBuZXcgcGMuQ29sb3IoMC41LCAwLjUsIDAuNSwgMSk7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC5lbWlzc2l2ZU1hcCA9IHRoaXMuX2RlZmF1bHRUZXh0dXJlO1xuICAgIHRoaXMuZGVmYXVsdEltYWdlTWF0ZXJpYWwuZW1pc3NpdmVNYXBUaW50ID0gdHJ1ZTtcbiAgICB0aGlzLmRlZmF1bHRJbWFnZU1hdGVyaWFsLm9wYWNpdHlNYXAgPSB0aGlzLl9kZWZhdWx0VGV4dHVyZTtcbiAgICB0aGlzLmRlZmF1bHRJbWFnZU1hdGVyaWFsLm9wYWNpdHlNYXBDaGFubmVsID0gXCJhXCI7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC5vcGFjaXR5VGludCA9IHRydWU7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC5vcGFjaXR5ID0gMDtcbiAgICB0aGlzLmRlZmF1bHRJbWFnZU1hdGVyaWFsLnVzZUxpZ2h0aW5nID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC51c2VHYW1tYVRvbmVtYXAgPSBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRJbWFnZU1hdGVyaWFsLnVzZUZvZyA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdEltYWdlTWF0ZXJpYWwudXNlU2t5Ym94ID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0SW1hZ2VNYXRlcmlhbC5ibGVuZFR5cGUgPSBwYy5CTEVORF9QUkVNVUxUSVBMSUVEO1xuICAgIHRoaXMuZGVmYXVsdEltYWdlTWF0ZXJpYWwuZGVwdGhXcml0ZSA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdEltYWdlTWF0ZXJpYWwudXBkYXRlKCk7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsID0gbmV3IHBjLlN0YW5kYXJkTWF0ZXJpYWw7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLmRpZmZ1c2UgPSBuZXcgcGMuQ29sb3IoMCwgMCwgMCwgMSk7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLmVtaXNzaXZlID0gbmV3IHBjLkNvbG9yKDAuNSwgMC41LCAwLjUsIDEpO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlSW1hZ2VNYXRlcmlhbC5lbWlzc2l2ZU1hcCA9IHRoaXMuX2RlZmF1bHRUZXh0dXJlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlSW1hZ2VNYXRlcmlhbC5lbWlzc2l2ZU1hcFRpbnQgPSB0cnVlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlSW1hZ2VNYXRlcmlhbC5vcGFjaXR5TWFwID0gdGhpcy5fZGVmYXVsdFRleHR1cmU7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLm9wYWNpdHlNYXBDaGFubmVsID0gXCJhXCI7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLm9wYWNpdHlUaW50ID0gdHJ1ZTtcbiAgICB0aGlzLmRlZmF1bHRTY3JlZW5TcGFjZUltYWdlTWF0ZXJpYWwub3BhY2l0eSA9IDA7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLnVzZUxpZ2h0aW5nID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLnVzZUdhbW1hVG9uZW1hcCA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlSW1hZ2VNYXRlcmlhbC51c2VGb2cgPSBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRTY3JlZW5TcGFjZUltYWdlTWF0ZXJpYWwudXNlU2t5Ym94ID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLmJsZW5kVHlwZSA9IHBjLkJMRU5EX1BSRU1VTFRJUExJRUQ7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLmRlcHRoVGVzdCA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlSW1hZ2VNYXRlcmlhbC5kZXB0aFdyaXRlID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbCA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbC5tc2RmTWFwID0gdGhpcy5fZGVmYXVsdFRleHR1cmU7XG4gICAgdGhpcy5kZWZhdWx0VGV4dE1hdGVyaWFsLnVzZUxpZ2h0aW5nID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0VGV4dE1hdGVyaWFsLnVzZUdhbW1hVG9uZW1hcCA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbC51c2VGb2cgPSBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRUZXh0TWF0ZXJpYWwudXNlU2t5Ym94ID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0VGV4dE1hdGVyaWFsLmRpZmZ1c2UgPSBuZXcgcGMuQ29sb3IoMCwgMCwgMCwgMSk7XG4gICAgdGhpcy5kZWZhdWx0VGV4dE1hdGVyaWFsLmVtaXNzaXZlID0gbmV3IHBjLkNvbG9yKDEsIDEsIDEsIDEpO1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbC5vcGFjaXR5ID0gMC41O1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbC5ibGVuZFR5cGUgPSBwYy5CTEVORF9QUkVNVUxUSVBMSUVEO1xuICAgIHRoaXMuZGVmYXVsdFRleHRNYXRlcmlhbC5kZXB0aFdyaXRlID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0VGV4dE1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsID0gbmV3IHBjLlN0YW5kYXJkTWF0ZXJpYWw7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwubXNkZk1hcCA9IHRoaXMuX2RlZmF1bHRUZXh0dXJlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsLnVzZUxpZ2h0aW5nID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwudXNlR2FtbWFUb25lbWFwID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwudXNlRm9nID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwudXNlU2t5Ym94ID0gZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwuZGlmZnVzZSA9IG5ldyBwYy5Db2xvcigwLCAwLCAwLCAxKTtcbiAgICB0aGlzLmRlZmF1bHRTY3JlZW5TcGFjZVRleHRNYXRlcmlhbC5lbWlzc2l2ZSA9IG5ldyBwYy5Db2xvcigxLCAxLCAxLCAxKTtcbiAgICB0aGlzLmRlZmF1bHRTY3JlZW5TcGFjZVRleHRNYXRlcmlhbC5vcGFjaXR5ID0gMC41O1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsLmJsZW5kVHlwZSA9IHBjLkJMRU5EX1BSRU1VTFRJUExJRUQ7XG4gICAgdGhpcy5kZWZhdWx0U2NyZWVuU3BhY2VUZXh0TWF0ZXJpYWwuZGVwdGhXcml0ZSA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsLmRlcHRoVGVzdCA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgIHRoaXMub24oXCJiZWZvcmVyZW1vdmVcIiwgdGhpcy5vblJlbW92ZUNvbXBvbmVudCwgdGhpcyk7XG4gIH07XG4gIEVsZW1lbnRDb21wb25lbnRTeXN0ZW0gPSBwYy5pbmhlcml0cyhFbGVtZW50Q29tcG9uZW50U3lzdGVtLCBwYy5Db21wb25lbnRTeXN0ZW0pO1xuICBwYy5Db21wb25lbnQuX2J1aWxkQWNjZXNzb3JzKHBjLkVsZW1lbnRDb21wb25lbnQucHJvdG90eXBlLCBfc2NoZW1hKTtcbiAgcGMuZXh0ZW5kKEVsZW1lbnRDb21wb25lbnRTeXN0ZW0ucHJvdG90eXBlLCB7aW5pdGlhbGl6ZUNvbXBvbmVudERhdGE6ZnVuY3Rpb24oY29tcG9uZW50LCBkYXRhLCBwcm9wZXJ0aWVzKSB7XG4gICAgaWYgKGRhdGEuYW5jaG9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChkYXRhLmFuY2hvciBpbnN0YW5jZW9mIHBjLlZlYzQpIHtcbiAgICAgICAgY29tcG9uZW50LmFuY2hvci5jb3B5KGRhdGEuYW5jaG9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXBvbmVudC5hbmNob3Iuc2V0KGRhdGEuYW5jaG9yWzBdLCBkYXRhLmFuY2hvclsxXSwgZGF0YS5hbmNob3JbMl0sIGRhdGEuYW5jaG9yWzNdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGRhdGEucGl2b3QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKGRhdGEucGl2b3QgaW5zdGFuY2VvZiBwYy5WZWMyKSB7XG4gICAgICAgIGNvbXBvbmVudC5waXZvdC5jb3B5KGRhdGEucGl2b3QpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29tcG9uZW50LnBpdm90LnNldChkYXRhLnBpdm90WzBdLCBkYXRhLnBpdm90WzFdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIHNwbGl0SG9yQW5jaG9ycyA9IE1hdGguYWJzKGNvbXBvbmVudC5hbmNob3IueCAtIGNvbXBvbmVudC5hbmNob3IueikgPiAwLjAwMTtcbiAgICB2YXIgc3BsaXRWZXJBbmNob3JzID0gTWF0aC5hYnMoY29tcG9uZW50LmFuY2hvci55IC0gY29tcG9uZW50LmFuY2hvci53KSA+IDAuMDAxO1xuICAgIHZhciBfbWFyZ2luQ2hhbmdlID0gZmFsc2U7XG4gICAgaWYgKGRhdGEubWFyZ2luICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChkYXRhLm1hcmdpbiBpbnN0YW5jZW9mIHBjLlZlYzQpIHtcbiAgICAgICAgY29tcG9uZW50Lm1hcmdpbi5jb3B5KGRhdGEubWFyZ2luKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbXBvbmVudC5fbWFyZ2luLnNldChkYXRhLm1hcmdpblswXSwgZGF0YS5tYXJnaW5bMV0sIGRhdGEubWFyZ2luWzJdLCBkYXRhLm1hcmdpblszXSk7XG4gICAgICB9XG4gICAgICBfbWFyZ2luQ2hhbmdlID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGRhdGEubGVmdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb21wb25lbnQuX21hcmdpbi54ID0gZGF0YS5sZWZ0O1xuICAgICAgX21hcmdpbkNoYW5nZSA9IHRydWU7XG4gICAgfVxuICAgIGlmIChkYXRhLmJvdHRvbSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb21wb25lbnQuX21hcmdpbi55ID0gZGF0YS5ib3R0b207XG4gICAgICBfbWFyZ2luQ2hhbmdlID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGRhdGEucmlnaHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29tcG9uZW50Ll9tYXJnaW4ueiA9IGRhdGEucmlnaHQ7XG4gICAgICBfbWFyZ2luQ2hhbmdlID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGRhdGEudG9wICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbXBvbmVudC5fbWFyZ2luLncgPSBkYXRhLnRvcDtcbiAgICAgIF9tYXJnaW5DaGFuZ2UgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoX21hcmdpbkNoYW5nZSkge1xuICAgICAgY29tcG9uZW50Lm1hcmdpbiA9IGNvbXBvbmVudC5fbWFyZ2luO1xuICAgIH1cbiAgICBpZiAoZGF0YS53aWR0aCAhPT0gdW5kZWZpbmVkICYmICFzcGxpdEhvckFuY2hvcnMpIHtcbiAgICAgIGNvbXBvbmVudC53aWR0aCA9IGRhdGEud2lkdGg7XG4gICAgfVxuICAgIGlmIChkYXRhLmhlaWdodCAhPT0gdW5kZWZpbmVkICYmICFzcGxpdFZlckFuY2hvcnMpIHtcbiAgICAgIGNvbXBvbmVudC5oZWlnaHQgPSBkYXRhLmhlaWdodDtcbiAgICB9XG4gICAgaWYgKGRhdGEuZW5hYmxlZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb21wb25lbnQuZW5hYmxlZCA9IGRhdGEuZW5hYmxlZDtcbiAgICB9XG4gICAgaWYgKGRhdGEudXNlSW5wdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29tcG9uZW50LnVzZUlucHV0ID0gZGF0YS51c2VJbnB1dDtcbiAgICB9XG4gICAgY29tcG9uZW50LmJhdGNoR3JvdXBJZCA9IGRhdGEuYmF0Y2hHcm91cElkID09PSB1bmRlZmluZWQgfHwgZGF0YS5iYXRjaEdyb3VwSWQgPT09IG51bGwgPyAtMSA6IGRhdGEuYmF0Y2hHcm91cElkO1xuICAgIGNvbXBvbmVudC50eXBlID0gZGF0YS50eXBlO1xuICAgIGlmIChjb21wb25lbnQudHlwZSA9PT0gcGMuRUxFTUVOVFRZUEVfSU1BR0UpIHtcbiAgICAgIGlmIChkYXRhLnJlY3QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoZGF0YS5yZWN0IGluc3RhbmNlb2YgcGMuVmVjNCkge1xuICAgICAgICAgIGNvbXBvbmVudC5yZWN0LmNvcHkoZGF0YS5yZWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb21wb25lbnQucmVjdC5zZXQoZGF0YS5yZWN0WzBdLCBkYXRhLnJlY3RbMV0sIGRhdGEucmVjdFsyXSwgZGF0YS5yZWN0WzNdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGRhdGEuY29sb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoZGF0YS5jb2xvciBpbnN0YW5jZW9mIHBjLkNvbG9yKSB7XG4gICAgICAgICAgY29tcG9uZW50LmNvbG9yLnNldChkYXRhLmNvbG9yLmRhdGFbMF0sIGRhdGEuY29sb3IuZGF0YVsxXSwgZGF0YS5jb2xvci5kYXRhWzJdLCBkYXRhLm9wYWNpdHkgIT09IHVuZGVmaW5lZCA/IGRhdGEub3BhY2l0eSA6IDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbXBvbmVudC5jb2xvci5zZXQoZGF0YS5jb2xvclswXSwgZGF0YS5jb2xvclsxXSwgZGF0YS5jb2xvclsyXSwgZGF0YS5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBkYXRhLm9wYWNpdHkgOiAxKTtcbiAgICAgICAgfVxuICAgICAgICBjb21wb25lbnQuY29sb3IgPSBjb21wb25lbnQuY29sb3I7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS5vcGFjaXR5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29tcG9uZW50Lm9wYWNpdHkgPSBkYXRhLm9wYWNpdHk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS50ZXh0dXJlQXNzZXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb21wb25lbnQudGV4dHVyZUFzc2V0ID0gZGF0YS50ZXh0dXJlQXNzZXQ7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS50ZXh0dXJlKSB7XG4gICAgICAgIGNvbXBvbmVudC50ZXh0dXJlID0gZGF0YS50ZXh0dXJlO1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEubWF0ZXJpYWxBc3NldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbXBvbmVudC5tYXRlcmlhbEFzc2V0ID0gZGF0YS5tYXRlcmlhbEFzc2V0O1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEubWF0ZXJpYWwpIHtcbiAgICAgICAgY29tcG9uZW50Lm1hdGVyaWFsID0gZGF0YS5tYXRlcmlhbDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNvbXBvbmVudC50eXBlID09PSBwYy5FTEVNRU5UVFlQRV9URVhUKSB7XG4gICAgICAgIGlmIChkYXRhLmF1dG9XaWR0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY29tcG9uZW50LmF1dG9XaWR0aCA9IGRhdGEuYXV0b1dpZHRoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmF1dG9IZWlnaHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC5hdXRvSGVpZ2h0ID0gZGF0YS5hdXRvSGVpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLnRleHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC50ZXh0ID0gZGF0YS50ZXh0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmNvbG9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBpZiAoZGF0YS5jb2xvciBpbnN0YW5jZW9mIHBjLkNvbG9yKSB7XG4gICAgICAgICAgICBjb21wb25lbnQuY29sb3Iuc2V0KGRhdGEuY29sb3IuZGF0YVswXSwgZGF0YS5jb2xvci5kYXRhWzFdLCBkYXRhLmNvbG9yLmRhdGFbMl0sIGRhdGEub3BhY2l0eSAhPT0gdW5kZWZpbmVkID8gZGF0YS5vcGFjaXR5IDogMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbXBvbmVudC5jb2xvci5zZXQoZGF0YS5jb2xvclswXSwgZGF0YS5jb2xvclsxXSwgZGF0YS5jb2xvclsyXSwgZGF0YS5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBkYXRhLm9wYWNpdHkgOiAxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29tcG9uZW50LmNvbG9yID0gY29tcG9uZW50LmNvbG9yO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLm9wYWNpdHkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC5vcGFjaXR5ID0gZGF0YS5vcGFjaXR5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLnNwYWNpbmcgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC5zcGFjaW5nID0gZGF0YS5zcGFjaW5nO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmZvbnRTaXplICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBjb21wb25lbnQuZm9udFNpemUgPSBkYXRhLmZvbnRTaXplO1xuICAgICAgICAgIGlmICghZGF0YS5saW5lSGVpZ2h0KSB7XG4gICAgICAgICAgICBjb21wb25lbnQubGluZUhlaWdodCA9IGRhdGEuZm9udFNpemU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmxpbmVIZWlnaHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC5saW5lSGVpZ2h0ID0gZGF0YS5saW5lSGVpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmZvbnRBc3NldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY29tcG9uZW50LmZvbnRBc3NldCA9IGRhdGEuZm9udEFzc2V0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmZvbnQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGNvbXBvbmVudC5mb250ID0gZGF0YS5mb250O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmFsaWdubWVudCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY29tcG9uZW50LmFsaWdubWVudCA9IGRhdGEuYWxpZ25tZW50O1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgc2NyZWVuID0gY29tcG9uZW50Ll9maW5kU2NyZWVuKCk7XG4gICAgaWYgKHNjcmVlbikge1xuICAgICAgY29tcG9uZW50Ll91cGRhdGVTY3JlZW4oc2NyZWVuKTtcbiAgICB9XG4gICAgRWxlbWVudENvbXBvbmVudFN5c3RlbS5fc3VwZXIuaW5pdGlhbGl6ZUNvbXBvbmVudERhdGEuY2FsbCh0aGlzLCBjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpO1xuICB9LCBvblJlbW92ZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNvbXBvbmVudCkge1xuICAgIGNvbXBvbmVudC5vblJlbW92ZSgpO1xuICB9LCBjbG9uZUNvbXBvbmVudDpmdW5jdGlvbihlbnRpdHksIGNsb25lKSB7XG4gICAgdmFyIHNvdXJjZSA9IGVudGl0eS5lbGVtZW50O1xuICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwge2VuYWJsZWQ6c291cmNlLmVuYWJsZWQsIHdpZHRoOnNvdXJjZS53aWR0aCwgaGVpZ2h0OnNvdXJjZS5oZWlnaHQsIGFuY2hvcjpzb3VyY2UuYW5jaG9yLmNsb25lKCksIHBpdm90OnNvdXJjZS5waXZvdC5jbG9uZSgpLCBtYXJnaW46c291cmNlLm1hcmdpbi5jbG9uZSgpLCBhbGlnbm1lbnQ6c291cmNlLmFsaWdubWVudCAmJiBzb3VyY2UuYWxpZ25tZW50LmNsb25lKCkgfHwgc291cmNlLmFsaWdubWVudCwgYXV0b1dpZHRoOnNvdXJjZS5hdXRvV2lkdGgsIGF1dG9IZWlnaHQ6c291cmNlLmF1dG9IZWlnaHQsIHR5cGU6c291cmNlLnR5cGUsIHJlY3Q6c291cmNlLnJlY3QgJiYgc291cmNlLnJlY3QuY2xvbmUoKSB8fCBzb3VyY2UucmVjdCwgbWF0ZXJpYWxBc3NldDpzb3VyY2UubWF0ZXJpYWxBc3NldCwgbWF0ZXJpYWw6c291cmNlLm1hdGVyaWFsLCBjb2xvcjpzb3VyY2UuY29sb3IgJiYgc291cmNlLmNvbG9yLmNsb25lKCkgfHxcbiAgICBzb3VyY2UuY29sb3IsIG9wYWNpdHk6c291cmNlLm9wYWNpdHksIHRleHR1cmVBc3NldDpzb3VyY2UudGV4dHVyZUFzc2V0LCB0ZXh0dXJlOnNvdXJjZS50ZXh0dXJlLCB0ZXh0OnNvdXJjZS50ZXh0LCBzcGFjaW5nOnNvdXJjZS5zcGFjaW5nLCBsaW5lSGVpZ2h0OnNvdXJjZS5saW5lSGVpZ2h0LCBmb250U2l6ZTpzb3VyY2UuZm9udFNpemUsIGZvbnRBc3NldDpzb3VyY2UuZm9udEFzc2V0LCBmb250OnNvdXJjZS5mb250LCB1c2VJbnB1dDpzb3VyY2UudXNlSW5wdXQsIGJhdGNoR3JvdXBJZDpzb3VyY2UuYmF0Y2hHcm91cElkfSk7XG4gIH19KTtcbiAgcmV0dXJuIHtFbGVtZW50Q29tcG9uZW50U3lzdGVtOkVsZW1lbnRDb21wb25lbnRTeXN0ZW19O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBFbGVtZW50Q29tcG9uZW50RGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gIH07XG4gIEVsZW1lbnRDb21wb25lbnREYXRhID0gcGMuaW5oZXJpdHMoRWxlbWVudENvbXBvbmVudERhdGEsIHBjLkNvbXBvbmVudERhdGEpO1xuICByZXR1cm4ge0VsZW1lbnRDb21wb25lbnREYXRhOkVsZW1lbnRDb21wb25lbnREYXRhfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgSW1hZ2VFbGVtZW50ID0gZnVuY3Rpb24gSW1hZ2VFbGVtZW50KGVsZW1lbnQpIHtcbiAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDtcbiAgICB0aGlzLl9lbnRpdHkgPSBlbGVtZW50LmVudGl0eTtcbiAgICB0aGlzLl9zeXN0ZW0gPSBlbGVtZW50LnN5c3RlbTtcbiAgICB0aGlzLl90ZXh0dXJlQXNzZXQgPSBudWxsO1xuICAgIHRoaXMuX3RleHR1cmUgPSBudWxsO1xuICAgIHRoaXMuX21hdGVyaWFsQXNzZXQgPSBudWxsO1xuICAgIHRoaXMuX21hdGVyaWFsID0gbnVsbDtcbiAgICB0aGlzLl9yZWN0ID0gbmV3IHBjLlZlYzQoMCwgMCwgMSwgMSk7XG4gICAgdGhpcy5fY29sb3IgPSBuZXcgcGMuQ29sb3IoMSwgMSwgMSwgMSk7XG4gICAgdGhpcy5fcG9zaXRpb25zID0gW107XG4gICAgdGhpcy5fbm9ybWFscyA9IFtdO1xuICAgIHRoaXMuX3V2cyA9IFtdO1xuICAgIHRoaXMuX2luZGljZXMgPSBbXTtcbiAgICB0aGlzLl9tZXNoID0gdGhpcy5fY3JlYXRlTWVzaCgpO1xuICAgIHRoaXMuX25vZGUgPSBuZXcgcGMuR3JhcGhOb2RlO1xuICAgIHRoaXMuX21vZGVsID0gbmV3IHBjLk1vZGVsO1xuICAgIHRoaXMuX21vZGVsLmdyYXBoID0gdGhpcy5fbm9kZTtcbiAgICB0aGlzLl9tZXNoSW5zdGFuY2UgPSBuZXcgcGMuTWVzaEluc3RhbmNlKHRoaXMuX25vZGUsIHRoaXMuX21lc2gsIHRoaXMuX21hdGVyaWFsKTtcbiAgICB0aGlzLl9tZXNoSW5zdGFuY2UuY2FzdFNoYWRvdyA9IGZhbHNlO1xuICAgIHRoaXMuX21lc2hJbnN0YW5jZS5yZWNlaXZlU2hhZG93ID0gZmFsc2U7XG4gICAgdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlcy5wdXNoKHRoaXMuX21lc2hJbnN0YW5jZSk7XG4gICAgdGhpcy5fZHJhd09yZGVyID0gMDtcbiAgICB0aGlzLl9lbnRpdHkuYWRkQ2hpbGQodGhpcy5fbW9kZWwuZ3JhcGgpO1xuICAgIHRoaXMuX21vZGVsLl9lbnRpdHkgPSB0aGlzLl9lbnRpdHk7XG4gICAgdGhpcy5fb25TY3JlZW5DaGFuZ2UodGhpcy5fZWxlbWVudC5zY3JlZW4pO1xuICAgIHRoaXMuX2VsZW1lbnQub24oXCJyZXNpemVcIiwgdGhpcy5fb25QYXJlbnRSZXNpemUsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub24oXCJzY3JlZW46c2V0OnNjcmVlbnNwYWNlXCIsIHRoaXMuX29uU2NyZWVuU3BhY2VDaGFuZ2UsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub24oXCJzZXQ6c2NyZWVuXCIsIHRoaXMuX29uU2NyZWVuQ2hhbmdlLCB0aGlzKTtcbiAgICB0aGlzLl9lbGVtZW50Lm9uKFwic2V0OmRyYXdvcmRlclwiLCB0aGlzLl9vbkRyYXdPcmRlckNoYW5nZSwgdGhpcyk7XG4gICAgdGhpcy5fZWxlbWVudC5vbihcInNjcmVlbjpzZXQ6cmVzb2x1dGlvblwiLCB0aGlzLl9vblJlc29sdXRpb25DaGFuZ2UsIHRoaXMpO1xuICB9O1xuICBwYy5leHRlbmQoSW1hZ2VFbGVtZW50LnByb3RvdHlwZSwge2Rlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICB0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLnJlbW92ZU1vZGVsKHRoaXMuX21vZGVsKTtcbiAgICAgIHRoaXMuX21vZGVsLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuX21vZGVsID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5fZWxlbWVudC5vZmYoXCJyZXNpemVcIiwgdGhpcy5fb25QYXJlbnRSZXNpemUsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub2ZmKFwic2NyZWVuOnNldDpzY3JlZW5zcGFjZVwiLCB0aGlzLl9vblNjcmVlblNwYWNlQ2hhbmdlLCB0aGlzKTtcbiAgICB0aGlzLl9lbGVtZW50Lm9mZihcInNldDpzY3JlZW5cIiwgdGhpcy5fb25TY3JlZW5DaGFuZ2UsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub2ZmKFwic2V0OmRyYXdvcmRlclwiLCB0aGlzLl9vbkRyYXdPcmRlckNoYW5nZSwgdGhpcyk7XG4gICAgdGhpcy5fZWxlbWVudC5vZmYoXCJzY3JlZW46c2V0OnJlc29sdXRpb25cIiwgdGhpcy5fb25SZXNvbHV0aW9uQ2hhbmdlLCB0aGlzKTtcbiAgfSwgX29uUmVzb2x1dGlvbkNoYW5nZTpmdW5jdGlvbihyZXMpIHtcbiAgfSwgX29uUGFyZW50UmVzaXplOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9tZXNoKSB7XG4gICAgICB0aGlzLl91cGRhdGVNZXNoKHRoaXMuX21lc2gpO1xuICAgIH1cbiAgfSwgX29uU2NyZWVuU3BhY2VDaGFuZ2U6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl91cGRhdGVNYXRlcmlhbCh2YWx1ZSk7XG4gIH0sIF9vblNjcmVlbkNoYW5nZTpmdW5jdGlvbihzY3JlZW4pIHtcbiAgICBpZiAoc2NyZWVuKSB7XG4gICAgICB0aGlzLl91cGRhdGVNYXRlcmlhbChzY3JlZW4uc2NyZWVuLnNjcmVlblNwYWNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fdXBkYXRlTWF0ZXJpYWwoZmFsc2UpO1xuICAgIH1cbiAgfSwgX29uRHJhd09yZGVyQ2hhbmdlOmZ1bmN0aW9uKG9yZGVyKSB7XG4gICAgdGhpcy5fZHJhd09yZGVyID0gb3JkZXI7XG4gICAgaWYgKHRoaXMuX21lc2hJbnN0YW5jZSkge1xuICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLmRyYXdPcmRlciA9IG9yZGVyO1xuICAgIH1cbiAgfSwgX2hhc1VzZXJNYXRlcmlhbDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gISF0aGlzLl9tYXRlcmlhbEFzc2V0IHx8ICEhdGhpcy5fbWF0ZXJpYWwgJiYgdGhpcy5fbWF0ZXJpYWwgIT09IHRoaXMuX3N5c3RlbS5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsICYmIHRoaXMuX21hdGVyaWFsICE9PSB0aGlzLl9zeXN0ZW0uZGVmYXVsdEltYWdlTWF0ZXJpYWw7XG4gIH0sIF91cGRhdGVNYXRlcmlhbDpmdW5jdGlvbihzY3JlZW5TcGFjZSkge1xuICAgIGlmIChzY3JlZW5TcGFjZSkge1xuICAgICAgaWYgKCF0aGlzLl9oYXNVc2VyTWF0ZXJpYWwoKSkge1xuICAgICAgICB0aGlzLl9tYXRlcmlhbCA9IHRoaXMuX3N5c3RlbS5kZWZhdWx0U2NyZWVuU3BhY2VJbWFnZU1hdGVyaWFsO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX21lc2hJbnN0YW5jZSkge1xuICAgICAgICB0aGlzLl9tZXNoSW5zdGFuY2UubGF5ZXIgPSBwYy5zY2VuZS5MQVlFUl9IVUQ7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5faGFzVXNlck1hdGVyaWFsKCkpIHtcbiAgICAgICAgdGhpcy5fbWF0ZXJpYWwgPSB0aGlzLl9zeXN0ZW0uZGVmYXVsdEltYWdlTWF0ZXJpYWw7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fbWVzaEluc3RhbmNlKSB7XG4gICAgICAgIHRoaXMuX21lc2hJbnN0YW5jZS5sYXllciA9IHBjLnNjZW5lLkxBWUVSX1dPUkxEO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5fbWVzaEluc3RhbmNlKSB7XG4gICAgICB0aGlzLl9tZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSB0aGlzLl9tYXRlcmlhbDtcbiAgICAgIHRoaXMuX21lc2hJbnN0YW5jZS5zY3JlZW5TcGFjZSA9IHNjcmVlblNwYWNlO1xuICAgIH1cbiAgfSwgX2NyZWF0ZU1lc2g6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHcgPSB0aGlzLl9lbGVtZW50LndpZHRoO1xuICAgIHZhciBoID0gdGhpcy5fZWxlbWVudC5oZWlnaHQ7XG4gICAgdGhpcy5fcG9zaXRpb25zWzBdID0gMDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbMV0gPSAwO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1syXSA9IDA7XG4gICAgdGhpcy5fcG9zaXRpb25zWzNdID0gdztcbiAgICB0aGlzLl9wb3NpdGlvbnNbNF0gPSAwO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1s1XSA9IDA7XG4gICAgdGhpcy5fcG9zaXRpb25zWzZdID0gdztcbiAgICB0aGlzLl9wb3NpdGlvbnNbN10gPSBoO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1s4XSA9IDA7XG4gICAgdGhpcy5fcG9zaXRpb25zWzldID0gMDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbMTBdID0gaDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbMTFdID0gMDtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgMTI7aSArPSAzKSB7XG4gICAgICB0aGlzLl9ub3JtYWxzW2ldID0gMDtcbiAgICAgIHRoaXMuX25vcm1hbHNbaSArIDFdID0gMDtcbiAgICAgIHRoaXMuX25vcm1hbHNbaSArIDJdID0gMTtcbiAgICB9XG4gICAgdGhpcy5fdXZzWzBdID0gdGhpcy5fcmVjdC5kYXRhWzBdO1xuICAgIHRoaXMuX3V2c1sxXSA9IHRoaXMuX3JlY3QuZGF0YVsxXTtcbiAgICB0aGlzLl91dnNbMl0gPSB0aGlzLl9yZWN0LmRhdGFbMF0gKyB0aGlzLl9yZWN0LmRhdGFbMl07XG4gICAgdGhpcy5fdXZzWzNdID0gdGhpcy5fcmVjdC5kYXRhWzFdO1xuICAgIHRoaXMuX3V2c1s0XSA9IHRoaXMuX3JlY3QuZGF0YVswXSArIHRoaXMuX3JlY3QuZGF0YVsyXTtcbiAgICB0aGlzLl91dnNbNV0gPSB0aGlzLl9yZWN0LmRhdGFbMV0gKyB0aGlzLl9yZWN0LmRhdGFbM107XG4gICAgdGhpcy5fdXZzWzZdID0gdGhpcy5fcmVjdC5kYXRhWzBdO1xuICAgIHRoaXMuX3V2c1s3XSA9IHRoaXMuX3JlY3QuZGF0YVsxXSArIHRoaXMuX3JlY3QuZGF0YVszXTtcbiAgICB0aGlzLl9pbmRpY2VzWzBdID0gMDtcbiAgICB0aGlzLl9pbmRpY2VzWzFdID0gMTtcbiAgICB0aGlzLl9pbmRpY2VzWzJdID0gMztcbiAgICB0aGlzLl9pbmRpY2VzWzNdID0gMjtcbiAgICB0aGlzLl9pbmRpY2VzWzRdID0gMztcbiAgICB0aGlzLl9pbmRpY2VzWzVdID0gMTtcbiAgICB2YXIgbWVzaCA9IHBjLmNyZWF0ZU1lc2godGhpcy5fc3lzdGVtLmFwcC5ncmFwaGljc0RldmljZSwgdGhpcy5fcG9zaXRpb25zLCB7dXZzOnRoaXMuX3V2cywgbm9ybWFsczp0aGlzLl9ub3JtYWxzLCBpbmRpY2VzOnRoaXMuX2luZGljZXN9KTtcbiAgICB0aGlzLl91cGRhdGVNZXNoKG1lc2gpO1xuICAgIHJldHVybiBtZXNoO1xuICB9LCBfdXBkYXRlTWVzaDpmdW5jdGlvbihtZXNoKSB7XG4gICAgdmFyIGk7XG4gICAgdmFyIHcgPSB0aGlzLl9lbGVtZW50LndpZHRoO1xuICAgIHZhciBoID0gdGhpcy5fZWxlbWVudC5oZWlnaHQ7XG4gICAgaWYgKHRoaXMuX2VsZW1lbnQuc2NyZWVuKSB7XG4gICAgICB0aGlzLl91cGRhdGVNYXRlcmlhbCh0aGlzLl9lbGVtZW50LnNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91cGRhdGVNYXRlcmlhbCgpO1xuICAgIH1cbiAgICB0aGlzLl9wb3NpdGlvbnNbMF0gPSAwO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1sxXSA9IDA7XG4gICAgdGhpcy5fcG9zaXRpb25zWzJdID0gMDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbM10gPSB3O1xuICAgIHRoaXMuX3Bvc2l0aW9uc1s0XSA9IDA7XG4gICAgdGhpcy5fcG9zaXRpb25zWzVdID0gMDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbNl0gPSB3O1xuICAgIHRoaXMuX3Bvc2l0aW9uc1s3XSA9IGg7XG4gICAgdGhpcy5fcG9zaXRpb25zWzhdID0gMDtcbiAgICB0aGlzLl9wb3NpdGlvbnNbOV0gPSAwO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1sxMF0gPSBoO1xuICAgIHRoaXMuX3Bvc2l0aW9uc1sxMV0gPSAwO1xuICAgIHZhciBocCA9IHRoaXMuX2VsZW1lbnQucGl2b3QuZGF0YVswXTtcbiAgICB2YXIgdnAgPSB0aGlzLl9lbGVtZW50LnBpdm90LmRhdGFbMV07XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5fcG9zaXRpb25zLmxlbmd0aDtpICs9IDMpIHtcbiAgICAgIHRoaXMuX3Bvc2l0aW9uc1tpXSAtPSBocCAqIHc7XG4gICAgICB0aGlzLl9wb3NpdGlvbnNbaSArIDFdIC09IHZwICogaDtcbiAgICB9XG4gICAgdGhpcy5fdXZzWzBdID0gdGhpcy5fcmVjdC5kYXRhWzBdO1xuICAgIHRoaXMuX3V2c1sxXSA9IHRoaXMuX3JlY3QuZGF0YVsxXTtcbiAgICB0aGlzLl91dnNbMl0gPSB0aGlzLl9yZWN0LmRhdGFbMF0gKyB0aGlzLl9yZWN0LmRhdGFbMl07XG4gICAgdGhpcy5fdXZzWzNdID0gdGhpcy5fcmVjdC5kYXRhWzFdO1xuICAgIHRoaXMuX3V2c1s0XSA9IHRoaXMuX3JlY3QuZGF0YVswXSArIHRoaXMuX3JlY3QuZGF0YVsyXTtcbiAgICB0aGlzLl91dnNbNV0gPSB0aGlzLl9yZWN0LmRhdGFbMV0gKyB0aGlzLl9yZWN0LmRhdGFbM107XG4gICAgdGhpcy5fdXZzWzZdID0gdGhpcy5fcmVjdC5kYXRhWzBdO1xuICAgIHRoaXMuX3V2c1s3XSA9IHRoaXMuX3JlY3QuZGF0YVsxXSArIHRoaXMuX3JlY3QuZGF0YVszXTtcbiAgICB2YXIgdmIgPSBtZXNoLnZlcnRleEJ1ZmZlcjtcbiAgICB2YXIgaXQgPSBuZXcgcGMuVmVydGV4SXRlcmF0b3IodmIpO1xuICAgIHZhciBudW1WZXJ0aWNlcyA9IDQ7XG4gICAgZm9yIChpID0gMDtpIDwgbnVtVmVydGljZXM7aSsrKSB7XG4gICAgICBpdC5lbGVtZW50W3BjLlNFTUFOVElDX1BPU0lUSU9OXS5zZXQodGhpcy5fcG9zaXRpb25zW2kgKiAzICsgMF0sIHRoaXMuX3Bvc2l0aW9uc1tpICogMyArIDFdLCB0aGlzLl9wb3NpdGlvbnNbaSAqIDMgKyAyXSk7XG4gICAgICBpdC5lbGVtZW50W3BjLlNFTUFOVElDX05PUk1BTF0uc2V0KHRoaXMuX25vcm1hbHNbaSAqIDMgKyAwXSwgdGhpcy5fbm9ybWFsc1tpICogMyArIDFdLCB0aGlzLl9ub3JtYWxzW2kgKiAzICsgMl0pO1xuICAgICAgaXQuZWxlbWVudFtwYy5TRU1BTlRJQ19URVhDT09SRDBdLnNldCh0aGlzLl91dnNbaSAqIDIgKyAwXSwgdGhpcy5fdXZzW2kgKiAyICsgMV0pO1xuICAgICAgaXQubmV4dCgpO1xuICAgIH1cbiAgICBpdC5lbmQoKTtcbiAgICBtZXNoLmFhYmIuY29tcHV0ZSh0aGlzLl9wb3NpdGlvbnMpO1xuICAgIGlmICh0aGlzLl9tZXNoSW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuX21lc2hJbnN0YW5jZS5fYWFiYlZlciA9IC0xO1xuICAgIH1cbiAgfSwgX29uTWF0ZXJpYWxMb2FkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5tYXRlcmlhbCA9IGFzc2V0LnJlc291cmNlO1xuICB9LCBfb25NYXRlcmlhbEFkZGVkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5fc3lzdGVtLmFwcC5hc3NldHMub2ZmKFwiYWRkOlwiICsgYXNzZXQuaWQsIHRoaXMuX29uTWF0ZXJpYWxBZGRlZCwgdGhpcyk7XG4gICAgaWYgKHRoaXMuX21hdGVyaWFsQXNzZXQgPT09IGFzc2V0LmlkKSB7XG4gICAgICB0aGlzLl9iaW5kTWF0ZXJpYWxBc3NldChhc3NldCk7XG4gICAgfVxuICB9LCBfYmluZE1hdGVyaWFsQXNzZXQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBhc3NldC5vbihcImxvYWRcIiwgdGhpcy5fb25NYXRlcmlhbExvYWQsIHRoaXMpO1xuICAgIGFzc2V0Lm9uKFwiY2hhbmdlXCIsIHRoaXMuX29uTWF0ZXJpYWxDaGFuZ2UsIHRoaXMpO1xuICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMuX29uTWF0ZXJpYWxSZW1vdmUsIHRoaXMpO1xuICAgIGlmIChhc3NldC5yZXNvdXJjZSkge1xuICAgICAgdGhpcy5fb25NYXRlcmlhbExvYWQoYXNzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9zeXN0ZW0uYXBwLmFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICB9XG4gIH0sIF9vbk1hdGVyaWFsQ2hhbmdlOmZ1bmN0aW9uKCkge1xuICB9LCBfb25NYXRlcmlhbFJlbW92ZTpmdW5jdGlvbigpIHtcbiAgfSwgX29uVGV4dHVyZUFkZGVkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5fc3lzdGVtLmFwcC5hc3NldHMub2ZmKFwiYWRkOlwiICsgYXNzZXQuaWQsIHRoaXMuX29uVGV4dHVyZUFkZGVkLCB0aGlzKTtcbiAgICBpZiAodGhpcy5fdGV4dHVyZUFzc2V0ID09PSBhc3NldC5pZCkge1xuICAgICAgdGhpcy5fYmluZFRleHR1cmVBc3NldChhc3NldCk7XG4gICAgfVxuICB9LCBfYmluZFRleHR1cmVBc3NldDpmdW5jdGlvbihhc3NldCkge1xuICAgIGFzc2V0Lm9uKFwibG9hZFwiLCB0aGlzLl9vblRleHR1cmVMb2FkLCB0aGlzKTtcbiAgICBhc3NldC5vbihcImNoYW5nZVwiLCB0aGlzLl9vblRleHR1cmVDaGFuZ2UsIHRoaXMpO1xuICAgIGFzc2V0Lm9uKFwicmVtb3ZlXCIsIHRoaXMuX29uVGV4dHVyZVJlbW92ZSwgdGhpcyk7XG4gICAgaWYgKGFzc2V0LnJlc291cmNlKSB7XG4gICAgICB0aGlzLl9vblRleHR1cmVMb2FkKGFzc2V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fc3lzdGVtLmFwcC5hc3NldHMubG9hZChhc3NldCk7XG4gICAgfVxuICB9LCBfb25UZXh0dXJlTG9hZDpmdW5jdGlvbihhc3NldCkge1xuICAgIHRoaXMudGV4dHVyZSA9IGFzc2V0LnJlc291cmNlO1xuICB9LCBfb25UZXh0dXJlQ2hhbmdlOmZ1bmN0aW9uKGFzc2V0KSB7XG4gIH0sIF9vblRleHR1cmVSZW1vdmU6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgfSwgb25FbmFibGU6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX21vZGVsICYmICF0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwodGhpcy5fbW9kZWwpKSB7XG4gICAgICB0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLmFkZE1vZGVsKHRoaXMuX21vZGVsKTtcbiAgICB9XG4gIH0sIG9uRGlzYWJsZTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fbW9kZWwgJiYgdGhpcy5fc3lzdGVtLmFwcC5zY2VuZS5jb250YWluc01vZGVsKHRoaXMuX21vZGVsKSkge1xuICAgICAgdGhpcy5fc3lzdGVtLmFwcC5zY2VuZS5yZW1vdmVNb2RlbCh0aGlzLl9tb2RlbCk7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShJbWFnZUVsZW1lbnQucHJvdG90eXBlLCBcImNvbG9yXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbG9yO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9jb2xvci5kYXRhWzBdID0gdmFsdWUuZGF0YVswXTtcbiAgICB0aGlzLl9jb2xvci5kYXRhWzFdID0gdmFsdWUuZGF0YVsxXTtcbiAgICB0aGlzLl9jb2xvci5kYXRhWzJdID0gdmFsdWUuZGF0YVsyXTtcbiAgICBpZiAodGhpcy5fbWVzaEluc3RhbmNlKSB7XG4gICAgICB0aGlzLl9tZXNoSW5zdGFuY2Uuc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfZW1pc3NpdmVcIiwgdGhpcy5fY29sb3IuZGF0YTMpO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSW1hZ2VFbGVtZW50LnByb3RvdHlwZSwgXCJvcGFjaXR5XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbG9yLmRhdGFbM107XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2NvbG9yLmRhdGFbM10gPSB2YWx1ZTtcbiAgICB0aGlzLl9tZXNoSW5zdGFuY2Uuc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfb3BhY2l0eVwiLCB2YWx1ZSk7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEltYWdlRWxlbWVudC5wcm90b3R5cGUsIFwicmVjdFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWN0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBwYy5WZWM0KSB7XG4gICAgICB0aGlzLl9yZWN0LnNldCh2YWx1ZS54LCB2YWx1ZS55LCB2YWx1ZS56LCB2YWx1ZS53KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fcmVjdC5zZXQodmFsdWVbMF0sIHZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM10pO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbWVzaCkge1xuICAgICAgdGhpcy5fdXBkYXRlTWVzaCh0aGlzLl9tZXNoKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEltYWdlRWxlbWVudC5wcm90b3R5cGUsIFwibWF0ZXJpYWxcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWF0ZXJpYWw7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIGlmICghdmFsdWUpIHtcbiAgICAgIHZhciBzY3JlZW5TcGFjZSA9IHRoaXMuX2VsZW1lbnQuc2NyZWVuID8gdGhpcy5fZWxlbWVudC5zY3JlZW4uc2NyZWVuLnNjcmVlblNwYWNlIDogZmFsc2U7XG4gICAgICB2YWx1ZSA9IHNjcmVlblNwYWNlID8gdGhpcy5fc3lzdGVtLmRlZmF1bHRTY3JlZW5TcGFjZUltYWdlTWF0ZXJpYWwgOiB0aGlzLl9zeXN0ZW0uZGVmYXVsdEltYWdlTWF0ZXJpYWw7XG4gICAgfVxuICAgIHRoaXMuX21hdGVyaWFsID0gdmFsdWU7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLl9tZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSB2YWx1ZTtcbiAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5fc3lzdGVtLmRlZmF1bHRTY3JlZW5TcGFjZUltYWdlTWF0ZXJpYWwgJiYgdmFsdWUgIT09IHRoaXMuX3N5c3RlbS5kZWZhdWx0SW1hZ2VNYXRlcmlhbCkge1xuICAgICAgICB0aGlzLl9tZXNoSW5zdGFuY2UuZGVsZXRlUGFyYW1ldGVyKFwibWF0ZXJpYWxfb3BhY2l0eVwiKTtcbiAgICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLmRlbGV0ZVBhcmFtZXRlcihcIm1hdGVyaWFsX2VtaXNzaXZlXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLnNldFBhcmFtZXRlcihcIm1hdGVyaWFsX2VtaXNzaXZlXCIsIHRoaXMuX2NvbG9yLmRhdGEzKTtcbiAgICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLnNldFBhcmFtZXRlcihcIm1hdGVyaWFsX29wYWNpdHlcIiwgdGhpcy5fY29sb3IuZGF0YVszXSk7XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShJbWFnZUVsZW1lbnQucHJvdG90eXBlLCBcIm1hdGVyaWFsQXNzZXRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWF0ZXJpYWxBc3NldDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIGFzc2V0cyA9IHRoaXMuX3N5c3RlbS5hcHAuYXNzZXRzO1xuICAgIHZhciBfaWQgPSB2YWx1ZTtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBwYy5Bc3NldCkge1xuICAgICAgX2lkID0gdmFsdWUuaWQ7XG4gICAgfVxuICAgIGlmICh0aGlzLl9tYXRlcmlhbEFzc2V0ICE9PSBfaWQpIHtcbiAgICAgIGlmICh0aGlzLl9tYXRlcmlhbEFzc2V0KSB7XG4gICAgICAgIHZhciBfcHJldiA9IGFzc2V0cy5nZXQodGhpcy5fbWF0ZXJpYWxBc3NldCk7XG4gICAgICAgIGlmIChfcHJldikge1xuICAgICAgICAgIF9wcmV2Lm9mZihcImxvYWRcIiwgdGhpcy5fb25NYXRlcmlhbExvYWQsIHRoaXMpO1xuICAgICAgICAgIF9wcmV2Lm9mZihcImNoYW5nZVwiLCB0aGlzLl9vbk1hdGVyaWFsQ2hhbmdlLCB0aGlzKTtcbiAgICAgICAgICBfcHJldi5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25NYXRlcmlhbFJlbW92ZSwgdGhpcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuX21hdGVyaWFsQXNzZXQgPSBfaWQ7XG4gICAgICBpZiAodGhpcy5fbWF0ZXJpYWxBc3NldCkge1xuICAgICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KHRoaXMuX21hdGVyaWFsQXNzZXQpO1xuICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgdGhpcy5tYXRlcmlhbCA9IG51bGw7XG4gICAgICAgICAgYXNzZXRzLm9uKFwiYWRkOlwiICsgdGhpcy5fbWF0ZXJpYWxBc3NldCwgdGhpcy5fb25NYXRlcmlhbEFkZGVkLCB0aGlzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9iaW5kTWF0ZXJpYWxBc3NldChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubWF0ZXJpYWwgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSW1hZ2VFbGVtZW50LnByb3RvdHlwZSwgXCJ0ZXh0dXJlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RleHR1cmU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3RleHR1cmUgPSB2YWx1ZTtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHRoaXMuX21lc2hJbnN0YW5jZS5zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX2VtaXNzaXZlTWFwXCIsIHRoaXMuX3RleHR1cmUpO1xuICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLnNldFBhcmFtZXRlcihcInRleHR1cmVfb3BhY2l0eU1hcFwiLCB0aGlzLl90ZXh0dXJlKTtcbiAgICAgIHRoaXMuX21lc2hJbnN0YW5jZS5zZXRQYXJhbWV0ZXIoXCJtYXRlcmlhbF9lbWlzc2l2ZVwiLCB0aGlzLl9jb2xvci5kYXRhMyk7XG4gICAgICB0aGlzLl9tZXNoSW5zdGFuY2Uuc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfb3BhY2l0eVwiLCB0aGlzLl9jb2xvci5kYXRhWzNdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbWVzaEluc3RhbmNlLmRlbGV0ZVBhcmFtZXRlcihcInRleHR1cmVfZW1pc3NpdmVNYXBcIik7XG4gICAgICB0aGlzLl9tZXNoSW5zdGFuY2UuZGVsZXRlUGFyYW1ldGVyKFwidGV4dHVyZV9vcGFjaXR5TWFwXCIpO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSW1hZ2VFbGVtZW50LnByb3RvdHlwZSwgXCJ0ZXh0dXJlQXNzZXRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdGV4dHVyZUFzc2V0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5fc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdmFyIF9pZCA9IHZhbHVlO1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICBfaWQgPSB2YWx1ZS5pZDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3RleHR1cmVBc3NldCAhPT0gX2lkKSB7XG4gICAgICBpZiAodGhpcy5fdGV4dHVyZUFzc2V0KSB7XG4gICAgICAgIHZhciBfcHJldiA9IGFzc2V0cy5nZXQodGhpcy5fdGV4dHVyZUFzc2V0KTtcbiAgICAgICAgaWYgKF9wcmV2KSB7XG4gICAgICAgICAgX3ByZXYub2ZmKFwibG9hZFwiLCB0aGlzLl9vblRleHR1cmVMb2FkLCB0aGlzKTtcbiAgICAgICAgICBfcHJldi5vZmYoXCJjaGFuZ2VcIiwgdGhpcy5fb25UZXh0dXJlQ2hhbmdlLCB0aGlzKTtcbiAgICAgICAgICBfcHJldi5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25UZXh0dXJlUmVtb3ZlLCB0aGlzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5fdGV4dHVyZUFzc2V0ID0gX2lkO1xuICAgICAgaWYgKHRoaXMuX3RleHR1cmVBc3NldCkge1xuICAgICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KHRoaXMuX3RleHR1cmVBc3NldCk7XG4gICAgICAgIGlmICghYXNzZXQpIHtcbiAgICAgICAgICB0aGlzLnRleHR1cmUgPSBudWxsO1xuICAgICAgICAgIGFzc2V0cy5vbihcImFkZDpcIiArIHRoaXMuX3RleHR1cmVBc3NldCwgdGhpcy5fb25UZXh0dXJlQWRkZWQsIHRoaXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2JpbmRUZXh0dXJlQXNzZXQoYXNzZXQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRleHR1cmUgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge0ltYWdlRWxlbWVudDpJbWFnZUVsZW1lbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBUZXh0RWxlbWVudCA9IGZ1bmN0aW9uIFRleHRFbGVtZW50KGVsZW1lbnQpIHtcbiAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDtcbiAgICB0aGlzLl9zeXN0ZW0gPSBlbGVtZW50LnN5c3RlbTtcbiAgICB0aGlzLl9lbnRpdHkgPSBlbGVtZW50LmVudGl0eTtcbiAgICB0aGlzLl90ZXh0ID0gXCJcIjtcbiAgICB0aGlzLl9mb250QXNzZXQgPSBudWxsO1xuICAgIHRoaXMuX2ZvbnQgPSBudWxsO1xuICAgIHRoaXMuX2NvbG9yID0gbmV3IHBjLkNvbG9yKDEsIDEsIDEsIDEpO1xuICAgIHRoaXMuX3NwYWNpbmcgPSAxO1xuICAgIHRoaXMuX2ZvbnRTaXplID0gMzI7XG4gICAgdGhpcy5fbGluZUhlaWdodCA9IDMyO1xuICAgIHRoaXMuX2FsaWdubWVudCA9IG5ldyBwYy5WZWMyKDAuNSwgMC41KTtcbiAgICB0aGlzLl9hdXRvV2lkdGggPSB0cnVlO1xuICAgIHRoaXMuX2F1dG9IZWlnaHQgPSB0cnVlO1xuICAgIHRoaXMud2lkdGggPSAwO1xuICAgIHRoaXMuaGVpZ2h0ID0gMDtcbiAgICB0aGlzLl9ub2RlID0gbmV3IHBjLkdyYXBoTm9kZTtcbiAgICB0aGlzLl9tb2RlbCA9IG5ldyBwYy5Nb2RlbDtcbiAgICB0aGlzLl9tb2RlbC5ncmFwaCA9IHRoaXMuX25vZGU7XG4gICAgdGhpcy5fZW50aXR5LmFkZENoaWxkKHRoaXMuX25vZGUpO1xuICAgIHRoaXMuX21lc2hJbmZvID0gW107XG4gICAgdGhpcy5fbWF0ZXJpYWwgPSBudWxsO1xuICAgIHRoaXMuX25vUmVzaXplID0gZmFsc2U7XG4gICAgdGhpcy5fb25TY3JlZW5DaGFuZ2UodGhpcy5fZWxlbWVudC5zY3JlZW4pO1xuICAgIGVsZW1lbnQub24oXCJyZXNpemVcIiwgdGhpcy5fb25QYXJlbnRSZXNpemUsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub24oXCJzZXQ6c2NyZWVuXCIsIHRoaXMuX29uU2NyZWVuQ2hhbmdlLCB0aGlzKTtcbiAgICBlbGVtZW50Lm9uKFwic2NyZWVuOnNldDpzY3JlZW5zcGFjZVwiLCB0aGlzLl9vblNjcmVlblNwYWNlQ2hhbmdlLCB0aGlzKTtcbiAgICBlbGVtZW50Lm9uKFwic2V0OmRyYXdvcmRlclwiLCB0aGlzLl9vbkRyYXdPcmRlckNoYW5nZSwgdGhpcyk7XG4gICAgZWxlbWVudC5vbihcInNldDpwaXZvdFwiLCB0aGlzLl9vblBpdm90Q2hhbmdlLCB0aGlzKTtcbiAgfTtcbiAgcGMuZXh0ZW5kKFRleHRFbGVtZW50LnByb3RvdHlwZSwge2Rlc3Ryb3k6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICB0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLnJlbW92ZU1vZGVsKHRoaXMuX21vZGVsKTtcbiAgICAgIHRoaXMuX21vZGVsLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuX21vZGVsID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5fZWxlbWVudC5vZmYoXCJyZXNpemVcIiwgdGhpcy5fb25QYXJlbnRSZXNpemUsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub2ZmKFwic2V0OnNjcmVlblwiLCB0aGlzLl9vblNjcmVlbkNoYW5nZSwgdGhpcyk7XG4gICAgdGhpcy5fZWxlbWVudC5vZmYoXCJzY3JlZW46c2V0OnNjcmVlbnNwYWNlXCIsIHRoaXMuX29uU2NyZWVuU3BhY2VDaGFuZ2UsIHRoaXMpO1xuICAgIHRoaXMuX2VsZW1lbnQub2ZmKFwic2V0OmRyYXdvcmRlclwiLCB0aGlzLl9vbkRyYXdPcmRlckNoYW5nZSwgdGhpcyk7XG4gICAgdGhpcy5fZWxlbWVudC5vZmYoXCJzZXQ6cGl2b3RcIiwgdGhpcy5fb25QaXZvdENoYW5nZSwgdGhpcyk7XG4gIH0sIF9vblBhcmVudFJlc2l6ZTpmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7XG4gICAgaWYgKHRoaXMuX25vUmVzaXplKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLl9mb250KSB7XG4gICAgICB0aGlzLl91cGRhdGVUZXh0KHRoaXMuX3RleHQpO1xuICAgIH1cbiAgfSwgX29uU2NyZWVuQ2hhbmdlOmZ1bmN0aW9uKHNjcmVlbikge1xuICAgIGlmIChzY3JlZW4pIHtcbiAgICAgIHRoaXMuX3VwZGF0ZU1hdGVyaWFsKHNjcmVlbi5zY3JlZW4uc2NyZWVuU3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91cGRhdGVNYXRlcmlhbChmYWxzZSk7XG4gICAgfVxuICB9LCBfb25TY3JlZW5TcGFjZUNoYW5nZTpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX3VwZGF0ZU1hdGVyaWFsKHZhbHVlKTtcbiAgfSwgX29uRHJhd09yZGVyQ2hhbmdlOmZ1bmN0aW9uKG9yZGVyKSB7XG4gICAgdGhpcy5fZHJhd09yZGVyID0gb3JkZXI7XG4gICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlc1tpXS5kcmF3T3JkZXIgPSBvcmRlcjtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9vblBpdm90Q2hhbmdlOmZ1bmN0aW9uKHBpdm90KSB7XG4gICAgaWYgKHRoaXMuX2ZvbnQpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVRleHQoKTtcbiAgICB9XG4gIH0sIF91cGRhdGVUZXh0OmZ1bmN0aW9uKHRleHQpIHtcbiAgICBpZiAodGV4dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0ZXh0ID0gdGhpcy5fdGV4dDtcbiAgICB9XG4gICAgdmFyIHRleHRMZW5ndGggPSB0ZXh0Lmxlbmd0aDtcbiAgICBpZiAodGV4dExlbmd0aCA9PT0gMCkge1xuICAgICAgdGV4dExlbmd0aCA9IDE7XG4gICAgICB0ZXh0ID0gXCIgXCI7XG4gICAgfVxuICAgIHZhciBjaGFyYWN0ZXJzUGVyVGV4dHVyZSA9IHt9O1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCB0ZXh0TGVuZ3RoO2krKykge1xuICAgICAgdmFyIGNvZGUgPSB0ZXh0LmNoYXJDb2RlQXQoaSk7XG4gICAgICB2YXIgaW5mbyA9IHRoaXMuX2ZvbnQuZGF0YS5jaGFyc1tjb2RlXTtcbiAgICAgIGlmICghaW5mbykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZhciBtYXAgPSBpbmZvLm1hcDtcbiAgICAgIGlmICghY2hhcmFjdGVyc1BlclRleHR1cmVbbWFwXSkge1xuICAgICAgICBjaGFyYWN0ZXJzUGVyVGV4dHVyZVttYXBdID0gMDtcbiAgICAgIH1cbiAgICAgIGNoYXJhY3RlcnNQZXJUZXh0dXJlW21hcF0rKztcbiAgICB9XG4gICAgdmFyIHJlbW92ZWRNb2RlbCA9ICF0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwodGhpcy5fbW9kZWwpO1xuICAgIHZhciBzY3JlZW5TcGFjZSA9IHRoaXMuX2VsZW1lbnQuc2NyZWVuICYmIHRoaXMuX2VsZW1lbnQuc2NyZWVuLnNjcmVlbi5zY3JlZW5TcGFjZTtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fbWVzaEluZm8ubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICB2YXIgbCA9IGNoYXJhY3RlcnNQZXJUZXh0dXJlW2ldIHx8IDA7XG4gICAgICB2YXIgbWVzaEluZm8gPSB0aGlzLl9tZXNoSW5mb1tpXTtcbiAgICAgIGlmIChtZXNoSW5mby5jb3VudCAhPT0gbCkge1xuICAgICAgICBpZiAoIXJlbW92ZWRNb2RlbCkge1xuICAgICAgICAgIHRoaXMuX3N5c3RlbS5hcHAuc2NlbmUucmVtb3ZlTW9kZWwodGhpcy5fbW9kZWwpO1xuICAgICAgICAgIHJlbW92ZWRNb2RlbCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgbWVzaEluZm8uY291bnQgPSBsO1xuICAgICAgICBtZXNoSW5mby5wb3NpdGlvbnMubGVuZ3RoID0gbWVzaEluZm8ubm9ybWFscy5sZW5ndGggPSBsICogMyAqIDQ7XG4gICAgICAgIG1lc2hJbmZvLmluZGljZXMubGVuZ3RoID0gbCAqIDMgKiAyO1xuICAgICAgICBtZXNoSW5mby51dnMubGVuZ3RoID0gbCAqIDIgKiA0O1xuICAgICAgICBpZiAobWVzaEluZm8ubWVzaEluc3RhbmNlKSB7XG4gICAgICAgICAgdGhpcy5fcmVtb3ZlTWVzaEluc3RhbmNlKG1lc2hJbmZvLm1lc2hJbnN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGwgPT09IDApIHtcbiAgICAgICAgICBtZXNoSW5mby5tZXNoSW5zdGFuY2UgPSBudWxsO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIHYgPSAwO3YgPCBsO3YrKykge1xuICAgICAgICAgIG1lc2hJbmZvLmluZGljZXNbdiAqIDMgKiAyICsgMF0gPSB2ICogNDtcbiAgICAgICAgICBtZXNoSW5mby5pbmRpY2VzW3YgKiAzICogMiArIDFdID0gdiAqIDQgKyAxO1xuICAgICAgICAgIG1lc2hJbmZvLmluZGljZXNbdiAqIDMgKiAyICsgMl0gPSB2ICogNCArIDM7XG4gICAgICAgICAgbWVzaEluZm8uaW5kaWNlc1t2ICogMyAqIDIgKyAzXSA9IHYgKiA0ICsgMjtcbiAgICAgICAgICBtZXNoSW5mby5pbmRpY2VzW3YgKiAzICogMiArIDRdID0gdiAqIDQgKyAzO1xuICAgICAgICAgIG1lc2hJbmZvLmluZGljZXNbdiAqIDMgKiAyICsgNV0gPSB2ICogNCArIDE7XG4gICAgICAgICAgbWVzaEluZm8ubm9ybWFsc1t2ICogNCAqIDMgKyAwXSA9IDA7XG4gICAgICAgICAgbWVzaEluZm8ubm9ybWFsc1t2ICogNCAqIDMgKyAxXSA9IDA7XG4gICAgICAgICAgbWVzaEluZm8ubm9ybWFsc1t2ICogNCAqIDMgKyAyXSA9IC0xO1xuICAgICAgICAgIG1lc2hJbmZvLm5vcm1hbHNbdiAqIDQgKiAzICsgM10gPSAwO1xuICAgICAgICAgIG1lc2hJbmZvLm5vcm1hbHNbdiAqIDQgKiAzICsgNF0gPSAwO1xuICAgICAgICAgIG1lc2hJbmZvLm5vcm1hbHNbdiAqIDQgKiAzICsgNV0gPSAtMTtcbiAgICAgICAgICBtZXNoSW5mby5ub3JtYWxzW3YgKiA0ICogMyArIDZdID0gMDtcbiAgICAgICAgICBtZXNoSW5mby5ub3JtYWxzW3YgKiA0ICogMyArIDddID0gMDtcbiAgICAgICAgICBtZXNoSW5mby5ub3JtYWxzW3YgKiA0ICogMyArIDhdID0gLTE7XG4gICAgICAgICAgbWVzaEluZm8ubm9ybWFsc1t2ICogNCAqIDMgKyA5XSA9IDA7XG4gICAgICAgICAgbWVzaEluZm8ubm9ybWFsc1t2ICogNCAqIDMgKyAxMF0gPSAwO1xuICAgICAgICAgIG1lc2hJbmZvLm5vcm1hbHNbdiAqIDQgKiAzICsgMTFdID0gLTE7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lc2ggPSBwYy5jcmVhdGVNZXNoKHRoaXMuX3N5c3RlbS5hcHAuZ3JhcGhpY3NEZXZpY2UsIG1lc2hJbmZvLnBvc2l0aW9ucywge3V2czptZXNoSW5mby51dnMsIG5vcm1hbHM6bWVzaEluZm8ubm9ybWFscywgaW5kaWNlczptZXNoSW5mby5pbmRpY2VzfSk7XG4gICAgICAgIHZhciBtaSA9IG5ldyBwYy5NZXNoSW5zdGFuY2UodGhpcy5fbm9kZSwgbWVzaCwgdGhpcy5fbWF0ZXJpYWwpO1xuICAgICAgICBtaS5jYXN0U2hhZG93ID0gZmFsc2U7XG4gICAgICAgIG1pLnJlY2VpdmVTaGFkb3cgPSBmYWxzZTtcbiAgICAgICAgbWkuZHJhd09yZGVyID0gdGhpcy5fZHJhd09yZGVyO1xuICAgICAgICBpZiAoc2NyZWVuU3BhY2UpIHtcbiAgICAgICAgICBtaS5sYXllciA9IHBjLnNjZW5lLkxBWUVSX0hVRDtcbiAgICAgICAgfVxuICAgICAgICBtaS5zY3JlZW5TcGFjZSA9IHNjcmVlblNwYWNlO1xuICAgICAgICBtaS5zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX21zZGZNYXBcIiwgdGhpcy5fZm9udC50ZXh0dXJlc1tpXSk7XG4gICAgICAgIG1pLnNldFBhcmFtZXRlcihcIm1hdGVyaWFsX2VtaXNzaXZlXCIsIHRoaXMuX2NvbG9yLmRhdGEzKTtcbiAgICAgICAgbWkuc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfb3BhY2l0eVwiLCB0aGlzLl9jb2xvci5kYXRhWzNdKTtcbiAgICAgICAgbWkuc2V0UGFyYW1ldGVyKFwiZm9udF9zZGZJbnRlbnNpdHlcIiwgdGhpcy5fZm9udC5pbnRlbnNpdHkpO1xuICAgICAgICBtaS5zZXRQYXJhbWV0ZXIoXCJmb250X3B4cmFuZ2VcIiwgdGhpcy5fZ2V0UHhSYW5nZSh0aGlzLl9mb250KSk7XG4gICAgICAgIG1pLnNldFBhcmFtZXRlcihcImZvbnRfdGV4dHVyZVdpZHRoXCIsIHRoaXMuX2ZvbnQuZGF0YS5pbmZvLm1hcHNbaV0ud2lkdGgpO1xuICAgICAgICBtZXNoSW5mby5tZXNoSW5zdGFuY2UgPSBtaTtcbiAgICAgICAgdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlcy5wdXNoKG1pKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlbW92ZWRNb2RlbCAmJiB0aGlzLl9lbGVtZW50LmVuYWJsZWQgJiYgdGhpcy5fZW50aXR5LmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuX3N5c3RlbS5hcHAuc2NlbmUuYWRkTW9kZWwodGhpcy5fbW9kZWwpO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVNZXNoZXModGV4dCk7XG4gIH0sIF9yZW1vdmVNZXNoSW5zdGFuY2U6ZnVuY3Rpb24obWVzaEluc3RhbmNlKSB7XG4gICAgdmFyIG9sZE1lc2ggPSBtZXNoSW5zdGFuY2UubWVzaDtcbiAgICBpZiAob2xkTWVzaCkge1xuICAgICAgaWYgKG9sZE1lc2gudmVydGV4QnVmZmVyKSB7XG4gICAgICAgIG9sZE1lc2gudmVydGV4QnVmZmVyLmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICAgIGlmIChvbGRNZXNoLmluZGV4QnVmZmVyKSB7XG4gICAgICAgIGZvciAodmFyIGliID0gMCwgaWJsZW4gPSBvbGRNZXNoLmluZGV4QnVmZmVyLmxlbmd0aDtpYiA8IGlibGVuO2liKyspIHtcbiAgICAgICAgICBvbGRNZXNoLmluZGV4QnVmZmVyW2liXS5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGlkeCA9IHRoaXMuX21vZGVsLm1lc2hJbnN0YW5jZXMuaW5kZXhPZihtZXNoSW5zdGFuY2UpO1xuICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICB0aGlzLl9tb2RlbC5tZXNoSW5zdGFuY2VzLnNwbGljZShpZHgsIDEpO1xuICAgIH1cbiAgfSwgX3VwZGF0ZU1hdGVyaWFsOmZ1bmN0aW9uKHNjcmVlblNwYWNlKSB7XG4gICAgdmFyIGxheWVyO1xuICAgIGlmIChzY3JlZW5TcGFjZSkge1xuICAgICAgdGhpcy5fbWF0ZXJpYWwgPSB0aGlzLl9zeXN0ZW0uZGVmYXVsdFNjcmVlblNwYWNlVGV4dE1hdGVyaWFsO1xuICAgICAgbGF5ZXIgPSBwYy5zY2VuZS5MQVlFUl9IVUQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX21hdGVyaWFsID0gdGhpcy5fc3lzdGVtLmRlZmF1bHRUZXh0TWF0ZXJpYWw7XG4gICAgICBsYXllciA9IHBjLnNjZW5lLkxBWUVSX1dPUkxEO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbW9kZWwpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9tb2RlbC5tZXNoSW5zdGFuY2VzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgICB2YXIgbWkgPSB0aGlzLl9tb2RlbC5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgICBtaS5sYXllciA9IGxheWVyO1xuICAgICAgICBtaS5tYXRlcmlhbCA9IHRoaXMuX21hdGVyaWFsO1xuICAgICAgICBtaS5zY3JlZW5TcGFjZSA9IHNjcmVlblNwYWNlO1xuICAgICAgfVxuICAgIH1cbiAgfSwgX3VwZGF0ZU1lc2hlczpmdW5jdGlvbih0ZXh0KSB7XG4gICAgdmFyIGpzb24gPSB0aGlzLl9mb250LmRhdGE7XG4gICAgdGhpcy53aWR0aCA9IDA7XG4gICAgdGhpcy5oZWlnaHQgPSAwO1xuICAgIHZhciBsaW5lV2lkdGhzID0gW107XG4gICAgdmFyIGwgPSB0ZXh0Lmxlbmd0aDtcbiAgICB2YXIgX3ggPSAwO1xuICAgIHZhciBfeSA9IDA7XG4gICAgdmFyIF96ID0gMDtcbiAgICB2YXIgbGluZXMgPSAxO1xuICAgIHZhciBsYXN0TGluZSA9IDA7XG4gICAgdmFyIGZvbnRNaW5ZID0gMDtcbiAgICB2YXIgZm9udE1heFkgPSAwO1xuICAgIHZhciBzY2FsZSA9IDE7XG4gICAgdmFyIE1BR0lDID0gMzI7XG4gICAgdmFyIGNoYXIsIGRhdGEsIGk7XG4gICAgZm9yIChjaGFyIGluIGpzb24uY2hhcnMpIHtcbiAgICAgIGRhdGEgPSBqc29uLmNoYXJzW2NoYXJdO1xuICAgICAgc2NhbGUgPSBkYXRhLmhlaWdodCAvIE1BR0lDICogdGhpcy5fZm9udFNpemUgLyBkYXRhLmhlaWdodDtcbiAgICAgIGlmIChkYXRhLmJvdW5kcykge1xuICAgICAgICBmb250TWluWSA9IE1hdGgubWluKGZvbnRNaW5ZLCBkYXRhLmJvdW5kc1sxXSAqIHNjYWxlKTtcbiAgICAgICAgZm9udE1heFkgPSBNYXRoLm1heChmb250TWF4WSwgZGF0YS5ib3VuZHNbM10gKiBzY2FsZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IHRoaXMuX21lc2hJbmZvLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnF1YWQgPSAwO1xuICAgICAgdGhpcy5fbWVzaEluZm9baV0ubGluZXMgPSB7fTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbDtpKyspIHtcbiAgICAgIGNoYXIgPSB0ZXh0LmNoYXJDb2RlQXQoaSk7XG4gICAgICBpZiAoY2hhciA9PT0gMTAgfHwgY2hhciA9PT0gMTMpIHtcbiAgICAgICAgX3kgLT0gdGhpcy5fbGluZUhlaWdodDtcbiAgICAgICAgX3ggPSAwO1xuICAgICAgICBsaW5lcysrO1xuICAgICAgICBsYXN0TGluZSA9IGxpbmVzO1xuICAgICAgICBsaW5lV2lkdGhzLnB1c2goMCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgbGluZVdpZHRoc1tsaW5lcyAtIDFdID0gMDtcbiAgICAgIHZhciB4ID0gMDtcbiAgICAgIHZhciB5ID0gMDtcbiAgICAgIHZhciBhZHZhbmNlID0gMDtcbiAgICAgIHZhciBxdWFkc2l6ZSA9IDE7XG4gICAgICB2YXIgZ2x5cGhNaW5YID0gMDtcbiAgICAgIHZhciBnbHlwaFdpZHRoID0gMDtcbiAgICAgIGRhdGEgPSBqc29uLmNoYXJzW2NoYXJdO1xuICAgICAgaWYgKGRhdGEgJiYgZGF0YS5zY2FsZSkge1xuICAgICAgICB2YXIgc2l6ZSA9IChkYXRhLndpZHRoICsgZGF0YS5oZWlnaHQpIC8gMjtcbiAgICAgICAgc2NhbGUgPSBzaXplIC8gTUFHSUMgKiB0aGlzLl9mb250U2l6ZSAvIHNpemU7XG4gICAgICAgIHF1YWRzaXplID0gc2l6ZSAvIE1BR0lDICogdGhpcy5fZm9udFNpemUgLyBkYXRhLnNjYWxlO1xuICAgICAgICBhZHZhbmNlID0gZGF0YS54YWR2YW5jZSAqIHNjYWxlO1xuICAgICAgICB4ID0gZGF0YS54b2Zmc2V0ICogc2NhbGU7XG4gICAgICAgIHkgPSBkYXRhLnlvZmZzZXQgKiBzY2FsZTtcbiAgICAgICAgaWYgKGRhdGEuYm91bmRzKSB7XG4gICAgICAgICAgZ2x5cGhXaWR0aCA9IChkYXRhLmJvdW5kc1syXSAtIGRhdGEuYm91bmRzWzBdKSAqIHNjYWxlO1xuICAgICAgICAgIGdseXBoTWluWCA9IGRhdGEuYm91bmRzWzBdICogc2NhbGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ2x5cGhXaWR0aCA9IHg7XG4gICAgICAgICAgZ2x5cGhNaW5YID0gMDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWR2YW5jZSA9IDE7XG4gICAgICAgIHggPSAwO1xuICAgICAgICB5ID0gMDtcbiAgICAgICAgcXVhZHNpemUgPSB0aGlzLl9mb250U2l6ZTtcbiAgICAgIH1cbiAgICAgIHZhciBtZXNoSW5mbyA9IHRoaXMuX21lc2hJbmZvW2RhdGEgJiYgZGF0YS5tYXAgfHwgMF07XG4gICAgICB2YXIgcXVhZCA9IG1lc2hJbmZvLnF1YWQ7XG4gICAgICBtZXNoSW5mby5saW5lc1tsaW5lcyAtIDFdID0gcXVhZDtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAwXSA9IF94IC0geDtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAxXSA9IF95IC0geTtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAyXSA9IF96O1xuICAgICAgbWVzaEluZm8ucG9zaXRpb25zW3F1YWQgKiA0ICogMyArIDNdID0gX3ggLSB4ICsgcXVhZHNpemU7XG4gICAgICBtZXNoSW5mby5wb3NpdGlvbnNbcXVhZCAqIDQgKiAzICsgNF0gPSBfeSAtIHk7XG4gICAgICBtZXNoSW5mby5wb3NpdGlvbnNbcXVhZCAqIDQgKiAzICsgNV0gPSBfejtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA2XSA9IF94IC0geCArIHF1YWRzaXplO1xuICAgICAgbWVzaEluZm8ucG9zaXRpb25zW3F1YWQgKiA0ICogMyArIDddID0gX3kgLSB5ICsgcXVhZHNpemU7XG4gICAgICBtZXNoSW5mby5wb3NpdGlvbnNbcXVhZCAqIDQgKiAzICsgOF0gPSBfejtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA5XSA9IF94IC0geDtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAxMF0gPSBfeSAtIHkgKyBxdWFkc2l6ZTtcbiAgICAgIG1lc2hJbmZvLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAxMV0gPSBfejtcbiAgICAgIHRoaXMud2lkdGggPSBNYXRoLm1heCh0aGlzLndpZHRoLCBfeCArIGdseXBoV2lkdGggKyBnbHlwaE1pblgpO1xuICAgICAgbGluZVdpZHRoc1tsaW5lcyAtIDFdID0gTWF0aC5tYXgobGluZVdpZHRoc1tsaW5lcyAtIDFdLCBfeCArIGdseXBoV2lkdGggKyBnbHlwaE1pblgpO1xuICAgICAgdGhpcy5oZWlnaHQgPSBNYXRoLm1heCh0aGlzLmhlaWdodCwgZm9udE1heFkgLSAoX3kgKyBmb250TWluWSkpO1xuICAgICAgX3ggPSBfeCArIHRoaXMuX3NwYWNpbmcgKiBhZHZhbmNlO1xuICAgICAgdmFyIHV2ID0gdGhpcy5fZ2V0VXYoY2hhcik7XG4gICAgICBtZXNoSW5mby51dnNbcXVhZCAqIDQgKiAyICsgMF0gPSB1dlswXTtcbiAgICAgIG1lc2hJbmZvLnV2c1txdWFkICogNCAqIDIgKyAxXSA9IHV2WzFdO1xuICAgICAgbWVzaEluZm8udXZzW3F1YWQgKiA0ICogMiArIDJdID0gdXZbMl07XG4gICAgICBtZXNoSW5mby51dnNbcXVhZCAqIDQgKiAyICsgM10gPSB1dlsxXTtcbiAgICAgIG1lc2hJbmZvLnV2c1txdWFkICogNCAqIDIgKyA0XSA9IHV2WzJdO1xuICAgICAgbWVzaEluZm8udXZzW3F1YWQgKiA0ICogMiArIDVdID0gdXZbM107XG4gICAgICBtZXNoSW5mby51dnNbcXVhZCAqIDQgKiAyICsgNl0gPSB1dlswXTtcbiAgICAgIG1lc2hJbmZvLnV2c1txdWFkICogNCAqIDIgKyA3XSA9IHV2WzNdO1xuICAgICAgbWVzaEluZm8ucXVhZCsrO1xuICAgIH1cbiAgICB0aGlzLl9ub1Jlc2l6ZSA9IHRydWU7XG4gICAgdGhpcy5hdXRvV2lkdGggPSB0aGlzLl9hdXRvV2lkdGg7XG4gICAgdGhpcy5hdXRvSGVpZ2h0ID0gdGhpcy5fYXV0b0hlaWdodDtcbiAgICB0aGlzLl9ub1Jlc2l6ZSA9IGZhbHNlO1xuICAgIHZhciBocCA9IHRoaXMuX2VsZW1lbnQucGl2b3QuZGF0YVswXTtcbiAgICB2YXIgdnAgPSB0aGlzLl9lbGVtZW50LnBpdm90LmRhdGFbMV07XG4gICAgdmFyIGhhID0gdGhpcy5fYWxpZ25tZW50Lng7XG4gICAgdmFyIHZhID0gdGhpcy5fYWxpZ25tZW50Lnk7XG4gICAgZm9yIChpID0gMDtpIDwgdGhpcy5fbWVzaEluZm8ubGVuZ3RoO2krKykge1xuICAgICAgaWYgKHRoaXMuX21lc2hJbmZvW2ldLmNvdW50ID09PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdmFyIHByZXZRdWFkID0gMDtcbiAgICAgIGZvciAodmFyIGxpbmUgaW4gdGhpcy5fbWVzaEluZm9baV0ubGluZXMpIHtcbiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5fbWVzaEluZm9baV0ubGluZXNbbGluZV07XG4gICAgICAgIHZhciBob2Zmc2V0ID0gLWhwICogdGhpcy5fZWxlbWVudC53aWR0aCArIGhhICogKHRoaXMuX2VsZW1lbnQud2lkdGggLSBsaW5lV2lkdGhzW3BhcnNlSW50KGxpbmUsIDEwKV0pO1xuICAgICAgICB2YXIgdm9mZnNldCA9ICgxIC0gdnApICogdGhpcy5fZWxlbWVudC5oZWlnaHQgLSBmb250TWF4WSAtICgxIC0gdmEpICogKHRoaXMuX2VsZW1lbnQuaGVpZ2h0IC0gdGhpcy5oZWlnaHQpO1xuICAgICAgICBmb3IgKHZhciBxdWFkID0gcHJldlF1YWQ7cXVhZCA8PSBpbmRleDtxdWFkKyspIHtcbiAgICAgICAgICB0aGlzLl9tZXNoSW5mb1tpXS5wb3NpdGlvbnNbcXVhZCAqIDQgKiAzXSArPSBob2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAzXSArPSBob2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA2XSArPSBob2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA5XSArPSBob2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAxXSArPSB2b2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA0XSArPSB2b2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyA3XSArPSB2b2Zmc2V0O1xuICAgICAgICAgIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1txdWFkICogNCAqIDMgKyAxMF0gKz0gdm9mZnNldDtcbiAgICAgICAgfVxuICAgICAgICBwcmV2UXVhZCA9IGluZGV4ICsgMTtcbiAgICAgIH1cbiAgICAgIHZhciBudW1WZXJ0aWNlcyA9IHRoaXMuX21lc2hJbmZvW2ldLnF1YWQgKiA0O1xuICAgICAgdmFyIGl0ID0gbmV3IHBjLlZlcnRleEl0ZXJhdG9yKHRoaXMuX21lc2hJbmZvW2ldLm1lc2hJbnN0YW5jZS5tZXNoLnZlcnRleEJ1ZmZlcik7XG4gICAgICBmb3IgKHZhciB2ID0gMDt2IDwgbnVtVmVydGljZXM7disrKSB7XG4gICAgICAgIGl0LmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCh0aGlzLl9tZXNoSW5mb1tpXS5wb3NpdGlvbnNbdiAqIDMgKyAwXSwgdGhpcy5fbWVzaEluZm9baV0ucG9zaXRpb25zW3YgKiAzICsgMV0sIHRoaXMuX21lc2hJbmZvW2ldLnBvc2l0aW9uc1t2ICogMyArIDJdKTtcbiAgICAgICAgaXQuZWxlbWVudFtwYy5TRU1BTlRJQ19URVhDT09SRDBdLnNldCh0aGlzLl9tZXNoSW5mb1tpXS51dnNbdiAqIDIgKyAwXSwgdGhpcy5fbWVzaEluZm9baV0udXZzW3YgKiAyICsgMV0pO1xuICAgICAgICBpdC5uZXh0KCk7XG4gICAgICB9XG4gICAgICBpdC5lbmQoKTtcbiAgICAgIHRoaXMuX21lc2hJbmZvW2ldLm1lc2hJbnN0YW5jZS5tZXNoLmFhYmIuY29tcHV0ZSh0aGlzLl9tZXNoSW5mb1tpXS5wb3NpdGlvbnMpO1xuICAgICAgdGhpcy5fbWVzaEluZm9baV0ubWVzaEluc3RhbmNlLl9hYWJiVmVyID0gLTE7XG4gICAgfVxuICB9LCBfb25Gb250QWRkZWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICB0aGlzLl9zeXN0ZW0uYXBwLmFzc2V0cy5vZmYoXCJhZGQ6XCIgKyBhc3NldC5pZCwgdGhpcy5fb25Gb250QWRkZWQsIHRoaXMpO1xuICAgIGlmIChhc3NldC5pZCA9PT0gdGhpcy5fZm9udEFzc2V0KSB7XG4gICAgICB0aGlzLl9iaW5kRm9udChhc3NldCk7XG4gICAgfVxuICB9LCBfYmluZEZvbnQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBhc3NldC5vbihcImxvYWRcIiwgdGhpcy5fb25Gb250TG9hZCwgdGhpcyk7XG4gICAgYXNzZXQub24oXCJjaGFuZ2VcIiwgdGhpcy5fb25Gb250Q2hhbmdlLCB0aGlzKTtcbiAgICBhc3NldC5vbihcInJlbW92ZVwiLCB0aGlzLl9vbkZvbnRSZW1vdmUsIHRoaXMpO1xuICAgIGlmIChhc3NldC5yZXNvdXJjZSkge1xuICAgICAgdGhpcy5fb25Gb250TG9hZChhc3NldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N5c3RlbS5hcHAuYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgIH1cbiAgfSwgX29uRm9udExvYWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBpZiAodGhpcy5mb250ICE9PSBhc3NldC5yZXNvdXJjZSkge1xuICAgICAgdGhpcy5mb250ID0gYXNzZXQucmVzb3VyY2U7XG4gICAgfVxuICB9LCBfb25Gb250Q2hhbmdlOmZ1bmN0aW9uKGFzc2V0LCBuYW1lLCBfbmV3LCBfb2xkKSB7XG4gICAgaWYgKG5hbWUgPT09IFwiZGF0YVwiKSB7XG4gICAgICB0aGlzLl9mb250LmRhdGEgPSBfbmV3O1xuICAgICAgdmFyIG1hcHMgPSB0aGlzLl9mb250LmRhdGEuaW5mby5tYXBzLmxlbmd0aDtcbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBtYXBzO2krKykge1xuICAgICAgICBpZiAoIXRoaXMuX21lc2hJbmZvW2ldKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1pID0gdGhpcy5fbWVzaEluZm9baV0ubWVzaEluc3RhbmNlO1xuICAgICAgICBpZiAobWkpIHtcbiAgICAgICAgICBtaS5zZXRQYXJhbWV0ZXIoXCJmb250X3NkZkludGVuc2l0eVwiLCB0aGlzLl9mb250LmludGVuc2l0eSk7XG4gICAgICAgICAgbWkuc2V0UGFyYW1ldGVyKFwiZm9udF9weHJhbmdlXCIsIHRoaXMuX2dldFB4UmFuZ2UodGhpcy5fZm9udCkpO1xuICAgICAgICAgIG1pLnNldFBhcmFtZXRlcihcImZvbnRfdGV4dHVyZVdpZHRoXCIsIHRoaXMuX2ZvbnQuZGF0YS5pbmZvLm1hcHNbaV0ud2lkdGgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfb25Gb250UmVtb3ZlOmZ1bmN0aW9uKGFzc2V0KSB7XG4gIH0sIF9nZXRQeFJhbmdlOmZ1bmN0aW9uKGZvbnQpIHtcbiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX2ZvbnQuZGF0YS5jaGFycyk7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IGtleXMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIGNoYXIgPSB0aGlzLl9mb250LmRhdGEuY2hhcnNba2V5c1tpXV07XG4gICAgICBpZiAoY2hhci5zY2FsZSAmJiBjaGFyLnJhbmdlKSB7XG4gICAgICAgIHJldHVybiBjaGFyLnNjYWxlICogY2hhci5yYW5nZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIDI7XG4gIH0sIF9nZXRVdjpmdW5jdGlvbihjaGFyKSB7XG4gICAgdmFyIGRhdGEgPSB0aGlzLl9mb250LmRhdGE7XG4gICAgaWYgKCFkYXRhLmNoYXJzW2NoYXJdKSB7XG4gICAgICBpZiAoZGF0YS5jaGFyc1szMl0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFV2KDMyKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbMCwgMCwgMSwgMV07XG4gICAgfVxuICAgIHZhciBtYXAgPSBkYXRhLmNoYXJzW2NoYXJdLm1hcDtcbiAgICB2YXIgd2lkdGggPSBkYXRhLmluZm8ubWFwc1ttYXBdLndpZHRoO1xuICAgIHZhciBoZWlnaHQgPSBkYXRhLmluZm8ubWFwc1ttYXBdLmhlaWdodDtcbiAgICB2YXIgeCA9IGRhdGEuY2hhcnNbY2hhcl0ueDtcbiAgICB2YXIgeSA9IGRhdGEuY2hhcnNbY2hhcl0ueTtcbiAgICB2YXIgeDEgPSB4O1xuICAgIHZhciB5MSA9IHk7XG4gICAgdmFyIHgyID0geCArIGRhdGEuY2hhcnNbY2hhcl0ud2lkdGg7XG4gICAgdmFyIHkyID0geSAtIGRhdGEuY2hhcnNbY2hhcl0uaGVpZ2h0O1xuICAgIHZhciBlZGdlID0gMSAtIGRhdGEuY2hhcnNbY2hhcl0uaGVpZ2h0IC8gaGVpZ2h0O1xuICAgIHJldHVybiBbeDEgLyB3aWR0aCwgZWRnZSAtIHkxIC8gaGVpZ2h0LCB4MiAvIHdpZHRoLCBlZGdlIC0geTIgLyBoZWlnaHRdO1xuICB9LCBvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5fbW9kZWwgJiYgIXRoaXMuX3N5c3RlbS5hcHAuc2NlbmUuY29udGFpbnNNb2RlbCh0aGlzLl9tb2RlbCkpIHtcbiAgICAgIHRoaXMuX3N5c3RlbS5hcHAuc2NlbmUuYWRkTW9kZWwodGhpcy5fbW9kZWwpO1xuICAgIH1cbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLl9tb2RlbCAmJiB0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLmNvbnRhaW5zTW9kZWwodGhpcy5fbW9kZWwpKSB7XG4gICAgICB0aGlzLl9zeXN0ZW0uYXBwLnNjZW5lLnJlbW92ZU1vZGVsKHRoaXMuX21vZGVsKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHRFbGVtZW50LnByb3RvdHlwZSwgXCJ0ZXh0XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RleHQ7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHZhciBzdHIgPSB2YWx1ZS50b1N0cmluZygpO1xuICAgIGlmICh0aGlzLl9mb250KSB7XG4gICAgICB0aGlzLl91cGRhdGVUZXh0KHN0cik7XG4gICAgfVxuICAgIHRoaXMuX3RleHQgPSBzdHI7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHRFbGVtZW50LnByb3RvdHlwZSwgXCJjb2xvclwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9jb2xvcjtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fY29sb3IuZGF0YVswXSA9IHZhbHVlLmRhdGFbMF07XG4gICAgdGhpcy5fY29sb3IuZGF0YVsxXSA9IHZhbHVlLmRhdGFbMV07XG4gICAgdGhpcy5fY29sb3IuZGF0YVsyXSA9IHZhbHVlLmRhdGFbMl07XG4gICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlcy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgdmFyIG1pID0gdGhpcy5fbW9kZWwubWVzaEluc3RhbmNlc1tpXTtcbiAgICAgICAgbWkuc2V0UGFyYW1ldGVyKFwibWF0ZXJpYWxfZW1pc3NpdmVcIiwgdGhpcy5fY29sb3IuZGF0YTMpO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dEVsZW1lbnQucHJvdG90eXBlLCBcIm9wYWNpdHlcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fY29sb3IuZGF0YVszXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fY29sb3IuZGF0YVszXSA9IHZhbHVlO1xuICAgIGlmICh0aGlzLl9tb2RlbCkge1xuICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX21vZGVsLm1lc2hJbnN0YW5jZXMubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIHZhciBtaSA9IHRoaXMuX21vZGVsLm1lc2hJbnN0YW5jZXNbaV07XG4gICAgICAgIG1pLnNldFBhcmFtZXRlcihcIm1hdGVyaWFsX29wYWNpdHlcIiwgdmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dEVsZW1lbnQucHJvdG90eXBlLCBcImxpbmVIZWlnaHRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fbGluZUhlaWdodDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIF9wcmV2ID0gdGhpcy5fbGluZUhlaWdodDtcbiAgICB0aGlzLl9saW5lSGVpZ2h0ID0gdmFsdWU7XG4gICAgaWYgKF9wcmV2ICE9PSB2YWx1ZSAmJiB0aGlzLl9mb250KSB7XG4gICAgICB0aGlzLl91cGRhdGVUZXh0KCk7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0RWxlbWVudC5wcm90b3R5cGUsIFwic3BhY2luZ1wiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zcGFjaW5nO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgX3ByZXYgPSB0aGlzLl9zcGFjaW5nO1xuICAgIHRoaXMuX3NwYWNpbmcgPSB2YWx1ZTtcbiAgICBpZiAoX3ByZXYgIT09IHZhbHVlICYmIHRoaXMuX2ZvbnQpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVRleHQoKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHRFbGVtZW50LnByb3RvdHlwZSwgXCJmb250U2l6ZVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9mb250U2l6ZTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIF9wcmV2ID0gdGhpcy5fZm9udFNpemU7XG4gICAgdGhpcy5fZm9udFNpemUgPSB2YWx1ZTtcbiAgICBpZiAoX3ByZXYgIT09IHZhbHVlICYmIHRoaXMuX2ZvbnQpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVRleHQoKTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHRFbGVtZW50LnByb3RvdHlwZSwgXCJmb250QXNzZXRcIiwge2dldCBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fZm9udEFzc2V0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgYXNzZXRzID0gdGhpcy5fc3lzdGVtLmFwcC5hc3NldHM7XG4gICAgdmFyIF9pZCA9IHZhbHVlO1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIHBjLkFzc2V0KSB7XG4gICAgICBfaWQgPSB2YWx1ZS5pZDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2ZvbnRBc3NldCAhPT0gX2lkKSB7XG4gICAgICBpZiAodGhpcy5fZm9udEFzc2V0KSB7XG4gICAgICAgIHZhciBfcHJldiA9IGFzc2V0cy5nZXQodGhpcy5fZm9udEFzc2V0KTtcbiAgICAgICAgaWYgKF9wcmV2KSB7XG4gICAgICAgICAgX3ByZXYub2ZmKFwibG9hZFwiLCB0aGlzLl9vbkZvbnRMb2FkLCB0aGlzKTtcbiAgICAgICAgICBfcHJldi5vZmYoXCJjaGFuZ2VcIiwgdGhpcy5fb25Gb250Q2hhbmdlLCB0aGlzKTtcbiAgICAgICAgICBfcHJldi5vZmYoXCJyZW1vdmVcIiwgdGhpcy5fb25Gb250UmVtb3ZlLCB0aGlzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5fZm9udEFzc2V0ID0gX2lkO1xuICAgICAgaWYgKHRoaXMuX2ZvbnRBc3NldCkge1xuICAgICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KHRoaXMuX2ZvbnRBc3NldCk7XG4gICAgICAgIGlmICghYXNzZXQpIHtcbiAgICAgICAgICBhc3NldHMub24oXCJhZGQ6XCIgKyB0aGlzLl9mb250QXNzZXQsIHRoaXMuX29uRm9udEFkZGVkLCB0aGlzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9iaW5kRm9udChhc3NldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFRleHRFbGVtZW50LnByb3RvdHlwZSwgXCJmb250XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZvbnQ7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2ZvbnQgPSB2YWx1ZTtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9mb250LnRleHR1cmVzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKCF0aGlzLl9tZXNoSW5mb1tpXSkge1xuICAgICAgICB0aGlzLl9tZXNoSW5mb1tpXSA9IHtjb3VudDowLCBxdWFkOjAsIGxpbmVzOnt9LCBwb3NpdGlvbnM6W10sIG5vcm1hbHM6W10sIHV2czpbXSwgaW5kaWNlczpbXSwgbWVzaEluc3RhbmNlOm51bGx9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIG1pID0gdGhpcy5fbWVzaEluZm9baV0ubWVzaEluc3RhbmNlO1xuICAgICAgICBpZiAobWkpIHtcbiAgICAgICAgICBtaS5zZXRQYXJhbWV0ZXIoXCJmb250X3NkZkludGVuc2l0eVwiLCB0aGlzLl9mb250LmludGVuc2l0eSk7XG4gICAgICAgICAgbWkuc2V0UGFyYW1ldGVyKFwiZm9udF9weHJhbmdlXCIsIHRoaXMuX2dldFB4UmFuZ2UodGhpcy5fZm9udCkpO1xuICAgICAgICAgIG1pLnNldFBhcmFtZXRlcihcImZvbnRfdGV4dHVyZVdpZHRoXCIsIHRoaXMuX2ZvbnQuZGF0YS5pbmZvLm1hcHNbaV0ud2lkdGgpO1xuICAgICAgICAgIG1pLnNldFBhcmFtZXRlcihcInRleHR1cmVfbXNkZk1hcFwiLCB0aGlzLl9mb250LnRleHR1cmVzW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmVtb3ZlZE1vZGVsID0gZmFsc2U7XG4gICAgZm9yICh2YXIgaSA9IHRoaXMuX2ZvbnQudGV4dHVyZXMubGVuZ3RoO2kgPCB0aGlzLl9tZXNoSW5mby5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAodGhpcy5fbWVzaEluZm9baV0ubWVzaEluc3RhbmNlKSB7XG4gICAgICAgIGlmICghcmVtb3ZlZE1vZGVsKSB7XG4gICAgICAgICAgdGhpcy5fc3lzdGVtLmFwcC5zY2VuZS5yZW1vdmVNb2RlbCh0aGlzLl9tb2RlbCk7XG4gICAgICAgICAgcmVtb3ZlZE1vZGVsID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZW1vdmVNZXNoSW5zdGFuY2UodGhpcy5fbWVzaEluZm9baV0ubWVzaEluc3RhbmNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuX21lc2hJbmZvLmxlbmd0aCA+IHRoaXMuX2ZvbnQudGV4dHVyZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLl9tZXNoSW5mby5sZW5ndGggPSB0aGlzLl9mb250LnRleHR1cmVzLmxlbmd0aDtcbiAgICB9XG4gICAgdGhpcy5fdXBkYXRlVGV4dCgpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0RWxlbWVudC5wcm90b3R5cGUsIFwiYWxpZ25tZW50XCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FsaWdubWVudDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgcGMuVmVjMikge1xuICAgICAgdGhpcy5fYWxpZ25tZW50LnNldCh2YWx1ZS54LCB2YWx1ZS55KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fYWxpZ25tZW50LnNldCh2YWx1ZVswXSwgdmFsdWVbMV0pO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZm9udCkge1xuICAgICAgdGhpcy5fdXBkYXRlVGV4dCgpO1xuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGV4dEVsZW1lbnQucHJvdG90eXBlLCBcImF1dG9XaWR0aFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9hdXRvV2lkdGg7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuX2F1dG9XaWR0aCA9IHZhbHVlO1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdGhpcy5fZWxlbWVudC53aWR0aCA9IHRoaXMud2lkdGg7XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZXh0RWxlbWVudC5wcm90b3R5cGUsIFwiYXV0b0hlaWdodFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9hdXRvSGVpZ2h0O1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB0aGlzLl9hdXRvSGVpZ2h0ID0gdmFsdWU7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLl9lbGVtZW50LmhlaWdodCA9IHRoaXMuaGVpZ2h0O1xuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge1RleHRFbGVtZW50OlRleHRFbGVtZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICBwYy5GT05UX01TREYgPSBcIm1zZGZcIjtcbiAgdmFyIEZvbnQgPSBmdW5jdGlvbih0ZXh0dXJlcywgZGF0YSkge1xuICAgIHRoaXMudHlwZSA9IHBjLkZPTlRfTVNERjtcbiAgICB0aGlzLmVtID0gMTtcbiAgICB0aGlzLnRleHR1cmVzID0gdGV4dHVyZXM7XG4gICAgdGhpcy5pbnRlbnNpdHkgPSAwLjA7XG4gICAgdGhpcy5fZGF0YSA9IG51bGw7XG4gICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgfTtcbiAgRm9udC5wcm90b3R5cGUgPSB7fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZvbnQucHJvdG90eXBlLCBcImRhdGFcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5fZGF0YSA9IHZhbHVlO1xuICAgIGlmICghdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2RhdGEuaW50ZW5zaXR5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuaW50ZW5zaXR5ID0gdGhpcy5fZGF0YS5pbnRlbnNpdHk7XG4gICAgfVxuICAgIGlmICghdGhpcy5fZGF0YS5pbmZvKSB7XG4gICAgICB0aGlzLl9kYXRhLmluZm8gPSB7fTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9kYXRhLnZlcnNpb24gfHwgdGhpcy5fZGF0YS52ZXJzaW9uIDwgMikge1xuICAgICAgdGhpcy5fZGF0YS5pbmZvLm1hcHMgPSBbe3dpZHRoOnRoaXMuX2RhdGEuaW5mby53aWR0aCwgaGVpZ2h0OnRoaXMuX2RhdGEuaW5mby5oZWlnaHR9XTtcbiAgICAgIGlmICh0aGlzLl9kYXRhLmNoYXJzKSB7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9kYXRhLmNoYXJzKSB7XG4gICAgICAgICAgdGhpcy5fZGF0YS5jaGFyc1trZXldLm1hcCA9IDA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH19KTtcbiAgcmV0dXJuIHtGT05UX01TREY6cGMuRk9OVF9NU0RGLCBGb250OkZvbnR9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBab25lQ29tcG9uZW50ID0gZnVuY3Rpb24gWm9uZUNvbXBvbmVudChzeXN0ZW0sIGVudGl0eSkge1xuICAgIHRoaXMuX29sZFN0YXRlID0gdHJ1ZTtcbiAgICB0aGlzLl9zaXplID0gbmV3IHBjLlZlYzM7XG4gICAgdGhpcy5vbihcInNldF9lbmFibGVkXCIsIHRoaXMuX29uU2V0RW5hYmxlZCwgdGhpcyk7XG4gIH07XG4gIFpvbmVDb21wb25lbnQgPSBwYy5pbmhlcml0cyhab25lQ29tcG9uZW50LCBwYy5Db21wb25lbnQpO1xuICBwYy5leHRlbmQoWm9uZUNvbXBvbmVudC5wcm90b3R5cGUsIHtvbkVuYWJsZTpmdW5jdGlvbigpIHtcbiAgICBab25lQ29tcG9uZW50Ll9zdXBlci5vbkVuYWJsZS5jYWxsKHRoaXMpO1xuICAgIHRoaXMuX2NoZWNrU3RhdGUoKTtcbiAgfSwgb25EaXNhYmxlOmZ1bmN0aW9uKCkge1xuICAgIFpvbmVDb21wb25lbnQuX3N1cGVyLm9uRGlzYWJsZS5jYWxsKHRoaXMpO1xuICAgIHRoaXMuX2NoZWNrU3RhdGUoKTtcbiAgfSwgX29uU2V0RW5hYmxlZDpmdW5jdGlvbihwcm9wLCBvbGQsIHZhbHVlKSB7XG4gICAgdGhpcy5fY2hlY2tTdGF0ZSgpO1xuICB9LCBfY2hlY2tTdGF0ZTpmdW5jdGlvbigpIHtcbiAgICB2YXIgc3RhdGUgPSB0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZDtcbiAgICBpZiAoc3RhdGUgPT09IHRoaXMuX29sZFN0YXRlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX29sZFN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5maXJlKFwiZW5hYmxlXCIpO1xuICAgIHRoaXMuZmlyZShcInN0YXRlXCIsIHRoaXMuZW5hYmxlZCk7XG4gIH0sIF9vbkJlZm9yZVJlbW92ZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLmZpcmUoXCJyZW1vdmVcIik7XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFpvbmVDb21wb25lbnQucHJvdG90eXBlLCBcInNpemVcIiwge3NldDpmdW5jdGlvbihkYXRhKSB7XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICB0aGlzLl9zaXplLmNvcHkoZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkgJiYgZGF0YS5sZW5ndGggPj0gMykge1xuICAgICAgICB0aGlzLnNpemUuc2V0KGRhdGFbMF0sIGRhdGFbMV0sIGRhdGFbMl0pO1xuICAgICAgfVxuICAgIH1cbiAgfSwgZ2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9zaXplO1xuICB9fSk7XG4gIHJldHVybiB7Wm9uZUNvbXBvbmVudDpab25lQ29tcG9uZW50fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgX3NjaGVtYSA9IFtcImVuYWJsZWRcIl07XG4gIHZhciBab25lQ29tcG9uZW50U3lzdGVtID0gZnVuY3Rpb24gWm9uZUNvbXBvbmVudFN5c3RlbShhcHApIHtcbiAgICB0aGlzLmlkID0gXCJ6b25lXCI7XG4gICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgYXBwLnN5c3RlbXMuYWRkKHRoaXMuaWQsIHRoaXMpO1xuICAgIHRoaXMuQ29tcG9uZW50VHlwZSA9IHBjLlpvbmVDb21wb25lbnQ7XG4gICAgdGhpcy5EYXRhVHlwZSA9IHBjLlpvbmVDb21wb25lbnREYXRhO1xuICAgIHRoaXMuc2NoZW1hID0gX3NjaGVtYTtcbiAgICB0aGlzLm9uKFwiYmVmb3JlcmVtb3ZlXCIsIHRoaXMuX29uQmVmb3JlUmVtb3ZlLCB0aGlzKTtcbiAgfTtcbiAgWm9uZUNvbXBvbmVudFN5c3RlbSA9IHBjLmluaGVyaXRzKFpvbmVDb21wb25lbnRTeXN0ZW0sIHBjLkNvbXBvbmVudFN5c3RlbSk7XG4gIHBjLkNvbXBvbmVudC5fYnVpbGRBY2Nlc3NvcnMocGMuWm9uZUNvbXBvbmVudC5wcm90b3R5cGUsIF9zY2hlbWEpO1xuICBwYy5leHRlbmQoWm9uZUNvbXBvbmVudFN5c3RlbS5wcm90b3R5cGUsIHtpbml0aWFsaXplQ29tcG9uZW50RGF0YTpmdW5jdGlvbihjb21wb25lbnQsIGRhdGEsIHByb3BlcnRpZXMpIHtcbiAgICBjb21wb25lbnQuZW5hYmxlZCA9IGRhdGEuaGFzT3duUHJvcGVydHkoXCJlbmFibGVkXCIpID8gISFkYXRhLmVuYWJsZWQgOiB0cnVlO1xuICAgIGlmIChkYXRhLnNpemUpIHtcbiAgICAgIGlmIChkYXRhLnNpemUgaW5zdGFuY2VvZiBwYy5WZWMzKSB7XG4gICAgICAgIGNvbXBvbmVudC5zaXplLmNvcHkoZGF0YS5zaXplKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChkYXRhLnNpemUgaW5zdGFuY2VvZiBBcnJheSAmJiBkYXRhLnNpemUubGVuZ3RoID49IDMpIHtcbiAgICAgICAgICBjb21wb25lbnQuc2l6ZS5zZXQoZGF0YS5zaXplWzBdLCBkYXRhLnNpemVbMV0sIGRhdGEuc2l6ZVsyXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIGNsb25lQ29tcG9uZW50OmZ1bmN0aW9uKGVudGl0eSwgY2xvbmUpIHtcbiAgICB2YXIgZGF0YSA9IHtzaXplOmVudGl0eS56b25lLnNpemV9O1xuICAgIHJldHVybiB0aGlzLmFkZENvbXBvbmVudChjbG9uZSwgZGF0YSk7XG4gIH0sIF9vbkJlZm9yZVJlbW92ZTpmdW5jdGlvbihlbnRpdHksIGNvbXBvbmVudCkge1xuICAgIGNvbXBvbmVudC5fb25CZWZvcmVSZW1vdmUoKTtcbiAgfX0pO1xuICByZXR1cm4ge1pvbmVDb21wb25lbnRTeXN0ZW06Wm9uZUNvbXBvbmVudFN5c3RlbX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFpvbmVDb21wb25lbnREYXRhID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcbiAgfTtcbiAgWm9uZUNvbXBvbmVudERhdGEgPSBwYy5pbmhlcml0cyhab25lQ29tcG9uZW50RGF0YSwgcGMuQ29tcG9uZW50RGF0YSk7XG4gIHJldHVybiB7Wm9uZUNvbXBvbmVudERhdGE6Wm9uZUNvbXBvbmVudERhdGF9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBFbnRpdHkgPSBmdW5jdGlvbihuYW1lLCBhcHApIHtcbiAgICBpZiAobmFtZSBpbnN0YW5jZW9mIHBjLkFwcGxpY2F0aW9uKSB7XG4gICAgICBhcHAgPSBuYW1lO1xuICAgIH1cbiAgICB0aGlzLl9ndWlkID0gcGMuZ3VpZC5jcmVhdGUoKTtcbiAgICB0aGlzLl9iYXRjaEhhbmRsZSA9IG51bGw7XG4gICAgdGhpcy5jID0ge307XG4gICAgdGhpcy5fYXBwID0gYXBwO1xuICAgIGlmICghYXBwKSB7XG4gICAgICB0aGlzLl9hcHAgPSBwYy5BcHBsaWNhdGlvbi5nZXRBcHBsaWNhdGlvbigpO1xuICAgICAgaWYgKCF0aGlzLl9hcHApIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkNvdWxkbid0IGZpbmQgY3VycmVudCBhcHBsaWNhdGlvblwiKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgfTtcbiAgRW50aXR5ID0gcGMuaW5oZXJpdHMoRW50aXR5LCBwYy5HcmFwaE5vZGUpO1xuICBFbnRpdHkucHJvdG90eXBlLmFkZENvbXBvbmVudCA9IGZ1bmN0aW9uKHR5cGUsIGRhdGEpIHtcbiAgICB2YXIgc3lzdGVtID0gdGhpcy5fYXBwLnN5c3RlbXNbdHlwZV07XG4gICAgaWYgKHN5c3RlbSkge1xuICAgICAgaWYgKCF0aGlzLmNbdHlwZV0pIHtcbiAgICAgICAgcmV0dXJuIHN5c3RlbS5hZGRDb21wb25lbnQodGhpcywgZGF0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dFUlJPUihwYy5zdHJpbmcuZm9ybWF0KFwiRW50aXR5IGFscmVhZHkgaGFzIHswfSBDb21wb25lbnRcIiwgdHlwZSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsb2dFUlJPUihwYy5zdHJpbmcuZm9ybWF0KFwiU3lzdGVtOiAnezB9JyBkb2Vzbid0IGV4aXN0XCIsIHR5cGUpKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfTtcbiAgRW50aXR5LnByb3RvdHlwZS5yZW1vdmVDb21wb25lbnQgPSBmdW5jdGlvbih0eXBlKSB7XG4gICAgdmFyIHN5c3RlbSA9IHRoaXMuX2FwcC5zeXN0ZW1zW3R5cGVdO1xuICAgIGlmIChzeXN0ZW0pIHtcbiAgICAgIGlmICh0aGlzLmNbdHlwZV0pIHtcbiAgICAgICAgc3lzdGVtLnJlbW92ZUNvbXBvbmVudCh0aGlzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ0VSUk9SKHBjLnN0cmluZy5mb3JtYXQoXCJFbnRpdHkgZG9lc24ndCBoYXZlIHswfSBDb21wb25lbnRcIiwgdHlwZSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsb2dFUlJPUihwYy5zdHJpbmcuZm9ybWF0KFwiU3lzdGVtOiAnezB9JyBkb2Vzbid0IGV4aXN0XCIsIHR5cGUpKTtcbiAgICB9XG4gIH07XG4gIEVudGl0eS5wcm90b3R5cGUuZ2V0R3VpZCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9ndWlkO1xuICB9O1xuICBFbnRpdHkucHJvdG90eXBlLnNldEd1aWQgPSBmdW5jdGlvbihndWlkKSB7XG4gICAgdGhpcy5fZ3VpZCA9IGd1aWQ7XG4gIH07XG4gIEVudGl0eS5wcm90b3R5cGUuX25vdGlmeUhpZXJhcmNoeVN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uKG5vZGUsIGVuYWJsZWQpIHtcbiAgICB2YXIgZW5hYmxlRmlyc3QgPSBmYWxzZTtcbiAgICBpZiAobm9kZSA9PT0gdGhpcyAmJiB0aGlzLl9hcHAuX2VuYWJsZUxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICBlbmFibGVGaXJzdCA9IHRydWU7XG4gICAgfVxuICAgIG5vZGUuX29uSGllcmFyY2h5U3RhdGVDaGFuZ2VkKGVuYWJsZWQpO1xuICAgIGlmIChub2RlLl9vbkhpZXJhcmNoeVN0YXRlUG9zdENoYW5nZWQpIHtcbiAgICAgIHRoaXMuX2FwcC5fZW5hYmxlTGlzdC5wdXNoKG5vZGUpO1xuICAgIH1cbiAgICB2YXIgaSwgbGVuO1xuICAgIHZhciBjID0gbm9kZS5fY2hpbGRyZW47XG4gICAgZm9yIChpID0gMCwgbGVuID0gYy5sZW5ndGg7aSA8IGxlbjtpKyspIHtcbiAgICAgIGlmIChjW2ldLl9lbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX25vdGlmeUhpZXJhcmNoeVN0YXRlQ2hhbmdlZChjW2ldLCBlbmFibGVkKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGVuYWJsZUZpcnN0KSB7XG4gICAgICBmb3IgKGkgPSAwLCBsZW4gPSB0aGlzLl9hcHAuX2VuYWJsZUxpc3QubGVuZ3RoO2kgPCBsZW47aSsrKSB7XG4gICAgICAgIHRoaXMuX2FwcC5fZW5hYmxlTGlzdFtpXS5fb25IaWVyYXJjaHlTdGF0ZVBvc3RDaGFuZ2VkKCk7XG4gICAgICB9XG4gICAgICB0aGlzLl9hcHAuX2VuYWJsZUxpc3QubGVuZ3RoID0gMDtcbiAgICB9XG4gIH07XG4gIEVudGl0eS5wcm90b3R5cGUuX29uSGllcmFyY2h5U3RhdGVDaGFuZ2VkID0gZnVuY3Rpb24oZW5hYmxlZCkge1xuICAgIHBjLkVudGl0eS5fc3VwZXIuX29uSGllcmFyY2h5U3RhdGVDaGFuZ2VkLmNhbGwodGhpcywgZW5hYmxlZCk7XG4gICAgdmFyIGNvbXBvbmVudDtcbiAgICB2YXIgY29tcG9uZW50cyA9IHRoaXMuYztcbiAgICBmb3IgKHZhciB0eXBlIGluIGNvbXBvbmVudHMpIHtcbiAgICAgIGlmIChjb21wb25lbnRzLmhhc093blByb3BlcnR5KHR5cGUpKSB7XG4gICAgICAgIGNvbXBvbmVudCA9IGNvbXBvbmVudHNbdHlwZV07XG4gICAgICAgIGlmIChjb21wb25lbnQuZW5hYmxlZCkge1xuICAgICAgICAgIGlmIChlbmFibGVkKSB7XG4gICAgICAgICAgICBjb21wb25lbnQub25FbmFibGUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29tcG9uZW50Lm9uRGlzYWJsZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgRW50aXR5LnByb3RvdHlwZS5fb25IaWVyYXJjaHlTdGF0ZVBvc3RDaGFuZ2VkID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGNvbXBvbmVudHMgPSB0aGlzLmM7XG4gICAgZm9yICh2YXIgdHlwZSBpbiBjb21wb25lbnRzKSB7XG4gICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkge1xuICAgICAgICBjb21wb25lbnRzW3R5cGVdLm9uUG9zdFN0YXRlQ2hhbmdlKCk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBFbnRpdHkucHJvdG90eXBlLnNldFJlcXVlc3QgPSBmdW5jdGlvbihyZXF1ZXN0KSB7XG4gICAgdGhpcy5fcmVxdWVzdCA9IHJlcXVlc3Q7XG4gIH07XG4gIEVudGl0eS5wcm90b3R5cGUuZ2V0UmVxdWVzdCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0O1xuICB9O1xuICBFbnRpdHkucHJvdG90eXBlLmZpbmRCeUd1aWQgPSBmdW5jdGlvbihndWlkKSB7XG4gICAgaWYgKHRoaXMuX2d1aWQgPT09IGd1aWQpIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5fY2hpbGRyZW4ubGVuZ3RoO2krKykge1xuICAgICAgaWYgKHRoaXMuX2NoaWxkcmVuW2ldLmZpbmRCeUd1aWQpIHtcbiAgICAgICAgdmFyIGZvdW5kID0gdGhpcy5fY2hpbGRyZW5baV0uZmluZEJ5R3VpZChndWlkKTtcbiAgICAgICAgaWYgKGZvdW5kICE9PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuIGZvdW5kO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9O1xuICBFbnRpdHkucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY2hpbGRHdWlkcztcbiAgICB2YXIgbmFtZTtcbiAgICBmb3IgKG5hbWUgaW4gdGhpcy5jKSB7XG4gICAgICB0aGlzLmNbbmFtZV0uZW5hYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKG5hbWUgaW4gdGhpcy5jKSB7XG4gICAgICB0aGlzLmNbbmFtZV0uc3lzdGVtLnJlbW92ZUNvbXBvbmVudCh0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3BhcmVudCkge1xuICAgICAgdGhpcy5fcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMpO1xuICAgIH1cbiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLl9jaGlsZHJlbjtcbiAgICB2YXIgbGVuZ3RoID0gY2hpbGRyZW4ubGVuZ3RoO1xuICAgIHZhciBjaGlsZCA9IGNoaWxkcmVuLnNoaWZ0KCk7XG4gICAgd2hpbGUgKGNoaWxkKSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBwYy5FbnRpdHkpIHtcbiAgICAgICAgY2hpbGQuZGVzdHJveSgpO1xuICAgICAgfVxuICAgICAgY2hpbGQuX3BhcmVudCA9IG51bGw7XG4gICAgICBjaGlsZCA9IGNoaWxkcmVuLnNoaWZ0KCk7XG4gICAgfVxuICAgIHRoaXMuZmlyZShcImRlc3Ryb3lcIiwgdGhpcyk7XG4gICAgaWYgKHRoaXMuX2NhbGxiYWNrcykge1xuICAgICAgdGhpcy5fY2FsbGJhY2tzID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2NhbGxiYWNrQWN0aXZlKSB7XG4gICAgICB0aGlzLl9jYWxsYmFja0FjdGl2ZSA9IG51bGw7XG4gICAgfVxuICB9O1xuICBFbnRpdHkucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHR5cGU7XG4gICAgdmFyIGMgPSBuZXcgcGMuRW50aXR5KHRoaXMuX2FwcCk7XG4gICAgcGMuRW50aXR5Ll9zdXBlci5fY2xvbmVJbnRlcm5hbC5jYWxsKHRoaXMsIGMpO1xuICAgIGZvciAodHlwZSBpbiB0aGlzLmMpIHtcbiAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNbdHlwZV07XG4gICAgICBjb21wb25lbnQuc3lzdGVtLmNsb25lQ29tcG9uZW50KHRoaXMsIGMpO1xuICAgIH1cbiAgICB2YXIgaTtcbiAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl9jaGlsZHJlbi5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgY2hpbGQgPSB0aGlzLl9jaGlsZHJlbltpXTtcbiAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIHBjLkVudGl0eSkge1xuICAgICAgICBjLmFkZENoaWxkKGNoaWxkLmNsb25lKCkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYztcbiAgfTtcbiAgcmV0dXJuIHtFbnRpdHk6RW50aXR5fTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgUmVzb3VyY2VMb2FkZXIgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9oYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuX3JlcXVlc3RzID0ge307XG4gICAgdGhpcy5fY2FjaGUgPSB7fTtcbiAgfTtcbiAgUmVzb3VyY2VMb2FkZXIucHJvdG90eXBlID0ge2FkZEhhbmRsZXI6ZnVuY3Rpb24odHlwZSwgaGFuZGxlcikge1xuICAgIHRoaXMuX2hhbmRsZXJzW3R5cGVdID0gaGFuZGxlcjtcbiAgICBoYW5kbGVyLl9sb2FkZXIgPSB0aGlzO1xuICB9LCByZW1vdmVIYW5kbGVyOmZ1bmN0aW9uKHR5cGUpIHtcbiAgICBkZWxldGUgdGhpcy5faGFuZGxlcnNbdHlwZV07XG4gIH0sIGdldEhhbmRsZXI6ZnVuY3Rpb24odHlwZSkge1xuICAgIHJldHVybiB0aGlzLl9oYW5kbGVyc1t0eXBlXTtcbiAgfSwgbG9hZDpmdW5jdGlvbih1cmwsIHR5cGUsIGNhbGxiYWNrLCBhc3NldCkge1xuICAgIHZhciBoYW5kbGVyID0gdGhpcy5faGFuZGxlcnNbdHlwZV07XG4gICAgaWYgKCFoYW5kbGVyKSB7XG4gICAgICB2YXIgZXJyID0gXCJObyBoYW5kbGVyIGZvciBhc3NldCB0eXBlOiBcIiArIHR5cGU7XG4gICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIga2V5ID0gdXJsICsgdHlwZTtcbiAgICBpZiAodGhpcy5fY2FjaGVba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjYWxsYmFjayhudWxsLCB0aGlzLl9jYWNoZVtrZXldKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX3JlcXVlc3RzW2tleV0pIHtcbiAgICAgICAgdGhpcy5fcmVxdWVzdHNba2V5XS5wdXNoKGNhbGxiYWNrKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3JlcXVlc3RzW2tleV0gPSBbY2FsbGJhY2tdO1xuICAgICAgICBoYW5kbGVyLmxvYWQodXJsLCBmdW5jdGlvbihlcnIsIGRhdGEsIGV4dHJhKSB7XG4gICAgICAgICAgaWYgKCF0aGlzLl9yZXF1ZXN0c1trZXldKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciBpLCBsZW4gPSB0aGlzLl9yZXF1ZXN0c1trZXldLmxlbmd0aDtcbiAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgdmFyIHJlc291cmNlID0gaGFuZGxlci5vcGVuKHVybCwgZGF0YSwgYXNzZXQpO1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVba2V5XSA9IHJlc291cmNlO1xuICAgICAgICAgICAgZm9yIChpID0gMDtpIDwgbGVuO2krKykge1xuICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1trZXldW2ldKG51bGwsIHJlc291cmNlLCBleHRyYSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IGxlbjtpKyspIHtcbiAgICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHNba2V5XVtpXShlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBkZWxldGUgdGhpcy5fcmVxdWVzdHNba2V5XTtcbiAgICAgICAgfS5iaW5kKHRoaXMpLCBhc3NldCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBvcGVuOmZ1bmN0aW9uKHR5cGUsIGRhdGEpIHtcbiAgICB2YXIgaGFuZGxlciA9IHRoaXMuX2hhbmRsZXJzW3R5cGVdO1xuICAgIGlmICghaGFuZGxlcikge1xuICAgICAgY29uc29sZS53YXJuKFwiTm8gcmVzb3VyY2UgaGFuZGxlciBmb3VuZCBmb3I6IFwiICsgdHlwZSk7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIub3BlbihudWxsLCBkYXRhKTtcbiAgfSwgcGF0Y2g6ZnVuY3Rpb24oYXNzZXQsIGFzc2V0cykge1xuICAgIHZhciBoYW5kbGVyID0gdGhpcy5faGFuZGxlcnNbYXNzZXQudHlwZV07XG4gICAgaWYgKCFoYW5kbGVyKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJObyByZXNvdXJjZSBoYW5kbGVyIGZvdW5kIGZvcjogXCIgKyBhc3NldC50eXBlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGhhbmRsZXIucGF0Y2gpIHtcbiAgICAgIGhhbmRsZXIucGF0Y2goYXNzZXQsIGFzc2V0cyk7XG4gICAgfVxuICB9LCBjbGVhckNhY2hlOmZ1bmN0aW9uKHVybCwgdHlwZSkge1xuICAgIGRlbGV0ZSB0aGlzLl9jYWNoZVt1cmwgKyB0eXBlXTtcbiAgfSwgZ2V0RnJvbUNhY2hlOmZ1bmN0aW9uKHVybCwgdHlwZSkge1xuICAgIGlmICh0aGlzLl9jYWNoZVt1cmwgKyB0eXBlXSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlW3VybCArIHR5cGVdO1xuICAgIH1cbiAgfSwgZGVzdHJveTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9oYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuX3JlcXVlc3RzID0ge307XG4gICAgdGhpcy5fY2FjaGUgPSB7fTtcbiAgfX07XG4gIHJldHVybiB7UmVzb3VyY2VMb2FkZXI6UmVzb3VyY2VMb2FkZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBBbmltYXRpb25IYW5kbGVyID0gZnVuY3Rpb24oKSB7XG4gIH07XG4gIEFuaW1hdGlvbkhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICAgIHBjLmh0dHAuZ2V0KHVybCwgZnVuY3Rpb24oZXJyLCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBhbmltYXRpb24gcmVzb3VyY2U6IHswfSBbezF9XVwiLCB1cmwsIGVycikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UpO1xuICAgICAgfVxuICAgIH0uYmluZCh0aGlzKSk7XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgcmV0dXJuIHRoaXNbXCJfcGFyc2VBbmltYXRpb25WXCIgKyBkYXRhLmFuaW1hdGlvbi52ZXJzaW9uXShkYXRhKTtcbiAgfSwgX3BhcnNlQW5pbWF0aW9uVjM6ZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBhbmltRGF0YSA9IGRhdGEuYW5pbWF0aW9uO1xuICAgIHZhciBhbmltID0gbmV3IHBjLkFuaW1hdGlvbjtcbiAgICBhbmltLnNldE5hbWUoYW5pbURhdGEubmFtZSk7XG4gICAgYW5pbS5kdXJhdGlvbiA9IGFuaW1EYXRhLmR1cmF0aW9uO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBhbmltRGF0YS5ub2Rlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgbm9kZSA9IG5ldyBwYy5Ob2RlO1xuICAgICAgdmFyIG4gPSBhbmltRGF0YS5ub2Rlc1tpXTtcbiAgICAgIG5vZGUuX25hbWUgPSBuLm5hbWU7XG4gICAgICBmb3IgKHZhciBqID0gMDtqIDwgbi5rZXlzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgdmFyIGsgPSBuLmtleXNbal07XG4gICAgICAgIHZhciB0ID0gay50aW1lO1xuICAgICAgICB2YXIgcCA9IGsucG9zO1xuICAgICAgICB2YXIgciA9IGsucm90O1xuICAgICAgICB2YXIgcyA9IGsuc2NhbGU7XG4gICAgICAgIHZhciBwb3MgPSBuZXcgcGMuVmVjMyhwWzBdLCBwWzFdLCBwWzJdKTtcbiAgICAgICAgdmFyIHJvdCA9IChuZXcgcGMuUXVhdCkuc2V0RnJvbUV1bGVyQW5nbGVzKHJbMF0sIHJbMV0sIHJbMl0pO1xuICAgICAgICB2YXIgc2NsID0gbmV3IHBjLlZlYzMoc1swXSwgc1sxXSwgc1syXSk7XG4gICAgICAgIHZhciBrZXkgPSBuZXcgcGMuS2V5KHQsIHBvcywgcm90LCBzY2wpO1xuICAgICAgICBub2RlLl9rZXlzLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICAgIGFuaW0uYWRkTm9kZShub2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIGFuaW07XG4gIH0sIF9wYXJzZUFuaW1hdGlvblY0OmZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgYW5pbURhdGEgPSBkYXRhLmFuaW1hdGlvbjtcbiAgICB2YXIgYW5pbSA9IG5ldyBwYy5BbmltYXRpb247XG4gICAgYW5pbS5zZXROYW1lKGFuaW1EYXRhLm5hbWUpO1xuICAgIGFuaW0uZHVyYXRpb24gPSBhbmltRGF0YS5kdXJhdGlvbjtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgYW5pbURhdGEubm9kZXMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIG5vZGUgPSBuZXcgcGMuTm9kZTtcbiAgICAgIHZhciBuID0gYW5pbURhdGEubm9kZXNbaV07XG4gICAgICBub2RlLl9uYW1lID0gbi5uYW1lO1xuICAgICAgdmFyIGRlZlBvcyA9IG4uZGVmYXVsdHMucDtcbiAgICAgIHZhciBkZWZSb3QgPSBuLmRlZmF1bHRzLnI7XG4gICAgICB2YXIgZGVmU2NsID0gbi5kZWZhdWx0cy5zO1xuICAgICAgZm9yICh2YXIgaiA9IDA7aiA8IG4ua2V5cy5sZW5ndGg7aisrKSB7XG4gICAgICAgIHZhciBrID0gbi5rZXlzW2pdO1xuICAgICAgICB2YXIgdCA9IGsudDtcbiAgICAgICAgdmFyIHAgPSBkZWZQb3MgPyBkZWZQb3MgOiBrLnA7XG4gICAgICAgIHZhciByID0gZGVmUm90ID8gZGVmUm90IDogay5yO1xuICAgICAgICB2YXIgcyA9IGRlZlNjbCA/IGRlZlNjbCA6IGsucztcbiAgICAgICAgdmFyIHBvcyA9IG5ldyBwYy5WZWMzKHBbMF0sIHBbMV0sIHBbMl0pO1xuICAgICAgICB2YXIgcm90ID0gKG5ldyBwYy5RdWF0KS5zZXRGcm9tRXVsZXJBbmdsZXMoclswXSwgclsxXSwgclsyXSk7XG4gICAgICAgIHZhciBzY2wgPSBuZXcgcGMuVmVjMyhzWzBdLCBzWzFdLCBzWzJdKTtcbiAgICAgICAgdmFyIGtleSA9IG5ldyBwYy5LZXkodCwgcG9zLCByb3QsIHNjbCk7XG4gICAgICAgIG5vZGUuX2tleXMucHVzaChrZXkpO1xuICAgICAgfVxuICAgICAgYW5pbS5hZGROb2RlKG5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gYW5pbTtcbiAgfX07XG4gIHJldHVybiB7QW5pbWF0aW9uSGFuZGxlcjpBbmltYXRpb25IYW5kbGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgaWUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDtcbiAgICB2YXIgbXNpZSA9IHVhLmluZGV4T2YoXCJNU0lFIFwiKTtcbiAgICBpZiAobXNpZSA+IDApIHtcbiAgICAgIHJldHVybiBwYXJzZUludCh1YS5zdWJzdHJpbmcobXNpZSArIDUsIHVhLmluZGV4T2YoXCIuXCIsIG1zaWUpKSwgMTApO1xuICAgIH1cbiAgICB2YXIgdHJpZGVudCA9IHVhLmluZGV4T2YoXCJUcmlkZW50L1wiKTtcbiAgICBpZiAodHJpZGVudCA+IDApIHtcbiAgICAgIHZhciBydiA9IHVhLmluZGV4T2YoXCJydjpcIik7XG4gICAgICByZXR1cm4gcGFyc2VJbnQodWEuc3Vic3RyaW5nKHJ2ICsgMywgdWEuaW5kZXhPZihcIi5cIiwgcnYpKSwgMTApO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0oKTtcbiAgdmFyIEF1ZGlvSGFuZGxlciA9IGZ1bmN0aW9uKG1hbmFnZXIpIHtcbiAgICB0aGlzLm1hbmFnZXIgPSBtYW5hZ2VyO1xuICB9O1xuICBBdWRpb0hhbmRsZXIucHJvdG90eXBlID0ge19pc1N1cHBvcnRlZDpmdW5jdGlvbih1cmwpIHtcbiAgICB2YXIgdG9NSU1FID0ge1wiLm9nZ1wiOlwiYXVkaW8vb2dnXCIsIFwiLm1wM1wiOlwiYXVkaW8vbXBlZ1wiLCBcIi53YXZcIjpcImF1ZGlvL3gtd2F2XCIsIFwiLm1wNGFcIjpcImF1ZGlvL21wNFwiLCBcIi5tNGFcIjpcImF1ZGlvL21wNFwiLCBcIi5tcDRcIjpcImF1ZGlvL21wNFwiLCBcIi5hYWNcIjpcImF1ZGlvL2FhY1wifTtcbiAgICB2YXIgZXh0ID0gcGMucGF0aC5nZXRFeHRlbnNpb24odXJsKTtcbiAgICBpZiAodG9NSU1FW2V4dF0pIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9LCBsb2FkOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICB2YXIgc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc291cmNlKSB7XG4gICAgICBjYWxsYmFjayhudWxsLCBuZXcgcGMuU291bmQocmVzb3VyY2UpKTtcbiAgICB9O1xuICAgIHZhciBlcnJvciA9IGZ1bmN0aW9uKG1zZykge1xuICAgICAgbXNnID0gbXNnIHx8IFwiRXJyb3IgbG9hZGluZyBhdWRpbyB1cmw6IFwiICsgdXJsO1xuICAgICAgY29uc29sZS53YXJuKG1zZyk7XG4gICAgICBjYWxsYmFjayhtc2cpO1xuICAgIH07XG4gICAgaWYgKHRoaXMuX2NyZWF0ZVNvdW5kKSB7XG4gICAgICBpZiAoIXRoaXMuX2lzU3VwcG9ydGVkKHVybCkpIHtcbiAgICAgICAgZXJyb3IocGMuc3RyaW5nLmZvcm1hdChcIkF1ZGlvIGZvcm1hdCBmb3IgezB9IG5vdCBzdXBwb3J0ZWRcIiwgdXJsKSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2NyZWF0ZVNvdW5kKHVybCwgc3VjY2VzcywgZXJyb3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlcnJvcihudWxsKTtcbiAgICB9XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH19O1xuICBpZiAocGMuU291bmRNYW5hZ2VyLmhhc0F1ZGlvQ29udGV4dCgpKSB7XG4gICAgQXVkaW9IYW5kbGVyLnByb3RvdHlwZS5fY3JlYXRlU291bmQgPSBmdW5jdGlvbih1cmwsIHN1Y2Nlc3MsIGVycm9yKSB7XG4gICAgICB2YXIgbWFuYWdlciA9IHRoaXMubWFuYWdlcjtcbiAgICAgIGlmICghbWFuYWdlci5jb250ZXh0KSB7XG4gICAgICAgIGVycm9yKFwiQXVkaW8gbWFuYWdlciBoYXMgbm8gYXVkaW8gY29udGV4dFwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBlcnJvcihlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBtYW5hZ2VyLmNvbnRleHQuZGVjb2RlQXVkaW9EYXRhKHJlc3BvbnNlLCBzdWNjZXNzLCBlcnJvcik7XG4gICAgICB9KTtcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIGlmIChwYy5Tb3VuZE1hbmFnZXIuaGFzQXVkaW8oKSkge1xuICAgICAgQXVkaW9IYW5kbGVyLnByb3RvdHlwZS5fY3JlYXRlU291bmQgPSBmdW5jdGlvbih1cmwsIHN1Y2Nlc3MsIGVycm9yKSB7XG4gICAgICAgIHZhciBhdWRpbyA9IG51bGw7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXVkaW8gPSBuZXcgQXVkaW87XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBlcnJvcihcIk5vIHN1cHBvcnQgZm9yIEF1ZGlvIGVsZW1lbnRcIik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpZSkge1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYXVkaW8pO1xuICAgICAgICB9XG4gICAgICAgIHZhciBvblJlYWR5ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgYXVkaW8ucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNhbnBsYXl0aHJvdWdoXCIsIG9uUmVhZHkpO1xuICAgICAgICAgIGlmIChpZSkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhdWRpbyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN1Y2Nlc3MoYXVkaW8pO1xuICAgICAgICB9O1xuICAgICAgICBhdWRpby5vbmVycm9yID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgYXVkaW8ub25lcnJvciA9IG51bGw7XG4gICAgICAgICAgaWYgKGllKSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGF1ZGlvKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZXJyb3IoKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcihcImNhbnBsYXl0aHJvdWdoXCIsIG9uUmVhZHkpO1xuICAgICAgICBhdWRpby5zcmMgPSB1cmw7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuICByZXR1cm4ge0F1ZGlvSGFuZGxlcjpBdWRpb0hhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBDdWJlbWFwSGFuZGxlciA9IGZ1bmN0aW9uKGRldmljZSwgYXNzZXRzLCBsb2FkZXIpIHtcbiAgICB0aGlzLl9kZXZpY2UgPSBkZXZpY2U7XG4gICAgdGhpcy5fYXNzZXRzID0gYXNzZXRzO1xuICAgIHRoaXMuX2xvYWRlciA9IGxvYWRlcjtcbiAgfTtcbiAgQ3ViZW1hcEhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldEN1YmVNYXAsIGFzc2V0cykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgbG9hZGVkID0gZmFsc2U7XG4gICAgaWYgKCFhc3NldEN1YmVNYXAucmVzb3VyY2VzWzBdKSB7XG4gICAgICBhc3NldEN1YmVNYXAucmVzb3VyY2VzWzBdID0gbmV3IHBjLlRleHR1cmUodGhpcy5fZGV2aWNlLCB7Zm9ybWF0OnBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCBjdWJlbWFwOnRydWUsIG1pcG1hcHM6dHJ1ZSwgZml4Q3ViZW1hcFNlYW1zOiEhYXNzZXRDdWJlTWFwLl9kZHN9KTtcbiAgICAgIGxvYWRlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmICghYXNzZXRDdWJlTWFwLmZpbGUpIHtcbiAgICAgIGRlbGV0ZSBhc3NldEN1YmVNYXAuX2RkcztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGFzc2V0Q3ViZU1hcC5maWxlICYmICFhc3NldEN1YmVNYXAuX2Rkcykge1xuICAgICAgICB2YXIgdXJsID0gYXNzZXRDdWJlTWFwLmdldEZpbGVVcmwoKTtcbiAgICAgICAgYXNzZXRzLl9sb2FkZXIubG9hZCh1cmwgKyBcIj90PVwiICsgYXNzZXRDdWJlTWFwLmZpbGUuaGFzaCwgXCJ0ZXh0dXJlXCIsIGZ1bmN0aW9uKGVyciwgdGV4dHVyZSkge1xuICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICBhc3NldHMuX2xvYWRlci5wYXRjaCh7cmVzb3VyY2U6dGV4dHVyZSwgdHlwZTpcInRleHR1cmVcIiwgZGF0YTphc3NldEN1YmVNYXAuZGF0YX0sIGFzc2V0cyk7XG4gICAgICAgICAgICBhc3NldEN1YmVNYXAuX2RkcyA9IHRleHR1cmU7XG4gICAgICAgICAgICBzZWxmLnBhdGNoKGFzc2V0Q3ViZU1hcCwgYXNzZXRzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXNzZXRzLmZpcmUoXCJlcnJvclwiLCBlcnIsIGFzc2V0Q3ViZU1hcCk7XG4gICAgICAgICAgICBhc3NldHMuZmlyZShcImVycm9yOlwiICsgYXNzZXRDdWJlTWFwLmlkLCBlcnIsIGFzc2V0Q3ViZU1hcCk7XG4gICAgICAgICAgICBhc3NldEN1YmVNYXAuZmlyZShcImVycm9yXCIsIGVyciwgYXNzZXRDdWJlTWFwKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoKCFhc3NldEN1YmVNYXAuZmlsZSB8fCAhYXNzZXRDdWJlTWFwLl9kZHMpICYmIGFzc2V0Q3ViZU1hcC5yZXNvdXJjZXNbMV0pIHtcbiAgICAgIGFzc2V0Q3ViZU1hcC5yZXNvdXJjZXMgPSBbYXNzZXRDdWJlTWFwLnJlc291cmNlc1swXV07XG4gICAgICBsb2FkZWQgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoYXNzZXRDdWJlTWFwLl9kZHMgJiYgIWFzc2V0Q3ViZU1hcC5yZXNvdXJjZXNbMV0pIHtcbiAgICAgICAgYXNzZXRDdWJlTWFwLnJlc291cmNlcyA9IFthc3NldEN1YmVNYXAucmVzb3VyY2VzWzBdXTtcbiAgICAgICAgYXNzZXRDdWJlTWFwLl9kZHMuZml4Q3ViZW1hcFNlYW1zID0gdHJ1ZTtcbiAgICAgICAgYXNzZXRDdWJlTWFwLl9kZHMuYWRkcmVzc1UgPSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0U7XG4gICAgICAgIGFzc2V0Q3ViZU1hcC5fZGRzLmFkZHJlc3NWID0gcGMuQUREUkVTU19DTEFNUF9UT19FREdFO1xuICAgICAgICB2YXIgc3RhcnRJbmRleCA9IDA7XG4gICAgICAgIGlmICh0aGlzLl9kZXZpY2UudXNlVGV4Q3ViZUxvZCkge1xuICAgICAgICAgIGFzc2V0Q3ViZU1hcC5yZXNvdXJjZXMucHVzaChhc3NldEN1YmVNYXAuX2Rkcyk7XG4gICAgICAgICAgc3RhcnRJbmRleCA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0SW5kZXg7aSA8IDY7aSsrKSB7XG4gICAgICAgICAgdmFyIG1pcCA9IG5ldyBwYy5UZXh0dXJlKHRoaXMuX2RldmljZSwge2N1YmVtYXA6dHJ1ZSwgZml4Q3ViZW1hcFNlYW1zOnRydWUsIG1pcG1hcHM6dHJ1ZSwgZm9ybWF0OmFzc2V0Q3ViZU1hcC5fZGRzLmZvcm1hdCwgcmdibTphc3NldEN1YmVNYXAuX2Rkcy5yZ2JtLCB3aWR0aDpNYXRoLnBvdygyLCA3IC0gaSksIGhlaWdodDpNYXRoLnBvdygyLCA3IC0gaSl9KTtcbiAgICAgICAgICBtaXAuX2xldmVsc1swXSA9IGFzc2V0Q3ViZU1hcC5fZGRzLl9sZXZlbHNbaV07XG4gICAgICAgICAgbWlwLnVwbG9hZCgpO1xuICAgICAgICAgIGFzc2V0Q3ViZU1hcC5yZXNvdXJjZXMucHVzaChtaXApO1xuICAgICAgICB9XG4gICAgICAgIGxvYWRlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBjdWJlbWFwID0gYXNzZXRDdWJlTWFwLnJlc291cmNlO1xuICAgIGlmIChjdWJlbWFwLm5hbWUgIT09IGFzc2V0Q3ViZU1hcC5uYW1lKSB7XG4gICAgICBjdWJlbWFwLm5hbWUgPSBhc3NldEN1YmVNYXAubmFtZTtcbiAgICB9XG4gICAgdmFyIHJnYm0gPSAhIWFzc2V0Q3ViZU1hcC5kYXRhLnJnYm07XG4gICAgaWYgKGFzc2V0Q3ViZU1hcC5kYXRhLmhhc093blByb3BlcnR5KFwicmdibVwiKSAmJiBjdWJlbWFwLnJnYm0gIT09IHJnYm0pIHtcbiAgICAgIGN1YmVtYXAucmdibSA9IHJnYm07XG4gICAgfVxuICAgIGN1YmVtYXAuZml4Q3ViZW1hcFNlYW1zID0gISFhc3NldEN1YmVNYXAuX2RkcztcbiAgICBpZiAoYXNzZXRDdWJlTWFwLmRhdGEuaGFzT3duUHJvcGVydHkoXCJtaW5GaWx0ZXJcIikgJiYgY3ViZW1hcC5taW5GaWx0ZXIgIT09IGFzc2V0Q3ViZU1hcC5kYXRhLm1pbkZpbHRlcikge1xuICAgICAgY3ViZW1hcC5taW5GaWx0ZXIgPSBhc3NldEN1YmVNYXAuZGF0YS5taW5GaWx0ZXI7XG4gICAgfVxuICAgIGlmIChhc3NldEN1YmVNYXAuZGF0YS5oYXNPd25Qcm9wZXJ0eShcIm1hZ0ZpbHRlclwiKSAmJiBjdWJlbWFwLm1hZ0ZpbHRlciAhPT0gYXNzZXRDdWJlTWFwLmRhdGEubWFnRmlsdGVyKSB7XG4gICAgICBjdWJlbWFwLm1hZ0ZpbHRlciA9IGFzc2V0Q3ViZU1hcC5kYXRhLm1hZ0ZpbHRlcjtcbiAgICB9XG4gICAgaWYgKGFzc2V0Q3ViZU1hcC5kYXRhLmhhc093blByb3BlcnR5KFwiYW5pc290cm9weVwiKSAmJiBjdWJlbWFwLmFuaXNvdHJvcHkgIT09IGFzc2V0Q3ViZU1hcC5kYXRhLmFuaXNvdHJvcHkpIHtcbiAgICAgIGN1YmVtYXAuYW5pc290cm9weSA9IGFzc2V0Q3ViZU1hcC5kYXRhLmFuaXNvdHJvcHk7XG4gICAgfVxuICAgIGlmIChjdWJlbWFwLmFkZHJlc3NVICE9PSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0UpIHtcbiAgICAgIGN1YmVtYXAuYWRkcmVzc1UgPSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0U7XG4gICAgfVxuICAgIGlmIChjdWJlbWFwLmFkZHJlc3NWICE9PSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0UpIHtcbiAgICAgIGN1YmVtYXAuYWRkcmVzc1YgPSBwYy5BRERSRVNTX0NMQU1QX1RPX0VER0U7XG4gICAgfVxuICAgIHRoaXMuX3BhdGNoVGV4dHVyZUZhY2VzKGFzc2V0Q3ViZU1hcCwgYXNzZXRzKTtcbiAgICBpZiAobG9hZGVkKSB7XG4gICAgICBhc3NldHMuZmlyZShcImxvYWRcIiwgYXNzZXRDdWJlTWFwKTtcbiAgICAgIGFzc2V0cy5maXJlKFwibG9hZDpcIiArIGFzc2V0Q3ViZU1hcC5pZCwgYXNzZXRDdWJlTWFwKTtcbiAgICAgIGFzc2V0Q3ViZU1hcC5maXJlKFwibG9hZFwiLCBhc3NldEN1YmVNYXApO1xuICAgIH1cbiAgfSwgX3BhdGNoVGV4dHVyZTpmdW5jdGlvbigpIHtcbiAgICB0aGlzLnJlZ2lzdHJ5Ll9sb2FkZXIuX2hhbmRsZXJzLmN1YmVtYXAuX3BhdGNoVGV4dHVyZUZhY2VzKHRoaXMsIHRoaXMucmVnaXN0cnkpO1xuICB9LCBfcGF0Y2hUZXh0dXJlRmFjZXM6ZnVuY3Rpb24oYXNzZXRDdWJlTWFwLCBhc3NldHMpIHtcbiAgICBpZiAoIWFzc2V0Q3ViZU1hcC5sb2FkRmFjZXMgJiYgYXNzZXRDdWJlTWFwLmZpbGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGN1YmVtYXAgPSBhc3NldEN1YmVNYXAucmVzb3VyY2U7XG4gICAgdmFyIHNvdXJjZXMgPSBbXTtcbiAgICB2YXIgY291bnQgPSAwO1xuICAgIHZhciBsZXZlbHNVcGRhdGVkID0gZmFsc2U7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGlmICghYXNzZXRDdWJlTWFwLl9sZXZlbHNFdmVudHMpIHtcbiAgICAgIGFzc2V0Q3ViZU1hcC5fbGV2ZWxzRXZlbnRzID0gW251bGwsIG51bGwsIG51bGwsIG51bGwsIG51bGwsIG51bGxdO1xuICAgIH1cbiAgICBhc3NldEN1YmVNYXAuZGF0YS50ZXh0dXJlcy5mb3JFYWNoKGZ1bmN0aW9uKGlkLCBpbmRleCkge1xuICAgICAgdmFyIGFzc2V0QWRkZWQgPSBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICBhc3NldC5yZWFkeShhc3NldFJlYWR5KTtcbiAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgfTtcbiAgICAgIHZhciBhc3NldFJlYWR5ID0gZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgY291bnQrKztcbiAgICAgICAgc291cmNlc1tpbmRleF0gPSBhc3NldCAmJiBhc3NldC5yZXNvdXJjZS5nZXRTb3VyY2UoKSB8fCBudWxsO1xuICAgICAgICB2YXIgZXZ0QXNzZXQgPSBhc3NldEN1YmVNYXAuX2xldmVsc0V2ZW50c1tpbmRleF07XG4gICAgICAgIGlmIChldnRBc3NldCAhPT0gYXNzZXQpIHtcbiAgICAgICAgICBpZiAoZXZ0QXNzZXQpIHtcbiAgICAgICAgICAgIGV2dEFzc2V0Lm9mZihcImxvYWRcIiwgc2VsZi5fcGF0Y2hUZXh0dXJlLCBhc3NldEN1YmVNYXApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGFzc2V0Lm9uKFwibG9hZFwiLCBzZWxmLl9wYXRjaFRleHR1cmUsIGFzc2V0Q3ViZU1hcCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGFzc2V0Q3ViZU1hcC5fbGV2ZWxzRXZlbnRzW2luZGV4XSA9IGFzc2V0IHx8IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNvdXJjZXNbaW5kZXhdICE9PSBjdWJlbWFwLl9sZXZlbHNbMF1baW5kZXhdKSB7XG4gICAgICAgICAgbGV2ZWxzVXBkYXRlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvdW50ID09PSA2ICYmIGxldmVsc1VwZGF0ZWQpIHtcbiAgICAgICAgICBjdWJlbWFwLnNldFNvdXJjZShzb3VyY2VzKTtcbiAgICAgICAgICBhc3NldHMuZmlyZShcImxvYWRcIiwgYXNzZXRDdWJlTWFwKTtcbiAgICAgICAgICBhc3NldHMuZmlyZShcImxvYWQ6XCIgKyBhc3NldEN1YmVNYXAuaWQsIGFzc2V0Q3ViZU1hcCk7XG4gICAgICAgICAgYXNzZXRDdWJlTWFwLmZpcmUoXCJsb2FkXCIsIGFzc2V0Q3ViZU1hcCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KGlkKTtcbiAgICAgIGlmIChhc3NldCkge1xuICAgICAgICBhc3NldC5yZWFkeShhc3NldFJlYWR5KTtcbiAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlkKSB7XG4gICAgICAgICAgYXNzZXRzLm9uY2UoXCJsb2FkOlwiICsgaWQsIGFzc2V0UmVhZHkpO1xuICAgICAgICAgIGFzc2V0cy5vbmNlKFwiYWRkOlwiICsgaWQsIGFzc2V0QWRkZWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFzc2V0UmVhZHkobnVsbCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfX07XG4gIHJldHVybiB7Q3ViZW1hcEhhbmRsZXI6Q3ViZW1hcEhhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBKc29uSGFuZGxlciA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBKc29uSGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBKU09OIHJlc291cmNlOiB7MH0gW3sxfV1cIiwgdXJsLCBlcnIpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSwgb3BlbjpmdW5jdGlvbih1cmwsIGRhdGEpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfSwgcGF0Y2g6ZnVuY3Rpb24oYXNzZXQsIGFzc2V0cykge1xuICB9fTtcbiAgcmV0dXJuIHtKc29uSGFuZGxlcjpKc29uSGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFBBUkFNRVRFUl9UWVBFUyA9IHthbWJpZW50OlwidmVjM1wiLCBhbWJpZW50VG51bWJlcjpcImJvb2xlYW5cIiwgYW9NYXA6XCJ0ZXh0dXJlXCIsIGFvTWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsIGFvTWFwQ2hhbm5lbDpcInN0cmluZ1wiLCBhb01hcFV2OlwibnVtYmVyXCIsIGFvTWFwVGlsaW5nOlwidmVjMlwiLCBhb01hcE9mZnNldDpcInZlYzJcIiwgb2NjbHVkZVNwZWN1bGFyOlwiYm9vbGVhblwiLCBkaWZmdXNlOlwidmVjM1wiLCBkaWZmdXNlTWFwOlwidGV4dHVyZVwiLCBkaWZmdXNlTWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsIGRpZmZ1c2VNYXBDaGFubmVsOlwic3RyaW5nXCIsIGRpZmZ1c2VNYXBVdjpcIm51bWJlclwiLCBkaWZmdXNlTWFwVGlsaW5nOlwidmVjMlwiLCBkaWZmdXNlTWFwT2Zmc2V0OlwidmVjMlwiLCBkaWZmdXNlTWFwVG51bWJlcjpcImJvb2xlYW5cIiwgc3BlY3VsYXI6XCJ2ZWMzXCIsIHNwZWN1bGFyTWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsIHNwZWN1bGFyTWFwQ2hhbm5lbDpcInN0cmluZ1wiLFxuICBzcGVjdWxhck1hcFV2OlwibnVtYmVyXCIsIHNwZWN1bGFyTWFwOlwidGV4dHVyZVwiLCBzcGVjdWxhck1hcFRpbGluZzpcInZlYzJcIiwgc3BlY3VsYXJNYXBPZmZzZXQ6XCJ2ZWMyXCIsIHNwZWN1bGFyTWFwVG51bWJlcjpcImJvb2xlYW5cIiwgc3BlY3VsYXJBbnRpYWxpYXM6XCJib29sZWFuXCIsIHVzZU1ldGFsbmVzczpcImJvb2xlYW5cIiwgbWV0YWxuZXNzTWFwOlwidGV4dHVyZVwiLCBtZXRhbG5lc3NNYXBWZXJ0ZXhDb2xvcjpcImJvb2xlYW5cIiwgbWV0YWxuZXNzTWFwQ2hhbm5lbDpcInN0cmluZ1wiLCBtZXRhbG5lc3NNYXBVdjpcIm51bWJlclwiLCBtZXRhbG5lc3NNYXBUaWxpbmc6XCJ2ZWMyXCIsIG1ldGFsbmVzc01hcE9mZnNldDpcInZlYzJcIiwgbWV0YWxuZXNzTWFwVG51bWJlcjpcImJvb2xlYW5cIiwgbWV0YWxuZXNzOlwibnVtYmVyXCIsIGNvbnNlcnZlRW5lcmd5OlwiYm9vbGVhblwiLCBzaGluaW5lc3M6XCJudW1iZXJcIiwgZ2xvc3NNYXA6XCJ0ZXh0dXJlXCIsIGdsb3NzTWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsIGdsb3NzTWFwQ2hhbm5lbDpcInN0cmluZ1wiLFxuICBnbG9zc01hcFV2OlwibnVtYmVyXCIsIGdsb3NzTWFwVGlsaW5nOlwidmVjMlwiLCBnbG9zc01hcE9mZnNldDpcInZlYzJcIiwgZnJlc25lbE1vZGVsOlwibnVtYmVyXCIsIGZyZXNuZWxGYWN0b3I6XCJmbG9hdFwiLCBlbWlzc2l2ZTpcInZlYzNcIiwgZW1pc3NpdmVNYXA6XCJ0ZXh0dXJlXCIsIGVtaXNzaXZlTWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsIGVtaXNzaXZlTWFwQ2hhbm5lbDpcInN0cmluZ1wiLCBlbWlzc2l2ZU1hcFV2OlwibnVtYmVyXCIsIGVtaXNzaXZlTWFwVGlsaW5nOlwidmVjMlwiLCBlbWlzc2l2ZU1hcE9mZnNldDpcInZlYzJcIiwgZW1pc3NpdmVNYXBUaW50OlwiYm9vbGVhblwiLCBlbWlzc2l2ZUludGVuc2l0eTpcIm51bWJlclwiLCBub3JtYWxNYXA6XCJ0ZXh0dXJlXCIsIG5vcm1hbE1hcFRpbGluZzpcInZlYzJcIiwgbm9ybWFsTWFwT2Zmc2V0OlwidmVjMlwiLCBub3JtYWxNYXBVdjpcIm51bWJlclwiLCBidW1wTWFwRmFjdG9yOlwibnVtYmVyXCIsIGhlaWdodE1hcDpcInRleHR1cmVcIiwgaGVpZ2h0TWFwQ2hhbm5lbDpcInN0cmluZ1wiLFxuICBoZWlnaHRNYXBVdjpcIm51bWJlclwiLCBoZWlnaHRNYXBUaWxpbmc6XCJ2ZWMyXCIsIGhlaWdodE1hcE9mZnNldDpcInZlYzJcIiwgaGVpZ2h0TWFwRmFjdG9yOlwibnVtYmVyXCIsIGFscGhhVGVzdDpcIm51bWJlclwiLCBvcGFjaXR5OlwibnVtYmVyXCIsIG9wYWNpdHlNYXA6XCJ0ZXh0dXJlXCIsIG9wYWNpdHlNYXBWZXJ0ZXhDb2xvcjpcImJvb2xlYW5cIiwgb3BhY2l0eU1hcENoYW5uZWw6XCJzdHJpbmdcIiwgb3BhY2l0eU1hcFV2OlwibnVtYmVyXCIsIG9wYWNpdHlNYXBUaWxpbmc6XCJ2ZWMyXCIsIG9wYWNpdHlNYXBPZmZzZXQ6XCJ2ZWMyXCIsIHJlZmxlY3Rpdml0eTpcIm51bWJlclwiLCByZWZyYWN0aW9uOlwibnVtYmVyXCIsIHJlZnJhY3Rpb25JbmRleDpcIm51bWJlclwiLCBzcGhlcmVNYXA6XCJ0ZXh0dXJlXCIsIGN1YmVNYXA6XCJjdWJlbWFwXCIsIGN1YmVNYXBQcm9qZWN0aW9uOlwibnVtYmVyXCIsIGN1YmVNYXBQcm9qZWN0aW9uQm94OlwiYm91bmRpbmdib3hcIiwgbGlnaHRNYXA6XCJ0ZXh0dXJlXCIsIGxpZ2h0TWFwVmVydGV4Q29sb3I6XCJib29sZWFuXCIsXG4gIGxpZ2h0TWFwQ2hhbm5lbDpcInN0cmluZ1wiLCBsaWdodE1hcFV2OlwibnVtYmVyXCIsIGxpZ2h0TWFwVGlsaW5nOlwidmVjMlwiLCBsaWdodE1hcE9mZnNldDpcInZlYzJcIiwgZGVwdGhUZXN0OlwiYm9vbGVhblwiLCBkZXB0aFdyaXRlOlwiYm9vbGVhblwiLCBjdWxsOlwibnVtYmVyXCIsIGJsZW5kVHlwZTpcIm51bWJlclwiLCBzaGFkaW5nTW9kZWw6XCJudW1iZXJcIn07XG4gIHZhciBwbGFjZWhvbGRlcnMgPSB7fTtcbiAgdmFyIHBsYWNlaG9sZGVyc01hcHBpbmcgPSB7YW9NYXA6XCJ3aGl0ZVwiLCBkaWZmdXNlTWFwOlwiZ3JheVwiLCBzcGVjdWxhck1hcDpcImdyYXlcIiwgbWV0YWxuZXNzTWFwOlwiYmxhY2tcIiwgZ2xvc3NNYXA6XCJncmF5XCIsIGVtaXNzaXZlTWFwOlwiZ3JheVwiLCBub3JtYWxNYXA6XCJub3JtYWxcIiwgaGVpZ2h0TWFwOlwiZ3JheVwiLCBvcGFjaXR5TWFwOlwiZ3JheVwiLCBzcGhlcmVNYXA6XCJncmF5XCIsIGxpZ2h0TWFwOlwid2hpdGVcIn07XG4gIHZhciBvbkN1YmVtYXBBc3NldExvYWQgPSBmdW5jdGlvbihhc3NldCwgYXR0cmlidXRlLCBuZXdWYWx1ZSwgb2xkVmFsdWUpIHtcbiAgICB2YXIgcHJvcHMgPSBbXCJjdWJlTWFwXCIsIFwicHJlZmlsdGVyZWRDdWJlTWFwMTI4XCIsIFwicHJlZmlsdGVyZWRDdWJlTWFwNjRcIiwgXCJwcmVmaWx0ZXJlZEN1YmVNYXAzMlwiLCBcInByZWZpbHRlcmVkQ3ViZU1hcDE2XCIsIFwicHJlZmlsdGVyZWRDdWJlTWFwOFwiLCBcInByZWZpbHRlcmVkQ3ViZU1hcDRcIl07XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHByb3BzLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmICh0aGlzW3Byb3BzW2ldXSAhPT0gYXNzZXQucmVzb3VyY2VzW2ldKSB7XG4gICAgICAgIHRoaXNbcHJvcHNbaV1dID0gYXNzZXQucmVzb3VyY2VzW2ldO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9O1xuICB2YXIgTWF0ZXJpYWxIYW5kbGVyID0gZnVuY3Rpb24oYXBwKSB7XG4gICAgdGhpcy5fYXNzZXRzID0gYXBwLmFzc2V0cztcbiAgICB0aGlzLl9kZXZpY2UgPSBhcHAuZ3JhcGhpY3NEZXZpY2U7XG4gICAgdGhpcy5fY3JlYXRlUGxhY2Vob2xkZXJzKCk7XG4gIH07XG4gIE1hdGVyaWFsSGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGNhbGxiYWNrKHBjLnN0cmluZy5mb3JtYXQoXCJFcnJvciBsb2FkaW5nIG1hdGVyaWFsOiB7MH0gW3sxfV1cIiwgdXJsLCBlcnIpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHZhciBtYXRlcmlhbCA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xuICAgIGlmICghZGF0YS5wYXJhbWV0ZXJzKSB7XG4gICAgICB0aGlzLl9jcmVhdGVQYXJhbWV0ZXJzKGRhdGEpO1xuICAgIH1cbiAgICBtYXRlcmlhbC5pbml0KGRhdGEpO1xuICAgIG1hdGVyaWFsLl9kYXRhID0gZGF0YTtcbiAgICByZXR1cm4gbWF0ZXJpYWw7XG4gIH0sIF9jcmVhdGVQbGFjZWhvbGRlcnM6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHRleHR1cmVzID0ge3doaXRlOlsyNTUsIDI1NSwgMjU1LCAyNTVdLCBncmF5OlsxMjgsIDEyOCwgMTI4LCAyNTVdLCBibGFjazpbMCwgMCwgMCwgMjU1XSwgbm9ybWFsOlsxMjgsIDEyOCwgMjU1LCAyNTVdfTtcbiAgICBmb3IgKHZhciBrZXkgaW4gdGV4dHVyZXMpIHtcbiAgICAgIGlmICghdGV4dHVyZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZhciB0ZXh0dXJlID0gcGxhY2Vob2xkZXJzW2tleV0gPSBuZXcgcGMuVGV4dHVyZSh0aGlzLl9kZXZpY2UsIHt3aWR0aDoyLCBoZWlnaHQ6MiwgZm9ybWF0OnBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4fSk7XG4gICAgICB2YXIgcGl4ZWxzID0gdGV4dHVyZS5sb2NrKCk7XG4gICAgICBmb3IgKHZhciBpID0gMDtpIDwgNDtpKyspIHtcbiAgICAgICAgZm9yICh2YXIgYyA9IDA7YyA8IDQ7YysrKSB7XG4gICAgICAgICAgcGl4ZWxzW2kgKiA0ICsgY10gPSB0ZXh0dXJlc1trZXldW2NdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0ZXh0dXJlLnVubG9jaygpO1xuICAgIH1cbiAgfSwgX2NyZWF0ZVBhcmFtZXRlcnM6ZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBwYXJhbWV0ZXJzID0gW107XG4gICAgaWYgKCFkYXRhLnNoYWRpbmdNb2RlbCkge1xuICAgICAgZGF0YS5zaGFkaW5nTW9kZWwgPSBkYXRhLnNoYWRlciA9PT0gXCJibGlublwiID8gcGMuU1BFQ1VMQVJfQkxJTk4gOiBwYy5TUEVDVUxBUl9QSE9ORztcbiAgICB9XG4gICAgdmFyIHNoYWRlciA9IGRhdGEuc2hhZGVyO1xuICAgIGRlbGV0ZSBkYXRhLnNoYWRlcjtcbiAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkge1xuICAgICAgaWYgKCFkYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBwYXJhbWV0ZXJzLnB1c2goe25hbWU6a2V5LCB0eXBlOlBBUkFNRVRFUl9UWVBFU1trZXldLCBkYXRhOmRhdGFba2V5XX0pO1xuICAgIH1cbiAgICBkYXRhLnNoYWRlciA9IHNoYWRlcjtcbiAgICBkYXRhLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gICAgaWYgKGFzc2V0LmRhdGEuc2hhZGVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGFzc2V0LmRhdGEgPSBhc3NldC5yZXNvdXJjZS5fZGF0YTtcbiAgICAgIGRlbGV0ZSBhc3NldC5yZXNvdXJjZS5fZGF0YTtcbiAgICB9XG4gICAgdGhpcy5fdXBkYXRlU3RhbmRhcmRNYXRlcmlhbChhc3NldCwgYXNzZXQuZGF0YSwgYXNzZXRzKTtcbiAgICBhc3NldC5vZmYoXCJjaGFuZ2VcIiwgdGhpcy5fb25Bc3NldENoYW5nZSwgdGhpcyk7XG4gICAgYXNzZXQub24oXCJjaGFuZ2VcIiwgdGhpcy5fb25Bc3NldENoYW5nZSwgdGhpcyk7XG4gICAgYXNzZXQub24oXCJ1bmxvYWRcIiwgdGhpcy5fb25Bc3NldFVubG9hZCwgdGhpcyk7XG4gIH0sIF9vbkFzc2V0Q2hhbmdlOmZ1bmN0aW9uKGFzc2V0LCBhdHRyaWJ1dGUsIHZhbHVlKSB7XG4gICAgaWYgKGF0dHJpYnV0ZSA9PT0gXCJkYXRhXCIpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVN0YW5kYXJkTWF0ZXJpYWwoYXNzZXQsIHZhbHVlLCB0aGlzLl9hc3NldHMpO1xuICAgIH1cbiAgfSwgX29uQXNzZXRVbmxvYWQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICBkZWxldGUgYXNzZXQuZGF0YS5wYXJhbWV0ZXJzO1xuICAgIGRlbGV0ZSBhc3NldC5kYXRhLmNodW5rcztcbiAgICBkZWxldGUgYXNzZXQuZGF0YS5uYW1lO1xuICB9LCBfdXBkYXRlU3RhbmRhcmRNYXRlcmlhbDpmdW5jdGlvbihhc3NldCwgZGF0YSwgYXNzZXRzKSB7XG4gICAgdmFyIG1hdGVyaWFsID0gYXNzZXQucmVzb3VyY2U7XG4gICAgdmFyIGRpcjtcbiAgICBpZiAoYXNzZXQuZmlsZSkge1xuICAgICAgZGlyID0gcGMucGF0aC5nZXREaXJlY3RvcnkoYXNzZXQuZ2V0RmlsZVVybCgpKTtcbiAgICB9XG4gICAgZGF0YS5uYW1lID0gYXNzZXQubmFtZTtcbiAgICBpZiAoIWRhdGEucGFyYW1ldGVycykge1xuICAgICAgdGhpcy5fY3JlYXRlUGFyYW1ldGVycyhkYXRhKTtcbiAgICB9XG4gICAgdmFyIHBhdGhNYXBwaW5nID0gZGF0YS5tYXBwaW5nX2Zvcm1hdCA9PT0gXCJwYXRoXCI7XG4gICAgZGF0YS5jaHVua3MgPSBhc3NldC5yZXNvdXJjZS5jaHVua3M7XG4gICAgZGF0YS5wYXJhbWV0ZXJzLmZvckVhY2goZnVuY3Rpb24ocGFyYW0sIGkpIHtcbiAgICAgIHZhciBpZDtcbiAgICAgIGlmIChwYXJhbS50eXBlID09PSBcInRleHR1cmVcIikge1xuICAgICAgICBpZiAoIW1hdGVyaWFsLl9hc3NldEhhbmRsZXJzKSB7XG4gICAgICAgICAgbWF0ZXJpYWwuX2Fzc2V0SGFuZGxlcnMgPSB7fTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgaGFuZGxlciA9IG1hdGVyaWFsLl9hc3NldEhhbmRsZXJzW3BhcmFtLm5hbWVdO1xuICAgICAgICBpZiAocGFyYW0uZGF0YSAmJiAhKHBhcmFtLmRhdGEgaW5zdGFuY2VvZiBwYy5UZXh0dXJlKSkge1xuICAgICAgICAgIGlmIChwYXRoTWFwcGluZykge1xuICAgICAgICAgICAgYXNzZXQgPSBhc3NldHMuZ2V0QnlVcmwocGMucGF0aC5qb2luKGRpciwgcGFyYW0uZGF0YSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZCA9IHBhcmFtLmRhdGE7XG4gICAgICAgICAgICBhc3NldCA9IGFzc2V0cy5nZXQocGFyYW0uZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChoYW5kbGVyKSB7XG4gICAgICAgICAgICBhc3NldHMub2ZmKFwibG9hZDpcIiArIGhhbmRsZXIuaWQsIGhhbmRsZXIuYmluZCk7XG4gICAgICAgICAgICBhc3NldHMub2ZmKFwiYWRkOlwiICsgaGFuZGxlci5pZCwgaGFuZGxlci5hZGQpO1xuICAgICAgICAgICAgYXNzZXRzLm9mZihcInJlbW92ZTpcIiArIGhhbmRsZXIuaWQsIGhhbmRsZXIucmVtb3ZlKTtcbiAgICAgICAgICAgIGlmIChoYW5kbGVyLnVybCkge1xuICAgICAgICAgICAgICBhc3NldHMub2ZmKFwiYWRkOnVybDpcIiArIGhhbmRsZXIudXJsLCBoYW5kbGVyLmFkZCk7XG4gICAgICAgICAgICAgIGFzc2V0cy5vZmYoXCJyZW1vdmU6dXJsOlwiICsgaGFuZGxlci51cmwsIGhhbmRsZXIucmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1hdGVyaWFsLl9hc3NldEhhbmRsZXJzW3BhcmFtLm5hbWVdID0gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaGFuZGxlciA9IG1hdGVyaWFsLl9hc3NldEhhbmRsZXJzW3BhcmFtLm5hbWVdID0ge2lkOmlkLCB1cmw6cGF0aE1hcHBpbmcgPyBwYy5wYXRoLmpvaW4oZGlyLCBwYXJhbS5kYXRhKSA6IFwiXCIsIGJpbmQ6ZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICAgIGRhdGEucGFyYW1ldGVyc1tpXS5kYXRhID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICAgICAgICBtYXRlcmlhbFtkYXRhLnBhcmFtZXRlcnNbaV0ubmFtZV0gPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICAgIG1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgICAgICAgIH0sIGFkZDpmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgYXNzZXRzLmxvYWQoYXNzZXQpO1xuICAgICAgICAgIH0sIHJlbW92ZTpmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgaWYgKG1hdGVyaWFsW2RhdGEucGFyYW1ldGVyc1tpXS5uYW1lXSA9PT0gYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzW2ldLmRhdGEgPSBudWxsO1xuICAgICAgICAgICAgICBtYXRlcmlhbFtkYXRhLnBhcmFtZXRlcnNbaV0ubmFtZV0gPSBudWxsO1xuICAgICAgICAgICAgICBtYXRlcmlhbC51cGRhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9fTtcbiAgICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICAgIGFzc2V0cy5vbihcImxvYWQ6XCIgKyBpZCwgaGFuZGxlci5iaW5kKTtcbiAgICAgICAgICAgIGFzc2V0cy5vbihcInJlbW92ZTpcIiArIGlkLCBoYW5kbGVyLnJlbW92ZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChwYXRoTWFwcGluZykge1xuICAgICAgICAgICAgICBhc3NldHMub24oXCJsb2FkOnVybDpcIiArIHBjLnBhdGguam9pbihkaXIsIHBhcmFtLmRhdGEpLCBoYW5kbGVyLmJpbmQpO1xuICAgICAgICAgICAgICBhc3NldHMub24oXCJyZW1vdmU6dXJsOlwiICsgcGMucGF0aC5qb2luKGRpciwgcGFyYW0uZGF0YSksIGhhbmRsZXIucmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICBpZiAoYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgICAgICAgaGFuZGxlci5iaW5kKGFzc2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChwbGFjZWhvbGRlcnNNYXBwaW5nW2RhdGEucGFyYW1ldGVyc1tpXS5uYW1lXSkge1xuICAgICAgICAgICAgICAgIHZhciB0ZXh0dXJlID0gcGxhY2Vob2xkZXJzW3BsYWNlaG9sZGVyc01hcHBpbmdbZGF0YS5wYXJhbWV0ZXJzW2ldLm5hbWVdXTtcbiAgICAgICAgICAgICAgICBpZiAodGV4dHVyZSkge1xuICAgICAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzW2ldLmRhdGEgPSB0ZXh0dXJlO1xuICAgICAgICAgICAgICAgICAgbWF0ZXJpYWxbZGF0YS5wYXJhbWV0ZXJzW2ldLm5hbWVdID0gdGV4dHVyZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlkKSB7XG4gICAgICAgICAgICAgIGFzc2V0cy5vbmNlKFwiYWRkOlwiICsgaWQsIGhhbmRsZXIuYWRkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChwYXRoTWFwcGluZykge1xuICAgICAgICAgICAgICAgIGFzc2V0cy5vbmNlKFwiYWRkOnVybDpcIiArIGhhbmRsZXIudXJsLCBoYW5kbGVyLmFkZCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGhhbmRsZXIgJiYgIXBhcmFtLmRhdGEpIHtcbiAgICAgICAgICAgIGFzc2V0cy5vZmYoXCJsb2FkOlwiICsgaGFuZGxlci5pZCwgaGFuZGxlci5iaW5kKTtcbiAgICAgICAgICAgIGFzc2V0cy5vZmYoXCJhZGQ6XCIgKyBoYW5kbGVyLmlkLCBoYW5kbGVyLmFkZCk7XG4gICAgICAgICAgICBhc3NldHMub2ZmKFwicmVtb3ZlOlwiICsgaGFuZGxlci5pZCwgaGFuZGxlci5yZW1vdmUpO1xuICAgICAgICAgICAgaWYgKGhhbmRsZXIudXJsKSB7XG4gICAgICAgICAgICAgIGFzc2V0cy5vZmYoXCJhZGQ6dXJsOlwiICsgaGFuZGxlci51cmwsIGhhbmRsZXIuYWRkKTtcbiAgICAgICAgICAgICAgYXNzZXRzLm9mZihcInJlbW92ZTp1cmw6XCIgKyBoYW5kbGVyLnVybCwgaGFuZGxlci5yZW1vdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWF0ZXJpYWwuX2Fzc2V0SGFuZGxlcnNbcGFyYW0ubmFtZV0gPSBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHBhcmFtLnR5cGUgPT09IFwiY3ViZW1hcFwiICYmIHBhcmFtLmRhdGEgJiYgIShwYXJhbS5kYXRhIGluc3RhbmNlb2YgcGMuVGV4dHVyZSkpIHtcbiAgICAgICAgICBpZiAocGF0aE1hcHBpbmcpIHtcbiAgICAgICAgICAgIGFzc2V0ID0gYXNzZXRzLmdldEJ5VXJsKHBjLnBhdGguam9pbihkaXIsIHBhcmFtLmRhdGEpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWQgPSBwYXJhbS5kYXRhO1xuICAgICAgICAgICAgYXNzZXQgPSBhc3NldHMuZ2V0KHBhcmFtLmRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB2YXIgb25BZGQgPSBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgaWYgKGRhdGEuc2hhZGluZ01vZGVsID09PSBwYy5TUEVDVUxBUl9QSE9ORykge1xuICAgICAgICAgICAgICBhc3NldC5sb2FkRmFjZXMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXNzZXQucmVhZHkob25SZWFkeSk7XG4gICAgICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICB2YXIgb25SZWFkeSA9IGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICAgICAgICBwYXJhbS5kYXRhID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICAgICAgICBpZiAoYXNzZXQucmVzb3VyY2VzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzLnB1c2goe25hbWU6XCJwcmVmaWx0ZXJlZEN1YmVNYXAxMjhcIiwgZGF0YTphc3NldC5yZXNvdXJjZXNbMV19KTtcbiAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzLnB1c2goe25hbWU6XCJwcmVmaWx0ZXJlZEN1YmVNYXA2NFwiLCBkYXRhOmFzc2V0LnJlc291cmNlc1syXX0pO1xuICAgICAgICAgICAgICBkYXRhLnBhcmFtZXRlcnMucHVzaCh7bmFtZTpcInByZWZpbHRlcmVkQ3ViZU1hcDMyXCIsIGRhdGE6YXNzZXQucmVzb3VyY2VzWzNdfSk7XG4gICAgICAgICAgICAgIGRhdGEucGFyYW1ldGVycy5wdXNoKHtuYW1lOlwicHJlZmlsdGVyZWRDdWJlTWFwMTZcIiwgZGF0YTphc3NldC5yZXNvdXJjZXNbNF19KTtcbiAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzLnB1c2goe25hbWU6XCJwcmVmaWx0ZXJlZEN1YmVNYXA4XCIsIGRhdGE6YXNzZXQucmVzb3VyY2VzWzVdfSk7XG4gICAgICAgICAgICAgIGRhdGEucGFyYW1ldGVycy5wdXNoKHtuYW1lOlwicHJlZmlsdGVyZWRDdWJlTWFwNFwiLCBkYXRhOmFzc2V0LnJlc291cmNlc1s2XX0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWF0ZXJpYWwuaW5pdChkYXRhKTtcbiAgICAgICAgICAgIGFzc2V0Lm9mZihcImxvYWRcIiwgb25DdWJlbWFwQXNzZXRMb2FkLCBtYXRlcmlhbCk7XG4gICAgICAgICAgICBhc3NldC5vbihcImxvYWRcIiwgb25DdWJlbWFwQXNzZXRMb2FkLCBtYXRlcmlhbCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIG9uQWRkKGFzc2V0KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlkKSB7XG4gICAgICAgICAgICAgIGFzc2V0cy5vbmNlKFwiYWRkOlwiICsgaWQsIG9uQWRkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChwYXRoTWFwcGluZykge1xuICAgICAgICAgICAgICAgIGFzc2V0cy5vbmNlKFwiYWRkOnVybDpcIiArIHBjLnBhdGguam9pbihkaXIsIHBhcmFtLmRhdGEpLCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgICAgICAgYXNzZXQucmVhZHkoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wYXJhbWV0ZXJzW2ldLmRhdGEgPSBhc3NldC5yZXNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWwuaW5pdChkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQub2ZmKFwibG9hZFwiLCBvbkN1YmVtYXBBc3NldExvYWQsIG1hdGVyaWFsKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQub24oXCJsb2FkXCIsIG9uQ3ViZW1hcEFzc2V0TG9hZCwgbWF0ZXJpYWwpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICBhc3NldHMubG9hZChhc3NldCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBtYXRlcmlhbC5pbml0KGRhdGEpO1xuICB9fTtcbiAgcmV0dXJuIHtNYXRlcmlhbEhhbmRsZXI6TWF0ZXJpYWxIYW5kbGVyLCBnZXRNYXRlcmlhbFBhcmFtVHlwZTpmdW5jdGlvbihuYW1lKSB7XG4gICAgcmV0dXJuIFBBUkFNRVRFUl9UWVBFU1tuYW1lXTtcbiAgfX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIE1vZGVsSGFuZGxlciA9IGZ1bmN0aW9uKGRldmljZSkge1xuICAgIHRoaXMuX2RldmljZSA9IGRldmljZTtcbiAgICB0aGlzLl9wYXJzZXJzID0gW107XG4gICAgdGhpcy5hZGRQYXJzZXIobmV3IHBjLkpzb25Nb2RlbFBhcnNlcih0aGlzLl9kZXZpY2UpLCBmdW5jdGlvbih1cmwsIGRhdGEpIHtcbiAgICAgIHJldHVybiBwYy5wYXRoLmdldEV4dGVuc2lvbih1cmwpID09PSBcIi5qc29uXCI7XG4gICAgfSk7XG4gIH07XG4gIE1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMID0gcGMuU2NlbmUuZGVmYXVsdE1hdGVyaWFsO1xuICBNb2RlbEhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICAgIHBjLmh0dHAuZ2V0KHVybCwgZnVuY3Rpb24oZXJyLCByZXNwb25zZSkge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBtb2RlbDogezB9IFt7MX1dXCIsIHVybCwgZXJyKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX3BhcnNlcnMubGVuZ3RoO2krKykge1xuICAgICAgdmFyIHAgPSB0aGlzLl9wYXJzZXJzW2ldO1xuICAgICAgaWYgKHAuZGVjaWRlcih1cmwsIGRhdGEpKSB7XG4gICAgICAgIHJldHVybiBwLnBhcnNlci5wYXJzZShkYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbG9nV0FSTklORyhwYy5zdHJpbmcuZm9ybWF0KFwiTm8gbW9kZWwgcGFyc2VyIGZvdW5kIGZvcjogezB9XCIsIHVybCkpO1xuICAgIHJldHVybiBudWxsO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gICAgaWYgKCFhc3NldC5yZXNvdXJjZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZGF0YSA9IGFzc2V0LmRhdGE7XG4gICAgYXNzZXQucmVzb3VyY2UubWVzaEluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKG1lc2hJbnN0YW5jZSwgaSkge1xuICAgICAgaWYgKGRhdGEubWFwcGluZykge1xuICAgICAgICB2YXIgaGFuZGxlTWF0ZXJpYWwgPSBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgIGlmIChhc3NldC5yZXNvdXJjZSkge1xuICAgICAgICAgICAgbWVzaEluc3RhbmNlLm1hdGVyaWFsID0gYXNzZXQucmVzb3VyY2U7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2V0Lm9uY2UoXCJsb2FkXCIsIGhhbmRsZU1hdGVyaWFsKTtcbiAgICAgICAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYXNzZXQub25jZShcInJlbW92ZVwiLCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICAgICAgaWYgKG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9PT0gYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgICAgICAgbWVzaEluc3RhbmNlLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGlmICghZGF0YS5tYXBwaW5nW2ldKSB7XG4gICAgICAgICAgbWVzaEluc3RhbmNlLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBpZCA9IGRhdGEubWFwcGluZ1tpXS5tYXRlcmlhbDtcbiAgICAgICAgdmFyIHVybCA9IGRhdGEubWFwcGluZ1tpXS5wYXRoO1xuICAgICAgICB2YXIgbWF0ZXJpYWw7XG4gICAgICAgIGlmIChpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgaWYgKCFpZCkge1xuICAgICAgICAgICAgbWVzaEluc3RhbmNlLm1hdGVyaWFsID0gcGMuTW9kZWxIYW5kbGVyLkRFRkFVTFRfTUFURVJJQUw7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1hdGVyaWFsID0gYXNzZXRzLmdldChpZCk7XG4gICAgICAgICAgICBpZiAobWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgaGFuZGxlTWF0ZXJpYWwobWF0ZXJpYWwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXNzZXRzLm9uY2UoXCJhZGQ6XCIgKyBpZCwgaGFuZGxlTWF0ZXJpYWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodXJsKSB7XG4gICAgICAgICAgICB2YXIgZmlsZVVybCA9IGFzc2V0LmdldEZpbGVVcmwoKTtcbiAgICAgICAgICAgIHZhciBkaXJVcmwgPSBwYy5wYXRoLmdldERpcmVjdG9yeShmaWxlVXJsKTtcbiAgICAgICAgICAgIHZhciBwYXRoID0gcGMucGF0aC5qb2luKGRpclVybCwgZGF0YS5tYXBwaW5nW2ldLnBhdGgpO1xuICAgICAgICAgICAgbWF0ZXJpYWwgPSBhc3NldHMuZ2V0QnlVcmwocGF0aCk7XG4gICAgICAgICAgICBpZiAobWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgaGFuZGxlTWF0ZXJpYWwobWF0ZXJpYWwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXNzZXRzLm9uY2UoXCJhZGQ6dXJsOlwiICsgcGF0aCwgaGFuZGxlTWF0ZXJpYWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9LCBhZGRQYXJzZXI6ZnVuY3Rpb24ocGFyc2VyLCBkZWNpZGVyKSB7XG4gICAgdGhpcy5fcGFyc2Vycy5wdXNoKHtwYXJzZXI6cGFyc2VyLCBkZWNpZGVyOmRlY2lkZXJ9KTtcbiAgfX07XG4gIHJldHVybiB7TW9kZWxIYW5kbGVyOk1vZGVsSGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjcmlwdEhhbmRsZXIgPSBmdW5jdGlvbihhcHApIHtcbiAgICB0aGlzLl9hcHAgPSBhcHA7XG4gICAgdGhpcy5fc2NyaXB0cyA9IHt9O1xuICAgIHRoaXMuX2NhY2hlID0ge307XG4gIH07XG4gIFNjcmlwdEhhbmRsZXIuX3R5cGVzID0gW107XG4gIFNjcmlwdEhhbmRsZXIuX3B1c2ggPSBmdW5jdGlvbihUeXBlKSB7XG4gICAgaWYgKHBjLnNjcmlwdC5sZWdhY3kgJiYgU2NyaXB0SGFuZGxlci5fdHlwZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc29sZS5hc3NlcnQoXCJTY3JpcHQgT3JkZXJpbmcgRXJyb3IuIENvbnRhY3Qgc3VwcG9ydEBwbGF5Y2FudmFzLmNvbVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgU2NyaXB0SGFuZGxlci5fdHlwZXMucHVzaChUeXBlKTtcbiAgICB9XG4gIH07XG4gIFNjcmlwdEhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBwYy5zY3JpcHQuYXBwID0gdGhpcy5fYXBwO1xuICAgIHRoaXMuX2xvYWRTY3JpcHQodXJsLCBmdW5jdGlvbihlcnIsIHVybCwgZXh0cmEpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGlmIChwYy5zY3JpcHQubGVnYWN5KSB7XG4gICAgICAgICAgdmFyIFR5cGUgPSBudWxsO1xuICAgICAgICAgIGlmIChTY3JpcHRIYW5kbGVyLl90eXBlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIFR5cGUgPSBTY3JpcHRIYW5kbGVyLl90eXBlcy5wb3AoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKFR5cGUpIHtcbiAgICAgICAgICAgIHRoaXMuX3NjcmlwdHNbdXJsXSA9IFR5cGU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIFR5cGUgPSBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBUeXBlLCBleHRyYSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdmFyIG9iaiA9IHt9O1xuICAgICAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBTY3JpcHRIYW5kbGVyLl90eXBlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICBvYmpbU2NyaXB0SGFuZGxlci5fdHlwZXNbaV0ubmFtZV0gPSBTY3JpcHRIYW5kbGVyLl90eXBlc1tpXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgU2NyaXB0SGFuZGxlci5fdHlwZXMubGVuZ3RoID0gMDtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBvYmosIGV4dHJhKTtcbiAgICAgICAgICBkZWxldGUgc2VsZi5fbG9hZGVyLl9jYWNoZVt1cmwgKyBcInNjcmlwdFwiXTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcykpO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHJldHVybiBkYXRhO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gIH0sIF9sb2FkU2NyaXB0OmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICB2YXIgaGVhZCA9IGRvY3VtZW50LmhlYWQ7XG4gICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic2NyaXB0XCIpO1xuICAgIHRoaXMuX2NhY2hlW3VybF0gPSBlbGVtZW50O1xuICAgIGVsZW1lbnQuYXN5bmMgPSBmYWxzZTtcbiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJlcnJvclwiLCBmdW5jdGlvbihlKSB7XG4gICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiU2NyaXB0OiB7MH0gZmFpbGVkIHRvIGxvYWRcIiwgZS50YXJnZXQuc3JjKSk7XG4gICAgfSwgZmFsc2UpO1xuICAgIHZhciBkb25lID0gZmFsc2U7XG4gICAgZWxlbWVudC5vbmxvYWQgPSBlbGVtZW50Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKCFkb25lICYmICghdGhpcy5yZWFkeVN0YXRlIHx8ICh0aGlzLnJlYWR5U3RhdGUgPT0gXCJsb2FkZWRcIiB8fCB0aGlzLnJlYWR5U3RhdGUgPT0gXCJjb21wbGV0ZVwiKSkpIHtcbiAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVybCwgZWxlbWVudCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBlbGVtZW50LnNyYyA9IHVybDtcbiAgICBoZWFkLmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICB9fTtcbiAgcmV0dXJuIHtTY3JpcHRIYW5kbGVyOlNjcmlwdEhhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBUZXh0SGFuZGxlciA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBUZXh0SGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyB0ZXh0IHJlc291cmNlOiB7MH0gW3sxfV1cIiwgdXJsLCBlcnIpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSwgb3BlbjpmdW5jdGlvbih1cmwsIGRhdGEpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfSwgcGF0Y2g6ZnVuY3Rpb24oYXNzZXQsIGFzc2V0cykge1xuICB9fTtcbiAgcmV0dXJuIHtUZXh0SGFuZGxlcjpUZXh0SGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEJpbmFyeUhhbmRsZXIgPSBmdW5jdGlvbigpIHtcbiAgfTtcbiAgQmluYXJ5SGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCB7cmVzcG9uc2VUeXBlOnBjLkh0dHAuUmVzcG9uc2VUeXBlLkFSUkFZX0JVRkZFUn0sIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKHBjLnN0cmluZy5mb3JtYXQoXCJFcnJvciBsb2FkaW5nIGJpbmFyeSByZXNvdXJjZTogezB9IFt7MX1dXCIsIHVybCwgZXJyKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH0sIHBhdGNoOmZ1bmN0aW9uKGFzc2V0LCBhc3NldHMpIHtcbiAgfX07XG4gIHJldHVybiB7QmluYXJ5SGFuZGxlcjpCaW5hcnlIYW5kbGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgSlNPTl9BRERSRVNTX01PREUgPSB7XCJyZXBlYXRcIjpwYy5BRERSRVNTX1JFUEVBVCwgXCJjbGFtcFwiOnBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRSwgXCJtaXJyb3JcIjpwYy5BRERSRVNTX01JUlJPUkVEX1JFUEVBVH07XG4gIHZhciBKU09OX0ZJTFRFUl9NT0RFID0ge1wibmVhcmVzdFwiOnBjLkZJTFRFUl9ORUFSRVNULCBcImxpbmVhclwiOnBjLkZJTFRFUl9MSU5FQVIsIFwibmVhcmVzdF9taXBfbmVhcmVzdFwiOnBjLkZJTFRFUl9ORUFSRVNUX01JUE1BUF9ORUFSRVNULCBcImxpbmVhcl9taXBfbmVhcmVzdFwiOnBjLkZJTFRFUl9MSU5FQVJfTUlQTUFQX05FQVJFU1QsIFwibmVhcmVzdF9taXBfbGluZWFyXCI6cGMuRklMVEVSX05FQVJFU1RfTUlQTUFQX0xJTkVBUiwgXCJsaW5lYXJfbWlwX2xpbmVhclwiOnBjLkZJTFRFUl9MSU5FQVJfTUlQTUFQX0xJTkVBUn07XG4gIGZ1bmN0aW9uIGFycmF5QnVmZmVyQ29weShzcmMsIGRzdCwgZHN0Qnl0ZU9mZnNldCwgbnVtQnl0ZXMpIHtcbiAgICB2YXIgaTtcbiAgICB2YXIgZHN0MzJPZmZzZXQgPSBkc3RCeXRlT2Zmc2V0IC8gNDtcbiAgICB2YXIgdGFpbCA9IG51bUJ5dGVzICUgNDtcbiAgICB2YXIgc3JjMzIgPSBuZXcgVWludDMyQXJyYXkoc3JjLmJ1ZmZlciwgMCwgKG51bUJ5dGVzIC0gdGFpbCkgLyA0KTtcbiAgICB2YXIgZHN0MzIgPSBuZXcgVWludDMyQXJyYXkoZHN0LmJ1ZmZlcik7XG4gICAgZm9yIChpID0gMDtpIDwgc3JjMzIubGVuZ3RoO2krKykge1xuICAgICAgZHN0MzJbZHN0MzJPZmZzZXQgKyBpXSA9IHNyYzMyW2ldO1xuICAgIH1cbiAgICBmb3IgKGkgPSBudW1CeXRlcyAtIHRhaWw7aSA8IG51bUJ5dGVzO2krKykge1xuICAgICAgZHN0W2RzdEJ5dGVPZmZzZXQgKyBpXSA9IHNyY1tpXTtcbiAgICB9XG4gIH1cbiAgdmFyIFRleHR1cmVIYW5kbGVyID0gZnVuY3Rpb24oZGV2aWNlLCBhc3NldHMsIGxvYWRlcikge1xuICAgIHRoaXMuX2RldmljZSA9IGRldmljZTtcbiAgICB0aGlzLl9hc3NldHMgPSBhc3NldHM7XG4gICAgdGhpcy5fbG9hZGVyID0gbG9hZGVyO1xuICAgIHRoaXMuY3Jvc3NPcmlnaW4gPSB1bmRlZmluZWQ7XG4gICAgaWYgKGFzc2V0cy5wcmVmaXgpIHtcbiAgICAgIHRoaXMuY3Jvc3NPcmlnaW4gPSBcImFub255bW91c1wiO1xuICAgIH1cbiAgfTtcbiAgVGV4dHVyZUhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgaW1hZ2U7XG4gICAgdmFyIHVybFdpdGhvdXRQYXJhbXMgPSB1cmwuaW5kZXhPZihcIj9cIikgPj0gMCA/IHVybC5zcGxpdChcIj9cIilbMF0gOiB1cmw7XG4gICAgdmFyIGV4dCA9IHBjLnBhdGguZ2V0RXh0ZW5zaW9uKHVybFdpdGhvdXRQYXJhbXMpLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKGV4dCA9PT0gXCIuZGRzXCIgfHwgZXh0ID09PSBcIi5jcm5cIikge1xuICAgICAgdmFyIG9wdGlvbnMgPSB7Y2FjaGU6dHJ1ZSwgcmVzcG9uc2VUeXBlOlwiYXJyYXlidWZmZXJcIn07XG4gICAgICBwYy5odHRwLmdldCh1cmwsIG9wdGlvbnMsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChleHQgPT09IFwiLmpwZ1wiIHx8IGV4dCA9PT0gXCIuanBlZ1wiIHx8IGV4dCA9PT0gXCIuZ2lmXCIgfHwgZXh0ID09PSBcIi5wbmdcIikge1xuICAgICAgICBpbWFnZSA9IG5ldyBJbWFnZTtcbiAgICAgICAgaWYgKHNlbGYuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCAmJiBwYy5BQlNPTFVURV9VUkwudGVzdCh1cmwpKSB7XG4gICAgICAgICAgaW1hZ2UuY3Jvc3NPcmlnaW4gPSBzZWxmLmNyb3NzT3JpZ2luO1xuICAgICAgICB9XG4gICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGltYWdlKTtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2Uub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgICAgY2FsbGJhY2socGMuc3RyaW5nLmZvcm1hdChcIkVycm9yIGxvYWRpbmcgVGV4dHVyZSBmcm9tOiAnezB9J1wiLCB1cmwpKTtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2Uuc3JjID0gdXJsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGJsb2JTdGFydCA9IHVybFdpdGhvdXRQYXJhbXMuaW5kZXhPZihcImJsb2I6XCIpO1xuICAgICAgICBpZiAoYmxvYlN0YXJ0ID49IDApIHtcbiAgICAgICAgICB1cmxXaXRob3V0UGFyYW1zID0gdXJsV2l0aG91dFBhcmFtcy5zdWJzdHIoYmxvYlN0YXJ0KTtcbiAgICAgICAgICB1cmwgPSB1cmxXaXRob3V0UGFyYW1zO1xuICAgICAgICAgIGltYWdlID0gbmV3IEltYWdlO1xuICAgICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgaW1hZ2UpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgaW1hZ2Uub25lcnJvciA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBUZXh0dXJlIGZyb206ICd7MH0nXCIsIHVybCkpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgaW1hZ2Uuc3JjID0gdXJsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBUZXh0dXJlOiBmb3JtYXQgbm90IHN1cHBvcnRlZDogJ3swfSdcIiwgZXh0KSk7XG4gICAgICAgICAgfSwgMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgaWYgKCF1cmwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciB0ZXh0dXJlO1xuICAgIHZhciBleHQgPSBwYy5wYXRoLmdldEV4dGVuc2lvbih1cmwpLnRvTG93ZXJDYXNlKCk7XG4gICAgdmFyIGZvcm1hdCA9IG51bGw7XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBJbWFnZSB8fCBkYXRhIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCkge1xuICAgICAgdmFyIGltZyA9IGRhdGE7XG4gICAgICBmb3JtYXQgPSBleHQgPT09IFwiLmpwZ1wiIHx8IGV4dCA9PT0gXCIuanBlZ1wiID8gcGMuUElYRUxGT1JNQVRfUjhfRzhfQjggOiBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BODtcbiAgICAgIHRleHR1cmUgPSBuZXcgcGMuVGV4dHVyZSh0aGlzLl9kZXZpY2UsIHt3aWR0aDppbWcud2lkdGgsIGhlaWdodDppbWcuaGVpZ2h0LCBmb3JtYXQ6Zm9ybWF0fSk7XG4gICAgICB0ZXh0dXJlLnNldFNvdXJjZShpbWcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7XG4gICAgICAgIGlmIChleHQgPT09IFwiLmNyblwiKSB7XG4gICAgICAgICAgdmFyIHNyY1NpemUgPSBkYXRhLmJ5dGVMZW5ndGg7XG4gICAgICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7XG4gICAgICAgICAgdmFyIHNyYyA9IE1vZHVsZS5fbWFsbG9jKHNyY1NpemUpO1xuICAgICAgICAgIGFycmF5QnVmZmVyQ29weShieXRlcywgTW9kdWxlLkhFQVBVOCwgc3JjLCBzcmNTaXplKTtcbiAgICAgICAgICB2YXIgZHN0ID0gTW9kdWxlLl9jcm5fZGVjb21wcmVzc19nZXRfZGF0YShzcmMsIHNyY1NpemUpO1xuICAgICAgICAgIHZhciBkc3RTaXplID0gTW9kdWxlLl9jcm5fZGVjb21wcmVzc19nZXRfc2l6ZShzcmMsIHNyY1NpemUpO1xuICAgICAgICAgIGRhdGEgPSBNb2R1bGUuSEVBUFU4LmJ1ZmZlci5zbGljZShkc3QsIGRzdCArIGRzdFNpemUpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBoZWFkZXIgPSBuZXcgVWludDMyQXJyYXkoZGF0YSwgMCwgMTI4IC8gNCk7XG4gICAgICAgIHZhciB3aWR0aCA9IGhlYWRlcls0XTtcbiAgICAgICAgdmFyIGhlaWdodCA9IGhlYWRlclszXTtcbiAgICAgICAgdmFyIG1pcHMgPSBNYXRoLm1heChoZWFkZXJbN10sIDEpO1xuICAgICAgICB2YXIgaXNGb3VyQ2MgPSBoZWFkZXJbMjBdID09PSA0O1xuICAgICAgICB2YXIgZmNjID0gaGVhZGVyWzIxXTtcbiAgICAgICAgdmFyIGJwcCA9IGhlYWRlclsyMl07XG4gICAgICAgIHZhciBpc0N1YmVtYXAgPSBoZWFkZXJbMjhdID09PSA2NTAyNDtcbiAgICAgICAgdmFyIEZDQ19EWFQxID0gODI3NjExMjA0O1xuICAgICAgICB2YXIgRkNDX0RYVDUgPSA4OTQ3MjAwNjg7XG4gICAgICAgIHZhciBGQ0NfRlAzMiA9IDExNjtcbiAgICAgICAgdmFyIEZDQ19FVEMxID0gODI2NDk2MDY5O1xuICAgICAgICB2YXIgRkNDX1BWUlRDXzJCUFBfUkdCXzEgPSA4MjU0Mzg4MDA7XG4gICAgICAgIHZhciBGQ0NfUFZSVENfMkJQUF9SR0JBXzEgPSA4MjU1MDQzMzY7XG4gICAgICAgIHZhciBGQ0NfUFZSVENfNEJQUF9SR0JfMSA9IDgyNTQzOTMxMjtcbiAgICAgICAgdmFyIEZDQ19QVlJUQ180QlBQX1JHQkFfMSA9IDgyNTUwNDg0ODtcbiAgICAgICAgdmFyIGNvbXByZXNzZWQgPSBmYWxzZTtcbiAgICAgICAgdmFyIGZsb2F0aW5nID0gZmFsc2U7XG4gICAgICAgIHZhciBldGMxID0gZmFsc2U7XG4gICAgICAgIHZhciBwdnJ0YzIgPSBmYWxzZTtcbiAgICAgICAgdmFyIHB2cnRjNCA9IGZhbHNlO1xuICAgICAgICBpZiAoaXNGb3VyQ2MpIHtcbiAgICAgICAgICBpZiAoZmNjID09PSBGQ0NfRFhUMSkge1xuICAgICAgICAgICAgZm9ybWF0ID0gcGMuUElYRUxGT1JNQVRfRFhUMTtcbiAgICAgICAgICAgIGNvbXByZXNzZWQgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZmNjID09PSBGQ0NfRFhUNSkge1xuICAgICAgICAgICAgICBmb3JtYXQgPSBwYy5QSVhFTEZPUk1BVF9EWFQ1O1xuICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChmY2MgPT09IEZDQ19GUDMyKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gcGMuUElYRUxGT1JNQVRfUkdCQTMyRjtcbiAgICAgICAgICAgICAgICBmbG9hdGluZyA9IHRydWU7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGZjYyA9PT0gRkNDX0VUQzEpIHtcbiAgICAgICAgICAgICAgICAgIGZvcm1hdCA9IHBjLlBJWEVMRk9STUFUX0VUQzE7XG4gICAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIGV0YzEgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBpZiAoZmNjID09PSBGQ0NfUFZSVENfMkJQUF9SR0JfMSB8fCBmY2MgPT09IEZDQ19QVlJUQ18yQlBQX1JHQkFfMSkge1xuICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBmY2MgPT09IEZDQ19QVlJUQ18yQlBQX1JHQl8xID8gcGMuUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JfMSA6IHBjLlBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCQV8xO1xuICAgICAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcHZydGMyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmY2MgPT09IEZDQ19QVlJUQ180QlBQX1JHQl8xIHx8IGZjYyA9PT0gRkNDX1BWUlRDXzRCUFBfUkdCQV8xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gZmNjID09PSBGQ0NfUFZSVENfNEJQUF9SR0JfMSA/IHBjLlBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCXzEgOiBwYy5QSVhFTEZPUk1BVF9QVlJUQ180QlBQX1JHQkFfMTtcbiAgICAgICAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICBwdnJ0YzQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChicHAgPT09IDMyKSB7XG4gICAgICAgICAgICBmb3JtYXQgPSBwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BODtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFmb3JtYXQpIHtcbiAgICAgICAgICB0ZXh0dXJlID0gbmV3IHBjLlRleHR1cmUodGhpcy5fZGV2aWNlLCB7d2lkdGg6NCwgaGVpZ2h0OjQsIGZvcm1hdDpwYy5QSVhFTEZPUk1BVF9SOF9HOF9COH0pO1xuICAgICAgICAgIHJldHVybiB0ZXh0dXJlO1xuICAgICAgICB9XG4gICAgICAgIHZhciB0ZXhPcHRpb25zID0ge3dpZHRoOndpZHRoLCBoZWlnaHQ6aGVpZ2h0LCBmb3JtYXQ6Zm9ybWF0LCBjdWJlbWFwOmlzQ3ViZW1hcH07XG4gICAgICAgIHRleHR1cmUgPSBuZXcgcGMuVGV4dHVyZSh0aGlzLl9kZXZpY2UsIHRleE9wdGlvbnMpO1xuICAgICAgICBpZiAoaXNDdWJlbWFwKSB7XG4gICAgICAgICAgdGV4dHVyZS5hZGRyZXNzVSA9IHBjLkFERFJFU1NfQ0xBTVBfVE9fRURHRTtcbiAgICAgICAgICB0ZXh0dXJlLmFkZHJlc3NWID0gcGMuQUREUkVTU19DTEFNUF9UT19FREdFO1xuICAgICAgICB9XG4gICAgICAgIHZhciBvZmZzZXQgPSAxMjg7XG4gICAgICAgIHZhciBmYWNlcyA9IGlzQ3ViZW1hcCA/IDYgOiAxO1xuICAgICAgICB2YXIgbWlwU2l6ZTtcbiAgICAgICAgdmFyIERYVF9CTE9DS19XSURUSCA9IDQ7XG4gICAgICAgIHZhciBEWFRfQkxPQ0tfSEVJR0hUID0gNDtcbiAgICAgICAgdmFyIGJsb2NrU2l6ZSA9IGZjYyA9PT0gRkNDX0RYVDEgPyA4IDogMTY7XG4gICAgICAgIHZhciBudW1CbG9ja3NBY3Jvc3MsIG51bUJsb2Nrc0Rvd24sIG51bUJsb2NrcztcbiAgICAgICAgZm9yICh2YXIgZmFjZSA9IDA7ZmFjZSA8IGZhY2VzO2ZhY2UrKykge1xuICAgICAgICAgIHZhciBtaXBXaWR0aCA9IHdpZHRoO1xuICAgICAgICAgIHZhciBtaXBIZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IG1pcHM7aSsrKSB7XG4gICAgICAgICAgICBpZiAoY29tcHJlc3NlZCkge1xuICAgICAgICAgICAgICBpZiAoZXRjMSkge1xuICAgICAgICAgICAgICAgIG1pcFNpemUgPSBNYXRoLmZsb29yKChtaXBXaWR0aCArIDMpIC8gNCkgKiBNYXRoLmZsb29yKChtaXBIZWlnaHQgKyAzKSAvIDQpICogODtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocHZydGMyKSB7XG4gICAgICAgICAgICAgICAgICBtaXBTaXplID0gTWF0aC5tYXgobWlwV2lkdGgsIDE2KSAqIE1hdGgubWF4KG1pcEhlaWdodCwgOCkgLyA0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBpZiAocHZydGM0KSB7XG4gICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBNYXRoLm1heChtaXBXaWR0aCwgOCkgKiBNYXRoLm1heChtaXBIZWlnaHQsIDgpIC8gMjtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG51bUJsb2Nrc0Fjcm9zcyA9IE1hdGguZmxvb3IoKG1pcFdpZHRoICsgRFhUX0JMT0NLX1dJRFRIIC0gMSkgLyBEWFRfQkxPQ0tfV0lEVEgpO1xuICAgICAgICAgICAgICAgICAgICBudW1CbG9ja3NEb3duID0gTWF0aC5mbG9vcigobWlwSGVpZ2h0ICsgRFhUX0JMT0NLX0hFSUdIVCAtIDEpIC8gRFhUX0JMT0NLX0hFSUdIVCk7XG4gICAgICAgICAgICAgICAgICAgIG51bUJsb2NrcyA9IG51bUJsb2Nrc0Fjcm9zcyAqIG51bUJsb2Nrc0Rvd247XG4gICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBudW1CbG9ja3MgKiBibG9ja1NpemU7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBtaXBTaXplID0gbWlwV2lkdGggKiBtaXBIZWlnaHQgKiA0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG1pcEJ1ZmYgPSBmbG9hdGluZyA/IG5ldyBGbG9hdDMyQXJyYXkoZGF0YSwgb2Zmc2V0LCBtaXBTaXplKSA6IG5ldyBVaW50OEFycmF5KGRhdGEsIG9mZnNldCwgbWlwU2l6ZSk7XG4gICAgICAgICAgICBpZiAoIWlzQ3ViZW1hcCkge1xuICAgICAgICAgICAgICB0ZXh0dXJlLl9sZXZlbHNbaV0gPSBtaXBCdWZmO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKCF0ZXh0dXJlLl9sZXZlbHNbaV0pIHtcbiAgICAgICAgICAgICAgICB0ZXh0dXJlLl9sZXZlbHNbaV0gPSBbXTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0ZXh0dXJlLl9sZXZlbHNbaV1bZmFjZV0gPSBtaXBCdWZmO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb2Zmc2V0ICs9IGZsb2F0aW5nID8gbWlwU2l6ZSAqIDQgOiBtaXBTaXplO1xuICAgICAgICAgICAgbWlwV2lkdGggPSBNYXRoLm1heChtaXBXaWR0aCAqIDAuNSwgMSk7XG4gICAgICAgICAgICBtaXBIZWlnaHQgPSBNYXRoLm1heChtaXBIZWlnaHQgKiAwLjUsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0ZXh0dXJlLnVwbG9hZCgpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGV4dHVyZTtcbiAgfSwgcGF0Y2g6ZnVuY3Rpb24oYXNzZXQsIGFzc2V0cykge1xuICAgIHZhciB0ZXh0dXJlID0gYXNzZXQucmVzb3VyY2U7XG4gICAgaWYgKCF0ZXh0dXJlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0ZXh0dXJlLm5hbWUgIT09IGFzc2V0Lm5hbWUpIHtcbiAgICAgIHRleHR1cmUubmFtZSA9IGFzc2V0Lm5hbWU7XG4gICAgfVxuICAgIGlmIChhc3NldC5kYXRhLmhhc093blByb3BlcnR5KFwibWluZmlsdGVyXCIpICYmIHRleHR1cmUubWluRmlsdGVyICE9PSBKU09OX0ZJTFRFUl9NT0RFW2Fzc2V0LmRhdGEubWluZmlsdGVyXSkge1xuICAgICAgdGV4dHVyZS5taW5GaWx0ZXIgPSBKU09OX0ZJTFRFUl9NT0RFW2Fzc2V0LmRhdGEubWluZmlsdGVyXTtcbiAgICB9XG4gICAgaWYgKGFzc2V0LmRhdGEuaGFzT3duUHJvcGVydHkoXCJtYWdmaWx0ZXJcIikgJiYgdGV4dHVyZS5tYWdGaWx0ZXIgIT09IEpTT05fRklMVEVSX01PREVbYXNzZXQuZGF0YS5tYWdmaWx0ZXJdKSB7XG4gICAgICB0ZXh0dXJlLm1hZ0ZpbHRlciA9IEpTT05fRklMVEVSX01PREVbYXNzZXQuZGF0YS5tYWdmaWx0ZXJdO1xuICAgIH1cbiAgICBpZiAoYXNzZXQuZGF0YS5oYXNPd25Qcm9wZXJ0eShcImFkZHJlc3N1XCIpICYmIHRleHR1cmUuYWRkcmVzc1UgIT09IEpTT05fQUREUkVTU19NT0RFW2Fzc2V0LmRhdGEuYWRkcmVzc3VdKSB7XG4gICAgICB0ZXh0dXJlLmFkZHJlc3NVID0gSlNPTl9BRERSRVNTX01PREVbYXNzZXQuZGF0YS5hZGRyZXNzdV07XG4gICAgfVxuICAgIGlmIChhc3NldC5kYXRhLmhhc093blByb3BlcnR5KFwiYWRkcmVzc3ZcIikgJiYgdGV4dHVyZS5hZGRyZXNzViAhPT0gSlNPTl9BRERSRVNTX01PREVbYXNzZXQuZGF0YS5hZGRyZXNzdl0pIHtcbiAgICAgIHRleHR1cmUuYWRkcmVzc1YgPSBKU09OX0FERFJFU1NfTU9ERVthc3NldC5kYXRhLmFkZHJlc3N2XTtcbiAgICB9XG4gICAgaWYgKGFzc2V0LmRhdGEuaGFzT3duUHJvcGVydHkoXCJtaXBtYXBzXCIpICYmIHRleHR1cmUubWlwbWFwcyAhPT0gYXNzZXQuZGF0YS5taXBtYXBzKSB7XG4gICAgICB0ZXh0dXJlLm1pcG1hcHMgPSBhc3NldC5kYXRhLm1pcG1hcHM7XG4gICAgfVxuICAgIGlmIChhc3NldC5kYXRhLmhhc093blByb3BlcnR5KFwiYW5pc290cm9weVwiKSAmJiB0ZXh0dXJlLmFuaXNvdHJvcHkgIT09IGFzc2V0LmRhdGEuYW5pc290cm9weSkge1xuICAgICAgdGV4dHVyZS5hbmlzb3Ryb3B5ID0gYXNzZXQuZGF0YS5hbmlzb3Ryb3B5O1xuICAgIH1cbiAgICB2YXIgcmdibSA9ICEhYXNzZXQuZGF0YS5yZ2JtO1xuICAgIGlmIChhc3NldC5kYXRhLmhhc093blByb3BlcnR5KFwicmdibVwiKSAmJiB0ZXh0dXJlLnJnYm0gIT09IHJnYm0pIHtcbiAgICAgIHRleHR1cmUucmdibSA9IHJnYm07XG4gICAgfVxuICB9fTtcbiAgcmV0dXJuIHtUZXh0dXJlSGFuZGxlcjpUZXh0dXJlSGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEh0bWxIYW5kbGVyID0gZnVuY3Rpb24oKSB7XG4gIH07XG4gIEh0bWxIYW5kbGVyLnByb3RvdHlwZSA9IHtsb2FkOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICBwYy5odHRwLmdldCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKHBjLnN0cmluZy5mb3JtYXQoXCJFcnJvciBsb2FkaW5nIGh0bWwgcmVzb3VyY2U6IHswfSBbezF9XVwiLCB1cmwsIGVycikpO1xuICAgICAgfVxuICAgIH0pO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHJldHVybiBkYXRhO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gIH19O1xuICByZXR1cm4ge0h0bWxIYW5kbGVyOkh0bWxIYW5kbGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgQ3NzSGFuZGxlciA9IGZ1bmN0aW9uKCkge1xuICB9O1xuICBDc3NIYW5kbGVyLnByb3RvdHlwZSA9IHtsb2FkOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICBwYy5odHRwLmdldCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKHBjLnN0cmluZy5mb3JtYXQoXCJFcnJvciBsb2FkaW5nIGNzcyByZXNvdXJjZTogezB9IFt7MX1dXCIsIHVybCwgZXJyKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sIG9wZW46ZnVuY3Rpb24odXJsLCBkYXRhKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH0sIHBhdGNoOmZ1bmN0aW9uKGFzc2V0LCBhc3NldHMpIHtcbiAgfX07XG4gIHZhciBjcmVhdGVTdHlsZSA9IGZ1bmN0aW9uKGNzc1N0cmluZykge1xuICAgIHZhciByZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIik7XG4gICAgcmVzdWx0LnR5cGUgPSBcInRleHQvY3NzXCI7XG4gICAgaWYgKHJlc3VsdC5zdHlsZVNoZWV0KSB7XG4gICAgICByZXN1bHQuc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzU3RyaW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY3NzU3RyaW5nKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG4gIHJldHVybiB7Q3NzSGFuZGxlcjpDc3NIYW5kbGVyLCBjcmVhdGVTdHlsZTpjcmVhdGVTdHlsZX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNoYWRlckhhbmRsZXIgPSBmdW5jdGlvbigpIHtcbiAgfTtcbiAgU2hhZGVySGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhwYy5zdHJpbmcuZm9ybWF0KFwiRXJyb3IgbG9hZGluZyBzaGFkZXIgcmVzb3VyY2U6IHswfSBbezF9XVwiLCB1cmwsIGVycikpO1xuICAgICAgfVxuICAgIH0pO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHJldHVybiBkYXRhO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gIH19O1xuICByZXR1cm4ge1NoYWRlckhhbmRsZXI6U2hhZGVySGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjZW5lSGFuZGxlciA9IGZ1bmN0aW9uKGFwcCkge1xuICAgIHRoaXMuX2FwcCA9IGFwcDtcbiAgfTtcbiAgU2NlbmVIYW5kbGVyLnByb3RvdHlwZSA9IHtsb2FkOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICBwYy5odHRwLmdldCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKFwiRXJyb3IgcmVxdWVzdGluZyBzY2VuZTogXCIgKyB1cmwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHRoaXMuX2FwcC5zeXN0ZW1zLnNjcmlwdC5wcmVsb2FkaW5nID0gdHJ1ZTtcbiAgICB2YXIgcGFyc2VyID0gbmV3IHBjLlNjZW5lUGFyc2VyKHRoaXMuX2FwcCk7XG4gICAgdmFyIHBhcmVudCA9IHBhcnNlci5wYXJzZShkYXRhKTtcbiAgICB2YXIgc2NlbmUgPSB0aGlzLl9hcHAuc2NlbmU7XG4gICAgc2NlbmUucm9vdCA9IHBhcmVudDtcbiAgICB0aGlzLl9hcHAuYXBwbHlTY2VuZVNldHRpbmdzKGRhdGEuc2V0dGluZ3MpO1xuICAgIHRoaXMuX2FwcC5zeXN0ZW1zLnNjcmlwdC5wcmVsb2FkaW5nID0gZmFsc2U7XG4gICAgcmV0dXJuIHNjZW5lO1xuICB9LCBwYXRjaDpmdW5jdGlvbihhc3NldCwgYXNzZXRzKSB7XG4gIH19O1xuICByZXR1cm4ge1NjZW5lSGFuZGxlcjpTY2VuZUhhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBIaWVyYXJjaHlIYW5kbGVyID0gZnVuY3Rpb24oYXBwKSB7XG4gICAgdGhpcy5fYXBwID0gYXBwO1xuICB9O1xuICBIaWVyYXJjaHlIYW5kbGVyLnByb3RvdHlwZSA9IHtsb2FkOmZ1bmN0aW9uKHVybCwgY2FsbGJhY2spIHtcbiAgICBwYy5odHRwLmdldCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHtcbiAgICAgIGlmICghZXJyKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKFwiRXJyb3IgcmVxdWVzdGluZyBzY2VuZTogXCIgKyB1cmwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHRoaXMuX2FwcC5zeXN0ZW1zLnNjcmlwdC5wcmVsb2FkaW5nID0gdHJ1ZTtcbiAgICB2YXIgcGFyc2VyID0gbmV3IHBjLlNjZW5lUGFyc2VyKHRoaXMuX2FwcCk7XG4gICAgdmFyIHBhcmVudCA9IHBhcnNlci5wYXJzZShkYXRhKTtcbiAgICB0aGlzLl9hcHAuc3lzdGVtcy5zY3JpcHQucHJlbG9hZGluZyA9IGZhbHNlO1xuICAgIHJldHVybiBwYXJlbnQ7XG4gIH19O1xuICByZXR1cm4ge0hpZXJhcmNoeUhhbmRsZXI6SGllcmFyY2h5SGFuZGxlcn07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIFNjZW5lU2V0dGluZ3NIYW5kbGVyID0gZnVuY3Rpb24oYXBwKSB7XG4gICAgdGhpcy5fYXBwID0gYXBwO1xuICB9O1xuICBTY2VuZVNldHRpbmdzSGFuZGxlci5wcm90b3R5cGUgPSB7bG9hZDpmdW5jdGlvbih1cmwsIGNhbGxiYWNrKSB7XG4gICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhcIkVycm9yIHJlcXVlc3Rpbmcgc2NlbmU6IFwiICsgdXJsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSwgb3BlbjpmdW5jdGlvbih1cmwsIGRhdGEpIHtcbiAgICByZXR1cm4gZGF0YS5zZXR0aW5ncztcbiAgfX07XG4gIHJldHVybiB7U2NlbmVTZXR0aW5nc0hhbmRsZXI6U2NlbmVTZXR0aW5nc0hhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBGb2xkZXJIYW5kbGVyID0gZnVuY3Rpb24oKSB7XG4gIH07XG4gIEZvbGRlckhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaykge1xuICAgIGNhbGxiYWNrKG51bGwsIG51bGwpO1xuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSkge1xuICAgIHJldHVybiBkYXRhO1xuICB9fTtcbiAgcmV0dXJuIHtGb2xkZXJIYW5kbGVyOkZvbGRlckhhbmRsZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBGb250SGFuZGxlciA9IGZ1bmN0aW9uKGxvYWRlcikge1xuICAgIHRoaXMuX2xvYWRlciA9IGxvYWRlcjtcbiAgfTtcbiAgRm9udEhhbmRsZXIucHJvdG90eXBlID0ge2xvYWQ6ZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYXNzZXQpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgaWYgKHBjLnBhdGguZ2V0RXh0ZW5zaW9uKHVybCkgPT09IFwiLmpzb25cIikge1xuICAgICAgcGMuaHR0cC5nZXQodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlKSB7XG4gICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgc2VsZi5fbG9hZFRleHR1cmVzKHVybC5yZXBsYWNlKFwiLmpzb25cIiwgXCIucG5nXCIpLCByZXNwb25zZSwgZnVuY3Rpb24oZXJyLCB0ZXh0dXJlcykge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHtkYXRhOnJlc3BvbnNlLCB0ZXh0dXJlczp0ZXh0dXJlc30pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNhbGxiYWNrKHBjLnN0cmluZy5mb3JtYXQoXCJFcnJvciBsb2FkaW5nIGZvbnQgcmVzb3VyY2U6IHswfSBbezF9XVwiLCB1cmwsIGVycikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbG9hZFRleHR1cmVzKHVybCwgYXNzZXQgJiYgYXNzZXQuZGF0YSwgY2FsbGJhY2spO1xuICAgIH1cbiAgfSwgX2xvYWRUZXh0dXJlczpmdW5jdGlvbih1cmwsIGRhdGEsIGNhbGxiYWNrKSB7XG4gICAgdmFyIG51bVRleHR1cmVzID0gMTtcbiAgICB2YXIgbnVtTG9hZGVkID0gMDtcbiAgICB2YXIgZXJyb3IgPSBudWxsO1xuICAgIGlmIChkYXRhICYmIGRhdGEudmVyc2lvbiA+PSAyKSB7XG4gICAgICBudW1UZXh0dXJlcyA9IGRhdGEuaW5mby5tYXBzLmxlbmd0aDtcbiAgICB9XG4gICAgdmFyIHRleHR1cmVzID0gbmV3IEFycmF5KG51bVRleHR1cmVzKTtcbiAgICB2YXIgbG9hZGVyID0gdGhpcy5fbG9hZGVyO1xuICAgIHZhciBsb2FkVGV4dHVyZSA9IGZ1bmN0aW9uKGluZGV4KSB7XG4gICAgICB2YXIgb25Mb2FkZWQgPSBmdW5jdGlvbihlcnIsIHRleHR1cmUpIHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBlcnJvciA9IGVycjtcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfVxuICAgICAgICB0ZXh0dXJlLnVwbG9hZCgpO1xuICAgICAgICB0ZXh0dXJlc1tpbmRleF0gPSB0ZXh0dXJlO1xuICAgICAgICBudW1Mb2FkZWQrKztcbiAgICAgICAgaWYgKG51bUxvYWRlZCA9PT0gbnVtVGV4dHVyZXMpIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCB0ZXh0dXJlcyk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgbG9hZGVyLmxvYWQodXJsLCBcInRleHR1cmVcIiwgb25Mb2FkZWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9hZGVyLmxvYWQodXJsLnJlcGxhY2UoXCIucG5nXCIsIGluZGV4ICsgXCIucG5nXCIpLCBcInRleHR1cmVcIiwgb25Mb2FkZWQpO1xuICAgICAgfVxuICAgIH07XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG51bVRleHR1cmVzO2krKykge1xuICAgICAgbG9hZFRleHR1cmUoaSk7XG4gICAgfVxuICB9LCBvcGVuOmZ1bmN0aW9uKHVybCwgZGF0YSwgYXNzZXQpIHtcbiAgICB2YXIgZm9udDtcbiAgICBpZiAoZGF0YS50ZXh0dXJlcykge1xuICAgICAgZm9udCA9IG5ldyBwYy5Gb250KGRhdGEudGV4dHVyZXMsIGRhdGEuZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvbnQgPSBuZXcgcGMuRm9udChkYXRhLCBudWxsKTtcbiAgICB9XG4gICAgcmV0dXJuIGZvbnQ7XG4gIH0sIHBhdGNoOmZ1bmN0aW9uKGFzc2V0LCBhc3NldHMpIHtcbiAgICB2YXIgZm9udCA9IGFzc2V0LnJlc291cmNlO1xuICAgIGlmICghZm9udC5kYXRhICYmIGFzc2V0LmRhdGEpIHtcbiAgICAgIGZvbnQuZGF0YSA9IGFzc2V0LmRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghYXNzZXQuZGF0YSAmJiBmb250LmRhdGEpIHtcbiAgICAgICAgYXNzZXQuZGF0YSA9IGZvbnQuZGF0YTtcbiAgICAgIH1cbiAgICB9XG4gIH19O1xuICByZXR1cm4ge0ZvbnRIYW5kbGVyOkZvbnRIYW5kbGVyfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgSlNPTl9QUklNSVRJVkVfVFlQRSA9IHtcInBvaW50c1wiOnBjLlBSSU1JVElWRV9QT0lOVFMsIFwibGluZXNcIjpwYy5QUklNSVRJVkVfTElORVMsIFwibGluZWxvb3BcIjpwYy5QUklNSVRJVkVfTElORUxPT1AsIFwibGluZXN0cmlwXCI6cGMuUFJJTUlUSVZFX0xJTkVTVFJJUCwgXCJ0cmlhbmdsZXNcIjpwYy5QUklNSVRJVkVfVFJJQU5HTEVTLCBcInRyaWFuZ2xlc3RyaXBcIjpwYy5QUklNSVRJVkVfVFJJU1RSSVAsIFwidHJpYW5nbGVmYW5cIjpwYy5QUklNSVRJVkVfVFJJRkFOfTtcbiAgdmFyIEpTT05fVkVSVEVYX0VMRU1FTlRfVFlQRSA9IHtcImludDhcIjpwYy5UWVBFX0lOVDgsIFwidWludDhcIjpwYy5UWVBFX1VJTlQ4LCBcImludDE2XCI6cGMuVFlQRV9JTlQxNiwgXCJ1aW50MTZcIjpwYy5UWVBFX1VJTlQxNiwgXCJpbnQzMlwiOnBjLlRZUEVfSU5UMzIsIFwidWludDMyXCI6cGMuVFlQRV9VSU5UMzIsIFwiZmxvYXQzMlwiOnBjLlRZUEVfRkxPQVQzMn07XG4gIHZhciBKc29uTW9kZWxQYXJzZXIgPSBmdW5jdGlvbihkZXZpY2UpIHtcbiAgICB0aGlzLl9kZXZpY2UgPSBkZXZpY2U7XG4gIH07XG4gIEpzb25Nb2RlbFBhcnNlci5wcm90b3R5cGUgPSB7cGFyc2U6ZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBtb2RlbERhdGEgPSBkYXRhLm1vZGVsO1xuICAgIGlmICghbW9kZWxEYXRhKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKG1vZGVsRGF0YS52ZXJzaW9uIDw9IDEpIHtcbiAgICAgIGxvZ0VSUk9SKHBjLnN0cmluZy5mb3JtYXQoXCJUcnlpbmcgdG8gcGFyc2UgdW5zdXBwb3J0ZWQgbW9kZWwgZm9ybWF0LlwiKSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgdmFyIG5vZGVzID0gdGhpcy5fcGFyc2VOb2RlcyhkYXRhKTtcbiAgICB2YXIgc2tpbnMgPSB0aGlzLl9wYXJzZVNraW5zKGRhdGEsIG5vZGVzKTtcbiAgICB2YXIgbW9ycGhzID0gdGhpcy5fcGFyc2VNb3JwaHMoZGF0YSwgbm9kZXMpO1xuICAgIHZhciB2ZXJ0ZXhCdWZmZXJzID0gdGhpcy5fcGFyc2VWZXJ0ZXhCdWZmZXJzKGRhdGEpO1xuICAgIHZhciBpbmRpY2VzID0gdGhpcy5fcGFyc2VJbmRleEJ1ZmZlcnMoZGF0YSwgdmVydGV4QnVmZmVycyk7XG4gICAgdmFyIG1lc2hlcyA9IHRoaXMuX3BhcnNlTWVzaGVzKGRhdGEsIHNraW5zLnNraW5zLCBtb3JwaHMubW9ycGhzLCB2ZXJ0ZXhCdWZmZXJzLCBpbmRpY2VzLmJ1ZmZlciwgaW5kaWNlcy5kYXRhKTtcbiAgICB0aGlzLl9pbml0TW9ycGhzKGRhdGEsIG1vcnBocy5tb3JwaHMsIHZlcnRleEJ1ZmZlcnMsIG1lc2hlcyk7XG4gICAgdmFyIG1lc2hJbnN0YW5jZXMgPSB0aGlzLl9wYXJzZU1lc2hJbnN0YW5jZXMoZGF0YSwgbm9kZXMsIG1lc2hlcywgc2tpbnMuc2tpbnMsIHNraW5zLmluc3RhbmNlcywgbW9ycGhzLm1vcnBocywgbW9ycGhzLmluc3RhbmNlcyk7XG4gICAgdmFyIG1vZGVsID0gbmV3IHBjLk1vZGVsO1xuICAgIG1vZGVsLmdyYXBoID0gbm9kZXNbMF07XG4gICAgbW9kZWwubWVzaEluc3RhbmNlcyA9IG1lc2hJbnN0YW5jZXM7XG4gICAgbW9kZWwuc2tpbkluc3RhbmNlcyA9IHNraW5zLmluc3RhbmNlcztcbiAgICBtb2RlbC5tb3JwaEluc3RhbmNlcyA9IG1vcnBocy5pbnN0YW5jZXM7XG4gICAgbW9kZWwuZ2V0R3JhcGgoKS5zeW5jSGllcmFyY2h5KCk7XG4gICAgcmV0dXJuIG1vZGVsO1xuICB9LCBfcGFyc2VOb2RlczpmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIG1vZGVsRGF0YSA9IGRhdGEubW9kZWw7XG4gICAgdmFyIG5vZGVzID0gW107XG4gICAgdmFyIGk7XG4gICAgZm9yIChpID0gMDtpIDwgbW9kZWxEYXRhLm5vZGVzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBub2RlRGF0YSA9IG1vZGVsRGF0YS5ub2Rlc1tpXTtcbiAgICAgIHZhciBub2RlID0gbmV3IHBjLkdyYXBoTm9kZTtcbiAgICAgIG5vZGUuc2V0TmFtZShub2RlRGF0YS5uYW1lKTtcbiAgICAgIG5vZGUuc2V0TG9jYWxQb3NpdGlvbihub2RlRGF0YS5wb3NpdGlvblswXSwgbm9kZURhdGEucG9zaXRpb25bMV0sIG5vZGVEYXRhLnBvc2l0aW9uWzJdKTtcbiAgICAgIG5vZGUuc2V0TG9jYWxFdWxlckFuZ2xlcyhub2RlRGF0YS5yb3RhdGlvblswXSwgbm9kZURhdGEucm90YXRpb25bMV0sIG5vZGVEYXRhLnJvdGF0aW9uWzJdKTtcbiAgICAgIG5vZGUuc2V0TG9jYWxTY2FsZShub2RlRGF0YS5zY2FsZVswXSwgbm9kZURhdGEuc2NhbGVbMV0sIG5vZGVEYXRhLnNjYWxlWzJdKTtcbiAgICAgIG5vZGUuc2NhbGVDb21wZW5zYXRpb24gPSAhIW5vZGVEYXRhLnNjYWxlQ29tcGVuc2F0aW9uO1xuICAgICAgbm9kZXMucHVzaChub2RlKTtcbiAgICB9XG4gICAgZm9yIChpID0gMTtpIDwgbW9kZWxEYXRhLnBhcmVudHMubGVuZ3RoO2krKykge1xuICAgICAgbm9kZXNbbW9kZWxEYXRhLnBhcmVudHNbaV1dLmFkZENoaWxkKG5vZGVzW2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGVzO1xuICB9LCBfcGFyc2VTa2luczpmdW5jdGlvbihkYXRhLCBub2Rlcykge1xuICAgIHZhciBtb2RlbERhdGEgPSBkYXRhLm1vZGVsO1xuICAgIHZhciBza2lucyA9IFtdO1xuICAgIHZhciBza2luSW5zdGFuY2VzID0gW107XG4gICAgdmFyIGksIGo7XG4gICAgaWYgKCF0aGlzLl9kZXZpY2Uuc3VwcG9ydHNCb25lVGV4dHVyZXMgJiYgbW9kZWxEYXRhLnNraW5zLmxlbmd0aCA+IDApIHtcbiAgICAgIHZhciBib25lTGltaXQgPSB0aGlzLl9kZXZpY2UuZ2V0Qm9uZUxpbWl0KCk7XG4gICAgICBwYy5wYXJ0aXRpb25Ta2luKG1vZGVsRGF0YSwgbnVsbCwgYm9uZUxpbWl0KTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbW9kZWxEYXRhLnNraW5zLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBza2luRGF0YSA9IG1vZGVsRGF0YS5za2luc1tpXTtcbiAgICAgIHZhciBpbnZlcnNlQmluZE1hdHJpY2VzID0gW107XG4gICAgICBmb3IgKGogPSAwO2ogPCBza2luRGF0YS5pbnZlcnNlQmluZE1hdHJpY2VzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgdmFyIGlibSA9IHNraW5EYXRhLmludmVyc2VCaW5kTWF0cmljZXNbal07XG4gICAgICAgIGludmVyc2VCaW5kTWF0cmljZXNbal0gPSBuZXcgcGMuTWF0NChpYm1bMF0sIGlibVsxXSwgaWJtWzJdLCBpYm1bM10sIGlibVs0XSwgaWJtWzVdLCBpYm1bNl0sIGlibVs3XSwgaWJtWzhdLCBpYm1bOV0sIGlibVsxMF0sIGlibVsxMV0sIGlibVsxMl0sIGlibVsxM10sIGlibVsxNF0sIGlibVsxNV0pO1xuICAgICAgfVxuICAgICAgdmFyIHNraW4gPSBuZXcgcGMuU2tpbih0aGlzLl9kZXZpY2UsIGludmVyc2VCaW5kTWF0cmljZXMsIHNraW5EYXRhLmJvbmVOYW1lcyk7XG4gICAgICBza2lucy5wdXNoKHNraW4pO1xuICAgICAgdmFyIHNraW5JbnN0YW5jZSA9IG5ldyBwYy5Ta2luSW5zdGFuY2Uoc2tpbiwgbm9kZXNbMF0pO1xuICAgICAgdmFyIGJvbmVzID0gW107XG4gICAgICBmb3IgKGogPSAwO2ogPCBza2luLmJvbmVOYW1lcy5sZW5ndGg7aisrKSB7XG4gICAgICAgIHZhciBib25lTmFtZSA9IHNraW4uYm9uZU5hbWVzW2pdO1xuICAgICAgICB2YXIgYm9uZSA9IG5vZGVzWzBdLmZpbmRCeU5hbWUoYm9uZU5hbWUpO1xuICAgICAgICBib25lcy5wdXNoKGJvbmUpO1xuICAgICAgfVxuICAgICAgc2tpbkluc3RhbmNlLmJvbmVzID0gYm9uZXM7XG4gICAgICBza2luSW5zdGFuY2VzLnB1c2goc2tpbkluc3RhbmNlKTtcbiAgICB9XG4gICAgcmV0dXJuIHtza2luczpza2lucywgaW5zdGFuY2VzOnNraW5JbnN0YW5jZXN9O1xuICB9LCBfcGFyc2VNb3JwaHM6ZnVuY3Rpb24oZGF0YSwgbm9kZXMpIHtcbiAgICB2YXIgbW9kZWxEYXRhID0gZGF0YS5tb2RlbDtcbiAgICB2YXIgbW9ycGhzID0gW107XG4gICAgdmFyIG1vcnBoSW5zdGFuY2VzID0gW107XG4gICAgdmFyIGksIGosIGs7XG4gICAgdmFyIHRhcmdldHMsIG1vcnBoVGFyZ2V0LCBtb3JwaFRhcmdldEFycmF5O1xuICAgIGlmIChtb2RlbERhdGEubW9ycGhzKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBtb2RlbERhdGEubW9ycGhzLmxlbmd0aDtpKyspIHtcbiAgICAgICAgdGFyZ2V0cyA9IG1vZGVsRGF0YS5tb3JwaHNbaV0udGFyZ2V0cztcbiAgICAgICAgbW9ycGhUYXJnZXRBcnJheSA9IFtdO1xuICAgICAgICBmb3IgKGogPSAwO2ogPCB0YXJnZXRzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICB2YXIgdGFyZ2V0QWFiYiA9IHRhcmdldHNbal0uYWFiYjtcbiAgICAgICAgICB2YXIgbWluID0gdGFyZ2V0QWFiYi5taW47XG4gICAgICAgICAgdmFyIG1heCA9IHRhcmdldEFhYmIubWF4O1xuICAgICAgICAgIHZhciBhYWJiID0gbmV3IHBjLkJvdW5kaW5nQm94KG5ldyBwYy5WZWMzKChtYXhbMF0gKyBtaW5bMF0pICogMC41LCAobWF4WzFdICsgbWluWzFdKSAqIDAuNSwgKG1heFsyXSArIG1pblsyXSkgKiAwLjUpLCBuZXcgcGMuVmVjMygobWF4WzBdIC0gbWluWzBdKSAqIDAuNSwgKG1heFsxXSAtIG1pblsxXSkgKiAwLjUsIChtYXhbMl0gLSBtaW5bMl0pICogMC41KSk7XG4gICAgICAgICAgbW9ycGhUYXJnZXQgPSBuZXcgcGMuTW9ycGhUYXJnZXQoe2luZGljZXM6dGFyZ2V0c1tqXS5pbmRpY2VzLCBkZWx0YVBvc2l0aW9uczp0YXJnZXRzW2pdLmRlbHRhUG9zaXRpb25zLCBkZWx0YU5vcm1hbHM6dGFyZ2V0c1tqXS5kZWx0YU5vcm1hbHMsIG5hbWU6dGFyZ2V0c1tqXS5uYW1lLCBhYWJiOmFhYmJ9KTtcbiAgICAgICAgICBtb3JwaFRhcmdldEFycmF5LnB1c2gobW9ycGhUYXJnZXQpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBtb3JwaCA9IG5ldyBwYy5Nb3JwaChtb3JwaFRhcmdldEFycmF5KTtcbiAgICAgICAgbW9ycGhzLnB1c2gobW9ycGgpO1xuICAgICAgICB2YXIgbW9ycGhJbnN0YW5jZSA9IG5ldyBwYy5Nb3JwaEluc3RhbmNlKG1vcnBoKTtcbiAgICAgICAgbW9ycGhJbnN0YW5jZXMucHVzaChtb3JwaEluc3RhbmNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHttb3JwaHM6bW9ycGhzLCBpbnN0YW5jZXM6bW9ycGhJbnN0YW5jZXN9O1xuICB9LCBfY2FsY3VsYXRlVGFuZ2VudHNNb3JwaFRhcmdldDpmdW5jdGlvbihwb3NpdGlvbnMsIG5vcm1hbHMsIHV2cywgaW5kaWNlcywgdGFuMSwgdGFuMiwgbXRJbmRpY2VzLCB0YW5nZW50cykge1xuICAgIHZhciBzZGlyeCwgc2RpcnksIHNkaXJ6O1xuICAgIHZhciB0ZGlyeCwgdGRpcnksIHRkaXJ6O1xuICAgIHZhciB2MXgsIHYxeSwgdjF6O1xuICAgIHZhciB2MngsIHYyeSwgdjJ6O1xuICAgIHZhciB2M3gsIHYzeSwgdjN6O1xuICAgIHZhciB3MXgsIHcxeTtcbiAgICB2YXIgdzJ4LCB3Mnk7XG4gICAgdmFyIHczeCwgdzN5O1xuICAgIHZhciB0MXgsIHQxeSwgdDF6O1xuICAgIHZhciB0MngsIHQyeSwgdDJ6O1xuICAgIHZhciBueCwgbnksIG56O1xuICAgIHZhciB0cmlhbmdsZUNvdW50O1xuICAgIHZhciB2ZXJ0ZXhDb3VudDtcbiAgICB2YXIgaTEsIGkyLCBpMztcbiAgICB2YXIgeDEsIHgyLCB5MSwgeTIsIHoxLCB6MiwgczEsIHMyLCB0MSwgdDIsIHI7XG4gICAgdmFyIGksIGo7XG4gICAgdmFyIGFyZWEsIG5kb3R0LCBtdEluZGV4Q291bnQsIGxlbjtcbiAgICB0cmlhbmdsZUNvdW50ID0gaW5kaWNlcy5sZW5ndGggLyAzO1xuICAgIHZlcnRleENvdW50ID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7XG4gICAgYXJlYSA9IDAuMDtcbiAgICBmb3IgKGkgPSAwO2kgPCB0cmlhbmdsZUNvdW50O2krKykge1xuICAgICAgaTEgPSBpbmRpY2VzW2kgKiAzXTtcbiAgICAgIGkyID0gaW5kaWNlc1tpICogMyArIDFdO1xuICAgICAgaTMgPSBpbmRpY2VzW2kgKiAzICsgMl07XG4gICAgICB2MXggPSBwb3NpdGlvbnNbaTEgKiAzXTtcbiAgICAgIHYxeSA9IHBvc2l0aW9uc1tpMSAqIDMgKyAxXTtcbiAgICAgIHYxeiA9IHBvc2l0aW9uc1tpMSAqIDMgKyAyXTtcbiAgICAgIHYyeCA9IHBvc2l0aW9uc1tpMiAqIDNdO1xuICAgICAgdjJ5ID0gcG9zaXRpb25zW2kyICogMyArIDFdO1xuICAgICAgdjJ6ID0gcG9zaXRpb25zW2kyICogMyArIDJdO1xuICAgICAgdjN4ID0gcG9zaXRpb25zW2kzICogM107XG4gICAgICB2M3kgPSBwb3NpdGlvbnNbaTMgKiAzICsgMV07XG4gICAgICB2M3ogPSBwb3NpdGlvbnNbaTMgKiAzICsgMl07XG4gICAgICB3MXggPSB1dnNbaTEgKiAyXTtcbiAgICAgIHcxeSA9IHV2c1tpMSAqIDIgKyAxXTtcbiAgICAgIHcyeCA9IHV2c1tpMiAqIDJdO1xuICAgICAgdzJ5ID0gdXZzW2kyICogMiArIDFdO1xuICAgICAgdzN4ID0gdXZzW2kzICogMl07XG4gICAgICB3M3kgPSB1dnNbaTMgKiAyICsgMV07XG4gICAgICB4MSA9IHYyeCAtIHYxeDtcbiAgICAgIHgyID0gdjN4IC0gdjF4O1xuICAgICAgeTEgPSB2MnkgLSB2MXk7XG4gICAgICB5MiA9IHYzeSAtIHYxeTtcbiAgICAgIHoxID0gdjJ6IC0gdjF6O1xuICAgICAgejIgPSB2M3ogLSB2MXo7XG4gICAgICBzMSA9IHcyeCAtIHcxeDtcbiAgICAgIHMyID0gdzN4IC0gdzF4O1xuICAgICAgdDEgPSB3MnkgLSB3MXk7XG4gICAgICB0MiA9IHczeSAtIHcxeTtcbiAgICAgIGFyZWEgPSBzMSAqIHQyIC0gczIgKiB0MTtcbiAgICAgIGlmIChhcmVhID09IDAuMCkge1xuICAgICAgICBzZGlyeCA9IDA7XG4gICAgICAgIHNkaXJ5ID0gMTtcbiAgICAgICAgc2RpcnogPSAwO1xuICAgICAgICB0ZGlyeCA9IDE7XG4gICAgICAgIHRkaXJ5ID0gMDtcbiAgICAgICAgdGRpcnogPSAwO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgciA9IDEuMCAvIGFyZWE7XG4gICAgICAgIHNkaXJ4ID0gKHQyICogeDEgLSB0MSAqIHgyKSAqIHI7XG4gICAgICAgIHNkaXJ5ID0gKHQyICogeTEgLSB0MSAqIHkyKSAqIHI7XG4gICAgICAgIHNkaXJ6ID0gKHQyICogejEgLSB0MSAqIHoyKSAqIHI7XG4gICAgICAgIHRkaXJ4ID0gKHMxICogeDIgLSBzMiAqIHgxKSAqIHI7XG4gICAgICAgIHRkaXJ5ID0gKHMxICogeTIgLSBzMiAqIHkxKSAqIHI7XG4gICAgICAgIHRkaXJ6ID0gKHMxICogejIgLSBzMiAqIHoxKSAqIHI7XG4gICAgICB9XG4gICAgICB0YW4xW2kxICogMyArIDBdICs9IHNkaXJ4O1xuICAgICAgdGFuMVtpMSAqIDMgKyAxXSArPSBzZGlyeTtcbiAgICAgIHRhbjFbaTEgKiAzICsgMl0gKz0gc2Rpcno7XG4gICAgICB0YW4xW2kyICogMyArIDBdICs9IHNkaXJ4O1xuICAgICAgdGFuMVtpMiAqIDMgKyAxXSArPSBzZGlyeTtcbiAgICAgIHRhbjFbaTIgKiAzICsgMl0gKz0gc2Rpcno7XG4gICAgICB0YW4xW2kzICogMyArIDBdICs9IHNkaXJ4O1xuICAgICAgdGFuMVtpMyAqIDMgKyAxXSArPSBzZGlyeTtcbiAgICAgIHRhbjFbaTMgKiAzICsgMl0gKz0gc2Rpcno7XG4gICAgICB0YW4yW2kxICogMyArIDBdICs9IHRkaXJ4O1xuICAgICAgdGFuMltpMSAqIDMgKyAxXSArPSB0ZGlyeTtcbiAgICAgIHRhbjJbaTEgKiAzICsgMl0gKz0gdGRpcno7XG4gICAgICB0YW4yW2kyICogMyArIDBdICs9IHRkaXJ4O1xuICAgICAgdGFuMltpMiAqIDMgKyAxXSArPSB0ZGlyeTtcbiAgICAgIHRhbjJbaTIgKiAzICsgMl0gKz0gdGRpcno7XG4gICAgICB0YW4yW2kzICogMyArIDBdICs9IHRkaXJ4O1xuICAgICAgdGFuMltpMyAqIDMgKyAxXSArPSB0ZGlyeTtcbiAgICAgIHRhbjJbaTMgKiAzICsgMl0gKz0gdGRpcno7XG4gICAgfVxuICAgIG10SW5kZXhDb3VudCA9IG10SW5kaWNlcy5sZW5ndGg7XG4gICAgZm9yIChqID0gMDtqIDwgbXRJbmRleENvdW50O2orKykge1xuICAgICAgaSA9IG10SW5kaWNlc1tqXTtcbiAgICAgIG54ID0gbm9ybWFsc1tpICogM107XG4gICAgICBueSA9IG5vcm1hbHNbaSAqIDMgKyAxXTtcbiAgICAgIG56ID0gbm9ybWFsc1tpICogMyArIDJdO1xuICAgICAgdDF4ID0gdGFuMVtpICogM107XG4gICAgICB0MXkgPSB0YW4xW2kgKiAzICsgMV07XG4gICAgICB0MXogPSB0YW4xW2kgKiAzICsgMl07XG4gICAgICB0MnggPSB0YW4yW2kgKiAzXTtcbiAgICAgIHQyeSA9IHRhbjJbaSAqIDMgKyAxXTtcbiAgICAgIHQyeiA9IHRhbjJbaSAqIDMgKyAyXTtcbiAgICAgIG5kb3R0ID0gbnggKiB0MXggKyBueSAqIHQxeSArIG56ICogdDF6O1xuICAgICAgdjF4ID0gbnggKiBuZG90dDtcbiAgICAgIHYxeSA9IG55ICogbmRvdHQ7XG4gICAgICB2MXogPSBueiAqIG5kb3R0O1xuICAgICAgdjJ4ID0gbnkgKiB0MXogLSB0MXkgKiBuejtcbiAgICAgIHYyeSA9IG56ICogdDF4IC0gdDF6ICogbng7XG4gICAgICB2MnogPSBueCAqIHQxeSAtIHQxeCAqIG55O1xuICAgICAgdDF4IC09IHYxeDtcbiAgICAgIHQxeSAtPSB2MXk7XG4gICAgICB0MXogLT0gdjF6O1xuICAgICAgbGVuID0gMS4wIC8gTWF0aC5zcXJ0KHQxeCAqIHQxeCArIHQxeSAqIHQxeSArIHQxeiAqIHQxeik7XG4gICAgICB0MXggKj0gbGVuO1xuICAgICAgdDF5ICo9IGxlbjtcbiAgICAgIHQxeiAqPSBsZW47XG4gICAgICB0YW5nZW50c1tpICogNF0gPSB0MXg7XG4gICAgICB0YW5nZW50c1tpICogNCArIDFdID0gdDF5O1xuICAgICAgdGFuZ2VudHNbaSAqIDQgKyAyXSA9IHQxejtcbiAgICAgIHRhbmdlbnRzW2kgKiA0ICsgM10gPSB2MnggKiB0MnggKyB2MnkgKiB0MnkgKyB2MnogKiB0MnogPCAwLjAgPyAtMS4wIDogMS4wO1xuICAgIH1cbiAgICByZXR1cm4gdGFuZ2VudHM7XG4gIH0sIF9pbml0TW9ycGhzOmZ1bmN0aW9uKGRhdGEsIG1vcnBocywgdmVydGV4QnVmZmVycywgbWVzaGVzKSB7XG4gICAgdmFyIG1vZGVsRGF0YSA9IGRhdGEubW9kZWw7XG4gICAgdmFyIGksIGo7XG4gICAgdmFyIHRhcmdldCwgaywgbCwgaW5kZXg7XG4gICAgdmFyIHRyaUEsIHRyaUIsIHRyaUM7XG4gICAgdmFyIGZsYWdnZWQ7XG4gICAgdmFyIGJhc2VQb3M7XG4gICAgdmFyIGJhc2VOb3JtO1xuICAgIHZhciBiYXNlVXY7XG4gICAgdmFyIG51bVZlcnRzO1xuICAgIHZhciBudW1JbmRpY2VzO1xuICAgIHZhciB0cG9zLCB0bm9ybTtcbiAgICB2YXIgdmVydGV4RGF0YTtcbiAgICB2YXIgbXRUcmlJbmRpY2VzID0gW107XG4gICAgdmFyIHByb2Nlc3NlZCA9IFtdO1xuICAgIHZhciB2aWQ7XG4gICAgZm9yIChpID0gMDtpIDwgbWVzaGVzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZpZCA9IG1vZGVsRGF0YS5tZXNoZXNbaV0udmVydGljZXM7XG4gICAgICBpZiAocHJvY2Vzc2VkW3ZpZF0pIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB2ZXJ0ZXhEYXRhID0gbW9kZWxEYXRhLnZlcnRpY2VzW3ZpZF07XG4gICAgICBpZiAoIXZlcnRleERhdGEudGFuZ2VudCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHZhciB0YW5nZW50cyA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4RGF0YS50YW5nZW50LmRhdGEpO1xuICAgICAgcHJvY2Vzc2VkW3ZpZF0gPSB0cnVlO1xuICAgICAgaWYgKHZlcnRleERhdGEucG9zaXRpb24gJiYgdmVydGV4RGF0YS5ub3JtYWwgJiYgdmVydGV4RGF0YS50ZXhDb29yZDApIHtcbiAgICAgICAgdmFyIGluZGljZXMgPSBbXTtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbW9kZWxEYXRhLm1lc2hlcy5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgaWYgKG1vZGVsRGF0YS5tZXNoZXNbal0udmVydGljZXMgPT09IHZpZCkge1xuICAgICAgICAgICAgaW5kaWNlcyA9IGluZGljZXMuY29uY2F0KG1vZGVsRGF0YS5tZXNoZXNbal0uaW5kaWNlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJhc2VQb3MgPSB2ZXJ0ZXhEYXRhLnBvc2l0aW9uLmRhdGE7XG4gICAgICAgIGJhc2VOb3JtID0gdmVydGV4RGF0YS5ub3JtYWwuZGF0YTtcbiAgICAgICAgYmFzZVV2ID0gdmVydGV4RGF0YS50ZXhDb29yZDAuZGF0YTtcbiAgICAgICAgbnVtVmVydHMgPSBiYXNlUG9zLmxlbmd0aCAvIDM7XG4gICAgICAgIG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDtcbiAgICAgICAgdmFyIHRhcmdldFRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0cyAqIDQpO1xuICAgICAgICB2YXIgdGFuMSA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydHMgKiAzKTtcbiAgICAgICAgdmFyIHRhbjIgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRzICogMyk7XG4gICAgICAgIHRwb3MgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRzICogMyk7XG4gICAgICAgIHRwb3Muc2V0KGJhc2VQb3MpO1xuICAgICAgICB0bm9ybSA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydHMgKiAzKTtcbiAgICAgICAgdG5vcm0uc2V0KGJhc2VOb3JtKTtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbW9ycGhzLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICBpZiAobW9kZWxEYXRhLm1lc2hlc1tpXS5tb3JwaCAhPT0gaikge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZvciAoayA9IDA7ayA8IG1vcnBoc1tqXS5fdGFyZ2V0cy5sZW5ndGg7aysrKSB7XG4gICAgICAgICAgICB0YXJnZXQgPSBtb3JwaHNbal0uX3RhcmdldHNba107XG4gICAgICAgICAgICB2YXIgbXRJbmRpY2VzID0gdGFyZ2V0LmluZGljZXM7XG4gICAgICAgICAgICB2YXIgbnVtTXRJbmRpY2VzID0gbXRJbmRpY2VzLmxlbmd0aDtcbiAgICAgICAgICAgIGlmIChudW1NdEluZGljZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0YXJnZXQuZGVsdGFUYW5nZW50cyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtTXRJbmRpY2VzICogNCk7XG4gICAgICAgICAgICBpZiAoIWZsYWdnZWQgfHwgZmxhZ2dlZC5sZW5ndGggPCBudW1WZXJ0cykge1xuICAgICAgICAgICAgICBmbGFnZ2VkID0gbmV3IFVpbnQ4QXJyYXkobnVtVmVydHMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZm9yIChsID0gMDtsID4gbnVtVmVydHM7bCsrKSB7XG4gICAgICAgICAgICAgICAgZmxhZ2dlZFtsXSA9IDA7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAobCA9IDA7bCA8IG51bU10SW5kaWNlcztsKyspIHtcbiAgICAgICAgICAgICAgaW5kZXggPSBtdEluZGljZXNbbF07XG4gICAgICAgICAgICAgIGZsYWdnZWRbaW5kZXhdID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBudW1NdFRyaUluZGljZXMgPSAwO1xuICAgICAgICAgICAgZm9yIChsID0gMDtsIDwgbnVtSW5kaWNlcztsICs9IDMpIHtcbiAgICAgICAgICAgICAgdHJpQSA9IGluZGljZXNbbF07XG4gICAgICAgICAgICAgIHRyaUIgPSBpbmRpY2VzW2wgKyAxXTtcbiAgICAgICAgICAgICAgdHJpQyA9IGluZGljZXNbbCArIDJdO1xuICAgICAgICAgICAgICBpZiAoZmxhZ2dlZFt0cmlBXSB8fCBmbGFnZ2VkW3RyaUJdIHx8IGZsYWdnZWRbdHJpQ10pIHtcbiAgICAgICAgICAgICAgICBtdFRyaUluZGljZXNbbnVtTXRUcmlJbmRpY2VzXSA9IHRyaUE7XG4gICAgICAgICAgICAgICAgbXRUcmlJbmRpY2VzW251bU10VHJpSW5kaWNlcyArIDFdID0gdHJpQjtcbiAgICAgICAgICAgICAgICBtdFRyaUluZGljZXNbbnVtTXRUcmlJbmRpY2VzICsgMl0gPSB0cmlDO1xuICAgICAgICAgICAgICAgIG51bU10VHJpSW5kaWNlcyArPSAzO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtdFRyaUluZGljZXMubGVuZ3RoID0gbnVtTXRUcmlJbmRpY2VzO1xuICAgICAgICAgICAgdmFyIGRlbHRhUG9zID0gdGFyZ2V0LmRlbHRhUG9zaXRpb25zO1xuICAgICAgICAgICAgdmFyIGRlbHRhTm9ybSA9IHRhcmdldC5kZWx0YU5vcm1hbHM7XG4gICAgICAgICAgICBmb3IgKGwgPSAwO2wgPCBudW1NdEluZGljZXM7bCsrKSB7XG4gICAgICAgICAgICAgIGluZGV4ID0gbXRJbmRpY2VzW2xdO1xuICAgICAgICAgICAgICB0cG9zW2luZGV4ICogM10gKz0gZGVsdGFQb3NbbCAqIDNdO1xuICAgICAgICAgICAgICB0cG9zW2luZGV4ICogMyArIDFdICs9IGRlbHRhUG9zW2wgKiAzICsgMV07XG4gICAgICAgICAgICAgIHRwb3NbaW5kZXggKiAzICsgMl0gKz0gZGVsdGFQb3NbbCAqIDMgKyAyXTtcbiAgICAgICAgICAgICAgdG5vcm1baW5kZXggKiAzXSArPSBkZWx0YU5vcm1bbCAqIDNdO1xuICAgICAgICAgICAgICB0bm9ybVtpbmRleCAqIDMgKyAxXSArPSBkZWx0YU5vcm1bbCAqIDMgKyAxXTtcbiAgICAgICAgICAgICAgdG5vcm1baW5kZXggKiAzICsgMl0gKz0gZGVsdGFOb3JtW2wgKiAzICsgMl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVUYW5nZW50c01vcnBoVGFyZ2V0KHRwb3MsIHRub3JtLCBiYXNlVXYsIG10VHJpSW5kaWNlcywgdGFuMSwgdGFuMiwgbXRJbmRpY2VzLCB0YXJnZXRUYW5nZW50cyk7XG4gICAgICAgICAgICB2YXIgZGVsdGFUYW5nZW50cyA9IHRhcmdldC5kZWx0YVRhbmdlbnRzO1xuICAgICAgICAgICAgZm9yIChsID0gMDtsIDwgbnVtTXRJbmRpY2VzO2wrKykge1xuICAgICAgICAgICAgICBpbmRleCA9IG10SW5kaWNlc1tsXTtcbiAgICAgICAgICAgICAgZGVsdGFUYW5nZW50c1tsICogNF0gPSB0YXJnZXRUYW5nZW50c1tsICogNF0gLSB0YW5nZW50c1tpbmRleCAqIDRdO1xuICAgICAgICAgICAgICBkZWx0YVRhbmdlbnRzW2wgKiA0ICsgMV0gPSB0YXJnZXRUYW5nZW50c1tsICogNCArIDFdIC0gdGFuZ2VudHNbaW5kZXggKiA0ICsgMV07XG4gICAgICAgICAgICAgIGRlbHRhVGFuZ2VudHNbbCAqIDQgKyAyXSA9IHRhcmdldFRhbmdlbnRzW2wgKiA0ICsgMl0gLSB0YW5nZW50c1tpbmRleCAqIDQgKyAyXTtcbiAgICAgICAgICAgICAgZGVsdGFUYW5nZW50c1tsICogNCArIDNdID0gdGFyZ2V0VGFuZ2VudHNbbCAqIDQgKyAzXSAtIHRhbmdlbnRzW2luZGV4ICogNCArIDNdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGsgPT09IG1vcnBoc1tqXS5fdGFyZ2V0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChsID0gMDtsIDwgbnVtSW5kaWNlcztsICs9IDMpIHtcbiAgICAgICAgICAgICAgdHJpQSA9IGluZGljZXNbbF07XG4gICAgICAgICAgICAgIHRyaUIgPSBpbmRpY2VzW2wgKyAxXTtcbiAgICAgICAgICAgICAgdHJpQyA9IGluZGljZXNbbCArIDJdO1xuICAgICAgICAgICAgICB0YW4xW3RyaUEgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUEgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUEgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUIgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUIgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUIgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUMgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUMgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4xW3RyaUMgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUEgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUEgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUEgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUIgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUIgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUIgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUMgKiAzICsgMF0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUMgKiAzICsgMV0gPSAwO1xuICAgICAgICAgICAgICB0YW4yW3RyaUMgKiAzICsgMl0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChsID0gMDtsIDwgbnVtTXRJbmRpY2VzO2wrKykge1xuICAgICAgICAgICAgICBpbmRleCA9IHRhcmdldC5pbmRpY2VzW2xdO1xuICAgICAgICAgICAgICB0cG9zW2luZGV4ICogM10gPSBiYXNlUG9zW2luZGV4ICogM107XG4gICAgICAgICAgICAgIHRwb3NbaW5kZXggKiAzICsgMV0gPSBiYXNlUG9zW2luZGV4ICogMyArIDFdO1xuICAgICAgICAgICAgICB0cG9zW2luZGV4ICogMyArIDJdID0gYmFzZVBvc1tpbmRleCAqIDMgKyAyXTtcbiAgICAgICAgICAgICAgdG5vcm1baW5kZXggKiAzXSA9IGJhc2VOb3JtW2luZGV4ICogM107XG4gICAgICAgICAgICAgIHRub3JtW2luZGV4ICogMyArIDFdID0gYmFzZU5vcm1baW5kZXggKiAzICsgMV07XG4gICAgICAgICAgICAgIHRub3JtW2luZGV4ICogMyArIDJdID0gYmFzZU5vcm1baW5kZXggKiAzICsgMl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBfcGFyc2VWZXJ0ZXhCdWZmZXJzOmZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgbW9kZWxEYXRhID0gZGF0YS5tb2RlbDtcbiAgICB2YXIgdmVydGV4QnVmZmVycyA9IFtdO1xuICAgIHZhciBhdHRyaWJ1dGUsIGF0dHJpYnV0ZU5hbWU7XG4gICAgdmFyIGF0dHJpYnV0ZU1hcCA9IHtwb3NpdGlvbjpwYy5TRU1BTlRJQ19QT1NJVElPTiwgbm9ybWFsOnBjLlNFTUFOVElDX05PUk1BTCwgdGFuZ2VudDpwYy5TRU1BTlRJQ19UQU5HRU5ULCBibGVuZFdlaWdodDpwYy5TRU1BTlRJQ19CTEVORFdFSUdIVCwgYmxlbmRJbmRpY2VzOnBjLlNFTUFOVElDX0JMRU5ESU5ESUNFUywgY29sb3I6cGMuU0VNQU5USUNfQ09MT1IsIHRleENvb3JkMDpwYy5TRU1BTlRJQ19URVhDT09SRDAsIHRleENvb3JkMTpwYy5TRU1BTlRJQ19URVhDT09SRDEsIHRleENvb3JkMjpwYy5TRU1BTlRJQ19URVhDT09SRDIsIHRleENvb3JkMzpwYy5TRU1BTlRJQ19URVhDT09SRDMsIHRleENvb3JkNDpwYy5TRU1BTlRJQ19URVhDT09SRDQsIHRleENvb3JkNTpwYy5TRU1BTlRJQ19URVhDT09SRDUsIHRleENvb3JkNjpwYy5TRU1BTlRJQ19URVhDT09SRDYsIHRleENvb3JkNzpwYy5TRU1BTlRJQ19URVhDT09SRDd9O1xuICAgIHZhciBpLCBqO1xuICAgIGZvciAoaSA9IDA7aSA8IG1vZGVsRGF0YS52ZXJ0aWNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgdmVydGV4RGF0YSA9IG1vZGVsRGF0YS52ZXJ0aWNlc1tpXTtcbiAgICAgIGlmICh2ZXJ0ZXhEYXRhLnBvc2l0aW9uICYmIHZlcnRleERhdGEubm9ybWFsICYmIHZlcnRleERhdGEudGV4Q29vcmQwKSB7XG4gICAgICAgIHZhciBpbmRpY2VzID0gW107XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IG1vZGVsRGF0YS5tZXNoZXMubGVuZ3RoO2orKykge1xuICAgICAgICAgIGlmIChtb2RlbERhdGEubWVzaGVzW2pdLnZlcnRpY2VzID09PSBpKSB7XG4gICAgICAgICAgICBpbmRpY2VzID0gaW5kaWNlcy5jb25jYXQobW9kZWxEYXRhLm1lc2hlc1tqXS5pbmRpY2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHRhbmdlbnRzID0gcGMuY2FsY3VsYXRlVGFuZ2VudHModmVydGV4RGF0YS5wb3NpdGlvbi5kYXRhLCB2ZXJ0ZXhEYXRhLm5vcm1hbC5kYXRhLCB2ZXJ0ZXhEYXRhLnRleENvb3JkMC5kYXRhLCBpbmRpY2VzKTtcbiAgICAgICAgdmVydGV4RGF0YS50YW5nZW50ID0ge3R5cGU6XCJmbG9hdDMyXCIsIGNvbXBvbmVudHM6NCwgZGF0YTp0YW5nZW50c307XG4gICAgICB9XG4gICAgICB2YXIgZm9ybWF0RGVzYyA9IFtdO1xuICAgICAgZm9yIChhdHRyaWJ1dGVOYW1lIGluIHZlcnRleERhdGEpIHtcbiAgICAgICAgYXR0cmlidXRlID0gdmVydGV4RGF0YVthdHRyaWJ1dGVOYW1lXTtcbiAgICAgICAgdmFyIGF0dHJpYlR5cGUgPSBhdHRyaWJ1dGUudHlwZTtcbiAgICAgICAgaWYgKCF0aGlzLl9kZXZpY2Uuc3VwcG9ydHNVbnNpZ25lZEJ5dGUpIHtcbiAgICAgICAgICBpZiAoYXR0cmliVHlwZSA9PT0gXCJ1aW50OFwiKSB7XG4gICAgICAgICAgICBhdHRyaWJUeXBlID0gXCJmbG9hdDMyXCI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhdHRyaWJUeXBlID09PSBcImludDhcIikge1xuICAgICAgICAgICAgYXR0cmliVHlwZSA9IFwiZmxvYXQzMlwiO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3JtYXREZXNjLnB1c2goe3NlbWFudGljOmF0dHJpYnV0ZU1hcFthdHRyaWJ1dGVOYW1lXSwgY29tcG9uZW50czphdHRyaWJ1dGUuY29tcG9uZW50cywgdHlwZTpKU09OX1ZFUlRFWF9FTEVNRU5UX1RZUEVbYXR0cmliVHlwZV0sIG5vcm1hbGl6ZTphdHRyaWJ1dGVNYXBbYXR0cmlidXRlTmFtZV0gPT09IHBjLlNFTUFOVElDX0NPTE9SfSk7XG4gICAgICB9XG4gICAgICB2YXIgdmVydGV4Rm9ybWF0ID0gbmV3IHBjLlZlcnRleEZvcm1hdCh0aGlzLl9kZXZpY2UsIGZvcm1hdERlc2MpO1xuICAgICAgdmFyIG51bVZlcnRpY2VzID0gdmVydGV4RGF0YS5wb3NpdGlvbi5kYXRhLmxlbmd0aCAvIHZlcnRleERhdGEucG9zaXRpb24uY29tcG9uZW50cztcbiAgICAgIHZhciB2ZXJ0ZXhCdWZmZXIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKHRoaXMuX2RldmljZSwgdmVydGV4Rm9ybWF0LCBudW1WZXJ0aWNlcyk7XG4gICAgICB2YXIgaXRlcmF0b3IgPSBuZXcgcGMuVmVydGV4SXRlcmF0b3IodmVydGV4QnVmZmVyKTtcbiAgICAgIGZvciAoaiA9IDA7aiA8IG51bVZlcnRpY2VzO2orKykge1xuICAgICAgICBmb3IgKGF0dHJpYnV0ZU5hbWUgaW4gdmVydGV4RGF0YSkge1xuICAgICAgICAgIGF0dHJpYnV0ZSA9IHZlcnRleERhdGFbYXR0cmlidXRlTmFtZV07XG4gICAgICAgICAgc3dpdGNoKGF0dHJpYnV0ZS5jb21wb25lbnRzKSB7XG4gICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbYXR0cmlidXRlTWFwW2F0dHJpYnV0ZU5hbWVdXS5zZXQoYXR0cmlidXRlLmRhdGFbal0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgICAgaXRlcmF0b3IuZWxlbWVudFthdHRyaWJ1dGVNYXBbYXR0cmlidXRlTmFtZV1dLnNldChhdHRyaWJ1dGUuZGF0YVtqICogMl0sIGF0dHJpYnV0ZS5kYXRhW2ogKiAyICsgMV0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMzpcbiAgICAgICAgICAgICAgaXRlcmF0b3IuZWxlbWVudFthdHRyaWJ1dGVNYXBbYXR0cmlidXRlTmFtZV1dLnNldChhdHRyaWJ1dGUuZGF0YVtqICogM10sIGF0dHJpYnV0ZS5kYXRhW2ogKiAzICsgMV0sIGF0dHJpYnV0ZS5kYXRhW2ogKiAzICsgMl0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgNDpcbiAgICAgICAgICAgICAgaXRlcmF0b3IuZWxlbWVudFthdHRyaWJ1dGVNYXBbYXR0cmlidXRlTmFtZV1dLnNldChhdHRyaWJ1dGUuZGF0YVtqICogNF0sIGF0dHJpYnV0ZS5kYXRhW2ogKiA0ICsgMV0sIGF0dHJpYnV0ZS5kYXRhW2ogKiA0ICsgMl0sIGF0dHJpYnV0ZS5kYXRhW2ogKiA0ICsgM10pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaXRlcmF0b3IubmV4dCgpO1xuICAgICAgfVxuICAgICAgaXRlcmF0b3IuZW5kKCk7XG4gICAgICB2ZXJ0ZXhCdWZmZXJzLnB1c2godmVydGV4QnVmZmVyKTtcbiAgICB9XG4gICAgcmV0dXJuIHZlcnRleEJ1ZmZlcnM7XG4gIH0sIF9wYXJzZUluZGV4QnVmZmVyczpmdW5jdGlvbihkYXRhLCB2ZXJ0ZXhCdWZmZXJzKSB7XG4gICAgdmFyIG1vZGVsRGF0YSA9IGRhdGEubW9kZWw7XG4gICAgdmFyIGluZGV4QnVmZmVyID0gbnVsbDtcbiAgICB2YXIgaW5kZXhEYXRhID0gbnVsbDtcbiAgICB2YXIgaTtcbiAgICB2YXIgbnVtSW5kaWNlcyA9IDA7XG4gICAgZm9yIChpID0gMDtpIDwgbW9kZWxEYXRhLm1lc2hlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgbWVzaERhdGEgPSBtb2RlbERhdGEubWVzaGVzW2ldO1xuICAgICAgaWYgKG1lc2hEYXRhLmluZGljZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBudW1JbmRpY2VzICs9IG1lc2hEYXRhLmluZGljZXMubGVuZ3RoO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgbWF4VmVydHMgPSAwO1xuICAgIGZvciAoaSA9IDA7aSA8IHZlcnRleEJ1ZmZlcnMubGVuZ3RoO2krKykge1xuICAgICAgbWF4VmVydHMgPSBNYXRoLm1heChtYXhWZXJ0cywgdmVydGV4QnVmZmVyc1tpXS5udW1WZXJ0aWNlcyk7XG4gICAgfVxuICAgIGlmIChudW1JbmRpY2VzID4gMCkge1xuICAgICAgaWYgKG1heFZlcnRzID4gNjU1MzUgJiYgdGhpcy5fZGV2aWNlLmV4dFVpbnRFbGVtZW50KSB7XG4gICAgICAgIGluZGV4QnVmZmVyID0gbmV3IHBjLkluZGV4QnVmZmVyKHRoaXMuX2RldmljZSwgcGMuSU5ERVhGT1JNQVRfVUlOVDMyLCBudW1JbmRpY2VzKTtcbiAgICAgICAgaW5kZXhEYXRhID0gbmV3IFVpbnQzMkFycmF5KGluZGV4QnVmZmVyLmxvY2soKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbmRleEJ1ZmZlciA9IG5ldyBwYy5JbmRleEJ1ZmZlcih0aGlzLl9kZXZpY2UsIHBjLklOREVYRk9STUFUX1VJTlQxNiwgbnVtSW5kaWNlcyk7XG4gICAgICAgIGluZGV4RGF0YSA9IG5ldyBVaW50MTZBcnJheShpbmRleEJ1ZmZlci5sb2NrKCkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge2J1ZmZlcjppbmRleEJ1ZmZlciwgZGF0YTppbmRleERhdGF9O1xuICB9LCBfcGFyc2VNZXNoZXM6ZnVuY3Rpb24oZGF0YSwgc2tpbnMsIG1vcnBocywgdmVydGV4QnVmZmVycywgaW5kZXhCdWZmZXIsIGluZGV4RGF0YSkge1xuICAgIHZhciBtb2RlbERhdGEgPSBkYXRhLm1vZGVsO1xuICAgIHZhciBtZXNoZXMgPSBbXTtcbiAgICB2YXIgaW5kZXhCYXNlID0gMDtcbiAgICB2YXIgaTtcbiAgICBmb3IgKGkgPSAwO2kgPCBtb2RlbERhdGEubWVzaGVzLmxlbmd0aDtpKyspIHtcbiAgICAgIHZhciBtZXNoRGF0YSA9IG1vZGVsRGF0YS5tZXNoZXNbaV07XG4gICAgICB2YXIgbWVzaEFhYmIgPSBtZXNoRGF0YS5hYWJiO1xuICAgICAgdmFyIG1pbiA9IG1lc2hBYWJiLm1pbjtcbiAgICAgIHZhciBtYXggPSBtZXNoQWFiYi5tYXg7XG4gICAgICB2YXIgYWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveChuZXcgcGMuVmVjMygobWF4WzBdICsgbWluWzBdKSAqIDAuNSwgKG1heFsxXSArIG1pblsxXSkgKiAwLjUsIChtYXhbMl0gKyBtaW5bMl0pICogMC41KSwgbmV3IHBjLlZlYzMoKG1heFswXSAtIG1pblswXSkgKiAwLjUsIChtYXhbMV0gLSBtaW5bMV0pICogMC41LCAobWF4WzJdIC0gbWluWzJdKSAqIDAuNSkpO1xuICAgICAgdmFyIGluZGV4ZWQgPSBtZXNoRGF0YS5pbmRpY2VzICE9PSB1bmRlZmluZWQ7XG4gICAgICB2YXIgbWVzaCA9IG5ldyBwYy5NZXNoO1xuICAgICAgbWVzaC52ZXJ0ZXhCdWZmZXIgPSB2ZXJ0ZXhCdWZmZXJzW21lc2hEYXRhLnZlcnRpY2VzXTtcbiAgICAgIG1lc2guaW5kZXhCdWZmZXJbMF0gPSBpbmRleGVkID8gaW5kZXhCdWZmZXIgOiBudWxsO1xuICAgICAgbWVzaC5wcmltaXRpdmVbMF0udHlwZSA9IEpTT05fUFJJTUlUSVZFX1RZUEVbbWVzaERhdGEudHlwZV07XG4gICAgICBtZXNoLnByaW1pdGl2ZVswXS5iYXNlID0gaW5kZXhlZCA/IG1lc2hEYXRhLmJhc2UgKyBpbmRleEJhc2UgOiBtZXNoRGF0YS5iYXNlO1xuICAgICAgbWVzaC5wcmltaXRpdmVbMF0uY291bnQgPSBtZXNoRGF0YS5jb3VudDtcbiAgICAgIG1lc2gucHJpbWl0aXZlWzBdLmluZGV4ZWQgPSBpbmRleGVkO1xuICAgICAgbWVzaC5za2luID0gbWVzaERhdGEuc2tpbiAhPT0gdW5kZWZpbmVkID8gc2tpbnNbbWVzaERhdGEuc2tpbl0gOiBudWxsO1xuICAgICAgbWVzaC5tb3JwaCA9IG1lc2hEYXRhLm1vcnBoICE9PSB1bmRlZmluZWQgPyBtb3JwaHNbbWVzaERhdGEubW9ycGhdIDogbnVsbDtcbiAgICAgIG1lc2guYWFiYiA9IGFhYmI7XG4gICAgICBpZiAoaW5kZXhlZCkge1xuICAgICAgICBpbmRleERhdGEuc2V0KG1lc2hEYXRhLmluZGljZXMsIGluZGV4QmFzZSk7XG4gICAgICAgIGluZGV4QmFzZSArPSBtZXNoRGF0YS5pbmRpY2VzLmxlbmd0aDtcbiAgICAgIH1cbiAgICAgIG1lc2hlcy5wdXNoKG1lc2gpO1xuICAgIH1cbiAgICBpZiAoaW5kZXhCdWZmZXIgIT09IG51bGwpIHtcbiAgICAgIGluZGV4QnVmZmVyLnVubG9jaygpO1xuICAgIH1cbiAgICByZXR1cm4gbWVzaGVzO1xuICB9LCBfcGFyc2VNZXNoSW5zdGFuY2VzOmZ1bmN0aW9uKGRhdGEsIG5vZGVzLCBtZXNoZXMsIHNraW5zLCBza2luSW5zdGFuY2VzLCBtb3JwaHMsIG1vcnBoSW5zdGFuY2VzKSB7XG4gICAgdmFyIG1vZGVsRGF0YSA9IGRhdGEubW9kZWw7XG4gICAgdmFyIG1lc2hJbnN0YW5jZXMgPSBbXTtcbiAgICB2YXIgaTtcbiAgICBmb3IgKGkgPSAwO2kgPCBtb2RlbERhdGEubWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICB2YXIgbWVzaEluc3RhbmNlRGF0YSA9IG1vZGVsRGF0YS5tZXNoSW5zdGFuY2VzW2ldO1xuICAgICAgdmFyIG5vZGUgPSBub2Rlc1ttZXNoSW5zdGFuY2VEYXRhLm5vZGVdO1xuICAgICAgdmFyIG1lc2ggPSBtZXNoZXNbbWVzaEluc3RhbmNlRGF0YS5tZXNoXTtcbiAgICAgIHZhciBtZXNoSW5zdGFuY2UgPSBuZXcgcGMuTWVzaEluc3RhbmNlKG5vZGUsIG1lc2gsIHBjLk1vZGVsSGFuZGxlci5ERUZBVUxUX01BVEVSSUFMKTtcbiAgICAgIGlmIChtZXNoLnNraW4pIHtcbiAgICAgICAgdmFyIHNraW5JbmRleCA9IHNraW5zLmluZGV4T2YobWVzaC5za2luKTtcbiAgICAgICAgbWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSA9IHNraW5JbnN0YW5jZXNbc2tpbkluZGV4XTtcbiAgICAgIH1cbiAgICAgIGlmIChtZXNoLm1vcnBoKSB7XG4gICAgICAgIHZhciBtb3JwaEluZGV4ID0gbW9ycGhzLmluZGV4T2YobWVzaC5tb3JwaCk7XG4gICAgICAgIG1lc2hJbnN0YW5jZS5tb3JwaEluc3RhbmNlID0gbW9ycGhJbnN0YW5jZXNbbW9ycGhJbmRleF07XG4gICAgICB9XG4gICAgICBtZXNoSW5zdGFuY2VzLnB1c2gobWVzaEluc3RhbmNlKTtcbiAgICB9XG4gICAgcmV0dXJuIG1lc2hJbnN0YW5jZXM7XG4gIH19O1xuICByZXR1cm4ge0pzb25Nb2RlbFBhcnNlcjpKc29uTW9kZWxQYXJzZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBTY2VuZVBhcnNlciA9IGZ1bmN0aW9uKGFwcCkge1xuICAgIHRoaXMuX2FwcCA9IGFwcDtcbiAgfTtcbiAgU2NlbmVQYXJzZXIucHJvdG90eXBlID0ge3BhcnNlOmZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgZW50aXRpZXMgPSB7fTtcbiAgICB2YXIgaWQsIGk7XG4gICAgdmFyIHBhcmVudCA9IG51bGw7XG4gICAgZm9yIChpZCBpbiBkYXRhLmVudGl0aWVzKSB7XG4gICAgICBlbnRpdGllc1tpZF0gPSB0aGlzLl9jcmVhdGVFbnRpdHkoZGF0YS5lbnRpdGllc1tpZF0pO1xuICAgICAgaWYgKGRhdGEuZW50aXRpZXNbaWRdLnBhcmVudCA9PT0gbnVsbCkge1xuICAgICAgICBwYXJlbnQgPSBlbnRpdGllc1tpZF07XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaWQgaW4gZGF0YS5lbnRpdGllcykge1xuICAgICAgdmFyIGVudGl0eSA9IGVudGl0aWVzW2lkXTtcbiAgICAgIHZhciBsID0gZGF0YS5lbnRpdGllc1tpZF0uY2hpbGRyZW4ubGVuZ3RoO1xuICAgICAgZm9yIChpID0gMDtpIDwgbDtpKyspIHtcbiAgICAgICAgdmFyIHJlc291cmNlX2lkID0gZGF0YS5lbnRpdGllc1tpZF0uY2hpbGRyZW5baV07XG4gICAgICAgIGlmIChlbnRpdGllc1tyZXNvdXJjZV9pZF0pIHtcbiAgICAgICAgICBlbnRpdGllc1tpZF0uYWRkQ2hpbGQoZW50aXRpZXNbcmVzb3VyY2VfaWRdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9vcGVuQ29tcG9uZW50RGF0YShwYXJlbnQsIGRhdGEuZW50aXRpZXMpO1xuICAgIHJldHVybiBwYXJlbnQ7XG4gIH0sIF9jcmVhdGVFbnRpdHk6ZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBlbnRpdHkgPSBuZXcgcGMuRW50aXR5O1xuICAgIHZhciBwID0gZGF0YS5wb3NpdGlvbjtcbiAgICB2YXIgciA9IGRhdGEucm90YXRpb247XG4gICAgdmFyIHMgPSBkYXRhLnNjYWxlO1xuICAgIGVudGl0eS5uYW1lID0gZGF0YS5uYW1lO1xuICAgIGVudGl0eS5fZ3VpZCA9IGRhdGEucmVzb3VyY2VfaWQ7XG4gICAgZW50aXR5LnNldExvY2FsUG9zaXRpb24ocFswXSwgcFsxXSwgcFsyXSk7XG4gICAgZW50aXR5LnNldExvY2FsRXVsZXJBbmdsZXMoclswXSwgclsxXSwgclsyXSk7XG4gICAgZW50aXR5LnNldExvY2FsU2NhbGUoc1swXSwgc1sxXSwgc1syXSk7XG4gICAgZW50aXR5Ll9lbmFibGVkID0gZGF0YS5lbmFibGVkICE9PSB1bmRlZmluZWQgPyBkYXRhLmVuYWJsZWQgOiB0cnVlO1xuICAgIGVudGl0eS5fZW5hYmxlZEluSGllcmFyY2h5ID0gZW50aXR5Ll9lbmFibGVkO1xuICAgIGVudGl0eS50ZW1wbGF0ZSA9IGRhdGEudGVtcGxhdGU7XG4gICAgaWYgKGRhdGEudGFncykge1xuICAgICAgZm9yICh2YXIgaSA9IDA7aSA8IGRhdGEudGFncy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGVudGl0eS50YWdzLmFkZChkYXRhLnRhZ3NbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZGF0YS5sYWJlbHMpIHtcbiAgICAgIGRhdGEubGFiZWxzLmZvckVhY2goZnVuY3Rpb24obGFiZWwpIHtcbiAgICAgICAgZW50aXR5LmFkZExhYmVsKGxhYmVsKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZW50aXR5O1xuICB9LCBfb3BlbkNvbXBvbmVudERhdGE6ZnVuY3Rpb24oZW50aXR5LCBlbnRpdGllcykge1xuICAgIHZhciBzeXN0ZW1zID0gdGhpcy5fYXBwLnN5c3RlbXMubGlzdCgpO1xuICAgIHZhciBpLCBsZW4gPSBzeXN0ZW1zLmxlbmd0aDtcbiAgICB2YXIgZWRhdGEgPSBlbnRpdGllc1tlbnRpdHkuX2d1aWRdO1xuICAgIGZvciAoaSA9IDA7aSA8IGxlbjtpKyspIHtcbiAgICAgIHZhciBjb21wb25lbnREYXRhID0gZWRhdGEuY29tcG9uZW50c1tzeXN0ZW1zW2ldLmlkXTtcbiAgICAgIGlmIChjb21wb25lbnREYXRhKSB7XG4gICAgICAgIHRoaXMuX2FwcC5zeXN0ZW1zW3N5c3RlbXNbaV0uaWRdLmFkZENvbXBvbmVudChlbnRpdHksIGNvbXBvbmVudERhdGEpO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgY2hpbGQsIGxlbmd0aCA9IGVkYXRhLmNoaWxkcmVuLmxlbmd0aDtcbiAgICB2YXIgY2hpbGRyZW4gPSBlbnRpdHkuX2NoaWxkcmVuO1xuICAgIGZvciAoaSA9IDA7aSA8IGxlbmd0aDtpKyspIHtcbiAgICAgIGNoaWxkcmVuW2ldID0gdGhpcy5fb3BlbkNvbXBvbmVudERhdGEoY2hpbGRyZW5baV0sIGVudGl0aWVzKTtcbiAgICB9XG4gICAgcmV0dXJuIGVudGl0eTtcbiAgfX07XG4gIHJldHVybiB7U2NlbmVQYXJzZXI6U2NlbmVQYXJzZXJ9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBhc3NldElkQ291bnRlciA9IDA7XG4gIHZhciBBQlNPTFVURV9VUkwgPSBuZXcgUmVnRXhwKFwiXlwiICsgXCJcXFxccypcIiArIFwiKD86XCIgKyBcIlthLXpdK1thLXowLTlcXFxcLVxcXFwrXFxcXC5dKlwiICsgXCI6XCIgKyBcIik/XCIgKyBcIi8vXCIsIFwiaVwiKTtcbiAgdmFyIEFzc2V0ID0gZnVuY3Rpb24obmFtZSwgdHlwZSwgZmlsZSwgZGF0YSkge1xuICAgIHRoaXMuX2lkID0gKythc3NldElkQ291bnRlcjtcbiAgICB0aGlzLm5hbWUgPSBuYW1lIHx8IFwiXCI7XG4gICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICB0aGlzLnRhZ3MgPSBuZXcgcGMuVGFncyh0aGlzKTtcbiAgICB0aGlzLl9wcmVsb2FkID0gZmFsc2U7XG4gICAgdGhpcy52YXJpYW50cyA9IG5ldyBwYy5Bc3NldFZhcmlhbnRzKHRoaXMpO1xuICAgIHRoaXMuX2ZpbGUgPSBudWxsO1xuICAgIHRoaXMuX2RhdGEgPSBkYXRhIHx8IHt9O1xuICAgIHRoaXMuX3Jlc291cmNlcyA9IFtdO1xuICAgIHRoaXMubG9hZGVkID0gZmFsc2U7XG4gICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgdGhpcy5yZWdpc3RyeSA9IG51bGw7XG4gICAgcGMuZXZlbnRzLmF0dGFjaCh0aGlzKTtcbiAgICBpZiAoZmlsZSkge1xuICAgICAgdGhpcy5maWxlID0gZmlsZTtcbiAgICB9XG4gIH07XG4gIEFzc2V0LnByb3RvdHlwZSA9IHtnZXRGaWxlVXJsOmZ1bmN0aW9uKCkge1xuICAgIHZhciBmaWxlID0gdGhpcy5nZXRQcmVmZXJyZWRGaWxlKCk7XG4gICAgaWYgKCFmaWxlIHx8ICFmaWxlLnVybCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHZhciB1cmwgPSBmaWxlLnVybDtcbiAgICBpZiAodGhpcy5yZWdpc3RyeSAmJiB0aGlzLnJlZ2lzdHJ5LnByZWZpeCAmJiAhQUJTT0xVVEVfVVJMLnRlc3QodXJsKSkge1xuICAgICAgdXJsID0gdGhpcy5yZWdpc3RyeS5wcmVmaXggKyB1cmw7XG4gICAgfVxuICAgIGlmICh0aGlzLnR5cGUgIT09IFwic2NyaXB0XCIgJiYgZmlsZS5oYXNoKSB7XG4gICAgICB2YXIgc2VwYXJhdG9yID0gdXJsLmluZGV4T2YoXCI/XCIpICE9PSAtMSA/IFwiJlwiIDogXCI/XCI7XG4gICAgICB1cmwgKz0gc2VwYXJhdG9yICsgXCJ0PVwiICsgZmlsZS5oYXNoO1xuICAgIH1cbiAgICByZXR1cm4gdXJsO1xuICB9LCBnZXRQcmVmZXJyZWRGaWxlOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5maWxlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMudHlwZSA9PT0gXCJ0ZXh0dXJlXCIpIHtcbiAgICAgIHZhciBkZXZpY2UgPSB0aGlzLnJlZ2lzdHJ5Ll9sb2FkZXIuZ2V0SGFuZGxlcihcInRleHR1cmVcIikuX2RldmljZTtcbiAgICAgIGlmICh0aGlzLnZhcmlhbnRzLnB2ciAmJiBkZXZpY2UuZXh0Q29tcHJlc3NlZFRleHR1cmVQVlJUQykge1xuICAgICAgICByZXR1cm4gdGhpcy52YXJpYW50cy5wdnI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy52YXJpYW50cy5keHQgJiYgZGV2aWNlLmV4dENvbXByZXNzZWRUZXh0dXJlUzNUQykge1xuICAgICAgICAgIHJldHVybiB0aGlzLnZhcmlhbnRzLmR4dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodGhpcy52YXJpYW50cy5ldGMxICYmIGRldmljZS5leHRDb21wcmVzc2VkVGV4dHVyZUVUQzEpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhcmlhbnRzLmV0YzE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmZpbGU7XG4gIH0sIHJlYWR5OmZ1bmN0aW9uKGNhbGxiYWNrLCBzY29wZSkge1xuICAgIHNjb3BlID0gc2NvcGUgfHwgdGhpcztcbiAgICBpZiAodGhpcy5yZXNvdXJjZSkge1xuICAgICAgY2FsbGJhY2suY2FsbChzY29wZSwgdGhpcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub25jZShcImxvYWRcIiwgZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgY2FsbGJhY2suY2FsbChzY29wZSwgYXNzZXQpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LCByZWxvYWQ6ZnVuY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmxvYWRlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy50eXBlID09PSBcImN1YmVtYXBcIikge1xuICAgICAgdGhpcy5yZWdpc3RyeS5fbG9hZGVyLnBhdGNoKHRoaXMsIHRoaXMucmVnaXN0cnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5yZWdpc3RyeS5sb2FkKHRoaXMpO1xuICAgIH1cbiAgfSwgdW5sb2FkOmZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5sb2FkZWQgJiYgIXRoaXMucmVzb3VyY2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5maXJlKFwidW5sb2FkXCIsIHRoaXMpO1xuICAgIHRoaXMucmVnaXN0cnkuZmlyZShcInVubG9hZDpcIiArIHRoaXMuaWQsIHRoaXMpO1xuICAgIGlmICh0aGlzLnJlc291cmNlICYmIHRoaXMucmVzb3VyY2UuZGVzdHJveSkge1xuICAgICAgdGhpcy5yZXNvdXJjZS5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMucmVzb3VyY2UgPSBudWxsO1xuICAgIHRoaXMubG9hZGVkID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuZmlsZSkge1xuICAgICAgdGhpcy5yZWdpc3RyeS5fbG9hZGVyLmNsZWFyQ2FjaGUodGhpcy5nZXRGaWxlVXJsKCksIHRoaXMudHlwZSk7XG4gICAgfVxuICB9fTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFzc2V0LnByb3RvdHlwZSwgXCJpZFwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdGhpcy5faWQgPSB2YWx1ZTtcbiAgICBpZiAodmFsdWUgPiBhc3NldElkQ291bnRlcikge1xuICAgICAgYXNzZXRJZENvdW50ZXIgPSB2YWx1ZTtcbiAgICB9XG4gIH19KTtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFzc2V0LnByb3RvdHlwZSwgXCJmaWxlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbGU7XG4gIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgIHZhciBrZXk7XG4gICAgdmFyIHZhbHVlQXNCb29sID0gISF2YWx1ZTtcbiAgICB2YXIgZmlsZUFzQm9vbCA9ICEhdGhpcy5fZmlsZTtcbiAgICBpZiAodmFsdWVBc0Jvb2wgIT09IGZpbGVBc0Jvb2wgfHwgdmFsdWUgJiYgdGhpcy5fZmlsZSAmJiB2YWx1ZS5oYXNoICE9PSB0aGlzLl9maWxlKSB7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9maWxlKSB7XG4gICAgICAgICAgdGhpcy5fZmlsZSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2ZpbGUudXJsID0gdmFsdWUudXJsO1xuICAgICAgICB0aGlzLl9maWxlLmZpbGVuYW1lID0gdmFsdWUuZmlsZW5hbWU7XG4gICAgICAgIHRoaXMuX2ZpbGUuaGFzaCA9IHZhbHVlLmhhc2g7XG4gICAgICAgIHRoaXMuX2ZpbGUuc2l6ZSA9IHZhbHVlLnNpemU7XG4gICAgICAgIHRoaXMuX2ZpbGUudmFyaWFudHMgPSB0aGlzLnZhcmlhbnRzO1xuICAgICAgICBpZiAodmFsdWUuaGFzT3duUHJvcGVydHkoXCJ2YXJpYW50c1wiKSkge1xuICAgICAgICAgIHRoaXMudmFyaWFudHMuY2xlYXIoKTtcbiAgICAgICAgICBpZiAodmFsdWUudmFyaWFudHMpIHtcbiAgICAgICAgICAgIGZvciAoa2V5IGluIHZhbHVlLnZhcmlhbnRzKSB7XG4gICAgICAgICAgICAgIGlmICghdmFsdWUudmFyaWFudHNba2V5XSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHRoaXMudmFyaWFudHNba2V5XSA9IHZhbHVlLnZhcmlhbnRzW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmlyZShcImNoYW5nZVwiLCB0aGlzLCBcImZpbGVcIiwgdGhpcy5fZmlsZSwgdGhpcy5fZmlsZSk7XG4gICAgICAgIHRoaXMucmVsb2FkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9maWxlID0gbnVsbDtcbiAgICAgICAgdGhpcy52YXJpYW50cy5jbGVhcigpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodmFsdWUgJiYgdGhpcy5fZmlsZSAmJiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eShcInZhcmlhbnRzXCIpKSB7XG4gICAgICAgIHRoaXMudmFyaWFudHMuY2xlYXIoKTtcbiAgICAgICAgaWYgKHZhbHVlLnZhcmlhbnRzKSB7XG4gICAgICAgICAgZm9yIChrZXkgaW4gdmFsdWUudmFyaWFudHMpIHtcbiAgICAgICAgICAgIGlmICghdmFsdWUudmFyaWFudHNba2V5XSkge1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudmFyaWFudHNba2V5XSA9IHZhbHVlLnZhcmlhbnRzW2tleV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShBc3NldC5wcm90b3R5cGUsIFwiZGF0YVwiLCB7Z2V0OmZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhO1xuICB9LCBzZXQ6ZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgb2xkID0gdGhpcy5fZGF0YTtcbiAgICB0aGlzLl9kYXRhID0gdmFsdWU7XG4gICAgaWYgKHZhbHVlICE9PSBvbGQpIHtcbiAgICAgIHRoaXMuZmlyZShcImNoYW5nZVwiLCB0aGlzLCBcImRhdGFcIiwgdmFsdWUsIG9sZCk7XG4gICAgICBpZiAodGhpcy5sb2FkZWQpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5fbG9hZGVyLnBhdGNoKHRoaXMsIHRoaXMucmVnaXN0cnkpO1xuICAgICAgfVxuICAgIH1cbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQXNzZXQucHJvdG90eXBlLCBcInJlc291cmNlXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Jlc291cmNlc1swXTtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIF9vbGQgPSB0aGlzLl9yZXNvdXJjZXNbMF07XG4gICAgdGhpcy5fcmVzb3VyY2VzWzBdID0gdmFsdWU7XG4gICAgdGhpcy5maXJlKFwiY2hhbmdlXCIsIHRoaXMsIFwicmVzb3VyY2VcIiwgdmFsdWUsIF9vbGQpO1xuICB9fSk7XG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShBc3NldC5wcm90b3R5cGUsIFwicmVzb3VyY2VzXCIsIHtnZXQ6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Jlc291cmNlcztcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIF9vbGQgPSB0aGlzLl9yZXNvdXJjZXM7XG4gICAgdGhpcy5fcmVzb3VyY2VzID0gdmFsdWU7XG4gICAgdGhpcy5maXJlKFwiY2hhbmdlXCIsIHRoaXMsIFwicmVzb3VyY2VzXCIsIHZhbHVlLCBfb2xkKTtcbiAgfX0pO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQXNzZXQucHJvdG90eXBlLCBcInByZWxvYWRcIiwge2dldDpmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJlbG9hZDtcbiAgfSwgc2V0OmZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFsdWUgPSAhIXZhbHVlO1xuICAgIGlmICh0aGlzLl9wcmVsb2FkID09PSB2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9wcmVsb2FkID0gdmFsdWU7XG4gICAgaWYgKHRoaXMuX3ByZWxvYWQgJiYgIXRoaXMubG9hZGVkICYmICF0aGlzLmxvYWRpbmcgJiYgdGhpcy5yZWdpc3RyeSkge1xuICAgICAgdGhpcy5yZWdpc3RyeS5sb2FkKHRoaXMpO1xuICAgIH1cbiAgfX0pO1xuICByZXR1cm4ge0Fzc2V0OkFzc2V0LCBBU1NFVF9BTklNQVRJT046XCJhbmltYXRpb25cIiwgQVNTRVRfQVVESU86XCJhdWRpb1wiLCBBU1NFVF9JTUFHRTpcImltYWdlXCIsIEFTU0VUX0pTT046XCJqc29uXCIsIEFTU0VUX01PREVMOlwibW9kZWxcIiwgQVNTRVRfTUFURVJJQUw6XCJtYXRlcmlhbFwiLCBBU1NFVF9URVhUOlwidGV4dFwiLCBBU1NFVF9URVhUVVJFOlwidGV4dHVyZVwiLCBBU1NFVF9DVUJFTUFQOlwiY3ViZW1hcFwiLCBBU1NFVF9TSEFERVI6XCJzaGFkZXJcIiwgQVNTRVRfQ1NTOlwiY3NzXCIsIEFTU0VUX0hUTUw6XCJodG1sXCIsIEFTU0VUX1NDUklQVDpcInNjcmlwdFwiLCBBQlNPTFVURV9VUkw6QUJTT0xVVEVfVVJMfTtcbn0oKSk7XG5wYy5leHRlbmQocGMsIGZ1bmN0aW9uKCkge1xuICB2YXIgcHJvcGVydGllcyA9IFtdO1xuICB2YXIgQXNzZXRWYXJpYW50cyA9IGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdGhpcy5hc3NldCA9IGFzc2V0O1xuICB9O1xuICB2YXIgZGVmaW5lVmFyaWFudFByb3BlcnR5ID0gZnVuY3Rpb24obmFtZSkge1xuICAgIHZhciBmaWVsZCA9IFwiX1wiICsgbmFtZTtcbiAgICBwcm9wZXJ0aWVzLnB1c2goZmllbGQpO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShBc3NldFZhcmlhbnRzLnByb3RvdHlwZSwgbmFtZSwge2dldDpmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzW2ZpZWxkXSB8fCBudWxsO1xuICAgIH0sIHNldDpmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgdmFyIGZpZWxkQXNCb29sID0gISF0aGlzW2ZpZWxkXTtcbiAgICAgIHZhciB2YWx1ZUFzQm9vbCA9ICEhdmFsdWU7XG4gICAgICBpZiAoZmllbGRBc0Jvb2wgIT09IHZhbHVlQXNCb29sIHx8IHRoaXNbZmllbGRdICYmIHZhbHVlICYmIHRoaXNbZmllbGRdLmhhc2ggIT09IHZhbHVlLmhhc2gpIHtcbiAgICAgICAgdmFyIG9sZCA9IHRoaXNbZmllbGRdO1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICB0aGlzW2ZpZWxkXSA9IHt1cmw6dmFsdWUudXJsLCBmaWxlbmFtZTp2YWx1ZS5maWxlbmFtZSwgc2l6ZTp2YWx1ZS5zaXplLCBoYXNoOnZhbHVlLmhhc2gsIG9wdDp2YWx1ZS5vcHQgfHwgMH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpc1tmaWVsZF0gPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFzc2V0LmZpbGUpIHtcbiAgICAgICAgICB0aGlzLmFzc2V0LmZpcmUoXCJjaGFuZ2VcIiwgdGhpcy5hc3NldCwgXCJmaWxlXCIsIHRoaXMuYXNzZXQuX2ZpbGUsIHRoaXMuYXNzZXQuX2ZpbGUpO1xuICAgICAgICAgIHRoaXMuYXNzZXQucmVsb2FkKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9fSk7XG4gIH07XG4gIGRlZmluZVZhcmlhbnRQcm9wZXJ0eShcImR4dFwiKTtcbiAgZGVmaW5lVmFyaWFudFByb3BlcnR5KFwicHZyXCIpO1xuICBkZWZpbmVWYXJpYW50UHJvcGVydHkoXCJldGMxXCIpO1xuICBBc3NldFZhcmlhbnRzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkge1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBwcm9wZXJ0aWVzLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXNbcHJvcGVydGllc1tpXV0gPSBudWxsO1xuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHtBc3NldFZhcmlhbnRzOkFzc2V0VmFyaWFudHN9O1xufSgpKTtcbnBjLmV4dGVuZChwYywgZnVuY3Rpb24oKSB7XG4gIHZhciBBc3NldFJlZ2lzdHJ5ID0gZnVuY3Rpb24obG9hZGVyKSB7XG4gICAgdGhpcy5fbG9hZGVyID0gbG9hZGVyO1xuICAgIHRoaXMuX2Fzc2V0cyA9IFtdO1xuICAgIHRoaXMuX2NhY2hlID0ge307XG4gICAgdGhpcy5fbmFtZXMgPSB7fTtcbiAgICB0aGlzLl90YWdzID0gbmV3IHBjLlRhZ3NDYWNoZShcIl9pZFwiKTtcbiAgICB0aGlzLl91cmxzID0ge307XG4gICAgdGhpcy5wcmVmaXggPSBudWxsO1xuICAgIHBjLmV4dGVuZCh0aGlzLCBwYy5ldmVudHMpO1xuICB9O1xuICBBc3NldFJlZ2lzdHJ5LnByb3RvdHlwZSA9IHtsaXN0OmZ1bmN0aW9uKGZpbHRlcnMpIHtcbiAgICBmaWx0ZXJzID0gZmlsdGVycyB8fCB7fTtcbiAgICByZXR1cm4gdGhpcy5fYXNzZXRzLmZpbHRlcihmdW5jdGlvbihhc3NldCkge1xuICAgICAgdmFyIGluY2x1ZGUgPSB0cnVlO1xuICAgICAgaWYgKGZpbHRlcnMucHJlbG9hZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGluY2x1ZGUgPSBhc3NldC5wcmVsb2FkID09PSBmaWx0ZXJzLnByZWxvYWQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gaW5jbHVkZTtcbiAgICB9KTtcbiAgfSwgYWRkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgdmFyIGluZGV4ID0gdGhpcy5fYXNzZXRzLnB1c2goYXNzZXQpIC0gMTtcbiAgICB2YXIgdXJsO1xuICAgIHRoaXMuX2NhY2hlW2Fzc2V0LmlkXSA9IGluZGV4O1xuICAgIGlmICghdGhpcy5fbmFtZXNbYXNzZXQubmFtZV0pIHtcbiAgICAgIHRoaXMuX25hbWVzW2Fzc2V0Lm5hbWVdID0gW107XG4gICAgfVxuICAgIHRoaXMuX25hbWVzW2Fzc2V0Lm5hbWVdLnB1c2goaW5kZXgpO1xuICAgIGlmIChhc3NldC5maWxlKSB7XG4gICAgICB1cmwgPSBhc3NldC5maWxlLnVybDtcbiAgICAgIHRoaXMuX3VybHNbdXJsXSA9IGluZGV4O1xuICAgIH1cbiAgICBhc3NldC5yZWdpc3RyeSA9IHRoaXM7XG4gICAgdGhpcy5fdGFncy5hZGRJdGVtKGFzc2V0KTtcbiAgICBhc3NldC50YWdzLm9uKFwiYWRkXCIsIHRoaXMuX29uVGFnQWRkLCB0aGlzKTtcbiAgICBhc3NldC50YWdzLm9uKFwicmVtb3ZlXCIsIHRoaXMuX29uVGFnUmVtb3ZlLCB0aGlzKTtcbiAgICB0aGlzLmZpcmUoXCJhZGRcIiwgYXNzZXQpO1xuICAgIHRoaXMuZmlyZShcImFkZDpcIiArIGFzc2V0LmlkLCBhc3NldCk7XG4gICAgaWYgKHVybCkge1xuICAgICAgdGhpcy5maXJlKFwiYWRkOnVybDpcIiArIHVybCwgYXNzZXQpO1xuICAgIH1cbiAgICBpZiAoYXNzZXQucHJlbG9hZCkge1xuICAgICAgdGhpcy5sb2FkKGFzc2V0KTtcbiAgICB9XG4gIH0sIHJlbW92ZTpmdW5jdGlvbihhc3NldCkge1xuICAgIGRlbGV0ZSB0aGlzLl9jYWNoZVthc3NldC5pZF07XG4gICAgZGVsZXRlIHRoaXMuX25hbWVzW2Fzc2V0Lm5hbWVdO1xuICAgIHZhciB1cmwgPSBhc3NldC5maWxlID8gYXNzZXQuZmlsZS51cmwgOiBudWxsO1xuICAgIGlmICh1cmwpIHtcbiAgICAgIGRlbGV0ZSB0aGlzLl91cmxzW3VybF07XG4gICAgfVxuICAgIHRoaXMuX3RhZ3MucmVtb3ZlSXRlbShhc3NldCk7XG4gICAgYXNzZXQudGFncy5vZmYoXCJhZGRcIiwgdGhpcy5fb25UYWdBZGQsIHRoaXMpO1xuICAgIGFzc2V0LnRhZ3Mub2ZmKFwicmVtb3ZlXCIsIHRoaXMuX29uVGFnUmVtb3ZlLCB0aGlzKTtcbiAgICBhc3NldC5maXJlKFwicmVtb3ZlXCIsIGFzc2V0KTtcbiAgICB0aGlzLmZpcmUoXCJyZW1vdmVcIiwgYXNzZXQpO1xuICAgIHRoaXMuZmlyZShcInJlbW92ZTpcIiArIGFzc2V0LmlkLCBhc3NldCk7XG4gICAgaWYgKHVybCkge1xuICAgICAgdGhpcy5maXJlKFwicmVtb3ZlOnVybDpcIiArIHVybCwgYXNzZXQpO1xuICAgIH1cbiAgfSwgZ2V0OmZ1bmN0aW9uKGlkKSB7XG4gICAgdmFyIGlkeCA9IHRoaXMuX2NhY2hlW2lkXTtcbiAgICByZXR1cm4gdGhpcy5fYXNzZXRzW2lkeF07XG4gIH0sIGdldEJ5VXJsOmZ1bmN0aW9uKHVybCkge1xuICAgIHZhciBpZHggPSB0aGlzLl91cmxzW3VybF07XG4gICAgcmV0dXJuIHRoaXMuX2Fzc2V0c1tpZHhdO1xuICB9LCBsb2FkOmZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgaWYgKGFzc2V0LmxvYWRpbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGlmIChhc3NldC5sb2FkZWQpIHtcbiAgICAgIGlmIChhc3NldC50eXBlID09PSBcImN1YmVtYXBcIikge1xuICAgICAgICBzZWxmLl9sb2FkZXIucGF0Y2goYXNzZXQsIHRoaXMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbG9hZCA9ICEhYXNzZXQuZmlsZTtcbiAgICB2YXIgZmlsZSA9IGFzc2V0LmdldFByZWZlcnJlZEZpbGUoKTtcbiAgICB2YXIgX2xvYWQgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciB1cmwgPSBhc3NldC5nZXRGaWxlVXJsKCk7XG4gICAgICBhc3NldC5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgIHNlbGYuX2xvYWRlci5sb2FkKHVybCwgYXNzZXQudHlwZSwgZnVuY3Rpb24oZXJyLCByZXNvdXJjZSwgZXh0cmEpIHtcbiAgICAgICAgYXNzZXQubG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgYXNzZXQubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgc2VsZi5maXJlKFwiZXJyb3JcIiwgZXJyLCBhc3NldCk7XG4gICAgICAgICAgc2VsZi5maXJlKFwiZXJyb3I6XCIgKyBhc3NldC5pZCwgZXJyLCBhc3NldCk7XG4gICAgICAgICAgYXNzZXQuZmlyZShcImVycm9yXCIsIGVyciwgYXNzZXQpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzb3VyY2UgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgIGFzc2V0LnJlc291cmNlcyA9IHJlc291cmNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFzc2V0LnJlc291cmNlID0gcmVzb3VyY2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFwYy5zY3JpcHQubGVnYWN5ICYmIGFzc2V0LnR5cGUgPT09IFwic2NyaXB0XCIpIHtcbiAgICAgICAgICB2YXIgbG9hZGVyID0gc2VsZi5fbG9hZGVyLmdldEhhbmRsZXIoXCJzY3JpcHRcIik7XG4gICAgICAgICAgaWYgKGxvYWRlci5fY2FjaGVbYXNzZXQuaWRdICYmIGxvYWRlci5fY2FjaGVbYXNzZXQuaWRdLnBhcmVudE5vZGUgPT09IGRvY3VtZW50LmhlYWQpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQobG9hZGVyLl9jYWNoZVthc3NldC5pZF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2FkZXIuX2NhY2hlW2Fzc2V0LmlkXSA9IGV4dHJhO1xuICAgICAgICB9XG4gICAgICAgIHNlbGYuX2xvYWRlci5wYXRjaChhc3NldCwgc2VsZik7XG4gICAgICAgIHNlbGYuZmlyZShcImxvYWRcIiwgYXNzZXQpO1xuICAgICAgICBzZWxmLmZpcmUoXCJsb2FkOlwiICsgYXNzZXQuaWQsIGFzc2V0KTtcbiAgICAgICAgaWYgKGZpbGUgJiYgZmlsZS51cmwpIHtcbiAgICAgICAgICBzZWxmLmZpcmUoXCJsb2FkOnVybDpcIiArIGZpbGUudXJsLCBhc3NldCk7XG4gICAgICAgIH1cbiAgICAgICAgYXNzZXQuZmlyZShcImxvYWRcIiwgYXNzZXQpO1xuICAgICAgfSwgYXNzZXQpO1xuICAgIH07XG4gICAgdmFyIF9vcGVuID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgcmVzb3VyY2UgPSBzZWxmLl9sb2FkZXIub3Blbihhc3NldC50eXBlLCBhc3NldC5kYXRhKTtcbiAgICAgIGlmIChyZXNvdXJjZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgIGFzc2V0LnJlc291cmNlcyA9IHJlc291cmNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXNzZXQucmVzb3VyY2UgPSByZXNvdXJjZTtcbiAgICAgIH1cbiAgICAgIGFzc2V0LmxvYWRlZCA9IHRydWU7XG4gICAgICBzZWxmLl9sb2FkZXIucGF0Y2goYXNzZXQsIHNlbGYpO1xuICAgICAgc2VsZi5maXJlKFwibG9hZFwiLCBhc3NldCk7XG4gICAgICBzZWxmLmZpcmUoXCJsb2FkOlwiICsgYXNzZXQuaWQsIGFzc2V0KTtcbiAgICAgIGlmIChmaWxlICYmIGZpbGUudXJsKSB7XG4gICAgICAgIHNlbGYuZmlyZShcImxvYWQ6dXJsOlwiICsgZmlsZS51cmwsIGFzc2V0KTtcbiAgICAgIH1cbiAgICAgIGFzc2V0LmZpcmUoXCJsb2FkXCIsIGFzc2V0KTtcbiAgICB9O1xuICAgIGlmIChmaWxlICYmIGFzc2V0LnR5cGUgPT09IFwiY3ViZW1hcFwiKSB7XG4gICAgICBsb2FkID0gZmFsc2U7XG4gICAgICB2YXIgdXJsID0gYXNzZXQuZ2V0RmlsZVVybCgpO1xuICAgICAgdGhpcy5fbG9hZGVyLmxvYWQodXJsLCBcInRleHR1cmVcIiwgZnVuY3Rpb24oZXJyLCB0ZXh0dXJlKSB7XG4gICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgc2VsZi5fbG9hZGVyLnBhdGNoKHtyZXNvdXJjZTp0ZXh0dXJlLCB0eXBlOlwidGV4dHVyZVwiLCBkYXRhOmFzc2V0LmRhdGF9LCBzZWxmKTtcbiAgICAgICAgICBhc3NldC5fZGRzID0gdGV4dHVyZTtcbiAgICAgICAgICBfb3BlbigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNlbGYuZmlyZShcImVycm9yXCIsIGVyciwgYXNzZXQpO1xuICAgICAgICAgIHNlbGYuZmlyZShcImVycm9yOlwiICsgYXNzZXQuaWQsIGVyciwgYXNzZXQpO1xuICAgICAgICAgIGFzc2V0LmZpcmUoXCJlcnJvclwiLCBlcnIsIGFzc2V0KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoIWZpbGUpIHtcbiAgICAgIF9vcGVuKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChsb2FkKSB7XG4gICAgICAgIHRoaXMuZmlyZShcImxvYWQ6c3RhcnRcIiwgYXNzZXQpO1xuICAgICAgICB0aGlzLmZpcmUoXCJsb2FkOlwiICsgYXNzZXQuaWQgKyBcIjpzdGFydFwiLCBhc3NldCk7XG4gICAgICAgIF9sb2FkKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBsb2FkRnJvbVVybDpmdW5jdGlvbih1cmwsIHR5cGUsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBuYW1lID0gcGMucGF0aC5nZXRCYXNlbmFtZSh1cmwpO1xuICAgIHZhciBmaWxlID0ge3VybDp1cmx9O1xuICAgIHZhciBkYXRhID0ge307XG4gICAgdmFyIGFzc2V0ID0gc2VsZi5nZXRCeVVybCh1cmwpO1xuICAgIGlmICghYXNzZXQpIHtcbiAgICAgIGFzc2V0ID0gbmV3IHBjLkFzc2V0KG5hbWUsIHR5cGUsIGZpbGUsIGRhdGEpO1xuICAgICAgc2VsZi5hZGQoYXNzZXQpO1xuICAgIH1cbiAgICBpZiAodHlwZSA9PT0gXCJtb2RlbFwiKSB7XG4gICAgICBzZWxmLl9sb2FkTW9kZWwoYXNzZXQsIGNhbGxiYWNrKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXNzZXQub25jZShcImxvYWRcIiwgZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIGFzc2V0KTtcbiAgICB9KTtcbiAgICBhc3NldC5vbmNlKFwiZXJyb3JcIiwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICBjYWxsYmFjayhlcnIpO1xuICAgIH0pO1xuICAgIHNlbGYubG9hZChhc3NldCk7XG4gIH0sIF9sb2FkTW9kZWw6ZnVuY3Rpb24oYXNzZXQsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciB1cmwgPSBhc3NldC5nZXRGaWxlVXJsKCk7XG4gICAgdmFyIGRpciA9IHBjLnBhdGguZ2V0RGlyZWN0b3J5KHVybCk7XG4gICAgdmFyIGJhc2VuYW1lID0gcGMucGF0aC5nZXRCYXNlbmFtZSh1cmwpO1xuICAgIHZhciBuYW1lID0gYmFzZW5hbWUucmVwbGFjZShcIi5qc29uXCIsIFwiXCIpO1xuICAgIHZhciBleHQgPSBwYy5wYXRoLmdldEV4dGVuc2lvbih1cmwpO1xuICAgIHZhciBfbG9hZEFzc2V0ID0gZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgIGFzc2V0Lm9uY2UoXCJsb2FkXCIsIGZ1bmN0aW9uKGFzc2V0KSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGFzc2V0KTtcbiAgICAgIH0pO1xuICAgICAgYXNzZXQub25jZShcImVycm9yXCIsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgfSk7XG4gICAgICBzZWxmLmxvYWQoYXNzZXQpO1xuICAgIH07XG4gICAgaWYgKGV4dCA9PT0gXCIuanNvblwiKSB7XG4gICAgICB2YXIgbWFwcGluZ1VybCA9IHBjLnBhdGguam9pbihkaXIsIGJhc2VuYW1lLnJlcGxhY2UoXCIuanNvblwiLCBcIi5tYXBwaW5nLmpzb25cIikpO1xuICAgICAgdGhpcy5fbG9hZGVyLmxvYWQobWFwcGluZ1VybCwgXCJqc29uXCIsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgYXNzZXQuZGF0YSA9IHttYXBwaW5nOltdfTtcbiAgICAgICAgICBfbG9hZEFzc2V0KGFzc2V0KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgc2VsZi5fbG9hZE1hdGVyaWFscyhkaXIsIGRhdGEsIGZ1bmN0aW9uKGVyciwgbWF0ZXJpYWxzKSB7XG4gICAgICAgICAgYXNzZXQuZGF0YSA9IGRhdGE7XG4gICAgICAgICAgX2xvYWRBc3NldChhc3NldCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9sb2FkQXNzZXQoYXNzZXQpO1xuICAgIH1cbiAgfSwgX2xvYWRNYXRlcmlhbHM6ZnVuY3Rpb24oZGlyLCBtYXBwaW5nLCBjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgaTtcbiAgICB2YXIgY291bnQgPSBtYXBwaW5nLm1hcHBpbmcubGVuZ3RoO1xuICAgIHZhciBtYXRlcmlhbHMgPSBbXTtcbiAgICB2YXIgZG9uZSA9IGZ1bmN0aW9uKGVyciwgbWF0ZXJpYWxzKSB7XG4gICAgICBzZWxmLl9sb2FkVGV4dHVyZXMobWF0ZXJpYWxzLCBmdW5jdGlvbihlcnIsIHRleHR1cmVzKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIG1hdGVyaWFscyk7XG4gICAgICB9KTtcbiAgICB9O1xuICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgY2FsbGJhY2sobnVsbCwgbWF0ZXJpYWxzKTtcbiAgICB9XG4gICAgdmFyIG9uTG9hZEFzc2V0ID0gZnVuY3Rpb24oZXJyLCBhc3NldCkge1xuICAgICAgbWF0ZXJpYWxzLnB1c2goYXNzZXQpO1xuICAgICAgY291bnQtLTtcbiAgICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgICBkb25lKG51bGwsIG1hdGVyaWFscyk7XG4gICAgICB9XG4gICAgfTtcbiAgICBmb3IgKGkgPSAwO2kgPCBtYXBwaW5nLm1hcHBpbmcubGVuZ3RoO2krKykge1xuICAgICAgdmFyIHBhdGggPSBtYXBwaW5nLm1hcHBpbmdbaV0ucGF0aDtcbiAgICAgIGlmIChwYXRoKSB7XG4gICAgICAgIHNlbGYubG9hZEZyb21VcmwocGMucGF0aC5qb2luKGRpciwgcGF0aCksIFwibWF0ZXJpYWxcIiwgb25Mb2FkQXNzZXQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY291bnQtLTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIF9sb2FkVGV4dHVyZXM6ZnVuY3Rpb24obWF0ZXJpYWxzLCBjYWxsYmFjaykge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgaSwgajtcbiAgICB2YXIgdXNlZCA9IHt9O1xuICAgIHZhciB1cmxzID0gW107XG4gICAgdmFyIHRleHR1cmVzID0gW107XG4gICAgdmFyIGNvdW50ID0gMDtcbiAgICBmb3IgKGkgPSAwO2kgPCBtYXRlcmlhbHMubGVuZ3RoO2krKykge1xuICAgICAgaWYgKG1hdGVyaWFsc1tpXS5kYXRhLnBhcmFtZXRlcnMpIHtcbiAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGVyaWFsc1tpXS5kYXRhLnBhcmFtZXRlcnM7XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IHBhcmFtcy5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgaWYgKHBhcmFtc1tqXS50eXBlID09PSBcInRleHR1cmVcIikge1xuICAgICAgICAgICAgdmFyIHVybCA9IG1hdGVyaWFsc1tpXS5nZXRGaWxlVXJsKCk7XG4gICAgICAgICAgICB2YXIgZGlyID0gcGMucGF0aC5nZXREaXJlY3RvcnkodXJsKTtcbiAgICAgICAgICAgIHVybCA9IHBjLnBhdGguam9pbihkaXIsIHBhcmFtc1tqXS5kYXRhKTtcbiAgICAgICAgICAgIGlmICghdXNlZFt1cmxdKSB7XG4gICAgICAgICAgICAgIHVzZWRbdXJsXSA9IHRydWU7XG4gICAgICAgICAgICAgIHVybHMucHVzaCh1cmwpO1xuICAgICAgICAgICAgICBjb3VudCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiVXBkYXRlIG1hdGVyaWFsIGFzc2V0IGxvYWRlciB0byBzdXBwb3J0IG5ldyBtYXRlcmlhbCBmb3JtYXRcIik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghY291bnQpIHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHRleHR1cmVzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIG9uTG9hZEFzc2V0ID0gZnVuY3Rpb24oZXJyLCB0ZXh0dXJlKSB7XG4gICAgICB0ZXh0dXJlcy5wdXNoKHRleHR1cmUpO1xuICAgICAgY291bnQtLTtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgfVxuICAgICAgaWYgKGNvdW50ID09PSAwKSB7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHRleHR1cmVzKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGZvciAoaSA9IDA7aSA8IHVybHMubGVuZ3RoO2krKykge1xuICAgICAgc2VsZi5sb2FkRnJvbVVybCh1cmxzW2ldLCBcInRleHR1cmVcIiwgb25Mb2FkQXNzZXQpO1xuICAgIH1cbiAgfSwgZmluZEFsbDpmdW5jdGlvbihuYW1lLCB0eXBlKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBpZHhzID0gdGhpcy5fbmFtZXNbbmFtZV07XG4gICAgdmFyIGFzc2V0cztcbiAgICBpZiAoaWR4cykge1xuICAgICAgYXNzZXRzID0gaWR4cy5tYXAoZnVuY3Rpb24oaWR4KSB7XG4gICAgICAgIHJldHVybiBzZWxmLl9hc3NldHNbaWR4XTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgcmV0dXJuIGFzc2V0cy5maWx0ZXIoZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICByZXR1cm4gYXNzZXQudHlwZSA9PT0gdHlwZTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gYXNzZXRzO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9LCBfb25UYWdBZGQ6ZnVuY3Rpb24odGFnLCBhc3NldCkge1xuICAgIHRoaXMuX3RhZ3MuYWRkKHRhZywgYXNzZXQpO1xuICB9LCBfb25UYWdSZW1vdmU6ZnVuY3Rpb24odGFnLCBhc3NldCkge1xuICAgIHRoaXMuX3RhZ3MucmVtb3ZlKHRhZywgYXNzZXQpO1xuICB9LCBmaW5kQnlUYWc6ZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RhZ3MuZmluZChhcmd1bWVudHMpO1xuICB9LCBmaWx0ZXI6ZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB2YXIgaXRlbXMgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fYXNzZXRzLmxlbmd0aDtpIDwgbGVuO2krKykge1xuICAgICAgaWYgKGNhbGxiYWNrKHRoaXMuX2Fzc2V0c1tpXSkpIHtcbiAgICAgICAgaXRlbXMucHVzaCh0aGlzLl9hc3NldHNbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaXRlbXM7XG4gIH0sIGZpbmQ6ZnVuY3Rpb24obmFtZSwgdHlwZSkge1xuICAgIHZhciBhc3NldCA9IHRoaXMuZmluZEFsbChuYW1lLCB0eXBlKTtcbiAgICByZXR1cm4gYXNzZXQgPyBhc3NldFswXSA6IG51bGw7XG4gIH0sIGdldEFzc2V0QnlJZDpmdW5jdGlvbihpZCkge1xuICAgIGNvbnNvbGUud2FybihcIkRFUFJFQ0FURUQ6IGdldEFzc2V0QnlJZCgpIHVzZSBnZXQoKSBpbnN0ZWFkXCIpO1xuICAgIHJldHVybiB0aGlzLmdldChpZCk7XG4gIH19O1xuICByZXR1cm4ge0Fzc2V0UmVnaXN0cnk6QXNzZXRSZWdpc3RyeX07XG59KCkpO1xucGMuYW5pbSA9IHtBbmltYXRpb246cGMuQW5pbWF0aW9uLCBLZXk6cGMuS2V5LCBOb2RlOnBjLk5vZGUsIFNrZWxldG9uOnBjLlNrZWxldG9ufTtcbnBjLmFzc2V0ID0ge0FTU0VUX0FOSU1BVElPTjpcImFuaW1hdGlvblwiLCBBU1NFVF9BVURJTzpcImF1ZGlvXCIsIEFTU0VUX0lNQUdFOlwiaW1hZ2VcIiwgQVNTRVRfSlNPTjpcImpzb25cIiwgQVNTRVRfTU9ERUw6XCJtb2RlbFwiLCBBU1NFVF9NQVRFUklBTDpcIm1hdGVyaWFsXCIsIEFTU0VUX1RFWFQ6XCJ0ZXh0XCIsIEFTU0VUX1RFWFRVUkU6XCJ0ZXh0dXJlXCIsIEFTU0VUX0NVQkVNQVA6XCJjdWJlbWFwXCIsIEFTU0VUX1NDUklQVDpcInNjcmlwdFwifTtcbnBjLmF1ZGlvID0ge0F1ZGlvTWFuYWdlcjpwYy5Tb3VuZE1hbmFnZXIsIENoYW5uZWw6cGMuQ2hhbm5lbCwgQ2hhbm5lbDNkOnBjLkNoYW5uZWwzZCwgTGlzdGVuZXI6cGMuTGlzdGVuZXIsIFNvdW5kOnBjLlNvdW5kfTtcbnBjLmZ3ID0ge0FwcGxpY2F0aW9uOnBjLkFwcGxpY2F0aW9uLCBDb21wb25lbnQ6cGMuQ29tcG9uZW50LCBDb21wb25lbnREYXRhOnBjLkNvbXBvbmVudERhdGEsIENvbXBvbmVudFN5c3RlbTpwYy5Db21wb25lbnRTeXN0ZW0sIEVudGl0eTpwYy5FbnRpdHksIEZpbGxNb2RlOntOT05FOnBjLkZJTExNT0RFX05PTkUsIEZJTExfV0lORE9XOnBjLkZJTExNT0RFX0ZJTExfV0lORE9XLCBLRUVQX0FTUEVDVDpwYy5GSUxMTU9ERV9LRUVQX0FTUEVDVH0sIFJlc29sdXRpb25Nb2RlOntBVVRPOnBjLlJFU09MVVRJT05fQVVUTywgRklYRUQ6cGMuUkVTT0xVVElPTl9GSVhFRH19O1xucGMuZXh0ZW5kKHBjLmdmeCwge2RyYXdRdWFkV2l0aFNoYWRlcjpwYy5kcmF3UXVhZFdpdGhTaGFkZXIsIHByZWNhbGN1bGF0ZWRUYW5nZW50czpwYy5wcmVjYWxjdWxhdGVkVGFuZ2VudHMsIHByb2dyYW1saWI6cGMucHJvZ3JhbWxpYiwgc2hhZGVyQ2h1bmtzOnBjLnNoYWRlckNodW5rcywgQ29udGV4dENyZWF0aW9uRXJyb3I6cGMuQ29udGV4dENyZWF0aW9uRXJyb3IsIERldmljZTpwYy5HcmFwaGljc0RldmljZSwgSW5kZXhCdWZmZXI6cGMuSW5kZXhCdWZmZXIsIFByb2dyYW1MaWJyYXJ5OnBjLlByb2dyYW1MaWJyYXJ5LCBSZW5kZXJUYXJnZXQ6cGMuUmVuZGVyVGFyZ2V0LCBTY29wZUlkOnBjLlNjb3BlSWQsIFNoYWRlcjpwYy5TaGFkZXIsIFNoYWRlcklucHV0OnBjLlNoYWRlcklucHV0LCBUZXh0dXJlOnBjLlRleHR1cmUsIFVuc3VwcG9ydGVkQnJvd3NlckVycm9yOnBjLlVuc3VwcG9ydGVkQnJvd3NlckVycm9yLCBWZXJ0ZXhCdWZmZXI6cGMuVmVydGV4QnVmZmVyLCBWZXJ0ZXhGb3JtYXQ6cGMuVmVydGV4Rm9ybWF0LFxuVmVydGV4SXRlcmF0b3I6cGMuVmVydGV4SXRlcmF0b3J9KTtcbnBjLmV4dGVuZChwYy5pbnB1dCwge2dldFRvdWNoVGFyZ2V0Q29vcmRzOnBjLmdldFRvdWNoVGFyZ2V0Q29vcmRzLCBDb250cm9sbGVyOnBjLkNvbnRyb2xsZXIsIEdhbWVQYWRzOnBjLkdhbWVQYWRzLCBLZXlib2FyZDpwYy5LZXlib2FyZCwgS2V5Ym9hcmRFdmVudDpwYy5LZXlib2FyZEV2ZW50LCBNb3VzZTpwYy5Nb3VzZSwgTW91c2VFdmVudDpwYy5Nb3VzZUV2ZW50LCBUb3VjaDpwYy5Ub3VjaCwgVG91Y2hEZXZpY2U6cGMuVG91Y2hEZXZpY2UsIFRvdWNoRXZlbnQ6cGMuVG91Y2hFdmVudH0pO1xucGMucG9zdGVmZmVjdCA9IHtjcmVhdGVGdWxsc2NyZWVuUXVhZDpwYy5jcmVhdGVGdWxsc2NyZWVuUXVhZCwgZHJhd0Z1bGxzY3JlZW5RdWFkOnBjLmRyYXdGdWxsc2NyZWVuUXVhZCwgUG9zdEVmZmVjdDpwYy5Qb3N0RWZmZWN0LCBQb3N0RWZmZWN0UXVldWU6cGMuUG9zdEVmZmVjdFF1ZXVlfTtcbnBjLmV4dGVuZChwYy5zY2VuZSwge3BhcnRpdGlvblNraW46cGMucGFydGl0aW9uU2tpbiwgcHJvY2VkdXJhbDp7Y2FsY3VsYXRlVGFuZ2VudHM6cGMuY2FsY3VsYXRlVGFuZ2VudHMsIGNyZWF0ZU1lc2g6cGMuY3JlYXRlTWVzaCwgY3JlYXRlVG9ydXM6cGMuY3JlYXRlVG9ydXMsIGNyZWF0ZUN5bGluZGVyOnBjLmNyZWF0ZUN5bGluZGVyLCBjcmVhdGVDYXBzdWxlOnBjLmNyZWF0ZUNhcHN1bGUsIGNyZWF0ZUNvbmU6cGMuY3JlYXRlQ29uZSwgY3JlYXRlU3BoZXJlOnBjLmNyZWF0ZVNwaGVyZSwgY3JlYXRlUGxhbmU6cGMuY3JlYXRlUGxhbmUsIGNyZWF0ZUJveDpwYy5jcmVhdGVCb3h9LCBCYXNpY01hdGVyaWFsOnBjLkJhc2ljTWF0ZXJpYWwsIERlcHRoTWF0ZXJpYWw6cGMuRGVwdGhNYXRlcmlhbCwgRm9yd2FyZFJlbmRlcmVyOnBjLkZvcndhcmRSZW5kZXJlciwgR3JhcGhOb2RlOnBjLkdyYXBoTm9kZSwgTWF0ZXJpYWw6cGMuTWF0ZXJpYWwsIENvbW1hbmQ6cGMuQ29tbWFuZCwgTWVzaDpwYy5NZXNoLFxuTWVzaEluc3RhbmNlOnBjLk1lc2hJbnN0YW5jZSwgTW9kZWw6cGMuTW9kZWwsIFBhcnRpY2xlRW1pdHRlcjpwYy5QYXJ0aWNsZUVtaXR0ZXIsIFBob25nTWF0ZXJpYWw6cGMuU3RhbmRhcmRNYXRlcmlhbCwgUGlja2VyOnBjLlBpY2tlciwgUGlja01hdGVyaWFsOnBjLlBpY2tNYXRlcmlhbCwgUHJvamVjdGlvbjp7T1JUSE9HUkFQSElDOnBjLlBST0pFQ1RJT05fT1JUSE9HUkFQSElDLCBQRVJTUEVDVElWRTpwYy5QUk9KRUNUSU9OX1BFUlNQRUNUSVZFfSwgU2NlbmU6cGMuU2NlbmUsIFNraW46cGMuU2tpbiwgU2tpbkluc3RhbmNlOnBjLlNraW5JbnN0YW5jZX0pO1xucGMuc2hhcGUgPSB7QWFiYjpwYy5Cb3VuZGluZ0JveCwgU3BoZXJlOnBjLkJvdW5kaW5nU3BoZXJlLCBQbGFuZTpwYy5QbGFuZX07XG5wYy50aW1lID0ge25vdzpwYy5ub3csIFRpbWVyOnBjLlRpbWVyfTtcbnBjLlBob25nTWF0ZXJpYWwgPSBwYy5TdGFuZGFyZE1hdGVyaWFsO1xucGMuQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmludGVyc2VjdFJheSA9IHBjLkJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3RzUmF5O1xucGMuRUxFTUVOVFRZUEVfSU5UOCA9IHBjLlRZUEVfSU5UODtcbnBjLkVMRU1FTlRUWVBFX1VJTlQ4ID0gcGMuVFlQRV9VSU5UODtcbnBjLkVMRU1FTlRUWVBFX0lOVDE2ID0gcGMuVFlQRV9JTlQxNjtcbnBjLkVMRU1FTlRUWVBFX1VJTlQxNiA9IHBjLlRZUEVfVUlOVDE2O1xucGMuRUxFTUVOVFRZUEVfSU5UMzIgPSBwYy5UWVBFX0lOVDMyO1xucGMuRUxFTUVOVFRZUEVfVUlOVDMyID0gcGMuVFlQRV9VSU5UMzI7XG5wYy5FTEVNRU5UVFlQRV9GTE9BVDMyID0gcGMuVFlQRV9GTE9BVDMyO1xucGMuZXh0ZW5kKHBjLkFwcGxpY2F0aW9uLnByb3RvdHlwZSwgZnVuY3Rpb24oKSB7XG4gIHZhciBsaW5lVmVydGV4Rm9ybWF0ID0gbnVsbDtcbiAgdmFyIGxpbmVCYXRjaGVzID0gW107XG4gIHZhciBxdWFkTWVzaCA9IG51bGw7XG4gIHZhciBjdWJlTG9jYWxQb3MgPSBudWxsO1xuICB2YXIgY3ViZVdvcmxkUG9zID0gbnVsbDtcbiAgdmFyIHRlbXBHcmFwaE5vZGUgPSBuZXcgcGMuR3JhcGhOb2RlO1xuICB2YXIgaWRlbnRpdHlHcmFwaE5vZGUgPSBuZXcgcGMuR3JhcGhOb2RlO1xuICB2YXIgbGluZUJhdGNoID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5udW1MaW5lc0FsbG9jYXRlZCA9IDEyODtcbiAgICB0aGlzLnZiID0gbnVsbDtcbiAgICB0aGlzLnZiUmFtID0gbnVsbDtcbiAgICB0aGlzLm1lc2ggPSBudWxsO1xuICAgIHRoaXMubGluZXNVc2VkID0gMDtcbiAgICB0aGlzLm1hdGVyaWFsID0gbnVsbDtcbiAgICB0aGlzLm1lc2hJbnN0YW5jZSA9IG51bGw7XG4gIH07XG4gIGxpbmVCYXRjaC5wcm90b3R5cGUgPSB7aW5pdDpmdW5jdGlvbihkZXZpY2UsIGxpbmVzVG9BZGQpIHtcbiAgICBpZiAoIXRoaXMubWVzaCkge1xuICAgICAgdGhpcy5tZXNoID0gbmV3IHBjLk1lc2g7XG4gICAgICB0aGlzLm1lc2gucHJpbWl0aXZlWzBdLnR5cGUgPSBwYy5QUklNSVRJVkVfTElORVM7XG4gICAgICB0aGlzLm1lc2gucHJpbWl0aXZlWzBdLmJhc2UgPSAwO1xuICAgICAgdGhpcy5tZXNoLnByaW1pdGl2ZVswXS5pbmRleGVkID0gZmFsc2U7XG4gICAgICB0aGlzLm1hdGVyaWFsID0gbmV3IHBjLkJhc2ljTWF0ZXJpYWw7XG4gICAgICB0aGlzLm1hdGVyaWFsLnZlcnRleENvbG9ycyA9IHRydWU7XG4gICAgICB0aGlzLm1hdGVyaWFsLmJsZW5kID0gdHJ1ZTtcbiAgICAgIHRoaXMubWF0ZXJpYWwuYmxlbmRUeXBlID0gcGMuQkxFTkRfTk9STUFMO1xuICAgICAgdGhpcy5tYXRlcmlhbC51cGRhdGUoKTtcbiAgICB9XG4gICAgd2hpbGUgKHRoaXMubGluZXNVc2VkICsgbGluZXNUb0FkZCA+IHRoaXMubnVtTGluZXNBbGxvY2F0ZWQpIHtcbiAgICAgIHRoaXMudmIgPSBudWxsO1xuICAgICAgdGhpcy5udW1MaW5lc0FsbG9jYXRlZCAqPSAyO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudmIpIHtcbiAgICAgIHRoaXMudmIgPSBuZXcgcGMuVmVydGV4QnVmZmVyKGRldmljZSwgbGluZVZlcnRleEZvcm1hdCwgdGhpcy5udW1MaW5lc0FsbG9jYXRlZCAqIDIsIHBjLkJVRkZFUl9EWU5BTUlDKTtcbiAgICAgIHRoaXMubWVzaC52ZXJ0ZXhCdWZmZXIgPSB0aGlzLnZiO1xuICAgICAgdGhpcy52YlJhbSA9IG5ldyBEYXRhVmlldyh0aGlzLnZiLmxvY2soKSk7XG4gICAgICBpZiAoIXRoaXMubWVzaEluc3RhbmNlKSB7XG4gICAgICAgIGlkZW50aXR5R3JhcGhOb2RlLndvcmxkVHJhbnNmb3JtID0gcGMuTWF0NC5JREVOVElUWTtcbiAgICAgICAgaWRlbnRpdHlHcmFwaE5vZGUuX2RpcnR5V29ybGQgPSBpZGVudGl0eUdyYXBoTm9kZS5fZGlydHlOb3JtYWwgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tZXNoSW5zdGFuY2UgPSBuZXcgcGMuTWVzaEluc3RhbmNlKGlkZW50aXR5R3JhcGhOb2RlLCB0aGlzLm1lc2gsIHRoaXMubWF0ZXJpYWwpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgYWRkTGluZXM6ZnVuY3Rpb24ocG9zaXRpb24sIGNvbG9yKSB7XG4gICAgdmFyIG11bHRpQ29sb3IgPSAhIWNvbG9yLmxlbmd0aDtcbiAgICB2YXIgb2Zmc2V0ID0gdGhpcy5saW5lc1VzZWQgKiAyICogbGluZVZlcnRleEZvcm1hdC5zaXplO1xuICAgIHZhciBjbHI7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHBvc2l0aW9uLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMudmJSYW0uc2V0RmxvYXQzMihvZmZzZXQsIHBvc2l0aW9uW2ldLngsIHRydWUpO1xuICAgICAgb2Zmc2V0ICs9IDQ7XG4gICAgICB0aGlzLnZiUmFtLnNldEZsb2F0MzIob2Zmc2V0LCBwb3NpdGlvbltpXS55LCB0cnVlKTtcbiAgICAgIG9mZnNldCArPSA0O1xuICAgICAgdGhpcy52YlJhbS5zZXRGbG9hdDMyKG9mZnNldCwgcG9zaXRpb25baV0ueiwgdHJ1ZSk7XG4gICAgICBvZmZzZXQgKz0gNDtcbiAgICAgIGNsciA9IG11bHRpQ29sb3IgPyBjb2xvcltpXSA6IGNvbG9yO1xuICAgICAgdGhpcy52YlJhbS5zZXRVaW50OChvZmZzZXQsIGNsci5yICogMjU1KTtcbiAgICAgIG9mZnNldCArPSAxO1xuICAgICAgdGhpcy52YlJhbS5zZXRVaW50OChvZmZzZXQsIGNsci5nICogMjU1KTtcbiAgICAgIG9mZnNldCArPSAxO1xuICAgICAgdGhpcy52YlJhbS5zZXRVaW50OChvZmZzZXQsIGNsci5iICogMjU1KTtcbiAgICAgIG9mZnNldCArPSAxO1xuICAgICAgdGhpcy52YlJhbS5zZXRVaW50OChvZmZzZXQsIGNsci5hICogMjU1KTtcbiAgICAgIG9mZnNldCArPSAxO1xuICAgIH1cbiAgICB0aGlzLmxpbmVzVXNlZCArPSBwb3NpdGlvbi5sZW5ndGggLyAyO1xuICB9LCBmaW5hbGl6ZTpmdW5jdGlvbihkcmF3Q2FsbHMpIHtcbiAgICBpZiAodGhpcy5saW5lc1VzZWQgPiAwKSB7XG4gICAgICB0aGlzLnZiLnNldERhdGEodGhpcy52YlJhbS5idWZmZXIpO1xuICAgICAgdGhpcy5tZXNoLnByaW1pdGl2ZVswXS5jb3VudCA9IHRoaXMubGluZXNVc2VkICogMjtcbiAgICAgIGRyYXdDYWxscy5wdXNoKHRoaXMubWVzaEluc3RhbmNlKTtcbiAgICAgIHRoaXMubGluZXNVc2VkID0gMDtcbiAgICB9XG4gIH19O1xuICBmdW5jdGlvbiBfYWRkTGluZXMoYmF0Y2hJZCwgcG9zaXRpb24sIGNvbG9yKSB7XG4gICAgaWYgKCFsaW5lVmVydGV4Rm9ybWF0KSB7XG4gICAgICBsaW5lVmVydGV4Rm9ybWF0ID0gbmV3IHBjLlZlcnRleEZvcm1hdCh0aGlzLmdyYXBoaWNzRGV2aWNlLCBbe3NlbWFudGljOnBjLlNFTUFOVElDX1BPU0lUSU9OLCBjb21wb25lbnRzOjMsIHR5cGU6cGMuVFlQRV9GTE9BVDMyfSwge3NlbWFudGljOnBjLlNFTUFOVElDX0NPTE9SLCBjb21wb25lbnRzOjQsIHR5cGU6cGMuVFlQRV9VSU5UOCwgbm9ybWFsaXplOnRydWV9XSk7XG4gICAgICB0aGlzLm9uKFwicHJlcmVuZGVyXCIsIHRoaXMuX3ByZVJlbmRlckltbWVkaWF0ZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICghbGluZUJhdGNoZXNbYmF0Y2hJZF0pIHtcbiAgICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdID0gbmV3IGxpbmVCYXRjaDtcbiAgICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdLmluaXQodGhpcy5ncmFwaGljc0RldmljZSwgcG9zaXRpb24ubGVuZ3RoIC8gMik7XG4gICAgICBpZiAoYmF0Y2hJZCA9PT0gcGMuTElORUJBVENIX09WRVJMQVkpIHtcbiAgICAgICAgbGluZUJhdGNoZXNbYmF0Y2hJZF0ubWF0ZXJpYWwuZGVwdGhUZXN0ID0gZmFsc2U7XG4gICAgICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdLm1lc2hJbnN0YW5jZS5sYXllciA9IHBjLkxBWUVSX0dJWk1PO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGJhdGNoSWQgPT09IHBjLkxJTkVCQVRDSF9HSVpNTykge1xuICAgICAgICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdLm1lc2hJbnN0YW5jZS5sYXllciA9IHBjLkxBWUVSX0dJWk1PO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdLmluaXQodGhpcy5ncmFwaGljc0RldmljZSwgcG9zaXRpb24ubGVuZ3RoIC8gMik7XG4gICAgfVxuICAgIGxpbmVCYXRjaGVzW2JhdGNoSWRdLmFkZExpbmVzKHBvc2l0aW9uLCBjb2xvcik7XG4gIH1cbiAgZnVuY3Rpb24gcmVuZGVyTGluZShzdGFydCwgZW5kLCBjb2xvciwgYXJnMywgYXJnNCkge1xuICAgIHZhciBlbmRDb2xvciA9IGNvbG9yO1xuICAgIHZhciBsaW5lVHlwZSA9IHBjLkxJTkVCQVRDSF9XT1JMRDtcbiAgICBpZiAoYXJnMykge1xuICAgICAgaWYgKHR5cGVvZiBhcmczID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgIGxpbmVUeXBlID0gYXJnMztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVuZENvbG9yID0gYXJnMztcbiAgICAgICAgaWYgKGFyZzQpIHtcbiAgICAgICAgICBsaW5lVHlwZSA9IGFyZzQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fYWRkTGluZXMobGluZVR5cGUsIFtzdGFydCwgZW5kXSwgW2NvbG9yLCBlbmRDb2xvcl0pO1xuICB9XG4gIGZ1bmN0aW9uIHJlbmRlckxpbmVzKHBvc2l0aW9uLCBjb2xvciwgbGluZVR5cGUpIHtcbiAgICBpZiAobGluZVR5cGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGluZVR5cGUgPSBwYy5MSU5FQkFUQ0hfV09STEQ7XG4gICAgfVxuICAgIHZhciBtdWx0aUNvbG9yID0gISFjb2xvci5sZW5ndGg7XG4gICAgaWYgKG11bHRpQ29sb3IpIHtcbiAgICAgIGlmIChwb3NpdGlvbi5sZW5ndGggIT09IGNvbG9yLmxlbmd0aCkge1xuICAgICAgICBwYy5sb2cuZXJyb3IoXCJyZW5kZXJMaW5lczogcG9zaXRpb24vY29sb3IgYXJyYXlzIGhhdmUgZGlmZmVyZW50IGxlbmd0aHNcIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBvc2l0aW9uLmxlbmd0aCAlIDIgIT09IDApIHtcbiAgICAgIHBjLmxvZy5lcnJvcihcInJlbmRlckxpbmVzOiBhcnJheSBsZW5ndGggaXMgbm90IGRpdmlzaWJsZSBieSAyXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9hZGRMaW5lcyhsaW5lVHlwZSwgcG9zaXRpb24sIGNvbG9yKTtcbiAgfVxuICBmdW5jdGlvbiByZW5kZXJXaXJlQ3ViZShtYXRyaXgsIGNvbG9yLCBsaW5lVHlwZSkge1xuICAgIGlmIChsaW5lVHlwZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsaW5lVHlwZSA9IHBjLkxJTkVCQVRDSF9XT1JMRDtcbiAgICB9XG4gICAgdmFyIGk7XG4gICAgaWYgKCFjdWJlTG9jYWxQb3MpIHtcbiAgICAgIHZhciB4ID0gMC41O1xuICAgICAgY3ViZUxvY2FsUG9zID0gW25ldyBwYy5WZWMzKC14LCAteCwgLXgpLCBuZXcgcGMuVmVjMygteCwgeCwgLXgpLCBuZXcgcGMuVmVjMyh4LCB4LCAteCksIG5ldyBwYy5WZWMzKHgsIC14LCAteCksIG5ldyBwYy5WZWMzKC14LCAteCwgeCksIG5ldyBwYy5WZWMzKC14LCB4LCB4KSwgbmV3IHBjLlZlYzMoeCwgeCwgeCksIG5ldyBwYy5WZWMzKHgsIC14LCB4KV07XG4gICAgICBjdWJlV29ybGRQb3MgPSBbbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzLCBuZXcgcGMuVmVjMywgbmV3IHBjLlZlYzMsIG5ldyBwYy5WZWMzXTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgODtpKyspIHtcbiAgICAgIG1hdHJpeC50cmFuc2Zvcm1Qb2ludChjdWJlTG9jYWxQb3NbaV0sIGN1YmVXb3JsZFBvc1tpXSk7XG4gICAgfVxuICAgIHRoaXMucmVuZGVyTGluZXMoW2N1YmVXb3JsZFBvc1swXSwgY3ViZVdvcmxkUG9zWzFdLCBjdWJlV29ybGRQb3NbMV0sIGN1YmVXb3JsZFBvc1syXSwgY3ViZVdvcmxkUG9zWzJdLCBjdWJlV29ybGRQb3NbM10sIGN1YmVXb3JsZFBvc1szXSwgY3ViZVdvcmxkUG9zWzBdLCBjdWJlV29ybGRQb3NbNF0sIGN1YmVXb3JsZFBvc1s1XSwgY3ViZVdvcmxkUG9zWzVdLCBjdWJlV29ybGRQb3NbNl0sIGN1YmVXb3JsZFBvc1s2XSwgY3ViZVdvcmxkUG9zWzddLCBjdWJlV29ybGRQb3NbN10sIGN1YmVXb3JsZFBvc1s0XSwgY3ViZVdvcmxkUG9zWzBdLCBjdWJlV29ybGRQb3NbNF0sIGN1YmVXb3JsZFBvc1sxXSwgY3ViZVdvcmxkUG9zWzVdLCBjdWJlV29ybGRQb3NbMl0sIGN1YmVXb3JsZFBvc1s2XSwgY3ViZVdvcmxkUG9zWzNdLCBjdWJlV29ybGRQb3NbN11dLCBjb2xvciwgbGluZVR5cGUpO1xuICB9XG4gIGZ1bmN0aW9uIF9wcmVSZW5kZXJJbW1lZGlhdGUoKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IDM7aSsrKSB7XG4gICAgICBpZiAobGluZUJhdGNoZXNbaV0pIHtcbiAgICAgICAgbGluZUJhdGNoZXNbaV0uZmluYWxpemUodGhpcy5zY2VuZS5pbW1lZGlhdGVEcmF3Q2FsbHMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBmdW5jdGlvbiByZW5kZXJNZXNoSW5zdGFuY2UobWVzaEluc3RhbmNlKSB7XG4gICAgdGhpcy5zY2VuZS5pbW1lZGlhdGVEcmF3Q2FsbHMucHVzaChtZXNoSW5zdGFuY2UpO1xuICB9XG4gIGZ1bmN0aW9uIHJlbmRlck1lc2gobWVzaCwgbWF0ZXJpYWwsIG1hdHJpeCkge1xuICAgIHRlbXBHcmFwaE5vZGUud29ybGRUcmFuc2Zvcm0gPSBtYXRyaXg7XG4gICAgdGVtcEdyYXBoTm9kZS5fZGlydHlXb3JsZCA9IHRlbXBHcmFwaE5vZGUuX2RpcnR5Tm9ybWFsID0gZmFsc2U7XG4gICAgdmFyIGluc3RhbmNlID0gbmV3IHBjLk1lc2hJbnN0YW5jZSh0ZW1wR3JhcGhOb2RlLCBtZXNoLCBtYXRlcmlhbCk7XG4gICAgdGhpcy5zY2VuZS5pbW1lZGlhdGVEcmF3Q2FsbHMucHVzaChpbnN0YW5jZSk7XG4gIH1cbiAgZnVuY3Rpb24gcmVuZGVyUXVhZChtYXRyaXgsIG1hdGVyaWFsLCBsYXllcikge1xuICAgIGlmICghcXVhZE1lc2gpIHtcbiAgICAgIHZhciBmb3JtYXQgPSBuZXcgcGMuVmVydGV4Rm9ybWF0KHRoaXMuZ3JhcGhpY3NEZXZpY2UsIFt7c2VtYW50aWM6cGMuU0VNQU5USUNfUE9TSVRJT04sIGNvbXBvbmVudHM6MywgdHlwZTpwYy5UWVBFX0ZMT0FUMzJ9XSk7XG4gICAgICB2YXIgcXVhZFZiID0gbmV3IHBjLlZlcnRleEJ1ZmZlcih0aGlzLmdyYXBoaWNzRGV2aWNlLCBmb3JtYXQsIDQpO1xuICAgICAgdmFyIGl0ZXJhdG9yID0gbmV3IHBjLlZlcnRleEl0ZXJhdG9yKHF1YWRWYik7XG4gICAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX1BPU0lUSU9OXS5zZXQoLTAuNSwgLTAuNSwgMCk7XG4gICAgICBpdGVyYXRvci5uZXh0KCk7XG4gICAgICBpdGVyYXRvci5lbGVtZW50W3BjLlNFTUFOVElDX1BPU0lUSU9OXS5zZXQoMC41LCAtMC41LCAwKTtcbiAgICAgIGl0ZXJhdG9yLm5leHQoKTtcbiAgICAgIGl0ZXJhdG9yLmVsZW1lbnRbcGMuU0VNQU5USUNfUE9TSVRJT05dLnNldCgtMC41LCAwLjUsIDApO1xuICAgICAgaXRlcmF0b3IubmV4dCgpO1xuICAgICAgaXRlcmF0b3IuZWxlbWVudFtwYy5TRU1BTlRJQ19QT1NJVElPTl0uc2V0KDAuNSwgMC41LCAwKTtcbiAgICAgIGl0ZXJhdG9yLmVuZCgpO1xuICAgICAgcXVhZE1lc2ggPSBuZXcgcGMuTWVzaDtcbiAgICAgIHF1YWRNZXNoLnZlcnRleEJ1ZmZlciA9IHF1YWRWYjtcbiAgICAgIHF1YWRNZXNoLnByaW1pdGl2ZVswXS50eXBlID0gcGMuUFJJTUlUSVZFX1RSSVNUUklQO1xuICAgICAgcXVhZE1lc2gucHJpbWl0aXZlWzBdLmJhc2UgPSAwO1xuICAgICAgcXVhZE1lc2gucHJpbWl0aXZlWzBdLmNvdW50ID0gNDtcbiAgICAgIHF1YWRNZXNoLnByaW1pdGl2ZVswXS5pbmRleGVkID0gZmFsc2U7XG4gICAgfVxuICAgIHRlbXBHcmFwaE5vZGUud29ybGRUcmFuc2Zvcm0gPSBtYXRyaXg7XG4gICAgdGVtcEdyYXBoTm9kZS5fZGlydHlXb3JsZCA9IHRlbXBHcmFwaE5vZGUuX2RpcnR5Tm9ybWFsID0gZmFsc2U7XG4gICAgdmFyIHF1YWQgPSBuZXcgcGMuTWVzaEluc3RhbmNlKHRlbXBHcmFwaE5vZGUsIHF1YWRNZXNoLCBtYXRlcmlhbCk7XG4gICAgaWYgKGxheWVyKSB7XG4gICAgICBxdWFkLmxheWVyID0gbGF5ZXI7XG4gICAgfVxuICAgIHRoaXMuc2NlbmUuaW1tZWRpYXRlRHJhd0NhbGxzLnB1c2gocXVhZCk7XG4gIH1cbiAgcmV0dXJuIHtyZW5kZXJNZXNoSW5zdGFuY2U6cmVuZGVyTWVzaEluc3RhbmNlLCByZW5kZXJNZXNoOnJlbmRlck1lc2gsIHJlbmRlckxpbmU6cmVuZGVyTGluZSwgcmVuZGVyTGluZXM6cmVuZGVyTGluZXMsIHJlbmRlclF1YWQ6cmVuZGVyUXVhZCwgcmVuZGVyV2lyZUN1YmU6cmVuZGVyV2lyZUN1YmUsIF9hZGRMaW5lczpfYWRkTGluZXMsIF9wcmVSZW5kZXJJbW1lZGlhdGU6X3ByZVJlbmRlckltbWVkaWF0ZX07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIG1heFNpemUgPSAyMDQ4O1xuICB2YXIgbWFza0R5bmFtaWMgPSAxO1xuICB2YXIgbWFza0Jha2VkID0gMjtcbiAgdmFyIG1hc2tMaWdodG1hcCA9IDQ7XG4gIHZhciBzY2VuZUxpZ2h0bWFwcyA9IFtdO1xuICB2YXIgc2NlbmVMaWdodG1hcHNOb2RlID0gW107XG4gIHZhciBsbUNhbWVyYTtcbiAgdmFyIHRlbXBWZWMgPSBuZXcgcGMuVmVjMztcbiAgdmFyIGJvdW5kcyA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgdmFyIGxpZ2h0Qm91bmRzID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICB2YXIgdGVtcFNwaGVyZSA9IHt9O1xuICB2YXIgUEFTU19DT0xPUiA9IDA7XG4gIHZhciBQQVNTX0RJUiA9IDE7XG4gIHZhciBwYXNzVGV4TmFtZSA9IFtcInRleHR1cmVfbGlnaHRNYXBcIiwgXCJ0ZXh0dXJlX2RpckxpZ2h0TWFwXCJdO1xuICB2YXIgcGFzc01hdGVyaWFsID0gW107XG4gIGZ1bmN0aW9uIGNvbGxlY3RNb2RlbHMobm9kZSwgbm9kZXMsIG5vZGVzTWVzaEluc3RhbmNlcywgYWxsTm9kZXMpIHtcbiAgICBpZiAoIW5vZGUuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgaTtcbiAgICBpZiAobm9kZS5tb2RlbCAmJiBub2RlLm1vZGVsLm1vZGVsICYmIG5vZGUubW9kZWwuZW5hYmxlZCkge1xuICAgICAgaWYgKGFsbE5vZGVzKSB7XG4gICAgICAgIGFsbE5vZGVzLnB1c2gobm9kZSk7XG4gICAgICB9XG4gICAgICBpZiAobm9kZS5tb2RlbC5kYXRhLmxpZ2h0bWFwcGVkKSB7XG4gICAgICAgIGlmIChub2Rlcykge1xuICAgICAgICAgIHZhciBoYXNVdjEgPSB0cnVlO1xuICAgICAgICAgIHZhciBtZXNoSW5zdGFuY2VzID0gbm9kZS5tb2RlbC5tb2RlbC5tZXNoSW5zdGFuY2VzO1xuICAgICAgICAgIGZvciAoaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgaWYgKCFtZXNoSW5zdGFuY2VzW2ldLm1lc2gudmVydGV4QnVmZmVyLmZvcm1hdC5oYXNVdjEpIHtcbiAgICAgICAgICAgICAgaGFzVXYxID0gZmFsc2U7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoaGFzVXYxKSB7XG4gICAgICAgICAgICB2YXIgajtcbiAgICAgICAgICAgIHZhciBpc0luc3RhbmNlO1xuICAgICAgICAgICAgdmFyIG5vdEluc3RhbmNlZE1lc2hJbnN0YW5jZXMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgICAgICAgICBpc0luc3RhbmNlID0gZmFsc2U7XG4gICAgICAgICAgICAgIGZvciAoaiA9IDA7aiA8IG1lc2hJbnN0YW5jZXMubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgICAgIGlmIChpICE9PSBqKSB7XG4gICAgICAgICAgICAgICAgICBpZiAobWVzaEluc3RhbmNlc1tpXS5tZXNoID09PSBtZXNoSW5zdGFuY2VzW2pdLm1lc2gpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNJbnN0YW5jZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChpc0luc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgbm9kZXMucHVzaChub2RlKTtcbiAgICAgICAgICAgICAgICBub2Rlc01lc2hJbnN0YW5jZXMucHVzaChbbWVzaEluc3RhbmNlc1tpXV0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5vdEluc3RhbmNlZE1lc2hJbnN0YW5jZXMucHVzaChtZXNoSW5zdGFuY2VzW2ldKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG5vdEluc3RhbmNlZE1lc2hJbnN0YW5jZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpO1xuICAgICAgICAgICAgICBub2Rlc01lc2hJbnN0YW5jZXMucHVzaChub3RJbnN0YW5jZWRNZXNoSW5zdGFuY2VzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbm9kZS5fY2hpbGRyZW4ubGVuZ3RoO2krKykge1xuICAgICAgY29sbGVjdE1vZGVscyhub2RlLl9jaGlsZHJlbltpXSwgbm9kZXMsIG5vZGVzTWVzaEluc3RhbmNlcywgYWxsTm9kZXMpO1xuICAgIH1cbiAgfVxuICB2YXIgTGlnaHRtYXBwZXIgPSBmdW5jdGlvbihkZXZpY2UsIHJvb3QsIHNjZW5lLCByZW5kZXJlciwgYXNzZXRzKSB7XG4gICAgdGhpcy5kZXZpY2UgPSBkZXZpY2U7XG4gICAgdGhpcy5yb290ID0gcm9vdDtcbiAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyO1xuICAgIHRoaXMuYXNzZXRzID0gYXNzZXRzO1xuICB9O1xuICBMaWdodG1hcHBlci5wcm90b3R5cGUgPSB7Y2FsY3VsYXRlTGlnaHRtYXBTaXplOmZ1bmN0aW9uKG5vZGUpIHtcbiAgICB2YXIgZGF0YSwgcGFyZW50O1xuICAgIHZhciBzaXplTXVsdCA9IHRoaXMuc2NlbmUubGlnaHRtYXBTaXplTXVsdGlwbGllciB8fCAxNjtcbiAgICB2YXIgc2NhbGUgPSB0ZW1wVmVjO1xuICAgIHZhciBhcmVhID0ge3g6MSwgeToxLCB6OjEsIHV2OjF9O1xuICAgIGlmIChub2RlLm1vZGVsLmFzc2V0KSB7XG4gICAgICBkYXRhID0gdGhpcy5hc3NldHMuZ2V0KG5vZGUubW9kZWwuYXNzZXQpLmRhdGE7XG4gICAgICBpZiAoZGF0YS5hcmVhKSB7XG4gICAgICAgIGFyZWEueCA9IGRhdGEuYXJlYS54O1xuICAgICAgICBhcmVhLnkgPSBkYXRhLmFyZWEueTtcbiAgICAgICAgYXJlYS56ID0gZGF0YS5hcmVhLno7XG4gICAgICAgIGFyZWEudXYgPSBkYXRhLmFyZWEudXY7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChub2RlLm1vZGVsLl9hcmVhKSB7XG4gICAgICAgIGRhdGEgPSBub2RlLm1vZGVsO1xuICAgICAgICBpZiAoZGF0YS5fYXJlYSkge1xuICAgICAgICAgIGFyZWEueCA9IGRhdGEuX2FyZWEueDtcbiAgICAgICAgICBhcmVhLnkgPSBkYXRhLl9hcmVhLnk7XG4gICAgICAgICAgYXJlYS56ID0gZGF0YS5fYXJlYS56O1xuICAgICAgICAgIGFyZWEudXYgPSBkYXRhLl9hcmVhLnV2O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBhcmVhTXVsdCA9IG5vZGUubW9kZWwubGlnaHRtYXBTaXplTXVsdGlwbGllciB8fCAxO1xuICAgIGFyZWEueCAqPSBhcmVhTXVsdDtcbiAgICBhcmVhLnkgKj0gYXJlYU11bHQ7XG4gICAgYXJlYS56ICo9IGFyZWFNdWx0O1xuICAgIHNjYWxlLmNvcHkobm9kZS5sb2NhbFNjYWxlKTtcbiAgICBwYXJlbnQgPSBub2RlLl9wYXJlbnQ7XG4gICAgd2hpbGUgKHBhcmVudCkge1xuICAgICAgc2NhbGUubXVsKHBhcmVudC5sb2NhbFNjYWxlKTtcbiAgICAgIHBhcmVudCA9IHBhcmVudC5fcGFyZW50O1xuICAgIH1cbiAgICBzY2FsZS54ID0gTWF0aC5hYnMoc2NhbGUueCk7XG4gICAgc2NhbGUueSA9IE1hdGguYWJzKHNjYWxlLnkpO1xuICAgIHNjYWxlLnogPSBNYXRoLmFicyhzY2FsZS56KTtcbiAgICB2YXIgdG90YWxBcmVhID0gYXJlYS54ICogc2NhbGUueSAqIHNjYWxlLnogKyBhcmVhLnkgKiBzY2FsZS54ICogc2NhbGUueiArIGFyZWEueiAqIHNjYWxlLnggKiBzY2FsZS55O1xuICAgIHRvdGFsQXJlYSAvPSBhcmVhLnV2O1xuICAgIHRvdGFsQXJlYSA9IE1hdGguc3FydCh0b3RhbEFyZWEpO1xuICAgIHJldHVybiBNYXRoLm1pbihwYy5tYXRoLm5leHRQb3dlck9mVHdvKHRvdGFsQXJlYSAqIHNpemVNdWx0KSwgdGhpcy5zY2VuZS5saWdodG1hcE1heFJlc29sdXRpb24gfHwgbWF4U2l6ZSk7XG4gIH0sIGJha2U6ZnVuY3Rpb24obm9kZXMsIG1vZGUpIHtcbiAgICB2YXIgaSwgajtcbiAgICB2YXIgZGV2aWNlID0gdGhpcy5kZXZpY2U7XG4gICAgdmFyIHNjZW5lID0gdGhpcy5zY2VuZTtcbiAgICB2YXIgcGFzc0NvdW50ID0gMTtcbiAgICBpZiAobW9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtb2RlID0gcGMuQkFLRV9DT0xPUkRJUjtcbiAgICB9XG4gICAgaWYgKG1vZGUgPT09IHBjLkJBS0VfQ09MT1JESVIpIHtcbiAgICAgIHBhc3NDb3VudCA9IDI7XG4gICAgfVxuICAgIHZhciBwYXNzO1xuICAgIHZhciBhbGxOb2RlcyA9IFtdO1xuICAgIHZhciBub2Rlc01lc2hJbnN0YW5jZXMgPSBbXTtcbiAgICBpZiAoIW5vZGVzKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCBzY2VuZUxpZ2h0bWFwcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IHNjZW5lTGlnaHRtYXBzW2ldLmxlbmd0aDtqKyspIHtcbiAgICAgICAgICBzY2VuZUxpZ2h0bWFwc1tpXVtqXS5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHNjZW5lTGlnaHRtYXBzID0gW107XG4gICAgICBzY2VuZUxpZ2h0bWFwc05vZGUgPSBbXTtcbiAgICAgIG5vZGVzID0gW107XG4gICAgICBjb2xsZWN0TW9kZWxzKHRoaXMucm9vdCwgbm9kZXMsIG5vZGVzTWVzaEluc3RhbmNlcywgYWxsTm9kZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgaztcbiAgICAgIGZvciAoaSA9IHNjZW5lTGlnaHRtYXBzTm9kZS5sZW5ndGggLSAxO2kgPj0gMDtpLS0pIHtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbm9kZXMubGVuZ3RoO2orKykge1xuICAgICAgICAgIGlmIChzY2VuZUxpZ2h0bWFwc05vZGVbaV0gPT09IG5vZGVzW2pdKSB7XG4gICAgICAgICAgICBmb3IgKGsgPSAwO2sgPCBzY2VuZUxpZ2h0bWFwc1tpXS5sZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIHNjZW5lTGlnaHRtYXBzW2ldW2tdLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNjZW5lTGlnaHRtYXBzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIHNjZW5lTGlnaHRtYXBzTm9kZS5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB2YXIgX25vZGVzID0gW107XG4gICAgICBmb3IgKGkgPSAwO2kgPCBub2Rlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGNvbGxlY3RNb2RlbHMobm9kZXNbaV0sIF9ub2Rlcywgbm9kZXNNZXNoSW5zdGFuY2VzKTtcbiAgICAgIH1cbiAgICAgIG5vZGVzID0gX25vZGVzO1xuICAgICAgY29sbGVjdE1vZGVscyh0aGlzLnJvb3QsIG51bGwsIG51bGwsIGFsbE5vZGVzKTtcbiAgICB9XG4gICAgaWYgKG5vZGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgZGV2aWNlLmZpcmUoXCJsaWdodG1hcHBlcjplbmRcIiwge3RpbWVzdGFtcDpwYy5ub3coKSwgdGFyZ2V0OnRoaXN9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHJldmVydFN0YXRpYyA9IGZhbHNlO1xuICAgIGlmIChzY2VuZS5fbmVlZHNTdGF0aWNQcmVwYXJlKSB7XG4gICAgICBzY2VuZS5fbmVlZHNTdGF0aWNQcmVwYXJlID0gZmFsc2U7XG4gICAgICByZXZlcnRTdGF0aWMgPSB0cnVlO1xuICAgIH1cbiAgICB2YXIgdGV4U2l6ZSA9IFtdO1xuICAgIHZhciBsbWFwcyA9IFtbXSwgW11dO1xuICAgIHZhciB0ZXhQb29sID0ge307XG4gICAgdmFyIHNpemU7XG4gICAgdmFyIHRleDtcbiAgICB2YXIgaW5zdGFuY2VzO1xuICAgIHZhciBibGFja1RleCA9IG5ldyBwYy5UZXh0dXJlKHRoaXMuZGV2aWNlLCB7d2lkdGg6NCwgaGVpZ2h0OjQsIGZvcm1hdDpwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgcmdibTp0cnVlfSk7XG4gICAgZm9yIChpID0gMDtpIDwgbm9kZXMubGVuZ3RoO2krKykge1xuICAgICAgc2l6ZSA9IHRoaXMuY2FsY3VsYXRlTGlnaHRtYXBTaXplKG5vZGVzW2ldKTtcbiAgICAgIHRleFNpemUucHVzaChzaXplKTtcbiAgICAgIGZvciAocGFzcyA9IDA7cGFzcyA8IHBhc3NDb3VudDtwYXNzKyspIHtcbiAgICAgICAgdGV4ID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7d2lkdGg6c2l6ZSwgaGVpZ2h0OnNpemUsIGZvcm1hdDpwYy5QSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgbWlwbWFwczpmYWxzZSwgcmdibTpwYXNzID09PSBQQVNTX0NPTE9SLCBtaW5GaWx0ZXI6cGMuRklMVEVSX05FQVJFU1QsIG1hZ0ZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVH0pO1xuICAgICAgICBsbWFwc1twYXNzXS5wdXNoKHRleCk7XG4gICAgICB9XG4gICAgICBpZiAoIXRleFBvb2xbc2l6ZV0pIHtcbiAgICAgICAgdmFyIHRleDIgPSBuZXcgcGMuVGV4dHVyZShkZXZpY2UsIHt3aWR0aDpzaXplLCBoZWlnaHQ6c2l6ZSwgZm9ybWF0OnBjLlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4LCBtaXBtYXBzOmZhbHNlLCByZ2JtOnRydWUsIG1pbkZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVCwgbWFnRmlsdGVyOnBjLkZJTFRFUl9ORUFSRVNUfSk7XG4gICAgICAgIHZhciB0YXJnMiA9IG5ldyBwYy5SZW5kZXJUYXJnZXQoZGV2aWNlLCB0ZXgyLCB7ZGVwdGg6ZmFsc2V9KTtcbiAgICAgICAgdGV4UG9vbFtzaXplXSA9IHRhcmcyO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgbGlnaHRzID0gW107XG4gICAgdmFyIG9yaWdNYXNrID0gW107XG4gICAgdmFyIG9yaWdTaGFkb3dNb2RlID0gW107XG4gICAgdmFyIG9yaWdFbmFibGVkID0gW107XG4gICAgdmFyIHNjZW5lTGlnaHRzID0gc2NlbmUuX2xpZ2h0cztcbiAgICB2YXIgbWFzaztcbiAgICBmb3IgKGkgPSAwO2kgPCBzY2VuZUxpZ2h0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAoc2NlbmVMaWdodHNbaV0uX2VuYWJsZWQpIHtcbiAgICAgICAgbWFzayA9IHNjZW5lTGlnaHRzW2ldLl9tYXNrO1xuICAgICAgICBpZiAoKG1hc2sgJiBtYXNrTGlnaHRtYXApICE9PSAwKSB7XG4gICAgICAgICAgb3JpZ01hc2sucHVzaChtYXNrKTtcbiAgICAgICAgICBvcmlnU2hhZG93TW9kZS5wdXNoKHNjZW5lTGlnaHRzW2ldLnNoYWRvd1VwZGF0ZU1vZGUpO1xuICAgICAgICAgIHNjZW5lTGlnaHRzW2ldLl9tYXNrID0gNDI5NDk2NzI5NTtcbiAgICAgICAgICBzY2VuZUxpZ2h0c1tpXS5zaGFkb3dVcGRhdGVNb2RlID0gc2NlbmVMaWdodHNbaV0uX3R5cGUgPT09IHBjLkxJR0hUVFlQRV9ESVJFQ1RJT05BTCA/IHBjLlNIQURPV1VQREFURV9SRUFMVElNRSA6IHBjLlNIQURPV1VQREFURV9USElTRlJBTUU7XG4gICAgICAgICAgbGlnaHRzLnB1c2goc2NlbmVMaWdodHNbaV0pO1xuICAgICAgICAgIHNjZW5lTGlnaHRzW2ldLmlzU3RhdGljID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG9yaWdFbmFibGVkLnB1c2goc2NlbmVMaWdodHNbaV0uX2VuYWJsZWQpO1xuICAgICAgc2NlbmVMaWdodHNbaV0uZW5hYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgY2h1bmtzID0gcGMuc2hhZGVyQ2h1bmtzO1xuICAgIHZhciB4Zm9ybVV2MSA9IGNodW5rcy50cmFuc2Zvcm1VdjFWUztcbiAgICB2YXIgYmFrZUxtRW5kID0gY2h1bmtzLmJha2VMbUVuZFBTO1xuICAgIHZhciBkaWxhdGUgPSBjaHVua3MuZGlsYXRlUFM7XG4gICAgdmFyIGRpbGF0ZVNoYWRlciA9IGNodW5rcy5jcmVhdGVTaGFkZXJGcm9tQ29kZShkZXZpY2UsIGNodW5rcy5mdWxsc2NyZWVuUXVhZFZTLCBkaWxhdGUsIFwibG1EaWxhdGVcIik7XG4gICAgdmFyIGNvbnN0YW50VGV4U291cmNlID0gZGV2aWNlLnNjb3BlLnJlc29sdmUoXCJzb3VyY2VcIik7XG4gICAgdmFyIGNvbnN0YW50UGl4ZWxPZmZzZXQgPSBkZXZpY2Uuc2NvcGUucmVzb2x2ZShcInBpeGVsT2Zmc2V0XCIpO1xuICAgIHZhciBjb25zdGFudEJha2VEaXIgPSBkZXZpY2Uuc2NvcGUucmVzb2x2ZShcImJha2VEaXJcIik7XG4gICAgdmFyIHBpeGVsT2Zmc2V0ID0gbmV3IHBjLlZlYzI7XG4gICAgdmFyIGxtcyA9IHt9O1xuICAgIHZhciBkcmF3Q2FsbHMgPSBzY2VuZS5kcmF3Q2FsbHM7XG4gICAgZm9yIChpID0gMDtpIDwgZHJhd0NhbGxzLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmIChkcmF3Q2FsbHNbaV0ubm9kZSkge1xuICAgICAgICBkcmF3Q2FsbHNbaV0ubm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgb3JpZ0ZvZyA9IHNjZW5lLmZvZztcbiAgICB2YXIgb3JpZ0FtYmllbnRSID0gc2NlbmUuYW1iaWVudExpZ2h0LmRhdGFbMF07XG4gICAgdmFyIG9yaWdBbWJpZW50RyA9IHNjZW5lLmFtYmllbnRMaWdodC5kYXRhWzFdO1xuICAgIHZhciBvcmlnQW1iaWVudEIgPSBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVsyXTtcbiAgICB2YXIgb3JpZ0RyYXdDYWxscyA9IHNjZW5lLmRyYXdDYWxscztcbiAgICBzY2VuZS5mb2cgPSBwYy5GT0dfTk9ORTtcbiAgICBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVswXSA9IDA7XG4gICAgc2NlbmUuYW1iaWVudExpZ2h0LmRhdGFbMV0gPSAwO1xuICAgIHNjZW5lLmFtYmllbnRMaWdodC5kYXRhWzJdID0gMDtcbiAgICBpZiAoIWxtQ2FtZXJhKSB7XG4gICAgICBsbUNhbWVyYSA9IG5ldyBwYy5DYW1lcmE7XG4gICAgICBsbUNhbWVyYS5fbm9kZSA9IG5ldyBwYy5HcmFwaE5vZGU7XG4gICAgICBsbUNhbWVyYS5jbGVhckNvbG9yWzBdID0gMDtcbiAgICAgIGxtQ2FtZXJhLmNsZWFyQ29sb3JbMV0gPSAwO1xuICAgICAgbG1DYW1lcmEuY2xlYXJDb2xvclsyXSA9IDA7XG4gICAgICBsbUNhbWVyYS5jbGVhckNvbG9yWzNdID0gMDtcbiAgICAgIGxtQ2FtZXJhLmNsZWFyRGVwdGggPSAxO1xuICAgICAgbG1DYW1lcmEuY2xlYXJGbGFncyA9IHBjLkNMRUFSRkxBR19DT0xPUjtcbiAgICAgIGxtQ2FtZXJhLmNsZWFyU3RlbmNpbCA9IG51bGw7XG4gICAgICBsbUNhbWVyYS5mcnVzdHVtQ3VsbGluZyA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgbm9kZTtcbiAgICB2YXIgbG0sIHJjdiwgbWF0LCBtO1xuICAgIHZhciBvcmlnU2hhZGVyRGVmcyA9IFtdO1xuICAgIG9yaWdTaGFkZXJEZWZzLmxlbmd0aCA9IHNjZW5lTGlnaHRtYXBzTm9kZS5sZW5ndGg7XG4gICAgdmFyIHNoYWRlckRlZnM7XG4gICAgZm9yIChub2RlID0gMDtub2RlIDwgYWxsTm9kZXMubGVuZ3RoO25vZGUrKykge1xuICAgICAgcmN2ID0gYWxsTm9kZXNbbm9kZV0ubW9kZWwubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgIHNoYWRlckRlZnMgPSBbXTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IHJjdi5sZW5ndGg7aSsrKSB7XG4gICAgICAgIHNoYWRlckRlZnMucHVzaChyY3ZbaV0uX3NoYWRlckRlZnMpO1xuICAgICAgICByY3ZbaV0uX3NoYWRlckRlZnMgJj0gfihwYy5TSEFERVJERUZfTE0gfCBwYy5TSEFERVJERUZfRElSTE0pO1xuICAgICAgfVxuICAgICAgZm9yIChpID0gMDtpIDwgc2NlbmVMaWdodG1hcHNOb2RlLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYgKHNjZW5lTGlnaHRtYXBzTm9kZVtpXSA9PT0gYWxsTm9kZXNbbm9kZV0pIHtcbiAgICAgICAgICBvcmlnU2hhZGVyRGVmc1tpXSA9IHNoYWRlckRlZnM7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIG9yaWdDYXN0U2hhZG93cyA9IFtdO1xuICAgIHZhciBvcmlnQ2FzdGVyczIgPSBzY2VuZS5zaGFkb3dDYXN0ZXJzLnNsaWNlKCk7XG4gICAgZm9yIChub2RlID0gMDtub2RlIDwgYWxsTm9kZXMubGVuZ3RoO25vZGUrKykge1xuICAgICAgb3JpZ0Nhc3RTaGFkb3dzW25vZGVdID0gYWxsTm9kZXNbbm9kZV0ubW9kZWwuY2FzdFNoYWRvd3M7XG4gICAgICBhbGxOb2Rlc1tub2RlXS5tb2RlbC5jYXN0U2hhZG93cyA9IGFsbE5vZGVzW25vZGVdLm1vZGVsLmRhdGEuY2FzdFNoYWRvd3NMaWdodG1hcDtcbiAgICB9XG4gICAgdmFyIG9yaWdDYXN0ZXJzID0gc2NlbmUuc2hhZG93Q2FzdGVycztcbiAgICB2YXIgY2FzdGVycyA9IFtdO1xuICAgIHZhciBpbnN0YW5jZUNsb25lLCBwcm9wO1xuICAgIGZvciAoaSA9IDA7aSA8IG9yaWdDYXN0ZXJzLmxlbmd0aDtpKyspIHtcbiAgICAgIG0gPSBvcmlnQ2FzdGVyc1tpXTtcbiAgICAgIGluc3RhbmNlQ2xvbmUgPSBuZXcgcGMuTWVzaEluc3RhbmNlKG0ubm9kZSwgbS5tZXNoLCBtLm1hdGVyaWFsKTtcbiAgICAgIGZvciAocHJvcCBpbiBtKSB7XG4gICAgICAgIGlmIChtLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgaW5zdGFuY2VDbG9uZVtwcm9wXSA9IG1bcHJvcF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNhc3RlcnMucHVzaChpbnN0YW5jZUNsb25lKTtcbiAgICB9XG4gICAgc2NlbmUuc2hhZG93Q2FzdGVycyA9IGNhc3RlcnM7XG4gICAgdmFyIG9yaWdNYXQgPSBbXTtcbiAgICB2YXIgbm9kZUJvdW5kcyA9IFtdO1xuICAgIHZhciBub2RlVGFyZyA9IFtbXSwgW11dO1xuICAgIHZhciB0YXJnLCB0YXJnVG1wLCB0ZXhUbXA7XG4gICAgdmFyIGxpZ2h0LCBzaGFkb3dDYW07XG4gICAgdmFyIG5vZGVMaWdodENvdW50ID0gW107XG4gICAgbm9kZUxpZ2h0Q291bnQubGVuZ3RoID0gbm9kZXMubGVuZ3RoO1xuICAgIHNjZW5lLnVwZGF0ZVNoYWRlcnNGdW5jKGRldmljZSk7XG4gICAgZm9yIChub2RlID0gMDtub2RlIDwgbm9kZXMubGVuZ3RoO25vZGUrKykge1xuICAgICAgcmN2ID0gbm9kZXNNZXNoSW5zdGFuY2VzW25vZGVdO1xuICAgICAgZm9yIChpID0gMDtpIDwgcmN2Lmxlbmd0aDtpKyspIHtcbiAgICAgICAgbWF0ID0gcmN2W2ldLm1hdGVyaWFsO1xuICAgICAgICBvcmlnTWF0LnB1c2gobWF0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGxtTWF0ZXJpYWw7XG4gICAgZm9yIChwYXNzID0gMDtwYXNzIDwgcGFzc0NvdW50O3Bhc3MrKykge1xuICAgICAgaWYgKCFwYXNzTWF0ZXJpYWxbcGFzc10pIHtcbiAgICAgICAgbG1NYXRlcmlhbCA9IG5ldyBwYy5TdGFuZGFyZE1hdGVyaWFsO1xuICAgICAgICBsbU1hdGVyaWFsLmNodW5rcy50cmFuc2Zvcm1WUyA9IHhmb3JtVXYxO1xuICAgICAgICBpZiAocGFzcyA9PT0gUEFTU19DT0xPUikge1xuICAgICAgICAgIGxtTWF0ZXJpYWwuY2h1bmtzLmVuZFBTID0gYmFrZUxtRW5kO1xuICAgICAgICAgIGxtTWF0ZXJpYWwuYW1iaWVudCA9IG5ldyBwYy5Db2xvcigwLCAwLCAwKTtcbiAgICAgICAgICBsbU1hdGVyaWFsLmFtYmllbnRUaW50ID0gdHJ1ZTtcbiAgICAgICAgICBsbU1hdGVyaWFsLmxpZ2h0TWFwID0gYmxhY2tUZXg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG1NYXRlcmlhbC5jaHVua3MuYmFzZVBTID0gY2h1bmtzLmJhc2VQUyArIFwiXFxudW5pZm9ybSBzYW1wbGVyMkQgdGV4dHVyZV9kaXJMaWdodE1hcDtcXG51bmlmb3JtIGZsb2F0IGJha2VEaXI7XFxuXCI7XG4gICAgICAgICAgbG1NYXRlcmlhbC5jaHVua3MuZW5kUFMgPSBjaHVua3MuYmFrZURpckxtRW5kUFM7XG4gICAgICAgIH1cbiAgICAgICAgbG1NYXRlcmlhbC5jaHVua3Mub3V0cHV0QWxwaGFQUyA9IFwiXFxuXCI7XG4gICAgICAgIGxtTWF0ZXJpYWwuY2h1bmtzLm91dHB1dEFscGhhT3BhcXVlUFMgPSBcIlxcblwiO1xuICAgICAgICBsbU1hdGVyaWFsLmNodW5rcy5vdXRwdXRBbHBoYVByZW11bFBTID0gXCJcXG5cIjtcbiAgICAgICAgbG1NYXRlcmlhbC5jdWxsID0gcGMuQ1VMTEZBQ0VfTk9ORTtcbiAgICAgICAgbG1NYXRlcmlhbC5mb3JjZVV2MSA9IHRydWU7XG4gICAgICAgIGxtTWF0ZXJpYWwudXBkYXRlKCk7XG4gICAgICAgIGxtTWF0ZXJpYWwudXBkYXRlU2hhZGVyKGRldmljZSwgc2NlbmUpO1xuICAgICAgICBsbU1hdGVyaWFsLm5hbWUgPSBcImxtTWF0ZXJpYWxcIiArIHBhc3M7XG4gICAgICAgIHBhc3NNYXRlcmlhbFtwYXNzXSA9IGxtTWF0ZXJpYWw7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBjbnRyID0gMDtcbiAgICBmb3IgKG5vZGUgPSAwO25vZGUgPCBub2Rlcy5sZW5ndGg7bm9kZSsrKSB7XG4gICAgICByY3YgPSBub2Rlc01lc2hJbnN0YW5jZXNbbm9kZV07XG4gICAgICBub2RlTGlnaHRDb3VudFtub2RlXSA9IDA7XG4gICAgICBpZiAocmN2Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgYm91bmRzLmNvcHkocmN2WzBdLmFhYmIpO1xuICAgICAgICBmb3IgKGkgPSAwO2kgPCByY3YubGVuZ3RoO2krKykge1xuICAgICAgICAgIHJjdltpXS5ub2RlLmdldFdvcmxkVHJhbnNmb3JtKCk7XG4gICAgICAgICAgYm91bmRzLmFkZChyY3ZbaV0uYWFiYik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHZhciBuYm91bmRzID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICAgICAgbmJvdW5kcy5jb3B5KGJvdW5kcyk7XG4gICAgICBub2RlQm91bmRzLnB1c2gobmJvdW5kcyk7XG4gICAgICBmb3IgKGkgPSAwO2kgPCByY3YubGVuZ3RoO2krKykge1xuICAgICAgICBtID0gcmN2W2ldO1xuICAgICAgICBtLl9zaGFkZXJEZWZzICY9IH4ocGMuU0hBREVSREVGX0xNIHwgcGMuU0hBREVSREVGX0RJUkxNKTtcbiAgICAgICAgbS5tYXNrID0gbWFza0xpZ2h0bWFwO1xuICAgICAgICBtLmRlbGV0ZVBhcmFtZXRlcihcInRleHR1cmVfbGlnaHRNYXBcIik7XG4gICAgICAgIG0uZGVsZXRlUGFyYW1ldGVyKFwidGV4dHVyZV9kaXJMaWdodE1hcFwiKTtcbiAgICAgICAgbS5zZXRQYXJhbWV0ZXIoXCJ0ZXh0dXJlX2xpZ2h0TWFwXCIsIG9yaWdNYXRbY250cl0ubGlnaHRNYXAgPyBvcmlnTWF0W2NudHJdLmxpZ2h0TWFwIDogYmxhY2tUZXgpO1xuICAgICAgICBtLnNldFBhcmFtZXRlcihcInRleHR1cmVfZGlyTGlnaHRNYXBcIiwgYmxhY2tUZXgpO1xuICAgICAgICBjbnRyKys7XG4gICAgICB9XG4gICAgICBmb3IgKHBhc3MgPSAwO3Bhc3MgPCBwYXNzQ291bnQ7cGFzcysrKSB7XG4gICAgICAgIGxtID0gbG1hcHNbcGFzc11bbm9kZV07XG4gICAgICAgIHRhcmcgPSBuZXcgcGMuUmVuZGVyVGFyZ2V0KGRldmljZSwgbG0sIHtkZXB0aDpmYWxzZX0pO1xuICAgICAgICBub2RlVGFyZ1twYXNzXS5wdXNoKHRhcmcpO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGogPSAwO2ogPCBsaWdodHMubGVuZ3RoO2orKykge1xuICAgICAgbGlnaHRzW2pdLmVuYWJsZWQgPSBmYWxzZTtcbiAgICB9XG4gICAgdmFyIHNoYWRlcnNVcGRhdGVkT24xc3RQYXNzID0gZmFsc2U7XG4gICAgZm9yIChpID0gMDtpIDwgbGlnaHRzLmxlbmd0aDtpKyspIHtcbiAgICAgIGxpZ2h0c1tpXS5lbmFibGVkID0gdHJ1ZTtcbiAgICAgIGxpZ2h0c1tpXS5fY2FjaGVTaGFkb3dNYXAgPSB0cnVlO1xuICAgICAgaWYgKGxpZ2h0c1tpXS5fdHlwZSAhPT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgICAgIGxpZ2h0c1tpXS5fbm9kZS5nZXRXb3JsZFRyYW5zZm9ybSgpO1xuICAgICAgICBsaWdodHNbaV0uZ2V0Qm91bmRpbmdTcGhlcmUodGVtcFNwaGVyZSk7XG4gICAgICAgIGxpZ2h0Qm91bmRzLmNlbnRlciA9IHRlbXBTcGhlcmUuY2VudGVyO1xuICAgICAgICBsaWdodEJvdW5kcy5oYWxmRXh0ZW50cy54ID0gdGVtcFNwaGVyZS5yYWRpdXM7XG4gICAgICAgIGxpZ2h0Qm91bmRzLmhhbGZFeHRlbnRzLnkgPSB0ZW1wU3BoZXJlLnJhZGl1cztcbiAgICAgICAgbGlnaHRCb3VuZHMuaGFsZkV4dGVudHMueiA9IHRlbXBTcGhlcmUucmFkaXVzO1xuICAgICAgfVxuICAgICAgaWYgKGxpZ2h0c1tpXS5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgICAgbGlnaHQgPSBsaWdodHNbaV07XG4gICAgICAgIHNoYWRvd0NhbSA9IHRoaXMucmVuZGVyZXIuZ2V0U2hhZG93Q2FtZXJhKGRldmljZSwgbGlnaHQpO1xuICAgICAgICBzaGFkb3dDYW0uX25vZGUuc2V0UG9zaXRpb24obGlnaHQuX25vZGUuZ2V0UG9zaXRpb24oKSk7XG4gICAgICAgIHNoYWRvd0NhbS5fbm9kZS5zZXRSb3RhdGlvbihsaWdodC5fbm9kZS5nZXRSb3RhdGlvbigpKTtcbiAgICAgICAgc2hhZG93Q2FtLl9ub2RlLnJvdGF0ZUxvY2FsKC05MCwgMCwgMCk7XG4gICAgICAgIHNoYWRvd0NhbS5wcm9qZWN0aW9uID0gcGMuUFJPSkVDVElPTl9QRVJTUEVDVElWRTtcbiAgICAgICAgc2hhZG93Q2FtLm5lYXJDbGlwID0gbGlnaHQuYXR0ZW51YXRpb25FbmQgLyAxMDAwO1xuICAgICAgICBzaGFkb3dDYW0uZmFyQ2xpcCA9IGxpZ2h0LmF0dGVudWF0aW9uRW5kO1xuICAgICAgICBzaGFkb3dDYW0uYXNwZWN0UmF0aW8gPSAxO1xuICAgICAgICBzaGFkb3dDYW0uZm92ID0gbGlnaHQuX291dGVyQ29uZUFuZ2xlICogMjtcbiAgICAgICAgdGhpcy5yZW5kZXJlci51cGRhdGVDYW1lcmFGcnVzdHVtKHNoYWRvd0NhbSk7XG4gICAgICB9XG4gICAgICBmb3IgKG5vZGUgPSAwO25vZGUgPCBub2Rlcy5sZW5ndGg7bm9kZSsrKSB7XG4gICAgICAgIHJjdiA9IG5vZGVzTWVzaEluc3RhbmNlc1tub2RlXTtcbiAgICAgICAgYm91bmRzID0gbm9kZUJvdW5kc1tub2RlXTtcbiAgICAgICAgc2NlbmUuZHJhd0NhbGxzID0gW107XG4gICAgICAgIGZvciAoaiA9IDA7aiA8IHJjdi5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgc2NlbmUuZHJhd0NhbGxzLnB1c2gocmN2W2pdKTtcbiAgICAgICAgfVxuICAgICAgICBzY2VuZS51cGRhdGVTaGFkZXJzID0gdHJ1ZTtcbiAgICAgICAgaWYgKGxpZ2h0c1tpXS5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX0RJUkVDVElPTkFMKSB7XG4gICAgICAgICAgdGVtcFZlYy5jb3B5KGJvdW5kcy5jZW50ZXIpO1xuICAgICAgICAgIHRlbXBWZWMueSArPSBib3VuZHMuaGFsZkV4dGVudHMueTtcbiAgICAgICAgICBsbUNhbWVyYS5fbm9kZS5zZXRQb3NpdGlvbih0ZW1wVmVjKTtcbiAgICAgICAgICBsbUNhbWVyYS5fbm9kZS5zZXRFdWxlckFuZ2xlcygtOTAsIDAsIDApO1xuICAgICAgICAgIHZhciBmcnVzdHVtU2l6ZSA9IE1hdGgubWF4KGJvdW5kcy5oYWxmRXh0ZW50cy54LCBib3VuZHMuaGFsZkV4dGVudHMueik7XG4gICAgICAgICAgbG1DYW1lcmEucHJvamVjdGlvbiA9IHBjLlBST0pFQ1RJT05fT1JUSE9HUkFQSElDO1xuICAgICAgICAgIGxtQ2FtZXJhLm5lYXJDbGlwID0gMDtcbiAgICAgICAgICBsbUNhbWVyYS5mYXJDbGlwID0gYm91bmRzLmhhbGZFeHRlbnRzLnkgKiAyO1xuICAgICAgICAgIGxtQ2FtZXJhLmFzcGVjdFJhdGlvID0gMTtcbiAgICAgICAgICBsbUNhbWVyYS5vcnRob0hlaWdodCA9IGZydXN0dW1TaXplO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghbGlnaHRCb3VuZHMuaW50ZXJzZWN0cyhib3VuZHMpKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpZ2h0c1tpXS5fdHlwZSA9PT0gcGMuTElHSFRUWVBFX1NQT1QpIHtcbiAgICAgICAgICB2YXIgbm9kZVZpc2libGUgPSBmYWxzZTtcbiAgICAgICAgICBmb3IgKGogPSAwO2ogPCByY3YubGVuZ3RoO2orKykge1xuICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIuX2lzVmlzaWJsZShzaGFkb3dDYW0sIHJjdltqXSkpIHtcbiAgICAgICAgICAgICAgbm9kZVZpc2libGUgPSB0cnVlO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFub2RlVmlzaWJsZSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAocGFzcyA9IDA7cGFzcyA8IHBhc3NDb3VudDtwYXNzKyspIHtcbiAgICAgICAgICBsbSA9IGxtYXBzW3Bhc3NdW25vZGVdO1xuICAgICAgICAgIHRhcmcgPSBub2RlVGFyZ1twYXNzXVtub2RlXTtcbiAgICAgICAgICB0YXJnVG1wID0gdGV4UG9vbFtsbS53aWR0aF07XG4gICAgICAgICAgdGV4VG1wID0gdGFyZ1RtcC5jb2xvckJ1ZmZlcjtcbiAgICAgICAgICBpZiAocGFzcyA9PT0gMCkge1xuICAgICAgICAgICAgc2hhZGVyc1VwZGF0ZWRPbjFzdFBhc3MgPSBzY2VuZS51cGRhdGVTaGFkZXJzO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoc2hhZGVyc1VwZGF0ZWRPbjFzdFBhc3MpIHtcbiAgICAgICAgICAgICAgc2NlbmUudXBkYXRlU2hhZGVycyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGZvciAoaiA9IDA7aiA8IHJjdi5sZW5ndGg7aisrKSB7XG4gICAgICAgICAgICByY3Zbal0ubWF0ZXJpYWwgPSBwYXNzTWF0ZXJpYWxbcGFzc107XG4gICAgICAgICAgfVxuICAgICAgICAgIGxtQ2FtZXJhLnJlbmRlclRhcmdldCA9IHRhcmdUbXA7XG4gICAgICAgICAgaWYgKHBhc3MgPT09IFBBU1NfRElSKSB7XG4gICAgICAgICAgICBjb25zdGFudEJha2VEaXIuc2V0VmFsdWUobGlnaHRzW2ldLmJha2VEaXIgPyAxIDogMCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMucmVuZGVyZXIuX2ZvcndhcmRUaW1lID0gMDtcbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLl9zaGFkb3dNYXBUaW1lID0gMDtcbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcihzY2VuZSwgbG1DYW1lcmEpO1xuICAgICAgICAgIGxtYXBzW3Bhc3NdW25vZGVdID0gdGV4VG1wO1xuICAgICAgICAgIG5vZGVUYXJnW3Bhc3NdW25vZGVdID0gdGFyZ1RtcDtcbiAgICAgICAgICB0ZXhQb29sW2xtLndpZHRoXSA9IHRhcmc7XG4gICAgICAgICAgZm9yIChqID0gMDtqIDwgcmN2Lmxlbmd0aDtqKyspIHtcbiAgICAgICAgICAgIG0gPSByY3Zbal07XG4gICAgICAgICAgICBtLnNldFBhcmFtZXRlcihwYXNzVGV4TmFtZVtwYXNzXSwgdGV4VG1wKTtcbiAgICAgICAgICAgIG0uX3NoYWRlckRlZnMgfD0gcGMuU0hBREVSREVGX0xNO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBub2RlTGlnaHRDb3VudFtub2RlXSsrO1xuICAgICAgfVxuICAgICAgbGlnaHRzW2ldLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgIGxpZ2h0c1tpXS5fY2FjaGVTaGFkb3dNYXAgPSBmYWxzZTtcbiAgICAgIGlmIChsaWdodHNbaV0uX2lzQ2FjaGVkU2hhZG93TWFwKSB7XG4gICAgICAgIGxpZ2h0c1tpXS5fZGVzdHJveVNoYWRvd01hcCgpO1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgaWQgPSAwO1xuICAgIHZhciBzY2VuZUxtYXBzO1xuICAgIGZvciAobm9kZSA9IDA7bm9kZSA8IG5vZGVzLmxlbmd0aDtub2RlKyspIHtcbiAgICAgIHJjdiA9IG5vZGVzTWVzaEluc3RhbmNlc1tub2RlXTtcbiAgICAgIHNjZW5lTG1hcHMgPSBbXTtcbiAgICAgIGZvciAocGFzcyA9IDA7cGFzcyA8IHBhc3NDb3VudDtwYXNzKyspIHtcbiAgICAgICAgbG0gPSBsbWFwc1twYXNzXVtub2RlXTtcbiAgICAgICAgdGFyZyA9IG5vZGVUYXJnW3Bhc3NdW25vZGVdO1xuICAgICAgICB0YXJnVG1wID0gdGV4UG9vbFtsbS53aWR0aF07XG4gICAgICAgIHRleFRtcCA9IHRhcmdUbXAuY29sb3JCdWZmZXI7XG4gICAgICAgIHZhciBudW1EaWxhdGVzMnggPSA0O1xuICAgICAgICBwaXhlbE9mZnNldC5zZXQoMSAvIGxtLndpZHRoLCAxIC8gbG0uaGVpZ2h0KTtcbiAgICAgICAgY29uc3RhbnRQaXhlbE9mZnNldC5zZXRWYWx1ZShwaXhlbE9mZnNldC5kYXRhKTtcbiAgICAgICAgZm9yIChpID0gMDtpIDwgbnVtRGlsYXRlczJ4O2krKykge1xuICAgICAgICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKGxtKTtcbiAgICAgICAgICBwYy5kcmF3UXVhZFdpdGhTaGFkZXIoZGV2aWNlLCB0YXJnVG1wLCBkaWxhdGVTaGFkZXIpO1xuICAgICAgICAgIGNvbnN0YW50VGV4U291cmNlLnNldFZhbHVlKHRleFRtcCk7XG4gICAgICAgICAgcGMuZHJhd1F1YWRXaXRoU2hhZGVyKGRldmljZSwgdGFyZywgZGlsYXRlU2hhZGVyKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGkgPSAwO2kgPCByY3YubGVuZ3RoO2krKykge1xuICAgICAgICAgIG0gPSByY3ZbaV07XG4gICAgICAgICAgaWYgKHBhc3MgPT09IDApIHtcbiAgICAgICAgICAgIG0ubWFzayA9IG1hc2tCYWtlZDtcbiAgICAgICAgICAgIHJjdltpXS5tYXRlcmlhbCA9IG9yaWdNYXRbaWRdO1xuICAgICAgICAgICAgaWQrKztcbiAgICAgICAgICB9XG4gICAgICAgICAgcmN2W2ldLnNldFBhcmFtZXRlcihwYXNzVGV4TmFtZVtwYXNzXSwgbG0pO1xuICAgICAgICAgIGlmIChwYXNzID09PSBQQVNTX0RJUikge1xuICAgICAgICAgICAgcmN2W2ldLl9zaGFkZXJEZWZzIHw9IHBjLlNIQURFUkRFRl9ESVJMTTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc2NlbmVMbWFwc1twYXNzXSA9IGxtO1xuICAgICAgICBpZiAocGFzcyA9PT0gcGFzc0NvdW50IC0gMSkge1xuICAgICAgICAgIHRhcmcuZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBzY2VuZUxpZ2h0bWFwcy5wdXNoKHNjZW5lTG1hcHMpO1xuICAgICAgc2NlbmVMaWdodG1hcHNOb2RlLnB1c2gobm9kZXNbbm9kZV0pO1xuICAgIH1cbiAgICBmb3IgKHZhciBrZXkgaW4gdGV4UG9vbCkge1xuICAgICAgaWYgKHRleFBvb2wuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICB0ZXhQb29sW2tleV0uY29sb3JCdWZmZXIuZGVzdHJveSgpO1xuICAgICAgICB0ZXhQb29sW2tleV0uZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBzY2VuZUxpZ2h0bWFwcy5sZW5ndGg7aSsrKSB7XG4gICAgICBmb3IgKGogPSAwO2ogPCBzY2VuZUxpZ2h0bWFwc1tpXS5sZW5ndGg7aisrKSB7XG4gICAgICAgIHRleCA9IHNjZW5lTGlnaHRtYXBzW2ldW2pdO1xuICAgICAgICB0ZXgubWluRmlsdGVyID0gcGMuRklMVEVSX0xJTkVBUjtcbiAgICAgICAgdGV4Lm1hZ0ZpbHRlciA9IHBjLkZJTFRFUl9MSU5FQVI7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAobm9kZSA9IDA7bm9kZSA8IGFsbE5vZGVzLmxlbmd0aDtub2RlKyspIHtcbiAgICAgIGFsbE5vZGVzW25vZGVdLm1vZGVsLmNhc3RTaGFkb3dzID0gb3JpZ0Nhc3RTaGFkb3dzW25vZGVdO1xuICAgIH1cbiAgICBzY2VuZS5zaGFkb3dDYXN0ZXJzID0gb3JpZ0Nhc3RlcnMyO1xuICAgIGZvciAoaSA9IDA7aSA8IG9yaWdTaGFkZXJEZWZzLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmIChvcmlnU2hhZGVyRGVmc1tpXSkge1xuICAgICAgICByY3YgPSBzY2VuZUxpZ2h0bWFwc05vZGVbaV0ubW9kZWwubW9kZWwubWVzaEluc3RhbmNlcztcbiAgICAgICAgZm9yIChqID0gMDtqIDwgcmN2Lmxlbmd0aDtqKyspIHtcbiAgICAgICAgICByY3Zbal0uX3NoYWRlckRlZnMgfD0gb3JpZ1NoYWRlckRlZnNbaV1bal0gJiAocGMuU0hBREVSREVGX0xNIHwgcGMuU0hBREVSREVGX0RJUkxNKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBsaWdodHMubGVuZ3RoO2krKykge1xuICAgICAgbGlnaHRzW2ldLl9tYXNrID0gb3JpZ01hc2tbaV07XG4gICAgICBsaWdodHNbaV0uc2hhZG93VXBkYXRlTW9kZSA9IG9yaWdTaGFkb3dNb2RlW2ldO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwO2kgPCBzY2VuZUxpZ2h0cy5sZW5ndGg7aSsrKSB7XG4gICAgICBzY2VuZUxpZ2h0c1tpXS5lbmFibGVkID0gb3JpZ0VuYWJsZWRbaV07XG4gICAgfVxuICAgIHNjZW5lLmRyYXdDYWxscyA9IG9yaWdEcmF3Q2FsbHM7XG4gICAgc2NlbmUuZm9nID0gb3JpZ0ZvZztcbiAgICBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVswXSA9IG9yaWdBbWJpZW50UjtcbiAgICBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVsxXSA9IG9yaWdBbWJpZW50RztcbiAgICBzY2VuZS5hbWJpZW50TGlnaHQuZGF0YVsyXSA9IG9yaWdBbWJpZW50QjtcbiAgICBpZiAocmV2ZXJ0U3RhdGljKSB7XG4gICAgICBzY2VuZS5fbmVlZHNTdGF0aWNQcmVwYXJlID0gdHJ1ZTtcbiAgICB9XG4gIH19O1xuICByZXR1cm4ge0xpZ2h0bWFwcGVyOkxpZ2h0bWFwcGVyLCBNQVNLX0RZTkFNSUM6bWFza0R5bmFtaWMsIE1BU0tfQkFLRUQ6bWFza0Jha2VkLCBNQVNLX0xJR0hUTUFQOm1hc2tMaWdodG1hcH07XG59KCkpO1xucGMuZXh0ZW5kKHBjLCBmdW5jdGlvbigpIHtcbiAgdmFyIEJhdGNoID0gZnVuY3Rpb24obWVzaEluc3RhbmNlcywgZHluYW1pYywgYmF0Y2hHcm91cElkKSB7XG4gICAgdGhpcy5vcmlnTWVzaEluc3RhbmNlcyA9IG1lc2hJbnN0YW5jZXM7XG4gICAgdGhpcy5fYWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICB0aGlzLm1lc2hJbnN0YW5jZSA9IG51bGw7XG4gICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5keW5hbWljID0gZHluYW1pYztcbiAgICB0aGlzLmJhdGNoR3JvdXBJZCA9IGJhdGNoR3JvdXBJZDtcbiAgfTtcbiAgdmFyIEJhdGNoR3JvdXAgPSBmdW5jdGlvbihpZCwgbmFtZSwgZHluYW1pYywgbWF4QWFiYlNpemUpIHtcbiAgICB0aGlzLmR5bmFtaWMgPSBkeW5hbWljO1xuICAgIHRoaXMubWF4QWFiYlNpemUgPSBtYXhBYWJiU2l6ZTtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfTtcbiAgdmFyIFNraW5CYXRjaEluc3RhbmNlID0gZnVuY3Rpb24oZGV2aWNlLCBub2Rlcywgcm9vdE5vZGUpIHtcbiAgICB0aGlzLmRldmljZSA9IGRldmljZTtcbiAgICB0aGlzLnJvb3ROb2RlID0gcm9vdE5vZGU7XG4gICAgdGhpcy5fZGlydHkgPSB0cnVlO1xuICAgIHRoaXMuYm9uZXMgPSBub2RlcztcbiAgICB2YXIgbnVtQm9uZXMgPSBub2Rlcy5sZW5ndGg7XG4gICAgaWYgKGRldmljZS5zdXBwb3J0c0JvbmVUZXh0dXJlcykge1xuICAgICAgdmFyIHNpemU7XG4gICAgICBpZiAobnVtQm9uZXMgPiAyNTYpIHtcbiAgICAgICAgc2l6ZSA9IDY0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKG51bUJvbmVzID4gNjQpIHtcbiAgICAgICAgICBzaXplID0gMzI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKG51bUJvbmVzID4gMTYpIHtcbiAgICAgICAgICAgIHNpemUgPSAxNjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2l6ZSA9IDg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmJvbmVUZXh0dXJlID0gbmV3IHBjLlRleHR1cmUoZGV2aWNlLCB7d2lkdGg6c2l6ZSwgaGVpZ2h0OnNpemUsIGZvcm1hdDpwYy5QSVhFTEZPUk1BVF9SR0JBMzJGLCBtaXBtYXBzOmZhbHNlLCBtaW5GaWx0ZXI6cGMuRklMVEVSX05FQVJFU1QsIG1hZ0ZpbHRlcjpwYy5GSUxURVJfTkVBUkVTVH0pO1xuICAgICAgdGhpcy5tYXRyaXhQYWxldHRlID0gdGhpcy5ib25lVGV4dHVyZS5sb2NrKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWF0cml4UGFsZXR0ZSA9IG5ldyBGbG9hdDMyQXJyYXkobnVtQm9uZXMgKiAxNik7XG4gICAgfVxuICB9O1xuICBTa2luQmF0Y2hJbnN0YW5jZS5wcm90b3R5cGUgPSB7dXBkYXRlTWF0cmljZXM6ZnVuY3Rpb24oKSB7XG4gIH0sIHVwZGF0ZU1hdHJpeFBhbGV0dGU6ZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBlO1xuICAgIHZhciBtcCA9IHRoaXMubWF0cml4UGFsZXR0ZTtcbiAgICB2YXIgYmFzZTtcbiAgICBmb3IgKHZhciBpID0gdGhpcy5ib25lcy5sZW5ndGggLSAxO2kgPj0gMDtpLS0pIHtcbiAgICAgIHBlID0gdGhpcy5ib25lc1tpXS5nZXRXb3JsZFRyYW5zZm9ybSgpLmRhdGE7XG4gICAgICBiYXNlID0gaSAqIDE2O1xuICAgICAgbXBbYmFzZV0gPSBwZVswXTtcbiAgICAgIG1wW2Jhc2UgKyAxXSA9IHBlWzFdO1xuICAgICAgbXBbYmFzZSArIDJdID0gcGVbMl07XG4gICAgICBtcFtiYXNlICsgM10gPSBwZVszXTtcbiAgICAgIG1wW2Jhc2UgKyA0XSA9IHBlWzRdO1xuICAgICAgbXBbYmFzZSArIDVdID0gcGVbNV07XG4gICAgICBtcFtiYXNlICsgNl0gPSBwZVs2XTtcbiAgICAgIG1wW2Jhc2UgKyA3XSA9IHBlWzddO1xuICAgICAgbXBbYmFzZSArIDhdID0gcGVbOF07XG4gICAgICBtcFtiYXNlICsgOV0gPSBwZVs5XTtcbiAgICAgIG1wW2Jhc2UgKyAxMF0gPSBwZVsxMF07XG4gICAgICBtcFtiYXNlICsgMTFdID0gcGVbMTFdO1xuICAgICAgbXBbYmFzZSArIDEyXSA9IHBlWzEyXTtcbiAgICAgIG1wW2Jhc2UgKyAxM10gPSBwZVsxM107XG4gICAgICBtcFtiYXNlICsgMTRdID0gcGVbMTRdO1xuICAgICAgbXBbYmFzZSArIDE1XSA9IHBlWzE1XTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZGV2aWNlLnN1cHBvcnRzQm9uZVRleHR1cmVzKSB7XG4gICAgICB0aGlzLmJvbmVUZXh0dXJlLmxvY2soKTtcbiAgICAgIHRoaXMuYm9uZVRleHR1cmUudW5sb2NrKCk7XG4gICAgfVxuICB9fTtcbiAgdmFyIEJhdGNoTWFuYWdlciA9IGZ1bmN0aW9uKGRldmljZSwgcm9vdCwgc2NlbmUpIHtcbiAgICB0aGlzLmRldmljZSA9IGRldmljZTtcbiAgICB0aGlzLnJvb3ROb2RlID0gcm9vdDtcbiAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgdGhpcy5faW5pdCA9IGZhbHNlO1xuICAgIHRoaXMuX2JhdGNoR3JvdXBzID0ge307XG4gICAgdGhpcy5fYmF0Y2hHcm91cENvdW50ZXIgPSAwO1xuICAgIHRoaXMuX2JhdGNoTGlzdCA9IFtdO1xuICAgIHRoaXMuX2RpcnR5R3JvdXBzID0gW107XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuYWRkR3JvdXAgPSBmdW5jdGlvbihuYW1lLCBkeW5hbWljLCBtYXhBYWJiU2l6ZSwgaWQpIHtcbiAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaWQgPSB0aGlzLl9iYXRjaEdyb3VwQ291bnRlcjtcbiAgICAgIHRoaXMuX2JhdGNoR3JvdXBDb3VudGVyKys7XG4gICAgfVxuICAgIGlmICh0aGlzLl9iYXRjaEdyb3Vwc1tpZF0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGdyb3VwO1xuICAgIHRoaXMuX2JhdGNoR3JvdXBzW2lkXSA9IGdyb3VwID0gbmV3IHBjLkJhdGNoR3JvdXAoaWQsIG5hbWUsIGR5bmFtaWMsIG1heEFhYmJTaXplKTtcbiAgICByZXR1cm4gZ3JvdXA7XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUucmVtb3ZlR3JvdXAgPSBmdW5jdGlvbihpZCkge1xuICAgIGlmICghdGhpcy5fYmF0Y2hHcm91cHNbaWRdKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBuZXdCYXRjaExpc3QgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgdGhpcy5fYmF0Y2hMaXN0Lmxlbmd0aDtpKyspIHtcbiAgICAgIGlmICh0aGlzLl9iYXRjaExpc3RbaV0uYmF0Y2hHcm91cElkICE9PSBpZCkge1xuICAgICAgICBuZXdCYXRjaExpc3QucHVzaCh0aGlzLl9iYXRjaExpc3RbaV0pO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2JhdGNoTGlzdFtpXS5yZWZDb3VudGVyID0gMTtcbiAgICAgIHRoaXMuZGVzdHJveSh0aGlzLl9iYXRjaExpc3RbaV0pO1xuICAgIH1cbiAgICB0aGlzLl9iYXRjaExpc3QgPSBuZXdCYXRjaExpc3Q7XG4gICAgdGhpcy5fcmVtb3ZlTW9kZWxzRnJvbUJhdGNoR3JvdXAodGhpcy5yb290Tm9kZSwgaWQpO1xuICAgIGRlbGV0ZSB0aGlzLl9iYXRjaEdyb3Vwc1tpZF07XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuX3JlbW92ZU1vZGVsc0Zyb21CYXRjaEdyb3VwID0gZnVuY3Rpb24obm9kZSwgaWQpIHtcbiAgICBpZiAoIW5vZGUuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobm9kZS5tb2RlbCAmJiBub2RlLm1vZGVsLmJhdGNoR3JvdXBJZCA9PT0gaWQpIHtcbiAgICAgIG5vZGUubW9kZWwuYmF0Y2hHcm91cElkID0gLTE7XG4gICAgfVxuICAgIGlmIChub2RlLmVsZW1lbnQgJiYgbm9kZS5lbGVtZW50LmJhdGNoR3JvdXBJZCA9PT0gaWQpIHtcbiAgICAgIG5vZGUuZWxlbWVudC5iYXRjaEdyb3VwSWQgPSAtMTtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMuX3JlbW92ZU1vZGVsc0Zyb21CYXRjaEdyb3VwKG5vZGUuX2NoaWxkcmVuW2ldLCBpZCk7XG4gICAgfVxuICB9O1xuICBCYXRjaE1hbmFnZXIucHJvdG90eXBlLl9jb2xsZWN0QW5kUmVtb3ZlTW9kZWxzID0gZnVuY3Rpb24obm9kZSwgZ3JvdXBNZXNoSW5zdGFuY2VzLCBncm91cElkcykge1xuICAgIGlmICghbm9kZS5lbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBpO1xuICAgIGlmIChub2RlLm1vZGVsICYmIG5vZGUubW9kZWwuYmF0Y2hHcm91cElkID49IDAgJiYgbm9kZS5tb2RlbC5tb2RlbCAmJiBub2RlLm1vZGVsLmVuYWJsZWQpIHtcbiAgICAgIGlmICghZ3JvdXBJZHMgfHwgZ3JvdXBJZHMgJiYgZ3JvdXBJZHMuaW5kZXhPZihub2RlLm1vZGVsLmJhdGNoR3JvdXBJZCkgPj0gMCkge1xuICAgICAgICB2YXIgYXJyID0gZ3JvdXBNZXNoSW5zdGFuY2VzW25vZGUubW9kZWwuYmF0Y2hHcm91cElkXTtcbiAgICAgICAgaWYgKCFhcnIpIHtcbiAgICAgICAgICBhcnIgPSBncm91cE1lc2hJbnN0YW5jZXNbbm9kZS5tb2RlbC5iYXRjaEdyb3VwSWRdID0gW107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUubW9kZWwuaXNTdGF0aWMpIHtcbiAgICAgICAgICB2YXIgZHJhd0NhbGxzID0gdGhpcy5zY2VuZS5kcmF3Q2FsbHM7XG4gICAgICAgICAgdmFyIG5vZGVNZXNoSW5zdGFuY2VzID0gbm9kZS5tb2RlbC5tZXNoSW5zdGFuY2VzO1xuICAgICAgICAgIGZvciAoaSA9IDA7aSA8IGRyYXdDYWxscy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICBpZiAoIWRyYXdDYWxsc1tpXS5fc3RhdGljU291cmNlKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG5vZGVNZXNoSW5zdGFuY2VzLmluZGV4T2YoZHJhd0NhbGxzW2ldLl9zdGF0aWNTb3VyY2UpIDwgMCkge1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdyb3VwTWVzaEluc3RhbmNlc1tub2RlLm1vZGVsLmJhdGNoR3JvdXBJZF0ucHVzaChkcmF3Q2FsbHNbaV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb3IgKGkgPSAwO2kgPCBub2RlTWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICBpZiAoZHJhd0NhbGxzLmluZGV4T2Yobm9kZU1lc2hJbnN0YW5jZXNbaV0pID49IDApIHtcbiAgICAgICAgICAgICAgZ3JvdXBNZXNoSW5zdGFuY2VzW25vZGUubW9kZWwuYmF0Y2hHcm91cElkXS5wdXNoKG5vZGVNZXNoSW5zdGFuY2VzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ3JvdXBNZXNoSW5zdGFuY2VzW25vZGUubW9kZWwuYmF0Y2hHcm91cElkXSA9IGFyci5jb25jYXQobm9kZS5tb2RlbC5tZXNoSW5zdGFuY2VzKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNjZW5lLnJlbW92ZU1vZGVsKG5vZGUubW9kZWwubW9kZWwpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAobm9kZS5lbGVtZW50ICYmIG5vZGUuZWxlbWVudC5iYXRjaEdyb3VwSWQgPj0gMCAmJiBub2RlLmVsZW1lbnQuZW5hYmxlZCkge1xuICAgICAgaWYgKCFncm91cElkcyB8fCBncm91cElkcyAmJiBncm91cElkcy5pbmRleE9mKG5vZGUuZWxlbWVudC5iYXRjaEdyb3VwSWQpID49IDApIHtcbiAgICAgICAgdmFyIGFyciA9IGdyb3VwTWVzaEluc3RhbmNlc1tub2RlLmVsZW1lbnQuYmF0Y2hHcm91cElkXTtcbiAgICAgICAgaWYgKCFhcnIpIHtcbiAgICAgICAgICBhcnIgPSBncm91cE1lc2hJbnN0YW5jZXNbbm9kZS5lbGVtZW50LmJhdGNoR3JvdXBJZF0gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdmFsaWQgPSBmYWxzZTtcbiAgICAgICAgaWYgKG5vZGUuZWxlbWVudC5fdGV4dCkge1xuICAgICAgICAgIGdyb3VwTWVzaEluc3RhbmNlc1tub2RlLmVsZW1lbnQuYmF0Y2hHcm91cElkXS5wdXNoKG5vZGUuZWxlbWVudC5fdGV4dC5fbW9kZWwubWVzaEluc3RhbmNlc1swXSk7XG4gICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmVNb2RlbChub2RlLmVsZW1lbnQuX3RleHQuX21vZGVsKTtcbiAgICAgICAgICB2YWxpZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKG5vZGUuZWxlbWVudC5faW1hZ2UpIHtcbiAgICAgICAgICAgIGdyb3VwTWVzaEluc3RhbmNlc1tub2RlLmVsZW1lbnQuYmF0Y2hHcm91cElkXS5wdXNoKG5vZGUuZWxlbWVudC5faW1hZ2UuX21vZGVsLm1lc2hJbnN0YW5jZXNbMF0pO1xuICAgICAgICAgICAgdGhpcy5zY2VuZS5yZW1vdmVNb2RlbChub2RlLmVsZW1lbnQuX2ltYWdlLl9tb2RlbCk7XG4gICAgICAgICAgICB2YWxpZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoaSA9IDA7aSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDtpKyspIHtcbiAgICAgIHRoaXMuX2NvbGxlY3RBbmRSZW1vdmVNb2RlbHMobm9kZS5fY2hpbGRyZW5baV0sIGdyb3VwTWVzaEluc3RhbmNlcywgZ3JvdXBJZHMpO1xuICAgIH1cbiAgfTtcbiAgQmF0Y2hNYW5hZ2VyLnByb3RvdHlwZS5fbWFya0dyb3VwRGlydHkgPSBmdW5jdGlvbihpZCkge1xuICAgIGlmICh0aGlzLl9kaXJ0eUdyb3Vwcy5pbmRleE9mKGlkKSA8IDApIHtcbiAgICAgIHRoaXMuX2RpcnR5R3JvdXBzLnB1c2goaWQpO1xuICAgIH1cbiAgfTtcbiAgQmF0Y2hNYW5hZ2VyLnByb3RvdHlwZS5fcmVnaXN0ZXJFbnRpdGllcyA9IGZ1bmN0aW9uKGJhdGNoLCBtZXNoSW5zdGFuY2VzKSB7XG4gICAgdmFyIG5vZGU7XG4gICAgdmFyIGVudHMgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgbWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICBub2RlID0gbWVzaEluc3RhbmNlc1tpXS5ub2RlO1xuICAgICAgd2hpbGUgKCFub2RlLl9hcHAgJiYgbm9kZS5fcGFyZW50KSB7XG4gICAgICAgIG5vZGUgPSBub2RlLl9wYXJlbnQ7XG4gICAgICB9XG4gICAgICBpZiAoIW5vZGUuX2FwcCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGVudHMucHVzaChub2RlKTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RlcihiYXRjaCwgZW50cyk7XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuZ2VuZXJhdGUgPSBmdW5jdGlvbihncm91cElkcykge1xuICAgIHZhciBpO1xuICAgIHZhciBncm91cE1lc2hJbnN0YW5jZXMgPSB7fTtcbiAgICBpZiAoIWdyb3VwSWRzKSB7XG4gICAgICBmb3IgKGkgPSAwO2kgPCB0aGlzLl9iYXRjaExpc3QubGVuZ3RoO2krKykge1xuICAgICAgICB0aGlzLl9iYXRjaExpc3RbaV0ucmVmQ291bnRlciA9IDE7XG4gICAgICAgIHRoaXMuZGVzdHJveSh0aGlzLl9iYXRjaExpc3RbaV0pO1xuICAgICAgfVxuICAgICAgdGhpcy5fYmF0Y2hMaXN0Lmxlbmd0aCA9IDA7XG4gICAgICB0aGlzLl9jb2xsZWN0QW5kUmVtb3ZlTW9kZWxzKHRoaXMucm9vdE5vZGUsIGdyb3VwTWVzaEluc3RhbmNlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBuZXdCYXRjaExpc3QgPSBbXTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IHRoaXMuX2JhdGNoTGlzdC5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmIChncm91cElkcy5pbmRleE9mKHRoaXMuX2JhdGNoTGlzdFtpXS5iYXRjaEdyb3VwSWQpIDwgMCkge1xuICAgICAgICAgIG5ld0JhdGNoTGlzdC5wdXNoKHRoaXMuX2JhdGNoTGlzdFtpXSk7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYmF0Y2hMaXN0W2ldLnJlZkNvdW50ZXIgPSAxO1xuICAgICAgICB0aGlzLmRlc3Ryb3kodGhpcy5fYmF0Y2hMaXN0W2ldKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2JhdGNoTGlzdCA9IG5ld0JhdGNoTGlzdDtcbiAgICAgIHRoaXMuX2NvbGxlY3RBbmRSZW1vdmVNb2RlbHModGhpcy5yb290Tm9kZSwgZ3JvdXBNZXNoSW5zdGFuY2VzLCBncm91cElkcyk7XG4gICAgfVxuICAgIHZhciBncm91cCwgbGlzdHMsIGdyb3VwRGF0YSwgYmF0Y2g7XG4gICAgZm9yICh2YXIgZ3JvdXBJZCBpbiBncm91cE1lc2hJbnN0YW5jZXMpIHtcbiAgICAgIGlmICghZ3JvdXBNZXNoSW5zdGFuY2VzLmhhc093blByb3BlcnR5KGdyb3VwSWQpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgZ3JvdXAgPSBncm91cE1lc2hJbnN0YW5jZXNbZ3JvdXBJZF07XG4gICAgICBncm91cERhdGEgPSB0aGlzLl9iYXRjaEdyb3Vwc1tncm91cElkXTtcbiAgICAgIGlmICghZ3JvdXBEYXRhKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgbGlzdHMgPSB0aGlzLnByZXBhcmUoZ3JvdXAsIGdyb3VwRGF0YS5keW5hbWljLCBncm91cERhdGEubWF4QWFiYlNpemUpO1xuICAgICAgZm9yIChpID0gMDtpIDwgbGlzdHMubGVuZ3RoO2krKykge1xuICAgICAgICBiYXRjaCA9IHRoaXMuY3JlYXRlKGxpc3RzW2ldLCBncm91cERhdGEuZHluYW1pYywgcGFyc2VJbnQoZ3JvdXBJZCkpO1xuICAgICAgICB0aGlzLnNjZW5lLmFkZE1vZGVsKGJhdGNoLm1vZGVsKTtcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJFbnRpdGllcyhiYXRjaCwgbGlzdHNbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgQmF0Y2hNYW5hZ2VyLnByb3RvdHlwZS5nZXRHcm91cEJ5TmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICB2YXIgZ3JvdXBzID0gdGhpcy5fYmF0Y2hHcm91cHM7XG4gICAgZm9yICh2YXIgZ3JvdXAgaW4gZ3JvdXBzKSB7XG4gICAgICBpZiAoIWdyb3Vwcy5oYXNPd25Qcm9wZXJ0eShncm91cCkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoZ3JvdXBzW2dyb3VwXS5uYW1lID09PSBuYW1lKSB7XG4gICAgICAgIHJldHVybiBncm91cHNbZ3JvdXBdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfTtcbiAgZnVuY3Rpb24gcGFyYW1zSWRlbnRpY2FsKGEsIGIpIHtcbiAgICBpZiAoYSAmJiAhYikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIWEgJiYgYikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBhID0gYS5kYXRhO1xuICAgIGIgPSBiLmRhdGE7XG4gICAgaWYgKGEgPT09IGIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoYSBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSAmJiBiIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KSB7XG4gICAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGZvciAodmFyIGkgPSAwO2kgPCBhLmxlbmd0aDtpKyspIHtcbiAgICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgQmF0Y2hNYW5hZ2VyLnByb3RvdHlwZS5wcmVwYXJlID0gZnVuY3Rpb24obWVzaEluc3RhbmNlcywgZHluYW1pYywgbWF4QWFiYlNpemUpIHtcbiAgICBpZiAobWVzaEluc3RhbmNlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgaWYgKG1heEFhYmJTaXplID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG1heEFhYmJTaXplID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xuICAgIH1cbiAgICB2YXIgaGFsZk1heEFhYmJTaXplID0gbWF4QWFiYlNpemUgKiAwLjU7XG4gICAgdmFyIG1heEluc3RhbmNlQ291bnQgPSB0aGlzLmRldmljZS5zdXBwb3J0c0JvbmVUZXh0dXJlcyA/IDEwMjQgOiB0aGlzLmRldmljZS5ib25lTGltaXQ7XG4gICAgdmFyIGk7XG4gICAgdmFyIG1hdGVyaWFsLCBsYXllciwgdmVydENvdW50LCBwYXJhbXMsIHBhcmFtczIsIHBhcmFtLCBwYXJhbUZhaWxlZCwgbGlnaHRMaXN0LCBkZWZzO1xuICAgIHZhciBhYWJiID0gbmV3IHBjLkJvdW5kaW5nQm94O1xuICAgIHZhciB0ZXN0QWFiYiA9IG5ldyBwYy5Cb3VuZGluZ0JveDtcbiAgICB2YXIgbGlzdHMgPSBbXTtcbiAgICB2YXIgaiA9IDA7XG4gICAgdmFyIG1lc2hJbnN0YW5jZXNMZWZ0QSA9IG1lc2hJbnN0YW5jZXM7XG4gICAgdmFyIG1lc2hJbnN0YW5jZXNMZWZ0QjtcbiAgICB2YXIgaztcbiAgICB3aGlsZSAobWVzaEluc3RhbmNlc0xlZnRBLmxlbmd0aCA+IDApIHtcbiAgICAgIGxpc3RzW2pdID0gW107XG4gICAgICBtZXNoSW5zdGFuY2VzTGVmdEIgPSBbXTtcbiAgICAgIG1hdGVyaWFsID0gbWVzaEluc3RhbmNlc0xlZnRBWzBdLm1hdGVyaWFsO1xuICAgICAgbGF5ZXIgPSBtZXNoSW5zdGFuY2VzTGVmdEFbMF0ubGF5ZXI7XG4gICAgICBkZWZzID0gbWVzaEluc3RhbmNlc0xlZnRBWzBdLl9zaGFkZXJEZWZzO1xuICAgICAgcGFyYW1zID0gbWVzaEluc3RhbmNlc0xlZnRBWzBdLnBhcmFtZXRlcnM7XG4gICAgICBsaWdodExpc3QgPSBtZXNoSW5zdGFuY2VzTGVmdEFbMF0uX3N0YXRpY0xpZ2h0TGlzdDtcbiAgICAgIHZlcnRDb3VudCA9IG1lc2hJbnN0YW5jZXNMZWZ0QVswXS5tZXNoLnZlcnRleEJ1ZmZlci5nZXROdW1WZXJ0aWNlcygpO1xuICAgICAgYWFiYi5jb3B5KG1lc2hJbnN0YW5jZXNMZWZ0QVswXS5hYWJiKTtcbiAgICAgIGZvciAoaSA9IDA7aSA8IG1lc2hJbnN0YW5jZXNMZWZ0QS5sZW5ndGg7aSsrKSB7XG4gICAgICAgIGlmIChpID4gMCkge1xuICAgICAgICAgIGlmIChtYXRlcmlhbCAhPT0gbWVzaEluc3RhbmNlc0xlZnRBW2ldLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2VzTGVmdEIucHVzaChtZXNoSW5zdGFuY2VzTGVmdEFbaV0pO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChsYXllciAhPT0gbWVzaEluc3RhbmNlc0xlZnRBW2ldLmxheWVyKSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2VzTGVmdEIucHVzaChtZXNoSW5zdGFuY2VzTGVmdEFbaV0pO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChkZWZzICE9PSBtZXNoSW5zdGFuY2VzTGVmdEFbaV0uX3NoYWRlckRlZnMpIHtcbiAgICAgICAgICAgIG1lc2hJbnN0YW5jZXNMZWZ0Qi5wdXNoKG1lc2hJbnN0YW5jZXNMZWZ0QVtpXSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHZlcnRDb3VudCArIG1lc2hJbnN0YW5jZXNMZWZ0QVtpXS5tZXNoLnZlcnRleEJ1ZmZlci5nZXROdW1WZXJ0aWNlcygpID4gNjU1MzUpIHtcbiAgICAgICAgICAgIG1lc2hJbnN0YW5jZXNMZWZ0Qi5wdXNoKG1lc2hJbnN0YW5jZXNMZWZ0QVtpXSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGVzdEFhYmIuY29weShhYWJiKTtcbiAgICAgICAgICB0ZXN0QWFiYi5hZGQobWVzaEluc3RhbmNlc0xlZnRBW2ldLmFhYmIpO1xuICAgICAgICAgIGlmICh0ZXN0QWFiYi5oYWxmRXh0ZW50cy54ID4gaGFsZk1heEFhYmJTaXplIHx8IHRlc3RBYWJiLmhhbGZFeHRlbnRzLnkgPiBoYWxmTWF4QWFiYlNpemUgfHwgdGVzdEFhYmIuaGFsZkV4dGVudHMueiA+IGhhbGZNYXhBYWJiU2l6ZSkge1xuICAgICAgICAgICAgbWVzaEluc3RhbmNlc0xlZnRCLnB1c2gobWVzaEluc3RhbmNlc0xlZnRBW2ldKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwYXJhbXMyID0gbWVzaEluc3RhbmNlc0xlZnRBW2ldLnBhcmFtZXRlcnM7XG4gICAgICAgICAgcGFyYW1GYWlsZWQgPSBmYWxzZTtcbiAgICAgICAgICBmb3IgKHBhcmFtIGluIHBhcmFtcykge1xuICAgICAgICAgICAgaWYgKCFwYXJhbXMuaGFzT3duUHJvcGVydHkocGFyYW0pKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFwYXJhbXNJZGVudGljYWwocGFyYW1zW3BhcmFtXSwgcGFyYW1zMltwYXJhbV0pKSB7XG4gICAgICAgICAgICAgIHBhcmFtRmFpbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghcGFyYW1GYWlsZWQpIHtcbiAgICAgICAgICAgIGZvciAocGFyYW0gaW4gcGFyYW1zMikge1xuICAgICAgICAgICAgICBpZiAoIXBhcmFtczIuaGFzT3duUHJvcGVydHkocGFyYW0pKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKCFwYXJhbXNJZGVudGljYWwocGFyYW1zMltwYXJhbV0sIHBhcmFtc1twYXJhbV0pKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1GYWlsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwYXJhbUZhaWxlZCkge1xuICAgICAgICAgICAgbWVzaEluc3RhbmNlc0xlZnRCLnB1c2gobWVzaEluc3RhbmNlc0xlZnRBW2ldKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwYXJhbXMyID0gbWVzaEluc3RhbmNlc0xlZnRBW2ldLl9zdGF0aWNMaWdodExpc3Q7XG4gICAgICAgICAgaWYgKGxpZ2h0TGlzdCAmJiAhcGFyYW1zMiB8fCAhbGlnaHRMaXN0ICYmIHBhcmFtczIpIHtcbiAgICAgICAgICAgIG1lc2hJbnN0YW5jZXNMZWZ0Qi5wdXNoKG1lc2hJbnN0YW5jZXNMZWZ0QVtpXSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGxpZ2h0TGlzdCAmJiBwYXJhbXMyKSB7XG4gICAgICAgICAgICBwYXJhbUZhaWxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yIChrID0gMDtrIDwgbGlnaHRMaXN0Lmxlbmd0aDtrKyspIHtcbiAgICAgICAgICAgICAgaWYgKHBhcmFtczIuaW5kZXhPZihsaWdodExpc3Rba10pIDwgMCkge1xuICAgICAgICAgICAgICAgIHBhcmFtRmFpbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChrID0gMDtrIDwgcGFyYW1zMi5sZW5ndGg7aysrKSB7XG4gICAgICAgICAgICAgIGlmIChsaWdodExpc3QuaW5kZXhPZihwYXJhbXMyW2tdKSA8IDApIHtcbiAgICAgICAgICAgICAgICBwYXJhbUZhaWxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJhbUZhaWxlZCkge1xuICAgICAgICAgICAgICBtZXNoSW5zdGFuY2VzTGVmdEIucHVzaChtZXNoSW5zdGFuY2VzTGVmdEFbaV0pO1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYWFiYi5hZGQobWVzaEluc3RhbmNlc0xlZnRBW2ldLmFhYmIpO1xuICAgICAgICB2ZXJ0Q291bnQgKz0gbWVzaEluc3RhbmNlc0xlZnRBW2ldLm1lc2gudmVydGV4QnVmZmVyLmdldE51bVZlcnRpY2VzKCk7XG4gICAgICAgIGxpc3RzW2pdLnB1c2gobWVzaEluc3RhbmNlc0xlZnRBW2ldKTtcbiAgICAgICAgaWYgKGR5bmFtaWMgJiYgbGlzdHNbal0ubGVuZ3RoID09PSBtYXhJbnN0YW5jZUNvdW50KSB7XG4gICAgICAgICAgaWYgKGkgPT09IG1lc2hJbnN0YW5jZXNMZWZ0QS5sZW5ndGgpIHtcbiAgICAgICAgICAgIG1lc2hJbnN0YW5jZXNMZWZ0QiA9IFtdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtZXNoSW5zdGFuY2VzTGVmdEIgPSBtZXNoSW5zdGFuY2VzTGVmdEEuc2xpY2UoaSArIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaisrO1xuICAgICAgbWVzaEluc3RhbmNlc0xlZnRBID0gbWVzaEluc3RhbmNlc0xlZnRCO1xuICAgIH1cbiAgICByZXR1cm4gbGlzdHM7XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24obWVzaEluc3RhbmNlcywgZHluYW1pYywgYmF0Y2hHcm91cElkKSB7XG4gICAgaWYgKCF0aGlzLl9pbml0KSB7XG4gICAgICB2YXIgYm9uZUxpbWl0ID0gXCIjZGVmaW5lIEJPTkVfTElNSVQgXCIgKyB0aGlzLmRldmljZS5nZXRCb25lTGltaXQoKSArIFwiXFxuXCI7XG4gICAgICB0aGlzLnRyYW5zZm9ybVZTID0gYm9uZUxpbWl0ICsgcGMuc2hhZGVyQ2h1bmtzLnRyYW5zZm9ybUJhdGNoU2tpbm5lZFZTO1xuICAgICAgdGhpcy50cmFuc2Zvcm1FbGVtZW50VlMgPSBib25lTGltaXQgKyBwYy5zaGFkZXJDaHVua3MudHJhbnNmb3JtU2NyZWVuU3BhY2VCYXRjaFNraW5uZWRWUztcbiAgICAgIHRoaXMuc2tpblRleFZTID0gcGMuc2hhZGVyQ2h1bmtzLnNraW5CYXRjaFRleFZTO1xuICAgICAgdGhpcy5za2luQ29uc3RWUyA9IHBjLnNoYWRlckNodW5rcy5za2luQmF0Y2hDb25zdFZTO1xuICAgICAgdGhpcy52ZXJ0ZXhGb3JtYXRzID0ge307XG4gICAgICB0aGlzLl9pbml0ID0gdHJ1ZTtcbiAgICB9XG4gICAgdmFyIGksIGo7XG4gICAgdmFyIGJhdGNoID0gbmV3IHBjLkJhdGNoKG1lc2hJbnN0YW5jZXMsIGR5bmFtaWMsIGJhdGNoR3JvdXBJZCk7XG4gICAgdGhpcy5fYmF0Y2hMaXN0LnB1c2goYmF0Y2gpO1xuICAgIHZhciBtYXRlcmlhbCA9IG51bGw7XG4gICAgdmFyIG1lc2gsIGVsZW1zLCBudW1WZXJ0cywgdmVydFNpemUsIGluZGV4O1xuICAgIHZhciBoYXNQb3MsIGhhc05vcm1hbCwgaGFzVXYsIGhhc1V2MiwgaGFzVGFuZ2VudDtcbiAgICB2YXIgYmF0Y2hOdW1WZXJ0cyA9IDA7XG4gICAgdmFyIGJhdGNoTnVtSW5kaWNlcyA9IDA7XG4gICAgZm9yIChpID0gMDtpIDwgbWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAoIW1hdGVyaWFsKSB7XG4gICAgICAgIG1hdGVyaWFsID0gbWVzaEluc3RhbmNlc1tpXS5tYXRlcmlhbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChtYXRlcmlhbCAhPT0gbWVzaEluc3RhbmNlc1tpXS5tYXRlcmlhbCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbWVzaCA9IG1lc2hJbnN0YW5jZXNbaV0ubWVzaDtcbiAgICAgIGVsZW1zID0gbWVzaC52ZXJ0ZXhCdWZmZXIuZm9ybWF0LmVsZW1lbnRzO1xuICAgICAgbnVtVmVydHMgPSBtZXNoLnZlcnRleEJ1ZmZlci5udW1WZXJ0aWNlcztcbiAgICAgIGJhdGNoTnVtVmVydHMgKz0gbnVtVmVydHM7XG4gICAgICBmb3IgKGogPSAwO2ogPCBlbGVtcy5sZW5ndGg7aisrKSB7XG4gICAgICAgIGlmIChlbGVtc1tqXS5uYW1lID09PSBwYy5TRU1BTlRJQ19QT1NJVElPTikge1xuICAgICAgICAgIGhhc1BvcyA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX05PUk1BTCkge1xuICAgICAgICAgICAgaGFzTm9ybWFsID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX1RFWENPT1JEMCkge1xuICAgICAgICAgICAgICBoYXNVdiA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAoZWxlbXNbal0ubmFtZSA9PT0gcGMuU0VNQU5USUNfVEVYQ09PUkQxKSB7XG4gICAgICAgICAgICAgICAgaGFzVXYyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbXNbal0ubmFtZSA9PT0gcGMuU0VNQU5USUNfVEFOR0VOVCkge1xuICAgICAgICAgICAgICAgICAgaGFzVGFuZ2VudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBiYXRjaE51bUluZGljZXMgKz0gbWVzaC5wcmltaXRpdmVbMF0uY291bnQ7XG4gICAgfVxuICAgIGlmICghaGFzUG9zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBlbnRpdHlJbmRleFNpemVGID0gZHluYW1pYyA/IDEgOiAwO1xuICAgIHZhciBiYXRjaFZlcnRTaXplRiA9IDMgKyAoaGFzTm9ybWFsID8gMyA6IDApICsgKGhhc1V2ID8gMiA6IDApICsgKGhhc1V2MiA/IDIgOiAwKSArIChoYXNUYW5nZW50ID8gNCA6IDApICsgZW50aXR5SW5kZXhTaXplRjtcbiAgICB2YXIgYmF0Y2hPZmZzZXRORiA9IDM7XG4gICAgdmFyIGJhdGNoT2Zmc2V0VUYgPSBoYXNOb3JtYWwgPyAzICogMiA6IDM7XG4gICAgdmFyIGJhdGNoT2Zmc2V0VTJGID0gKGhhc05vcm1hbCA/IDMgKiAyIDogMykgKyAoaGFzVXYgPyAyIDogMCk7XG4gICAgdmFyIGJhdGNoT2Zmc2V0VEYgPSAoaGFzTm9ybWFsID8gMyAqIDIgOiAzKSArIChoYXNVdiA/IDIgOiAwKSArIChoYXNVdjIgPyAyIDogMCk7XG4gICAgdmFyIGJhdGNoT2Zmc2V0RUYgPSAoaGFzTm9ybWFsID8gMyAqIDIgOiAzKSArIChoYXNVdiA/IDIgOiAwKSArIChoYXNVdjIgPyAyIDogMCkgKyAoaGFzVGFuZ2VudCA/IDQgOiAwKTtcbiAgICB2YXIgYmF0Y2hEYXRhID0gbmV3IEZsb2F0MzJBcnJheShuZXcgQXJyYXlCdWZmZXIoYmF0Y2hOdW1WZXJ0cyAqIGJhdGNoVmVydFNpemVGICogNCkpO1xuICAgIHZhciBpbmRleEJ1ZmZlciA9IG5ldyBwYy5JbmRleEJ1ZmZlcih0aGlzLmRldmljZSwgcGMuSU5ERVhGT1JNQVRfVUlOVDE2LCBiYXRjaE51bUluZGljZXMsIHBjLkJVRkZFUl9TVEFUSUMpO1xuICAgIHZhciBiYXRjaEluZGV4RGF0YSA9IG5ldyBVaW50MTZBcnJheShpbmRleEJ1ZmZlci5sb2NrKCkpO1xuICAgIHZhciBtYXRyaWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkobWVzaEluc3RhbmNlcy5sZW5ndGggKiAxNik7XG4gICAgdmFyIHZlcnRTaXplRjtcbiAgICB2YXIgZGF0YSwgaW5kZXhCYXNlLCBudW1JbmRpY2VzLCBpbmRleERhdGEsIG10eDtcbiAgICB2YXIgdmVydGljZXNPZmZzZXQgPSAwO1xuICAgIHZhciBpbmRleE9mZnNldCA9IDA7XG4gICAgdmFyIHZiT2Zmc2V0ID0gMDtcbiAgICB2YXIgb2Zmc2V0UEYsIG9mZnNldE5GLCBvZmZzZXRVRiwgb2Zmc2V0VTJGLCBvZmZzZXRURjtcbiAgICB2YXIgdHJhbnNmb3JtLCB2ZWMsIHZlY0RhdGE7XG4gICAgaWYgKCFkeW5hbWljKSB7XG4gICAgICB2ZWMgPSBuZXcgcGMuVmVjMztcbiAgICAgIHZlY0RhdGEgPSB2ZWMuZGF0YTtcbiAgICB9XG4gICAgZm9yIChpID0gMDtpIDwgbWVzaEluc3RhbmNlcy5sZW5ndGg7aSsrKSB7XG4gICAgICBtZXNoID0gbWVzaEluc3RhbmNlc1tpXS5tZXNoO1xuICAgICAgZWxlbXMgPSBtZXNoLnZlcnRleEJ1ZmZlci5mb3JtYXQuZWxlbWVudHM7XG4gICAgICBudW1WZXJ0cyA9IG1lc2gudmVydGV4QnVmZmVyLm51bVZlcnRpY2VzO1xuICAgICAgdmVydFNpemUgPSBtZXNoLnZlcnRleEJ1ZmZlci5mb3JtYXQuc2l6ZTtcbiAgICAgIHZlcnRTaXplRiA9IHZlcnRTaXplIC8gNDtcbiAgICAgIGZvciAoaiA9IDA7aiA8IGVsZW1zLmxlbmd0aDtqKyspIHtcbiAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX1BPU0lUSU9OKSB7XG4gICAgICAgICAgb2Zmc2V0UEYgPSBlbGVtc1tqXS5vZmZzZXQgLyA0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChlbGVtc1tqXS5uYW1lID09PSBwYy5TRU1BTlRJQ19OT1JNQUwpIHtcbiAgICAgICAgICAgIG9mZnNldE5GID0gZWxlbXNbal0ub2Zmc2V0IC8gNDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGVsZW1zW2pdLm5hbWUgPT09IHBjLlNFTUFOVElDX1RFWENPT1JEMCkge1xuICAgICAgICAgICAgICBvZmZzZXRVRiA9IGVsZW1zW2pdLm9mZnNldCAvIDQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAoZWxlbXNbal0ubmFtZSA9PT0gcGMuU0VNQU5USUNfVEVYQ09PUkQxKSB7XG4gICAgICAgICAgICAgICAgb2Zmc2V0VTJGID0gZWxlbXNbal0ub2Zmc2V0IC8gNDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbXNbal0ubmFtZSA9PT0gcGMuU0VNQU5USUNfVEFOR0VOVCkge1xuICAgICAgICAgICAgICAgICAgb2Zmc2V0VEYgPSBlbGVtc1tqXS5vZmZzZXQgLyA0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkobWVzaC52ZXJ0ZXhCdWZmZXIuc3RvcmFnZSk7XG4gICAgICBpZiAoZHluYW1pYykge1xuICAgICAgICBmb3IgKGogPSAwO2ogPCBudW1WZXJ0cztqKyspIHtcbiAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXRdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0UEZdO1xuICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIDFdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0UEYgKyAxXTtcbiAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyAyXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFBGICsgMl07XG4gICAgICAgICAgaWYgKGhhc05vcm1hbCkge1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRORl0gPSBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRORl07XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldE5GICsgMV0gPSBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRORiArIDFdO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRORiArIDJdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0TkYgKyAyXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGhhc1V2KSB7XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldFVGXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFVGXTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VUYgKyAxXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFVGICsgMV07XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChoYXNVdjIpIHtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VTJGXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFUyRl07XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldFUyRiArIDFdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VTJGICsgMV07XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChoYXNUYW5nZW50KSB7XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldFRGXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFRGXTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VEYgKyAxXSA9IGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFRGICsgMV07XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldFRGICsgMl0gPSBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRURiArIDJdO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRURiArIDNdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VEYgKyAzXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIGJhdGNoT2Zmc2V0RUYgKyB2Yk9mZnNldF0gPSBpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cmFuc2Zvcm0gPSBtZXNoSW5zdGFuY2VzW2ldLm5vZGUuZ2V0V29ybGRUcmFuc2Zvcm0oKTtcbiAgICAgICAgZm9yIChqID0gMDtqIDwgbnVtVmVydHM7aisrKSB7XG4gICAgICAgICAgdmVjLnNldChkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRQRl0sIGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFBGICsgMV0sIGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldFBGICsgMl0pO1xuICAgICAgICAgIHRyYW5zZm9ybS50cmFuc2Zvcm1Qb2ludCh2ZWMsIHZlYyk7XG4gICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0XSA9IHZlY0RhdGFbMF07XG4gICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgMV0gPSB2ZWNEYXRhWzFdO1xuICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIDJdID0gdmVjRGF0YVsyXTtcbiAgICAgICAgICBpZiAoaGFzTm9ybWFsKSB7XG4gICAgICAgICAgICB2ZWMuc2V0KGRhdGFbaiAqIHZlcnRTaXplRiArIG9mZnNldE5GXSwgZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0TkYgKyAxXSwgZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0TkYgKyAyXSk7XG4gICAgICAgICAgICB0cmFuc2Zvcm0udHJhbnNmb3JtVmVjdG9yKHZlYywgdmVjKTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0TkZdID0gdmVjRGF0YVswXTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0TkYgKyAxXSA9IHZlY0RhdGFbMV07XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldE5GICsgMl0gPSB2ZWNEYXRhWzJdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoaGFzVXYpIHtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VUZdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VUZdO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRVRiArIDFdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VUYgKyAxXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGhhc1V2Mikge1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRVMkZdID0gZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VTJGXTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VTJGICsgMV0gPSBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRVMkYgKyAxXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHtcbiAgICAgICAgICAgIHZlYy5zZXQoZGF0YVtqICogdmVydFNpemVGICsgb2Zmc2V0VEZdLCBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRURiArIDFdLCBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRURiArIDJdKTtcbiAgICAgICAgICAgIHRyYW5zZm9ybS50cmFuc2Zvcm1WZWN0b3IodmVjLCB2ZWMpO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRURl0gPSB2ZWNEYXRhWzBdO1xuICAgICAgICAgICAgYmF0Y2hEYXRhW2ogKiBiYXRjaFZlcnRTaXplRiArIHZiT2Zmc2V0ICsgYmF0Y2hPZmZzZXRURiArIDFdID0gdmVjRGF0YVsxXTtcbiAgICAgICAgICAgIGJhdGNoRGF0YVtqICogYmF0Y2hWZXJ0U2l6ZUYgKyB2Yk9mZnNldCArIGJhdGNoT2Zmc2V0VEYgKyAyXSA9IHZlY0RhdGFbMl07XG4gICAgICAgICAgICBiYXRjaERhdGFbaiAqIGJhdGNoVmVydFNpemVGICsgdmJPZmZzZXQgKyBiYXRjaE9mZnNldFRGICsgM10gPSBkYXRhW2ogKiB2ZXJ0U2l6ZUYgKyBvZmZzZXRURiArIDNdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaW5kZXhCYXNlID0gbWVzaC5wcmltaXRpdmVbMF0uYmFzZTtcbiAgICAgIG51bUluZGljZXMgPSBtZXNoLnByaW1pdGl2ZVswXS5jb3VudDtcbiAgICAgIGluZGV4RGF0YSA9IG5ldyBVaW50MTZBcnJheShtZXNoLmluZGV4QnVmZmVyWzBdLnN0b3JhZ2UpO1xuICAgICAgZm9yIChqID0gMDtqIDwgbnVtSW5kaWNlcztqKyspIHtcbiAgICAgICAgYmF0Y2hJbmRleERhdGFbaiArIGluZGV4T2Zmc2V0XSA9IGluZGV4RGF0YVtpbmRleEJhc2UgKyBqXSArIHZlcnRpY2VzT2Zmc2V0O1xuICAgICAgfVxuICAgICAgaW5kZXhPZmZzZXQgKz0gbnVtSW5kaWNlcztcbiAgICAgIHZlcnRpY2VzT2Zmc2V0ICs9IG51bVZlcnRzO1xuICAgICAgdmJPZmZzZXQgPSB2ZXJ0aWNlc09mZnNldCAqIGJhdGNoVmVydFNpemVGO1xuICAgIH1cbiAgICB2YXIgdmVydGV4Rm9ybWF0SWQgPSAwO1xuICAgIGlmIChoYXNOb3JtYWwpIHtcbiAgICAgIHZlcnRleEZvcm1hdElkIHw9IDEgPDwgMTtcbiAgICB9XG4gICAgaWYgKGhhc1V2KSB7XG4gICAgICB2ZXJ0ZXhGb3JtYXRJZCB8PSAxIDw8IDI7XG4gICAgfVxuICAgIGlmIChoYXNVdjIpIHtcbiAgICAgIHZlcnRleEZvcm1hdElkIHw9IDEgPDwgMztcbiAgICB9XG4gICAgaWYgKGhhc1RhbmdlbnQpIHtcbiAgICAgIHZlcnRleEZvcm1hdElkIHw9IDEgPDwgNDtcbiAgICB9XG4gICAgaWYgKGR5bmFtaWMpIHtcbiAgICAgIHZlcnRleEZvcm1hdElkIHw9IDEgPDwgNTtcbiAgICB9XG4gICAgdmFyIHZlcnRleEZvcm1hdCA9IHRoaXMudmVydGV4Rm9ybWF0c1t2ZXJ0ZXhGb3JtYXRJZF07XG4gICAgaWYgKCF2ZXJ0ZXhGb3JtYXQpIHtcbiAgICAgIHZhciBmb3JtYXREZXNjID0gW107XG4gICAgICBmb3JtYXREZXNjLnB1c2goe3NlbWFudGljOnBjLlNFTUFOVElDX1BPU0lUSU9OLCBjb21wb25lbnRzOjMsIHR5cGU6cGMuRUxFTUVOVFRZUEVfRkxPQVQzMiwgbm9ybWFsaXplOmZhbHNlfSk7XG4gICAgICBpZiAoaGFzTm9ybWFsKSB7XG4gICAgICAgIGZvcm1hdERlc2MucHVzaCh7c2VtYW50aWM6cGMuU0VNQU5USUNfTk9STUFMLCBjb21wb25lbnRzOjMsIHR5cGU6cGMuRUxFTUVOVFRZUEVfRkxPQVQzMiwgbm9ybWFsaXplOmZhbHNlfSk7XG4gICAgICB9XG4gICAgICBpZiAoaGFzVXYpIHtcbiAgICAgICAgZm9ybWF0RGVzYy5wdXNoKHtzZW1hbnRpYzpwYy5TRU1BTlRJQ19URVhDT09SRDAsIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5FTEVNRU5UVFlQRV9GTE9BVDMyLCBub3JtYWxpemU6ZmFsc2V9KTtcbiAgICAgIH1cbiAgICAgIGlmIChoYXNVdjIpIHtcbiAgICAgICAgZm9ybWF0RGVzYy5wdXNoKHtzZW1hbnRpYzpwYy5TRU1BTlRJQ19URVhDT09SRDEsIGNvbXBvbmVudHM6MiwgdHlwZTpwYy5FTEVNRU5UVFlQRV9GTE9BVDMyLCBub3JtYWxpemU6ZmFsc2V9KTtcbiAgICAgIH1cbiAgICAgIGlmIChoYXNUYW5nZW50KSB7XG4gICAgICAgIGZvcm1hdERlc2MucHVzaCh7c2VtYW50aWM6cGMuU0VNQU5USUNfVEFOR0VOVCwgY29tcG9uZW50czo0LCB0eXBlOnBjLkVMRU1FTlRUWVBFX0ZMT0FUMzIsIG5vcm1hbGl6ZTpmYWxzZX0pO1xuICAgICAgfVxuICAgICAgaWYgKGR5bmFtaWMpIHtcbiAgICAgICAgZm9ybWF0RGVzYy5wdXNoKHtzZW1hbnRpYzpwYy5TRU1BTlRJQ19CTEVORElORElDRVMsIGNvbXBvbmVudHM6MSwgdHlwZTpwYy5FTEVNRU5UVFlQRV9GTE9BVDMyLCBub3JtYWxpemU6ZmFsc2V9KTtcbiAgICAgIH1cbiAgICAgIHZlcnRleEZvcm1hdCA9IHRoaXMudmVydGV4Rm9ybWF0c1t2ZXJ0ZXhGb3JtYXRJZF0gPSBuZXcgcGMuVmVydGV4Rm9ybWF0KHRoaXMuZGV2aWNlLCBmb3JtYXREZXNjKTtcbiAgICB9XG4gICAgdmFyIHZlcnRleEJ1ZmZlciA9IG5ldyBwYy5WZXJ0ZXhCdWZmZXIodGhpcy5kZXZpY2UsIHZlcnRleEZvcm1hdCwgYmF0Y2hOdW1WZXJ0cywgcGMuQlVGRkVSX1NUQVRJQywgYmF0Y2hEYXRhLmJ1ZmZlcik7XG4gICAgaW5kZXhCdWZmZXIudW5sb2NrKCk7XG4gICAgbWVzaCA9IG5ldyBwYy5NZXNoO1xuICAgIG1lc2gudmVydGV4QnVmZmVyID0gdmVydGV4QnVmZmVyO1xuICAgIG1lc2guaW5kZXhCdWZmZXJbMF0gPSBpbmRleEJ1ZmZlcjtcbiAgICBtZXNoLnByaW1pdGl2ZVswXS50eXBlID0gYmF0Y2gub3JpZ01lc2hJbnN0YW5jZXNbMF0ubWVzaC5wcmltaXRpdmVbMF0udHlwZTtcbiAgICBtZXNoLnByaW1pdGl2ZVswXS5iYXNlID0gMDtcbiAgICBtZXNoLnByaW1pdGl2ZVswXS5jb3VudCA9IGJhdGNoTnVtSW5kaWNlcztcbiAgICBtZXNoLnByaW1pdGl2ZVswXS5pbmRleGVkID0gdHJ1ZTtcbiAgICBtZXNoLmN1bGwgPSBmYWxzZTtcbiAgICBpZiAoZHluYW1pYykge1xuICAgICAgbWF0ZXJpYWwgPSBtYXRlcmlhbC5jbG9uZSgpO1xuICAgICAgbWF0ZXJpYWwuY2h1bmtzLnRyYW5zZm9ybVNraW5uZWRWUyA9IGJhdGNoLm9yaWdNZXNoSW5zdGFuY2VzWzBdLl9zaGFkZXJEZWZzICYgcGMuU0hBREVSREVGX1NDUkVFTlNQQUNFID8gdGhpcy50cmFuc2Zvcm1FbGVtZW50VlMgOiB0aGlzLnRyYW5zZm9ybVZTO1xuICAgICAgbWF0ZXJpYWwuY2h1bmtzLnNraW5UZXhWUyA9IHRoaXMuc2tpblRleFZTO1xuICAgICAgbWF0ZXJpYWwuY2h1bmtzLnNraW5Db25zdFZTID0gdGhpcy5za2luQ29uc3RWUztcbiAgICAgIG1hdGVyaWFsLnVwZGF0ZSgpO1xuICAgIH1cbiAgICB2YXIgbWVzaEluc3RhbmNlID0gbmV3IHBjLk1lc2hJbnN0YW5jZSh0aGlzLnJvb3ROb2RlLCBtZXNoLCBtYXRlcmlhbCk7XG4gICAgbWVzaEluc3RhbmNlLmNhc3RTaGFkb3cgPSBiYXRjaC5vcmlnTWVzaEluc3RhbmNlc1swXS5jYXN0U2hhZG93O1xuICAgIG1lc2hJbnN0YW5jZS5wYXJhbWV0ZXJzID0gYmF0Y2gub3JpZ01lc2hJbnN0YW5jZXNbMF0ucGFyYW1ldGVycztcbiAgICBtZXNoSW5zdGFuY2UuaXNTdGF0aWMgPSBiYXRjaC5vcmlnTWVzaEluc3RhbmNlc1swXS5pc1N0YXRpYztcbiAgICBtZXNoSW5zdGFuY2UuX3N0YXRpY0xpZ2h0TGlzdCA9IGJhdGNoLm9yaWdNZXNoSW5zdGFuY2VzWzBdLl9zdGF0aWNMaWdodExpc3Q7XG4gICAgaWYgKGR5bmFtaWMpIHtcbiAgICAgIHZhciBub2RlcyA9IFtdO1xuICAgICAgZm9yIChpID0gMDtpIDwgYmF0Y2gub3JpZ01lc2hJbnN0YW5jZXMubGVuZ3RoO2krKykge1xuICAgICAgICBub2Rlcy5wdXNoKGJhdGNoLm9yaWdNZXNoSW5zdGFuY2VzW2ldLm5vZGUpO1xuICAgICAgfVxuICAgICAgbWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSA9IG5ldyBTa2luQmF0Y2hJbnN0YW5jZSh0aGlzLmRldmljZSwgbm9kZXMsIHRoaXMucm9vdE5vZGUpO1xuICAgIH1cbiAgICBtZXNoSW5zdGFuY2UuX3VwZGF0ZUFhYmIgPSBmYWxzZTtcbiAgICBiYXRjaC5tZXNoSW5zdGFuY2UgPSBtZXNoSW5zdGFuY2U7XG4gICAgdGhpcy51cGRhdGUoYmF0Y2gpO1xuICAgIHZhciBuZXdNb2RlbCA9IG5ldyBwYy5Nb2RlbDtcbiAgICBuZXdNb2RlbC5tZXNoSW5zdGFuY2VzID0gW2JhdGNoLm1lc2hJbnN0YW5jZV07XG4gICAgbmV3TW9kZWwuY2FzdFNoYWRvd3MgPSBiYXRjaC5vcmlnTWVzaEluc3RhbmNlc1swXS5jYXN0U2hhZG93cztcbiAgICBiYXRjaC5tb2RlbCA9IG5ld01vZGVsO1xuICAgIHJldHVybiBiYXRjaDtcbiAgfTtcbiAgQmF0Y2hNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihiYXRjaCkge1xuICAgIGJhdGNoLl9hYWJiLmNvcHkoYmF0Y2gub3JpZ01lc2hJbnN0YW5jZXNbMF0uYWFiYik7XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IGJhdGNoLm9yaWdNZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIGlmIChpID4gMCkge1xuICAgICAgICBiYXRjaC5fYWFiYi5hZGQoYmF0Y2gub3JpZ01lc2hJbnN0YW5jZXNbaV0uYWFiYik7XG4gICAgICB9XG4gICAgfVxuICAgIGJhdGNoLm1lc2hJbnN0YW5jZS5hYWJiID0gYmF0Y2guX2FhYmI7XG4gICAgYmF0Y2guX2FhYmIuX3JhZGl1c1ZlciA9IC0xO1xuICAgIGJhdGNoLm1lc2hJbnN0YW5jZS5fYWFiYlZlciA9IDA7XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUudXBkYXRlQWxsID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2RpcnR5R3JvdXBzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuZ2VuZXJhdGUodGhpcy5fZGlydHlHcm91cHMpO1xuICAgICAgdGhpcy5fZGlydHlHcm91cHMubGVuZ3RoID0gMDtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDA7aSA8IHRoaXMuX2JhdGNoTGlzdC5sZW5ndGg7aSsrKSB7XG4gICAgICBpZiAoIXRoaXMuX2JhdGNoTGlzdFtpXS5keW5hbWljKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGUodGhpcy5fYmF0Y2hMaXN0W2ldKTtcbiAgICB9XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihiYXRjaCwgY2xvbmVkTWVzaEluc3RhbmNlcykge1xuICAgIHZhciBiYXRjaDIgPSBuZXcgcGMuQmF0Y2goY2xvbmVkTWVzaEluc3RhbmNlcywgYmF0Y2guZHluYW1pYywgYmF0Y2guYmF0Y2hHcm91cElkKTtcbiAgICB0aGlzLl9iYXRjaExpc3QucHVzaChiYXRjaDIpO1xuICAgIHZhciBub2RlcyA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwO2kgPCBjbG9uZWRNZXNoSW5zdGFuY2VzLmxlbmd0aDtpKyspIHtcbiAgICAgIG5vZGVzLnB1c2goY2xvbmVkTWVzaEluc3RhbmNlc1tpXS5ub2RlKTtcbiAgICB9XG4gICAgYmF0Y2gyLm1lc2hJbnN0YW5jZSA9IG5ldyBwYy5NZXNoSW5zdGFuY2UoYmF0Y2gubWVzaEluc3RhbmNlLm5vZGUsIGJhdGNoLm1lc2hJbnN0YW5jZS5tZXNoLCBiYXRjaC5tZXNoSW5zdGFuY2UubWF0ZXJpYWwpO1xuICAgIGJhdGNoMi5tZXNoSW5zdGFuY2UuX3VwZGF0ZUFhYmIgPSBmYWxzZTtcbiAgICBiYXRjaDIubWVzaEluc3RhbmNlLnBhcmFtZXRlcnMgPSBjbG9uZWRNZXNoSW5zdGFuY2VzWzBdLnBhcmFtZXRlcnM7XG4gICAgYmF0Y2gyLm1lc2hJbnN0YW5jZS5pc1N0YXRpYyA9IGNsb25lZE1lc2hJbnN0YW5jZXNbMF0uaXNTdGF0aWM7XG4gICAgYmF0Y2gyLm1lc2hJbnN0YW5jZS5fc3RhdGljTGlnaHRMaXN0ID0gY2xvbmVkTWVzaEluc3RhbmNlc1swXS5fc3RhdGljTGlnaHRMaXN0O1xuICAgIGlmIChiYXRjaC5keW5hbWljKSB7XG4gICAgICBiYXRjaDIubWVzaEluc3RhbmNlLnNraW5JbnN0YW5jZSA9IG5ldyBTa2luQmF0Y2hJbnN0YW5jZSh0aGlzLmRldmljZSwgbm9kZXMsIHRoaXMucm9vdE5vZGUpO1xuICAgIH1cbiAgICBiYXRjaDIubWVzaEluc3RhbmNlLmNhc3RTaGFkb3cgPSBiYXRjaC5tZXNoSW5zdGFuY2UuY2FzdFNoYWRvdztcbiAgICBiYXRjaDIubWVzaEluc3RhbmNlLl9zaGFkZXIgPSBiYXRjaC5tZXNoSW5zdGFuY2UuX3NoYWRlcjtcbiAgICB2YXIgbmV3TW9kZWwgPSBuZXcgcGMuTW9kZWw7XG4gICAgbmV3TW9kZWwubWVzaEluc3RhbmNlcyA9IFtiYXRjaDIubWVzaEluc3RhbmNlXTtcbiAgICBuZXdNb2RlbC5jYXN0U2hhZG93cyA9IGJhdGNoLm9yaWdNZXNoSW5zdGFuY2VzWzBdLmNhc3RTaGFkb3dzO1xuICAgIGJhdGNoMi5tb2RlbCA9IG5ld01vZGVsO1xuICAgIHJldHVybiBiYXRjaDI7XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGJhdGNoKSB7XG4gICAgYmF0Y2gucmVmQ291bnRlci0tO1xuICAgIGlmIChiYXRjaC5yZWZDb3VudGVyID09PSAwKSB7XG4gICAgICB0aGlzLnNjZW5lLnJlbW92ZU1vZGVsKGJhdGNoLm1vZGVsKTtcbiAgICAgIGJhdGNoLm1vZGVsLmRlc3Ryb3koKTtcbiAgICB9XG4gIH07XG4gIEJhdGNoTWFuYWdlci5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbihiYXRjaCwgZW50aXRpZXMpIHtcbiAgICBiYXRjaC5yZWZDb3VudGVyID0gZW50aXRpZXMubGVuZ3RoO1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIHNlbGYuZGVzdHJveShiYXRjaCk7XG4gICAgfTtcbiAgICBmb3IgKHZhciBpID0gMDtpIDwgZW50aXRpZXMubGVuZ3RoO2krKykge1xuICAgICAgZW50aXRpZXNbaV0ub25jZShcImRlc3Ryb3lcIiwgY2FsbGJhY2spO1xuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHtCYXRjaDpCYXRjaCwgQmF0Y2hHcm91cDpCYXRjaEdyb3VwLCBCYXRjaE1hbmFnZXI6QmF0Y2hNYW5hZ2VyfTtcbn0oKSk7XG5cblxuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFdFQlBBQ0sgRk9PVEVSXG4vLyAuL2pzL2V4dGVybmFsL3BsYXljYW52YXMuanNcbi8vIG1vZHVsZSBpZCA9IDFcbi8vIG1vZHVsZSBjaHVua3MgPSAwIl0sInNvdXJjZVJvb3QiOiIifQ==